{"ast":null,"code":"import ArcType from \"../Core/ArcType.js\";\nimport AssociativeArray from \"../Core/AssociativeArray.js\";\nimport BoundingRectangle from \"../Core/BoundingRectangle.js\";\nimport Cartesian2 from \"../Core/Cartesian2.js\";\nimport Cartesian3 from \"../Core/Cartesian3.js\";\nimport Cartographic from \"../Core/Cartographic.js\";\nimport ClockRange from \"../Core/ClockRange.js\";\nimport ClockStep from \"../Core/ClockStep.js\";\nimport clone from \"../Core/clone.js\";\nimport Color from \"../Core/Color.js\";\nimport createGuid from \"../Core/createGuid.js\";\nimport Credit from \"../Core/Credit.js\";\nimport defaultValue from \"../Core/defaultValue.js\";\nimport defined from \"../Core/defined.js\";\nimport DeveloperError from \"../Core/DeveloperError.js\";\nimport Ellipsoid from \"../Core/Ellipsoid.js\";\nimport Event from \"../Core/Event.js\";\nimport getExtensionFromUri from \"../Core/getExtensionFromUri.js\";\nimport getFilenameFromUri from \"../Core/getFilenameFromUri.js\";\nimport getTimestamp from \"../Core/getTimestamp.js\";\nimport HeadingPitchRange from \"../Core/HeadingPitchRange.js\";\nimport HeadingPitchRoll from \"../Core/HeadingPitchRoll.js\";\nimport Iso8601 from \"../Core/Iso8601.js\";\nimport JulianDate from \"../Core/JulianDate.js\";\nimport CesiumMath from \"../Core/Math.js\";\nimport NearFarScalar from \"../Core/NearFarScalar.js\";\nimport objectToQuery from \"../Core/objectToQuery.js\";\nimport oneTimeWarning from \"../Core/oneTimeWarning.js\";\nimport PinBuilder from \"../Core/PinBuilder.js\";\nimport PolygonHierarchy from \"../Core/PolygonHierarchy.js\";\nimport queryToObject from \"../Core/queryToObject.js\";\nimport Rectangle from \"../Core/Rectangle.js\";\nimport Resource from \"../Core/Resource.js\";\nimport RuntimeError from \"../Core/RuntimeError.js\";\nimport TimeInterval from \"../Core/TimeInterval.js\";\nimport TimeIntervalCollection from \"../Core/TimeIntervalCollection.js\";\nimport HeightReference from \"../Scene/HeightReference.js\";\nimport HorizontalOrigin from \"../Scene/HorizontalOrigin.js\";\nimport LabelStyle from \"../Scene/LabelStyle.js\";\nimport SceneMode from \"../Scene/SceneMode.js\";\nimport Autolinker from \"../ThirdParty/Autolinker.js\";\nimport Uri from \"../ThirdParty/Uri.js\";\nimport when from \"../ThirdParty/when.js\";\nimport zip from \"../ThirdParty/zip.js\";\nimport BillboardGraphics from \"./BillboardGraphics.js\";\nimport CompositePositionProperty from \"./CompositePositionProperty.js\";\nimport DataSource from \"./DataSource.js\";\nimport DataSourceClock from \"./DataSourceClock.js\";\nimport Entity from \"./Entity.js\";\nimport EntityCluster from \"./EntityCluster.js\";\nimport EntityCollection from \"./EntityCollection.js\";\nimport KmlCamera from \"./KmlCamera.js\";\nimport KmlLookAt from \"./KmlLookAt.js\";\nimport KmlTour from \"./KmlTour.js\";\nimport KmlTourFlyTo from \"./KmlTourFlyTo.js\";\nimport KmlTourWait from \"./KmlTourWait.js\";\nimport LabelGraphics from \"./LabelGraphics.js\";\nimport PathGraphics from \"./PathGraphics.js\";\nimport PolygonGraphics from \"./PolygonGraphics.js\";\nimport PolylineGraphics from \"./PolylineGraphics.js\";\nimport PositionPropertyArray from \"./PositionPropertyArray.js\";\nimport RectangleGraphics from \"./RectangleGraphics.js\";\nimport ReferenceProperty from \"./ReferenceProperty.js\";\nimport SampledPositionProperty from \"./SampledPositionProperty.js\";\nimport ScaledPositionProperty from \"./ScaledPositionProperty.js\";\nimport TimeIntervalCollectionProperty from \"./TimeIntervalCollectionProperty.js\";\nimport WallGraphics from \"./WallGraphics.js\"; //This is by no means an exhaustive list of MIME types.\n//The purpose of this list is to be able to accurately identify content embedded\n//in KMZ files. Eventually, we can make this configurable by the end user so they can add\n//there own content types if they have KMZ files that require it.\n\nvar MimeTypes = {\n  avi: \"video/x-msvideo\",\n  bmp: \"image/bmp\",\n  bz2: \"application/x-bzip2\",\n  chm: \"application/vnd.ms-htmlhelp\",\n  css: \"text/css\",\n  csv: \"text/csv\",\n  doc: \"application/msword\",\n  dvi: \"application/x-dvi\",\n  eps: \"application/postscript\",\n  flv: \"video/x-flv\",\n  gif: \"image/gif\",\n  gz: \"application/x-gzip\",\n  htm: \"text/html\",\n  html: \"text/html\",\n  ico: \"image/vnd.microsoft.icon\",\n  jnlp: \"application/x-java-jnlp-file\",\n  jpeg: \"image/jpeg\",\n  jpg: \"image/jpeg\",\n  m3u: \"audio/x-mpegurl\",\n  m4v: \"video/mp4\",\n  mathml: \"application/mathml+xml\",\n  mid: \"audio/midi\",\n  midi: \"audio/midi\",\n  mov: \"video/quicktime\",\n  mp3: \"audio/mpeg\",\n  mp4: \"video/mp4\",\n  mp4v: \"video/mp4\",\n  mpeg: \"video/mpeg\",\n  mpg: \"video/mpeg\",\n  odp: \"application/vnd.oasis.opendocument.presentation\",\n  ods: \"application/vnd.oasis.opendocument.spreadsheet\",\n  odt: \"application/vnd.oasis.opendocument.text\",\n  ogg: \"application/ogg\",\n  pdf: \"application/pdf\",\n  png: \"image/png\",\n  pps: \"application/vnd.ms-powerpoint\",\n  ppt: \"application/vnd.ms-powerpoint\",\n  ps: \"application/postscript\",\n  qt: \"video/quicktime\",\n  rdf: \"application/rdf+xml\",\n  rss: \"application/rss+xml\",\n  rtf: \"application/rtf\",\n  svg: \"image/svg+xml\",\n  swf: \"application/x-shockwave-flash\",\n  text: \"text/plain\",\n  tif: \"image/tiff\",\n  tiff: \"image/tiff\",\n  txt: \"text/plain\",\n  wav: \"audio/x-wav\",\n  wma: \"audio/x-ms-wma\",\n  wmv: \"video/x-ms-wmv\",\n  xml: \"application/xml\",\n  zip: \"application/zip\",\n  detectFromFilename: function (filename) {\n    var ext = filename.toLowerCase();\n    ext = getExtensionFromUri(ext);\n    return MimeTypes[ext];\n  }\n};\nvar parser;\n\nif (typeof DOMParser !== \"undefined\") {\n  parser = new DOMParser();\n}\n\nvar autolinker = new Autolinker({\n  stripPrefix: false,\n  email: false,\n  replaceFn: function (match) {\n    if (!match.protocolUrlMatch) {\n      //Prevent matching of non-explicit urls.\n      //i.e. foo.id won't match but http://foo.id will\n      return false;\n    }\n  }\n});\nvar BILLBOARD_SIZE = 32;\nvar BILLBOARD_NEAR_DISTANCE = 2414016;\nvar BILLBOARD_NEAR_RATIO = 1.0;\nvar BILLBOARD_FAR_DISTANCE = 1.6093e7;\nvar BILLBOARD_FAR_RATIO = 0.1;\nvar kmlNamespaces = [null, undefined, \"http://www.opengis.net/kml/2.2\", \"http://earth.google.com/kml/2.2\", \"http://earth.google.com/kml/2.1\", \"http://earth.google.com/kml/2.0\"];\nvar gxNamespaces = [\"http://www.google.com/kml/ext/2.2\"];\nvar atomNamespaces = [\"http://www.w3.org/2005/Atom\"];\nvar namespaces = {\n  kml: kmlNamespaces,\n  gx: gxNamespaces,\n  atom: atomNamespaces,\n  kmlgx: kmlNamespaces.concat(gxNamespaces)\n}; // Ensure Specs/Data/KML/unsupported.kml is kept up to date with these supported types\n\nvar featureTypes = {\n  Document: processDocument,\n  Folder: processFolder,\n  Placemark: processPlacemark,\n  NetworkLink: processNetworkLink,\n  GroundOverlay: processGroundOverlay,\n  PhotoOverlay: processUnsupportedFeature,\n  ScreenOverlay: processUnsupportedFeature,\n  Tour: processTour\n};\n\nfunction DeferredLoading(dataSource) {\n  this._dataSource = dataSource;\n  this._deferred = when.defer();\n  this._stack = [];\n  this._promises = [];\n  this._timeoutSet = false;\n  this._used = false;\n  this._started = 0;\n  this._timeThreshold = 1000; // Initial load is 1 second\n}\n\nObject.defineProperties(DeferredLoading.prototype, {\n  dataSource: {\n    get: function () {\n      return this._dataSource;\n    }\n  }\n});\n\nDeferredLoading.prototype.addNodes = function (nodes, processingData) {\n  this._stack.push({\n    nodes: nodes,\n    index: 0,\n    processingData: processingData\n  });\n\n  this._used = true;\n};\n\nDeferredLoading.prototype.addPromise = function (promise) {\n  this._promises.push(promise);\n};\n\nDeferredLoading.prototype.wait = function () {\n  // Case where we had a non-document/folder as the root\n  var deferred = this._deferred;\n\n  if (!this._used) {\n    deferred.resolve();\n  }\n\n  return when.join(deferred.promise, when.all(this._promises));\n};\n\nDeferredLoading.prototype.process = function () {\n  var isFirstCall = this._stack.length === 1;\n\n  if (isFirstCall) {\n    this._started = KmlDataSource._getTimestamp();\n  }\n\n  return this._process(isFirstCall);\n};\n\nDeferredLoading.prototype._giveUpTime = function () {\n  if (this._timeoutSet) {\n    // Timeout was already set so just return\n    return;\n  }\n\n  this._timeoutSet = true;\n  this._timeThreshold = 50; // After the first load lower threshold to 0.5 seconds\n\n  var that = this;\n  setTimeout(function () {\n    that._timeoutSet = false;\n    that._started = KmlDataSource._getTimestamp();\n\n    that._process(true);\n  }, 0);\n};\n\nDeferredLoading.prototype._nextNode = function () {\n  var stack = this._stack;\n  var top = stack[stack.length - 1];\n  var index = top.index;\n  var nodes = top.nodes;\n\n  if (index === nodes.length) {\n    return;\n  }\n\n  ++top.index;\n  return nodes[index];\n};\n\nDeferredLoading.prototype._pop = function () {\n  var stack = this._stack;\n  stack.pop(); // Return false if we are done\n\n  if (stack.length === 0) {\n    this._deferred.resolve();\n\n    return false;\n  }\n\n  return true;\n};\n\nDeferredLoading.prototype._process = function (isFirstCall) {\n  var dataSource = this.dataSource;\n  var processingData = this._stack[this._stack.length - 1].processingData;\n\n  var child = this._nextNode();\n\n  while (defined(child)) {\n    var featureProcessor = featureTypes[child.localName];\n\n    if (defined(featureProcessor) && (namespaces.kml.indexOf(child.namespaceURI) !== -1 || namespaces.gx.indexOf(child.namespaceURI) !== -1)) {\n      featureProcessor(dataSource, child, processingData, this); // Give up time and continue loading later\n\n      if (this._timeoutSet || KmlDataSource._getTimestamp() > this._started + this._timeThreshold) {\n        this._giveUpTime();\n\n        return;\n      }\n    }\n\n    child = this._nextNode();\n  } // If we are a recursive call from a subfolder, just return so the parent folder can continue processing\n  // If we aren't then make another call to processNodes because there is stuff still left in the queue\n\n\n  if (this._pop() && isFirstCall) {\n    this._process(true);\n  }\n};\n\nfunction isZipFile(blob) {\n  var magicBlob = blob.slice(0, Math.min(4, blob.size));\n  var deferred = when.defer();\n  var reader = new FileReader();\n  reader.addEventListener(\"load\", function () {\n    deferred.resolve(new DataView(reader.result).getUint32(0, false) === 0x504b0304);\n  });\n  reader.addEventListener(\"error\", function () {\n    deferred.reject(reader.error);\n  });\n  reader.readAsArrayBuffer(magicBlob);\n  return deferred.promise;\n}\n\nfunction readBlobAsText(blob) {\n  var deferred = when.defer();\n  var reader = new FileReader();\n  reader.addEventListener(\"load\", function () {\n    deferred.resolve(reader.result);\n  });\n  reader.addEventListener(\"error\", function () {\n    deferred.reject(reader.error);\n  });\n  reader.readAsText(blob);\n  return deferred.promise;\n}\n\nfunction insertNamespaces(text) {\n  var namespaceMap = {\n    xsi: \"http://www.w3.org/2001/XMLSchema-instance\"\n  };\n  var firstPart, lastPart, reg, declaration;\n\n  for (var key in namespaceMap) {\n    if (namespaceMap.hasOwnProperty(key)) {\n      reg = RegExp(\"[< ]\" + key + \":\");\n      declaration = \"xmlns:\" + key + \"=\";\n\n      if (reg.test(text) && text.indexOf(declaration) === -1) {\n        if (!defined(firstPart)) {\n          firstPart = text.substr(0, text.indexOf(\"<kml\") + 4);\n          lastPart = text.substr(firstPart.length);\n        }\n\n        firstPart += \" \" + declaration + '\"' + namespaceMap[key] + '\"';\n      }\n    }\n  }\n\n  if (defined(firstPart)) {\n    text = firstPart + lastPart;\n  }\n\n  return text;\n}\n\nfunction removeDuplicateNamespaces(text) {\n  var index = text.indexOf(\"xmlns:\");\n  var endDeclaration = text.indexOf(\">\", index);\n  var namespace, startIndex, endIndex;\n\n  while (index !== -1 && index < endDeclaration) {\n    namespace = text.slice(index, text.indexOf('\"', index));\n    startIndex = index;\n    index = text.indexOf(namespace, index + 1);\n\n    if (index !== -1) {\n      endIndex = text.indexOf('\"', text.indexOf('\"', index) + 1);\n      text = text.slice(0, index - 1) + text.slice(endIndex + 1, text.length);\n      index = text.indexOf(\"xmlns:\", startIndex - 1);\n    } else {\n      index = text.indexOf(\"xmlns:\", startIndex + 1);\n    }\n  }\n\n  return text;\n}\n\nfunction loadXmlFromZip(entry, uriResolver, deferred) {\n  entry.getData(new zip.TextWriter(), function (text) {\n    text = insertNamespaces(text);\n    text = removeDuplicateNamespaces(text);\n    uriResolver.kml = parser.parseFromString(text, \"application/xml\");\n    deferred.resolve();\n  });\n}\n\nfunction loadDataUriFromZip(entry, uriResolver, deferred) {\n  var mimeType = defaultValue(MimeTypes.detectFromFilename(entry.filename), \"application/octet-stream\");\n  entry.getData(new zip.Data64URIWriter(mimeType), function (dataUri) {\n    uriResolver[entry.filename] = dataUri;\n    deferred.resolve();\n  });\n}\n\nfunction embedDataUris(div, elementType, attributeName, uriResolver) {\n  var keys = uriResolver.keys;\n  var baseUri = new Uri(\".\");\n  var elements = div.querySelectorAll(elementType);\n\n  for (var i = 0; i < elements.length; i++) {\n    var element = elements[i];\n    var value = element.getAttribute(attributeName);\n    var uri = new Uri(value).resolve(baseUri).toString();\n    var index = keys.indexOf(uri);\n\n    if (index !== -1) {\n      var key = keys[index];\n      element.setAttribute(attributeName, uriResolver[key]);\n\n      if (elementType === \"a\" && element.getAttribute(\"download\") === null) {\n        element.setAttribute(\"download\", key);\n      }\n    }\n  }\n}\n\nfunction applyBasePath(div, elementType, attributeName, sourceResource) {\n  var elements = div.querySelectorAll(elementType);\n\n  for (var i = 0; i < elements.length; i++) {\n    var element = elements[i];\n    var value = element.getAttribute(attributeName);\n    var resource = resolveHref(value, sourceResource);\n    element.setAttribute(attributeName, resource.url);\n  }\n} // an optional context is passed to allow for some malformed kmls (those with multiple geometries with same ids) to still parse\n// correctly, as they do in Google Earth.\n\n\nfunction createEntity(node, entityCollection, context) {\n  var id = queryStringAttribute(node, \"id\");\n  id = defined(id) && id.length !== 0 ? id : createGuid();\n\n  if (defined(context)) {\n    id = context + id;\n  } // If we have a duplicate ID just generate one.\n  // This isn't valid KML but Google Earth handles this case.\n\n\n  var entity = entityCollection.getById(id);\n\n  if (defined(entity)) {\n    id = createGuid();\n\n    if (defined(context)) {\n      id = context + id;\n    }\n  }\n\n  entity = entityCollection.add(new Entity({\n    id: id\n  }));\n\n  if (!defined(entity.kml)) {\n    entity.addProperty(\"kml\");\n    entity.kml = new KmlFeatureData();\n  }\n\n  return entity;\n}\n\nfunction isExtrudable(altitudeMode, gxAltitudeMode) {\n  return altitudeMode === \"absolute\" || altitudeMode === \"relativeToGround\" || gxAltitudeMode === \"relativeToSeaFloor\";\n}\n\nfunction readCoordinate(value, ellipsoid) {\n  //Google Earth treats empty or missing coordinates as 0.\n  if (!defined(value)) {\n    return Cartesian3.fromDegrees(0, 0, 0, ellipsoid);\n  }\n\n  var digits = value.match(/[^\\s,\\n]+/g);\n\n  if (!defined(digits)) {\n    return Cartesian3.fromDegrees(0, 0, 0, ellipsoid);\n  }\n\n  var longitude = parseFloat(digits[0]);\n  var latitude = parseFloat(digits[1]);\n  var height = parseFloat(digits[2]);\n  longitude = isNaN(longitude) ? 0.0 : longitude;\n  latitude = isNaN(latitude) ? 0.0 : latitude;\n  height = isNaN(height) ? 0.0 : height;\n  return Cartesian3.fromDegrees(longitude, latitude, height, ellipsoid);\n}\n\nfunction readCoordinates(element, ellipsoid) {\n  if (!defined(element)) {\n    return undefined;\n  }\n\n  var tuples = element.textContent.match(/[^\\s\\n]+/g);\n\n  if (!defined(tuples)) {\n    return undefined;\n  }\n\n  var length = tuples.length;\n  var result = new Array(length);\n  var resultIndex = 0;\n\n  for (var i = 0; i < length; i++) {\n    result[resultIndex++] = readCoordinate(tuples[i], ellipsoid);\n  }\n\n  return result;\n}\n\nfunction queryNumericAttribute(node, attributeName) {\n  if (!defined(node)) {\n    return undefined;\n  }\n\n  var value = node.getAttribute(attributeName);\n\n  if (value !== null) {\n    var result = parseFloat(value);\n    return !isNaN(result) ? result : undefined;\n  }\n\n  return undefined;\n}\n\nfunction queryStringAttribute(node, attributeName) {\n  if (!defined(node)) {\n    return undefined;\n  }\n\n  var value = node.getAttribute(attributeName);\n  return value !== null ? value : undefined;\n}\n\nfunction queryFirstNode(node, tagName, namespace) {\n  if (!defined(node)) {\n    return undefined;\n  }\n\n  var childNodes = node.childNodes;\n  var length = childNodes.length;\n\n  for (var q = 0; q < length; q++) {\n    var child = childNodes[q];\n\n    if (child.localName === tagName && namespace.indexOf(child.namespaceURI) !== -1) {\n      return child;\n    }\n  }\n\n  return undefined;\n}\n\nfunction queryNodes(node, tagName, namespace) {\n  if (!defined(node)) {\n    return undefined;\n  }\n\n  var result = [];\n  var childNodes = node.getElementsByTagNameNS(\"*\", tagName);\n  var length = childNodes.length;\n\n  for (var q = 0; q < length; q++) {\n    var child = childNodes[q];\n\n    if (child.localName === tagName && namespace.indexOf(child.namespaceURI) !== -1) {\n      result.push(child);\n    }\n  }\n\n  return result;\n}\n\nfunction queryChildNodes(node, tagName, namespace) {\n  if (!defined(node)) {\n    return [];\n  }\n\n  var result = [];\n  var childNodes = node.childNodes;\n  var length = childNodes.length;\n\n  for (var q = 0; q < length; q++) {\n    var child = childNodes[q];\n\n    if (child.localName === tagName && namespace.indexOf(child.namespaceURI) !== -1) {\n      result.push(child);\n    }\n  }\n\n  return result;\n}\n\nfunction queryNumericValue(node, tagName, namespace) {\n  var resultNode = queryFirstNode(node, tagName, namespace);\n\n  if (defined(resultNode)) {\n    var result = parseFloat(resultNode.textContent);\n    return !isNaN(result) ? result : undefined;\n  }\n\n  return undefined;\n}\n\nfunction queryStringValue(node, tagName, namespace) {\n  var result = queryFirstNode(node, tagName, namespace);\n\n  if (defined(result)) {\n    return result.textContent.trim();\n  }\n\n  return undefined;\n}\n\nfunction queryBooleanValue(node, tagName, namespace) {\n  var result = queryFirstNode(node, tagName, namespace);\n\n  if (defined(result)) {\n    var value = result.textContent.trim();\n    return value === \"1\" || /^true$/i.test(value);\n  }\n\n  return undefined;\n}\n\nfunction resolveHref(href, sourceResource, uriResolver) {\n  if (!defined(href)) {\n    return undefined;\n  }\n\n  var resource;\n\n  if (defined(uriResolver)) {\n    // To resolve issues with KML sources defined in Windows style paths.\n    href = href.replace(/\\\\/g, \"/\");\n    var blob = uriResolver[href];\n\n    if (defined(blob)) {\n      resource = new Resource({\n        url: blob\n      });\n    } else {\n      // Needed for multiple levels of KML files in a KMZ\n      var baseUri = new Uri(sourceResource.getUrlComponent());\n      var uri = new Uri(href);\n      blob = uriResolver[uri.resolve(baseUri)];\n\n      if (defined(blob)) {\n        resource = new Resource({\n          url: blob\n        });\n      }\n    }\n  }\n\n  if (!defined(resource)) {\n    resource = sourceResource.getDerivedResource({\n      url: href\n    });\n  }\n\n  return resource;\n}\n\nvar colorOptions = {\n  maximumRed: undefined,\n  red: undefined,\n  maximumGreen: undefined,\n  green: undefined,\n  maximumBlue: undefined,\n  blue: undefined\n};\n\nfunction parseColorString(value, isRandom) {\n  if (!defined(value) || /^\\s*$/gm.test(value)) {\n    return undefined;\n  }\n\n  if (value[0] === \"#\") {\n    value = value.substring(1);\n  }\n\n  var alpha = parseInt(value.substring(0, 2), 16) / 255.0;\n  var blue = parseInt(value.substring(2, 4), 16) / 255.0;\n  var green = parseInt(value.substring(4, 6), 16) / 255.0;\n  var red = parseInt(value.substring(6, 8), 16) / 255.0;\n\n  if (!isRandom) {\n    return new Color(red, green, blue, alpha);\n  }\n\n  if (red > 0) {\n    colorOptions.maximumRed = red;\n    colorOptions.red = undefined;\n  } else {\n    colorOptions.maximumRed = undefined;\n    colorOptions.red = 0;\n  }\n\n  if (green > 0) {\n    colorOptions.maximumGreen = green;\n    colorOptions.green = undefined;\n  } else {\n    colorOptions.maximumGreen = undefined;\n    colorOptions.green = 0;\n  }\n\n  if (blue > 0) {\n    colorOptions.maximumBlue = blue;\n    colorOptions.blue = undefined;\n  } else {\n    colorOptions.maximumBlue = undefined;\n    colorOptions.blue = 0;\n  }\n\n  colorOptions.alpha = alpha;\n  return Color.fromRandom(colorOptions);\n}\n\nfunction queryColorValue(node, tagName, namespace) {\n  var value = queryStringValue(node, tagName, namespace);\n\n  if (!defined(value)) {\n    return undefined;\n  }\n\n  return parseColorString(value, queryStringValue(node, \"colorMode\", namespace) === \"random\");\n}\n\nfunction processTimeStamp(featureNode) {\n  var node = queryFirstNode(featureNode, \"TimeStamp\", namespaces.kmlgx);\n  var whenString = queryStringValue(node, \"when\", namespaces.kmlgx);\n\n  if (!defined(node) || !defined(whenString) || whenString.length === 0) {\n    return undefined;\n  } //According to the KML spec, a TimeStamp represents a \"single moment in time\"\n  //However, since Cesium animates much differently than Google Earth, that doesn't\n  //Make much sense here.  Instead, we use the TimeStamp as the moment the feature\n  //comes into existence.  This works much better and gives a similar feel to\n  //GE's experience.\n\n\n  var when = JulianDate.fromIso8601(whenString);\n  var result = new TimeIntervalCollection();\n  result.addInterval(new TimeInterval({\n    start: when,\n    stop: Iso8601.MAXIMUM_VALUE\n  }));\n  return result;\n}\n\nfunction processTimeSpan(featureNode) {\n  var node = queryFirstNode(featureNode, \"TimeSpan\", namespaces.kmlgx);\n\n  if (!defined(node)) {\n    return undefined;\n  }\n\n  var result;\n  var beginNode = queryFirstNode(node, \"begin\", namespaces.kmlgx);\n  var beginDate = defined(beginNode) ? JulianDate.fromIso8601(beginNode.textContent) : undefined;\n  var endNode = queryFirstNode(node, \"end\", namespaces.kmlgx);\n  var endDate = defined(endNode) ? JulianDate.fromIso8601(endNode.textContent) : undefined;\n\n  if (defined(beginDate) && defined(endDate)) {\n    if (JulianDate.lessThan(endDate, beginDate)) {\n      var tmp = beginDate;\n      beginDate = endDate;\n      endDate = tmp;\n    }\n\n    result = new TimeIntervalCollection();\n    result.addInterval(new TimeInterval({\n      start: beginDate,\n      stop: endDate\n    }));\n  } else if (defined(beginDate)) {\n    result = new TimeIntervalCollection();\n    result.addInterval(new TimeInterval({\n      start: beginDate,\n      stop: Iso8601.MAXIMUM_VALUE\n    }));\n  } else if (defined(endDate)) {\n    result = new TimeIntervalCollection();\n    result.addInterval(new TimeInterval({\n      start: Iso8601.MINIMUM_VALUE,\n      stop: endDate\n    }));\n  }\n\n  return result;\n}\n\nfunction createDefaultBillboard() {\n  var billboard = new BillboardGraphics();\n  billboard.width = BILLBOARD_SIZE;\n  billboard.height = BILLBOARD_SIZE;\n  billboard.scaleByDistance = new NearFarScalar(BILLBOARD_NEAR_DISTANCE, BILLBOARD_NEAR_RATIO, BILLBOARD_FAR_DISTANCE, BILLBOARD_FAR_RATIO);\n  billboard.pixelOffsetScaleByDistance = new NearFarScalar(BILLBOARD_NEAR_DISTANCE, BILLBOARD_NEAR_RATIO, BILLBOARD_FAR_DISTANCE, BILLBOARD_FAR_RATIO);\n  return billboard;\n}\n\nfunction createDefaultPolygon() {\n  var polygon = new PolygonGraphics();\n  polygon.outline = true;\n  polygon.outlineColor = Color.WHITE;\n  return polygon;\n}\n\nfunction createDefaultLabel() {\n  var label = new LabelGraphics();\n  label.translucencyByDistance = new NearFarScalar(3000000, 1.0, 5000000, 0.0);\n  label.pixelOffset = new Cartesian2(17, 0);\n  label.horizontalOrigin = HorizontalOrigin.LEFT;\n  label.font = \"16px sans-serif\";\n  label.style = LabelStyle.FILL_AND_OUTLINE;\n  return label;\n}\n\nfunction getIconHref(iconNode, dataSource, sourceResource, uriResolver, canRefresh) {\n  var href = queryStringValue(iconNode, \"href\", namespaces.kml);\n\n  if (!defined(href) || href.length === 0) {\n    return undefined;\n  }\n\n  if (href.indexOf(\"root://icons/palette-\") === 0) {\n    var palette = href.charAt(21); // Get the icon number\n\n    var x = defaultValue(queryNumericValue(iconNode, \"x\", namespaces.gx), 0);\n    var y = defaultValue(queryNumericValue(iconNode, \"y\", namespaces.gx), 0);\n    x = Math.min(x / 32, 7);\n    y = 7 - Math.min(y / 32, 7);\n    var iconNum = 8 * y + x;\n    href = \"https://maps.google.com/mapfiles/kml/pal\" + palette + \"/icon\" + iconNum + \".png\";\n  }\n\n  var hrefResource = resolveHref(href, sourceResource, uriResolver);\n\n  if (canRefresh) {\n    var refreshMode = queryStringValue(iconNode, \"refreshMode\", namespaces.kml);\n    var viewRefreshMode = queryStringValue(iconNode, \"viewRefreshMode\", namespaces.kml);\n\n    if (refreshMode === \"onInterval\" || refreshMode === \"onExpire\") {\n      oneTimeWarning(\"kml-refreshMode-\" + refreshMode, \"KML - Unsupported Icon refreshMode: \" + refreshMode);\n    } else if (viewRefreshMode === \"onStop\" || viewRefreshMode === \"onRegion\") {\n      oneTimeWarning(\"kml-refreshMode-\" + viewRefreshMode, \"KML - Unsupported Icon viewRefreshMode: \" + viewRefreshMode);\n    }\n\n    var viewBoundScale = defaultValue(queryStringValue(iconNode, \"viewBoundScale\", namespaces.kml), 1.0);\n    var defaultViewFormat = viewRefreshMode === \"onStop\" ? \"BBOX=[bboxWest],[bboxSouth],[bboxEast],[bboxNorth]\" : \"\";\n    var viewFormat = defaultValue(queryStringValue(iconNode, \"viewFormat\", namespaces.kml), defaultViewFormat);\n    var httpQuery = queryStringValue(iconNode, \"httpQuery\", namespaces.kml);\n\n    if (defined(viewFormat)) {\n      hrefResource.setQueryParameters(queryToObject(cleanupString(viewFormat)));\n    }\n\n    if (defined(httpQuery)) {\n      hrefResource.setQueryParameters(queryToObject(cleanupString(httpQuery)));\n    }\n\n    var ellipsoid = dataSource._ellipsoid;\n    processNetworkLinkQueryString(hrefResource, dataSource._camera, dataSource._canvas, viewBoundScale, dataSource._lastCameraView.bbox, ellipsoid);\n    return hrefResource;\n  }\n\n  return hrefResource;\n}\n\nfunction processBillboardIcon(dataSource, node, targetEntity, sourceResource, uriResolver) {\n  var scale = queryNumericValue(node, \"scale\", namespaces.kml);\n  var heading = queryNumericValue(node, \"heading\", namespaces.kml);\n  var color = queryColorValue(node, \"color\", namespaces.kml);\n  var iconNode = queryFirstNode(node, \"Icon\", namespaces.kml);\n  var icon = getIconHref(iconNode, dataSource, sourceResource, uriResolver, false); // If icon tags are present but blank, we do not want to show an icon\n\n  if (defined(iconNode) && !defined(icon)) {\n    icon = false;\n  }\n\n  var x = queryNumericValue(iconNode, \"x\", namespaces.gx);\n  var y = queryNumericValue(iconNode, \"y\", namespaces.gx);\n  var w = queryNumericValue(iconNode, \"w\", namespaces.gx);\n  var h = queryNumericValue(iconNode, \"h\", namespaces.gx);\n  var hotSpotNode = queryFirstNode(node, \"hotSpot\", namespaces.kml);\n  var hotSpotX = queryNumericAttribute(hotSpotNode, \"x\");\n  var hotSpotY = queryNumericAttribute(hotSpotNode, \"y\");\n  var hotSpotXUnit = queryStringAttribute(hotSpotNode, \"xunits\");\n  var hotSpotYUnit = queryStringAttribute(hotSpotNode, \"yunits\");\n  var billboard = targetEntity.billboard;\n\n  if (!defined(billboard)) {\n    billboard = createDefaultBillboard();\n    targetEntity.billboard = billboard;\n  }\n\n  billboard.image = icon;\n  billboard.scale = scale;\n  billboard.color = color;\n\n  if (defined(x) || defined(y) || defined(w) || defined(h)) {\n    billboard.imageSubRegion = new BoundingRectangle(x, y, w, h);\n  } //GE treats a heading of zero as no heading\n  //You can still point north using a 360 degree angle (or any multiple of 360)\n\n\n  if (defined(heading) && heading !== 0) {\n    billboard.rotation = CesiumMath.toRadians(-heading);\n    billboard.alignedAxis = Cartesian3.UNIT_Z;\n  } //Hotpot is the KML equivalent of pixel offset\n  //The hotspot origin is the lower left, but we leave\n  //our billboard origin at the center and simply\n  //modify the pixel offset to take this into account\n\n\n  scale = defaultValue(scale, 1.0);\n  var xOffset;\n  var yOffset;\n\n  if (defined(hotSpotX)) {\n    if (hotSpotXUnit === \"pixels\") {\n      xOffset = -hotSpotX * scale;\n    } else if (hotSpotXUnit === \"insetPixels\") {\n      xOffset = (hotSpotX - BILLBOARD_SIZE) * scale;\n    } else if (hotSpotXUnit === \"fraction\") {\n      xOffset = -hotSpotX * BILLBOARD_SIZE * scale;\n    }\n\n    xOffset += BILLBOARD_SIZE * 0.5 * scale;\n  }\n\n  if (defined(hotSpotY)) {\n    if (hotSpotYUnit === \"pixels\") {\n      yOffset = hotSpotY * scale;\n    } else if (hotSpotYUnit === \"insetPixels\") {\n      yOffset = (-hotSpotY + BILLBOARD_SIZE) * scale;\n    } else if (hotSpotYUnit === \"fraction\") {\n      yOffset = hotSpotY * BILLBOARD_SIZE * scale;\n    }\n\n    yOffset -= BILLBOARD_SIZE * 0.5 * scale;\n  }\n\n  if (defined(xOffset) || defined(yOffset)) {\n    billboard.pixelOffset = new Cartesian2(xOffset, yOffset);\n  }\n}\n\nfunction applyStyle(dataSource, styleNode, targetEntity, sourceResource, uriResolver) {\n  for (var i = 0, len = styleNode.childNodes.length; i < len; i++) {\n    var node = styleNode.childNodes.item(i);\n\n    if (node.localName === \"IconStyle\") {\n      processBillboardIcon(dataSource, node, targetEntity, sourceResource, uriResolver);\n    } else if (node.localName === \"LabelStyle\") {\n      var label = targetEntity.label;\n\n      if (!defined(label)) {\n        label = createDefaultLabel();\n        targetEntity.label = label;\n      }\n\n      label.scale = defaultValue(queryNumericValue(node, \"scale\", namespaces.kml), label.scale);\n      label.fillColor = defaultValue(queryColorValue(node, \"color\", namespaces.kml), label.fillColor);\n      label.text = targetEntity.name;\n    } else if (node.localName === \"LineStyle\") {\n      var polyline = targetEntity.polyline;\n\n      if (!defined(polyline)) {\n        polyline = new PolylineGraphics();\n        targetEntity.polyline = polyline;\n      }\n\n      polyline.width = queryNumericValue(node, \"width\", namespaces.kml);\n      polyline.material = queryColorValue(node, \"color\", namespaces.kml);\n\n      if (defined(queryColorValue(node, \"outerColor\", namespaces.gx))) {\n        oneTimeWarning(\"kml-gx:outerColor\", \"KML - gx:outerColor is not supported in a LineStyle\");\n      }\n\n      if (defined(queryNumericValue(node, \"outerWidth\", namespaces.gx))) {\n        oneTimeWarning(\"kml-gx:outerWidth\", \"KML - gx:outerWidth is not supported in a LineStyle\");\n      }\n\n      if (defined(queryNumericValue(node, \"physicalWidth\", namespaces.gx))) {\n        oneTimeWarning(\"kml-gx:physicalWidth\", \"KML - gx:physicalWidth is not supported in a LineStyle\");\n      }\n\n      if (defined(queryBooleanValue(node, \"labelVisibility\", namespaces.gx))) {\n        oneTimeWarning(\"kml-gx:labelVisibility\", \"KML - gx:labelVisibility is not supported in a LineStyle\");\n      }\n    } else if (node.localName === \"PolyStyle\") {\n      var polygon = targetEntity.polygon;\n\n      if (!defined(polygon)) {\n        polygon = createDefaultPolygon();\n        targetEntity.polygon = polygon;\n      }\n\n      polygon.material = defaultValue(queryColorValue(node, \"color\", namespaces.kml), polygon.material);\n      polygon.fill = defaultValue(queryBooleanValue(node, \"fill\", namespaces.kml), polygon.fill);\n      polygon.outline = defaultValue(queryBooleanValue(node, \"outline\", namespaces.kml), polygon.outline);\n    } else if (node.localName === \"BalloonStyle\") {\n      var bgColor = defaultValue(parseColorString(queryStringValue(node, \"bgColor\", namespaces.kml)), Color.WHITE);\n      var textColor = defaultValue(parseColorString(queryStringValue(node, \"textColor\", namespaces.kml)), Color.BLACK);\n      var text = queryStringValue(node, \"text\", namespaces.kml); //This is purely an internal property used in style processing,\n      //it never ends up on the final entity.\n\n      targetEntity.addProperty(\"balloonStyle\");\n      targetEntity.balloonStyle = {\n        bgColor: bgColor,\n        textColor: textColor,\n        text: text\n      };\n    } else if (node.localName === \"ListStyle\") {\n      var listItemType = queryStringValue(node, \"listItemType\", namespaces.kml);\n\n      if (listItemType === \"radioFolder\" || listItemType === \"checkOffOnly\") {\n        oneTimeWarning(\"kml-listStyle-\" + listItemType, \"KML - Unsupported ListStyle with listItemType: \" + listItemType);\n      }\n    }\n  }\n} //Processes and merges any inline styles for the provided node into the provided entity.\n\n\nfunction computeFinalStyle(dataSource, placeMark, styleCollection, sourceResource, uriResolver) {\n  var result = new Entity();\n  var styleEntity; //Google earth seems to always use the last inline Style/StyleMap only\n\n  var styleIndex = -1;\n  var childNodes = placeMark.childNodes;\n  var length = childNodes.length;\n\n  for (var q = 0; q < length; q++) {\n    var child = childNodes[q];\n\n    if (child.localName === \"Style\" || child.localName === \"StyleMap\") {\n      styleIndex = q;\n    }\n  }\n\n  if (styleIndex !== -1) {\n    var inlineStyleNode = childNodes[styleIndex];\n\n    if (inlineStyleNode.localName === \"Style\") {\n      applyStyle(dataSource, inlineStyleNode, result, sourceResource, uriResolver);\n    } else {\n      // StyleMap\n      var pairs = queryChildNodes(inlineStyleNode, \"Pair\", namespaces.kml);\n\n      for (var p = 0; p < pairs.length; p++) {\n        var pair = pairs[p];\n        var key = queryStringValue(pair, \"key\", namespaces.kml);\n\n        if (key === \"normal\") {\n          var styleUrl = queryStringValue(pair, \"styleUrl\", namespaces.kml);\n\n          if (defined(styleUrl)) {\n            styleEntity = styleCollection.getById(styleUrl);\n\n            if (!defined(styleEntity)) {\n              styleEntity = styleCollection.getById(\"#\" + styleUrl);\n            }\n\n            if (defined(styleEntity)) {\n              result.merge(styleEntity);\n            }\n          } else {\n            var node = queryFirstNode(pair, \"Style\", namespaces.kml);\n            applyStyle(dataSource, node, result, sourceResource, uriResolver);\n          }\n        } else {\n          oneTimeWarning(\"kml-styleMap-\" + key, \"KML - Unsupported StyleMap key: \" + key);\n        }\n      }\n    }\n  } //Google earth seems to always use the first external style only.\n\n\n  var externalStyle = queryStringValue(placeMark, \"styleUrl\", namespaces.kml);\n\n  if (defined(externalStyle)) {\n    var id = externalStyle;\n\n    if (externalStyle[0] !== \"#\" && externalStyle.indexOf(\"#\") !== -1) {\n      var tokens = externalStyle.split(\"#\");\n      var uri = tokens[0];\n      var resource = sourceResource.getDerivedResource({\n        url: uri\n      });\n      id = resource.getUrlComponent() + \"#\" + tokens[1];\n    }\n\n    styleEntity = styleCollection.getById(id);\n\n    if (!defined(styleEntity)) {\n      styleEntity = styleCollection.getById(\"#\" + id);\n    }\n\n    if (defined(styleEntity)) {\n      result.merge(styleEntity);\n    }\n  }\n\n  return result;\n} //Asynchronously processes an external style file.\n\n\nfunction processExternalStyles(dataSource, resource, styleCollection) {\n  return resource.fetchXML().then(function (styleKml) {\n    return processStyles(dataSource, styleKml, styleCollection, resource, true);\n  });\n} //Processes all shared and external styles and stores\n//their id into the provided styleCollection.\n//Returns an array of promises that will resolve when\n//each style is loaded.\n\n\nfunction processStyles(dataSource, kml, styleCollection, sourceResource, isExternal, uriResolver) {\n  var i;\n  var id;\n  var styleEntity;\n  var node;\n  var styleNodes = queryNodes(kml, \"Style\", namespaces.kml);\n\n  if (defined(styleNodes)) {\n    var styleNodesLength = styleNodes.length;\n\n    for (i = 0; i < styleNodesLength; i++) {\n      node = styleNodes[i];\n      id = queryStringAttribute(node, \"id\");\n\n      if (defined(id)) {\n        id = \"#\" + id;\n\n        if (isExternal && defined(sourceResource)) {\n          id = sourceResource.getUrlComponent() + id;\n        }\n\n        if (!defined(styleCollection.getById(id))) {\n          styleEntity = new Entity({\n            id: id\n          });\n          styleCollection.add(styleEntity);\n          applyStyle(dataSource, node, styleEntity, sourceResource, uriResolver);\n        }\n      }\n    }\n  }\n\n  var styleMaps = queryNodes(kml, \"StyleMap\", namespaces.kml);\n\n  if (defined(styleMaps)) {\n    var styleMapsLength = styleMaps.length;\n\n    for (i = 0; i < styleMapsLength; i++) {\n      var styleMap = styleMaps[i];\n      id = queryStringAttribute(styleMap, \"id\");\n\n      if (defined(id)) {\n        var pairs = queryChildNodes(styleMap, \"Pair\", namespaces.kml);\n\n        for (var p = 0; p < pairs.length; p++) {\n          var pair = pairs[p];\n          var key = queryStringValue(pair, \"key\", namespaces.kml);\n\n          if (key === \"normal\") {\n            id = \"#\" + id;\n\n            if (isExternal && defined(sourceResource)) {\n              id = sourceResource.getUrlComponent() + id;\n            }\n\n            if (!defined(styleCollection.getById(id))) {\n              styleEntity = styleCollection.getOrCreateEntity(id);\n              var styleUrl = queryStringValue(pair, \"styleUrl\", namespaces.kml);\n\n              if (defined(styleUrl)) {\n                if (styleUrl[0] !== \"#\") {\n                  styleUrl = \"#\" + styleUrl;\n                }\n\n                if (isExternal && defined(sourceResource)) {\n                  styleUrl = sourceResource.getUrlComponent() + styleUrl;\n                }\n\n                var base = styleCollection.getById(styleUrl);\n\n                if (defined(base)) {\n                  styleEntity.merge(base);\n                }\n              } else {\n                node = queryFirstNode(pair, \"Style\", namespaces.kml);\n                applyStyle(dataSource, node, styleEntity, sourceResource, uriResolver);\n              }\n            }\n          } else {\n            oneTimeWarning(\"kml-styleMap-\" + key, \"KML - Unsupported StyleMap key: \" + key);\n          }\n        }\n      }\n    }\n  }\n\n  var promises = [];\n  var styleUrlNodes = kml.getElementsByTagName(\"styleUrl\");\n  var styleUrlNodesLength = styleUrlNodes.length;\n\n  for (i = 0; i < styleUrlNodesLength; i++) {\n    var styleReference = styleUrlNodes[i].textContent;\n\n    if (styleReference[0] !== \"#\") {\n      //According to the spec, all local styles should start with a #\n      //and everything else is an external style that has a # seperating\n      //the URL of the document and the style.  However, Google Earth\n      //also accepts styleUrls without a # as meaning a local style.\n      var tokens = styleReference.split(\"#\");\n\n      if (tokens.length === 2) {\n        var uri = tokens[0];\n        var resource = sourceResource.getDerivedResource({\n          url: uri\n        });\n        promises.push(processExternalStyles(dataSource, resource, styleCollection));\n      }\n    }\n  }\n\n  return promises;\n}\n\nfunction createDropLine(entityCollection, entity, styleEntity) {\n  var entityPosition = new ReferenceProperty(entityCollection, entity.id, [\"position\"]);\n  var surfacePosition = new ScaledPositionProperty(entity.position);\n  entity.polyline = defined(styleEntity.polyline) ? styleEntity.polyline.clone() : new PolylineGraphics();\n  entity.polyline.positions = new PositionPropertyArray([entityPosition, surfacePosition]);\n}\n\nfunction heightReferenceFromAltitudeMode(altitudeMode, gxAltitudeMode) {\n  if (!defined(altitudeMode) && !defined(gxAltitudeMode) || altitudeMode === \"clampToGround\") {\n    return HeightReference.CLAMP_TO_GROUND;\n  }\n\n  if (altitudeMode === \"relativeToGround\") {\n    return HeightReference.RELATIVE_TO_GROUND;\n  }\n\n  if (altitudeMode === \"absolute\") {\n    return HeightReference.NONE;\n  }\n\n  if (gxAltitudeMode === \"clampToSeaFloor\") {\n    oneTimeWarning(\"kml-gx:altitudeMode-clampToSeaFloor\", \"KML - <gx:altitudeMode>:clampToSeaFloor is currently not supported, using <kml:altitudeMode>:clampToGround.\");\n    return HeightReference.CLAMP_TO_GROUND;\n  }\n\n  if (gxAltitudeMode === \"relativeToSeaFloor\") {\n    oneTimeWarning(\"kml-gx:altitudeMode-relativeToSeaFloor\", \"KML - <gx:altitudeMode>:relativeToSeaFloor is currently not supported, using <kml:altitudeMode>:relativeToGround.\");\n    return HeightReference.RELATIVE_TO_GROUND;\n  }\n\n  if (defined(altitudeMode)) {\n    oneTimeWarning(\"kml-altitudeMode-unknown\", \"KML - Unknown <kml:altitudeMode>:\" + altitudeMode + \", using <kml:altitudeMode>:CLAMP_TO_GROUND.\");\n  } else {\n    oneTimeWarning(\"kml-gx:altitudeMode-unknown\", \"KML - Unknown <gx:altitudeMode>:\" + gxAltitudeMode + \", using <kml:altitudeMode>:CLAMP_TO_GROUND.\");\n  } // Clamp to ground is the default\n\n\n  return HeightReference.CLAMP_TO_GROUND;\n}\n\nfunction createPositionPropertyFromAltitudeMode(property, altitudeMode, gxAltitudeMode) {\n  if (gxAltitudeMode === \"relativeToSeaFloor\" || altitudeMode === \"absolute\" || altitudeMode === \"relativeToGround\") {\n    //Just return the ellipsoid referenced property until we support MSL\n    return property;\n  }\n\n  if (defined(altitudeMode) && altitudeMode !== \"clampToGround\" || //\n  defined(gxAltitudeMode) && gxAltitudeMode !== \"clampToSeaFloor\") {\n    oneTimeWarning(\"kml-altitudeMode-unknown\", \"KML - Unknown altitudeMode: \" + defaultValue(altitudeMode, gxAltitudeMode));\n  } // Clamp to ground is the default\n\n\n  return new ScaledPositionProperty(property);\n}\n\nfunction createPositionPropertyArrayFromAltitudeMode(properties, altitudeMode, gxAltitudeMode, ellipsoid) {\n  if (!defined(properties)) {\n    return undefined;\n  }\n\n  if (gxAltitudeMode === \"relativeToSeaFloor\" || altitudeMode === \"absolute\" || altitudeMode === \"relativeToGround\") {\n    //Just return the ellipsoid referenced property until we support MSL\n    return properties;\n  }\n\n  if (defined(altitudeMode) && altitudeMode !== \"clampToGround\" || //\n  defined(gxAltitudeMode) && gxAltitudeMode !== \"clampToSeaFloor\") {\n    oneTimeWarning(\"kml-altitudeMode-unknown\", \"KML - Unknown altitudeMode: \" + defaultValue(altitudeMode, gxAltitudeMode));\n  } // Clamp to ground is the default\n\n\n  var propertiesLength = properties.length;\n\n  for (var i = 0; i < propertiesLength; i++) {\n    var property = properties[i];\n    ellipsoid.scaleToGeodeticSurface(property, property);\n  }\n\n  return properties;\n}\n\nfunction processPositionGraphics(dataSource, entity, styleEntity, heightReference) {\n  var label = entity.label;\n\n  if (!defined(label)) {\n    label = defined(styleEntity.label) ? styleEntity.label.clone() : createDefaultLabel();\n    entity.label = label;\n  }\n\n  label.text = entity.name;\n  var billboard = entity.billboard;\n\n  if (!defined(billboard)) {\n    billboard = defined(styleEntity.billboard) ? styleEntity.billboard.clone() : createDefaultBillboard();\n    entity.billboard = billboard;\n  }\n\n  if (!defined(billboard.image)) {\n    billboard.image = dataSource._pinBuilder.fromColor(Color.YELLOW, 64); // If there were empty <Icon> tags in the KML, then billboard.image was set to false above\n    // However, in this case, the false value would have been converted to a property afterwards\n    // Thus, we check if billboard.image is defined with value of false\n  } else if (!billboard.image.getValue()) {\n    billboard.image = undefined;\n  }\n\n  var scale = 1.0;\n\n  if (defined(billboard.scale)) {\n    scale = billboard.scale.getValue();\n\n    if (scale !== 0) {\n      label.pixelOffset = new Cartesian2(scale * 16 + 1, 0);\n    } else {\n      //Minor tweaks to better match Google Earth.\n      label.pixelOffset = undefined;\n      label.horizontalOrigin = undefined;\n    }\n  }\n\n  if (defined(heightReference) && dataSource._clampToGround) {\n    billboard.heightReference = heightReference;\n    label.heightReference = heightReference;\n  }\n}\n\nfunction processPathGraphics(entity, styleEntity) {\n  var path = entity.path;\n\n  if (!defined(path)) {\n    path = new PathGraphics();\n    path.leadTime = 0;\n    entity.path = path;\n  }\n\n  var polyline = styleEntity.polyline;\n\n  if (defined(polyline)) {\n    path.material = polyline.material;\n    path.width = polyline.width;\n  }\n}\n\nfunction processPoint(dataSource, entityCollection, geometryNode, entity, styleEntity) {\n  var coordinatesString = queryStringValue(geometryNode, \"coordinates\", namespaces.kml);\n  var altitudeMode = queryStringValue(geometryNode, \"altitudeMode\", namespaces.kml);\n  var gxAltitudeMode = queryStringValue(geometryNode, \"altitudeMode\", namespaces.gx);\n  var extrude = queryBooleanValue(geometryNode, \"extrude\", namespaces.kml);\n  var ellipsoid = dataSource._ellipsoid;\n  var position = readCoordinate(coordinatesString, ellipsoid);\n  entity.position = position;\n  processPositionGraphics(dataSource, entity, styleEntity, heightReferenceFromAltitudeMode(altitudeMode, gxAltitudeMode));\n\n  if (extrude && isExtrudable(altitudeMode, gxAltitudeMode)) {\n    createDropLine(entityCollection, entity, styleEntity);\n  }\n\n  return true;\n}\n\nfunction processLineStringOrLinearRing(dataSource, entityCollection, geometryNode, entity, styleEntity) {\n  var coordinatesNode = queryFirstNode(geometryNode, \"coordinates\", namespaces.kml);\n  var altitudeMode = queryStringValue(geometryNode, \"altitudeMode\", namespaces.kml);\n  var gxAltitudeMode = queryStringValue(geometryNode, \"altitudeMode\", namespaces.gx);\n  var extrude = queryBooleanValue(geometryNode, \"extrude\", namespaces.kml);\n  var tessellate = queryBooleanValue(geometryNode, \"tessellate\", namespaces.kml);\n  var canExtrude = isExtrudable(altitudeMode, gxAltitudeMode);\n  var zIndex = queryNumericValue(geometryNode, \"drawOrder\", namespaces.gx);\n  var ellipsoid = dataSource._ellipsoid;\n  var coordinates = readCoordinates(coordinatesNode, ellipsoid);\n  var polyline = styleEntity.polyline;\n\n  if (canExtrude && extrude) {\n    var wall = new WallGraphics();\n    entity.wall = wall;\n    wall.positions = coordinates;\n    var polygon = styleEntity.polygon;\n\n    if (defined(polygon)) {\n      wall.fill = polygon.fill;\n      wall.material = polygon.material;\n    } //Always outline walls so they show up in 2D.\n\n\n    wall.outline = true;\n\n    if (defined(polyline)) {\n      wall.outlineColor = defined(polyline.material) ? polyline.material.color : Color.WHITE;\n      wall.outlineWidth = polyline.width;\n    } else if (defined(polygon)) {\n      wall.outlineColor = defined(polygon.material) ? polygon.material.color : Color.WHITE;\n    }\n  } else if (dataSource._clampToGround && !canExtrude && tessellate) {\n    var polylineGraphics = new PolylineGraphics();\n    polylineGraphics.clampToGround = true;\n    entity.polyline = polylineGraphics;\n    polylineGraphics.positions = coordinates;\n\n    if (defined(polyline)) {\n      polylineGraphics.material = defined(polyline.material) ? polyline.material.color.getValue(Iso8601.MINIMUM_VALUE) : Color.WHITE;\n      polylineGraphics.width = defaultValue(polyline.width, 1.0);\n    } else {\n      polylineGraphics.material = Color.WHITE;\n      polylineGraphics.width = 1.0;\n    }\n\n    polylineGraphics.zIndex = zIndex;\n  } else {\n    if (defined(zIndex)) {\n      oneTimeWarning(\"kml-gx:drawOrder\", \"KML - gx:drawOrder is not supported in LineStrings when clampToGround is false\");\n    }\n\n    if (dataSource._clampToGround && !tessellate) {\n      oneTimeWarning(\"kml-line-tesselate\", \"Ignoring clampToGround for KML lines without the tessellate flag.\");\n    }\n\n    polyline = defined(polyline) ? polyline.clone() : new PolylineGraphics();\n    entity.polyline = polyline;\n    polyline.positions = createPositionPropertyArrayFromAltitudeMode(coordinates, altitudeMode, gxAltitudeMode, ellipsoid);\n\n    if (!tessellate || canExtrude) {\n      polyline.arcType = ArcType.NONE;\n    }\n  }\n\n  return true;\n}\n\nfunction processPolygon(dataSource, entityCollection, geometryNode, entity, styleEntity) {\n  var outerBoundaryIsNode = queryFirstNode(geometryNode, \"outerBoundaryIs\", namespaces.kml);\n  var linearRingNode = queryFirstNode(outerBoundaryIsNode, \"LinearRing\", namespaces.kml);\n  var coordinatesNode = queryFirstNode(linearRingNode, \"coordinates\", namespaces.kml);\n  var ellipsoid = dataSource._ellipsoid;\n  var coordinates = readCoordinates(coordinatesNode, ellipsoid);\n  var extrude = queryBooleanValue(geometryNode, \"extrude\", namespaces.kml);\n  var altitudeMode = queryStringValue(geometryNode, \"altitudeMode\", namespaces.kml);\n  var gxAltitudeMode = queryStringValue(geometryNode, \"altitudeMode\", namespaces.gx);\n  var canExtrude = isExtrudable(altitudeMode, gxAltitudeMode);\n  var polygon = defined(styleEntity.polygon) ? styleEntity.polygon.clone() : createDefaultPolygon();\n  var polyline = styleEntity.polyline;\n\n  if (defined(polyline)) {\n    polygon.outlineColor = defined(polyline.material) ? polyline.material.color : Color.WHITE;\n    polygon.outlineWidth = polyline.width;\n  }\n\n  entity.polygon = polygon;\n\n  if (canExtrude) {\n    polygon.perPositionHeight = true;\n    polygon.extrudedHeight = extrude ? 0 : undefined;\n  } else if (!dataSource._clampToGround) {\n    polygon.height = 0;\n  }\n\n  if (defined(coordinates)) {\n    var hierarchy = new PolygonHierarchy(coordinates);\n    var innerBoundaryIsNodes = queryChildNodes(geometryNode, \"innerBoundaryIs\", namespaces.kml);\n\n    for (var j = 0; j < innerBoundaryIsNodes.length; j++) {\n      linearRingNode = queryChildNodes(innerBoundaryIsNodes[j], \"LinearRing\", namespaces.kml);\n\n      for (var k = 0; k < linearRingNode.length; k++) {\n        coordinatesNode = queryFirstNode(linearRingNode[k], \"coordinates\", namespaces.kml);\n        coordinates = readCoordinates(coordinatesNode, ellipsoid);\n\n        if (defined(coordinates)) {\n          hierarchy.holes.push(new PolygonHierarchy(coordinates));\n        }\n      }\n    }\n\n    polygon.hierarchy = hierarchy;\n  }\n\n  return true;\n}\n\nfunction processTrack(dataSource, entityCollection, geometryNode, entity, styleEntity) {\n  var altitudeMode = queryStringValue(geometryNode, \"altitudeMode\", namespaces.kml);\n  var gxAltitudeMode = queryStringValue(geometryNode, \"altitudeMode\", namespaces.gx);\n  var coordNodes = queryChildNodes(geometryNode, \"coord\", namespaces.gx);\n  var angleNodes = queryChildNodes(geometryNode, \"angles\", namespaces.gx);\n  var timeNodes = queryChildNodes(geometryNode, \"when\", namespaces.kml);\n  var extrude = queryBooleanValue(geometryNode, \"extrude\", namespaces.kml);\n  var canExtrude = isExtrudable(altitudeMode, gxAltitudeMode);\n  var ellipsoid = dataSource._ellipsoid;\n\n  if (angleNodes.length > 0) {\n    oneTimeWarning(\"kml-gx:angles\", \"KML - gx:angles are not supported in gx:Tracks\");\n  }\n\n  var length = Math.min(coordNodes.length, timeNodes.length);\n  var coordinates = [];\n  var times = [];\n\n  for (var i = 0; i < length; i++) {\n    var position = readCoordinate(coordNodes[i].textContent, ellipsoid);\n    coordinates.push(position);\n    times.push(JulianDate.fromIso8601(timeNodes[i].textContent));\n  }\n\n  var property = new SampledPositionProperty();\n  property.addSamples(times, coordinates);\n  entity.position = property;\n  processPositionGraphics(dataSource, entity, styleEntity, heightReferenceFromAltitudeMode(altitudeMode, gxAltitudeMode));\n  processPathGraphics(entity, styleEntity);\n  entity.availability = new TimeIntervalCollection();\n\n  if (timeNodes.length > 0) {\n    entity.availability.addInterval(new TimeInterval({\n      start: times[0],\n      stop: times[times.length - 1]\n    }));\n  }\n\n  if (canExtrude && extrude) {\n    createDropLine(entityCollection, entity, styleEntity);\n  }\n\n  return true;\n}\n\nfunction addToMultiTrack(times, positions, composite, availability, dropShowProperty, extrude, altitudeMode, gxAltitudeMode, includeEndPoints) {\n  var start = times[0];\n  var stop = times[times.length - 1];\n  var data = new SampledPositionProperty();\n  data.addSamples(times, positions);\n  composite.intervals.addInterval(new TimeInterval({\n    start: start,\n    stop: stop,\n    isStartIncluded: includeEndPoints,\n    isStopIncluded: includeEndPoints,\n    data: createPositionPropertyFromAltitudeMode(data, altitudeMode, gxAltitudeMode)\n  }));\n  availability.addInterval(new TimeInterval({\n    start: start,\n    stop: stop,\n    isStartIncluded: includeEndPoints,\n    isStopIncluded: includeEndPoints\n  }));\n  dropShowProperty.intervals.addInterval(new TimeInterval({\n    start: start,\n    stop: stop,\n    isStartIncluded: includeEndPoints,\n    isStopIncluded: includeEndPoints,\n    data: extrude\n  }));\n}\n\nfunction processMultiTrack(dataSource, entityCollection, geometryNode, entity, styleEntity) {\n  // Multitrack options do not work in GE as detailed in the spec,\n  // rather than altitudeMode being at the MultiTrack level,\n  // GE just defers all settings to the underlying track.\n  var interpolate = queryBooleanValue(geometryNode, \"interpolate\", namespaces.gx);\n  var trackNodes = queryChildNodes(geometryNode, \"Track\", namespaces.gx);\n  var times;\n  var lastStop;\n  var lastStopPosition;\n  var needDropLine = false;\n  var dropShowProperty = new TimeIntervalCollectionProperty();\n  var availability = new TimeIntervalCollection();\n  var composite = new CompositePositionProperty();\n  var ellipsoid = dataSource._ellipsoid;\n\n  for (var i = 0, len = trackNodes.length; i < len; i++) {\n    var trackNode = trackNodes[i];\n    var timeNodes = queryChildNodes(trackNode, \"when\", namespaces.kml);\n    var coordNodes = queryChildNodes(trackNode, \"coord\", namespaces.gx);\n    var altitudeMode = queryStringValue(trackNode, \"altitudeMode\", namespaces.kml);\n    var gxAltitudeMode = queryStringValue(trackNode, \"altitudeMode\", namespaces.gx);\n    var canExtrude = isExtrudable(altitudeMode, gxAltitudeMode);\n    var extrude = queryBooleanValue(trackNode, \"extrude\", namespaces.kml);\n    var length = Math.min(coordNodes.length, timeNodes.length);\n    var positions = [];\n    times = [];\n\n    for (var x = 0; x < length; x++) {\n      var position = readCoordinate(coordNodes[x].textContent, ellipsoid);\n      positions.push(position);\n      times.push(JulianDate.fromIso8601(timeNodes[x].textContent));\n    }\n\n    if (interpolate) {\n      //If we are interpolating, then we need to fill in the end of\n      //the last track and the beginning of this one with a sampled\n      //property.  From testing in Google Earth, this property\n      //is never extruded and always absolute.\n      if (defined(lastStop)) {\n        addToMultiTrack([lastStop, times[0]], [lastStopPosition, positions[0]], composite, availability, dropShowProperty, false, \"absolute\", undefined, false);\n      }\n\n      lastStop = times[length - 1];\n      lastStopPosition = positions[positions.length - 1];\n    }\n\n    addToMultiTrack(times, positions, composite, availability, dropShowProperty, canExtrude && extrude, altitudeMode, gxAltitudeMode, true);\n    needDropLine = needDropLine || canExtrude && extrude;\n  }\n\n  entity.availability = availability;\n  entity.position = composite;\n  processPositionGraphics(dataSource, entity, styleEntity);\n  processPathGraphics(entity, styleEntity);\n\n  if (needDropLine) {\n    createDropLine(entityCollection, entity, styleEntity);\n    entity.polyline.show = dropShowProperty;\n  }\n\n  return true;\n}\n\nvar geometryTypes = {\n  Point: processPoint,\n  LineString: processLineStringOrLinearRing,\n  LinearRing: processLineStringOrLinearRing,\n  Polygon: processPolygon,\n  Track: processTrack,\n  MultiTrack: processMultiTrack,\n  MultiGeometry: processMultiGeometry,\n  Model: processUnsupportedGeometry\n};\n\nfunction processMultiGeometry(dataSource, entityCollection, geometryNode, entity, styleEntity, context) {\n  var childNodes = geometryNode.childNodes;\n  var hasGeometry = false;\n\n  for (var i = 0, len = childNodes.length; i < len; i++) {\n    var childNode = childNodes.item(i);\n    var geometryProcessor = geometryTypes[childNode.localName];\n\n    if (defined(geometryProcessor)) {\n      var childEntity = createEntity(childNode, entityCollection, context);\n      childEntity.parent = entity;\n      childEntity.name = entity.name;\n      childEntity.availability = entity.availability;\n      childEntity.description = entity.description;\n      childEntity.kml = entity.kml;\n\n      if (geometryProcessor(dataSource, entityCollection, childNode, childEntity, styleEntity)) {\n        hasGeometry = true;\n      }\n    }\n  }\n\n  return hasGeometry;\n}\n\nfunction processUnsupportedGeometry(dataSource, entityCollection, geometryNode, entity, styleEntity) {\n  oneTimeWarning(\"kml-unsupportedGeometry\", \"KML - Unsupported geometry: \" + geometryNode.localName);\n  return false;\n}\n\nfunction processExtendedData(node, entity) {\n  var extendedDataNode = queryFirstNode(node, \"ExtendedData\", namespaces.kml);\n\n  if (!defined(extendedDataNode)) {\n    return undefined;\n  }\n\n  if (defined(queryFirstNode(extendedDataNode, \"SchemaData\", namespaces.kml))) {\n    oneTimeWarning(\"kml-schemaData\", \"KML - SchemaData is unsupported\");\n  }\n\n  if (defined(queryStringAttribute(extendedDataNode, \"xmlns:prefix\"))) {\n    oneTimeWarning(\"kml-extendedData\", \"KML - ExtendedData with xmlns:prefix is unsupported\");\n  }\n\n  var result = {};\n  var dataNodes = queryChildNodes(extendedDataNode, \"Data\", namespaces.kml);\n\n  if (defined(dataNodes)) {\n    var length = dataNodes.length;\n\n    for (var i = 0; i < length; i++) {\n      var dataNode = dataNodes[i];\n      var name = queryStringAttribute(dataNode, \"name\");\n\n      if (defined(name)) {\n        result[name] = {\n          displayName: queryStringValue(dataNode, \"displayName\", namespaces.kml),\n          value: queryStringValue(dataNode, \"value\", namespaces.kml)\n        };\n      }\n    }\n  }\n\n  entity.kml.extendedData = result;\n}\n\nvar scratchDiv;\n\nif (typeof document !== \"undefined\") {\n  scratchDiv = document.createElement(\"div\");\n}\n\nfunction processDescription(node, entity, styleEntity, uriResolver, sourceResource) {\n  var i;\n  var key;\n  var keys;\n  var kmlData = entity.kml;\n  var extendedData = kmlData.extendedData;\n  var description = queryStringValue(node, \"description\", namespaces.kml);\n  var balloonStyle = defaultValue(entity.balloonStyle, styleEntity.balloonStyle);\n  var background = Color.WHITE;\n  var foreground = Color.BLACK;\n  var text = description;\n\n  if (defined(balloonStyle)) {\n    background = defaultValue(balloonStyle.bgColor, Color.WHITE);\n    foreground = defaultValue(balloonStyle.textColor, Color.BLACK);\n    text = defaultValue(balloonStyle.text, description);\n  }\n\n  var value;\n\n  if (defined(text)) {\n    text = text.replace(\"$[name]\", defaultValue(entity.name, \"\"));\n    text = text.replace(\"$[description]\", defaultValue(description, \"\"));\n    text = text.replace(\"$[address]\", defaultValue(kmlData.address, \"\"));\n    text = text.replace(\"$[Snippet]\", defaultValue(kmlData.snippet, \"\"));\n    text = text.replace(\"$[id]\", entity.id); //While not explicitly defined by the OGC spec, in Google Earth\n    //The appearance of geDirections adds the directions to/from links\n    //We simply replace this string with nothing.\n\n    text = text.replace(\"$[geDirections]\", \"\");\n\n    if (defined(extendedData)) {\n      var matches = text.match(/\\$\\[.+?\\]/g);\n\n      if (matches !== null) {\n        for (i = 0; i < matches.length; i++) {\n          var token = matches[i];\n          var propertyName = token.substr(2, token.length - 3);\n          var isDisplayName = /\\/displayName$/.test(propertyName);\n          propertyName = propertyName.replace(/\\/displayName$/, \"\");\n          value = extendedData[propertyName];\n\n          if (defined(value)) {\n            value = isDisplayName ? value.displayName : value.value;\n          }\n\n          if (defined(value)) {\n            text = text.replace(token, defaultValue(value, \"\"));\n          }\n        }\n      }\n    }\n  } else if (defined(extendedData)) {\n    //If no description exists, build a table out of the extended data\n    keys = Object.keys(extendedData);\n\n    if (keys.length > 0) {\n      text = '<table class=\"cesium-infoBox-defaultTable cesium-infoBox-defaultTable-lighter\"><tbody>';\n\n      for (i = 0; i < keys.length; i++) {\n        key = keys[i];\n        value = extendedData[key];\n        text += \"<tr><th>\" + defaultValue(value.displayName, key) + \"</th><td>\" + defaultValue(value.value, \"\") + \"</td></tr>\";\n      }\n\n      text += \"</tbody></table>\";\n    }\n  }\n\n  if (!defined(text)) {\n    //No description\n    return;\n  } //Turns non-explicit links into clickable links.\n\n\n  text = autolinker.link(text); //Use a temporary div to manipulate the links\n  //so that they open in a new window.\n\n  scratchDiv.innerHTML = text;\n  var links = scratchDiv.querySelectorAll(\"a\");\n\n  for (i = 0; i < links.length; i++) {\n    links[i].setAttribute(\"target\", \"_blank\");\n  } //Rewrite any KMZ embedded urls\n\n\n  if (defined(uriResolver) && uriResolver.keys.length > 1) {\n    embedDataUris(scratchDiv, \"a\", \"href\", uriResolver);\n    embedDataUris(scratchDiv, \"img\", \"src\", uriResolver);\n  } //Make relative urls absolute using the sourceResource\n\n\n  applyBasePath(scratchDiv, \"a\", \"href\", sourceResource);\n  applyBasePath(scratchDiv, \"img\", \"src\", sourceResource);\n  var tmp = '<div class=\"cesium-infoBox-description-lighter\" style=\"';\n  tmp += \"overflow:auto;\";\n  tmp += \"word-wrap:break-word;\";\n  tmp += \"background-color:\" + background.toCssColorString() + \";\";\n  tmp += \"color:\" + foreground.toCssColorString() + \";\";\n  tmp += '\">';\n  tmp += scratchDiv.innerHTML + \"</div>\";\n  scratchDiv.innerHTML = \"\"; //Set the final HTML as the description.\n\n  entity.description = tmp;\n}\n\nfunction processFeature(dataSource, featureNode, processingData) {\n  var entityCollection = processingData.entityCollection;\n  var parent = processingData.parentEntity;\n  var sourceResource = processingData.sourceResource;\n  var uriResolver = processingData.uriResolver;\n  var entity = createEntity(featureNode, entityCollection, processingData.context);\n  var kmlData = entity.kml;\n  var styleEntity = computeFinalStyle(dataSource, featureNode, processingData.styleCollection, sourceResource, uriResolver);\n  var name = queryStringValue(featureNode, \"name\", namespaces.kml);\n  entity.name = name;\n  entity.parent = parent;\n  var availability = processTimeSpan(featureNode);\n\n  if (!defined(availability)) {\n    availability = processTimeStamp(featureNode);\n  }\n\n  entity.availability = availability;\n  mergeAvailabilityWithParent(entity); // Per KML spec \"A Feature is visible only if it and all its ancestors are visible.\"\n\n  function ancestryIsVisible(parentEntity) {\n    if (!parentEntity) {\n      return true;\n    }\n\n    return parentEntity.show && ancestryIsVisible(parentEntity.parent);\n  }\n\n  var visibility = queryBooleanValue(featureNode, \"visibility\", namespaces.kml);\n  entity.show = ancestryIsVisible(parent) && defaultValue(visibility, true); //var open = queryBooleanValue(featureNode, 'open', namespaces.kml);\n\n  var authorNode = queryFirstNode(featureNode, \"author\", namespaces.atom);\n  var author = kmlData.author;\n  author.name = queryStringValue(authorNode, \"name\", namespaces.atom);\n  author.uri = queryStringValue(authorNode, \"uri\", namespaces.atom);\n  author.email = queryStringValue(authorNode, \"email\", namespaces.atom);\n  var linkNode = queryFirstNode(featureNode, \"link\", namespaces.atom);\n  var link = kmlData.link;\n  link.href = queryStringAttribute(linkNode, \"href\");\n  link.hreflang = queryStringAttribute(linkNode, \"hreflang\");\n  link.rel = queryStringAttribute(linkNode, \"rel\");\n  link.type = queryStringAttribute(linkNode, \"type\");\n  link.title = queryStringAttribute(linkNode, \"title\");\n  link.length = queryStringAttribute(linkNode, \"length\");\n  kmlData.address = queryStringValue(featureNode, \"address\", namespaces.kml);\n  kmlData.phoneNumber = queryStringValue(featureNode, \"phoneNumber\", namespaces.kml);\n  kmlData.snippet = queryStringValue(featureNode, \"Snippet\", namespaces.kml);\n  processExtendedData(featureNode, entity);\n  processDescription(featureNode, entity, styleEntity, uriResolver, sourceResource);\n  var ellipsoid = dataSource._ellipsoid;\n  processLookAt(featureNode, entity, ellipsoid);\n  processCamera(featureNode, entity, ellipsoid);\n\n  if (defined(queryFirstNode(featureNode, \"Region\", namespaces.kml))) {\n    oneTimeWarning(\"kml-region\", \"KML - Placemark Regions are unsupported\");\n  }\n\n  return {\n    entity: entity,\n    styleEntity: styleEntity\n  };\n}\n\nfunction processDocument(dataSource, node, processingData, deferredLoading) {\n  deferredLoading.addNodes(node.childNodes, processingData);\n  deferredLoading.process();\n}\n\nfunction processFolder(dataSource, node, processingData, deferredLoading) {\n  var r = processFeature(dataSource, node, processingData);\n  var newProcessingData = clone(processingData);\n  newProcessingData.parentEntity = r.entity;\n  processDocument(dataSource, node, newProcessingData, deferredLoading);\n}\n\nfunction processPlacemark(dataSource, placemark, processingData, deferredLoading) {\n  var r = processFeature(dataSource, placemark, processingData);\n  var entity = r.entity;\n  var styleEntity = r.styleEntity;\n  var hasGeometry = false;\n  var childNodes = placemark.childNodes;\n\n  for (var i = 0, len = childNodes.length; i < len && !hasGeometry; i++) {\n    var childNode = childNodes.item(i);\n    var geometryProcessor = geometryTypes[childNode.localName];\n\n    if (defined(geometryProcessor)) {\n      // pass the placemark entity id as a context for case of defining multiple child entities together to handle case\n      // where some malformed kmls reuse the same id across placemarks, which works in GE, but is not technically to spec.\n      geometryProcessor(dataSource, processingData.entityCollection, childNode, entity, styleEntity, entity.id);\n      hasGeometry = true;\n    }\n  }\n\n  if (!hasGeometry) {\n    entity.merge(styleEntity);\n    processPositionGraphics(dataSource, entity, styleEntity);\n  }\n}\n\nvar playlistNodeProcessors = {\n  FlyTo: processTourFlyTo,\n  Wait: processTourWait,\n  SoundCue: processTourUnsupportedNode,\n  AnimatedUpdate: processTourUnsupportedNode,\n  TourControl: processTourUnsupportedNode\n};\n\nfunction processTour(dataSource, node, processingData, deferredLoading) {\n  var name = queryStringValue(node, \"name\", namespaces.kml);\n  var id = queryStringAttribute(node, \"id\");\n  var tour = new KmlTour(name, id);\n  var playlistNode = queryFirstNode(node, \"Playlist\", namespaces.gx);\n\n  if (playlistNode) {\n    var ellipsoid = dataSource._ellipsoid;\n    var childNodes = playlistNode.childNodes;\n\n    for (var i = 0; i < childNodes.length; i++) {\n      var entryNode = childNodes[i];\n\n      if (entryNode.localName) {\n        var playlistNodeProcessor = playlistNodeProcessors[entryNode.localName];\n\n        if (playlistNodeProcessor) {\n          playlistNodeProcessor(tour, entryNode, ellipsoid);\n        } else {\n          console.log(\"Unknown KML Tour playlist entry type \" + entryNode.localName);\n        }\n      }\n    }\n  }\n\n  if (!defined(dataSource.kmlTours)) {\n    dataSource.kmlTours = [];\n  }\n\n  dataSource.kmlTours.push(tour);\n}\n\nfunction processTourUnsupportedNode(tour, entryNode) {\n  oneTimeWarning(\"KML Tour unsupported node \" + entryNode.localName);\n}\n\nfunction processTourWait(tour, entryNode) {\n  var duration = queryNumericValue(entryNode, \"duration\", namespaces.gx);\n  tour.addPlaylistEntry(new KmlTourWait(duration));\n}\n\nfunction processTourFlyTo(tour, entryNode, ellipsoid) {\n  var duration = queryNumericValue(entryNode, \"duration\", namespaces.gx);\n  var flyToMode = queryStringValue(entryNode, \"flyToMode\", namespaces.gx);\n  var t = {\n    kml: {}\n  };\n  processLookAt(entryNode, t, ellipsoid);\n  processCamera(entryNode, t, ellipsoid);\n  var view = t.kml.lookAt || t.kml.camera;\n  var flyto = new KmlTourFlyTo(duration, flyToMode, view);\n  tour.addPlaylistEntry(flyto);\n}\n\nfunction processCamera(featureNode, entity, ellipsoid) {\n  var camera = queryFirstNode(featureNode, \"Camera\", namespaces.kml);\n\n  if (defined(camera)) {\n    var lon = defaultValue(queryNumericValue(camera, \"longitude\", namespaces.kml), 0.0);\n    var lat = defaultValue(queryNumericValue(camera, \"latitude\", namespaces.kml), 0.0);\n    var altitude = defaultValue(queryNumericValue(camera, \"altitude\", namespaces.kml), 0.0);\n    var heading = defaultValue(queryNumericValue(camera, \"heading\", namespaces.kml), 0.0);\n    var tilt = defaultValue(queryNumericValue(camera, \"tilt\", namespaces.kml), 0.0);\n    var roll = defaultValue(queryNumericValue(camera, \"roll\", namespaces.kml), 0.0);\n    var position = Cartesian3.fromDegrees(lon, lat, altitude, ellipsoid);\n    var hpr = HeadingPitchRoll.fromDegrees(heading, tilt - 90.0, roll);\n    entity.kml.camera = new KmlCamera(position, hpr);\n  }\n}\n\nfunction processLookAt(featureNode, entity, ellipsoid) {\n  var lookAt = queryFirstNode(featureNode, \"LookAt\", namespaces.kml);\n\n  if (defined(lookAt)) {\n    var lon = defaultValue(queryNumericValue(lookAt, \"longitude\", namespaces.kml), 0.0);\n    var lat = defaultValue(queryNumericValue(lookAt, \"latitude\", namespaces.kml), 0.0);\n    var altitude = defaultValue(queryNumericValue(lookAt, \"altitude\", namespaces.kml), 0.0);\n    var heading = queryNumericValue(lookAt, \"heading\", namespaces.kml);\n    var tilt = queryNumericValue(lookAt, \"tilt\", namespaces.kml);\n    var range = defaultValue(queryNumericValue(lookAt, \"range\", namespaces.kml), 0.0);\n    tilt = CesiumMath.toRadians(defaultValue(tilt, 0.0));\n    heading = CesiumMath.toRadians(defaultValue(heading, 0.0));\n    var hpr = new HeadingPitchRange(heading, tilt - CesiumMath.PI_OVER_TWO, range);\n    var viewPoint = Cartesian3.fromDegrees(lon, lat, altitude, ellipsoid);\n    entity.kml.lookAt = new KmlLookAt(viewPoint, hpr);\n  }\n}\n\nfunction processGroundOverlay(dataSource, groundOverlay, processingData, deferredLoading) {\n  var r = processFeature(dataSource, groundOverlay, processingData);\n  var entity = r.entity;\n  var geometry;\n  var isLatLonQuad = false;\n  var ellipsoid = dataSource._ellipsoid;\n  var positions = readCoordinates(queryFirstNode(groundOverlay, \"LatLonQuad\", namespaces.gx), ellipsoid);\n  var zIndex = queryNumericValue(groundOverlay, \"drawOrder\", namespaces.kml);\n\n  if (defined(positions)) {\n    geometry = createDefaultPolygon();\n    geometry.hierarchy = new PolygonHierarchy(positions);\n    geometry.zIndex = zIndex;\n    entity.polygon = geometry;\n    isLatLonQuad = true;\n  } else {\n    geometry = new RectangleGraphics();\n    geometry.zIndex = zIndex;\n    entity.rectangle = geometry;\n    var latLonBox = queryFirstNode(groundOverlay, \"LatLonBox\", namespaces.kml);\n\n    if (defined(latLonBox)) {\n      var west = queryNumericValue(latLonBox, \"west\", namespaces.kml);\n      var south = queryNumericValue(latLonBox, \"south\", namespaces.kml);\n      var east = queryNumericValue(latLonBox, \"east\", namespaces.kml);\n      var north = queryNumericValue(latLonBox, \"north\", namespaces.kml);\n\n      if (defined(west)) {\n        west = CesiumMath.negativePiToPi(CesiumMath.toRadians(west));\n      }\n\n      if (defined(south)) {\n        south = CesiumMath.clampToLatitudeRange(CesiumMath.toRadians(south));\n      }\n\n      if (defined(east)) {\n        east = CesiumMath.negativePiToPi(CesiumMath.toRadians(east));\n      }\n\n      if (defined(north)) {\n        north = CesiumMath.clampToLatitudeRange(CesiumMath.toRadians(north));\n      }\n\n      geometry.coordinates = new Rectangle(west, south, east, north);\n      var rotation = queryNumericValue(latLonBox, \"rotation\", namespaces.kml);\n\n      if (defined(rotation)) {\n        var rotationRadians = CesiumMath.toRadians(rotation);\n        geometry.rotation = rotationRadians;\n        geometry.stRotation = rotationRadians;\n      }\n    }\n  }\n\n  var iconNode = queryFirstNode(groundOverlay, \"Icon\", namespaces.kml);\n  var href = getIconHref(iconNode, dataSource, processingData.sourceResource, processingData.uriResolver, true);\n\n  if (defined(href)) {\n    if (isLatLonQuad) {\n      oneTimeWarning(\"kml-gx:LatLonQuad\", \"KML - gx:LatLonQuad Icon does not support texture projection.\");\n    }\n\n    var x = queryNumericValue(iconNode, \"x\", namespaces.gx);\n    var y = queryNumericValue(iconNode, \"y\", namespaces.gx);\n    var w = queryNumericValue(iconNode, \"w\", namespaces.gx);\n    var h = queryNumericValue(iconNode, \"h\", namespaces.gx);\n\n    if (defined(x) || defined(y) || defined(w) || defined(h)) {\n      oneTimeWarning(\"kml-groundOverlay-xywh\", \"KML - gx:x, gx:y, gx:w, gx:h aren't supported for GroundOverlays\");\n    }\n\n    geometry.material = href;\n    geometry.material.color = queryColorValue(groundOverlay, \"color\", namespaces.kml);\n    geometry.material.transparent = true;\n  } else {\n    geometry.material = queryColorValue(groundOverlay, \"color\", namespaces.kml);\n  }\n\n  var altitudeMode = queryStringValue(groundOverlay, \"altitudeMode\", namespaces.kml);\n\n  if (defined(altitudeMode)) {\n    if (altitudeMode === \"absolute\") {\n      //Use height above ellipsoid until we support MSL.\n      geometry.height = queryNumericValue(groundOverlay, \"altitude\", namespaces.kml);\n      geometry.zIndex = undefined;\n    } else if (altitudeMode !== \"clampToGround\") {\n      oneTimeWarning(\"kml-altitudeMode-unknown\", \"KML - Unknown altitudeMode: \" + altitudeMode);\n    } // else just use the default of 0 until we support 'clampToGround'\n\n  } else {\n    altitudeMode = queryStringValue(groundOverlay, \"altitudeMode\", namespaces.gx);\n\n    if (altitudeMode === \"relativeToSeaFloor\") {\n      oneTimeWarning(\"kml-altitudeMode-relativeToSeaFloor\", \"KML - altitudeMode relativeToSeaFloor is currently not supported, treating as absolute.\");\n      geometry.height = queryNumericValue(groundOverlay, \"altitude\", namespaces.kml);\n      geometry.zIndex = undefined;\n    } else if (altitudeMode === \"clampToSeaFloor\") {\n      oneTimeWarning(\"kml-altitudeMode-clampToSeaFloor\", \"KML - altitudeMode clampToSeaFloor is currently not supported, treating as clampToGround.\");\n    } else if (defined(altitudeMode)) {\n      oneTimeWarning(\"kml-altitudeMode-unknown\", \"KML - Unknown altitudeMode: \" + altitudeMode);\n    }\n  }\n}\n\nfunction processUnsupportedFeature(dataSource, node, processingData, deferredLoading) {\n  dataSource._unsupportedNode.raiseEvent(dataSource, processingData.parentEntity, node, processingData.entityCollection, processingData.styleCollection, processingData.sourceResource, processingData.uriResolver);\n\n  oneTimeWarning(\"kml-unsupportedFeature-\" + node.nodeName, \"KML - Unsupported feature: \" + node.nodeName);\n}\n\nvar RefreshMode = {\n  INTERVAL: 0,\n  EXPIRE: 1,\n  STOP: 2\n};\n\nfunction cleanupString(s) {\n  if (!defined(s) || s.length === 0) {\n    return \"\";\n  }\n\n  var sFirst = s[0];\n\n  if (sFirst === \"&\" || sFirst === \"?\") {\n    s = s.substring(1);\n  }\n\n  return s;\n}\n\nvar zeroRectangle = new Rectangle();\nvar scratchCartographic = new Cartographic();\nvar scratchCartesian2 = new Cartesian2();\nvar scratchCartesian3 = new Cartesian3();\n\nfunction processNetworkLinkQueryString(resource, camera, canvas, viewBoundScale, bbox, ellipsoid) {\n  function fixLatitude(value) {\n    if (value < -CesiumMath.PI_OVER_TWO) {\n      return -CesiumMath.PI_OVER_TWO;\n    } else if (value > CesiumMath.PI_OVER_TWO) {\n      return CesiumMath.PI_OVER_TWO;\n    }\n\n    return value;\n  }\n\n  function fixLongitude(value) {\n    if (value > CesiumMath.PI) {\n      return value - CesiumMath.TWO_PI;\n    } else if (value < -CesiumMath.PI) {\n      return value + CesiumMath.TWO_PI;\n    }\n\n    return value;\n  }\n\n  var queryString = objectToQuery(resource.queryParameters); // objectToQuery escapes [ and ], so fix that\n\n  queryString = queryString.replace(/%5B/g, \"[\").replace(/%5D/g, \"]\");\n\n  if (defined(camera) && camera._mode !== SceneMode.MORPHING) {\n    var centerCartesian;\n    var centerCartographic;\n    bbox = defaultValue(bbox, zeroRectangle);\n\n    if (defined(canvas)) {\n      scratchCartesian2.x = canvas.clientWidth * 0.5;\n      scratchCartesian2.y = canvas.clientHeight * 0.5;\n      centerCartesian = camera.pickEllipsoid(scratchCartesian2, ellipsoid, scratchCartesian3);\n    }\n\n    if (defined(centerCartesian)) {\n      centerCartographic = ellipsoid.cartesianToCartographic(centerCartesian, scratchCartographic);\n    } else {\n      centerCartographic = Rectangle.center(bbox, scratchCartographic);\n      centerCartesian = ellipsoid.cartographicToCartesian(centerCartographic);\n    }\n\n    if (defined(viewBoundScale) && !CesiumMath.equalsEpsilon(viewBoundScale, 1.0, CesiumMath.EPSILON9)) {\n      var newHalfWidth = bbox.width * viewBoundScale * 0.5;\n      var newHalfHeight = bbox.height * viewBoundScale * 0.5;\n      bbox = new Rectangle(fixLongitude(centerCartographic.longitude - newHalfWidth), fixLatitude(centerCartographic.latitude - newHalfHeight), fixLongitude(centerCartographic.longitude + newHalfWidth), fixLatitude(centerCartographic.latitude + newHalfHeight));\n    }\n\n    queryString = queryString.replace(\"[bboxWest]\", CesiumMath.toDegrees(bbox.west).toString());\n    queryString = queryString.replace(\"[bboxSouth]\", CesiumMath.toDegrees(bbox.south).toString());\n    queryString = queryString.replace(\"[bboxEast]\", CesiumMath.toDegrees(bbox.east).toString());\n    queryString = queryString.replace(\"[bboxNorth]\", CesiumMath.toDegrees(bbox.north).toString());\n    var lon = CesiumMath.toDegrees(centerCartographic.longitude).toString();\n    var lat = CesiumMath.toDegrees(centerCartographic.latitude).toString();\n    queryString = queryString.replace(\"[lookatLon]\", lon);\n    queryString = queryString.replace(\"[lookatLat]\", lat);\n    queryString = queryString.replace(\"[lookatTilt]\", CesiumMath.toDegrees(camera.pitch).toString());\n    queryString = queryString.replace(\"[lookatHeading]\", CesiumMath.toDegrees(camera.heading).toString());\n    queryString = queryString.replace(\"[lookatRange]\", Cartesian3.distance(camera.positionWC, centerCartesian));\n    queryString = queryString.replace(\"[lookatTerrainLon]\", lon);\n    queryString = queryString.replace(\"[lookatTerrainLat]\", lat);\n    queryString = queryString.replace(\"[lookatTerrainAlt]\", centerCartographic.height.toString());\n    ellipsoid.cartesianToCartographic(camera.positionWC, scratchCartographic);\n    queryString = queryString.replace(\"[cameraLon]\", CesiumMath.toDegrees(scratchCartographic.longitude).toString());\n    queryString = queryString.replace(\"[cameraLat]\", CesiumMath.toDegrees(scratchCartographic.latitude).toString());\n    queryString = queryString.replace(\"[cameraAlt]\", CesiumMath.toDegrees(scratchCartographic.height).toString());\n    var frustum = camera.frustum;\n    var aspectRatio = frustum.aspectRatio;\n    var horizFov = \"\";\n    var vertFov = \"\";\n\n    if (defined(aspectRatio)) {\n      var fov = CesiumMath.toDegrees(frustum.fov);\n\n      if (aspectRatio > 1.0) {\n        horizFov = fov;\n        vertFov = fov / aspectRatio;\n      } else {\n        vertFov = fov;\n        horizFov = fov * aspectRatio;\n      }\n    }\n\n    queryString = queryString.replace(\"[horizFov]\", horizFov.toString());\n    queryString = queryString.replace(\"[vertFov]\", vertFov.toString());\n  } else {\n    queryString = queryString.replace(\"[bboxWest]\", \"-180\");\n    queryString = queryString.replace(\"[bboxSouth]\", \"-90\");\n    queryString = queryString.replace(\"[bboxEast]\", \"180\");\n    queryString = queryString.replace(\"[bboxNorth]\", \"90\");\n    queryString = queryString.replace(\"[lookatLon]\", \"\");\n    queryString = queryString.replace(\"[lookatLat]\", \"\");\n    queryString = queryString.replace(\"[lookatRange]\", \"\");\n    queryString = queryString.replace(\"[lookatTilt]\", \"\");\n    queryString = queryString.replace(\"[lookatHeading]\", \"\");\n    queryString = queryString.replace(\"[lookatTerrainLon]\", \"\");\n    queryString = queryString.replace(\"[lookatTerrainLat]\", \"\");\n    queryString = queryString.replace(\"[lookatTerrainAlt]\", \"\");\n    queryString = queryString.replace(\"[cameraLon]\", \"\");\n    queryString = queryString.replace(\"[cameraLat]\", \"\");\n    queryString = queryString.replace(\"[cameraAlt]\", \"\");\n    queryString = queryString.replace(\"[horizFov]\", \"\");\n    queryString = queryString.replace(\"[vertFov]\", \"\");\n  }\n\n  if (defined(canvas)) {\n    queryString = queryString.replace(\"[horizPixels]\", canvas.clientWidth);\n    queryString = queryString.replace(\"[vertPixels]\", canvas.clientHeight);\n  } else {\n    queryString = queryString.replace(\"[horizPixels]\", \"\");\n    queryString = queryString.replace(\"[vertPixels]\", \"\");\n  }\n\n  queryString = queryString.replace(\"[terrainEnabled]\", \"1\");\n  queryString = queryString.replace(\"[clientVersion]\", \"1\");\n  queryString = queryString.replace(\"[kmlVersion]\", \"2.2\");\n  queryString = queryString.replace(\"[clientName]\", \"Cesium\");\n  queryString = queryString.replace(\"[language]\", \"English\");\n  resource.setQueryParameters(queryToObject(queryString));\n}\n\nfunction processNetworkLink(dataSource, node, processingData, deferredLoading) {\n  var r = processFeature(dataSource, node, processingData);\n  var networkEntity = r.entity;\n  var sourceResource = processingData.sourceResource;\n  var uriResolver = processingData.uriResolver;\n  var link = queryFirstNode(node, \"Link\", namespaces.kml);\n\n  if (!defined(link)) {\n    link = queryFirstNode(node, \"Url\", namespaces.kml);\n  }\n\n  if (defined(link)) {\n    var href = queryStringValue(link, \"href\", namespaces.kml);\n    var viewRefreshMode;\n    var viewBoundScale;\n\n    if (defined(href)) {\n      var newSourceUri = href;\n      href = resolveHref(href, sourceResource, processingData.uriResolver); // We need to pass in the original path if resolveHref returns a data uri because the network link\n      //  references a document in a KMZ archive\n\n      if (/^data:/.test(href.getUrlComponent())) {\n        // So if sourceUri isn't the kmz file, then its another kml in the archive, so resolve it\n        if (!/\\.kmz/i.test(sourceResource.getUrlComponent())) {\n          newSourceUri = sourceResource.getDerivedResource({\n            url: newSourceUri\n          });\n        }\n      } else {\n        newSourceUri = href.clone(); // Not a data uri so use the fully qualified uri\n\n        viewRefreshMode = queryStringValue(link, \"viewRefreshMode\", namespaces.kml);\n        viewBoundScale = defaultValue(queryStringValue(link, \"viewBoundScale\", namespaces.kml), 1.0);\n        var defaultViewFormat = viewRefreshMode === \"onStop\" ? \"BBOX=[bboxWest],[bboxSouth],[bboxEast],[bboxNorth]\" : \"\";\n        var viewFormat = defaultValue(queryStringValue(link, \"viewFormat\", namespaces.kml), defaultViewFormat);\n        var httpQuery = queryStringValue(link, \"httpQuery\", namespaces.kml);\n\n        if (defined(viewFormat)) {\n          href.setQueryParameters(queryToObject(cleanupString(viewFormat)));\n        }\n\n        if (defined(httpQuery)) {\n          href.setQueryParameters(queryToObject(cleanupString(httpQuery)));\n        }\n\n        var ellipsoid = dataSource._ellipsoid;\n        processNetworkLinkQueryString(href, dataSource._camera, dataSource._canvas, viewBoundScale, dataSource._lastCameraView.bbox, ellipsoid);\n      }\n\n      var options = {\n        sourceUri: newSourceUri,\n        uriResolver: uriResolver,\n        context: networkEntity.id\n      };\n      var networkLinkCollection = new EntityCollection();\n      var promise = load(dataSource, networkLinkCollection, href, options).then(function (rootElement) {\n        var entities = dataSource._entityCollection;\n        var newEntities = networkLinkCollection.values;\n        entities.suspendEvents();\n\n        for (var i = 0; i < newEntities.length; i++) {\n          var newEntity = newEntities[i];\n\n          if (!defined(newEntity.parent)) {\n            newEntity.parent = networkEntity;\n            mergeAvailabilityWithParent(newEntity);\n          }\n\n          entities.add(newEntity);\n        }\n\n        entities.resumeEvents(); // Add network links to a list if we need they will need to be updated\n\n        var refreshMode = queryStringValue(link, \"refreshMode\", namespaces.kml);\n        var refreshInterval = defaultValue(queryNumericValue(link, \"refreshInterval\", namespaces.kml), 0);\n\n        if (refreshMode === \"onInterval\" && refreshInterval > 0 || refreshMode === \"onExpire\" || viewRefreshMode === \"onStop\") {\n          var networkLinkControl = queryFirstNode(rootElement, \"NetworkLinkControl\", namespaces.kml);\n          var hasNetworkLinkControl = defined(networkLinkControl);\n          var now = JulianDate.now();\n          var networkLinkInfo = {\n            id: createGuid(),\n            href: href,\n            cookie: {},\n            lastUpdated: now,\n            updating: false,\n            entity: networkEntity,\n            viewBoundScale: viewBoundScale,\n            needsUpdate: false,\n            cameraUpdateTime: now\n          };\n          var minRefreshPeriod = 0;\n\n          if (hasNetworkLinkControl) {\n            networkLinkInfo.cookie = queryToObject(defaultValue(queryStringValue(networkLinkControl, \"cookie\", namespaces.kml), \"\"));\n            minRefreshPeriod = defaultValue(queryNumericValue(networkLinkControl, \"minRefreshPeriod\", namespaces.kml), 0);\n          }\n\n          if (refreshMode === \"onInterval\") {\n            if (hasNetworkLinkControl) {\n              refreshInterval = Math.max(minRefreshPeriod, refreshInterval);\n            }\n\n            networkLinkInfo.refreshMode = RefreshMode.INTERVAL;\n            networkLinkInfo.time = refreshInterval;\n          } else if (refreshMode === \"onExpire\") {\n            var expires;\n\n            if (hasNetworkLinkControl) {\n              expires = queryStringValue(networkLinkControl, \"expires\", namespaces.kml);\n            }\n\n            if (defined(expires)) {\n              try {\n                var date = JulianDate.fromIso8601(expires);\n                var diff = JulianDate.secondsDifference(date, now);\n\n                if (diff > 0 && diff < minRefreshPeriod) {\n                  JulianDate.addSeconds(now, minRefreshPeriod, date);\n                }\n\n                networkLinkInfo.refreshMode = RefreshMode.EXPIRE;\n                networkLinkInfo.time = date;\n              } catch (e) {\n                oneTimeWarning(\"kml-refreshMode-onInterval-onExpire\", \"KML - NetworkLinkControl expires is not a valid date\");\n              }\n            } else {\n              oneTimeWarning(\"kml-refreshMode-onExpire\", \"KML - refreshMode of onExpire requires the NetworkLinkControl to have an expires element\");\n            }\n          } else if (dataSource._camera) {\n            // Only allow onStop refreshes if we have a camera\n            networkLinkInfo.refreshMode = RefreshMode.STOP;\n            networkLinkInfo.time = defaultValue(queryNumericValue(link, \"viewRefreshTime\", namespaces.kml), 0);\n          } else {\n            oneTimeWarning(\"kml-refrehMode-onStop-noCamera\", \"A NetworkLink with viewRefreshMode=onStop requires a camera be passed in when creating the KmlDataSource\");\n          }\n\n          if (defined(networkLinkInfo.refreshMode)) {\n            dataSource._networkLinks.set(networkLinkInfo.id, networkLinkInfo);\n          }\n        } else if (viewRefreshMode === \"onRegion\") {\n          oneTimeWarning(\"kml-refrehMode-onRegion\", \"KML - Unsupported viewRefreshMode: onRegion\");\n        }\n      }).otherwise(function (error) {\n        oneTimeWarning(\"An error occured during loading \" + href.url);\n\n        dataSource._error.raiseEvent(dataSource, error);\n      });\n      deferredLoading.addPromise(promise);\n    }\n  }\n}\n\nfunction processFeatureNode(dataSource, node, processingData, deferredLoading) {\n  var featureProcessor = featureTypes[node.localName];\n\n  if (defined(featureProcessor)) {\n    return featureProcessor(dataSource, node, processingData, deferredLoading);\n  }\n\n  return processUnsupportedFeature(dataSource, node, processingData, deferredLoading);\n}\n\nfunction loadKml(dataSource, entityCollection, kml, sourceResource, uriResolver, context) {\n  entityCollection.removeAll();\n  var documentElement = kml.documentElement;\n  var document = documentElement.localName === \"Document\" ? documentElement : queryFirstNode(documentElement, \"Document\", namespaces.kml);\n  var name = queryStringValue(document, \"name\", namespaces.kml);\n\n  if (!defined(name)) {\n    name = getFilenameFromUri(sourceResource.getUrlComponent());\n  } // Only set the name from the root document\n\n\n  if (!defined(dataSource._name)) {\n    dataSource._name = name;\n  }\n\n  var deferredLoading = new KmlDataSource._DeferredLoading(dataSource);\n  var styleCollection = new EntityCollection(dataSource);\n  return when.all(processStyles(dataSource, kml, styleCollection, sourceResource, false, uriResolver)).then(function () {\n    var element = kml.documentElement;\n\n    if (element.localName === \"kml\") {\n      var childNodes = element.childNodes;\n\n      for (var i = 0; i < childNodes.length; i++) {\n        var tmp = childNodes[i];\n\n        if (defined(featureTypes[tmp.localName])) {\n          element = tmp;\n          break;\n        }\n      }\n    }\n\n    var processingData = {\n      parentEntity: undefined,\n      entityCollection: entityCollection,\n      styleCollection: styleCollection,\n      sourceResource: sourceResource,\n      uriResolver: uriResolver,\n      context: context\n    };\n    entityCollection.suspendEvents();\n    processFeatureNode(dataSource, element, processingData, deferredLoading);\n    entityCollection.resumeEvents();\n    return deferredLoading.wait().then(function () {\n      return kml.documentElement;\n    });\n  });\n}\n\nfunction loadKmz(dataSource, entityCollection, blob, sourceResource) {\n  var deferred = when.defer();\n  zip.createReader(new zip.BlobReader(blob), function (reader) {\n    reader.getEntries(function (entries) {\n      var promises = [];\n      var uriResolver = {};\n      var docEntry;\n      var docDefer;\n\n      for (var i = 0; i < entries.length; i++) {\n        var entry = entries[i];\n\n        if (!entry.directory) {\n          var innerDefer = when.defer();\n          promises.push(innerDefer.promise);\n\n          if (/\\.kml$/i.test(entry.filename)) {\n            // We use the first KML document we come across\n            //  https://developers.google.com/kml/documentation/kmzarchives\n            // Unless we come across a .kml file at the root of the archive because GE does this\n            if (!defined(docEntry) || !/\\//i.test(entry.filename)) {\n              if (defined(docEntry)) {\n                // We found one at the root so load the initial kml as a data uri\n                loadDataUriFromZip(docEntry, uriResolver, docDefer);\n              }\n\n              docEntry = entry;\n              docDefer = innerDefer;\n            } else {\n              // Wasn't the first kml and wasn't at the root\n              loadDataUriFromZip(entry, uriResolver, innerDefer);\n            }\n          } else {\n            loadDataUriFromZip(entry, uriResolver, innerDefer);\n          }\n        }\n      } // Now load the root KML document\n\n\n      if (defined(docEntry)) {\n        loadXmlFromZip(docEntry, uriResolver, docDefer);\n      }\n\n      when.all(promises).then(function () {\n        reader.close();\n\n        if (!defined(uriResolver.kml)) {\n          deferred.reject(new RuntimeError(\"KMZ file does not contain a KML document.\"));\n          return;\n        }\n\n        uriResolver.keys = Object.keys(uriResolver);\n        return loadKml(dataSource, entityCollection, uriResolver.kml, sourceResource, uriResolver);\n      }).then(deferred.resolve).otherwise(deferred.reject);\n    });\n  }, function (e) {\n    deferred.reject(e);\n  });\n  return deferred.promise;\n}\n\nfunction load(dataSource, entityCollection, data, options) {\n  options = defaultValue(options, defaultValue.EMPTY_OBJECT);\n  var sourceUri = options.sourceUri;\n  var uriResolver = options.uriResolver;\n  var context = options.context;\n  var promise = data;\n\n  if (typeof data === \"string\" || data instanceof Resource) {\n    data = Resource.createIfNeeded(data);\n    promise = data.fetchBlob();\n    sourceUri = defaultValue(sourceUri, data.clone()); // Add resource credits to our list of credits to display\n\n    var resourceCredits = dataSource._resourceCredits;\n    var credits = data.credits;\n\n    if (defined(credits)) {\n      var length = credits.length;\n\n      for (var i = 0; i < length; i++) {\n        resourceCredits.push(credits[i]);\n      }\n    }\n  } else {\n    sourceUri = defaultValue(sourceUri, Resource.DEFAULT.clone());\n  }\n\n  sourceUri = Resource.createIfNeeded(sourceUri);\n  return when(promise).then(function (dataToLoad) {\n    if (dataToLoad instanceof Blob) {\n      return isZipFile(dataToLoad).then(function (isZip) {\n        if (isZip) {\n          return loadKmz(dataSource, entityCollection, dataToLoad, sourceUri);\n        }\n\n        return readBlobAsText(dataToLoad).then(function (text) {\n          //There's no official way to validate if a parse was successful.\n          //The following check detects the error on various browsers.\n          //Insert missing namespaces\n          text = insertNamespaces(text); //Remove Duplicate Namespaces\n\n          text = removeDuplicateNamespaces(text); //IE raises an exception\n\n          var kml;\n          var error;\n\n          try {\n            kml = parser.parseFromString(text, \"application/xml\");\n          } catch (e) {\n            error = e.toString();\n          } //The parse succeeds on Chrome and Firefox, but the error\n          //handling is different in each.\n\n\n          if (defined(error) || kml.body || kml.documentElement.tagName === \"parsererror\") {\n            //Firefox has error information as the firstChild nodeValue.\n            var msg = defined(error) ? error : kml.documentElement.firstChild.nodeValue; //Chrome has it in the body text.\n\n            if (!msg) {\n              msg = kml.body.innerText;\n            } //Return the error\n\n\n            throw new RuntimeError(msg);\n          }\n\n          return loadKml(dataSource, entityCollection, kml, sourceUri, uriResolver, context);\n        });\n      });\n    }\n\n    return loadKml(dataSource, entityCollection, dataToLoad, sourceUri, uriResolver, context);\n  }).otherwise(function (error) {\n    dataSource._error.raiseEvent(dataSource, error);\n\n    console.log(error);\n    return when.reject(error);\n  });\n}\n/**\n * A {@link DataSource} which processes Keyhole Markup Language 2.2 (KML).\n * <p>\n * KML support in Cesium is incomplete, but a large amount of the standard,\n * as well as Google's <code>gx</code> extension namespace, is supported. See Github issue\n * {@link https://github.com/CesiumGS/cesium/issues/873|#873} for a\n * detailed list of what is and isn't support. Cesium will also write information to the\n * console when it encounters most unsupported features.\n * </p>\n * <p>\n * Non visual feature data, such as <code>atom:author</code> and <code>ExtendedData</code>\n * is exposed via an instance of {@link KmlFeatureData}, which is added to each {@link Entity}\n * under the <code>kml</code> property.\n * </p>\n *\n * @alias KmlDataSource\n * @constructor\n *\n * @param {Object} options An object with the following properties:\n * @param {Camera} options.camera The camera that is used for viewRefreshModes and sending camera properties to network links.\n * @param {Canvas} options.canvas The canvas that is used for sending viewer properties to network links.\n * @param {Ellipsoid} [options.ellipsoid=Ellipsoid.WGS84] The global ellipsoid used for geographical calculations.\n * @param {Credit|String} [options.credit] A credit for the data source, which is displayed on the canvas.\n *\n * @see {@link http://www.opengeospatial.org/standards/kml/|Open Geospatial Consortium KML Standard}\n * @see {@link https://developers.google.com/kml/|Google KML Documentation}\n *\n * @demo {@link https://sandcastle.cesium.com/index.html?src=KML.html|Cesium Sandcastle KML Demo}\n *\n * @example\n * var viewer = new Cesium.Viewer('cesiumContainer');\n * viewer.dataSources.add(Cesium.KmlDataSource.load('../../SampleData/facilities.kmz',\n *      {\n *           camera: viewer.scene.camera,\n *           canvas: viewer.scene.canvas\n *      })\n * );\n */\n\n\nfunction KmlDataSource(options) {\n  options = defaultValue(options, defaultValue.EMPTY_OBJECT);\n  var camera = options.camera;\n  var canvas = options.canvas; //>>includeStart('debug', pragmas.debug);\n\n  if (!defined(camera)) {\n    throw new DeveloperError(\"options.camera is required.\");\n  }\n\n  if (!defined(canvas)) {\n    throw new DeveloperError(\"options.canvas is required.\");\n  } //>>includeEnd('debug');\n\n\n  this._changed = new Event();\n  this._error = new Event();\n  this._loading = new Event();\n  this._refresh = new Event();\n  this._unsupportedNode = new Event();\n  this._clock = undefined;\n  this._entityCollection = new EntityCollection(this);\n  this._name = undefined;\n  this._isLoading = false;\n  this._pinBuilder = new PinBuilder();\n  this._networkLinks = new AssociativeArray();\n  this._entityCluster = new EntityCluster();\n  this._canvas = canvas;\n  this._camera = camera;\n  this._lastCameraView = {\n    position: defined(camera) ? Cartesian3.clone(camera.positionWC) : undefined,\n    direction: defined(camera) ? Cartesian3.clone(camera.directionWC) : undefined,\n    up: defined(camera) ? Cartesian3.clone(camera.upWC) : undefined,\n    bbox: defined(camera) ? camera.computeViewRectangle() : Rectangle.clone(Rectangle.MAX_VALUE)\n  };\n  this._ellipsoid = defaultValue(options.ellipsoid, Ellipsoid.WGS84); // User specified credit\n\n  var credit = options.credit;\n\n  if (typeof credit === \"string\") {\n    credit = new Credit(credit);\n  }\n\n  this._credit = credit; // Create a list of Credit's from the resource that the user can't remove\n\n  this._resourceCredits = [];\n}\n/**\n * Creates a Promise to a new instance loaded with the provided KML data.\n *\n * @param {Resource|String|Document|Blob} data A url, parsed KML document, or Blob containing binary KMZ data or a parsed KML document.\n * @param {Object} options An object with the following properties:\n * @param {Camera} options.camera The camera that is used for viewRefreshModes and sending camera properties to network links.\n * @param {Canvas} options.canvas The canvas that is used for sending viewer properties to network links.\n * @param {String} [options.sourceUri] Overrides the url to use for resolving relative links and other KML network features.\n * @param {Boolean} [options.clampToGround=false] true if we want the geometry features (Polygons, LineStrings and LinearRings) clamped to the ground.\n * @param {Ellipsoid} [options.ellipsoid=Ellipsoid.WGS84] The global ellipsoid used for geographical calculations.\n * @param {Credit|String} [options.credit] A credit for the data source, which is displayed on the canvas.\n *\n * @returns {Promise.<KmlDataSource>} A promise that will resolve to a new KmlDataSource instance once the KML is loaded.\n */\n\n\nKmlDataSource.load = function (data, options) {\n  options = defaultValue(options, defaultValue.EMPTY_OBJECT);\n  var dataSource = new KmlDataSource(options);\n  return dataSource.load(data, options);\n};\n\nObject.defineProperties(KmlDataSource.prototype, {\n  /**\n   * Gets or sets a human-readable name for this instance.\n   * This will be automatically be set to the KML document name on load.\n   * @memberof KmlDataSource.prototype\n   * @type {String}\n   */\n  name: {\n    get: function () {\n      return this._name;\n    },\n    set: function (value) {\n      if (this._name !== value) {\n        this._name = value;\n\n        this._changed.raiseEvent(this);\n      }\n    }\n  },\n\n  /**\n   * Gets the clock settings defined by the loaded KML. This represents the total\n   * availability interval for all time-dynamic data. If the KML does not contain\n   * time-dynamic data, this value is undefined.\n   * @memberof KmlDataSource.prototype\n   * @type {DataSourceClock}\n   */\n  clock: {\n    get: function () {\n      return this._clock;\n    }\n  },\n\n  /**\n   * Gets the collection of {@link Entity} instances.\n   * @memberof KmlDataSource.prototype\n   * @type {EntityCollection}\n   */\n  entities: {\n    get: function () {\n      return this._entityCollection;\n    }\n  },\n\n  /**\n   * Gets a value indicating if the data source is currently loading data.\n   * @memberof KmlDataSource.prototype\n   * @type {Boolean}\n   */\n  isLoading: {\n    get: function () {\n      return this._isLoading;\n    }\n  },\n\n  /**\n   * Gets an event that will be raised when the underlying data changes.\n   * @memberof KmlDataSource.prototype\n   * @type {Event}\n   */\n  changedEvent: {\n    get: function () {\n      return this._changed;\n    }\n  },\n\n  /**\n   * Gets an event that will be raised if an error is encountered during processing.\n   * @memberof KmlDataSource.prototype\n   * @type {Event}\n   */\n  errorEvent: {\n    get: function () {\n      return this._error;\n    }\n  },\n\n  /**\n   * Gets an event that will be raised when the data source either starts or stops loading.\n   * @memberof KmlDataSource.prototype\n   * @type {Event}\n   */\n  loadingEvent: {\n    get: function () {\n      return this._loading;\n    }\n  },\n\n  /**\n   * Gets an event that will be raised when the data source refreshes a network link.\n   * @memberof KmlDataSource.prototype\n   * @type {Event}\n   */\n  refreshEvent: {\n    get: function () {\n      return this._refresh;\n    }\n  },\n\n  /**\n   * Gets an event that will be raised when the data source finds an unsupported node type.\n   * @memberof KmlDataSource.prototype\n   * @type {Event}\n   */\n  unsupportedNodeEvent: {\n    get: function () {\n      return this._unsupportedNode;\n    }\n  },\n\n  /**\n   * Gets whether or not this data source should be displayed.\n   * @memberof KmlDataSource.prototype\n   * @type {Boolean}\n   */\n  show: {\n    get: function () {\n      return this._entityCollection.show;\n    },\n    set: function (value) {\n      this._entityCollection.show = value;\n    }\n  },\n\n  /**\n   * Gets or sets the clustering options for this data source. This object can be shared between multiple data sources.\n   *\n   * @memberof KmlDataSource.prototype\n   * @type {EntityCluster}\n   */\n  clustering: {\n    get: function () {\n      return this._entityCluster;\n    },\n    set: function (value) {\n      //>>includeStart('debug', pragmas.debug);\n      if (!defined(value)) {\n        throw new DeveloperError(\"value must be defined.\");\n      } //>>includeEnd('debug');\n\n\n      this._entityCluster = value;\n    }\n  },\n\n  /**\n   * Gets the credit that will be displayed for the data source\n   * @memberof KmlDataSource.prototype\n   * @type {Credit}\n   */\n  credit: {\n    get: function () {\n      return this._credit;\n    }\n  }\n});\n/**\n * Asynchronously loads the provided KML data, replacing any existing data.\n *\n * @param {Resource|String|Document|Blob} data A url, parsed KML document, or Blob containing binary KMZ data or a parsed KML document.\n * @param {Object} [options] An object with the following properties:\n * @param {Resource|String} [options.sourceUri] Overrides the url to use for resolving relative links and other KML network features.\n * @param {Boolean} [options.clampToGround=false] true if we want the geometry features (Polygons, LineStrings and LinearRings) clamped to the ground. If true, lines will use corridors so use Entity.corridor instead of Entity.polyline.\n * @param {Ellipsoid} [options.ellipsoid=Ellipsoid.WGS84] The global ellipsoid used for geographical calculations.\n *\n * @returns {Promise.<KmlDataSource>} A promise that will resolve to this instances once the KML is loaded.\n */\n\nKmlDataSource.prototype.load = function (data, options) {\n  //>>includeStart('debug', pragmas.debug);\n  if (!defined(data)) {\n    throw new DeveloperError(\"data is required.\");\n  } //>>includeEnd('debug');\n\n\n  options = defaultValue(options, defaultValue.EMPTY_OBJECT);\n  DataSource.setLoading(this, true);\n  var oldName = this._name;\n  this._name = undefined;\n  this._clampToGround = defaultValue(options.clampToGround, false);\n  var that = this;\n  return load(this, this._entityCollection, data, options).then(function () {\n    var clock;\n\n    var availability = that._entityCollection.computeAvailability();\n\n    var start = availability.start;\n    var stop = availability.stop;\n    var isMinStart = JulianDate.equals(start, Iso8601.MINIMUM_VALUE);\n    var isMaxStop = JulianDate.equals(stop, Iso8601.MAXIMUM_VALUE);\n\n    if (!isMinStart || !isMaxStop) {\n      var date; //If start is min time just start at midnight this morning, local time\n\n      if (isMinStart) {\n        date = new Date();\n        date.setHours(0, 0, 0, 0);\n        start = JulianDate.fromDate(date);\n      } //If stop is max value just stop at midnight tonight, local time\n\n\n      if (isMaxStop) {\n        date = new Date();\n        date.setHours(24, 0, 0, 0);\n        stop = JulianDate.fromDate(date);\n      }\n\n      clock = new DataSourceClock();\n      clock.startTime = start;\n      clock.stopTime = stop;\n      clock.currentTime = JulianDate.clone(start);\n      clock.clockRange = ClockRange.LOOP_STOP;\n      clock.clockStep = ClockStep.SYSTEM_CLOCK_MULTIPLIER;\n      clock.multiplier = Math.round(Math.min(Math.max(JulianDate.secondsDifference(stop, start) / 60, 1), 3.15569e7));\n    }\n\n    var changed = false;\n\n    if (clock !== that._clock) {\n      that._clock = clock;\n      changed = true;\n    }\n\n    if (oldName !== that._name) {\n      changed = true;\n    }\n\n    if (changed) {\n      that._changed.raiseEvent(that);\n    }\n\n    DataSource.setLoading(that, false);\n    return that;\n  }).otherwise(function (error) {\n    DataSource.setLoading(that, false);\n\n    that._error.raiseEvent(that, error);\n\n    console.log(error);\n    return when.reject(error);\n  });\n};\n\nfunction mergeAvailabilityWithParent(child) {\n  var parent = child.parent;\n\n  if (defined(parent)) {\n    var parentAvailability = parent.availability;\n\n    if (defined(parentAvailability)) {\n      var childAvailability = child.availability;\n\n      if (defined(childAvailability)) {\n        childAvailability.intersect(parentAvailability);\n      } else {\n        child.availability = parentAvailability;\n      }\n    }\n  }\n}\n\nfunction getNetworkLinkUpdateCallback(dataSource, networkLink, newEntityCollection, networkLinks, processedHref) {\n  return function (rootElement) {\n    if (!networkLinks.contains(networkLink.id)) {\n      // Got into the odd case where a parent network link was updated while a child\n      //  network link update was in flight, so just throw it away.\n      return;\n    }\n\n    var remove = false;\n    var networkLinkControl = queryFirstNode(rootElement, \"NetworkLinkControl\", namespaces.kml);\n    var hasNetworkLinkControl = defined(networkLinkControl);\n    var minRefreshPeriod = 0;\n\n    if (hasNetworkLinkControl) {\n      if (defined(queryFirstNode(networkLinkControl, \"Update\", namespaces.kml))) {\n        oneTimeWarning(\"kml-networkLinkControl-update\", \"KML - NetworkLinkControl updates aren't supported.\");\n        networkLink.updating = false;\n        networkLinks.remove(networkLink.id);\n        return;\n      }\n\n      networkLink.cookie = queryToObject(defaultValue(queryStringValue(networkLinkControl, \"cookie\", namespaces.kml), \"\"));\n      minRefreshPeriod = defaultValue(queryNumericValue(networkLinkControl, \"minRefreshPeriod\", namespaces.kml), 0);\n    }\n\n    var now = JulianDate.now();\n    var refreshMode = networkLink.refreshMode;\n\n    if (refreshMode === RefreshMode.INTERVAL) {\n      if (defined(networkLinkControl)) {\n        networkLink.time = Math.max(minRefreshPeriod, networkLink.time);\n      }\n    } else if (refreshMode === RefreshMode.EXPIRE) {\n      var expires;\n\n      if (defined(networkLinkControl)) {\n        expires = queryStringValue(networkLinkControl, \"expires\", namespaces.kml);\n      }\n\n      if (defined(expires)) {\n        try {\n          var date = JulianDate.fromIso8601(expires);\n          var diff = JulianDate.secondsDifference(date, now);\n\n          if (diff > 0 && diff < minRefreshPeriod) {\n            JulianDate.addSeconds(now, minRefreshPeriod, date);\n          }\n\n          networkLink.time = date;\n        } catch (e) {\n          oneTimeWarning(\"kml-networkLinkControl-expires\", \"KML - NetworkLinkControl expires is not a valid date\");\n          remove = true;\n        }\n      } else {\n        oneTimeWarning(\"kml-refreshMode-onExpire\", \"KML - refreshMode of onExpire requires the NetworkLinkControl to have an expires element\");\n        remove = true;\n      }\n    }\n\n    var networkLinkEntity = networkLink.entity;\n    var entityCollection = dataSource._entityCollection;\n    var newEntities = newEntityCollection.values;\n\n    function removeChildren(entity) {\n      entityCollection.remove(entity);\n      var children = entity._children;\n      var count = children.length;\n\n      for (var i = 0; i < count; ++i) {\n        removeChildren(children[i]);\n      }\n    } // Remove old entities\n\n\n    entityCollection.suspendEvents();\n    var entitiesCopy = entityCollection.values.slice();\n    var i;\n\n    for (i = 0; i < entitiesCopy.length; ++i) {\n      var entityToRemove = entitiesCopy[i];\n\n      if (entityToRemove.parent === networkLinkEntity) {\n        entityToRemove.parent = undefined;\n        removeChildren(entityToRemove);\n      }\n    }\n\n    entityCollection.resumeEvents(); // Add new entities\n\n    entityCollection.suspendEvents();\n\n    for (i = 0; i < newEntities.length; i++) {\n      var newEntity = newEntities[i];\n\n      if (!defined(newEntity.parent)) {\n        newEntity.parent = networkLinkEntity;\n        mergeAvailabilityWithParent(newEntity);\n      }\n\n      entityCollection.add(newEntity);\n    }\n\n    entityCollection.resumeEvents(); // No refresh information remove it, otherwise update lastUpdate time\n\n    if (remove) {\n      networkLinks.remove(networkLink.id);\n    } else {\n      networkLink.lastUpdated = now;\n    }\n\n    var availability = entityCollection.computeAvailability();\n    var start = availability.start;\n    var stop = availability.stop;\n    var isMinStart = JulianDate.equals(start, Iso8601.MINIMUM_VALUE);\n    var isMaxStop = JulianDate.equals(stop, Iso8601.MAXIMUM_VALUE);\n\n    if (!isMinStart || !isMaxStop) {\n      var clock = dataSource._clock;\n\n      if (clock.startTime !== start || clock.stopTime !== stop) {\n        clock.startTime = start;\n        clock.stopTime = stop;\n\n        dataSource._changed.raiseEvent(dataSource);\n      }\n    }\n\n    networkLink.updating = false;\n    networkLink.needsUpdate = false;\n\n    dataSource._refresh.raiseEvent(dataSource, processedHref.getUrlComponent(true));\n  };\n}\n\nvar entitiesToIgnore = new AssociativeArray();\n/**\n * Updates any NetworkLink that require updating\n * @function\n *\n * @param {JulianDate} time The simulation time.\n * @returns {Boolean} True if this data source is ready to be displayed at the provided time, false otherwise.\n */\n\nKmlDataSource.prototype.update = function (time) {\n  var networkLinks = this._networkLinks;\n\n  if (networkLinks.length === 0) {\n    return true;\n  }\n\n  var now = JulianDate.now();\n  var that = this;\n  entitiesToIgnore.removeAll();\n\n  function recurseIgnoreEntities(entity) {\n    var children = entity._children;\n    var count = children.length;\n\n    for (var i = 0; i < count; ++i) {\n      var child = children[i];\n      entitiesToIgnore.set(child.id, child);\n      recurseIgnoreEntities(child);\n    }\n  }\n\n  var cameraViewUpdate = false;\n  var lastCameraView = this._lastCameraView;\n  var camera = this._camera;\n\n  if (defined(camera) && !(camera.positionWC.equalsEpsilon(lastCameraView.position, CesiumMath.EPSILON7) && camera.directionWC.equalsEpsilon(lastCameraView.direction, CesiumMath.EPSILON7) && camera.upWC.equalsEpsilon(lastCameraView.up, CesiumMath.EPSILON7))) {\n    // Camera has changed so update the last view\n    lastCameraView.position = Cartesian3.clone(camera.positionWC);\n    lastCameraView.direction = Cartesian3.clone(camera.directionWC);\n    lastCameraView.up = Cartesian3.clone(camera.upWC);\n    lastCameraView.bbox = camera.computeViewRectangle();\n    cameraViewUpdate = true;\n  }\n\n  var newNetworkLinks = new AssociativeArray();\n  var changed = false;\n  networkLinks.values.forEach(function (networkLink) {\n    var entity = networkLink.entity;\n\n    if (entitiesToIgnore.contains(entity.id)) {\n      return;\n    }\n\n    if (!networkLink.updating) {\n      var doUpdate = false;\n\n      if (networkLink.refreshMode === RefreshMode.INTERVAL) {\n        if (JulianDate.secondsDifference(now, networkLink.lastUpdated) > networkLink.time) {\n          doUpdate = true;\n        }\n      } else if (networkLink.refreshMode === RefreshMode.EXPIRE) {\n        if (JulianDate.greaterThan(now, networkLink.time)) {\n          doUpdate = true;\n        }\n      } else if (networkLink.refreshMode === RefreshMode.STOP) {\n        if (cameraViewUpdate) {\n          networkLink.needsUpdate = true;\n          networkLink.cameraUpdateTime = now;\n        }\n\n        if (networkLink.needsUpdate && JulianDate.secondsDifference(now, networkLink.cameraUpdateTime) >= networkLink.time) {\n          doUpdate = true;\n        }\n      }\n\n      if (doUpdate) {\n        recurseIgnoreEntities(entity);\n        networkLink.updating = true;\n        var newEntityCollection = new EntityCollection();\n        var href = networkLink.href.clone();\n        href.setQueryParameters(networkLink.cookie);\n        var ellipsoid = defaultValue(that._ellipsoid, Ellipsoid.WGS84);\n        processNetworkLinkQueryString(href, that._camera, that._canvas, networkLink.viewBoundScale, lastCameraView.bbox, ellipsoid);\n        load(that, newEntityCollection, href, {\n          context: entity.id\n        }).then(getNetworkLinkUpdateCallback(that, networkLink, newEntityCollection, newNetworkLinks, href)).otherwise(function (error) {\n          var msg = \"NetworkLink \" + networkLink.href + \" refresh failed: \" + error;\n          console.log(msg);\n\n          that._error.raiseEvent(that, msg);\n        });\n        changed = true;\n      }\n    }\n\n    newNetworkLinks.set(networkLink.id, networkLink);\n  });\n\n  if (changed) {\n    this._networkLinks = newNetworkLinks;\n\n    this._changed.raiseEvent(this);\n  }\n\n  return true;\n};\n/**\n * Contains KML Feature data loaded into the <code>Entity.kml</code> property by {@link KmlDataSource}.\n * @alias KmlFeatureData\n * @constructor\n */\n\n\nfunction KmlFeatureData() {\n  /**\n   * Gets the atom syndication format author field.\n   * @type Object\n   */\n  this.author = {\n    /**\n     * Gets the name.\n     * @type String\n     * @alias author.name\n     * @memberof! KmlFeatureData#\n     * @property author.name\n     */\n    name: undefined,\n\n    /**\n     * Gets the URI.\n     * @type String\n     * @alias author.uri\n     * @memberof! KmlFeatureData#\n     * @property author.uri\n     */\n    uri: undefined,\n\n    /**\n     * Gets the email.\n     * @type String\n     * @alias author.email\n     * @memberof! KmlFeatureData#\n     * @property author.email\n     */\n    email: undefined\n  };\n  /**\n   * Gets the link.\n   * @type Object\n   */\n\n  this.link = {\n    /**\n     * Gets the href.\n     * @type String\n     * @alias link.href\n     * @memberof! KmlFeatureData#\n     * @property link.href\n     */\n    href: undefined,\n\n    /**\n     * Gets the language of the linked resource.\n     * @type String\n     * @alias link.hreflang\n     * @memberof! KmlFeatureData#\n     * @property link.hreflang\n     */\n    hreflang: undefined,\n\n    /**\n     * Gets the link relation.\n     * @type String\n     * @alias link.rel\n     * @memberof! KmlFeatureData#\n     * @property link.rel\n     */\n    rel: undefined,\n\n    /**\n     * Gets the link type.\n     * @type String\n     * @alias link.type\n     * @memberof! KmlFeatureData#\n     * @property link.type\n     */\n    type: undefined,\n\n    /**\n     * Gets the link title.\n     * @type String\n     * @alias link.title\n     * @memberof! KmlFeatureData#\n     * @property link.title\n     */\n    title: undefined,\n\n    /**\n     * Gets the link length.\n     * @type String\n     * @alias link.length\n     * @memberof! KmlFeatureData#\n     * @property link.length\n     */\n    length: undefined\n  };\n  /**\n   * Gets the unstructured address field.\n   * @type String\n   */\n\n  this.address = undefined;\n  /**\n   * Gets the phone number.\n   * @type String\n   */\n\n  this.phoneNumber = undefined;\n  /**\n   * Gets the snippet.\n   * @type String\n   */\n\n  this.snippet = undefined;\n  /**\n   * Gets the extended data, parsed into a JSON object.\n   * Currently only the <code>Data</code> property is supported.\n   * <code>SchemaData</code> and custom data are ignored.\n   * @type String\n   */\n\n  this.extendedData = undefined;\n} // For testing\n\n\nKmlDataSource._DeferredLoading = DeferredLoading;\nKmlDataSource._getTimestamp = getTimestamp;\nexport default KmlDataSource;","map":{"version":3,"sources":["C:/Users/passa/Desktop/WaterLevelReact/node_modules/cesium/Source/DataSources/KmlDataSource.js"],"names":["ArcType","AssociativeArray","BoundingRectangle","Cartesian2","Cartesian3","Cartographic","ClockRange","ClockStep","clone","Color","createGuid","Credit","defaultValue","defined","DeveloperError","Ellipsoid","Event","getExtensionFromUri","getFilenameFromUri","getTimestamp","HeadingPitchRange","HeadingPitchRoll","Iso8601","JulianDate","CesiumMath","NearFarScalar","objectToQuery","oneTimeWarning","PinBuilder","PolygonHierarchy","queryToObject","Rectangle","Resource","RuntimeError","TimeInterval","TimeIntervalCollection","HeightReference","HorizontalOrigin","LabelStyle","SceneMode","Autolinker","Uri","when","zip","BillboardGraphics","CompositePositionProperty","DataSource","DataSourceClock","Entity","EntityCluster","EntityCollection","KmlCamera","KmlLookAt","KmlTour","KmlTourFlyTo","KmlTourWait","LabelGraphics","PathGraphics","PolygonGraphics","PolylineGraphics","PositionPropertyArray","RectangleGraphics","ReferenceProperty","SampledPositionProperty","ScaledPositionProperty","TimeIntervalCollectionProperty","WallGraphics","MimeTypes","avi","bmp","bz2","chm","css","csv","doc","dvi","eps","flv","gif","gz","htm","html","ico","jnlp","jpeg","jpg","m3u","m4v","mathml","mid","midi","mov","mp3","mp4","mp4v","mpeg","mpg","odp","ods","odt","ogg","pdf","png","pps","ppt","ps","qt","rdf","rss","rtf","svg","swf","text","tif","tiff","txt","wav","wma","wmv","xml","detectFromFilename","filename","ext","toLowerCase","parser","DOMParser","autolinker","stripPrefix","email","replaceFn","match","protocolUrlMatch","BILLBOARD_SIZE","BILLBOARD_NEAR_DISTANCE","BILLBOARD_NEAR_RATIO","BILLBOARD_FAR_DISTANCE","BILLBOARD_FAR_RATIO","kmlNamespaces","undefined","gxNamespaces","atomNamespaces","namespaces","kml","gx","atom","kmlgx","concat","featureTypes","Document","processDocument","Folder","processFolder","Placemark","processPlacemark","NetworkLink","processNetworkLink","GroundOverlay","processGroundOverlay","PhotoOverlay","processUnsupportedFeature","ScreenOverlay","Tour","processTour","DeferredLoading","dataSource","_dataSource","_deferred","defer","_stack","_promises","_timeoutSet","_used","_started","_timeThreshold","Object","defineProperties","prototype","get","addNodes","nodes","processingData","push","index","addPromise","promise","wait","deferred","resolve","join","all","process","isFirstCall","length","KmlDataSource","_getTimestamp","_process","_giveUpTime","that","setTimeout","_nextNode","stack","top","_pop","pop","child","featureProcessor","localName","indexOf","namespaceURI","isZipFile","blob","magicBlob","slice","Math","min","size","reader","FileReader","addEventListener","DataView","result","getUint32","reject","error","readAsArrayBuffer","readBlobAsText","readAsText","insertNamespaces","namespaceMap","xsi","firstPart","lastPart","reg","declaration","key","hasOwnProperty","RegExp","test","substr","removeDuplicateNamespaces","endDeclaration","namespace","startIndex","endIndex","loadXmlFromZip","entry","uriResolver","getData","TextWriter","parseFromString","loadDataUriFromZip","mimeType","Data64URIWriter","dataUri","embedDataUris","div","elementType","attributeName","keys","baseUri","elements","querySelectorAll","i","element","value","getAttribute","uri","toString","setAttribute","applyBasePath","sourceResource","resource","resolveHref","url","createEntity","node","entityCollection","context","id","queryStringAttribute","entity","getById","add","addProperty","KmlFeatureData","isExtrudable","altitudeMode","gxAltitudeMode","readCoordinate","ellipsoid","fromDegrees","digits","longitude","parseFloat","latitude","height","isNaN","readCoordinates","tuples","textContent","Array","resultIndex","queryNumericAttribute","queryFirstNode","tagName","childNodes","q","queryNodes","getElementsByTagNameNS","queryChildNodes","queryNumericValue","resultNode","queryStringValue","trim","queryBooleanValue","href","replace","getUrlComponent","getDerivedResource","colorOptions","maximumRed","red","maximumGreen","green","maximumBlue","blue","parseColorString","isRandom","substring","alpha","parseInt","fromRandom","queryColorValue","processTimeStamp","featureNode","whenString","fromIso8601","addInterval","start","stop","MAXIMUM_VALUE","processTimeSpan","beginNode","beginDate","endNode","endDate","lessThan","tmp","MINIMUM_VALUE","createDefaultBillboard","billboard","width","scaleByDistance","pixelOffsetScaleByDistance","createDefaultPolygon","polygon","outline","outlineColor","WHITE","createDefaultLabel","label","translucencyByDistance","pixelOffset","horizontalOrigin","LEFT","font","style","FILL_AND_OUTLINE","getIconHref","iconNode","canRefresh","palette","charAt","x","y","iconNum","hrefResource","refreshMode","viewRefreshMode","viewBoundScale","defaultViewFormat","viewFormat","httpQuery","setQueryParameters","cleanupString","_ellipsoid","processNetworkLinkQueryString","_camera","_canvas","_lastCameraView","bbox","processBillboardIcon","targetEntity","scale","heading","color","icon","w","h","hotSpotNode","hotSpotX","hotSpotY","hotSpotXUnit","hotSpotYUnit","image","imageSubRegion","rotation","toRadians","alignedAxis","UNIT_Z","xOffset","yOffset","applyStyle","styleNode","len","item","fillColor","name","polyline","material","fill","bgColor","textColor","BLACK","balloonStyle","listItemType","computeFinalStyle","placeMark","styleCollection","styleEntity","styleIndex","inlineStyleNode","pairs","p","pair","styleUrl","merge","externalStyle","tokens","split","processExternalStyles","fetchXML","then","styleKml","processStyles","isExternal","styleNodes","styleNodesLength","styleMaps","styleMapsLength","styleMap","getOrCreateEntity","base","promises","styleUrlNodes","getElementsByTagName","styleUrlNodesLength","styleReference","createDropLine","entityPosition","surfacePosition","position","positions","heightReferenceFromAltitudeMode","CLAMP_TO_GROUND","RELATIVE_TO_GROUND","NONE","createPositionPropertyFromAltitudeMode","property","createPositionPropertyArrayFromAltitudeMode","properties","propertiesLength","scaleToGeodeticSurface","processPositionGraphics","heightReference","_pinBuilder","fromColor","YELLOW","getValue","_clampToGround","processPathGraphics","path","leadTime","processPoint","geometryNode","coordinatesString","extrude","processLineStringOrLinearRing","coordinatesNode","tessellate","canExtrude","zIndex","coordinates","wall","outlineWidth","polylineGraphics","clampToGround","arcType","processPolygon","outerBoundaryIsNode","linearRingNode","perPositionHeight","extrudedHeight","hierarchy","innerBoundaryIsNodes","j","k","holes","processTrack","coordNodes","angleNodes","timeNodes","times","addSamples","availability","addToMultiTrack","composite","dropShowProperty","includeEndPoints","data","intervals","isStartIncluded","isStopIncluded","processMultiTrack","interpolate","trackNodes","lastStop","lastStopPosition","needDropLine","trackNode","show","geometryTypes","Point","LineString","LinearRing","Polygon","Track","MultiTrack","MultiGeometry","processMultiGeometry","Model","processUnsupportedGeometry","hasGeometry","childNode","geometryProcessor","childEntity","parent","description","processExtendedData","extendedDataNode","dataNodes","dataNode","displayName","extendedData","scratchDiv","document","createElement","processDescription","kmlData","background","foreground","address","snippet","matches","token","propertyName","isDisplayName","link","innerHTML","links","toCssColorString","processFeature","parentEntity","mergeAvailabilityWithParent","ancestryIsVisible","visibility","authorNode","author","linkNode","hreflang","rel","type","title","phoneNumber","processLookAt","processCamera","deferredLoading","r","newProcessingData","placemark","playlistNodeProcessors","FlyTo","processTourFlyTo","Wait","processTourWait","SoundCue","processTourUnsupportedNode","AnimatedUpdate","TourControl","tour","playlistNode","entryNode","playlistNodeProcessor","console","log","kmlTours","duration","addPlaylistEntry","flyToMode","t","view","lookAt","camera","flyto","lon","lat","altitude","tilt","roll","hpr","range","PI_OVER_TWO","viewPoint","groundOverlay","geometry","isLatLonQuad","rectangle","latLonBox","west","south","east","north","negativePiToPi","clampToLatitudeRange","rotationRadians","stRotation","transparent","_unsupportedNode","raiseEvent","nodeName","RefreshMode","INTERVAL","EXPIRE","STOP","s","sFirst","zeroRectangle","scratchCartographic","scratchCartesian2","scratchCartesian3","canvas","fixLatitude","fixLongitude","PI","TWO_PI","queryString","queryParameters","_mode","MORPHING","centerCartesian","centerCartographic","clientWidth","clientHeight","pickEllipsoid","cartesianToCartographic","center","cartographicToCartesian","equalsEpsilon","EPSILON9","newHalfWidth","newHalfHeight","toDegrees","pitch","distance","positionWC","frustum","aspectRatio","horizFov","vertFov","fov","networkEntity","newSourceUri","options","sourceUri","networkLinkCollection","load","rootElement","entities","_entityCollection","newEntities","values","suspendEvents","newEntity","resumeEvents","refreshInterval","networkLinkControl","hasNetworkLinkControl","now","networkLinkInfo","cookie","lastUpdated","updating","needsUpdate","cameraUpdateTime","minRefreshPeriod","max","time","expires","date","diff","secondsDifference","addSeconds","e","_networkLinks","set","otherwise","_error","processFeatureNode","loadKml","removeAll","documentElement","_name","_DeferredLoading","loadKmz","createReader","BlobReader","getEntries","entries","docEntry","docDefer","directory","innerDefer","close","EMPTY_OBJECT","createIfNeeded","fetchBlob","resourceCredits","_resourceCredits","credits","DEFAULT","dataToLoad","Blob","isZip","body","msg","firstChild","nodeValue","innerText","_changed","_loading","_refresh","_clock","_isLoading","_entityCluster","direction","directionWC","up","upWC","computeViewRectangle","MAX_VALUE","WGS84","credit","_credit","clock","isLoading","changedEvent","errorEvent","loadingEvent","refreshEvent","unsupportedNodeEvent","clustering","setLoading","oldName","computeAvailability","isMinStart","equals","isMaxStop","Date","setHours","fromDate","startTime","stopTime","currentTime","clockRange","LOOP_STOP","clockStep","SYSTEM_CLOCK_MULTIPLIER","multiplier","round","changed","parentAvailability","childAvailability","intersect","getNetworkLinkUpdateCallback","networkLink","newEntityCollection","networkLinks","processedHref","contains","remove","networkLinkEntity","removeChildren","children","_children","count","entitiesCopy","entityToRemove","entitiesToIgnore","update","recurseIgnoreEntities","cameraViewUpdate","lastCameraView","EPSILON7","newNetworkLinks","forEach","doUpdate","greaterThan"],"mappings":"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","sourcesContent":["import ArcType from \"../Core/ArcType.js\";\nimport AssociativeArray from \"../Core/AssociativeArray.js\";\nimport BoundingRectangle from \"../Core/BoundingRectangle.js\";\nimport Cartesian2 from \"../Core/Cartesian2.js\";\nimport Cartesian3 from \"../Core/Cartesian3.js\";\nimport Cartographic from \"../Core/Cartographic.js\";\nimport ClockRange from \"../Core/ClockRange.js\";\nimport ClockStep from \"../Core/ClockStep.js\";\nimport clone from \"../Core/clone.js\";\nimport Color from \"../Core/Color.js\";\nimport createGuid from \"../Core/createGuid.js\";\nimport Credit from \"../Core/Credit.js\";\nimport defaultValue from \"../Core/defaultValue.js\";\nimport defined from \"../Core/defined.js\";\nimport DeveloperError from \"../Core/DeveloperError.js\";\nimport Ellipsoid from \"../Core/Ellipsoid.js\";\nimport Event from \"../Core/Event.js\";\nimport getExtensionFromUri from \"../Core/getExtensionFromUri.js\";\nimport getFilenameFromUri from \"../Core/getFilenameFromUri.js\";\nimport getTimestamp from \"../Core/getTimestamp.js\";\nimport HeadingPitchRange from \"../Core/HeadingPitchRange.js\";\nimport HeadingPitchRoll from \"../Core/HeadingPitchRoll.js\";\nimport Iso8601 from \"../Core/Iso8601.js\";\nimport JulianDate from \"../Core/JulianDate.js\";\nimport CesiumMath from \"../Core/Math.js\";\nimport NearFarScalar from \"../Core/NearFarScalar.js\";\nimport objectToQuery from \"../Core/objectToQuery.js\";\nimport oneTimeWarning from \"../Core/oneTimeWarning.js\";\nimport PinBuilder from \"../Core/PinBuilder.js\";\nimport PolygonHierarchy from \"../Core/PolygonHierarchy.js\";\nimport queryToObject from \"../Core/queryToObject.js\";\nimport Rectangle from \"../Core/Rectangle.js\";\nimport Resource from \"../Core/Resource.js\";\nimport RuntimeError from \"../Core/RuntimeError.js\";\nimport TimeInterval from \"../Core/TimeInterval.js\";\nimport TimeIntervalCollection from \"../Core/TimeIntervalCollection.js\";\nimport HeightReference from \"../Scene/HeightReference.js\";\nimport HorizontalOrigin from \"../Scene/HorizontalOrigin.js\";\nimport LabelStyle from \"../Scene/LabelStyle.js\";\nimport SceneMode from \"../Scene/SceneMode.js\";\nimport Autolinker from \"../ThirdParty/Autolinker.js\";\nimport Uri from \"../ThirdParty/Uri.js\";\nimport when from \"../ThirdParty/when.js\";\nimport zip from \"../ThirdParty/zip.js\";\nimport BillboardGraphics from \"./BillboardGraphics.js\";\nimport CompositePositionProperty from \"./CompositePositionProperty.js\";\nimport DataSource from \"./DataSource.js\";\nimport DataSourceClock from \"./DataSourceClock.js\";\nimport Entity from \"./Entity.js\";\nimport EntityCluster from \"./EntityCluster.js\";\nimport EntityCollection from \"./EntityCollection.js\";\nimport KmlCamera from \"./KmlCamera.js\";\nimport KmlLookAt from \"./KmlLookAt.js\";\nimport KmlTour from \"./KmlTour.js\";\nimport KmlTourFlyTo from \"./KmlTourFlyTo.js\";\nimport KmlTourWait from \"./KmlTourWait.js\";\nimport LabelGraphics from \"./LabelGraphics.js\";\nimport PathGraphics from \"./PathGraphics.js\";\nimport PolygonGraphics from \"./PolygonGraphics.js\";\nimport PolylineGraphics from \"./PolylineGraphics.js\";\nimport PositionPropertyArray from \"./PositionPropertyArray.js\";\nimport RectangleGraphics from \"./RectangleGraphics.js\";\nimport ReferenceProperty from \"./ReferenceProperty.js\";\nimport SampledPositionProperty from \"./SampledPositionProperty.js\";\nimport ScaledPositionProperty from \"./ScaledPositionProperty.js\";\nimport TimeIntervalCollectionProperty from \"./TimeIntervalCollectionProperty.js\";\nimport WallGraphics from \"./WallGraphics.js\";\n\n//This is by no means an exhaustive list of MIME types.\n//The purpose of this list is to be able to accurately identify content embedded\n//in KMZ files. Eventually, we can make this configurable by the end user so they can add\n//there own content types if they have KMZ files that require it.\nvar MimeTypes = {\n  avi: \"video/x-msvideo\",\n  bmp: \"image/bmp\",\n  bz2: \"application/x-bzip2\",\n  chm: \"application/vnd.ms-htmlhelp\",\n  css: \"text/css\",\n  csv: \"text/csv\",\n  doc: \"application/msword\",\n  dvi: \"application/x-dvi\",\n  eps: \"application/postscript\",\n  flv: \"video/x-flv\",\n  gif: \"image/gif\",\n  gz: \"application/x-gzip\",\n  htm: \"text/html\",\n  html: \"text/html\",\n  ico: \"image/vnd.microsoft.icon\",\n  jnlp: \"application/x-java-jnlp-file\",\n  jpeg: \"image/jpeg\",\n  jpg: \"image/jpeg\",\n  m3u: \"audio/x-mpegurl\",\n  m4v: \"video/mp4\",\n  mathml: \"application/mathml+xml\",\n  mid: \"audio/midi\",\n  midi: \"audio/midi\",\n  mov: \"video/quicktime\",\n  mp3: \"audio/mpeg\",\n  mp4: \"video/mp4\",\n  mp4v: \"video/mp4\",\n  mpeg: \"video/mpeg\",\n  mpg: \"video/mpeg\",\n  odp: \"application/vnd.oasis.opendocument.presentation\",\n  ods: \"application/vnd.oasis.opendocument.spreadsheet\",\n  odt: \"application/vnd.oasis.opendocument.text\",\n  ogg: \"application/ogg\",\n  pdf: \"application/pdf\",\n  png: \"image/png\",\n  pps: \"application/vnd.ms-powerpoint\",\n  ppt: \"application/vnd.ms-powerpoint\",\n  ps: \"application/postscript\",\n  qt: \"video/quicktime\",\n  rdf: \"application/rdf+xml\",\n  rss: \"application/rss+xml\",\n  rtf: \"application/rtf\",\n  svg: \"image/svg+xml\",\n  swf: \"application/x-shockwave-flash\",\n  text: \"text/plain\",\n  tif: \"image/tiff\",\n  tiff: \"image/tiff\",\n  txt: \"text/plain\",\n  wav: \"audio/x-wav\",\n  wma: \"audio/x-ms-wma\",\n  wmv: \"video/x-ms-wmv\",\n  xml: \"application/xml\",\n  zip: \"application/zip\",\n\n  detectFromFilename: function (filename) {\n    var ext = filename.toLowerCase();\n    ext = getExtensionFromUri(ext);\n    return MimeTypes[ext];\n  },\n};\n\nvar parser;\nif (typeof DOMParser !== \"undefined\") {\n  parser = new DOMParser();\n}\n\nvar autolinker = new Autolinker({\n  stripPrefix: false,\n  email: false,\n  replaceFn: function (match) {\n    if (!match.protocolUrlMatch) {\n      //Prevent matching of non-explicit urls.\n      //i.e. foo.id won't match but http://foo.id will\n      return false;\n    }\n  },\n});\n\nvar BILLBOARD_SIZE = 32;\n\nvar BILLBOARD_NEAR_DISTANCE = 2414016;\nvar BILLBOARD_NEAR_RATIO = 1.0;\nvar BILLBOARD_FAR_DISTANCE = 1.6093e7;\nvar BILLBOARD_FAR_RATIO = 0.1;\n\nvar kmlNamespaces = [\n  null,\n  undefined,\n  \"http://www.opengis.net/kml/2.2\",\n  \"http://earth.google.com/kml/2.2\",\n  \"http://earth.google.com/kml/2.1\",\n  \"http://earth.google.com/kml/2.0\",\n];\nvar gxNamespaces = [\"http://www.google.com/kml/ext/2.2\"];\nvar atomNamespaces = [\"http://www.w3.org/2005/Atom\"];\nvar namespaces = {\n  kml: kmlNamespaces,\n  gx: gxNamespaces,\n  atom: atomNamespaces,\n  kmlgx: kmlNamespaces.concat(gxNamespaces),\n};\n\n// Ensure Specs/Data/KML/unsupported.kml is kept up to date with these supported types\nvar featureTypes = {\n  Document: processDocument,\n  Folder: processFolder,\n  Placemark: processPlacemark,\n  NetworkLink: processNetworkLink,\n  GroundOverlay: processGroundOverlay,\n  PhotoOverlay: processUnsupportedFeature,\n  ScreenOverlay: processUnsupportedFeature,\n  Tour: processTour,\n};\n\nfunction DeferredLoading(dataSource) {\n  this._dataSource = dataSource;\n  this._deferred = when.defer();\n  this._stack = [];\n  this._promises = [];\n  this._timeoutSet = false;\n  this._used = false;\n\n  this._started = 0;\n  this._timeThreshold = 1000; // Initial load is 1 second\n}\n\nObject.defineProperties(DeferredLoading.prototype, {\n  dataSource: {\n    get: function () {\n      return this._dataSource;\n    },\n  },\n});\n\nDeferredLoading.prototype.addNodes = function (nodes, processingData) {\n  this._stack.push({\n    nodes: nodes,\n    index: 0,\n    processingData: processingData,\n  });\n  this._used = true;\n};\n\nDeferredLoading.prototype.addPromise = function (promise) {\n  this._promises.push(promise);\n};\n\nDeferredLoading.prototype.wait = function () {\n  // Case where we had a non-document/folder as the root\n  var deferred = this._deferred;\n  if (!this._used) {\n    deferred.resolve();\n  }\n\n  return when.join(deferred.promise, when.all(this._promises));\n};\n\nDeferredLoading.prototype.process = function () {\n  var isFirstCall = this._stack.length === 1;\n  if (isFirstCall) {\n    this._started = KmlDataSource._getTimestamp();\n  }\n\n  return this._process(isFirstCall);\n};\n\nDeferredLoading.prototype._giveUpTime = function () {\n  if (this._timeoutSet) {\n    // Timeout was already set so just return\n    return;\n  }\n\n  this._timeoutSet = true;\n  this._timeThreshold = 50; // After the first load lower threshold to 0.5 seconds\n  var that = this;\n  setTimeout(function () {\n    that._timeoutSet = false;\n    that._started = KmlDataSource._getTimestamp();\n    that._process(true);\n  }, 0);\n};\n\nDeferredLoading.prototype._nextNode = function () {\n  var stack = this._stack;\n  var top = stack[stack.length - 1];\n  var index = top.index;\n  var nodes = top.nodes;\n  if (index === nodes.length) {\n    return;\n  }\n  ++top.index;\n\n  return nodes[index];\n};\n\nDeferredLoading.prototype._pop = function () {\n  var stack = this._stack;\n  stack.pop();\n\n  // Return false if we are done\n  if (stack.length === 0) {\n    this._deferred.resolve();\n    return false;\n  }\n\n  return true;\n};\n\nDeferredLoading.prototype._process = function (isFirstCall) {\n  var dataSource = this.dataSource;\n  var processingData = this._stack[this._stack.length - 1].processingData;\n\n  var child = this._nextNode();\n  while (defined(child)) {\n    var featureProcessor = featureTypes[child.localName];\n    if (\n      defined(featureProcessor) &&\n      (namespaces.kml.indexOf(child.namespaceURI) !== -1 ||\n        namespaces.gx.indexOf(child.namespaceURI) !== -1)\n    ) {\n      featureProcessor(dataSource, child, processingData, this);\n\n      // Give up time and continue loading later\n      if (\n        this._timeoutSet ||\n        KmlDataSource._getTimestamp() > this._started + this._timeThreshold\n      ) {\n        this._giveUpTime();\n        return;\n      }\n    }\n\n    child = this._nextNode();\n  }\n\n  // If we are a recursive call from a subfolder, just return so the parent folder can continue processing\n  // If we aren't then make another call to processNodes because there is stuff still left in the queue\n  if (this._pop() && isFirstCall) {\n    this._process(true);\n  }\n};\n\nfunction isZipFile(blob) {\n  var magicBlob = blob.slice(0, Math.min(4, blob.size));\n  var deferred = when.defer();\n  var reader = new FileReader();\n  reader.addEventListener(\"load\", function () {\n    deferred.resolve(\n      new DataView(reader.result).getUint32(0, false) === 0x504b0304\n    );\n  });\n  reader.addEventListener(\"error\", function () {\n    deferred.reject(reader.error);\n  });\n  reader.readAsArrayBuffer(magicBlob);\n  return deferred.promise;\n}\n\nfunction readBlobAsText(blob) {\n  var deferred = when.defer();\n  var reader = new FileReader();\n  reader.addEventListener(\"load\", function () {\n    deferred.resolve(reader.result);\n  });\n  reader.addEventListener(\"error\", function () {\n    deferred.reject(reader.error);\n  });\n  reader.readAsText(blob);\n  return deferred.promise;\n}\n\nfunction insertNamespaces(text) {\n  var namespaceMap = {\n    xsi: \"http://www.w3.org/2001/XMLSchema-instance\",\n  };\n  var firstPart, lastPart, reg, declaration;\n\n  for (var key in namespaceMap) {\n    if (namespaceMap.hasOwnProperty(key)) {\n      reg = RegExp(\"[< ]\" + key + \":\");\n      declaration = \"xmlns:\" + key + \"=\";\n      if (reg.test(text) && text.indexOf(declaration) === -1) {\n        if (!defined(firstPart)) {\n          firstPart = text.substr(0, text.indexOf(\"<kml\") + 4);\n          lastPart = text.substr(firstPart.length);\n        }\n        firstPart += \" \" + declaration + '\"' + namespaceMap[key] + '\"';\n      }\n    }\n  }\n\n  if (defined(firstPart)) {\n    text = firstPart + lastPart;\n  }\n\n  return text;\n}\n\nfunction removeDuplicateNamespaces(text) {\n  var index = text.indexOf(\"xmlns:\");\n  var endDeclaration = text.indexOf(\">\", index);\n  var namespace, startIndex, endIndex;\n\n  while (index !== -1 && index < endDeclaration) {\n    namespace = text.slice(index, text.indexOf('\"', index));\n    startIndex = index;\n    index = text.indexOf(namespace, index + 1);\n    if (index !== -1) {\n      endIndex = text.indexOf('\"', text.indexOf('\"', index) + 1);\n      text = text.slice(0, index - 1) + text.slice(endIndex + 1, text.length);\n      index = text.indexOf(\"xmlns:\", startIndex - 1);\n    } else {\n      index = text.indexOf(\"xmlns:\", startIndex + 1);\n    }\n  }\n\n  return text;\n}\n\nfunction loadXmlFromZip(entry, uriResolver, deferred) {\n  entry.getData(new zip.TextWriter(), function (text) {\n    text = insertNamespaces(text);\n    text = removeDuplicateNamespaces(text);\n    uriResolver.kml = parser.parseFromString(text, \"application/xml\");\n    deferred.resolve();\n  });\n}\n\nfunction loadDataUriFromZip(entry, uriResolver, deferred) {\n  var mimeType = defaultValue(\n    MimeTypes.detectFromFilename(entry.filename),\n    \"application/octet-stream\"\n  );\n  entry.getData(new zip.Data64URIWriter(mimeType), function (dataUri) {\n    uriResolver[entry.filename] = dataUri;\n    deferred.resolve();\n  });\n}\n\nfunction embedDataUris(div, elementType, attributeName, uriResolver) {\n  var keys = uriResolver.keys;\n  var baseUri = new Uri(\".\");\n  var elements = div.querySelectorAll(elementType);\n  for (var i = 0; i < elements.length; i++) {\n    var element = elements[i];\n    var value = element.getAttribute(attributeName);\n    var uri = new Uri(value).resolve(baseUri).toString();\n    var index = keys.indexOf(uri);\n    if (index !== -1) {\n      var key = keys[index];\n      element.setAttribute(attributeName, uriResolver[key]);\n      if (elementType === \"a\" && element.getAttribute(\"download\") === null) {\n        element.setAttribute(\"download\", key);\n      }\n    }\n  }\n}\n\nfunction applyBasePath(div, elementType, attributeName, sourceResource) {\n  var elements = div.querySelectorAll(elementType);\n  for (var i = 0; i < elements.length; i++) {\n    var element = elements[i];\n    var value = element.getAttribute(attributeName);\n    var resource = resolveHref(value, sourceResource);\n    element.setAttribute(attributeName, resource.url);\n  }\n}\n\n// an optional context is passed to allow for some malformed kmls (those with multiple geometries with same ids) to still parse\n// correctly, as they do in Google Earth.\nfunction createEntity(node, entityCollection, context) {\n  var id = queryStringAttribute(node, \"id\");\n  id = defined(id) && id.length !== 0 ? id : createGuid();\n  if (defined(context)) {\n    id = context + id;\n  }\n\n  // If we have a duplicate ID just generate one.\n  // This isn't valid KML but Google Earth handles this case.\n  var entity = entityCollection.getById(id);\n  if (defined(entity)) {\n    id = createGuid();\n    if (defined(context)) {\n      id = context + id;\n    }\n  }\n\n  entity = entityCollection.add(new Entity({ id: id }));\n  if (!defined(entity.kml)) {\n    entity.addProperty(\"kml\");\n    entity.kml = new KmlFeatureData();\n  }\n  return entity;\n}\n\nfunction isExtrudable(altitudeMode, gxAltitudeMode) {\n  return (\n    altitudeMode === \"absolute\" ||\n    altitudeMode === \"relativeToGround\" ||\n    gxAltitudeMode === \"relativeToSeaFloor\"\n  );\n}\n\nfunction readCoordinate(value, ellipsoid) {\n  //Google Earth treats empty or missing coordinates as 0.\n  if (!defined(value)) {\n    return Cartesian3.fromDegrees(0, 0, 0, ellipsoid);\n  }\n\n  var digits = value.match(/[^\\s,\\n]+/g);\n  if (!defined(digits)) {\n    return Cartesian3.fromDegrees(0, 0, 0, ellipsoid);\n  }\n\n  var longitude = parseFloat(digits[0]);\n  var latitude = parseFloat(digits[1]);\n  var height = parseFloat(digits[2]);\n\n  longitude = isNaN(longitude) ? 0.0 : longitude;\n  latitude = isNaN(latitude) ? 0.0 : latitude;\n  height = isNaN(height) ? 0.0 : height;\n\n  return Cartesian3.fromDegrees(longitude, latitude, height, ellipsoid);\n}\n\nfunction readCoordinates(element, ellipsoid) {\n  if (!defined(element)) {\n    return undefined;\n  }\n\n  var tuples = element.textContent.match(/[^\\s\\n]+/g);\n  if (!defined(tuples)) {\n    return undefined;\n  }\n\n  var length = tuples.length;\n  var result = new Array(length);\n  var resultIndex = 0;\n  for (var i = 0; i < length; i++) {\n    result[resultIndex++] = readCoordinate(tuples[i], ellipsoid);\n  }\n  return result;\n}\n\nfunction queryNumericAttribute(node, attributeName) {\n  if (!defined(node)) {\n    return undefined;\n  }\n\n  var value = node.getAttribute(attributeName);\n  if (value !== null) {\n    var result = parseFloat(value);\n    return !isNaN(result) ? result : undefined;\n  }\n  return undefined;\n}\n\nfunction queryStringAttribute(node, attributeName) {\n  if (!defined(node)) {\n    return undefined;\n  }\n  var value = node.getAttribute(attributeName);\n  return value !== null ? value : undefined;\n}\n\nfunction queryFirstNode(node, tagName, namespace) {\n  if (!defined(node)) {\n    return undefined;\n  }\n  var childNodes = node.childNodes;\n  var length = childNodes.length;\n  for (var q = 0; q < length; q++) {\n    var child = childNodes[q];\n    if (\n      child.localName === tagName &&\n      namespace.indexOf(child.namespaceURI) !== -1\n    ) {\n      return child;\n    }\n  }\n  return undefined;\n}\n\nfunction queryNodes(node, tagName, namespace) {\n  if (!defined(node)) {\n    return undefined;\n  }\n  var result = [];\n  var childNodes = node.getElementsByTagNameNS(\"*\", tagName);\n  var length = childNodes.length;\n  for (var q = 0; q < length; q++) {\n    var child = childNodes[q];\n    if (\n      child.localName === tagName &&\n      namespace.indexOf(child.namespaceURI) !== -1\n    ) {\n      result.push(child);\n    }\n  }\n  return result;\n}\n\nfunction queryChildNodes(node, tagName, namespace) {\n  if (!defined(node)) {\n    return [];\n  }\n  var result = [];\n  var childNodes = node.childNodes;\n  var length = childNodes.length;\n  for (var q = 0; q < length; q++) {\n    var child = childNodes[q];\n    if (\n      child.localName === tagName &&\n      namespace.indexOf(child.namespaceURI) !== -1\n    ) {\n      result.push(child);\n    }\n  }\n  return result;\n}\n\nfunction queryNumericValue(node, tagName, namespace) {\n  var resultNode = queryFirstNode(node, tagName, namespace);\n  if (defined(resultNode)) {\n    var result = parseFloat(resultNode.textContent);\n    return !isNaN(result) ? result : undefined;\n  }\n  return undefined;\n}\n\nfunction queryStringValue(node, tagName, namespace) {\n  var result = queryFirstNode(node, tagName, namespace);\n  if (defined(result)) {\n    return result.textContent.trim();\n  }\n  return undefined;\n}\n\nfunction queryBooleanValue(node, tagName, namespace) {\n  var result = queryFirstNode(node, tagName, namespace);\n  if (defined(result)) {\n    var value = result.textContent.trim();\n    return value === \"1\" || /^true$/i.test(value);\n  }\n  return undefined;\n}\n\nfunction resolveHref(href, sourceResource, uriResolver) {\n  if (!defined(href)) {\n    return undefined;\n  }\n\n  var resource;\n  if (defined(uriResolver)) {\n    // To resolve issues with KML sources defined in Windows style paths.\n    href = href.replace(/\\\\/g, \"/\");\n    var blob = uriResolver[href];\n    if (defined(blob)) {\n      resource = new Resource({\n        url: blob,\n      });\n    } else {\n      // Needed for multiple levels of KML files in a KMZ\n      var baseUri = new Uri(sourceResource.getUrlComponent());\n      var uri = new Uri(href);\n      blob = uriResolver[uri.resolve(baseUri)];\n      if (defined(blob)) {\n        resource = new Resource({\n          url: blob,\n        });\n      }\n    }\n  }\n\n  if (!defined(resource)) {\n    resource = sourceResource.getDerivedResource({\n      url: href,\n    });\n  }\n\n  return resource;\n}\n\nvar colorOptions = {\n  maximumRed: undefined,\n  red: undefined,\n  maximumGreen: undefined,\n  green: undefined,\n  maximumBlue: undefined,\n  blue: undefined,\n};\n\nfunction parseColorString(value, isRandom) {\n  if (!defined(value) || /^\\s*$/gm.test(value)) {\n    return undefined;\n  }\n\n  if (value[0] === \"#\") {\n    value = value.substring(1);\n  }\n\n  var alpha = parseInt(value.substring(0, 2), 16) / 255.0;\n  var blue = parseInt(value.substring(2, 4), 16) / 255.0;\n  var green = parseInt(value.substring(4, 6), 16) / 255.0;\n  var red = parseInt(value.substring(6, 8), 16) / 255.0;\n\n  if (!isRandom) {\n    return new Color(red, green, blue, alpha);\n  }\n\n  if (red > 0) {\n    colorOptions.maximumRed = red;\n    colorOptions.red = undefined;\n  } else {\n    colorOptions.maximumRed = undefined;\n    colorOptions.red = 0;\n  }\n  if (green > 0) {\n    colorOptions.maximumGreen = green;\n    colorOptions.green = undefined;\n  } else {\n    colorOptions.maximumGreen = undefined;\n    colorOptions.green = 0;\n  }\n  if (blue > 0) {\n    colorOptions.maximumBlue = blue;\n    colorOptions.blue = undefined;\n  } else {\n    colorOptions.maximumBlue = undefined;\n    colorOptions.blue = 0;\n  }\n  colorOptions.alpha = alpha;\n  return Color.fromRandom(colorOptions);\n}\n\nfunction queryColorValue(node, tagName, namespace) {\n  var value = queryStringValue(node, tagName, namespace);\n  if (!defined(value)) {\n    return undefined;\n  }\n  return parseColorString(\n    value,\n    queryStringValue(node, \"colorMode\", namespace) === \"random\"\n  );\n}\n\nfunction processTimeStamp(featureNode) {\n  var node = queryFirstNode(featureNode, \"TimeStamp\", namespaces.kmlgx);\n  var whenString = queryStringValue(node, \"when\", namespaces.kmlgx);\n\n  if (!defined(node) || !defined(whenString) || whenString.length === 0) {\n    return undefined;\n  }\n\n  //According to the KML spec, a TimeStamp represents a \"single moment in time\"\n  //However, since Cesium animates much differently than Google Earth, that doesn't\n  //Make much sense here.  Instead, we use the TimeStamp as the moment the feature\n  //comes into existence.  This works much better and gives a similar feel to\n  //GE's experience.\n  var when = JulianDate.fromIso8601(whenString);\n  var result = new TimeIntervalCollection();\n  result.addInterval(\n    new TimeInterval({\n      start: when,\n      stop: Iso8601.MAXIMUM_VALUE,\n    })\n  );\n  return result;\n}\n\nfunction processTimeSpan(featureNode) {\n  var node = queryFirstNode(featureNode, \"TimeSpan\", namespaces.kmlgx);\n  if (!defined(node)) {\n    return undefined;\n  }\n  var result;\n\n  var beginNode = queryFirstNode(node, \"begin\", namespaces.kmlgx);\n  var beginDate = defined(beginNode)\n    ? JulianDate.fromIso8601(beginNode.textContent)\n    : undefined;\n\n  var endNode = queryFirstNode(node, \"end\", namespaces.kmlgx);\n  var endDate = defined(endNode)\n    ? JulianDate.fromIso8601(endNode.textContent)\n    : undefined;\n\n  if (defined(beginDate) && defined(endDate)) {\n    if (JulianDate.lessThan(endDate, beginDate)) {\n      var tmp = beginDate;\n      beginDate = endDate;\n      endDate = tmp;\n    }\n    result = new TimeIntervalCollection();\n    result.addInterval(\n      new TimeInterval({\n        start: beginDate,\n        stop: endDate,\n      })\n    );\n  } else if (defined(beginDate)) {\n    result = new TimeIntervalCollection();\n    result.addInterval(\n      new TimeInterval({\n        start: beginDate,\n        stop: Iso8601.MAXIMUM_VALUE,\n      })\n    );\n  } else if (defined(endDate)) {\n    result = new TimeIntervalCollection();\n    result.addInterval(\n      new TimeInterval({\n        start: Iso8601.MINIMUM_VALUE,\n        stop: endDate,\n      })\n    );\n  }\n\n  return result;\n}\n\nfunction createDefaultBillboard() {\n  var billboard = new BillboardGraphics();\n  billboard.width = BILLBOARD_SIZE;\n  billboard.height = BILLBOARD_SIZE;\n  billboard.scaleByDistance = new NearFarScalar(\n    BILLBOARD_NEAR_DISTANCE,\n    BILLBOARD_NEAR_RATIO,\n    BILLBOARD_FAR_DISTANCE,\n    BILLBOARD_FAR_RATIO\n  );\n  billboard.pixelOffsetScaleByDistance = new NearFarScalar(\n    BILLBOARD_NEAR_DISTANCE,\n    BILLBOARD_NEAR_RATIO,\n    BILLBOARD_FAR_DISTANCE,\n    BILLBOARD_FAR_RATIO\n  );\n  return billboard;\n}\n\nfunction createDefaultPolygon() {\n  var polygon = new PolygonGraphics();\n  polygon.outline = true;\n  polygon.outlineColor = Color.WHITE;\n  return polygon;\n}\n\nfunction createDefaultLabel() {\n  var label = new LabelGraphics();\n  label.translucencyByDistance = new NearFarScalar(3000000, 1.0, 5000000, 0.0);\n  label.pixelOffset = new Cartesian2(17, 0);\n  label.horizontalOrigin = HorizontalOrigin.LEFT;\n  label.font = \"16px sans-serif\";\n  label.style = LabelStyle.FILL_AND_OUTLINE;\n  return label;\n}\n\nfunction getIconHref(\n  iconNode,\n  dataSource,\n  sourceResource,\n  uriResolver,\n  canRefresh\n) {\n  var href = queryStringValue(iconNode, \"href\", namespaces.kml);\n  if (!defined(href) || href.length === 0) {\n    return undefined;\n  }\n\n  if (href.indexOf(\"root://icons/palette-\") === 0) {\n    var palette = href.charAt(21);\n\n    // Get the icon number\n    var x = defaultValue(queryNumericValue(iconNode, \"x\", namespaces.gx), 0);\n    var y = defaultValue(queryNumericValue(iconNode, \"y\", namespaces.gx), 0);\n    x = Math.min(x / 32, 7);\n    y = 7 - Math.min(y / 32, 7);\n    var iconNum = 8 * y + x;\n\n    href =\n      \"https://maps.google.com/mapfiles/kml/pal\" +\n      palette +\n      \"/icon\" +\n      iconNum +\n      \".png\";\n  }\n\n  var hrefResource = resolveHref(href, sourceResource, uriResolver);\n\n  if (canRefresh) {\n    var refreshMode = queryStringValue(iconNode, \"refreshMode\", namespaces.kml);\n    var viewRefreshMode = queryStringValue(\n      iconNode,\n      \"viewRefreshMode\",\n      namespaces.kml\n    );\n    if (refreshMode === \"onInterval\" || refreshMode === \"onExpire\") {\n      oneTimeWarning(\n        \"kml-refreshMode-\" + refreshMode,\n        \"KML - Unsupported Icon refreshMode: \" + refreshMode\n      );\n    } else if (viewRefreshMode === \"onStop\" || viewRefreshMode === \"onRegion\") {\n      oneTimeWarning(\n        \"kml-refreshMode-\" + viewRefreshMode,\n        \"KML - Unsupported Icon viewRefreshMode: \" + viewRefreshMode\n      );\n    }\n\n    var viewBoundScale = defaultValue(\n      queryStringValue(iconNode, \"viewBoundScale\", namespaces.kml),\n      1.0\n    );\n    var defaultViewFormat =\n      viewRefreshMode === \"onStop\"\n        ? \"BBOX=[bboxWest],[bboxSouth],[bboxEast],[bboxNorth]\"\n        : \"\";\n    var viewFormat = defaultValue(\n      queryStringValue(iconNode, \"viewFormat\", namespaces.kml),\n      defaultViewFormat\n    );\n    var httpQuery = queryStringValue(iconNode, \"httpQuery\", namespaces.kml);\n    if (defined(viewFormat)) {\n      hrefResource.setQueryParameters(queryToObject(cleanupString(viewFormat)));\n    }\n    if (defined(httpQuery)) {\n      hrefResource.setQueryParameters(queryToObject(cleanupString(httpQuery)));\n    }\n\n    var ellipsoid = dataSource._ellipsoid;\n    processNetworkLinkQueryString(\n      hrefResource,\n      dataSource._camera,\n      dataSource._canvas,\n      viewBoundScale,\n      dataSource._lastCameraView.bbox,\n      ellipsoid\n    );\n\n    return hrefResource;\n  }\n\n  return hrefResource;\n}\n\nfunction processBillboardIcon(\n  dataSource,\n  node,\n  targetEntity,\n  sourceResource,\n  uriResolver\n) {\n  var scale = queryNumericValue(node, \"scale\", namespaces.kml);\n  var heading = queryNumericValue(node, \"heading\", namespaces.kml);\n  var color = queryColorValue(node, \"color\", namespaces.kml);\n\n  var iconNode = queryFirstNode(node, \"Icon\", namespaces.kml);\n  var icon = getIconHref(\n    iconNode,\n    dataSource,\n    sourceResource,\n    uriResolver,\n    false\n  );\n\n  // If icon tags are present but blank, we do not want to show an icon\n  if (defined(iconNode) && !defined(icon)) {\n    icon = false;\n  }\n\n  var x = queryNumericValue(iconNode, \"x\", namespaces.gx);\n  var y = queryNumericValue(iconNode, \"y\", namespaces.gx);\n  var w = queryNumericValue(iconNode, \"w\", namespaces.gx);\n  var h = queryNumericValue(iconNode, \"h\", namespaces.gx);\n\n  var hotSpotNode = queryFirstNode(node, \"hotSpot\", namespaces.kml);\n  var hotSpotX = queryNumericAttribute(hotSpotNode, \"x\");\n  var hotSpotY = queryNumericAttribute(hotSpotNode, \"y\");\n  var hotSpotXUnit = queryStringAttribute(hotSpotNode, \"xunits\");\n  var hotSpotYUnit = queryStringAttribute(hotSpotNode, \"yunits\");\n\n  var billboard = targetEntity.billboard;\n  if (!defined(billboard)) {\n    billboard = createDefaultBillboard();\n    targetEntity.billboard = billboard;\n  }\n\n  billboard.image = icon;\n  billboard.scale = scale;\n  billboard.color = color;\n\n  if (defined(x) || defined(y) || defined(w) || defined(h)) {\n    billboard.imageSubRegion = new BoundingRectangle(x, y, w, h);\n  }\n\n  //GE treats a heading of zero as no heading\n  //You can still point north using a 360 degree angle (or any multiple of 360)\n  if (defined(heading) && heading !== 0) {\n    billboard.rotation = CesiumMath.toRadians(-heading);\n    billboard.alignedAxis = Cartesian3.UNIT_Z;\n  }\n\n  //Hotpot is the KML equivalent of pixel offset\n  //The hotspot origin is the lower left, but we leave\n  //our billboard origin at the center and simply\n  //modify the pixel offset to take this into account\n  scale = defaultValue(scale, 1.0);\n\n  var xOffset;\n  var yOffset;\n  if (defined(hotSpotX)) {\n    if (hotSpotXUnit === \"pixels\") {\n      xOffset = -hotSpotX * scale;\n    } else if (hotSpotXUnit === \"insetPixels\") {\n      xOffset = (hotSpotX - BILLBOARD_SIZE) * scale;\n    } else if (hotSpotXUnit === \"fraction\") {\n      xOffset = -hotSpotX * BILLBOARD_SIZE * scale;\n    }\n    xOffset += BILLBOARD_SIZE * 0.5 * scale;\n  }\n\n  if (defined(hotSpotY)) {\n    if (hotSpotYUnit === \"pixels\") {\n      yOffset = hotSpotY * scale;\n    } else if (hotSpotYUnit === \"insetPixels\") {\n      yOffset = (-hotSpotY + BILLBOARD_SIZE) * scale;\n    } else if (hotSpotYUnit === \"fraction\") {\n      yOffset = hotSpotY * BILLBOARD_SIZE * scale;\n    }\n\n    yOffset -= BILLBOARD_SIZE * 0.5 * scale;\n  }\n\n  if (defined(xOffset) || defined(yOffset)) {\n    billboard.pixelOffset = new Cartesian2(xOffset, yOffset);\n  }\n}\n\nfunction applyStyle(\n  dataSource,\n  styleNode,\n  targetEntity,\n  sourceResource,\n  uriResolver\n) {\n  for (var i = 0, len = styleNode.childNodes.length; i < len; i++) {\n    var node = styleNode.childNodes.item(i);\n    if (node.localName === \"IconStyle\") {\n      processBillboardIcon(\n        dataSource,\n        node,\n        targetEntity,\n        sourceResource,\n        uriResolver\n      );\n    } else if (node.localName === \"LabelStyle\") {\n      var label = targetEntity.label;\n      if (!defined(label)) {\n        label = createDefaultLabel();\n        targetEntity.label = label;\n      }\n      label.scale = defaultValue(\n        queryNumericValue(node, \"scale\", namespaces.kml),\n        label.scale\n      );\n      label.fillColor = defaultValue(\n        queryColorValue(node, \"color\", namespaces.kml),\n        label.fillColor\n      );\n      label.text = targetEntity.name;\n    } else if (node.localName === \"LineStyle\") {\n      var polyline = targetEntity.polyline;\n      if (!defined(polyline)) {\n        polyline = new PolylineGraphics();\n        targetEntity.polyline = polyline;\n      }\n      polyline.width = queryNumericValue(node, \"width\", namespaces.kml);\n      polyline.material = queryColorValue(node, \"color\", namespaces.kml);\n      if (defined(queryColorValue(node, \"outerColor\", namespaces.gx))) {\n        oneTimeWarning(\n          \"kml-gx:outerColor\",\n          \"KML - gx:outerColor is not supported in a LineStyle\"\n        );\n      }\n      if (defined(queryNumericValue(node, \"outerWidth\", namespaces.gx))) {\n        oneTimeWarning(\n          \"kml-gx:outerWidth\",\n          \"KML - gx:outerWidth is not supported in a LineStyle\"\n        );\n      }\n      if (defined(queryNumericValue(node, \"physicalWidth\", namespaces.gx))) {\n        oneTimeWarning(\n          \"kml-gx:physicalWidth\",\n          \"KML - gx:physicalWidth is not supported in a LineStyle\"\n        );\n      }\n      if (defined(queryBooleanValue(node, \"labelVisibility\", namespaces.gx))) {\n        oneTimeWarning(\n          \"kml-gx:labelVisibility\",\n          \"KML - gx:labelVisibility is not supported in a LineStyle\"\n        );\n      }\n    } else if (node.localName === \"PolyStyle\") {\n      var polygon = targetEntity.polygon;\n      if (!defined(polygon)) {\n        polygon = createDefaultPolygon();\n        targetEntity.polygon = polygon;\n      }\n      polygon.material = defaultValue(\n        queryColorValue(node, \"color\", namespaces.kml),\n        polygon.material\n      );\n      polygon.fill = defaultValue(\n        queryBooleanValue(node, \"fill\", namespaces.kml),\n        polygon.fill\n      );\n      polygon.outline = defaultValue(\n        queryBooleanValue(node, \"outline\", namespaces.kml),\n        polygon.outline\n      );\n    } else if (node.localName === \"BalloonStyle\") {\n      var bgColor = defaultValue(\n        parseColorString(queryStringValue(node, \"bgColor\", namespaces.kml)),\n        Color.WHITE\n      );\n      var textColor = defaultValue(\n        parseColorString(queryStringValue(node, \"textColor\", namespaces.kml)),\n        Color.BLACK\n      );\n      var text = queryStringValue(node, \"text\", namespaces.kml);\n\n      //This is purely an internal property used in style processing,\n      //it never ends up on the final entity.\n      targetEntity.addProperty(\"balloonStyle\");\n      targetEntity.balloonStyle = {\n        bgColor: bgColor,\n        textColor: textColor,\n        text: text,\n      };\n    } else if (node.localName === \"ListStyle\") {\n      var listItemType = queryStringValue(node, \"listItemType\", namespaces.kml);\n      if (listItemType === \"radioFolder\" || listItemType === \"checkOffOnly\") {\n        oneTimeWarning(\n          \"kml-listStyle-\" + listItemType,\n          \"KML - Unsupported ListStyle with listItemType: \" + listItemType\n        );\n      }\n    }\n  }\n}\n\n//Processes and merges any inline styles for the provided node into the provided entity.\nfunction computeFinalStyle(\n  dataSource,\n  placeMark,\n  styleCollection,\n  sourceResource,\n  uriResolver\n) {\n  var result = new Entity();\n  var styleEntity;\n\n  //Google earth seems to always use the last inline Style/StyleMap only\n  var styleIndex = -1;\n  var childNodes = placeMark.childNodes;\n  var length = childNodes.length;\n  for (var q = 0; q < length; q++) {\n    var child = childNodes[q];\n    if (child.localName === \"Style\" || child.localName === \"StyleMap\") {\n      styleIndex = q;\n    }\n  }\n\n  if (styleIndex !== -1) {\n    var inlineStyleNode = childNodes[styleIndex];\n    if (inlineStyleNode.localName === \"Style\") {\n      applyStyle(\n        dataSource,\n        inlineStyleNode,\n        result,\n        sourceResource,\n        uriResolver\n      );\n    } else {\n      // StyleMap\n      var pairs = queryChildNodes(inlineStyleNode, \"Pair\", namespaces.kml);\n      for (var p = 0; p < pairs.length; p++) {\n        var pair = pairs[p];\n        var key = queryStringValue(pair, \"key\", namespaces.kml);\n        if (key === \"normal\") {\n          var styleUrl = queryStringValue(pair, \"styleUrl\", namespaces.kml);\n          if (defined(styleUrl)) {\n            styleEntity = styleCollection.getById(styleUrl);\n            if (!defined(styleEntity)) {\n              styleEntity = styleCollection.getById(\"#\" + styleUrl);\n            }\n            if (defined(styleEntity)) {\n              result.merge(styleEntity);\n            }\n          } else {\n            var node = queryFirstNode(pair, \"Style\", namespaces.kml);\n            applyStyle(dataSource, node, result, sourceResource, uriResolver);\n          }\n        } else {\n          oneTimeWarning(\n            \"kml-styleMap-\" + key,\n            \"KML - Unsupported StyleMap key: \" + key\n          );\n        }\n      }\n    }\n  }\n\n  //Google earth seems to always use the first external style only.\n  var externalStyle = queryStringValue(placeMark, \"styleUrl\", namespaces.kml);\n  if (defined(externalStyle)) {\n    var id = externalStyle;\n    if (externalStyle[0] !== \"#\" && externalStyle.indexOf(\"#\") !== -1) {\n      var tokens = externalStyle.split(\"#\");\n      var uri = tokens[0];\n      var resource = sourceResource.getDerivedResource({\n        url: uri,\n      });\n\n      id = resource.getUrlComponent() + \"#\" + tokens[1];\n    }\n\n    styleEntity = styleCollection.getById(id);\n    if (!defined(styleEntity)) {\n      styleEntity = styleCollection.getById(\"#\" + id);\n    }\n    if (defined(styleEntity)) {\n      result.merge(styleEntity);\n    }\n  }\n\n  return result;\n}\n\n//Asynchronously processes an external style file.\nfunction processExternalStyles(dataSource, resource, styleCollection) {\n  return resource.fetchXML().then(function (styleKml) {\n    return processStyles(dataSource, styleKml, styleCollection, resource, true);\n  });\n}\n\n//Processes all shared and external styles and stores\n//their id into the provided styleCollection.\n//Returns an array of promises that will resolve when\n//each style is loaded.\nfunction processStyles(\n  dataSource,\n  kml,\n  styleCollection,\n  sourceResource,\n  isExternal,\n  uriResolver\n) {\n  var i;\n  var id;\n  var styleEntity;\n\n  var node;\n  var styleNodes = queryNodes(kml, \"Style\", namespaces.kml);\n  if (defined(styleNodes)) {\n    var styleNodesLength = styleNodes.length;\n    for (i = 0; i < styleNodesLength; i++) {\n      node = styleNodes[i];\n      id = queryStringAttribute(node, \"id\");\n      if (defined(id)) {\n        id = \"#\" + id;\n        if (isExternal && defined(sourceResource)) {\n          id = sourceResource.getUrlComponent() + id;\n        }\n        if (!defined(styleCollection.getById(id))) {\n          styleEntity = new Entity({\n            id: id,\n          });\n          styleCollection.add(styleEntity);\n          applyStyle(\n            dataSource,\n            node,\n            styleEntity,\n            sourceResource,\n            uriResolver\n          );\n        }\n      }\n    }\n  }\n\n  var styleMaps = queryNodes(kml, \"StyleMap\", namespaces.kml);\n  if (defined(styleMaps)) {\n    var styleMapsLength = styleMaps.length;\n    for (i = 0; i < styleMapsLength; i++) {\n      var styleMap = styleMaps[i];\n      id = queryStringAttribute(styleMap, \"id\");\n      if (defined(id)) {\n        var pairs = queryChildNodes(styleMap, \"Pair\", namespaces.kml);\n        for (var p = 0; p < pairs.length; p++) {\n          var pair = pairs[p];\n          var key = queryStringValue(pair, \"key\", namespaces.kml);\n          if (key === \"normal\") {\n            id = \"#\" + id;\n            if (isExternal && defined(sourceResource)) {\n              id = sourceResource.getUrlComponent() + id;\n            }\n            if (!defined(styleCollection.getById(id))) {\n              styleEntity = styleCollection.getOrCreateEntity(id);\n\n              var styleUrl = queryStringValue(pair, \"styleUrl\", namespaces.kml);\n              if (defined(styleUrl)) {\n                if (styleUrl[0] !== \"#\") {\n                  styleUrl = \"#\" + styleUrl;\n                }\n\n                if (isExternal && defined(sourceResource)) {\n                  styleUrl = sourceResource.getUrlComponent() + styleUrl;\n                }\n                var base = styleCollection.getById(styleUrl);\n\n                if (defined(base)) {\n                  styleEntity.merge(base);\n                }\n              } else {\n                node = queryFirstNode(pair, \"Style\", namespaces.kml);\n                applyStyle(\n                  dataSource,\n                  node,\n                  styleEntity,\n                  sourceResource,\n                  uriResolver\n                );\n              }\n            }\n          } else {\n            oneTimeWarning(\n              \"kml-styleMap-\" + key,\n              \"KML - Unsupported StyleMap key: \" + key\n            );\n          }\n        }\n      }\n    }\n  }\n\n  var promises = [];\n  var styleUrlNodes = kml.getElementsByTagName(\"styleUrl\");\n  var styleUrlNodesLength = styleUrlNodes.length;\n  for (i = 0; i < styleUrlNodesLength; i++) {\n    var styleReference = styleUrlNodes[i].textContent;\n    if (styleReference[0] !== \"#\") {\n      //According to the spec, all local styles should start with a #\n      //and everything else is an external style that has a # seperating\n      //the URL of the document and the style.  However, Google Earth\n      //also accepts styleUrls without a # as meaning a local style.\n      var tokens = styleReference.split(\"#\");\n      if (tokens.length === 2) {\n        var uri = tokens[0];\n        var resource = sourceResource.getDerivedResource({\n          url: uri,\n        });\n\n        promises.push(\n          processExternalStyles(dataSource, resource, styleCollection)\n        );\n      }\n    }\n  }\n\n  return promises;\n}\n\nfunction createDropLine(entityCollection, entity, styleEntity) {\n  var entityPosition = new ReferenceProperty(entityCollection, entity.id, [\n    \"position\",\n  ]);\n  var surfacePosition = new ScaledPositionProperty(entity.position);\n  entity.polyline = defined(styleEntity.polyline)\n    ? styleEntity.polyline.clone()\n    : new PolylineGraphics();\n  entity.polyline.positions = new PositionPropertyArray([\n    entityPosition,\n    surfacePosition,\n  ]);\n}\n\nfunction heightReferenceFromAltitudeMode(altitudeMode, gxAltitudeMode) {\n  if (\n    (!defined(altitudeMode) && !defined(gxAltitudeMode)) ||\n    altitudeMode === \"clampToGround\"\n  ) {\n    return HeightReference.CLAMP_TO_GROUND;\n  }\n\n  if (altitudeMode === \"relativeToGround\") {\n    return HeightReference.RELATIVE_TO_GROUND;\n  }\n\n  if (altitudeMode === \"absolute\") {\n    return HeightReference.NONE;\n  }\n\n  if (gxAltitudeMode === \"clampToSeaFloor\") {\n    oneTimeWarning(\n      \"kml-gx:altitudeMode-clampToSeaFloor\",\n      \"KML - <gx:altitudeMode>:clampToSeaFloor is currently not supported, using <kml:altitudeMode>:clampToGround.\"\n    );\n    return HeightReference.CLAMP_TO_GROUND;\n  }\n\n  if (gxAltitudeMode === \"relativeToSeaFloor\") {\n    oneTimeWarning(\n      \"kml-gx:altitudeMode-relativeToSeaFloor\",\n      \"KML - <gx:altitudeMode>:relativeToSeaFloor is currently not supported, using <kml:altitudeMode>:relativeToGround.\"\n    );\n    return HeightReference.RELATIVE_TO_GROUND;\n  }\n\n  if (defined(altitudeMode)) {\n    oneTimeWarning(\n      \"kml-altitudeMode-unknown\",\n      \"KML - Unknown <kml:altitudeMode>:\" +\n        altitudeMode +\n        \", using <kml:altitudeMode>:CLAMP_TO_GROUND.\"\n    );\n  } else {\n    oneTimeWarning(\n      \"kml-gx:altitudeMode-unknown\",\n      \"KML - Unknown <gx:altitudeMode>:\" +\n        gxAltitudeMode +\n        \", using <kml:altitudeMode>:CLAMP_TO_GROUND.\"\n    );\n  }\n\n  // Clamp to ground is the default\n  return HeightReference.CLAMP_TO_GROUND;\n}\n\nfunction createPositionPropertyFromAltitudeMode(\n  property,\n  altitudeMode,\n  gxAltitudeMode\n) {\n  if (\n    gxAltitudeMode === \"relativeToSeaFloor\" ||\n    altitudeMode === \"absolute\" ||\n    altitudeMode === \"relativeToGround\"\n  ) {\n    //Just return the ellipsoid referenced property until we support MSL\n    return property;\n  }\n\n  if (\n    (defined(altitudeMode) && altitudeMode !== \"clampToGround\") || //\n    (defined(gxAltitudeMode) && gxAltitudeMode !== \"clampToSeaFloor\")\n  ) {\n    oneTimeWarning(\n      \"kml-altitudeMode-unknown\",\n      \"KML - Unknown altitudeMode: \" +\n        defaultValue(altitudeMode, gxAltitudeMode)\n    );\n  }\n\n  // Clamp to ground is the default\n  return new ScaledPositionProperty(property);\n}\n\nfunction createPositionPropertyArrayFromAltitudeMode(\n  properties,\n  altitudeMode,\n  gxAltitudeMode,\n  ellipsoid\n) {\n  if (!defined(properties)) {\n    return undefined;\n  }\n\n  if (\n    gxAltitudeMode === \"relativeToSeaFloor\" ||\n    altitudeMode === \"absolute\" ||\n    altitudeMode === \"relativeToGround\"\n  ) {\n    //Just return the ellipsoid referenced property until we support MSL\n    return properties;\n  }\n\n  if (\n    (defined(altitudeMode) && altitudeMode !== \"clampToGround\") || //\n    (defined(gxAltitudeMode) && gxAltitudeMode !== \"clampToSeaFloor\")\n  ) {\n    oneTimeWarning(\n      \"kml-altitudeMode-unknown\",\n      \"KML - Unknown altitudeMode: \" +\n        defaultValue(altitudeMode, gxAltitudeMode)\n    );\n  }\n\n  // Clamp to ground is the default\n  var propertiesLength = properties.length;\n  for (var i = 0; i < propertiesLength; i++) {\n    var property = properties[i];\n    ellipsoid.scaleToGeodeticSurface(property, property);\n  }\n  return properties;\n}\n\nfunction processPositionGraphics(\n  dataSource,\n  entity,\n  styleEntity,\n  heightReference\n) {\n  var label = entity.label;\n  if (!defined(label)) {\n    label = defined(styleEntity.label)\n      ? styleEntity.label.clone()\n      : createDefaultLabel();\n    entity.label = label;\n  }\n  label.text = entity.name;\n\n  var billboard = entity.billboard;\n  if (!defined(billboard)) {\n    billboard = defined(styleEntity.billboard)\n      ? styleEntity.billboard.clone()\n      : createDefaultBillboard();\n    entity.billboard = billboard;\n  }\n\n  if (!defined(billboard.image)) {\n    billboard.image = dataSource._pinBuilder.fromColor(Color.YELLOW, 64);\n\n    // If there were empty <Icon> tags in the KML, then billboard.image was set to false above\n    // However, in this case, the false value would have been converted to a property afterwards\n    // Thus, we check if billboard.image is defined with value of false\n  } else if (!billboard.image.getValue()) {\n    billboard.image = undefined;\n  }\n\n  var scale = 1.0;\n  if (defined(billboard.scale)) {\n    scale = billboard.scale.getValue();\n    if (scale !== 0) {\n      label.pixelOffset = new Cartesian2(scale * 16 + 1, 0);\n    } else {\n      //Minor tweaks to better match Google Earth.\n      label.pixelOffset = undefined;\n      label.horizontalOrigin = undefined;\n    }\n  }\n\n  if (defined(heightReference) && dataSource._clampToGround) {\n    billboard.heightReference = heightReference;\n    label.heightReference = heightReference;\n  }\n}\n\nfunction processPathGraphics(entity, styleEntity) {\n  var path = entity.path;\n  if (!defined(path)) {\n    path = new PathGraphics();\n    path.leadTime = 0;\n    entity.path = path;\n  }\n\n  var polyline = styleEntity.polyline;\n  if (defined(polyline)) {\n    path.material = polyline.material;\n    path.width = polyline.width;\n  }\n}\n\nfunction processPoint(\n  dataSource,\n  entityCollection,\n  geometryNode,\n  entity,\n  styleEntity\n) {\n  var coordinatesString = queryStringValue(\n    geometryNode,\n    \"coordinates\",\n    namespaces.kml\n  );\n  var altitudeMode = queryStringValue(\n    geometryNode,\n    \"altitudeMode\",\n    namespaces.kml\n  );\n  var gxAltitudeMode = queryStringValue(\n    geometryNode,\n    \"altitudeMode\",\n    namespaces.gx\n  );\n  var extrude = queryBooleanValue(geometryNode, \"extrude\", namespaces.kml);\n  var ellipsoid = dataSource._ellipsoid;\n  var position = readCoordinate(coordinatesString, ellipsoid);\n\n  entity.position = position;\n  processPositionGraphics(\n    dataSource,\n    entity,\n    styleEntity,\n    heightReferenceFromAltitudeMode(altitudeMode, gxAltitudeMode)\n  );\n\n  if (extrude && isExtrudable(altitudeMode, gxAltitudeMode)) {\n    createDropLine(entityCollection, entity, styleEntity);\n  }\n\n  return true;\n}\n\nfunction processLineStringOrLinearRing(\n  dataSource,\n  entityCollection,\n  geometryNode,\n  entity,\n  styleEntity\n) {\n  var coordinatesNode = queryFirstNode(\n    geometryNode,\n    \"coordinates\",\n    namespaces.kml\n  );\n  var altitudeMode = queryStringValue(\n    geometryNode,\n    \"altitudeMode\",\n    namespaces.kml\n  );\n  var gxAltitudeMode = queryStringValue(\n    geometryNode,\n    \"altitudeMode\",\n    namespaces.gx\n  );\n  var extrude = queryBooleanValue(geometryNode, \"extrude\", namespaces.kml);\n  var tessellate = queryBooleanValue(\n    geometryNode,\n    \"tessellate\",\n    namespaces.kml\n  );\n  var canExtrude = isExtrudable(altitudeMode, gxAltitudeMode);\n  var zIndex = queryNumericValue(geometryNode, \"drawOrder\", namespaces.gx);\n\n  var ellipsoid = dataSource._ellipsoid;\n  var coordinates = readCoordinates(coordinatesNode, ellipsoid);\n  var polyline = styleEntity.polyline;\n  if (canExtrude && extrude) {\n    var wall = new WallGraphics();\n    entity.wall = wall;\n    wall.positions = coordinates;\n    var polygon = styleEntity.polygon;\n\n    if (defined(polygon)) {\n      wall.fill = polygon.fill;\n      wall.material = polygon.material;\n    }\n\n    //Always outline walls so they show up in 2D.\n    wall.outline = true;\n    if (defined(polyline)) {\n      wall.outlineColor = defined(polyline.material)\n        ? polyline.material.color\n        : Color.WHITE;\n      wall.outlineWidth = polyline.width;\n    } else if (defined(polygon)) {\n      wall.outlineColor = defined(polygon.material)\n        ? polygon.material.color\n        : Color.WHITE;\n    }\n  } else if (dataSource._clampToGround && !canExtrude && tessellate) {\n    var polylineGraphics = new PolylineGraphics();\n    polylineGraphics.clampToGround = true;\n    entity.polyline = polylineGraphics;\n    polylineGraphics.positions = coordinates;\n    if (defined(polyline)) {\n      polylineGraphics.material = defined(polyline.material)\n        ? polyline.material.color.getValue(Iso8601.MINIMUM_VALUE)\n        : Color.WHITE;\n      polylineGraphics.width = defaultValue(polyline.width, 1.0);\n    } else {\n      polylineGraphics.material = Color.WHITE;\n      polylineGraphics.width = 1.0;\n    }\n    polylineGraphics.zIndex = zIndex;\n  } else {\n    if (defined(zIndex)) {\n      oneTimeWarning(\n        \"kml-gx:drawOrder\",\n        \"KML - gx:drawOrder is not supported in LineStrings when clampToGround is false\"\n      );\n    }\n    if (dataSource._clampToGround && !tessellate) {\n      oneTimeWarning(\n        \"kml-line-tesselate\",\n        \"Ignoring clampToGround for KML lines without the tessellate flag.\"\n      );\n    }\n\n    polyline = defined(polyline) ? polyline.clone() : new PolylineGraphics();\n    entity.polyline = polyline;\n    polyline.positions = createPositionPropertyArrayFromAltitudeMode(\n      coordinates,\n      altitudeMode,\n      gxAltitudeMode,\n      ellipsoid\n    );\n    if (!tessellate || canExtrude) {\n      polyline.arcType = ArcType.NONE;\n    }\n  }\n\n  return true;\n}\n\nfunction processPolygon(\n  dataSource,\n  entityCollection,\n  geometryNode,\n  entity,\n  styleEntity\n) {\n  var outerBoundaryIsNode = queryFirstNode(\n    geometryNode,\n    \"outerBoundaryIs\",\n    namespaces.kml\n  );\n  var linearRingNode = queryFirstNode(\n    outerBoundaryIsNode,\n    \"LinearRing\",\n    namespaces.kml\n  );\n  var coordinatesNode = queryFirstNode(\n    linearRingNode,\n    \"coordinates\",\n    namespaces.kml\n  );\n  var ellipsoid = dataSource._ellipsoid;\n  var coordinates = readCoordinates(coordinatesNode, ellipsoid);\n  var extrude = queryBooleanValue(geometryNode, \"extrude\", namespaces.kml);\n  var altitudeMode = queryStringValue(\n    geometryNode,\n    \"altitudeMode\",\n    namespaces.kml\n  );\n  var gxAltitudeMode = queryStringValue(\n    geometryNode,\n    \"altitudeMode\",\n    namespaces.gx\n  );\n  var canExtrude = isExtrudable(altitudeMode, gxAltitudeMode);\n\n  var polygon = defined(styleEntity.polygon)\n    ? styleEntity.polygon.clone()\n    : createDefaultPolygon();\n\n  var polyline = styleEntity.polyline;\n  if (defined(polyline)) {\n    polygon.outlineColor = defined(polyline.material)\n      ? polyline.material.color\n      : Color.WHITE;\n    polygon.outlineWidth = polyline.width;\n  }\n  entity.polygon = polygon;\n\n  if (canExtrude) {\n    polygon.perPositionHeight = true;\n    polygon.extrudedHeight = extrude ? 0 : undefined;\n  } else if (!dataSource._clampToGround) {\n    polygon.height = 0;\n  }\n\n  if (defined(coordinates)) {\n    var hierarchy = new PolygonHierarchy(coordinates);\n    var innerBoundaryIsNodes = queryChildNodes(\n      geometryNode,\n      \"innerBoundaryIs\",\n      namespaces.kml\n    );\n    for (var j = 0; j < innerBoundaryIsNodes.length; j++) {\n      linearRingNode = queryChildNodes(\n        innerBoundaryIsNodes[j],\n        \"LinearRing\",\n        namespaces.kml\n      );\n      for (var k = 0; k < linearRingNode.length; k++) {\n        coordinatesNode = queryFirstNode(\n          linearRingNode[k],\n          \"coordinates\",\n          namespaces.kml\n        );\n        coordinates = readCoordinates(coordinatesNode, ellipsoid);\n        if (defined(coordinates)) {\n          hierarchy.holes.push(new PolygonHierarchy(coordinates));\n        }\n      }\n    }\n    polygon.hierarchy = hierarchy;\n  }\n\n  return true;\n}\n\nfunction processTrack(\n  dataSource,\n  entityCollection,\n  geometryNode,\n  entity,\n  styleEntity\n) {\n  var altitudeMode = queryStringValue(\n    geometryNode,\n    \"altitudeMode\",\n    namespaces.kml\n  );\n  var gxAltitudeMode = queryStringValue(\n    geometryNode,\n    \"altitudeMode\",\n    namespaces.gx\n  );\n  var coordNodes = queryChildNodes(geometryNode, \"coord\", namespaces.gx);\n  var angleNodes = queryChildNodes(geometryNode, \"angles\", namespaces.gx);\n  var timeNodes = queryChildNodes(geometryNode, \"when\", namespaces.kml);\n  var extrude = queryBooleanValue(geometryNode, \"extrude\", namespaces.kml);\n  var canExtrude = isExtrudable(altitudeMode, gxAltitudeMode);\n  var ellipsoid = dataSource._ellipsoid;\n\n  if (angleNodes.length > 0) {\n    oneTimeWarning(\n      \"kml-gx:angles\",\n      \"KML - gx:angles are not supported in gx:Tracks\"\n    );\n  }\n\n  var length = Math.min(coordNodes.length, timeNodes.length);\n  var coordinates = [];\n  var times = [];\n  for (var i = 0; i < length; i++) {\n    var position = readCoordinate(coordNodes[i].textContent, ellipsoid);\n    coordinates.push(position);\n    times.push(JulianDate.fromIso8601(timeNodes[i].textContent));\n  }\n  var property = new SampledPositionProperty();\n  property.addSamples(times, coordinates);\n  entity.position = property;\n  processPositionGraphics(\n    dataSource,\n    entity,\n    styleEntity,\n    heightReferenceFromAltitudeMode(altitudeMode, gxAltitudeMode)\n  );\n  processPathGraphics(entity, styleEntity);\n\n  entity.availability = new TimeIntervalCollection();\n\n  if (timeNodes.length > 0) {\n    entity.availability.addInterval(\n      new TimeInterval({\n        start: times[0],\n        stop: times[times.length - 1],\n      })\n    );\n  }\n\n  if (canExtrude && extrude) {\n    createDropLine(entityCollection, entity, styleEntity);\n  }\n\n  return true;\n}\n\nfunction addToMultiTrack(\n  times,\n  positions,\n  composite,\n  availability,\n  dropShowProperty,\n  extrude,\n  altitudeMode,\n  gxAltitudeMode,\n  includeEndPoints\n) {\n  var start = times[0];\n  var stop = times[times.length - 1];\n\n  var data = new SampledPositionProperty();\n  data.addSamples(times, positions);\n\n  composite.intervals.addInterval(\n    new TimeInterval({\n      start: start,\n      stop: stop,\n      isStartIncluded: includeEndPoints,\n      isStopIncluded: includeEndPoints,\n      data: createPositionPropertyFromAltitudeMode(\n        data,\n        altitudeMode,\n        gxAltitudeMode\n      ),\n    })\n  );\n  availability.addInterval(\n    new TimeInterval({\n      start: start,\n      stop: stop,\n      isStartIncluded: includeEndPoints,\n      isStopIncluded: includeEndPoints,\n    })\n  );\n  dropShowProperty.intervals.addInterval(\n    new TimeInterval({\n      start: start,\n      stop: stop,\n      isStartIncluded: includeEndPoints,\n      isStopIncluded: includeEndPoints,\n      data: extrude,\n    })\n  );\n}\n\nfunction processMultiTrack(\n  dataSource,\n  entityCollection,\n  geometryNode,\n  entity,\n  styleEntity\n) {\n  // Multitrack options do not work in GE as detailed in the spec,\n  // rather than altitudeMode being at the MultiTrack level,\n  // GE just defers all settings to the underlying track.\n\n  var interpolate = queryBooleanValue(\n    geometryNode,\n    \"interpolate\",\n    namespaces.gx\n  );\n  var trackNodes = queryChildNodes(geometryNode, \"Track\", namespaces.gx);\n\n  var times;\n  var lastStop;\n  var lastStopPosition;\n  var needDropLine = false;\n  var dropShowProperty = new TimeIntervalCollectionProperty();\n  var availability = new TimeIntervalCollection();\n  var composite = new CompositePositionProperty();\n  var ellipsoid = dataSource._ellipsoid;\n  for (var i = 0, len = trackNodes.length; i < len; i++) {\n    var trackNode = trackNodes[i];\n    var timeNodes = queryChildNodes(trackNode, \"when\", namespaces.kml);\n    var coordNodes = queryChildNodes(trackNode, \"coord\", namespaces.gx);\n    var altitudeMode = queryStringValue(\n      trackNode,\n      \"altitudeMode\",\n      namespaces.kml\n    );\n    var gxAltitudeMode = queryStringValue(\n      trackNode,\n      \"altitudeMode\",\n      namespaces.gx\n    );\n    var canExtrude = isExtrudable(altitudeMode, gxAltitudeMode);\n    var extrude = queryBooleanValue(trackNode, \"extrude\", namespaces.kml);\n\n    var length = Math.min(coordNodes.length, timeNodes.length);\n\n    var positions = [];\n    times = [];\n    for (var x = 0; x < length; x++) {\n      var position = readCoordinate(coordNodes[x].textContent, ellipsoid);\n      positions.push(position);\n      times.push(JulianDate.fromIso8601(timeNodes[x].textContent));\n    }\n\n    if (interpolate) {\n      //If we are interpolating, then we need to fill in the end of\n      //the last track and the beginning of this one with a sampled\n      //property.  From testing in Google Earth, this property\n      //is never extruded and always absolute.\n      if (defined(lastStop)) {\n        addToMultiTrack(\n          [lastStop, times[0]],\n          [lastStopPosition, positions[0]],\n          composite,\n          availability,\n          dropShowProperty,\n          false,\n          \"absolute\",\n          undefined,\n          false\n        );\n      }\n      lastStop = times[length - 1];\n      lastStopPosition = positions[positions.length - 1];\n    }\n\n    addToMultiTrack(\n      times,\n      positions,\n      composite,\n      availability,\n      dropShowProperty,\n      canExtrude && extrude,\n      altitudeMode,\n      gxAltitudeMode,\n      true\n    );\n    needDropLine = needDropLine || (canExtrude && extrude);\n  }\n\n  entity.availability = availability;\n  entity.position = composite;\n  processPositionGraphics(dataSource, entity, styleEntity);\n  processPathGraphics(entity, styleEntity);\n  if (needDropLine) {\n    createDropLine(entityCollection, entity, styleEntity);\n    entity.polyline.show = dropShowProperty;\n  }\n\n  return true;\n}\n\nvar geometryTypes = {\n  Point: processPoint,\n  LineString: processLineStringOrLinearRing,\n  LinearRing: processLineStringOrLinearRing,\n  Polygon: processPolygon,\n  Track: processTrack,\n  MultiTrack: processMultiTrack,\n  MultiGeometry: processMultiGeometry,\n  Model: processUnsupportedGeometry,\n};\n\nfunction processMultiGeometry(\n  dataSource,\n  entityCollection,\n  geometryNode,\n  entity,\n  styleEntity,\n  context\n) {\n  var childNodes = geometryNode.childNodes;\n  var hasGeometry = false;\n  for (var i = 0, len = childNodes.length; i < len; i++) {\n    var childNode = childNodes.item(i);\n    var geometryProcessor = geometryTypes[childNode.localName];\n    if (defined(geometryProcessor)) {\n      var childEntity = createEntity(childNode, entityCollection, context);\n      childEntity.parent = entity;\n      childEntity.name = entity.name;\n      childEntity.availability = entity.availability;\n      childEntity.description = entity.description;\n      childEntity.kml = entity.kml;\n      if (\n        geometryProcessor(\n          dataSource,\n          entityCollection,\n          childNode,\n          childEntity,\n          styleEntity\n        )\n      ) {\n        hasGeometry = true;\n      }\n    }\n  }\n\n  return hasGeometry;\n}\n\nfunction processUnsupportedGeometry(\n  dataSource,\n  entityCollection,\n  geometryNode,\n  entity,\n  styleEntity\n) {\n  oneTimeWarning(\n    \"kml-unsupportedGeometry\",\n    \"KML - Unsupported geometry: \" + geometryNode.localName\n  );\n  return false;\n}\n\nfunction processExtendedData(node, entity) {\n  var extendedDataNode = queryFirstNode(node, \"ExtendedData\", namespaces.kml);\n\n  if (!defined(extendedDataNode)) {\n    return undefined;\n  }\n\n  if (defined(queryFirstNode(extendedDataNode, \"SchemaData\", namespaces.kml))) {\n    oneTimeWarning(\"kml-schemaData\", \"KML - SchemaData is unsupported\");\n  }\n  if (defined(queryStringAttribute(extendedDataNode, \"xmlns:prefix\"))) {\n    oneTimeWarning(\n      \"kml-extendedData\",\n      \"KML - ExtendedData with xmlns:prefix is unsupported\"\n    );\n  }\n\n  var result = {};\n  var dataNodes = queryChildNodes(extendedDataNode, \"Data\", namespaces.kml);\n  if (defined(dataNodes)) {\n    var length = dataNodes.length;\n    for (var i = 0; i < length; i++) {\n      var dataNode = dataNodes[i];\n      var name = queryStringAttribute(dataNode, \"name\");\n      if (defined(name)) {\n        result[name] = {\n          displayName: queryStringValue(\n            dataNode,\n            \"displayName\",\n            namespaces.kml\n          ),\n          value: queryStringValue(dataNode, \"value\", namespaces.kml),\n        };\n      }\n    }\n  }\n  entity.kml.extendedData = result;\n}\n\nvar scratchDiv;\nif (typeof document !== \"undefined\") {\n  scratchDiv = document.createElement(\"div\");\n}\n\nfunction processDescription(\n  node,\n  entity,\n  styleEntity,\n  uriResolver,\n  sourceResource\n) {\n  var i;\n  var key;\n  var keys;\n\n  var kmlData = entity.kml;\n  var extendedData = kmlData.extendedData;\n  var description = queryStringValue(node, \"description\", namespaces.kml);\n\n  var balloonStyle = defaultValue(\n    entity.balloonStyle,\n    styleEntity.balloonStyle\n  );\n\n  var background = Color.WHITE;\n  var foreground = Color.BLACK;\n  var text = description;\n\n  if (defined(balloonStyle)) {\n    background = defaultValue(balloonStyle.bgColor, Color.WHITE);\n    foreground = defaultValue(balloonStyle.textColor, Color.BLACK);\n    text = defaultValue(balloonStyle.text, description);\n  }\n\n  var value;\n  if (defined(text)) {\n    text = text.replace(\"$[name]\", defaultValue(entity.name, \"\"));\n    text = text.replace(\"$[description]\", defaultValue(description, \"\"));\n    text = text.replace(\"$[address]\", defaultValue(kmlData.address, \"\"));\n    text = text.replace(\"$[Snippet]\", defaultValue(kmlData.snippet, \"\"));\n    text = text.replace(\"$[id]\", entity.id);\n\n    //While not explicitly defined by the OGC spec, in Google Earth\n    //The appearance of geDirections adds the directions to/from links\n    //We simply replace this string with nothing.\n    text = text.replace(\"$[geDirections]\", \"\");\n\n    if (defined(extendedData)) {\n      var matches = text.match(/\\$\\[.+?\\]/g);\n      if (matches !== null) {\n        for (i = 0; i < matches.length; i++) {\n          var token = matches[i];\n          var propertyName = token.substr(2, token.length - 3);\n          var isDisplayName = /\\/displayName$/.test(propertyName);\n          propertyName = propertyName.replace(/\\/displayName$/, \"\");\n\n          value = extendedData[propertyName];\n          if (defined(value)) {\n            value = isDisplayName ? value.displayName : value.value;\n          }\n          if (defined(value)) {\n            text = text.replace(token, defaultValue(value, \"\"));\n          }\n        }\n      }\n    }\n  } else if (defined(extendedData)) {\n    //If no description exists, build a table out of the extended data\n    keys = Object.keys(extendedData);\n    if (keys.length > 0) {\n      text =\n        '<table class=\"cesium-infoBox-defaultTable cesium-infoBox-defaultTable-lighter\"><tbody>';\n      for (i = 0; i < keys.length; i++) {\n        key = keys[i];\n        value = extendedData[key];\n        text +=\n          \"<tr><th>\" +\n          defaultValue(value.displayName, key) +\n          \"</th><td>\" +\n          defaultValue(value.value, \"\") +\n          \"</td></tr>\";\n      }\n      text += \"</tbody></table>\";\n    }\n  }\n\n  if (!defined(text)) {\n    //No description\n    return;\n  }\n\n  //Turns non-explicit links into clickable links.\n  text = autolinker.link(text);\n\n  //Use a temporary div to manipulate the links\n  //so that they open in a new window.\n  scratchDiv.innerHTML = text;\n  var links = scratchDiv.querySelectorAll(\"a\");\n  for (i = 0; i < links.length; i++) {\n    links[i].setAttribute(\"target\", \"_blank\");\n  }\n\n  //Rewrite any KMZ embedded urls\n  if (defined(uriResolver) && uriResolver.keys.length > 1) {\n    embedDataUris(scratchDiv, \"a\", \"href\", uriResolver);\n    embedDataUris(scratchDiv, \"img\", \"src\", uriResolver);\n  }\n\n  //Make relative urls absolute using the sourceResource\n  applyBasePath(scratchDiv, \"a\", \"href\", sourceResource);\n  applyBasePath(scratchDiv, \"img\", \"src\", sourceResource);\n\n  var tmp = '<div class=\"cesium-infoBox-description-lighter\" style=\"';\n  tmp += \"overflow:auto;\";\n  tmp += \"word-wrap:break-word;\";\n  tmp += \"background-color:\" + background.toCssColorString() + \";\";\n  tmp += \"color:\" + foreground.toCssColorString() + \";\";\n  tmp += '\">';\n  tmp += scratchDiv.innerHTML + \"</div>\";\n  scratchDiv.innerHTML = \"\";\n\n  //Set the final HTML as the description.\n  entity.description = tmp;\n}\n\nfunction processFeature(dataSource, featureNode, processingData) {\n  var entityCollection = processingData.entityCollection;\n  var parent = processingData.parentEntity;\n  var sourceResource = processingData.sourceResource;\n  var uriResolver = processingData.uriResolver;\n\n  var entity = createEntity(\n    featureNode,\n    entityCollection,\n    processingData.context\n  );\n  var kmlData = entity.kml;\n  var styleEntity = computeFinalStyle(\n    dataSource,\n    featureNode,\n    processingData.styleCollection,\n    sourceResource,\n    uriResolver\n  );\n\n  var name = queryStringValue(featureNode, \"name\", namespaces.kml);\n  entity.name = name;\n  entity.parent = parent;\n\n  var availability = processTimeSpan(featureNode);\n  if (!defined(availability)) {\n    availability = processTimeStamp(featureNode);\n  }\n  entity.availability = availability;\n\n  mergeAvailabilityWithParent(entity);\n\n  // Per KML spec \"A Feature is visible only if it and all its ancestors are visible.\"\n  function ancestryIsVisible(parentEntity) {\n    if (!parentEntity) {\n      return true;\n    }\n    return parentEntity.show && ancestryIsVisible(parentEntity.parent);\n  }\n\n  var visibility = queryBooleanValue(featureNode, \"visibility\", namespaces.kml);\n  entity.show = ancestryIsVisible(parent) && defaultValue(visibility, true);\n  //var open = queryBooleanValue(featureNode, 'open', namespaces.kml);\n\n  var authorNode = queryFirstNode(featureNode, \"author\", namespaces.atom);\n  var author = kmlData.author;\n  author.name = queryStringValue(authorNode, \"name\", namespaces.atom);\n  author.uri = queryStringValue(authorNode, \"uri\", namespaces.atom);\n  author.email = queryStringValue(authorNode, \"email\", namespaces.atom);\n\n  var linkNode = queryFirstNode(featureNode, \"link\", namespaces.atom);\n  var link = kmlData.link;\n  link.href = queryStringAttribute(linkNode, \"href\");\n  link.hreflang = queryStringAttribute(linkNode, \"hreflang\");\n  link.rel = queryStringAttribute(linkNode, \"rel\");\n  link.type = queryStringAttribute(linkNode, \"type\");\n  link.title = queryStringAttribute(linkNode, \"title\");\n  link.length = queryStringAttribute(linkNode, \"length\");\n\n  kmlData.address = queryStringValue(featureNode, \"address\", namespaces.kml);\n  kmlData.phoneNumber = queryStringValue(\n    featureNode,\n    \"phoneNumber\",\n    namespaces.kml\n  );\n  kmlData.snippet = queryStringValue(featureNode, \"Snippet\", namespaces.kml);\n\n  processExtendedData(featureNode, entity);\n  processDescription(\n    featureNode,\n    entity,\n    styleEntity,\n    uriResolver,\n    sourceResource\n  );\n\n  var ellipsoid = dataSource._ellipsoid;\n  processLookAt(featureNode, entity, ellipsoid);\n  processCamera(featureNode, entity, ellipsoid);\n\n  if (defined(queryFirstNode(featureNode, \"Region\", namespaces.kml))) {\n    oneTimeWarning(\"kml-region\", \"KML - Placemark Regions are unsupported\");\n  }\n\n  return {\n    entity: entity,\n    styleEntity: styleEntity,\n  };\n}\n\nfunction processDocument(dataSource, node, processingData, deferredLoading) {\n  deferredLoading.addNodes(node.childNodes, processingData);\n  deferredLoading.process();\n}\n\nfunction processFolder(dataSource, node, processingData, deferredLoading) {\n  var r = processFeature(dataSource, node, processingData);\n  var newProcessingData = clone(processingData);\n  newProcessingData.parentEntity = r.entity;\n  processDocument(dataSource, node, newProcessingData, deferredLoading);\n}\n\nfunction processPlacemark(\n  dataSource,\n  placemark,\n  processingData,\n  deferredLoading\n) {\n  var r = processFeature(dataSource, placemark, processingData);\n  var entity = r.entity;\n  var styleEntity = r.styleEntity;\n\n  var hasGeometry = false;\n  var childNodes = placemark.childNodes;\n  for (var i = 0, len = childNodes.length; i < len && !hasGeometry; i++) {\n    var childNode = childNodes.item(i);\n    var geometryProcessor = geometryTypes[childNode.localName];\n    if (defined(geometryProcessor)) {\n      // pass the placemark entity id as a context for case of defining multiple child entities together to handle case\n      // where some malformed kmls reuse the same id across placemarks, which works in GE, but is not technically to spec.\n      geometryProcessor(\n        dataSource,\n        processingData.entityCollection,\n        childNode,\n        entity,\n        styleEntity,\n        entity.id\n      );\n      hasGeometry = true;\n    }\n  }\n\n  if (!hasGeometry) {\n    entity.merge(styleEntity);\n    processPositionGraphics(dataSource, entity, styleEntity);\n  }\n}\n\nvar playlistNodeProcessors = {\n  FlyTo: processTourFlyTo,\n  Wait: processTourWait,\n  SoundCue: processTourUnsupportedNode,\n  AnimatedUpdate: processTourUnsupportedNode,\n  TourControl: processTourUnsupportedNode,\n};\n\nfunction processTour(dataSource, node, processingData, deferredLoading) {\n  var name = queryStringValue(node, \"name\", namespaces.kml);\n  var id = queryStringAttribute(node, \"id\");\n  var tour = new KmlTour(name, id);\n\n  var playlistNode = queryFirstNode(node, \"Playlist\", namespaces.gx);\n  if (playlistNode) {\n    var ellipsoid = dataSource._ellipsoid;\n    var childNodes = playlistNode.childNodes;\n    for (var i = 0; i < childNodes.length; i++) {\n      var entryNode = childNodes[i];\n      if (entryNode.localName) {\n        var playlistNodeProcessor = playlistNodeProcessors[entryNode.localName];\n        if (playlistNodeProcessor) {\n          playlistNodeProcessor(tour, entryNode, ellipsoid);\n        } else {\n          console.log(\n            \"Unknown KML Tour playlist entry type \" + entryNode.localName\n          );\n        }\n      }\n    }\n  }\n\n  if (!defined(dataSource.kmlTours)) {\n    dataSource.kmlTours = [];\n  }\n\n  dataSource.kmlTours.push(tour);\n}\n\nfunction processTourUnsupportedNode(tour, entryNode) {\n  oneTimeWarning(\"KML Tour unsupported node \" + entryNode.localName);\n}\n\nfunction processTourWait(tour, entryNode) {\n  var duration = queryNumericValue(entryNode, \"duration\", namespaces.gx);\n  tour.addPlaylistEntry(new KmlTourWait(duration));\n}\n\nfunction processTourFlyTo(tour, entryNode, ellipsoid) {\n  var duration = queryNumericValue(entryNode, \"duration\", namespaces.gx);\n  var flyToMode = queryStringValue(entryNode, \"flyToMode\", namespaces.gx);\n\n  var t = { kml: {} };\n\n  processLookAt(entryNode, t, ellipsoid);\n  processCamera(entryNode, t, ellipsoid);\n\n  var view = t.kml.lookAt || t.kml.camera;\n\n  var flyto = new KmlTourFlyTo(duration, flyToMode, view);\n  tour.addPlaylistEntry(flyto);\n}\n\nfunction processCamera(featureNode, entity, ellipsoid) {\n  var camera = queryFirstNode(featureNode, \"Camera\", namespaces.kml);\n  if (defined(camera)) {\n    var lon = defaultValue(\n      queryNumericValue(camera, \"longitude\", namespaces.kml),\n      0.0\n    );\n    var lat = defaultValue(\n      queryNumericValue(camera, \"latitude\", namespaces.kml),\n      0.0\n    );\n    var altitude = defaultValue(\n      queryNumericValue(camera, \"altitude\", namespaces.kml),\n      0.0\n    );\n\n    var heading = defaultValue(\n      queryNumericValue(camera, \"heading\", namespaces.kml),\n      0.0\n    );\n    var tilt = defaultValue(\n      queryNumericValue(camera, \"tilt\", namespaces.kml),\n      0.0\n    );\n    var roll = defaultValue(\n      queryNumericValue(camera, \"roll\", namespaces.kml),\n      0.0\n    );\n\n    var position = Cartesian3.fromDegrees(lon, lat, altitude, ellipsoid);\n    var hpr = HeadingPitchRoll.fromDegrees(heading, tilt - 90.0, roll);\n\n    entity.kml.camera = new KmlCamera(position, hpr);\n  }\n}\n\nfunction processLookAt(featureNode, entity, ellipsoid) {\n  var lookAt = queryFirstNode(featureNode, \"LookAt\", namespaces.kml);\n  if (defined(lookAt)) {\n    var lon = defaultValue(\n      queryNumericValue(lookAt, \"longitude\", namespaces.kml),\n      0.0\n    );\n    var lat = defaultValue(\n      queryNumericValue(lookAt, \"latitude\", namespaces.kml),\n      0.0\n    );\n    var altitude = defaultValue(\n      queryNumericValue(lookAt, \"altitude\", namespaces.kml),\n      0.0\n    );\n    var heading = queryNumericValue(lookAt, \"heading\", namespaces.kml);\n    var tilt = queryNumericValue(lookAt, \"tilt\", namespaces.kml);\n    var range = defaultValue(\n      queryNumericValue(lookAt, \"range\", namespaces.kml),\n      0.0\n    );\n\n    tilt = CesiumMath.toRadians(defaultValue(tilt, 0.0));\n    heading = CesiumMath.toRadians(defaultValue(heading, 0.0));\n\n    var hpr = new HeadingPitchRange(\n      heading,\n      tilt - CesiumMath.PI_OVER_TWO,\n      range\n    );\n    var viewPoint = Cartesian3.fromDegrees(lon, lat, altitude, ellipsoid);\n\n    entity.kml.lookAt = new KmlLookAt(viewPoint, hpr);\n  }\n}\n\nfunction processGroundOverlay(\n  dataSource,\n  groundOverlay,\n  processingData,\n  deferredLoading\n) {\n  var r = processFeature(dataSource, groundOverlay, processingData);\n  var entity = r.entity;\n\n  var geometry;\n  var isLatLonQuad = false;\n\n  var ellipsoid = dataSource._ellipsoid;\n  var positions = readCoordinates(\n    queryFirstNode(groundOverlay, \"LatLonQuad\", namespaces.gx),\n    ellipsoid\n  );\n  var zIndex = queryNumericValue(groundOverlay, \"drawOrder\", namespaces.kml);\n  if (defined(positions)) {\n    geometry = createDefaultPolygon();\n    geometry.hierarchy = new PolygonHierarchy(positions);\n    geometry.zIndex = zIndex;\n    entity.polygon = geometry;\n    isLatLonQuad = true;\n  } else {\n    geometry = new RectangleGraphics();\n    geometry.zIndex = zIndex;\n    entity.rectangle = geometry;\n\n    var latLonBox = queryFirstNode(groundOverlay, \"LatLonBox\", namespaces.kml);\n    if (defined(latLonBox)) {\n      var west = queryNumericValue(latLonBox, \"west\", namespaces.kml);\n      var south = queryNumericValue(latLonBox, \"south\", namespaces.kml);\n      var east = queryNumericValue(latLonBox, \"east\", namespaces.kml);\n      var north = queryNumericValue(latLonBox, \"north\", namespaces.kml);\n\n      if (defined(west)) {\n        west = CesiumMath.negativePiToPi(CesiumMath.toRadians(west));\n      }\n      if (defined(south)) {\n        south = CesiumMath.clampToLatitudeRange(CesiumMath.toRadians(south));\n      }\n      if (defined(east)) {\n        east = CesiumMath.negativePiToPi(CesiumMath.toRadians(east));\n      }\n      if (defined(north)) {\n        north = CesiumMath.clampToLatitudeRange(CesiumMath.toRadians(north));\n      }\n      geometry.coordinates = new Rectangle(west, south, east, north);\n\n      var rotation = queryNumericValue(latLonBox, \"rotation\", namespaces.kml);\n      if (defined(rotation)) {\n        var rotationRadians = CesiumMath.toRadians(rotation);\n        geometry.rotation = rotationRadians;\n        geometry.stRotation = rotationRadians;\n      }\n    }\n  }\n\n  var iconNode = queryFirstNode(groundOverlay, \"Icon\", namespaces.kml);\n  var href = getIconHref(\n    iconNode,\n    dataSource,\n    processingData.sourceResource,\n    processingData.uriResolver,\n    true\n  );\n  if (defined(href)) {\n    if (isLatLonQuad) {\n      oneTimeWarning(\n        \"kml-gx:LatLonQuad\",\n        \"KML - gx:LatLonQuad Icon does not support texture projection.\"\n      );\n    }\n    var x = queryNumericValue(iconNode, \"x\", namespaces.gx);\n    var y = queryNumericValue(iconNode, \"y\", namespaces.gx);\n    var w = queryNumericValue(iconNode, \"w\", namespaces.gx);\n    var h = queryNumericValue(iconNode, \"h\", namespaces.gx);\n\n    if (defined(x) || defined(y) || defined(w) || defined(h)) {\n      oneTimeWarning(\n        \"kml-groundOverlay-xywh\",\n        \"KML - gx:x, gx:y, gx:w, gx:h aren't supported for GroundOverlays\"\n      );\n    }\n\n    geometry.material = href;\n    geometry.material.color = queryColorValue(\n      groundOverlay,\n      \"color\",\n      namespaces.kml\n    );\n    geometry.material.transparent = true;\n  } else {\n    geometry.material = queryColorValue(groundOverlay, \"color\", namespaces.kml);\n  }\n\n  var altitudeMode = queryStringValue(\n    groundOverlay,\n    \"altitudeMode\",\n    namespaces.kml\n  );\n\n  if (defined(altitudeMode)) {\n    if (altitudeMode === \"absolute\") {\n      //Use height above ellipsoid until we support MSL.\n      geometry.height = queryNumericValue(\n        groundOverlay,\n        \"altitude\",\n        namespaces.kml\n      );\n      geometry.zIndex = undefined;\n    } else if (altitudeMode !== \"clampToGround\") {\n      oneTimeWarning(\n        \"kml-altitudeMode-unknown\",\n        \"KML - Unknown altitudeMode: \" + altitudeMode\n      );\n    }\n    // else just use the default of 0 until we support 'clampToGround'\n  } else {\n    altitudeMode = queryStringValue(\n      groundOverlay,\n      \"altitudeMode\",\n      namespaces.gx\n    );\n    if (altitudeMode === \"relativeToSeaFloor\") {\n      oneTimeWarning(\n        \"kml-altitudeMode-relativeToSeaFloor\",\n        \"KML - altitudeMode relativeToSeaFloor is currently not supported, treating as absolute.\"\n      );\n      geometry.height = queryNumericValue(\n        groundOverlay,\n        \"altitude\",\n        namespaces.kml\n      );\n      geometry.zIndex = undefined;\n    } else if (altitudeMode === \"clampToSeaFloor\") {\n      oneTimeWarning(\n        \"kml-altitudeMode-clampToSeaFloor\",\n        \"KML - altitudeMode clampToSeaFloor is currently not supported, treating as clampToGround.\"\n      );\n    } else if (defined(altitudeMode)) {\n      oneTimeWarning(\n        \"kml-altitudeMode-unknown\",\n        \"KML - Unknown altitudeMode: \" + altitudeMode\n      );\n    }\n  }\n}\n\nfunction processUnsupportedFeature(\n  dataSource,\n  node,\n  processingData,\n  deferredLoading\n) {\n  dataSource._unsupportedNode.raiseEvent(\n    dataSource,\n    processingData.parentEntity,\n    node,\n    processingData.entityCollection,\n    processingData.styleCollection,\n    processingData.sourceResource,\n    processingData.uriResolver\n  );\n  oneTimeWarning(\n    \"kml-unsupportedFeature-\" + node.nodeName,\n    \"KML - Unsupported feature: \" + node.nodeName\n  );\n}\n\nvar RefreshMode = {\n  INTERVAL: 0,\n  EXPIRE: 1,\n  STOP: 2,\n};\n\nfunction cleanupString(s) {\n  if (!defined(s) || s.length === 0) {\n    return \"\";\n  }\n\n  var sFirst = s[0];\n  if (sFirst === \"&\" || sFirst === \"?\") {\n    s = s.substring(1);\n  }\n\n  return s;\n}\n\nvar zeroRectangle = new Rectangle();\nvar scratchCartographic = new Cartographic();\nvar scratchCartesian2 = new Cartesian2();\nvar scratchCartesian3 = new Cartesian3();\n\nfunction processNetworkLinkQueryString(\n  resource,\n  camera,\n  canvas,\n  viewBoundScale,\n  bbox,\n  ellipsoid\n) {\n  function fixLatitude(value) {\n    if (value < -CesiumMath.PI_OVER_TWO) {\n      return -CesiumMath.PI_OVER_TWO;\n    } else if (value > CesiumMath.PI_OVER_TWO) {\n      return CesiumMath.PI_OVER_TWO;\n    }\n    return value;\n  }\n\n  function fixLongitude(value) {\n    if (value > CesiumMath.PI) {\n      return value - CesiumMath.TWO_PI;\n    } else if (value < -CesiumMath.PI) {\n      return value + CesiumMath.TWO_PI;\n    }\n\n    return value;\n  }\n\n  var queryString = objectToQuery(resource.queryParameters);\n\n  // objectToQuery escapes [ and ], so fix that\n  queryString = queryString.replace(/%5B/g, \"[\").replace(/%5D/g, \"]\");\n\n  if (defined(camera) && camera._mode !== SceneMode.MORPHING) {\n    var centerCartesian;\n    var centerCartographic;\n\n    bbox = defaultValue(bbox, zeroRectangle);\n    if (defined(canvas)) {\n      scratchCartesian2.x = canvas.clientWidth * 0.5;\n      scratchCartesian2.y = canvas.clientHeight * 0.5;\n      centerCartesian = camera.pickEllipsoid(\n        scratchCartesian2,\n        ellipsoid,\n        scratchCartesian3\n      );\n    }\n\n    if (defined(centerCartesian)) {\n      centerCartographic = ellipsoid.cartesianToCartographic(\n        centerCartesian,\n        scratchCartographic\n      );\n    } else {\n      centerCartographic = Rectangle.center(bbox, scratchCartographic);\n      centerCartesian = ellipsoid.cartographicToCartesian(centerCartographic);\n    }\n\n    if (\n      defined(viewBoundScale) &&\n      !CesiumMath.equalsEpsilon(viewBoundScale, 1.0, CesiumMath.EPSILON9)\n    ) {\n      var newHalfWidth = bbox.width * viewBoundScale * 0.5;\n      var newHalfHeight = bbox.height * viewBoundScale * 0.5;\n      bbox = new Rectangle(\n        fixLongitude(centerCartographic.longitude - newHalfWidth),\n        fixLatitude(centerCartographic.latitude - newHalfHeight),\n        fixLongitude(centerCartographic.longitude + newHalfWidth),\n        fixLatitude(centerCartographic.latitude + newHalfHeight)\n      );\n    }\n\n    queryString = queryString.replace(\n      \"[bboxWest]\",\n      CesiumMath.toDegrees(bbox.west).toString()\n    );\n    queryString = queryString.replace(\n      \"[bboxSouth]\",\n      CesiumMath.toDegrees(bbox.south).toString()\n    );\n    queryString = queryString.replace(\n      \"[bboxEast]\",\n      CesiumMath.toDegrees(bbox.east).toString()\n    );\n    queryString = queryString.replace(\n      \"[bboxNorth]\",\n      CesiumMath.toDegrees(bbox.north).toString()\n    );\n\n    var lon = CesiumMath.toDegrees(centerCartographic.longitude).toString();\n    var lat = CesiumMath.toDegrees(centerCartographic.latitude).toString();\n    queryString = queryString.replace(\"[lookatLon]\", lon);\n    queryString = queryString.replace(\"[lookatLat]\", lat);\n    queryString = queryString.replace(\n      \"[lookatTilt]\",\n      CesiumMath.toDegrees(camera.pitch).toString()\n    );\n    queryString = queryString.replace(\n      \"[lookatHeading]\",\n      CesiumMath.toDegrees(camera.heading).toString()\n    );\n    queryString = queryString.replace(\n      \"[lookatRange]\",\n      Cartesian3.distance(camera.positionWC, centerCartesian)\n    );\n    queryString = queryString.replace(\"[lookatTerrainLon]\", lon);\n    queryString = queryString.replace(\"[lookatTerrainLat]\", lat);\n    queryString = queryString.replace(\n      \"[lookatTerrainAlt]\",\n      centerCartographic.height.toString()\n    );\n\n    ellipsoid.cartesianToCartographic(camera.positionWC, scratchCartographic);\n    queryString = queryString.replace(\n      \"[cameraLon]\",\n      CesiumMath.toDegrees(scratchCartographic.longitude).toString()\n    );\n    queryString = queryString.replace(\n      \"[cameraLat]\",\n      CesiumMath.toDegrees(scratchCartographic.latitude).toString()\n    );\n    queryString = queryString.replace(\n      \"[cameraAlt]\",\n      CesiumMath.toDegrees(scratchCartographic.height).toString()\n    );\n\n    var frustum = camera.frustum;\n    var aspectRatio = frustum.aspectRatio;\n    var horizFov = \"\";\n    var vertFov = \"\";\n    if (defined(aspectRatio)) {\n      var fov = CesiumMath.toDegrees(frustum.fov);\n      if (aspectRatio > 1.0) {\n        horizFov = fov;\n        vertFov = fov / aspectRatio;\n      } else {\n        vertFov = fov;\n        horizFov = fov * aspectRatio;\n      }\n    }\n    queryString = queryString.replace(\"[horizFov]\", horizFov.toString());\n    queryString = queryString.replace(\"[vertFov]\", vertFov.toString());\n  } else {\n    queryString = queryString.replace(\"[bboxWest]\", \"-180\");\n    queryString = queryString.replace(\"[bboxSouth]\", \"-90\");\n    queryString = queryString.replace(\"[bboxEast]\", \"180\");\n    queryString = queryString.replace(\"[bboxNorth]\", \"90\");\n\n    queryString = queryString.replace(\"[lookatLon]\", \"\");\n    queryString = queryString.replace(\"[lookatLat]\", \"\");\n    queryString = queryString.replace(\"[lookatRange]\", \"\");\n    queryString = queryString.replace(\"[lookatTilt]\", \"\");\n    queryString = queryString.replace(\"[lookatHeading]\", \"\");\n    queryString = queryString.replace(\"[lookatTerrainLon]\", \"\");\n    queryString = queryString.replace(\"[lookatTerrainLat]\", \"\");\n    queryString = queryString.replace(\"[lookatTerrainAlt]\", \"\");\n\n    queryString = queryString.replace(\"[cameraLon]\", \"\");\n    queryString = queryString.replace(\"[cameraLat]\", \"\");\n    queryString = queryString.replace(\"[cameraAlt]\", \"\");\n    queryString = queryString.replace(\"[horizFov]\", \"\");\n    queryString = queryString.replace(\"[vertFov]\", \"\");\n  }\n\n  if (defined(canvas)) {\n    queryString = queryString.replace(\"[horizPixels]\", canvas.clientWidth);\n    queryString = queryString.replace(\"[vertPixels]\", canvas.clientHeight);\n  } else {\n    queryString = queryString.replace(\"[horizPixels]\", \"\");\n    queryString = queryString.replace(\"[vertPixels]\", \"\");\n  }\n\n  queryString = queryString.replace(\"[terrainEnabled]\", \"1\");\n  queryString = queryString.replace(\"[clientVersion]\", \"1\");\n  queryString = queryString.replace(\"[kmlVersion]\", \"2.2\");\n  queryString = queryString.replace(\"[clientName]\", \"Cesium\");\n  queryString = queryString.replace(\"[language]\", \"English\");\n\n  resource.setQueryParameters(queryToObject(queryString));\n}\n\nfunction processNetworkLink(dataSource, node, processingData, deferredLoading) {\n  var r = processFeature(dataSource, node, processingData);\n  var networkEntity = r.entity;\n\n  var sourceResource = processingData.sourceResource;\n  var uriResolver = processingData.uriResolver;\n\n  var link = queryFirstNode(node, \"Link\", namespaces.kml);\n\n  if (!defined(link)) {\n    link = queryFirstNode(node, \"Url\", namespaces.kml);\n  }\n  if (defined(link)) {\n    var href = queryStringValue(link, \"href\", namespaces.kml);\n    var viewRefreshMode;\n    var viewBoundScale;\n    if (defined(href)) {\n      var newSourceUri = href;\n      href = resolveHref(href, sourceResource, processingData.uriResolver);\n\n      // We need to pass in the original path if resolveHref returns a data uri because the network link\n      //  references a document in a KMZ archive\n      if (/^data:/.test(href.getUrlComponent())) {\n        // So if sourceUri isn't the kmz file, then its another kml in the archive, so resolve it\n        if (!/\\.kmz/i.test(sourceResource.getUrlComponent())) {\n          newSourceUri = sourceResource.getDerivedResource({\n            url: newSourceUri,\n          });\n        }\n      } else {\n        newSourceUri = href.clone(); // Not a data uri so use the fully qualified uri\n        viewRefreshMode = queryStringValue(\n          link,\n          \"viewRefreshMode\",\n          namespaces.kml\n        );\n        viewBoundScale = defaultValue(\n          queryStringValue(link, \"viewBoundScale\", namespaces.kml),\n          1.0\n        );\n        var defaultViewFormat =\n          viewRefreshMode === \"onStop\"\n            ? \"BBOX=[bboxWest],[bboxSouth],[bboxEast],[bboxNorth]\"\n            : \"\";\n        var viewFormat = defaultValue(\n          queryStringValue(link, \"viewFormat\", namespaces.kml),\n          defaultViewFormat\n        );\n        var httpQuery = queryStringValue(link, \"httpQuery\", namespaces.kml);\n        if (defined(viewFormat)) {\n          href.setQueryParameters(queryToObject(cleanupString(viewFormat)));\n        }\n        if (defined(httpQuery)) {\n          href.setQueryParameters(queryToObject(cleanupString(httpQuery)));\n        }\n\n        var ellipsoid = dataSource._ellipsoid;\n        processNetworkLinkQueryString(\n          href,\n          dataSource._camera,\n          dataSource._canvas,\n          viewBoundScale,\n          dataSource._lastCameraView.bbox,\n          ellipsoid\n        );\n      }\n\n      var options = {\n        sourceUri: newSourceUri,\n        uriResolver: uriResolver,\n        context: networkEntity.id,\n      };\n      var networkLinkCollection = new EntityCollection();\n      var promise = load(dataSource, networkLinkCollection, href, options)\n        .then(function (rootElement) {\n          var entities = dataSource._entityCollection;\n          var newEntities = networkLinkCollection.values;\n          entities.suspendEvents();\n          for (var i = 0; i < newEntities.length; i++) {\n            var newEntity = newEntities[i];\n            if (!defined(newEntity.parent)) {\n              newEntity.parent = networkEntity;\n              mergeAvailabilityWithParent(newEntity);\n            }\n\n            entities.add(newEntity);\n          }\n          entities.resumeEvents();\n\n          // Add network links to a list if we need they will need to be updated\n          var refreshMode = queryStringValue(\n            link,\n            \"refreshMode\",\n            namespaces.kml\n          );\n          var refreshInterval = defaultValue(\n            queryNumericValue(link, \"refreshInterval\", namespaces.kml),\n            0\n          );\n          if (\n            (refreshMode === \"onInterval\" && refreshInterval > 0) ||\n            refreshMode === \"onExpire\" ||\n            viewRefreshMode === \"onStop\"\n          ) {\n            var networkLinkControl = queryFirstNode(\n              rootElement,\n              \"NetworkLinkControl\",\n              namespaces.kml\n            );\n            var hasNetworkLinkControl = defined(networkLinkControl);\n\n            var now = JulianDate.now();\n            var networkLinkInfo = {\n              id: createGuid(),\n              href: href,\n              cookie: {},\n              lastUpdated: now,\n              updating: false,\n              entity: networkEntity,\n              viewBoundScale: viewBoundScale,\n              needsUpdate: false,\n              cameraUpdateTime: now,\n            };\n\n            var minRefreshPeriod = 0;\n            if (hasNetworkLinkControl) {\n              networkLinkInfo.cookie = queryToObject(\n                defaultValue(\n                  queryStringValue(\n                    networkLinkControl,\n                    \"cookie\",\n                    namespaces.kml\n                  ),\n                  \"\"\n                )\n              );\n              minRefreshPeriod = defaultValue(\n                queryNumericValue(\n                  networkLinkControl,\n                  \"minRefreshPeriod\",\n                  namespaces.kml\n                ),\n                0\n              );\n            }\n\n            if (refreshMode === \"onInterval\") {\n              if (hasNetworkLinkControl) {\n                refreshInterval = Math.max(minRefreshPeriod, refreshInterval);\n              }\n              networkLinkInfo.refreshMode = RefreshMode.INTERVAL;\n              networkLinkInfo.time = refreshInterval;\n            } else if (refreshMode === \"onExpire\") {\n              var expires;\n              if (hasNetworkLinkControl) {\n                expires = queryStringValue(\n                  networkLinkControl,\n                  \"expires\",\n                  namespaces.kml\n                );\n              }\n              if (defined(expires)) {\n                try {\n                  var date = JulianDate.fromIso8601(expires);\n                  var diff = JulianDate.secondsDifference(date, now);\n                  if (diff > 0 && diff < minRefreshPeriod) {\n                    JulianDate.addSeconds(now, minRefreshPeriod, date);\n                  }\n                  networkLinkInfo.refreshMode = RefreshMode.EXPIRE;\n                  networkLinkInfo.time = date;\n                } catch (e) {\n                  oneTimeWarning(\n                    \"kml-refreshMode-onInterval-onExpire\",\n                    \"KML - NetworkLinkControl expires is not a valid date\"\n                  );\n                }\n              } else {\n                oneTimeWarning(\n                  \"kml-refreshMode-onExpire\",\n                  \"KML - refreshMode of onExpire requires the NetworkLinkControl to have an expires element\"\n                );\n              }\n            } else if (dataSource._camera) {\n              // Only allow onStop refreshes if we have a camera\n              networkLinkInfo.refreshMode = RefreshMode.STOP;\n              networkLinkInfo.time = defaultValue(\n                queryNumericValue(link, \"viewRefreshTime\", namespaces.kml),\n                0\n              );\n            } else {\n              oneTimeWarning(\n                \"kml-refrehMode-onStop-noCamera\",\n                \"A NetworkLink with viewRefreshMode=onStop requires a camera be passed in when creating the KmlDataSource\"\n              );\n            }\n\n            if (defined(networkLinkInfo.refreshMode)) {\n              dataSource._networkLinks.set(networkLinkInfo.id, networkLinkInfo);\n            }\n          } else if (viewRefreshMode === \"onRegion\") {\n            oneTimeWarning(\n              \"kml-refrehMode-onRegion\",\n              \"KML - Unsupported viewRefreshMode: onRegion\"\n            );\n          }\n        })\n        .otherwise(function (error) {\n          oneTimeWarning(\"An error occured during loading \" + href.url);\n          dataSource._error.raiseEvent(dataSource, error);\n        });\n\n      deferredLoading.addPromise(promise);\n    }\n  }\n}\n\nfunction processFeatureNode(dataSource, node, processingData, deferredLoading) {\n  var featureProcessor = featureTypes[node.localName];\n  if (defined(featureProcessor)) {\n    return featureProcessor(dataSource, node, processingData, deferredLoading);\n  }\n\n  return processUnsupportedFeature(\n    dataSource,\n    node,\n    processingData,\n    deferredLoading\n  );\n}\n\nfunction loadKml(\n  dataSource,\n  entityCollection,\n  kml,\n  sourceResource,\n  uriResolver,\n  context\n) {\n  entityCollection.removeAll();\n\n  var documentElement = kml.documentElement;\n  var document =\n    documentElement.localName === \"Document\"\n      ? documentElement\n      : queryFirstNode(documentElement, \"Document\", namespaces.kml);\n  var name = queryStringValue(document, \"name\", namespaces.kml);\n  if (!defined(name)) {\n    name = getFilenameFromUri(sourceResource.getUrlComponent());\n  }\n\n  // Only set the name from the root document\n  if (!defined(dataSource._name)) {\n    dataSource._name = name;\n  }\n\n  var deferredLoading = new KmlDataSource._DeferredLoading(dataSource);\n  var styleCollection = new EntityCollection(dataSource);\n  return when\n    .all(\n      processStyles(\n        dataSource,\n        kml,\n        styleCollection,\n        sourceResource,\n        false,\n        uriResolver\n      )\n    )\n    .then(function () {\n      var element = kml.documentElement;\n      if (element.localName === \"kml\") {\n        var childNodes = element.childNodes;\n        for (var i = 0; i < childNodes.length; i++) {\n          var tmp = childNodes[i];\n          if (defined(featureTypes[tmp.localName])) {\n            element = tmp;\n            break;\n          }\n        }\n      }\n\n      var processingData = {\n        parentEntity: undefined,\n        entityCollection: entityCollection,\n        styleCollection: styleCollection,\n        sourceResource: sourceResource,\n        uriResolver: uriResolver,\n        context: context,\n      };\n\n      entityCollection.suspendEvents();\n      processFeatureNode(dataSource, element, processingData, deferredLoading);\n      entityCollection.resumeEvents();\n\n      return deferredLoading.wait().then(function () {\n        return kml.documentElement;\n      });\n    });\n}\n\nfunction loadKmz(dataSource, entityCollection, blob, sourceResource) {\n  var deferred = when.defer();\n  zip.createReader(\n    new zip.BlobReader(blob),\n    function (reader) {\n      reader.getEntries(function (entries) {\n        var promises = [];\n        var uriResolver = {};\n        var docEntry;\n        var docDefer;\n        for (var i = 0; i < entries.length; i++) {\n          var entry = entries[i];\n          if (!entry.directory) {\n            var innerDefer = when.defer();\n            promises.push(innerDefer.promise);\n            if (/\\.kml$/i.test(entry.filename)) {\n              // We use the first KML document we come across\n              //  https://developers.google.com/kml/documentation/kmzarchives\n              // Unless we come across a .kml file at the root of the archive because GE does this\n              if (!defined(docEntry) || !/\\//i.test(entry.filename)) {\n                if (defined(docEntry)) {\n                  // We found one at the root so load the initial kml as a data uri\n                  loadDataUriFromZip(docEntry, uriResolver, docDefer);\n                }\n                docEntry = entry;\n                docDefer = innerDefer;\n              } else {\n                // Wasn't the first kml and wasn't at the root\n                loadDataUriFromZip(entry, uriResolver, innerDefer);\n              }\n            } else {\n              loadDataUriFromZip(entry, uriResolver, innerDefer);\n            }\n          }\n        }\n\n        // Now load the root KML document\n        if (defined(docEntry)) {\n          loadXmlFromZip(docEntry, uriResolver, docDefer);\n        }\n        when\n          .all(promises)\n          .then(function () {\n            reader.close();\n            if (!defined(uriResolver.kml)) {\n              deferred.reject(\n                new RuntimeError(\"KMZ file does not contain a KML document.\")\n              );\n              return;\n            }\n            uriResolver.keys = Object.keys(uriResolver);\n            return loadKml(\n              dataSource,\n              entityCollection,\n              uriResolver.kml,\n              sourceResource,\n              uriResolver\n            );\n          })\n          .then(deferred.resolve)\n          .otherwise(deferred.reject);\n      });\n    },\n    function (e) {\n      deferred.reject(e);\n    }\n  );\n\n  return deferred.promise;\n}\n\nfunction load(dataSource, entityCollection, data, options) {\n  options = defaultValue(options, defaultValue.EMPTY_OBJECT);\n  var sourceUri = options.sourceUri;\n  var uriResolver = options.uriResolver;\n  var context = options.context;\n\n  var promise = data;\n  if (typeof data === \"string\" || data instanceof Resource) {\n    data = Resource.createIfNeeded(data);\n    promise = data.fetchBlob();\n    sourceUri = defaultValue(sourceUri, data.clone());\n\n    // Add resource credits to our list of credits to display\n    var resourceCredits = dataSource._resourceCredits;\n    var credits = data.credits;\n    if (defined(credits)) {\n      var length = credits.length;\n      for (var i = 0; i < length; i++) {\n        resourceCredits.push(credits[i]);\n      }\n    }\n  } else {\n    sourceUri = defaultValue(sourceUri, Resource.DEFAULT.clone());\n  }\n\n  sourceUri = Resource.createIfNeeded(sourceUri);\n\n  return when(promise)\n    .then(function (dataToLoad) {\n      if (dataToLoad instanceof Blob) {\n        return isZipFile(dataToLoad).then(function (isZip) {\n          if (isZip) {\n            return loadKmz(dataSource, entityCollection, dataToLoad, sourceUri);\n          }\n          return readBlobAsText(dataToLoad).then(function (text) {\n            //There's no official way to validate if a parse was successful.\n            //The following check detects the error on various browsers.\n\n            //Insert missing namespaces\n            text = insertNamespaces(text);\n\n            //Remove Duplicate Namespaces\n            text = removeDuplicateNamespaces(text);\n\n            //IE raises an exception\n            var kml;\n            var error;\n            try {\n              kml = parser.parseFromString(text, \"application/xml\");\n            } catch (e) {\n              error = e.toString();\n            }\n\n            //The parse succeeds on Chrome and Firefox, but the error\n            //handling is different in each.\n            if (\n              defined(error) ||\n              kml.body ||\n              kml.documentElement.tagName === \"parsererror\"\n            ) {\n              //Firefox has error information as the firstChild nodeValue.\n              var msg = defined(error)\n                ? error\n                : kml.documentElement.firstChild.nodeValue;\n\n              //Chrome has it in the body text.\n              if (!msg) {\n                msg = kml.body.innerText;\n              }\n\n              //Return the error\n              throw new RuntimeError(msg);\n            }\n            return loadKml(\n              dataSource,\n              entityCollection,\n              kml,\n              sourceUri,\n              uriResolver,\n              context\n            );\n          });\n        });\n      }\n      return loadKml(\n        dataSource,\n        entityCollection,\n        dataToLoad,\n        sourceUri,\n        uriResolver,\n        context\n      );\n    })\n    .otherwise(function (error) {\n      dataSource._error.raiseEvent(dataSource, error);\n      console.log(error);\n      return when.reject(error);\n    });\n}\n\n/**\n * A {@link DataSource} which processes Keyhole Markup Language 2.2 (KML).\n * <p>\n * KML support in Cesium is incomplete, but a large amount of the standard,\n * as well as Google's <code>gx</code> extension namespace, is supported. See Github issue\n * {@link https://github.com/CesiumGS/cesium/issues/873|#873} for a\n * detailed list of what is and isn't support. Cesium will also write information to the\n * console when it encounters most unsupported features.\n * </p>\n * <p>\n * Non visual feature data, such as <code>atom:author</code> and <code>ExtendedData</code>\n * is exposed via an instance of {@link KmlFeatureData}, which is added to each {@link Entity}\n * under the <code>kml</code> property.\n * </p>\n *\n * @alias KmlDataSource\n * @constructor\n *\n * @param {Object} options An object with the following properties:\n * @param {Camera} options.camera The camera that is used for viewRefreshModes and sending camera properties to network links.\n * @param {Canvas} options.canvas The canvas that is used for sending viewer properties to network links.\n * @param {Ellipsoid} [options.ellipsoid=Ellipsoid.WGS84] The global ellipsoid used for geographical calculations.\n * @param {Credit|String} [options.credit] A credit for the data source, which is displayed on the canvas.\n *\n * @see {@link http://www.opengeospatial.org/standards/kml/|Open Geospatial Consortium KML Standard}\n * @see {@link https://developers.google.com/kml/|Google KML Documentation}\n *\n * @demo {@link https://sandcastle.cesium.com/index.html?src=KML.html|Cesium Sandcastle KML Demo}\n *\n * @example\n * var viewer = new Cesium.Viewer('cesiumContainer');\n * viewer.dataSources.add(Cesium.KmlDataSource.load('../../SampleData/facilities.kmz',\n *      {\n *           camera: viewer.scene.camera,\n *           canvas: viewer.scene.canvas\n *      })\n * );\n */\nfunction KmlDataSource(options) {\n  options = defaultValue(options, defaultValue.EMPTY_OBJECT);\n  var camera = options.camera;\n  var canvas = options.canvas;\n\n  //>>includeStart('debug', pragmas.debug);\n  if (!defined(camera)) {\n    throw new DeveloperError(\"options.camera is required.\");\n  }\n  if (!defined(canvas)) {\n    throw new DeveloperError(\"options.canvas is required.\");\n  }\n  //>>includeEnd('debug');\n\n  this._changed = new Event();\n  this._error = new Event();\n  this._loading = new Event();\n  this._refresh = new Event();\n  this._unsupportedNode = new Event();\n\n  this._clock = undefined;\n  this._entityCollection = new EntityCollection(this);\n  this._name = undefined;\n  this._isLoading = false;\n  this._pinBuilder = new PinBuilder();\n  this._networkLinks = new AssociativeArray();\n  this._entityCluster = new EntityCluster();\n\n  this._canvas = canvas;\n  this._camera = camera;\n  this._lastCameraView = {\n    position: defined(camera) ? Cartesian3.clone(camera.positionWC) : undefined,\n    direction: defined(camera)\n      ? Cartesian3.clone(camera.directionWC)\n      : undefined,\n    up: defined(camera) ? Cartesian3.clone(camera.upWC) : undefined,\n    bbox: defined(camera)\n      ? camera.computeViewRectangle()\n      : Rectangle.clone(Rectangle.MAX_VALUE),\n  };\n\n  this._ellipsoid = defaultValue(options.ellipsoid, Ellipsoid.WGS84);\n\n  // User specified credit\n  var credit = options.credit;\n  if (typeof credit === \"string\") {\n    credit = new Credit(credit);\n  }\n  this._credit = credit;\n\n  // Create a list of Credit's from the resource that the user can't remove\n  this._resourceCredits = [];\n}\n\n/**\n * Creates a Promise to a new instance loaded with the provided KML data.\n *\n * @param {Resource|String|Document|Blob} data A url, parsed KML document, or Blob containing binary KMZ data or a parsed KML document.\n * @param {Object} options An object with the following properties:\n * @param {Camera} options.camera The camera that is used for viewRefreshModes and sending camera properties to network links.\n * @param {Canvas} options.canvas The canvas that is used for sending viewer properties to network links.\n * @param {String} [options.sourceUri] Overrides the url to use for resolving relative links and other KML network features.\n * @param {Boolean} [options.clampToGround=false] true if we want the geometry features (Polygons, LineStrings and LinearRings) clamped to the ground.\n * @param {Ellipsoid} [options.ellipsoid=Ellipsoid.WGS84] The global ellipsoid used for geographical calculations.\n * @param {Credit|String} [options.credit] A credit for the data source, which is displayed on the canvas.\n *\n * @returns {Promise.<KmlDataSource>} A promise that will resolve to a new KmlDataSource instance once the KML is loaded.\n */\nKmlDataSource.load = function (data, options) {\n  options = defaultValue(options, defaultValue.EMPTY_OBJECT);\n  var dataSource = new KmlDataSource(options);\n  return dataSource.load(data, options);\n};\n\nObject.defineProperties(KmlDataSource.prototype, {\n  /**\n   * Gets or sets a human-readable name for this instance.\n   * This will be automatically be set to the KML document name on load.\n   * @memberof KmlDataSource.prototype\n   * @type {String}\n   */\n  name: {\n    get: function () {\n      return this._name;\n    },\n    set: function (value) {\n      if (this._name !== value) {\n        this._name = value;\n        this._changed.raiseEvent(this);\n      }\n    },\n  },\n  /**\n   * Gets the clock settings defined by the loaded KML. This represents the total\n   * availability interval for all time-dynamic data. If the KML does not contain\n   * time-dynamic data, this value is undefined.\n   * @memberof KmlDataSource.prototype\n   * @type {DataSourceClock}\n   */\n  clock: {\n    get: function () {\n      return this._clock;\n    },\n  },\n  /**\n   * Gets the collection of {@link Entity} instances.\n   * @memberof KmlDataSource.prototype\n   * @type {EntityCollection}\n   */\n  entities: {\n    get: function () {\n      return this._entityCollection;\n    },\n  },\n  /**\n   * Gets a value indicating if the data source is currently loading data.\n   * @memberof KmlDataSource.prototype\n   * @type {Boolean}\n   */\n  isLoading: {\n    get: function () {\n      return this._isLoading;\n    },\n  },\n  /**\n   * Gets an event that will be raised when the underlying data changes.\n   * @memberof KmlDataSource.prototype\n   * @type {Event}\n   */\n  changedEvent: {\n    get: function () {\n      return this._changed;\n    },\n  },\n  /**\n   * Gets an event that will be raised if an error is encountered during processing.\n   * @memberof KmlDataSource.prototype\n   * @type {Event}\n   */\n  errorEvent: {\n    get: function () {\n      return this._error;\n    },\n  },\n  /**\n   * Gets an event that will be raised when the data source either starts or stops loading.\n   * @memberof KmlDataSource.prototype\n   * @type {Event}\n   */\n  loadingEvent: {\n    get: function () {\n      return this._loading;\n    },\n  },\n  /**\n   * Gets an event that will be raised when the data source refreshes a network link.\n   * @memberof KmlDataSource.prototype\n   * @type {Event}\n   */\n  refreshEvent: {\n    get: function () {\n      return this._refresh;\n    },\n  },\n  /**\n   * Gets an event that will be raised when the data source finds an unsupported node type.\n   * @memberof KmlDataSource.prototype\n   * @type {Event}\n   */\n  unsupportedNodeEvent: {\n    get: function () {\n      return this._unsupportedNode;\n    },\n  },\n  /**\n   * Gets whether or not this data source should be displayed.\n   * @memberof KmlDataSource.prototype\n   * @type {Boolean}\n   */\n  show: {\n    get: function () {\n      return this._entityCollection.show;\n    },\n    set: function (value) {\n      this._entityCollection.show = value;\n    },\n  },\n\n  /**\n   * Gets or sets the clustering options for this data source. This object can be shared between multiple data sources.\n   *\n   * @memberof KmlDataSource.prototype\n   * @type {EntityCluster}\n   */\n  clustering: {\n    get: function () {\n      return this._entityCluster;\n    },\n    set: function (value) {\n      //>>includeStart('debug', pragmas.debug);\n      if (!defined(value)) {\n        throw new DeveloperError(\"value must be defined.\");\n      }\n      //>>includeEnd('debug');\n      this._entityCluster = value;\n    },\n  },\n  /**\n   * Gets the credit that will be displayed for the data source\n   * @memberof KmlDataSource.prototype\n   * @type {Credit}\n   */\n  credit: {\n    get: function () {\n      return this._credit;\n    },\n  },\n});\n\n/**\n * Asynchronously loads the provided KML data, replacing any existing data.\n *\n * @param {Resource|String|Document|Blob} data A url, parsed KML document, or Blob containing binary KMZ data or a parsed KML document.\n * @param {Object} [options] An object with the following properties:\n * @param {Resource|String} [options.sourceUri] Overrides the url to use for resolving relative links and other KML network features.\n * @param {Boolean} [options.clampToGround=false] true if we want the geometry features (Polygons, LineStrings and LinearRings) clamped to the ground. If true, lines will use corridors so use Entity.corridor instead of Entity.polyline.\n * @param {Ellipsoid} [options.ellipsoid=Ellipsoid.WGS84] The global ellipsoid used for geographical calculations.\n *\n * @returns {Promise.<KmlDataSource>} A promise that will resolve to this instances once the KML is loaded.\n */\nKmlDataSource.prototype.load = function (data, options) {\n  //>>includeStart('debug', pragmas.debug);\n  if (!defined(data)) {\n    throw new DeveloperError(\"data is required.\");\n  }\n  //>>includeEnd('debug');\n\n  options = defaultValue(options, defaultValue.EMPTY_OBJECT);\n  DataSource.setLoading(this, true);\n\n  var oldName = this._name;\n  this._name = undefined;\n  this._clampToGround = defaultValue(options.clampToGround, false);\n\n  var that = this;\n  return load(this, this._entityCollection, data, options)\n    .then(function () {\n      var clock;\n\n      var availability = that._entityCollection.computeAvailability();\n\n      var start = availability.start;\n      var stop = availability.stop;\n      var isMinStart = JulianDate.equals(start, Iso8601.MINIMUM_VALUE);\n      var isMaxStop = JulianDate.equals(stop, Iso8601.MAXIMUM_VALUE);\n      if (!isMinStart || !isMaxStop) {\n        var date;\n\n        //If start is min time just start at midnight this morning, local time\n        if (isMinStart) {\n          date = new Date();\n          date.setHours(0, 0, 0, 0);\n          start = JulianDate.fromDate(date);\n        }\n\n        //If stop is max value just stop at midnight tonight, local time\n        if (isMaxStop) {\n          date = new Date();\n          date.setHours(24, 0, 0, 0);\n          stop = JulianDate.fromDate(date);\n        }\n\n        clock = new DataSourceClock();\n        clock.startTime = start;\n        clock.stopTime = stop;\n        clock.currentTime = JulianDate.clone(start);\n        clock.clockRange = ClockRange.LOOP_STOP;\n        clock.clockStep = ClockStep.SYSTEM_CLOCK_MULTIPLIER;\n        clock.multiplier = Math.round(\n          Math.min(\n            Math.max(JulianDate.secondsDifference(stop, start) / 60, 1),\n            3.15569e7\n          )\n        );\n      }\n\n      var changed = false;\n      if (clock !== that._clock) {\n        that._clock = clock;\n        changed = true;\n      }\n\n      if (oldName !== that._name) {\n        changed = true;\n      }\n\n      if (changed) {\n        that._changed.raiseEvent(that);\n      }\n\n      DataSource.setLoading(that, false);\n\n      return that;\n    })\n    .otherwise(function (error) {\n      DataSource.setLoading(that, false);\n      that._error.raiseEvent(that, error);\n      console.log(error);\n      return when.reject(error);\n    });\n};\n\nfunction mergeAvailabilityWithParent(child) {\n  var parent = child.parent;\n  if (defined(parent)) {\n    var parentAvailability = parent.availability;\n    if (defined(parentAvailability)) {\n      var childAvailability = child.availability;\n      if (defined(childAvailability)) {\n        childAvailability.intersect(parentAvailability);\n      } else {\n        child.availability = parentAvailability;\n      }\n    }\n  }\n}\n\nfunction getNetworkLinkUpdateCallback(\n  dataSource,\n  networkLink,\n  newEntityCollection,\n  networkLinks,\n  processedHref\n) {\n  return function (rootElement) {\n    if (!networkLinks.contains(networkLink.id)) {\n      // Got into the odd case where a parent network link was updated while a child\n      //  network link update was in flight, so just throw it away.\n      return;\n    }\n    var remove = false;\n    var networkLinkControl = queryFirstNode(\n      rootElement,\n      \"NetworkLinkControl\",\n      namespaces.kml\n    );\n    var hasNetworkLinkControl = defined(networkLinkControl);\n\n    var minRefreshPeriod = 0;\n    if (hasNetworkLinkControl) {\n      if (\n        defined(queryFirstNode(networkLinkControl, \"Update\", namespaces.kml))\n      ) {\n        oneTimeWarning(\n          \"kml-networkLinkControl-update\",\n          \"KML - NetworkLinkControl updates aren't supported.\"\n        );\n        networkLink.updating = false;\n        networkLinks.remove(networkLink.id);\n        return;\n      }\n      networkLink.cookie = queryToObject(\n        defaultValue(\n          queryStringValue(networkLinkControl, \"cookie\", namespaces.kml),\n          \"\"\n        )\n      );\n      minRefreshPeriod = defaultValue(\n        queryNumericValue(\n          networkLinkControl,\n          \"minRefreshPeriod\",\n          namespaces.kml\n        ),\n        0\n      );\n    }\n\n    var now = JulianDate.now();\n    var refreshMode = networkLink.refreshMode;\n    if (refreshMode === RefreshMode.INTERVAL) {\n      if (defined(networkLinkControl)) {\n        networkLink.time = Math.max(minRefreshPeriod, networkLink.time);\n      }\n    } else if (refreshMode === RefreshMode.EXPIRE) {\n      var expires;\n      if (defined(networkLinkControl)) {\n        expires = queryStringValue(\n          networkLinkControl,\n          \"expires\",\n          namespaces.kml\n        );\n      }\n      if (defined(expires)) {\n        try {\n          var date = JulianDate.fromIso8601(expires);\n          var diff = JulianDate.secondsDifference(date, now);\n          if (diff > 0 && diff < minRefreshPeriod) {\n            JulianDate.addSeconds(now, minRefreshPeriod, date);\n          }\n          networkLink.time = date;\n        } catch (e) {\n          oneTimeWarning(\n            \"kml-networkLinkControl-expires\",\n            \"KML - NetworkLinkControl expires is not a valid date\"\n          );\n          remove = true;\n        }\n      } else {\n        oneTimeWarning(\n          \"kml-refreshMode-onExpire\",\n          \"KML - refreshMode of onExpire requires the NetworkLinkControl to have an expires element\"\n        );\n        remove = true;\n      }\n    }\n\n    var networkLinkEntity = networkLink.entity;\n    var entityCollection = dataSource._entityCollection;\n    var newEntities = newEntityCollection.values;\n\n    function removeChildren(entity) {\n      entityCollection.remove(entity);\n      var children = entity._children;\n      var count = children.length;\n      for (var i = 0; i < count; ++i) {\n        removeChildren(children[i]);\n      }\n    }\n\n    // Remove old entities\n    entityCollection.suspendEvents();\n    var entitiesCopy = entityCollection.values.slice();\n    var i;\n    for (i = 0; i < entitiesCopy.length; ++i) {\n      var entityToRemove = entitiesCopy[i];\n      if (entityToRemove.parent === networkLinkEntity) {\n        entityToRemove.parent = undefined;\n        removeChildren(entityToRemove);\n      }\n    }\n    entityCollection.resumeEvents();\n\n    // Add new entities\n    entityCollection.suspendEvents();\n    for (i = 0; i < newEntities.length; i++) {\n      var newEntity = newEntities[i];\n      if (!defined(newEntity.parent)) {\n        newEntity.parent = networkLinkEntity;\n        mergeAvailabilityWithParent(newEntity);\n      }\n      entityCollection.add(newEntity);\n    }\n    entityCollection.resumeEvents();\n\n    // No refresh information remove it, otherwise update lastUpdate time\n    if (remove) {\n      networkLinks.remove(networkLink.id);\n    } else {\n      networkLink.lastUpdated = now;\n    }\n\n    var availability = entityCollection.computeAvailability();\n\n    var start = availability.start;\n    var stop = availability.stop;\n    var isMinStart = JulianDate.equals(start, Iso8601.MINIMUM_VALUE);\n    var isMaxStop = JulianDate.equals(stop, Iso8601.MAXIMUM_VALUE);\n    if (!isMinStart || !isMaxStop) {\n      var clock = dataSource._clock;\n\n      if (clock.startTime !== start || clock.stopTime !== stop) {\n        clock.startTime = start;\n        clock.stopTime = stop;\n        dataSource._changed.raiseEvent(dataSource);\n      }\n    }\n\n    networkLink.updating = false;\n    networkLink.needsUpdate = false;\n    dataSource._refresh.raiseEvent(\n      dataSource,\n      processedHref.getUrlComponent(true)\n    );\n  };\n}\n\nvar entitiesToIgnore = new AssociativeArray();\n\n/**\n * Updates any NetworkLink that require updating\n * @function\n *\n * @param {JulianDate} time The simulation time.\n * @returns {Boolean} True if this data source is ready to be displayed at the provided time, false otherwise.\n */\nKmlDataSource.prototype.update = function (time) {\n  var networkLinks = this._networkLinks;\n  if (networkLinks.length === 0) {\n    return true;\n  }\n\n  var now = JulianDate.now();\n  var that = this;\n\n  entitiesToIgnore.removeAll();\n\n  function recurseIgnoreEntities(entity) {\n    var children = entity._children;\n    var count = children.length;\n    for (var i = 0; i < count; ++i) {\n      var child = children[i];\n      entitiesToIgnore.set(child.id, child);\n      recurseIgnoreEntities(child);\n    }\n  }\n\n  var cameraViewUpdate = false;\n  var lastCameraView = this._lastCameraView;\n  var camera = this._camera;\n  if (\n    defined(camera) &&\n    !(\n      camera.positionWC.equalsEpsilon(\n        lastCameraView.position,\n        CesiumMath.EPSILON7\n      ) &&\n      camera.directionWC.equalsEpsilon(\n        lastCameraView.direction,\n        CesiumMath.EPSILON7\n      ) &&\n      camera.upWC.equalsEpsilon(lastCameraView.up, CesiumMath.EPSILON7)\n    )\n  ) {\n    // Camera has changed so update the last view\n    lastCameraView.position = Cartesian3.clone(camera.positionWC);\n    lastCameraView.direction = Cartesian3.clone(camera.directionWC);\n    lastCameraView.up = Cartesian3.clone(camera.upWC);\n    lastCameraView.bbox = camera.computeViewRectangle();\n    cameraViewUpdate = true;\n  }\n\n  var newNetworkLinks = new AssociativeArray();\n  var changed = false;\n  networkLinks.values.forEach(function (networkLink) {\n    var entity = networkLink.entity;\n    if (entitiesToIgnore.contains(entity.id)) {\n      return;\n    }\n\n    if (!networkLink.updating) {\n      var doUpdate = false;\n      if (networkLink.refreshMode === RefreshMode.INTERVAL) {\n        if (\n          JulianDate.secondsDifference(now, networkLink.lastUpdated) >\n          networkLink.time\n        ) {\n          doUpdate = true;\n        }\n      } else if (networkLink.refreshMode === RefreshMode.EXPIRE) {\n        if (JulianDate.greaterThan(now, networkLink.time)) {\n          doUpdate = true;\n        }\n      } else if (networkLink.refreshMode === RefreshMode.STOP) {\n        if (cameraViewUpdate) {\n          networkLink.needsUpdate = true;\n          networkLink.cameraUpdateTime = now;\n        }\n\n        if (\n          networkLink.needsUpdate &&\n          JulianDate.secondsDifference(now, networkLink.cameraUpdateTime) >=\n            networkLink.time\n        ) {\n          doUpdate = true;\n        }\n      }\n\n      if (doUpdate) {\n        recurseIgnoreEntities(entity);\n        networkLink.updating = true;\n        var newEntityCollection = new EntityCollection();\n        var href = networkLink.href.clone();\n\n        href.setQueryParameters(networkLink.cookie);\n        var ellipsoid = defaultValue(that._ellipsoid, Ellipsoid.WGS84);\n        processNetworkLinkQueryString(\n          href,\n          that._camera,\n          that._canvas,\n          networkLink.viewBoundScale,\n          lastCameraView.bbox,\n          ellipsoid\n        );\n\n        load(that, newEntityCollection, href, { context: entity.id })\n          .then(\n            getNetworkLinkUpdateCallback(\n              that,\n              networkLink,\n              newEntityCollection,\n              newNetworkLinks,\n              href\n            )\n          )\n          .otherwise(function (error) {\n            var msg =\n              \"NetworkLink \" + networkLink.href + \" refresh failed: \" + error;\n            console.log(msg);\n            that._error.raiseEvent(that, msg);\n          });\n        changed = true;\n      }\n    }\n    newNetworkLinks.set(networkLink.id, networkLink);\n  });\n\n  if (changed) {\n    this._networkLinks = newNetworkLinks;\n    this._changed.raiseEvent(this);\n  }\n\n  return true;\n};\n\n/**\n * Contains KML Feature data loaded into the <code>Entity.kml</code> property by {@link KmlDataSource}.\n * @alias KmlFeatureData\n * @constructor\n */\nfunction KmlFeatureData() {\n  /**\n   * Gets the atom syndication format author field.\n   * @type Object\n   */\n  this.author = {\n    /**\n     * Gets the name.\n     * @type String\n     * @alias author.name\n     * @memberof! KmlFeatureData#\n     * @property author.name\n     */\n    name: undefined,\n    /**\n     * Gets the URI.\n     * @type String\n     * @alias author.uri\n     * @memberof! KmlFeatureData#\n     * @property author.uri\n     */\n    uri: undefined,\n    /**\n     * Gets the email.\n     * @type String\n     * @alias author.email\n     * @memberof! KmlFeatureData#\n     * @property author.email\n     */\n    email: undefined,\n  };\n\n  /**\n   * Gets the link.\n   * @type Object\n   */\n  this.link = {\n    /**\n     * Gets the href.\n     * @type String\n     * @alias link.href\n     * @memberof! KmlFeatureData#\n     * @property link.href\n     */\n    href: undefined,\n    /**\n     * Gets the language of the linked resource.\n     * @type String\n     * @alias link.hreflang\n     * @memberof! KmlFeatureData#\n     * @property link.hreflang\n     */\n    hreflang: undefined,\n    /**\n     * Gets the link relation.\n     * @type String\n     * @alias link.rel\n     * @memberof! KmlFeatureData#\n     * @property link.rel\n     */\n    rel: undefined,\n    /**\n     * Gets the link type.\n     * @type String\n     * @alias link.type\n     * @memberof! KmlFeatureData#\n     * @property link.type\n     */\n    type: undefined,\n    /**\n     * Gets the link title.\n     * @type String\n     * @alias link.title\n     * @memberof! KmlFeatureData#\n     * @property link.title\n     */\n    title: undefined,\n    /**\n     * Gets the link length.\n     * @type String\n     * @alias link.length\n     * @memberof! KmlFeatureData#\n     * @property link.length\n     */\n    length: undefined,\n  };\n\n  /**\n   * Gets the unstructured address field.\n   * @type String\n   */\n  this.address = undefined;\n  /**\n   * Gets the phone number.\n   * @type String\n   */\n  this.phoneNumber = undefined;\n  /**\n   * Gets the snippet.\n   * @type String\n   */\n  this.snippet = undefined;\n  /**\n   * Gets the extended data, parsed into a JSON object.\n   * Currently only the <code>Data</code> property is supported.\n   * <code>SchemaData</code> and custom data are ignored.\n   * @type String\n   */\n  this.extendedData = undefined;\n}\n\n// For testing\nKmlDataSource._DeferredLoading = DeferredLoading;\nKmlDataSource._getTimestamp = getTimestamp;\n\nexport default KmlDataSource;\n"]},"metadata":{},"sourceType":"module"}