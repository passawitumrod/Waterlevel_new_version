{"ast":null,"code":"import AttributeCompression from \"../Core/AttributeCompression.js\";\nimport BoundingSphere from \"../Core/BoundingSphere.js\";\nimport Cartesian2 from \"../Core/Cartesian2.js\";\nimport Cartesian3 from \"../Core/Cartesian3.js\";\nimport Color from \"../Core/Color.js\";\nimport ComponentDatatype from \"../Core/ComponentDatatype.js\";\nimport defaultValue from \"../Core/defaultValue.js\";\nimport defined from \"../Core/defined.js\";\nimport destroyObject from \"../Core/destroyObject.js\";\nimport DeveloperError from \"../Core/DeveloperError.js\";\nimport EncodedCartesian3 from \"../Core/EncodedCartesian3.js\";\nimport IndexDatatype from \"../Core/IndexDatatype.js\";\nimport CesiumMath from \"../Core/Math.js\";\nimport Matrix4 from \"../Core/Matrix4.js\";\nimport WebGLConstants from \"../Core/WebGLConstants.js\";\nimport Buffer from \"../Renderer/Buffer.js\";\nimport BufferUsage from \"../Renderer/BufferUsage.js\";\nimport ContextLimits from \"../Renderer/ContextLimits.js\";\nimport DrawCommand from \"../Renderer/DrawCommand.js\";\nimport Pass from \"../Renderer/Pass.js\";\nimport RenderState from \"../Renderer/RenderState.js\";\nimport ShaderProgram from \"../Renderer/ShaderProgram.js\";\nimport ShaderSource from \"../Renderer/ShaderSource.js\";\nimport VertexArrayFacade from \"../Renderer/VertexArrayFacade.js\";\nimport BillboardCollectionFS from \"../Shaders/BillboardCollectionFS.js\";\nimport BillboardCollectionVS from \"../Shaders/BillboardCollectionVS.js\";\nimport Billboard from \"./Billboard.js\";\nimport BlendingState from \"./BlendingState.js\";\nimport BlendOption from \"./BlendOption.js\";\nimport HeightReference from \"./HeightReference.js\";\nimport HorizontalOrigin from \"./HorizontalOrigin.js\";\nimport SceneMode from \"./SceneMode.js\";\nimport SDFSettings from \"./SDFSettings.js\";\nimport TextureAtlas from \"./TextureAtlas.js\";\nimport VerticalOrigin from \"./VerticalOrigin.js\";\nvar SHOW_INDEX = Billboard.SHOW_INDEX;\nvar POSITION_INDEX = Billboard.POSITION_INDEX;\nvar PIXEL_OFFSET_INDEX = Billboard.PIXEL_OFFSET_INDEX;\nvar EYE_OFFSET_INDEX = Billboard.EYE_OFFSET_INDEX;\nvar HORIZONTAL_ORIGIN_INDEX = Billboard.HORIZONTAL_ORIGIN_INDEX;\nvar VERTICAL_ORIGIN_INDEX = Billboard.VERTICAL_ORIGIN_INDEX;\nvar SCALE_INDEX = Billboard.SCALE_INDEX;\nvar IMAGE_INDEX_INDEX = Billboard.IMAGE_INDEX_INDEX;\nvar COLOR_INDEX = Billboard.COLOR_INDEX;\nvar ROTATION_INDEX = Billboard.ROTATION_INDEX;\nvar ALIGNED_AXIS_INDEX = Billboard.ALIGNED_AXIS_INDEX;\nvar SCALE_BY_DISTANCE_INDEX = Billboard.SCALE_BY_DISTANCE_INDEX;\nvar TRANSLUCENCY_BY_DISTANCE_INDEX = Billboard.TRANSLUCENCY_BY_DISTANCE_INDEX;\nvar PIXEL_OFFSET_SCALE_BY_DISTANCE_INDEX = Billboard.PIXEL_OFFSET_SCALE_BY_DISTANCE_INDEX;\nvar DISTANCE_DISPLAY_CONDITION_INDEX = Billboard.DISTANCE_DISPLAY_CONDITION;\nvar DISABLE_DEPTH_DISTANCE = Billboard.DISABLE_DEPTH_DISTANCE;\nvar TEXTURE_COORDINATE_BOUNDS = Billboard.TEXTURE_COORDINATE_BOUNDS;\nvar SDF_INDEX = Billboard.SDF_INDEX;\nvar NUMBER_OF_PROPERTIES = Billboard.NUMBER_OF_PROPERTIES;\nvar attributeLocations;\nvar attributeLocationsBatched = {\n  positionHighAndScale: 0,\n  positionLowAndRotation: 1,\n  compressedAttribute0: 2,\n  // pixel offset, translate, horizontal origin, vertical origin, show, direction, texture coordinates\n  compressedAttribute1: 3,\n  // aligned axis, translucency by distance, image width\n  compressedAttribute2: 4,\n  // image height, color, pick color, size in meters, valid aligned axis, 13 bits free\n  eyeOffset: 5,\n  // 4 bytes free\n  scaleByDistance: 6,\n  pixelOffsetScaleByDistance: 7,\n  compressedAttribute3: 8,\n  textureCoordinateBoundsOrLabelTranslate: 9,\n  a_batchId: 10,\n  sdf: 11\n};\nvar attributeLocationsInstanced = {\n  direction: 0,\n  positionHighAndScale: 1,\n  positionLowAndRotation: 2,\n  // texture offset in w\n  compressedAttribute0: 3,\n  compressedAttribute1: 4,\n  compressedAttribute2: 5,\n  eyeOffset: 6,\n  // texture range in w\n  scaleByDistance: 7,\n  pixelOffsetScaleByDistance: 8,\n  compressedAttribute3: 9,\n  textureCoordinateBoundsOrLabelTranslate: 10,\n  a_batchId: 11,\n  sdf: 12\n};\n/**\n * A renderable collection of billboards.  Billboards are viewport-aligned\n * images positioned in the 3D scene.\n * <br /><br />\n * <div align='center'>\n * <img src='Images/Billboard.png' width='400' height='300' /><br />\n * Example billboards\n * </div>\n * <br /><br />\n * Billboards are added and removed from the collection using {@link BillboardCollection#add}\n * and {@link BillboardCollection#remove}.  Billboards in a collection automatically share textures\n * for images with the same identifier.\n *\n * @alias BillboardCollection\n * @constructor\n *\n * @param {Object} [options] Object with the following properties:\n * @param {Matrix4} [options.modelMatrix=Matrix4.IDENTITY] The 4x4 transformation matrix that transforms each billboard from model to world coordinates.\n * @param {Boolean} [options.debugShowBoundingVolume=false] For debugging only. Determines if this primitive's commands' bounding spheres are shown.\n * @param {Scene} [options.scene] Must be passed in for billboards that use the height reference property or will be depth tested against the globe.\n * @param {BlendOption} [options.blendOption=BlendOption.OPAQUE_AND_TRANSLUCENT] The billboard blending option. The default\n * is used for rendering both opaque and translucent billboards. However, if either all of the billboards are completely opaque or all are completely translucent,\n * setting the technique to BlendOption.OPAQUE or BlendOption.TRANSLUCENT can improve performance by up to 2x.\n *\n * @performance For best performance, prefer a few collections, each with many billboards, to\n * many collections with only a few billboards each.  Organize collections so that billboards\n * with the same update frequency are in the same collection, i.e., billboards that do not\n * change should be in one collection; billboards that change every frame should be in another\n * collection; and so on.\n *\n * @see BillboardCollection#add\n * @see BillboardCollection#remove\n * @see Billboard\n * @see LabelCollection\n *\n * @demo {@link https://sandcastle.cesium.com/index.html?src=Billboards.html|Cesium Sandcastle Billboard Demo}\n *\n * @example\n * // Create a billboard collection with two billboards\n * var billboards = scene.primitives.add(new Cesium.BillboardCollection());\n * billboards.add({\n *   position : new Cesium.Cartesian3(1.0, 2.0, 3.0),\n *   image : 'url/to/image'\n * });\n * billboards.add({\n *   position : new Cesium.Cartesian3(4.0, 5.0, 6.0),\n *   image : 'url/to/another/image'\n * });\n */\n\nfunction BillboardCollection(options) {\n  options = defaultValue(options, defaultValue.EMPTY_OBJECT);\n  this._scene = options.scene;\n  this._batchTable = options.batchTable;\n  this._textureAtlas = undefined;\n  this._textureAtlasGUID = undefined;\n  this._destroyTextureAtlas = true;\n  this._sp = undefined;\n  this._spTranslucent = undefined;\n  this._rsOpaque = undefined;\n  this._rsTranslucent = undefined;\n  this._vaf = undefined;\n  this._billboards = [];\n  this._billboardsToUpdate = [];\n  this._billboardsToUpdateIndex = 0;\n  this._billboardsRemoved = false;\n  this._createVertexArray = false;\n  this._shaderRotation = false;\n  this._compiledShaderRotation = false;\n  this._shaderAlignedAxis = false;\n  this._compiledShaderAlignedAxis = false;\n  this._shaderScaleByDistance = false;\n  this._compiledShaderScaleByDistance = false;\n  this._shaderTranslucencyByDistance = false;\n  this._compiledShaderTranslucencyByDistance = false;\n  this._shaderPixelOffsetScaleByDistance = false;\n  this._compiledShaderPixelOffsetScaleByDistance = false;\n  this._shaderDistanceDisplayCondition = false;\n  this._compiledShaderDistanceDisplayCondition = false;\n  this._shaderDisableDepthDistance = false;\n  this._compiledShaderDisableDepthDistance = false;\n  this._shaderClampToGround = false;\n  this._compiledShaderClampToGround = false;\n  this._propertiesChanged = new Uint32Array(NUMBER_OF_PROPERTIES);\n  this._maxSize = 0.0;\n  this._maxEyeOffset = 0.0;\n  this._maxScale = 1.0;\n  this._maxPixelOffset = 0.0;\n  this._allHorizontalCenter = true;\n  this._allVerticalCenter = true;\n  this._allSizedInMeters = true;\n  this._baseVolume = new BoundingSphere();\n  this._baseVolumeWC = new BoundingSphere();\n  this._baseVolume2D = new BoundingSphere();\n  this._boundingVolume = new BoundingSphere();\n  this._boundingVolumeDirty = false;\n  this._colorCommands = [];\n  /**\n   * The 4x4 transformation matrix that transforms each billboard in this collection from model to world coordinates.\n   * When this is the identity matrix, the billboards are drawn in world coordinates, i.e., Earth's WGS84 coordinates.\n   * Local reference frames can be used by providing a different transformation matrix, like that returned\n   * by {@link Transforms.eastNorthUpToFixedFrame}.\n   *\n   * @type {Matrix4}\n   * @default {@link Matrix4.IDENTITY}\n   *\n   *\n   * @example\n   * var center = Cesium.Cartesian3.fromDegrees(-75.59777, 40.03883);\n   * billboards.modelMatrix = Cesium.Transforms.eastNorthUpToFixedFrame(center);\n   * billboards.add({\n   *   image : 'url/to/image',\n   *   position : new Cesium.Cartesian3(0.0, 0.0, 0.0) // center\n   * });\n   * billboards.add({\n   *   image : 'url/to/image',\n   *   position : new Cesium.Cartesian3(1000000.0, 0.0, 0.0) // east\n   * });\n   * billboards.add({\n   *   image : 'url/to/image',\n   *   position : new Cesium.Cartesian3(0.0, 1000000.0, 0.0) // north\n   * });\n   * billboards.add({\n   *   image : 'url/to/image',\n   *   position : new Cesium.Cartesian3(0.0, 0.0, 1000000.0) // up\n   * });\n   *\n   * @see Transforms.eastNorthUpToFixedFrame\n   */\n\n  this.modelMatrix = Matrix4.clone(defaultValue(options.modelMatrix, Matrix4.IDENTITY));\n  this._modelMatrix = Matrix4.clone(Matrix4.IDENTITY);\n  /**\n   * This property is for debugging only; it is not for production use nor is it optimized.\n   * <p>\n   * Draws the bounding sphere for each draw command in the primitive.\n   * </p>\n   *\n   * @type {Boolean}\n   *\n   * @default false\n   */\n\n  this.debugShowBoundingVolume = defaultValue(options.debugShowBoundingVolume, false);\n  /**\n   * This property is for debugging only; it is not for production use nor is it optimized.\n   * <p>\n   * Draws the texture atlas for this BillboardCollection as a fullscreen quad.\n   * </p>\n   *\n   * @type {Boolean}\n   *\n   * @default false\n   */\n\n  this.debugShowTextureAtlas = defaultValue(options.debugShowTextureAtlas, false);\n  /**\n   * The billboard blending option. The default is used for rendering both opaque and translucent billboards.\n   * However, if either all of the billboards are completely opaque or all are completely translucent,\n   * setting the technique to BlendOption.OPAQUE or BlendOption.TRANSLUCENT can improve\n   * performance by up to 2x.\n   * @type {BlendOption}\n   * @default BlendOption.OPAQUE_AND_TRANSLUCENT\n   */\n\n  this.blendOption = defaultValue(options.blendOption, BlendOption.OPAQUE_AND_TRANSLUCENT);\n  this._blendOption = undefined;\n  this._mode = SceneMode.SCENE3D; // The buffer usage for each attribute is determined based on the usage of the attribute over time.\n\n  this._buffersUsage = [BufferUsage.STATIC_DRAW, // SHOW_INDEX\n  BufferUsage.STATIC_DRAW, // POSITION_INDEX\n  BufferUsage.STATIC_DRAW, // PIXEL_OFFSET_INDEX\n  BufferUsage.STATIC_DRAW, // EYE_OFFSET_INDEX\n  BufferUsage.STATIC_DRAW, // HORIZONTAL_ORIGIN_INDEX\n  BufferUsage.STATIC_DRAW, // VERTICAL_ORIGIN_INDEX\n  BufferUsage.STATIC_DRAW, // SCALE_INDEX\n  BufferUsage.STATIC_DRAW, // IMAGE_INDEX_INDEX\n  BufferUsage.STATIC_DRAW, // COLOR_INDEX\n  BufferUsage.STATIC_DRAW, // ROTATION_INDEX\n  BufferUsage.STATIC_DRAW, // ALIGNED_AXIS_INDEX\n  BufferUsage.STATIC_DRAW, // SCALE_BY_DISTANCE_INDEX\n  BufferUsage.STATIC_DRAW, // TRANSLUCENCY_BY_DISTANCE_INDEX\n  BufferUsage.STATIC_DRAW, // PIXEL_OFFSET_SCALE_BY_DISTANCE_INDEX\n  BufferUsage.STATIC_DRAW, // DISTANCE_DISPLAY_CONDITION_INDEX\n  BufferUsage.STATIC_DRAW // TEXTURE_COORDINATE_BOUNDS\n  ];\n  this._highlightColor = Color.clone(Color.WHITE); // Only used by Vector3DTilePoints\n\n  var that = this;\n  this._uniforms = {\n    u_atlas: function () {\n      return that._textureAtlas.texture;\n    },\n    u_highlightColor: function () {\n      return that._highlightColor;\n    }\n  };\n  var scene = this._scene;\n\n  if (defined(scene) && defined(scene.terrainProviderChanged)) {\n    this._removeCallbackFunc = scene.terrainProviderChanged.addEventListener(function () {\n      var billboards = this._billboards;\n      var length = billboards.length;\n\n      for (var i = 0; i < length; ++i) {\n        billboards[i]._updateClamping();\n      }\n    }, this);\n  }\n}\n\nObject.defineProperties(BillboardCollection.prototype, {\n  /**\n   * Returns the number of billboards in this collection.  This is commonly used with\n   * {@link BillboardCollection#get} to iterate over all the billboards\n   * in the collection.\n   * @memberof BillboardCollection.prototype\n   * @type {Number}\n   */\n  length: {\n    get: function () {\n      removeBillboards(this);\n      return this._billboards.length;\n    }\n  },\n\n  /**\n   * Gets or sets the textureAtlas.\n   * @memberof BillboardCollection.prototype\n   * @type {TextureAtlas}\n   * @private\n   */\n  textureAtlas: {\n    get: function () {\n      return this._textureAtlas;\n    },\n    set: function (value) {\n      if (this._textureAtlas !== value) {\n        this._textureAtlas = this._destroyTextureAtlas && this._textureAtlas && this._textureAtlas.destroy();\n        this._textureAtlas = value;\n        this._createVertexArray = true; // New per-billboard texture coordinates\n      }\n    }\n  },\n\n  /**\n   * Gets or sets a value which determines if the texture atlas is\n   * destroyed when the collection is destroyed.\n   *\n   * If the texture atlas is used by more than one collection, set this to <code>false</code>,\n   * and explicitly destroy the atlas to avoid attempting to destroy it multiple times.\n   *\n   * @memberof BillboardCollection.prototype\n   * @type {Boolean}\n   * @private\n   *\n   * @example\n   * // Set destroyTextureAtlas\n   * // Destroy a billboard collection but not its texture atlas.\n   *\n   * var atlas = new TextureAtlas({\n   *   scene : scene,\n   *   images : images\n   * });\n   * billboards.textureAtlas = atlas;\n   * billboards.destroyTextureAtlas = false;\n   * billboards = billboards.destroy();\n   * console.log(atlas.isDestroyed()); // False\n   */\n  destroyTextureAtlas: {\n    get: function () {\n      return this._destroyTextureAtlas;\n    },\n    set: function (value) {\n      this._destroyTextureAtlas = value;\n    }\n  }\n});\n\nfunction destroyBillboards(billboards) {\n  var length = billboards.length;\n\n  for (var i = 0; i < length; ++i) {\n    if (billboards[i]) {\n      billboards[i]._destroy();\n    }\n  }\n}\n/**\n * Creates and adds a billboard with the specified initial properties to the collection.\n * The added billboard is returned so it can be modified or removed from the collection later.\n *\n * @param {Object}[options] A template describing the billboard's properties as shown in Example 1.\n * @returns {Billboard} The billboard that was added to the collection.\n *\n * @performance Calling <code>add</code> is expected constant time.  However, the collection's vertex buffer\n * is rewritten - an <code>O(n)</code> operation that also incurs CPU to GPU overhead.  For\n * best performance, add as many billboards as possible before calling <code>update</code>.\n *\n * @exception {DeveloperError} This object was destroyed, i.e., destroy() was called.\n *\n *\n * @example\n * // Example 1:  Add a billboard, specifying all the default values.\n * var b = billboards.add({\n *   show : true,\n *   position : Cesium.Cartesian3.ZERO,\n *   pixelOffset : Cesium.Cartesian2.ZERO,\n *   eyeOffset : Cesium.Cartesian3.ZERO,\n *   heightReference : Cesium.HeightReference.NONE,\n *   horizontalOrigin : Cesium.HorizontalOrigin.CENTER,\n *   verticalOrigin : Cesium.VerticalOrigin.CENTER,\n *   scale : 1.0,\n *   image : 'url/to/image',\n *   imageSubRegion : undefined,\n *   color : Cesium.Color.WHITE,\n *   id : undefined,\n *   rotation : 0.0,\n *   alignedAxis : Cesium.Cartesian3.ZERO,\n *   width : undefined,\n *   height : undefined,\n *   scaleByDistance : undefined,\n *   translucencyByDistance : undefined,\n *   pixelOffsetScaleByDistance : undefined,\n *   sizeInMeters : false,\n *   distanceDisplayCondition : undefined\n * });\n *\n * @example\n * // Example 2:  Specify only the billboard's cartographic position.\n * var b = billboards.add({\n *   position : Cesium.Cartesian3.fromDegrees(longitude, latitude, height)\n * });\n *\n * @see BillboardCollection#remove\n * @see BillboardCollection#removeAll\n */\n\n\nBillboardCollection.prototype.add = function (options) {\n  var b = new Billboard(options, this);\n  b._index = this._billboards.length;\n\n  this._billboards.push(b);\n\n  this._createVertexArray = true;\n  return b;\n};\n/**\n * Removes a billboard from the collection.\n *\n * @param {Billboard} billboard The billboard to remove.\n * @returns {Boolean} <code>true</code> if the billboard was removed; <code>false</code> if the billboard was not found in the collection.\n *\n * @performance Calling <code>remove</code> is expected constant time.  However, the collection's vertex buffer\n * is rewritten - an <code>O(n)</code> operation that also incurs CPU to GPU overhead.  For\n * best performance, remove as many billboards as possible before calling <code>update</code>.\n * If you intend to temporarily hide a billboard, it is usually more efficient to call\n * {@link Billboard#show} instead of removing and re-adding the billboard.\n *\n * @exception {DeveloperError} This object was destroyed, i.e., destroy() was called.\n *\n *\n * @example\n * var b = billboards.add(...);\n * billboards.remove(b);  // Returns true\n *\n * @see BillboardCollection#add\n * @see BillboardCollection#removeAll\n * @see Billboard#show\n */\n\n\nBillboardCollection.prototype.remove = function (billboard) {\n  if (this.contains(billboard)) {\n    this._billboards[billboard._index] = null; // Removed later\n\n    this._billboardsRemoved = true;\n    this._createVertexArray = true;\n\n    billboard._destroy();\n\n    return true;\n  }\n\n  return false;\n};\n/**\n * Removes all billboards from the collection.\n *\n * @performance <code>O(n)</code>.  It is more efficient to remove all the billboards\n * from a collection and then add new ones than to create a new collection entirely.\n *\n * @exception {DeveloperError} This object was destroyed, i.e., destroy() was called.\n *\n *\n * @example\n * billboards.add(...);\n * billboards.add(...);\n * billboards.removeAll();\n *\n * @see BillboardCollection#add\n * @see BillboardCollection#remove\n */\n\n\nBillboardCollection.prototype.removeAll = function () {\n  destroyBillboards(this._billboards);\n  this._billboards = [];\n  this._billboardsToUpdate = [];\n  this._billboardsToUpdateIndex = 0;\n  this._billboardsRemoved = false;\n  this._createVertexArray = true;\n};\n\nfunction removeBillboards(billboardCollection) {\n  if (billboardCollection._billboardsRemoved) {\n    billboardCollection._billboardsRemoved = false;\n    var newBillboards = [];\n    var billboards = billboardCollection._billboards;\n    var length = billboards.length;\n\n    for (var i = 0, j = 0; i < length; ++i) {\n      var billboard = billboards[i];\n\n      if (billboard) {\n        billboard._index = j++;\n        newBillboards.push(billboard);\n      }\n    }\n\n    billboardCollection._billboards = newBillboards;\n  }\n}\n\nBillboardCollection.prototype._updateBillboard = function (billboard, propertyChanged) {\n  if (!billboard._dirty) {\n    this._billboardsToUpdate[this._billboardsToUpdateIndex++] = billboard;\n  }\n\n  ++this._propertiesChanged[propertyChanged];\n};\n/**\n * Check whether this collection contains a given billboard.\n *\n * @param {Billboard} [billboard] The billboard to check for.\n * @returns {Boolean} true if this collection contains the billboard, false otherwise.\n *\n * @see BillboardCollection#get\n */\n\n\nBillboardCollection.prototype.contains = function (billboard) {\n  return defined(billboard) && billboard._billboardCollection === this;\n};\n/**\n * Returns the billboard in the collection at the specified index.  Indices are zero-based\n * and increase as billboards are added.  Removing a billboard shifts all billboards after\n * it to the left, changing their indices.  This function is commonly used with\n * {@link BillboardCollection#length} to iterate over all the billboards\n * in the collection.\n *\n * @param {Number} index The zero-based index of the billboard.\n * @returns {Billboard} The billboard at the specified index.\n *\n * @performance Expected constant time.  If billboards were removed from the collection and\n * {@link BillboardCollection#update} was not called, an implicit <code>O(n)</code>\n * operation is performed.\n *\n * @exception {DeveloperError} This object was destroyed, i.e., destroy() was called.\n *\n *\n * @example\n * // Toggle the show property of every billboard in the collection\n * var len = billboards.length;\n * for (var i = 0; i < len; ++i) {\n *   var b = billboards.get(i);\n *   b.show = !b.show;\n * }\n *\n * @see BillboardCollection#length\n */\n\n\nBillboardCollection.prototype.get = function (index) {\n  //>>includeStart('debug', pragmas.debug);\n  if (!defined(index)) {\n    throw new DeveloperError(\"index is required.\");\n  } //>>includeEnd('debug');\n\n\n  removeBillboards(this);\n  return this._billboards[index];\n};\n\nvar getIndexBuffer;\n\nfunction getIndexBufferBatched(context) {\n  var sixteenK = 16 * 1024;\n  var indexBuffer = context.cache.billboardCollection_indexBufferBatched;\n\n  if (defined(indexBuffer)) {\n    return indexBuffer;\n  } // Subtract 6 because the last index is reserverd for primitive restart.\n  // https://www.khronos.org/registry/webgl/specs/latest/2.0/#5.18\n\n\n  var length = sixteenK * 6 - 6;\n  var indices = new Uint16Array(length);\n\n  for (var i = 0, j = 0; i < length; i += 6, j += 4) {\n    indices[i] = j;\n    indices[i + 1] = j + 1;\n    indices[i + 2] = j + 2;\n    indices[i + 3] = j + 0;\n    indices[i + 4] = j + 2;\n    indices[i + 5] = j + 3;\n  } // PERFORMANCE_IDEA:  Should we reference count billboard collections, and eventually delete this?\n  // Is this too much memory to allocate up front?  Should we dynamically grow it?\n\n\n  indexBuffer = Buffer.createIndexBuffer({\n    context: context,\n    typedArray: indices,\n    usage: BufferUsage.STATIC_DRAW,\n    indexDatatype: IndexDatatype.UNSIGNED_SHORT\n  });\n  indexBuffer.vertexArrayDestroyable = false;\n  context.cache.billboardCollection_indexBufferBatched = indexBuffer;\n  return indexBuffer;\n}\n\nfunction getIndexBufferInstanced(context) {\n  var indexBuffer = context.cache.billboardCollection_indexBufferInstanced;\n\n  if (defined(indexBuffer)) {\n    return indexBuffer;\n  }\n\n  indexBuffer = Buffer.createIndexBuffer({\n    context: context,\n    typedArray: new Uint16Array([0, 1, 2, 0, 2, 3]),\n    usage: BufferUsage.STATIC_DRAW,\n    indexDatatype: IndexDatatype.UNSIGNED_SHORT\n  });\n  indexBuffer.vertexArrayDestroyable = false;\n  context.cache.billboardCollection_indexBufferInstanced = indexBuffer;\n  return indexBuffer;\n}\n\nfunction getVertexBufferInstanced(context) {\n  var vertexBuffer = context.cache.billboardCollection_vertexBufferInstanced;\n\n  if (defined(vertexBuffer)) {\n    return vertexBuffer;\n  }\n\n  vertexBuffer = Buffer.createVertexBuffer({\n    context: context,\n    typedArray: new Float32Array([0.0, 0.0, 1.0, 0.0, 1.0, 1.0, 0.0, 1.0]),\n    usage: BufferUsage.STATIC_DRAW\n  });\n  vertexBuffer.vertexArrayDestroyable = false;\n  context.cache.billboardCollection_vertexBufferInstanced = vertexBuffer;\n  return vertexBuffer;\n}\n\nBillboardCollection.prototype.computeNewBuffersUsage = function () {\n  var buffersUsage = this._buffersUsage;\n  var usageChanged = false;\n  var properties = this._propertiesChanged;\n\n  for (var k = 0; k < NUMBER_OF_PROPERTIES; ++k) {\n    var newUsage = properties[k] === 0 ? BufferUsage.STATIC_DRAW : BufferUsage.STREAM_DRAW;\n    usageChanged = usageChanged || buffersUsage[k] !== newUsage;\n    buffersUsage[k] = newUsage;\n  }\n\n  return usageChanged;\n};\n\nfunction createVAF(context, numberOfBillboards, buffersUsage, instanced, batchTable, sdf) {\n  var attributes = [{\n    index: attributeLocations.positionHighAndScale,\n    componentsPerAttribute: 4,\n    componentDatatype: ComponentDatatype.FLOAT,\n    usage: buffersUsage[POSITION_INDEX]\n  }, {\n    index: attributeLocations.positionLowAndRotation,\n    componentsPerAttribute: 4,\n    componentDatatype: ComponentDatatype.FLOAT,\n    usage: buffersUsage[POSITION_INDEX]\n  }, {\n    index: attributeLocations.compressedAttribute0,\n    componentsPerAttribute: 4,\n    componentDatatype: ComponentDatatype.FLOAT,\n    usage: buffersUsage[PIXEL_OFFSET_INDEX]\n  }, {\n    index: attributeLocations.compressedAttribute1,\n    componentsPerAttribute: 4,\n    componentDatatype: ComponentDatatype.FLOAT,\n    usage: buffersUsage[TRANSLUCENCY_BY_DISTANCE_INDEX]\n  }, {\n    index: attributeLocations.compressedAttribute2,\n    componentsPerAttribute: 4,\n    componentDatatype: ComponentDatatype.FLOAT,\n    usage: buffersUsage[COLOR_INDEX]\n  }, {\n    index: attributeLocations.eyeOffset,\n    componentsPerAttribute: 4,\n    componentDatatype: ComponentDatatype.FLOAT,\n    usage: buffersUsage[EYE_OFFSET_INDEX]\n  }, {\n    index: attributeLocations.scaleByDistance,\n    componentsPerAttribute: 4,\n    componentDatatype: ComponentDatatype.FLOAT,\n    usage: buffersUsage[SCALE_BY_DISTANCE_INDEX]\n  }, {\n    index: attributeLocations.pixelOffsetScaleByDistance,\n    componentsPerAttribute: 4,\n    componentDatatype: ComponentDatatype.FLOAT,\n    usage: buffersUsage[PIXEL_OFFSET_SCALE_BY_DISTANCE_INDEX]\n  }, {\n    index: attributeLocations.compressedAttribute3,\n    componentsPerAttribute: 4,\n    componentDatatype: ComponentDatatype.FLOAT,\n    usage: buffersUsage[DISTANCE_DISPLAY_CONDITION_INDEX]\n  }, {\n    index: attributeLocations.textureCoordinateBoundsOrLabelTranslate,\n    componentsPerAttribute: 4,\n    componentDatatype: ComponentDatatype.FLOAT,\n    usage: buffersUsage[TEXTURE_COORDINATE_BOUNDS]\n  }]; // Instancing requires one non-instanced attribute.\n\n  if (instanced) {\n    attributes.push({\n      index: attributeLocations.direction,\n      componentsPerAttribute: 2,\n      componentDatatype: ComponentDatatype.FLOAT,\n      vertexBuffer: getVertexBufferInstanced(context)\n    });\n  }\n\n  if (defined(batchTable)) {\n    attributes.push({\n      index: attributeLocations.a_batchId,\n      componentsPerAttribute: 1,\n      componentDatatyps: ComponentDatatype.FLOAT,\n      bufferUsage: BufferUsage.STATIC_DRAW\n    });\n  }\n\n  if (sdf) {\n    attributes.push({\n      index: attributeLocations.sdf,\n      componentsPerAttribute: 2,\n      componentDatatype: ComponentDatatype.FLOAT,\n      usage: buffersUsage[SDF_INDEX]\n    });\n  } // When instancing is enabled, only one vertex is needed for each billboard.\n\n\n  var sizeInVertices = instanced ? numberOfBillboards : 4 * numberOfBillboards;\n  return new VertexArrayFacade(context, attributes, sizeInVertices, instanced);\n} ///////////////////////////////////////////////////////////////////////////\n// Four vertices per billboard.  Each has the same position, etc., but a different screen-space direction vector.\n// PERFORMANCE_IDEA:  Save memory if a property is the same for all billboards, use a latched attribute state,\n// instead of storing it in a vertex buffer.\n\n\nvar writePositionScratch = new EncodedCartesian3();\n\nfunction writePositionScaleAndRotation(billboardCollection, context, textureAtlasCoordinates, vafWriters, billboard) {\n  var i;\n  var positionHighWriter = vafWriters[attributeLocations.positionHighAndScale];\n  var positionLowWriter = vafWriters[attributeLocations.positionLowAndRotation];\n\n  var position = billboard._getActualPosition();\n\n  if (billboardCollection._mode === SceneMode.SCENE3D) {\n    BoundingSphere.expand(billboardCollection._baseVolume, position, billboardCollection._baseVolume);\n    billboardCollection._boundingVolumeDirty = true;\n  }\n\n  EncodedCartesian3.fromCartesian(position, writePositionScratch);\n  var scale = billboard.scale;\n  var rotation = billboard.rotation;\n\n  if (rotation !== 0.0) {\n    billboardCollection._shaderRotation = true;\n  }\n\n  billboardCollection._maxScale = Math.max(billboardCollection._maxScale, scale);\n  var high = writePositionScratch.high;\n  var low = writePositionScratch.low;\n\n  if (billboardCollection._instanced) {\n    i = billboard._index;\n    positionHighWriter(i, high.x, high.y, high.z, scale);\n    positionLowWriter(i, low.x, low.y, low.z, rotation);\n  } else {\n    i = billboard._index * 4;\n    positionHighWriter(i + 0, high.x, high.y, high.z, scale);\n    positionHighWriter(i + 1, high.x, high.y, high.z, scale);\n    positionHighWriter(i + 2, high.x, high.y, high.z, scale);\n    positionHighWriter(i + 3, high.x, high.y, high.z, scale);\n    positionLowWriter(i + 0, low.x, low.y, low.z, rotation);\n    positionLowWriter(i + 1, low.x, low.y, low.z, rotation);\n    positionLowWriter(i + 2, low.x, low.y, low.z, rotation);\n    positionLowWriter(i + 3, low.x, low.y, low.z, rotation);\n  }\n}\n\nvar scratchCartesian2 = new Cartesian2();\nvar UPPER_BOUND = 32768.0; // 2^15\n\nvar LEFT_SHIFT16 = 65536.0; // 2^16\n\nvar LEFT_SHIFT12 = 4096.0; // 2^12\n\nvar LEFT_SHIFT8 = 256.0; // 2^8\n\nvar LEFT_SHIFT7 = 128.0;\nvar LEFT_SHIFT5 = 32.0;\nvar LEFT_SHIFT3 = 8.0;\nvar LEFT_SHIFT2 = 4.0;\nvar RIGHT_SHIFT8 = 1.0 / 256.0;\nvar LOWER_LEFT = 0.0;\nvar LOWER_RIGHT = 2.0;\nvar UPPER_RIGHT = 3.0;\nvar UPPER_LEFT = 1.0;\n\nfunction writeCompressedAttrib0(billboardCollection, context, textureAtlasCoordinates, vafWriters, billboard) {\n  var i;\n  var writer = vafWriters[attributeLocations.compressedAttribute0];\n  var pixelOffset = billboard.pixelOffset;\n  var pixelOffsetX = pixelOffset.x;\n  var pixelOffsetY = pixelOffset.y;\n  var translate = billboard._translate;\n  var translateX = translate.x;\n  var translateY = translate.y;\n  billboardCollection._maxPixelOffset = Math.max(billboardCollection._maxPixelOffset, Math.abs(pixelOffsetX + translateX), Math.abs(-pixelOffsetY + translateY));\n  var horizontalOrigin = billboard.horizontalOrigin;\n  var verticalOrigin = billboard._verticalOrigin;\n  var show = billboard.show && billboard.clusterShow; // If the color alpha is zero, do not show this billboard.  This lets us avoid providing\n  // color during the pick pass and also eliminates a discard in the fragment shader.\n\n  if (billboard.color.alpha === 0.0) {\n    show = false;\n  } // Raw billboards don't distinguish between BASELINE and BOTTOM, only LabelCollection does that.\n\n\n  if (verticalOrigin === VerticalOrigin.BASELINE) {\n    verticalOrigin = VerticalOrigin.BOTTOM;\n  }\n\n  billboardCollection._allHorizontalCenter = billboardCollection._allHorizontalCenter && horizontalOrigin === HorizontalOrigin.CENTER;\n  billboardCollection._allVerticalCenter = billboardCollection._allVerticalCenter && verticalOrigin === VerticalOrigin.CENTER;\n  var bottomLeftX = 0;\n  var bottomLeftY = 0;\n  var width = 0;\n  var height = 0;\n  var index = billboard._imageIndex;\n\n  if (index !== -1) {\n    var imageRectangle = textureAtlasCoordinates[index]; //>>includeStart('debug', pragmas.debug);\n\n    if (!defined(imageRectangle)) {\n      throw new DeveloperError(\"Invalid billboard image index: \" + index);\n    } //>>includeEnd('debug');\n\n\n    bottomLeftX = imageRectangle.x;\n    bottomLeftY = imageRectangle.y;\n    width = imageRectangle.width;\n    height = imageRectangle.height;\n  }\n\n  var topRightX = bottomLeftX + width;\n  var topRightY = bottomLeftY + height;\n  var compressed0 = Math.floor(CesiumMath.clamp(pixelOffsetX, -UPPER_BOUND, UPPER_BOUND) + UPPER_BOUND) * LEFT_SHIFT7;\n  compressed0 += (horizontalOrigin + 1.0) * LEFT_SHIFT5;\n  compressed0 += (verticalOrigin + 1.0) * LEFT_SHIFT3;\n  compressed0 += (show ? 1.0 : 0.0) * LEFT_SHIFT2;\n  var compressed1 = Math.floor(CesiumMath.clamp(pixelOffsetY, -UPPER_BOUND, UPPER_BOUND) + UPPER_BOUND) * LEFT_SHIFT8;\n  var compressed2 = Math.floor(CesiumMath.clamp(translateX, -UPPER_BOUND, UPPER_BOUND) + UPPER_BOUND) * LEFT_SHIFT8;\n  var tempTanslateY = (CesiumMath.clamp(translateY, -UPPER_BOUND, UPPER_BOUND) + UPPER_BOUND) * RIGHT_SHIFT8;\n  var upperTranslateY = Math.floor(tempTanslateY);\n  var lowerTranslateY = Math.floor((tempTanslateY - upperTranslateY) * LEFT_SHIFT8);\n  compressed1 += upperTranslateY;\n  compressed2 += lowerTranslateY;\n  scratchCartesian2.x = bottomLeftX;\n  scratchCartesian2.y = bottomLeftY;\n  var compressedTexCoordsLL = AttributeCompression.compressTextureCoordinates(scratchCartesian2);\n  scratchCartesian2.x = topRightX;\n  var compressedTexCoordsLR = AttributeCompression.compressTextureCoordinates(scratchCartesian2);\n  scratchCartesian2.y = topRightY;\n  var compressedTexCoordsUR = AttributeCompression.compressTextureCoordinates(scratchCartesian2);\n  scratchCartesian2.x = bottomLeftX;\n  var compressedTexCoordsUL = AttributeCompression.compressTextureCoordinates(scratchCartesian2);\n\n  if (billboardCollection._instanced) {\n    i = billboard._index;\n    writer(i, compressed0, compressed1, compressed2, compressedTexCoordsLL);\n  } else {\n    i = billboard._index * 4;\n    writer(i + 0, compressed0 + LOWER_LEFT, compressed1, compressed2, compressedTexCoordsLL);\n    writer(i + 1, compressed0 + LOWER_RIGHT, compressed1, compressed2, compressedTexCoordsLR);\n    writer(i + 2, compressed0 + UPPER_RIGHT, compressed1, compressed2, compressedTexCoordsUR);\n    writer(i + 3, compressed0 + UPPER_LEFT, compressed1, compressed2, compressedTexCoordsUL);\n  }\n}\n\nfunction writeCompressedAttrib1(billboardCollection, context, textureAtlasCoordinates, vafWriters, billboard) {\n  var i;\n  var writer = vafWriters[attributeLocations.compressedAttribute1];\n  var alignedAxis = billboard.alignedAxis;\n\n  if (!Cartesian3.equals(alignedAxis, Cartesian3.ZERO)) {\n    billboardCollection._shaderAlignedAxis = true;\n  }\n\n  var near = 0.0;\n  var nearValue = 1.0;\n  var far = 1.0;\n  var farValue = 1.0;\n  var translucency = billboard.translucencyByDistance;\n\n  if (defined(translucency)) {\n    near = translucency.near;\n    nearValue = translucency.nearValue;\n    far = translucency.far;\n    farValue = translucency.farValue;\n\n    if (nearValue !== 1.0 || farValue !== 1.0) {\n      // translucency by distance calculation in shader need not be enabled\n      // until a billboard with near and far !== 1.0 is found\n      billboardCollection._shaderTranslucencyByDistance = true;\n    }\n  }\n\n  var width = 0;\n  var index = billboard._imageIndex;\n\n  if (index !== -1) {\n    var imageRectangle = textureAtlasCoordinates[index]; //>>includeStart('debug', pragmas.debug);\n\n    if (!defined(imageRectangle)) {\n      throw new DeveloperError(\"Invalid billboard image index: \" + index);\n    } //>>includeEnd('debug');\n\n\n    width = imageRectangle.width;\n  }\n\n  var textureWidth = billboardCollection._textureAtlas.texture.width;\n  var imageWidth = Math.round(defaultValue(billboard.width, textureWidth * width));\n  billboardCollection._maxSize = Math.max(billboardCollection._maxSize, imageWidth);\n  var compressed0 = CesiumMath.clamp(imageWidth, 0.0, LEFT_SHIFT16);\n  var compressed1 = 0.0;\n\n  if (Math.abs(Cartesian3.magnitudeSquared(alignedAxis) - 1.0) < CesiumMath.EPSILON6) {\n    compressed1 = AttributeCompression.octEncodeFloat(alignedAxis);\n  }\n\n  nearValue = CesiumMath.clamp(nearValue, 0.0, 1.0);\n  nearValue = nearValue === 1.0 ? 255.0 : nearValue * 255.0 | 0;\n  compressed0 = compressed0 * LEFT_SHIFT8 + nearValue;\n  farValue = CesiumMath.clamp(farValue, 0.0, 1.0);\n  farValue = farValue === 1.0 ? 255.0 : farValue * 255.0 | 0;\n  compressed1 = compressed1 * LEFT_SHIFT8 + farValue;\n\n  if (billboardCollection._instanced) {\n    i = billboard._index;\n    writer(i, compressed0, compressed1, near, far);\n  } else {\n    i = billboard._index * 4;\n    writer(i + 0, compressed0, compressed1, near, far);\n    writer(i + 1, compressed0, compressed1, near, far);\n    writer(i + 2, compressed0, compressed1, near, far);\n    writer(i + 3, compressed0, compressed1, near, far);\n  }\n}\n\nfunction writeCompressedAttrib2(billboardCollection, context, textureAtlasCoordinates, vafWriters, billboard) {\n  var i;\n  var writer = vafWriters[attributeLocations.compressedAttribute2];\n  var color = billboard.color;\n  var pickColor = !defined(billboardCollection._batchTable) ? billboard.getPickId(context).color : Color.WHITE;\n  var sizeInMeters = billboard.sizeInMeters ? 1.0 : 0.0;\n  var validAlignedAxis = Math.abs(Cartesian3.magnitudeSquared(billboard.alignedAxis) - 1.0) < CesiumMath.EPSILON6 ? 1.0 : 0.0;\n  billboardCollection._allSizedInMeters = billboardCollection._allSizedInMeters && sizeInMeters === 1.0;\n  var height = 0;\n  var index = billboard._imageIndex;\n\n  if (index !== -1) {\n    var imageRectangle = textureAtlasCoordinates[index]; //>>includeStart('debug', pragmas.debug);\n\n    if (!defined(imageRectangle)) {\n      throw new DeveloperError(\"Invalid billboard image index: \" + index);\n    } //>>includeEnd('debug');\n\n\n    height = imageRectangle.height;\n  }\n\n  var dimensions = billboardCollection._textureAtlas.texture.dimensions;\n  var imageHeight = Math.round(defaultValue(billboard.height, dimensions.y * height));\n  billboardCollection._maxSize = Math.max(billboardCollection._maxSize, imageHeight);\n  var labelHorizontalOrigin = defaultValue(billboard._labelHorizontalOrigin, -2);\n  labelHorizontalOrigin += 2;\n  var compressed3 = imageHeight * LEFT_SHIFT2 + labelHorizontalOrigin;\n  var red = Color.floatToByte(color.red);\n  var green = Color.floatToByte(color.green);\n  var blue = Color.floatToByte(color.blue);\n  var compressed0 = red * LEFT_SHIFT16 + green * LEFT_SHIFT8 + blue;\n  red = Color.floatToByte(pickColor.red);\n  green = Color.floatToByte(pickColor.green);\n  blue = Color.floatToByte(pickColor.blue);\n  var compressed1 = red * LEFT_SHIFT16 + green * LEFT_SHIFT8 + blue;\n  var compressed2 = Color.floatToByte(color.alpha) * LEFT_SHIFT16 + Color.floatToByte(pickColor.alpha) * LEFT_SHIFT8;\n  compressed2 += sizeInMeters * 2.0 + validAlignedAxis;\n\n  if (billboardCollection._instanced) {\n    i = billboard._index;\n    writer(i, compressed0, compressed1, compressed2, compressed3);\n  } else {\n    i = billboard._index * 4;\n    writer(i + 0, compressed0, compressed1, compressed2, compressed3);\n    writer(i + 1, compressed0, compressed1, compressed2, compressed3);\n    writer(i + 2, compressed0, compressed1, compressed2, compressed3);\n    writer(i + 3, compressed0, compressed1, compressed2, compressed3);\n  }\n}\n\nfunction writeEyeOffset(billboardCollection, context, textureAtlasCoordinates, vafWriters, billboard) {\n  var i;\n  var writer = vafWriters[attributeLocations.eyeOffset];\n  var eyeOffset = billboard.eyeOffset; // For billboards that are clamped to ground, move it slightly closer to the camera\n\n  var eyeOffsetZ = eyeOffset.z;\n\n  if (billboard._heightReference !== HeightReference.NONE) {\n    eyeOffsetZ *= 1.005;\n  }\n\n  billboardCollection._maxEyeOffset = Math.max(billboardCollection._maxEyeOffset, Math.abs(eyeOffset.x), Math.abs(eyeOffset.y), Math.abs(eyeOffsetZ));\n\n  if (billboardCollection._instanced) {\n    var width = 0;\n    var height = 0;\n    var index = billboard._imageIndex;\n\n    if (index !== -1) {\n      var imageRectangle = textureAtlasCoordinates[index]; //>>includeStart('debug', pragmas.debug);\n\n      if (!defined(imageRectangle)) {\n        throw new DeveloperError(\"Invalid billboard image index: \" + index);\n      } //>>includeEnd('debug');\n\n\n      width = imageRectangle.width;\n      height = imageRectangle.height;\n    }\n\n    scratchCartesian2.x = width;\n    scratchCartesian2.y = height;\n    var compressedTexCoordsRange = AttributeCompression.compressTextureCoordinates(scratchCartesian2);\n    i = billboard._index;\n    writer(i, eyeOffset.x, eyeOffset.y, eyeOffsetZ, compressedTexCoordsRange);\n  } else {\n    i = billboard._index * 4;\n    writer(i + 0, eyeOffset.x, eyeOffset.y, eyeOffsetZ, 0.0);\n    writer(i + 1, eyeOffset.x, eyeOffset.y, eyeOffsetZ, 0.0);\n    writer(i + 2, eyeOffset.x, eyeOffset.y, eyeOffsetZ, 0.0);\n    writer(i + 3, eyeOffset.x, eyeOffset.y, eyeOffsetZ, 0.0);\n  }\n}\n\nfunction writeScaleByDistance(billboardCollection, context, textureAtlasCoordinates, vafWriters, billboard) {\n  var i;\n  var writer = vafWriters[attributeLocations.scaleByDistance];\n  var near = 0.0;\n  var nearValue = 1.0;\n  var far = 1.0;\n  var farValue = 1.0;\n  var scale = billboard.scaleByDistance;\n\n  if (defined(scale)) {\n    near = scale.near;\n    nearValue = scale.nearValue;\n    far = scale.far;\n    farValue = scale.farValue;\n\n    if (nearValue !== 1.0 || farValue !== 1.0) {\n      // scale by distance calculation in shader need not be enabled\n      // until a billboard with near and far !== 1.0 is found\n      billboardCollection._shaderScaleByDistance = true;\n    }\n  }\n\n  if (billboardCollection._instanced) {\n    i = billboard._index;\n    writer(i, near, nearValue, far, farValue);\n  } else {\n    i = billboard._index * 4;\n    writer(i + 0, near, nearValue, far, farValue);\n    writer(i + 1, near, nearValue, far, farValue);\n    writer(i + 2, near, nearValue, far, farValue);\n    writer(i + 3, near, nearValue, far, farValue);\n  }\n}\n\nfunction writePixelOffsetScaleByDistance(billboardCollection, context, textureAtlasCoordinates, vafWriters, billboard) {\n  var i;\n  var writer = vafWriters[attributeLocations.pixelOffsetScaleByDistance];\n  var near = 0.0;\n  var nearValue = 1.0;\n  var far = 1.0;\n  var farValue = 1.0;\n  var pixelOffsetScale = billboard.pixelOffsetScaleByDistance;\n\n  if (defined(pixelOffsetScale)) {\n    near = pixelOffsetScale.near;\n    nearValue = pixelOffsetScale.nearValue;\n    far = pixelOffsetScale.far;\n    farValue = pixelOffsetScale.farValue;\n\n    if (nearValue !== 1.0 || farValue !== 1.0) {\n      // pixelOffsetScale by distance calculation in shader need not be enabled\n      // until a billboard with near and far !== 1.0 is found\n      billboardCollection._shaderPixelOffsetScaleByDistance = true;\n    }\n  }\n\n  if (billboardCollection._instanced) {\n    i = billboard._index;\n    writer(i, near, nearValue, far, farValue);\n  } else {\n    i = billboard._index * 4;\n    writer(i + 0, near, nearValue, far, farValue);\n    writer(i + 1, near, nearValue, far, farValue);\n    writer(i + 2, near, nearValue, far, farValue);\n    writer(i + 3, near, nearValue, far, farValue);\n  }\n}\n\nfunction writeCompressedAttribute3(billboardCollection, context, textureAtlasCoordinates, vafWriters, billboard) {\n  var i;\n  var writer = vafWriters[attributeLocations.compressedAttribute3];\n  var near = 0.0;\n  var far = Number.MAX_VALUE;\n  var distanceDisplayCondition = billboard.distanceDisplayCondition;\n\n  if (defined(distanceDisplayCondition)) {\n    near = distanceDisplayCondition.near;\n    far = distanceDisplayCondition.far;\n    near *= near;\n    far *= far;\n    billboardCollection._shaderDistanceDisplayCondition = true;\n  }\n\n  var disableDepthTestDistance = billboard.disableDepthTestDistance;\n  var clampToGround = billboard.heightReference === HeightReference.CLAMP_TO_GROUND && billboardCollection._scene.context.depthTexture;\n\n  if (!defined(disableDepthTestDistance)) {\n    disableDepthTestDistance = clampToGround ? 5000.0 : 0.0;\n  }\n\n  disableDepthTestDistance *= disableDepthTestDistance;\n\n  if (clampToGround || disableDepthTestDistance > 0.0) {\n    billboardCollection._shaderDisableDepthDistance = true;\n\n    if (disableDepthTestDistance === Number.POSITIVE_INFINITY) {\n      disableDepthTestDistance = -1.0;\n    }\n  }\n\n  var imageHeight;\n  var imageWidth;\n\n  if (!defined(billboard._labelDimensions)) {\n    var height = 0;\n    var width = 0;\n    var index = billboard._imageIndex;\n\n    if (index !== -1) {\n      var imageRectangle = textureAtlasCoordinates[index]; //>>includeStart('debug', pragmas.debug);\n\n      if (!defined(imageRectangle)) {\n        throw new DeveloperError(\"Invalid billboard image index: \" + index);\n      } //>>includeEnd('debug');\n\n\n      height = imageRectangle.height;\n      width = imageRectangle.width;\n    }\n\n    imageHeight = Math.round(defaultValue(billboard.height, billboardCollection._textureAtlas.texture.dimensions.y * height));\n    var textureWidth = billboardCollection._textureAtlas.texture.width;\n    imageWidth = Math.round(defaultValue(billboard.width, textureWidth * width));\n  } else {\n    imageWidth = billboard._labelDimensions.x;\n    imageHeight = billboard._labelDimensions.y;\n  }\n\n  var w = Math.floor(CesiumMath.clamp(imageWidth, 0.0, LEFT_SHIFT12));\n  var h = Math.floor(CesiumMath.clamp(imageHeight, 0.0, LEFT_SHIFT12));\n  var dimensions = w * LEFT_SHIFT12 + h;\n\n  if (billboardCollection._instanced) {\n    i = billboard._index;\n    writer(i, near, far, disableDepthTestDistance, dimensions);\n  } else {\n    i = billboard._index * 4;\n    writer(i + 0, near, far, disableDepthTestDistance, dimensions);\n    writer(i + 1, near, far, disableDepthTestDistance, dimensions);\n    writer(i + 2, near, far, disableDepthTestDistance, dimensions);\n    writer(i + 3, near, far, disableDepthTestDistance, dimensions);\n  }\n}\n\nfunction writeTextureCoordinateBoundsOrLabelTranslate(billboardCollection, context, textureAtlasCoordinates, vafWriters, billboard) {\n  if (billboard.heightReference === HeightReference.CLAMP_TO_GROUND) {\n    billboardCollection._shaderClampToGround = billboardCollection._scene.context.depthTexture;\n  }\n\n  var i;\n  var writer = vafWriters[attributeLocations.textureCoordinateBoundsOrLabelTranslate];\n\n  if (ContextLimits.maximumVertexTextureImageUnits > 0) {\n    //write _labelTranslate, used by depth testing in the vertex shader\n    var translateX = 0;\n    var translateY = 0;\n\n    if (defined(billboard._labelTranslate)) {\n      translateX = billboard._labelTranslate.x;\n      translateY = billboard._labelTranslate.y;\n    }\n\n    if (billboardCollection._instanced) {\n      i = billboard._index;\n      writer(i, translateX, translateY, 0.0, 0.0);\n    } else {\n      i = billboard._index * 4;\n      writer(i + 0, translateX, translateY, 0.0, 0.0);\n      writer(i + 1, translateX, translateY, 0.0, 0.0);\n      writer(i + 2, translateX, translateY, 0.0, 0.0);\n      writer(i + 3, translateX, translateY, 0.0, 0.0);\n    }\n\n    return;\n  } //write texture coordinate bounds, used by depth testing in fragment shader\n\n\n  var minX = 0;\n  var minY = 0;\n  var width = 0;\n  var height = 0;\n  var index = billboard._imageIndex;\n\n  if (index !== -1) {\n    var imageRectangle = textureAtlasCoordinates[index]; //>>includeStart('debug', pragmas.debug);\n\n    if (!defined(imageRectangle)) {\n      throw new DeveloperError(\"Invalid billboard image index: \" + index);\n    } //>>includeEnd('debug');\n\n\n    minX = imageRectangle.x;\n    minY = imageRectangle.y;\n    width = imageRectangle.width;\n    height = imageRectangle.height;\n  }\n\n  var maxX = minX + width;\n  var maxY = minY + height;\n\n  if (billboardCollection._instanced) {\n    i = billboard._index;\n    writer(i, minX, minY, maxX, maxY);\n  } else {\n    i = billboard._index * 4;\n    writer(i + 0, minX, minY, maxX, maxY);\n    writer(i + 1, minX, minY, maxX, maxY);\n    writer(i + 2, minX, minY, maxX, maxY);\n    writer(i + 3, minX, minY, maxX, maxY);\n  }\n}\n\nfunction writeBatchId(billboardCollection, context, textureAtlasCoordinates, vafWriters, billboard) {\n  if (!defined(billboardCollection._batchTable)) {\n    return;\n  }\n\n  var writer = vafWriters[attributeLocations.a_batchId];\n  var id = billboard._batchIndex;\n  var i;\n\n  if (billboardCollection._instanced) {\n    i = billboard._index;\n    writer(i, id);\n  } else {\n    i = billboard._index * 4;\n    writer(i + 0, id);\n    writer(i + 1, id);\n    writer(i + 2, id);\n    writer(i + 3, id);\n  }\n}\n\nfunction writeSDF(billboardCollection, context, textureAtlasCoordinates, vafWriters, billboard) {\n  if (!billboardCollection._sdf) {\n    return;\n  }\n\n  var i;\n  var writer = vafWriters[attributeLocations.sdf];\n  var outlineColor = billboard.outlineColor;\n  var outlineWidth = billboard.outlineWidth;\n  var red = Color.floatToByte(outlineColor.red);\n  var green = Color.floatToByte(outlineColor.green);\n  var blue = Color.floatToByte(outlineColor.blue);\n  var compressed0 = red * LEFT_SHIFT16 + green * LEFT_SHIFT8 + blue; // Compute the relative outline distance\n\n  var outlineDistance = outlineWidth / SDFSettings.RADIUS;\n  var compressed1 = Color.floatToByte(outlineColor.alpha) * LEFT_SHIFT16 + Color.floatToByte(outlineDistance) * LEFT_SHIFT8;\n\n  if (billboardCollection._instanced) {\n    i = billboard._index;\n    writer(i, compressed0, compressed1);\n  } else {\n    i = billboard._index * 4;\n    writer(i + 0, compressed0 + LOWER_LEFT, compressed1);\n    writer(i + 1, compressed0 + LOWER_RIGHT, compressed1);\n    writer(i + 2, compressed0 + UPPER_RIGHT, compressed1);\n    writer(i + 3, compressed0 + UPPER_LEFT, compressed1);\n  }\n}\n\nfunction writeBillboard(billboardCollection, context, textureAtlasCoordinates, vafWriters, billboard) {\n  writePositionScaleAndRotation(billboardCollection, context, textureAtlasCoordinates, vafWriters, billboard);\n  writeCompressedAttrib0(billboardCollection, context, textureAtlasCoordinates, vafWriters, billboard);\n  writeCompressedAttrib1(billboardCollection, context, textureAtlasCoordinates, vafWriters, billboard);\n  writeCompressedAttrib2(billboardCollection, context, textureAtlasCoordinates, vafWriters, billboard);\n  writeEyeOffset(billboardCollection, context, textureAtlasCoordinates, vafWriters, billboard);\n  writeScaleByDistance(billboardCollection, context, textureAtlasCoordinates, vafWriters, billboard);\n  writePixelOffsetScaleByDistance(billboardCollection, context, textureAtlasCoordinates, vafWriters, billboard);\n  writeCompressedAttribute3(billboardCollection, context, textureAtlasCoordinates, vafWriters, billboard);\n  writeTextureCoordinateBoundsOrLabelTranslate(billboardCollection, context, textureAtlasCoordinates, vafWriters, billboard);\n  writeBatchId(billboardCollection, context, textureAtlasCoordinates, vafWriters, billboard);\n  writeSDF(billboardCollection, context, textureAtlasCoordinates, vafWriters, billboard);\n}\n\nfunction recomputeActualPositions(billboardCollection, billboards, length, frameState, modelMatrix, recomputeBoundingVolume) {\n  var boundingVolume;\n\n  if (frameState.mode === SceneMode.SCENE3D) {\n    boundingVolume = billboardCollection._baseVolume;\n    billboardCollection._boundingVolumeDirty = true;\n  } else {\n    boundingVolume = billboardCollection._baseVolume2D;\n  }\n\n  var positions = [];\n\n  for (var i = 0; i < length; ++i) {\n    var billboard = billboards[i];\n    var position = billboard.position;\n\n    var actualPosition = Billboard._computeActualPosition(billboard, position, frameState, modelMatrix);\n\n    if (defined(actualPosition)) {\n      billboard._setActualPosition(actualPosition);\n\n      if (recomputeBoundingVolume) {\n        positions.push(actualPosition);\n      } else {\n        BoundingSphere.expand(boundingVolume, actualPosition, boundingVolume);\n      }\n    }\n  }\n\n  if (recomputeBoundingVolume) {\n    BoundingSphere.fromPoints(positions, boundingVolume);\n  }\n}\n\nfunction updateMode(billboardCollection, frameState) {\n  var mode = frameState.mode;\n  var billboards = billboardCollection._billboards;\n  var billboardsToUpdate = billboardCollection._billboardsToUpdate;\n  var modelMatrix = billboardCollection._modelMatrix;\n\n  if (billboardCollection._createVertexArray || billboardCollection._mode !== mode || mode !== SceneMode.SCENE3D && !Matrix4.equals(modelMatrix, billboardCollection.modelMatrix)) {\n    billboardCollection._mode = mode;\n    Matrix4.clone(billboardCollection.modelMatrix, modelMatrix);\n    billboardCollection._createVertexArray = true;\n\n    if (mode === SceneMode.SCENE3D || mode === SceneMode.SCENE2D || mode === SceneMode.COLUMBUS_VIEW) {\n      recomputeActualPositions(billboardCollection, billboards, billboards.length, frameState, modelMatrix, true);\n    }\n  } else if (mode === SceneMode.MORPHING) {\n    recomputeActualPositions(billboardCollection, billboards, billboards.length, frameState, modelMatrix, true);\n  } else if (mode === SceneMode.SCENE2D || mode === SceneMode.COLUMBUS_VIEW) {\n    recomputeActualPositions(billboardCollection, billboardsToUpdate, billboardCollection._billboardsToUpdateIndex, frameState, modelMatrix, false);\n  }\n}\n\nfunction updateBoundingVolume(collection, frameState, boundingVolume) {\n  var pixelScale = 1.0;\n\n  if (!collection._allSizedInMeters || collection._maxPixelOffset !== 0.0) {\n    pixelScale = frameState.camera.getPixelSize(boundingVolume, frameState.context.drawingBufferWidth, frameState.context.drawingBufferHeight);\n  }\n\n  var size = pixelScale * collection._maxScale * collection._maxSize * 2.0;\n\n  if (collection._allHorizontalCenter && collection._allVerticalCenter) {\n    size *= 0.5;\n  }\n\n  var offset = pixelScale * collection._maxPixelOffset + collection._maxEyeOffset;\n  boundingVolume.radius += size + offset;\n}\n\nfunction createDebugCommand(billboardCollection, context) {\n  var fs;\n  fs = \"uniform sampler2D billboard_texture; \\n\" + \"varying vec2 v_textureCoordinates; \\n\" + \"void main() \\n\" + \"{ \\n\" + \"    gl_FragColor = texture2D(billboard_texture, v_textureCoordinates); \\n\" + \"} \\n\";\n  var drawCommand = context.createViewportQuadCommand(fs, {\n    uniformMap: {\n      billboard_texture: function () {\n        return billboardCollection._textureAtlas.texture;\n      }\n    }\n  });\n  drawCommand.pass = Pass.OVERLAY;\n  return drawCommand;\n}\n\nvar scratchWriterArray = [];\n/**\n * Called when {@link Viewer} or {@link CesiumWidget} render the scene to\n * get the draw commands needed to render this primitive.\n * <p>\n * Do not call this function directly.  This is documented just to\n * list the exceptions that may be propagated when the scene is rendered:\n * </p>\n *\n * @exception {RuntimeError} image with id must be in the atlas.\n */\n\nBillboardCollection.prototype.update = function (frameState) {\n  removeBillboards(this);\n  var billboards = this._billboards;\n  var billboardsLength = billboards.length;\n  var context = frameState.context;\n  this._instanced = context.instancedArrays;\n  attributeLocations = this._instanced ? attributeLocationsInstanced : attributeLocationsBatched;\n  getIndexBuffer = this._instanced ? getIndexBufferInstanced : getIndexBufferBatched;\n  var textureAtlas = this._textureAtlas;\n\n  if (!defined(textureAtlas)) {\n    textureAtlas = this._textureAtlas = new TextureAtlas({\n      context: context\n    });\n\n    for (var ii = 0; ii < billboardsLength; ++ii) {\n      billboards[ii]._loadImage();\n    }\n  }\n\n  var textureAtlasCoordinates = textureAtlas.textureCoordinates;\n\n  if (textureAtlasCoordinates.length === 0) {\n    // Can't write billboard vertices until we have texture coordinates\n    // provided by a texture atlas\n    return;\n  }\n\n  updateMode(this, frameState);\n  billboards = this._billboards;\n  billboardsLength = billboards.length;\n  var billboardsToUpdate = this._billboardsToUpdate;\n  var billboardsToUpdateLength = this._billboardsToUpdateIndex;\n  var properties = this._propertiesChanged;\n  var textureAtlasGUID = textureAtlas.guid;\n  var createVertexArray = this._createVertexArray || this._textureAtlasGUID !== textureAtlasGUID;\n  this._textureAtlasGUID = textureAtlasGUID;\n  var vafWriters;\n  var pass = frameState.passes;\n  var picking = pass.pick; // PERFORMANCE_IDEA: Round robin multiple buffers.\n\n  if (createVertexArray || !picking && this.computeNewBuffersUsage()) {\n    this._createVertexArray = false;\n\n    for (var k = 0; k < NUMBER_OF_PROPERTIES; ++k) {\n      properties[k] = 0;\n    }\n\n    this._vaf = this._vaf && this._vaf.destroy();\n\n    if (billboardsLength > 0) {\n      // PERFORMANCE_IDEA:  Instead of creating a new one, resize like std::vector.\n      this._vaf = createVAF(context, billboardsLength, this._buffersUsage, this._instanced, this._batchTable, this._sdf);\n      vafWriters = this._vaf.writers; // Rewrite entire buffer if billboards were added or removed.\n\n      for (var i = 0; i < billboardsLength; ++i) {\n        var billboard = this._billboards[i];\n        billboard._dirty = false; // In case it needed an update.\n\n        writeBillboard(this, context, textureAtlasCoordinates, vafWriters, billboard);\n      } // Different billboard collections share the same index buffer.\n\n\n      this._vaf.commit(getIndexBuffer(context));\n    }\n\n    this._billboardsToUpdateIndex = 0;\n  } else if (billboardsToUpdateLength > 0) {\n    // Billboards were modified, but none were added or removed.\n    var writers = scratchWriterArray;\n    writers.length = 0;\n\n    if (properties[POSITION_INDEX] || properties[ROTATION_INDEX] || properties[SCALE_INDEX]) {\n      writers.push(writePositionScaleAndRotation);\n    }\n\n    if (properties[IMAGE_INDEX_INDEX] || properties[PIXEL_OFFSET_INDEX] || properties[HORIZONTAL_ORIGIN_INDEX] || properties[VERTICAL_ORIGIN_INDEX] || properties[SHOW_INDEX]) {\n      writers.push(writeCompressedAttrib0);\n\n      if (this._instanced) {\n        writers.push(writeEyeOffset);\n      }\n    }\n\n    if (properties[IMAGE_INDEX_INDEX] || properties[ALIGNED_AXIS_INDEX] || properties[TRANSLUCENCY_BY_DISTANCE_INDEX]) {\n      writers.push(writeCompressedAttrib1);\n      writers.push(writeCompressedAttrib2);\n    }\n\n    if (properties[IMAGE_INDEX_INDEX] || properties[COLOR_INDEX]) {\n      writers.push(writeCompressedAttrib2);\n    }\n\n    if (properties[EYE_OFFSET_INDEX]) {\n      writers.push(writeEyeOffset);\n    }\n\n    if (properties[SCALE_BY_DISTANCE_INDEX]) {\n      writers.push(writeScaleByDistance);\n    }\n\n    if (properties[PIXEL_OFFSET_SCALE_BY_DISTANCE_INDEX]) {\n      writers.push(writePixelOffsetScaleByDistance);\n    }\n\n    if (properties[DISTANCE_DISPLAY_CONDITION_INDEX] || properties[DISABLE_DEPTH_DISTANCE] || properties[IMAGE_INDEX_INDEX] || properties[POSITION_INDEX]) {\n      writers.push(writeCompressedAttribute3);\n    }\n\n    if (properties[IMAGE_INDEX_INDEX] || properties[POSITION_INDEX]) {\n      writers.push(writeTextureCoordinateBoundsOrLabelTranslate);\n    }\n\n    if (properties[SDF_INDEX]) {\n      writers.push(writeSDF);\n    }\n\n    var numWriters = writers.length;\n    vafWriters = this._vaf.writers;\n\n    if (billboardsToUpdateLength / billboardsLength > 0.1) {\n      // If more than 10% of billboard change, rewrite the entire buffer.\n      // PERFORMANCE_IDEA:  I totally made up 10% :).\n      for (var m = 0; m < billboardsToUpdateLength; ++m) {\n        var b = billboardsToUpdate[m];\n        b._dirty = false;\n\n        for (var n = 0; n < numWriters; ++n) {\n          writers[n](this, context, textureAtlasCoordinates, vafWriters, b);\n        }\n      }\n\n      this._vaf.commit(getIndexBuffer(context));\n    } else {\n      for (var h = 0; h < billboardsToUpdateLength; ++h) {\n        var bb = billboardsToUpdate[h];\n        bb._dirty = false;\n\n        for (var o = 0; o < numWriters; ++o) {\n          writers[o](this, context, textureAtlasCoordinates, vafWriters, bb);\n        }\n\n        if (this._instanced) {\n          this._vaf.subCommit(bb._index, 1);\n        } else {\n          this._vaf.subCommit(bb._index * 4, 4);\n        }\n      }\n\n      this._vaf.endSubCommits();\n    }\n\n    this._billboardsToUpdateIndex = 0;\n  } // If the number of total billboards ever shrinks considerably\n  // Truncate billboardsToUpdate so that we free memory that we're\n  // not going to be using.\n\n\n  if (billboardsToUpdateLength > billboardsLength * 1.5) {\n    billboardsToUpdate.length = billboardsLength;\n  }\n\n  if (!defined(this._vaf) || !defined(this._vaf.va)) {\n    return;\n  }\n\n  if (this._boundingVolumeDirty) {\n    this._boundingVolumeDirty = false;\n    BoundingSphere.transform(this._baseVolume, this.modelMatrix, this._baseVolumeWC);\n  }\n\n  var boundingVolume;\n  var modelMatrix = Matrix4.IDENTITY;\n\n  if (frameState.mode === SceneMode.SCENE3D) {\n    modelMatrix = this.modelMatrix;\n    boundingVolume = BoundingSphere.clone(this._baseVolumeWC, this._boundingVolume);\n  } else {\n    boundingVolume = BoundingSphere.clone(this._baseVolume2D, this._boundingVolume);\n  }\n\n  updateBoundingVolume(this, frameState, boundingVolume);\n  var blendOptionChanged = this._blendOption !== this.blendOption;\n  this._blendOption = this.blendOption;\n\n  if (blendOptionChanged) {\n    if (this._blendOption === BlendOption.OPAQUE || this._blendOption === BlendOption.OPAQUE_AND_TRANSLUCENT) {\n      this._rsOpaque = RenderState.fromCache({\n        depthTest: {\n          enabled: true,\n          func: WebGLConstants.LESS\n        },\n        depthMask: true\n      });\n    } else {\n      this._rsOpaque = undefined;\n    } // If OPAQUE_AND_TRANSLUCENT is in use, only the opaque pass gets the benefit of the depth buffer,\n    // not the translucent pass.  Otherwise, if the TRANSLUCENT pass is on its own, it turns on\n    // a depthMask in lieu of full depth sorting (because it has opaque-ish fragments that look bad in OIT).\n    // When the TRANSLUCENT depth mask is in use, label backgrounds require the depth func to be LEQUAL.\n\n\n    var useTranslucentDepthMask = this._blendOption === BlendOption.TRANSLUCENT;\n\n    if (this._blendOption === BlendOption.TRANSLUCENT || this._blendOption === BlendOption.OPAQUE_AND_TRANSLUCENT) {\n      this._rsTranslucent = RenderState.fromCache({\n        depthTest: {\n          enabled: true,\n          func: useTranslucentDepthMask ? WebGLConstants.LEQUAL : WebGLConstants.LESS\n        },\n        depthMask: useTranslucentDepthMask,\n        blending: BlendingState.ALPHA_BLEND\n      });\n    } else {\n      this._rsTranslucent = undefined;\n    }\n  }\n\n  this._shaderDisableDepthDistance = this._shaderDisableDepthDistance || frameState.minimumDisableDepthTestDistance !== 0.0;\n  var vsSource;\n  var fsSource;\n  var vs;\n  var fs;\n  var vertDefines;\n  var supportVSTextureReads = ContextLimits.maximumVertexTextureImageUnits > 0;\n\n  if (blendOptionChanged || this._shaderRotation !== this._compiledShaderRotation || this._shaderAlignedAxis !== this._compiledShaderAlignedAxis || this._shaderScaleByDistance !== this._compiledShaderScaleByDistance || this._shaderTranslucencyByDistance !== this._compiledShaderTranslucencyByDistance || this._shaderPixelOffsetScaleByDistance !== this._compiledShaderPixelOffsetScaleByDistance || this._shaderDistanceDisplayCondition !== this._compiledShaderDistanceDisplayCondition || this._shaderDisableDepthDistance !== this._compiledShaderDisableDepthDistance || this._shaderClampToGround !== this._compiledShaderClampToGround || this._sdf !== this._compiledSDF) {\n    vsSource = BillboardCollectionVS;\n    fsSource = BillboardCollectionFS;\n    vertDefines = [];\n\n    if (defined(this._batchTable)) {\n      vertDefines.push(\"VECTOR_TILE\");\n      vsSource = this._batchTable.getVertexShaderCallback(false, \"a_batchId\", undefined)(vsSource);\n      fsSource = this._batchTable.getFragmentShaderCallback(false, undefined)(fsSource);\n    }\n\n    vs = new ShaderSource({\n      defines: vertDefines,\n      sources: [vsSource]\n    });\n\n    if (this._instanced) {\n      vs.defines.push(\"INSTANCED\");\n    }\n\n    if (this._shaderRotation) {\n      vs.defines.push(\"ROTATION\");\n    }\n\n    if (this._shaderAlignedAxis) {\n      vs.defines.push(\"ALIGNED_AXIS\");\n    }\n\n    if (this._shaderScaleByDistance) {\n      vs.defines.push(\"EYE_DISTANCE_SCALING\");\n    }\n\n    if (this._shaderTranslucencyByDistance) {\n      vs.defines.push(\"EYE_DISTANCE_TRANSLUCENCY\");\n    }\n\n    if (this._shaderPixelOffsetScaleByDistance) {\n      vs.defines.push(\"EYE_DISTANCE_PIXEL_OFFSET\");\n    }\n\n    if (this._shaderDistanceDisplayCondition) {\n      vs.defines.push(\"DISTANCE_DISPLAY_CONDITION\");\n    }\n\n    if (this._shaderDisableDepthDistance) {\n      vs.defines.push(\"DISABLE_DEPTH_DISTANCE\");\n    }\n\n    if (this._shaderClampToGround) {\n      if (supportVSTextureReads) {\n        vs.defines.push(\"VERTEX_DEPTH_CHECK\");\n      } else {\n        vs.defines.push(\"FRAGMENT_DEPTH_CHECK\");\n      }\n    }\n\n    var sdfEdge = 1.0 - SDFSettings.CUTOFF;\n\n    if (this._sdf) {\n      vs.defines.push(\"SDF\");\n    }\n\n    var vectorFragDefine = defined(this._batchTable) ? \"VECTOR_TILE\" : \"\";\n\n    if (this._blendOption === BlendOption.OPAQUE_AND_TRANSLUCENT) {\n      fs = new ShaderSource({\n        defines: [\"OPAQUE\", vectorFragDefine],\n        sources: [fsSource]\n      });\n\n      if (this._shaderClampToGround) {\n        if (supportVSTextureReads) {\n          fs.defines.push(\"VERTEX_DEPTH_CHECK\");\n        } else {\n          fs.defines.push(\"FRAGMENT_DEPTH_CHECK\");\n        }\n      }\n\n      if (this._sdf) {\n        fs.defines.push(\"SDF\");\n        fs.defines.push(\"SDF_EDGE \" + sdfEdge);\n      }\n\n      this._sp = ShaderProgram.replaceCache({\n        context: context,\n        shaderProgram: this._sp,\n        vertexShaderSource: vs,\n        fragmentShaderSource: fs,\n        attributeLocations: attributeLocations\n      });\n      fs = new ShaderSource({\n        defines: [\"TRANSLUCENT\", vectorFragDefine],\n        sources: [fsSource]\n      });\n\n      if (this._shaderClampToGround) {\n        if (supportVSTextureReads) {\n          fs.defines.push(\"VERTEX_DEPTH_CHECK\");\n        } else {\n          fs.defines.push(\"FRAGMENT_DEPTH_CHECK\");\n        }\n      }\n\n      if (this._sdf) {\n        fs.defines.push(\"SDF\");\n        fs.defines.push(\"SDF_EDGE \" + sdfEdge);\n      }\n\n      this._spTranslucent = ShaderProgram.replaceCache({\n        context: context,\n        shaderProgram: this._spTranslucent,\n        vertexShaderSource: vs,\n        fragmentShaderSource: fs,\n        attributeLocations: attributeLocations\n      });\n    }\n\n    if (this._blendOption === BlendOption.OPAQUE) {\n      fs = new ShaderSource({\n        defines: [vectorFragDefine],\n        sources: [fsSource]\n      });\n\n      if (this._shaderClampToGround) {\n        if (supportVSTextureReads) {\n          fs.defines.push(\"VERTEX_DEPTH_CHECK\");\n        } else {\n          fs.defines.push(\"FRAGMENT_DEPTH_CHECK\");\n        }\n      }\n\n      if (this._sdf) {\n        fs.defines.push(\"SDF\");\n        fs.defines.push(\"SDF_EDGE \" + sdfEdge);\n      }\n\n      this._sp = ShaderProgram.replaceCache({\n        context: context,\n        shaderProgram: this._sp,\n        vertexShaderSource: vs,\n        fragmentShaderSource: fs,\n        attributeLocations: attributeLocations\n      });\n    }\n\n    if (this._blendOption === BlendOption.TRANSLUCENT) {\n      fs = new ShaderSource({\n        defines: [vectorFragDefine],\n        sources: [fsSource]\n      });\n\n      if (this._shaderClampToGround) {\n        if (supportVSTextureReads) {\n          fs.defines.push(\"VERTEX_DEPTH_CHECK\");\n        } else {\n          fs.defines.push(\"FRAGMENT_DEPTH_CHECK\");\n        }\n      }\n\n      if (this._sdf) {\n        fs.defines.push(\"SDF\");\n        fs.defines.push(\"SDF_EDGE \" + sdfEdge);\n      }\n\n      this._spTranslucent = ShaderProgram.replaceCache({\n        context: context,\n        shaderProgram: this._spTranslucent,\n        vertexShaderSource: vs,\n        fragmentShaderSource: fs,\n        attributeLocations: attributeLocations\n      });\n    }\n\n    this._compiledShaderRotation = this._shaderRotation;\n    this._compiledShaderAlignedAxis = this._shaderAlignedAxis;\n    this._compiledShaderScaleByDistance = this._shaderScaleByDistance;\n    this._compiledShaderTranslucencyByDistance = this._shaderTranslucencyByDistance;\n    this._compiledShaderPixelOffsetScaleByDistance = this._shaderPixelOffsetScaleByDistance;\n    this._compiledShaderDistanceDisplayCondition = this._shaderDistanceDisplayCondition;\n    this._compiledShaderDisableDepthDistance = this._shaderDisableDepthDistance;\n    this._compiledShaderClampToGround = this._shaderClampToGround;\n    this._compiledSDF = this._sdf;\n  }\n\n  var commandList = frameState.commandList;\n\n  if (pass.render || pass.pick) {\n    var colorList = this._colorCommands;\n    var opaque = this._blendOption === BlendOption.OPAQUE;\n    var opaqueAndTranslucent = this._blendOption === BlendOption.OPAQUE_AND_TRANSLUCENT;\n    var va = this._vaf.va;\n    var vaLength = va.length;\n    var uniforms = this._uniforms;\n    var pickId;\n\n    if (defined(this._batchTable)) {\n      uniforms = this._batchTable.getUniformMapCallback()(uniforms);\n      pickId = this._batchTable.getPickId();\n    } else {\n      pickId = \"v_pickColor\";\n    }\n\n    colorList.length = vaLength;\n    var totalLength = opaqueAndTranslucent ? vaLength * 2 : vaLength;\n\n    for (var j = 0; j < totalLength; ++j) {\n      var command = colorList[j];\n\n      if (!defined(command)) {\n        command = colorList[j] = new DrawCommand();\n      }\n\n      var opaqueCommand = opaque || opaqueAndTranslucent && j % 2 === 0;\n      command.pass = opaqueCommand || !opaqueAndTranslucent ? Pass.OPAQUE : Pass.TRANSLUCENT;\n      command.owner = this;\n      var index = opaqueAndTranslucent ? Math.floor(j / 2.0) : j;\n      command.boundingVolume = boundingVolume;\n      command.modelMatrix = modelMatrix;\n      command.count = va[index].indicesCount;\n      command.shaderProgram = opaqueCommand ? this._sp : this._spTranslucent;\n      command.uniformMap = uniforms;\n      command.vertexArray = va[index].va;\n      command.renderState = opaqueCommand ? this._rsOpaque : this._rsTranslucent;\n      command.debugShowBoundingVolume = this.debugShowBoundingVolume;\n      command.pickId = pickId;\n\n      if (this._instanced) {\n        command.count = 6;\n        command.instanceCount = billboardsLength;\n      }\n\n      commandList.push(command);\n    }\n\n    if (this.debugShowTextureAtlas) {\n      if (!defined(this.debugCommand)) {\n        this.debugCommand = createDebugCommand(this, frameState.context);\n      }\n\n      commandList.push(this.debugCommand);\n    }\n  }\n};\n/**\n * Returns true if this object was destroyed; otherwise, false.\n * <br /><br />\n * If this object was destroyed, it should not be used; calling any function other than\n * <code>isDestroyed</code> will result in a {@link DeveloperError} exception.\n *\n * @returns {Boolean} <code>true</code> if this object was destroyed; otherwise, <code>false</code>.\n *\n * @see BillboardCollection#destroy\n */\n\n\nBillboardCollection.prototype.isDestroyed = function () {\n  return false;\n};\n/**\n * Destroys the WebGL resources held by this object.  Destroying an object allows for deterministic\n * release of WebGL resources, instead of relying on the garbage collector to destroy this object.\n * <br /><br />\n * Once an object is destroyed, it should not be used; calling any function other than\n * <code>isDestroyed</code> will result in a {@link DeveloperError} exception.  Therefore,\n * assign the return value (<code>undefined</code>) to the object as done in the example.\n *\n * @exception {DeveloperError} This object was destroyed, i.e., destroy() was called.\n *\n *\n * @example\n * billboards = billboards && billboards.destroy();\n *\n * @see BillboardCollection#isDestroyed\n */\n\n\nBillboardCollection.prototype.destroy = function () {\n  if (defined(this._removeCallbackFunc)) {\n    this._removeCallbackFunc();\n\n    this._removeCallbackFunc = undefined;\n  }\n\n  this._textureAtlas = this._destroyTextureAtlas && this._textureAtlas && this._textureAtlas.destroy();\n  this._sp = this._sp && this._sp.destroy();\n  this._spTranslucent = this._spTranslucent && this._spTranslucent.destroy();\n  this._vaf = this._vaf && this._vaf.destroy();\n  destroyBillboards(this._billboards);\n  return destroyObject(this);\n};\n\nexport default BillboardCollection;","map":{"version":3,"sources":["C:/Users/passa/Desktop/WaterLevelReact/node_modules/cesium/Source/Scene/BillboardCollection.js"],"names":["AttributeCompression","BoundingSphere","Cartesian2","Cartesian3","Color","ComponentDatatype","defaultValue","defined","destroyObject","DeveloperError","EncodedCartesian3","IndexDatatype","CesiumMath","Matrix4","WebGLConstants","Buffer","BufferUsage","ContextLimits","DrawCommand","Pass","RenderState","ShaderProgram","ShaderSource","VertexArrayFacade","BillboardCollectionFS","BillboardCollectionVS","Billboard","BlendingState","BlendOption","HeightReference","HorizontalOrigin","SceneMode","SDFSettings","TextureAtlas","VerticalOrigin","SHOW_INDEX","POSITION_INDEX","PIXEL_OFFSET_INDEX","EYE_OFFSET_INDEX","HORIZONTAL_ORIGIN_INDEX","VERTICAL_ORIGIN_INDEX","SCALE_INDEX","IMAGE_INDEX_INDEX","COLOR_INDEX","ROTATION_INDEX","ALIGNED_AXIS_INDEX","SCALE_BY_DISTANCE_INDEX","TRANSLUCENCY_BY_DISTANCE_INDEX","PIXEL_OFFSET_SCALE_BY_DISTANCE_INDEX","DISTANCE_DISPLAY_CONDITION_INDEX","DISTANCE_DISPLAY_CONDITION","DISABLE_DEPTH_DISTANCE","TEXTURE_COORDINATE_BOUNDS","SDF_INDEX","NUMBER_OF_PROPERTIES","attributeLocations","attributeLocationsBatched","positionHighAndScale","positionLowAndRotation","compressedAttribute0","compressedAttribute1","compressedAttribute2","eyeOffset","scaleByDistance","pixelOffsetScaleByDistance","compressedAttribute3","textureCoordinateBoundsOrLabelTranslate","a_batchId","sdf","attributeLocationsInstanced","direction","BillboardCollection","options","EMPTY_OBJECT","_scene","scene","_batchTable","batchTable","_textureAtlas","undefined","_textureAtlasGUID","_destroyTextureAtlas","_sp","_spTranslucent","_rsOpaque","_rsTranslucent","_vaf","_billboards","_billboardsToUpdate","_billboardsToUpdateIndex","_billboardsRemoved","_createVertexArray","_shaderRotation","_compiledShaderRotation","_shaderAlignedAxis","_compiledShaderAlignedAxis","_shaderScaleByDistance","_compiledShaderScaleByDistance","_shaderTranslucencyByDistance","_compiledShaderTranslucencyByDistance","_shaderPixelOffsetScaleByDistance","_compiledShaderPixelOffsetScaleByDistance","_shaderDistanceDisplayCondition","_compiledShaderDistanceDisplayCondition","_shaderDisableDepthDistance","_compiledShaderDisableDepthDistance","_shaderClampToGround","_compiledShaderClampToGround","_propertiesChanged","Uint32Array","_maxSize","_maxEyeOffset","_maxScale","_maxPixelOffset","_allHorizontalCenter","_allVerticalCenter","_allSizedInMeters","_baseVolume","_baseVolumeWC","_baseVolume2D","_boundingVolume","_boundingVolumeDirty","_colorCommands","modelMatrix","clone","IDENTITY","_modelMatrix","debugShowBoundingVolume","debugShowTextureAtlas","blendOption","OPAQUE_AND_TRANSLUCENT","_blendOption","_mode","SCENE3D","_buffersUsage","STATIC_DRAW","_highlightColor","WHITE","that","_uniforms","u_atlas","texture","u_highlightColor","terrainProviderChanged","_removeCallbackFunc","addEventListener","billboards","length","i","_updateClamping","Object","defineProperties","prototype","get","removeBillboards","textureAtlas","set","value","destroy","destroyTextureAtlas","destroyBillboards","_destroy","add","b","_index","push","remove","billboard","contains","removeAll","billboardCollection","newBillboards","j","_updateBillboard","propertyChanged","_dirty","_billboardCollection","index","getIndexBuffer","getIndexBufferBatched","context","sixteenK","indexBuffer","cache","billboardCollection_indexBufferBatched","indices","Uint16Array","createIndexBuffer","typedArray","usage","indexDatatype","UNSIGNED_SHORT","vertexArrayDestroyable","getIndexBufferInstanced","billboardCollection_indexBufferInstanced","getVertexBufferInstanced","vertexBuffer","billboardCollection_vertexBufferInstanced","createVertexBuffer","Float32Array","computeNewBuffersUsage","buffersUsage","usageChanged","properties","k","newUsage","STREAM_DRAW","createVAF","numberOfBillboards","instanced","attributes","componentsPerAttribute","componentDatatype","FLOAT","componentDatatyps","bufferUsage","sizeInVertices","writePositionScratch","writePositionScaleAndRotation","textureAtlasCoordinates","vafWriters","positionHighWriter","positionLowWriter","position","_getActualPosition","expand","fromCartesian","scale","rotation","Math","max","high","low","_instanced","x","y","z","scratchCartesian2","UPPER_BOUND","LEFT_SHIFT16","LEFT_SHIFT12","LEFT_SHIFT8","LEFT_SHIFT7","LEFT_SHIFT5","LEFT_SHIFT3","LEFT_SHIFT2","RIGHT_SHIFT8","LOWER_LEFT","LOWER_RIGHT","UPPER_RIGHT","UPPER_LEFT","writeCompressedAttrib0","writer","pixelOffset","pixelOffsetX","pixelOffsetY","translate","_translate","translateX","translateY","abs","horizontalOrigin","verticalOrigin","_verticalOrigin","show","clusterShow","color","alpha","BASELINE","BOTTOM","CENTER","bottomLeftX","bottomLeftY","width","height","_imageIndex","imageRectangle","topRightX","topRightY","compressed0","floor","clamp","compressed1","compressed2","tempTanslateY","upperTranslateY","lowerTranslateY","compressedTexCoordsLL","compressTextureCoordinates","compressedTexCoordsLR","compressedTexCoordsUR","compressedTexCoordsUL","writeCompressedAttrib1","alignedAxis","equals","ZERO","near","nearValue","far","farValue","translucency","translucencyByDistance","textureWidth","imageWidth","round","magnitudeSquared","EPSILON6","octEncodeFloat","writeCompressedAttrib2","pickColor","getPickId","sizeInMeters","validAlignedAxis","dimensions","imageHeight","labelHorizontalOrigin","_labelHorizontalOrigin","compressed3","red","floatToByte","green","blue","writeEyeOffset","eyeOffsetZ","_heightReference","NONE","compressedTexCoordsRange","writeScaleByDistance","writePixelOffsetScaleByDistance","pixelOffsetScale","writeCompressedAttribute3","Number","MAX_VALUE","distanceDisplayCondition","disableDepthTestDistance","clampToGround","heightReference","CLAMP_TO_GROUND","depthTexture","POSITIVE_INFINITY","_labelDimensions","w","h","writeTextureCoordinateBoundsOrLabelTranslate","maximumVertexTextureImageUnits","_labelTranslate","minX","minY","maxX","maxY","writeBatchId","id","_batchIndex","writeSDF","_sdf","outlineColor","outlineWidth","outlineDistance","RADIUS","writeBillboard","recomputeActualPositions","frameState","recomputeBoundingVolume","boundingVolume","mode","positions","actualPosition","_computeActualPosition","_setActualPosition","fromPoints","updateMode","billboardsToUpdate","SCENE2D","COLUMBUS_VIEW","MORPHING","updateBoundingVolume","collection","pixelScale","camera","getPixelSize","drawingBufferWidth","drawingBufferHeight","size","offset","radius","createDebugCommand","fs","drawCommand","createViewportQuadCommand","uniformMap","billboard_texture","pass","OVERLAY","scratchWriterArray","update","billboardsLength","instancedArrays","ii","_loadImage","textureCoordinates","billboardsToUpdateLength","textureAtlasGUID","guid","createVertexArray","passes","picking","pick","writers","commit","numWriters","m","n","bb","o","subCommit","endSubCommits","va","transform","blendOptionChanged","OPAQUE","fromCache","depthTest","enabled","func","LESS","depthMask","useTranslucentDepthMask","TRANSLUCENT","LEQUAL","blending","ALPHA_BLEND","minimumDisableDepthTestDistance","vsSource","fsSource","vs","vertDefines","supportVSTextureReads","_compiledSDF","getVertexShaderCallback","getFragmentShaderCallback","defines","sources","sdfEdge","CUTOFF","vectorFragDefine","replaceCache","shaderProgram","vertexShaderSource","fragmentShaderSource","commandList","render","colorList","opaque","opaqueAndTranslucent","vaLength","uniforms","pickId","getUniformMapCallback","totalLength","command","opaqueCommand","owner","count","indicesCount","vertexArray","renderState","instanceCount","debugCommand","isDestroyed"],"mappings":"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","sourcesContent":["import AttributeCompression from \"../Core/AttributeCompression.js\";\nimport BoundingSphere from \"../Core/BoundingSphere.js\";\nimport Cartesian2 from \"../Core/Cartesian2.js\";\nimport Cartesian3 from \"../Core/Cartesian3.js\";\nimport Color from \"../Core/Color.js\";\nimport ComponentDatatype from \"../Core/ComponentDatatype.js\";\nimport defaultValue from \"../Core/defaultValue.js\";\nimport defined from \"../Core/defined.js\";\nimport destroyObject from \"../Core/destroyObject.js\";\nimport DeveloperError from \"../Core/DeveloperError.js\";\nimport EncodedCartesian3 from \"../Core/EncodedCartesian3.js\";\nimport IndexDatatype from \"../Core/IndexDatatype.js\";\nimport CesiumMath from \"../Core/Math.js\";\nimport Matrix4 from \"../Core/Matrix4.js\";\nimport WebGLConstants from \"../Core/WebGLConstants.js\";\nimport Buffer from \"../Renderer/Buffer.js\";\nimport BufferUsage from \"../Renderer/BufferUsage.js\";\nimport ContextLimits from \"../Renderer/ContextLimits.js\";\nimport DrawCommand from \"../Renderer/DrawCommand.js\";\nimport Pass from \"../Renderer/Pass.js\";\nimport RenderState from \"../Renderer/RenderState.js\";\nimport ShaderProgram from \"../Renderer/ShaderProgram.js\";\nimport ShaderSource from \"../Renderer/ShaderSource.js\";\nimport VertexArrayFacade from \"../Renderer/VertexArrayFacade.js\";\nimport BillboardCollectionFS from \"../Shaders/BillboardCollectionFS.js\";\nimport BillboardCollectionVS from \"../Shaders/BillboardCollectionVS.js\";\nimport Billboard from \"./Billboard.js\";\nimport BlendingState from \"./BlendingState.js\";\nimport BlendOption from \"./BlendOption.js\";\nimport HeightReference from \"./HeightReference.js\";\nimport HorizontalOrigin from \"./HorizontalOrigin.js\";\nimport SceneMode from \"./SceneMode.js\";\nimport SDFSettings from \"./SDFSettings.js\";\nimport TextureAtlas from \"./TextureAtlas.js\";\nimport VerticalOrigin from \"./VerticalOrigin.js\";\n\nvar SHOW_INDEX = Billboard.SHOW_INDEX;\nvar POSITION_INDEX = Billboard.POSITION_INDEX;\nvar PIXEL_OFFSET_INDEX = Billboard.PIXEL_OFFSET_INDEX;\nvar EYE_OFFSET_INDEX = Billboard.EYE_OFFSET_INDEX;\nvar HORIZONTAL_ORIGIN_INDEX = Billboard.HORIZONTAL_ORIGIN_INDEX;\nvar VERTICAL_ORIGIN_INDEX = Billboard.VERTICAL_ORIGIN_INDEX;\nvar SCALE_INDEX = Billboard.SCALE_INDEX;\nvar IMAGE_INDEX_INDEX = Billboard.IMAGE_INDEX_INDEX;\nvar COLOR_INDEX = Billboard.COLOR_INDEX;\nvar ROTATION_INDEX = Billboard.ROTATION_INDEX;\nvar ALIGNED_AXIS_INDEX = Billboard.ALIGNED_AXIS_INDEX;\nvar SCALE_BY_DISTANCE_INDEX = Billboard.SCALE_BY_DISTANCE_INDEX;\nvar TRANSLUCENCY_BY_DISTANCE_INDEX = Billboard.TRANSLUCENCY_BY_DISTANCE_INDEX;\nvar PIXEL_OFFSET_SCALE_BY_DISTANCE_INDEX =\n  Billboard.PIXEL_OFFSET_SCALE_BY_DISTANCE_INDEX;\nvar DISTANCE_DISPLAY_CONDITION_INDEX = Billboard.DISTANCE_DISPLAY_CONDITION;\nvar DISABLE_DEPTH_DISTANCE = Billboard.DISABLE_DEPTH_DISTANCE;\nvar TEXTURE_COORDINATE_BOUNDS = Billboard.TEXTURE_COORDINATE_BOUNDS;\nvar SDF_INDEX = Billboard.SDF_INDEX;\nvar NUMBER_OF_PROPERTIES = Billboard.NUMBER_OF_PROPERTIES;\n\nvar attributeLocations;\n\nvar attributeLocationsBatched = {\n  positionHighAndScale: 0,\n  positionLowAndRotation: 1,\n  compressedAttribute0: 2, // pixel offset, translate, horizontal origin, vertical origin, show, direction, texture coordinates\n  compressedAttribute1: 3, // aligned axis, translucency by distance, image width\n  compressedAttribute2: 4, // image height, color, pick color, size in meters, valid aligned axis, 13 bits free\n  eyeOffset: 5, // 4 bytes free\n  scaleByDistance: 6,\n  pixelOffsetScaleByDistance: 7,\n  compressedAttribute3: 8,\n  textureCoordinateBoundsOrLabelTranslate: 9,\n  a_batchId: 10,\n  sdf: 11,\n};\n\nvar attributeLocationsInstanced = {\n  direction: 0,\n  positionHighAndScale: 1,\n  positionLowAndRotation: 2, // texture offset in w\n  compressedAttribute0: 3,\n  compressedAttribute1: 4,\n  compressedAttribute2: 5,\n  eyeOffset: 6, // texture range in w\n  scaleByDistance: 7,\n  pixelOffsetScaleByDistance: 8,\n  compressedAttribute3: 9,\n  textureCoordinateBoundsOrLabelTranslate: 10,\n  a_batchId: 11,\n  sdf: 12,\n};\n\n/**\n * A renderable collection of billboards.  Billboards are viewport-aligned\n * images positioned in the 3D scene.\n * <br /><br />\n * <div align='center'>\n * <img src='Images/Billboard.png' width='400' height='300' /><br />\n * Example billboards\n * </div>\n * <br /><br />\n * Billboards are added and removed from the collection using {@link BillboardCollection#add}\n * and {@link BillboardCollection#remove}.  Billboards in a collection automatically share textures\n * for images with the same identifier.\n *\n * @alias BillboardCollection\n * @constructor\n *\n * @param {Object} [options] Object with the following properties:\n * @param {Matrix4} [options.modelMatrix=Matrix4.IDENTITY] The 4x4 transformation matrix that transforms each billboard from model to world coordinates.\n * @param {Boolean} [options.debugShowBoundingVolume=false] For debugging only. Determines if this primitive's commands' bounding spheres are shown.\n * @param {Scene} [options.scene] Must be passed in for billboards that use the height reference property or will be depth tested against the globe.\n * @param {BlendOption} [options.blendOption=BlendOption.OPAQUE_AND_TRANSLUCENT] The billboard blending option. The default\n * is used for rendering both opaque and translucent billboards. However, if either all of the billboards are completely opaque or all are completely translucent,\n * setting the technique to BlendOption.OPAQUE or BlendOption.TRANSLUCENT can improve performance by up to 2x.\n *\n * @performance For best performance, prefer a few collections, each with many billboards, to\n * many collections with only a few billboards each.  Organize collections so that billboards\n * with the same update frequency are in the same collection, i.e., billboards that do not\n * change should be in one collection; billboards that change every frame should be in another\n * collection; and so on.\n *\n * @see BillboardCollection#add\n * @see BillboardCollection#remove\n * @see Billboard\n * @see LabelCollection\n *\n * @demo {@link https://sandcastle.cesium.com/index.html?src=Billboards.html|Cesium Sandcastle Billboard Demo}\n *\n * @example\n * // Create a billboard collection with two billboards\n * var billboards = scene.primitives.add(new Cesium.BillboardCollection());\n * billboards.add({\n *   position : new Cesium.Cartesian3(1.0, 2.0, 3.0),\n *   image : 'url/to/image'\n * });\n * billboards.add({\n *   position : new Cesium.Cartesian3(4.0, 5.0, 6.0),\n *   image : 'url/to/another/image'\n * });\n */\nfunction BillboardCollection(options) {\n  options = defaultValue(options, defaultValue.EMPTY_OBJECT);\n\n  this._scene = options.scene;\n  this._batchTable = options.batchTable;\n\n  this._textureAtlas = undefined;\n  this._textureAtlasGUID = undefined;\n  this._destroyTextureAtlas = true;\n  this._sp = undefined;\n  this._spTranslucent = undefined;\n  this._rsOpaque = undefined;\n  this._rsTranslucent = undefined;\n  this._vaf = undefined;\n\n  this._billboards = [];\n  this._billboardsToUpdate = [];\n  this._billboardsToUpdateIndex = 0;\n  this._billboardsRemoved = false;\n  this._createVertexArray = false;\n\n  this._shaderRotation = false;\n  this._compiledShaderRotation = false;\n\n  this._shaderAlignedAxis = false;\n  this._compiledShaderAlignedAxis = false;\n\n  this._shaderScaleByDistance = false;\n  this._compiledShaderScaleByDistance = false;\n\n  this._shaderTranslucencyByDistance = false;\n  this._compiledShaderTranslucencyByDistance = false;\n\n  this._shaderPixelOffsetScaleByDistance = false;\n  this._compiledShaderPixelOffsetScaleByDistance = false;\n\n  this._shaderDistanceDisplayCondition = false;\n  this._compiledShaderDistanceDisplayCondition = false;\n\n  this._shaderDisableDepthDistance = false;\n  this._compiledShaderDisableDepthDistance = false;\n\n  this._shaderClampToGround = false;\n  this._compiledShaderClampToGround = false;\n\n  this._propertiesChanged = new Uint32Array(NUMBER_OF_PROPERTIES);\n\n  this._maxSize = 0.0;\n  this._maxEyeOffset = 0.0;\n  this._maxScale = 1.0;\n  this._maxPixelOffset = 0.0;\n  this._allHorizontalCenter = true;\n  this._allVerticalCenter = true;\n  this._allSizedInMeters = true;\n\n  this._baseVolume = new BoundingSphere();\n  this._baseVolumeWC = new BoundingSphere();\n  this._baseVolume2D = new BoundingSphere();\n  this._boundingVolume = new BoundingSphere();\n  this._boundingVolumeDirty = false;\n\n  this._colorCommands = [];\n\n  /**\n   * The 4x4 transformation matrix that transforms each billboard in this collection from model to world coordinates.\n   * When this is the identity matrix, the billboards are drawn in world coordinates, i.e., Earth's WGS84 coordinates.\n   * Local reference frames can be used by providing a different transformation matrix, like that returned\n   * by {@link Transforms.eastNorthUpToFixedFrame}.\n   *\n   * @type {Matrix4}\n   * @default {@link Matrix4.IDENTITY}\n   *\n   *\n   * @example\n   * var center = Cesium.Cartesian3.fromDegrees(-75.59777, 40.03883);\n   * billboards.modelMatrix = Cesium.Transforms.eastNorthUpToFixedFrame(center);\n   * billboards.add({\n   *   image : 'url/to/image',\n   *   position : new Cesium.Cartesian3(0.0, 0.0, 0.0) // center\n   * });\n   * billboards.add({\n   *   image : 'url/to/image',\n   *   position : new Cesium.Cartesian3(1000000.0, 0.0, 0.0) // east\n   * });\n   * billboards.add({\n   *   image : 'url/to/image',\n   *   position : new Cesium.Cartesian3(0.0, 1000000.0, 0.0) // north\n   * });\n   * billboards.add({\n   *   image : 'url/to/image',\n   *   position : new Cesium.Cartesian3(0.0, 0.0, 1000000.0) // up\n   * });\n   *\n   * @see Transforms.eastNorthUpToFixedFrame\n   */\n  this.modelMatrix = Matrix4.clone(\n    defaultValue(options.modelMatrix, Matrix4.IDENTITY)\n  );\n  this._modelMatrix = Matrix4.clone(Matrix4.IDENTITY);\n\n  /**\n   * This property is for debugging only; it is not for production use nor is it optimized.\n   * <p>\n   * Draws the bounding sphere for each draw command in the primitive.\n   * </p>\n   *\n   * @type {Boolean}\n   *\n   * @default false\n   */\n  this.debugShowBoundingVolume = defaultValue(\n    options.debugShowBoundingVolume,\n    false\n  );\n\n  /**\n   * This property is for debugging only; it is not for production use nor is it optimized.\n   * <p>\n   * Draws the texture atlas for this BillboardCollection as a fullscreen quad.\n   * </p>\n   *\n   * @type {Boolean}\n   *\n   * @default false\n   */\n  this.debugShowTextureAtlas = defaultValue(\n    options.debugShowTextureAtlas,\n    false\n  );\n\n  /**\n   * The billboard blending option. The default is used for rendering both opaque and translucent billboards.\n   * However, if either all of the billboards are completely opaque or all are completely translucent,\n   * setting the technique to BlendOption.OPAQUE or BlendOption.TRANSLUCENT can improve\n   * performance by up to 2x.\n   * @type {BlendOption}\n   * @default BlendOption.OPAQUE_AND_TRANSLUCENT\n   */\n  this.blendOption = defaultValue(\n    options.blendOption,\n    BlendOption.OPAQUE_AND_TRANSLUCENT\n  );\n  this._blendOption = undefined;\n\n  this._mode = SceneMode.SCENE3D;\n\n  // The buffer usage for each attribute is determined based on the usage of the attribute over time.\n  this._buffersUsage = [\n    BufferUsage.STATIC_DRAW, // SHOW_INDEX\n    BufferUsage.STATIC_DRAW, // POSITION_INDEX\n    BufferUsage.STATIC_DRAW, // PIXEL_OFFSET_INDEX\n    BufferUsage.STATIC_DRAW, // EYE_OFFSET_INDEX\n    BufferUsage.STATIC_DRAW, // HORIZONTAL_ORIGIN_INDEX\n    BufferUsage.STATIC_DRAW, // VERTICAL_ORIGIN_INDEX\n    BufferUsage.STATIC_DRAW, // SCALE_INDEX\n    BufferUsage.STATIC_DRAW, // IMAGE_INDEX_INDEX\n    BufferUsage.STATIC_DRAW, // COLOR_INDEX\n    BufferUsage.STATIC_DRAW, // ROTATION_INDEX\n    BufferUsage.STATIC_DRAW, // ALIGNED_AXIS_INDEX\n    BufferUsage.STATIC_DRAW, // SCALE_BY_DISTANCE_INDEX\n    BufferUsage.STATIC_DRAW, // TRANSLUCENCY_BY_DISTANCE_INDEX\n    BufferUsage.STATIC_DRAW, // PIXEL_OFFSET_SCALE_BY_DISTANCE_INDEX\n    BufferUsage.STATIC_DRAW, // DISTANCE_DISPLAY_CONDITION_INDEX\n    BufferUsage.STATIC_DRAW, // TEXTURE_COORDINATE_BOUNDS\n  ];\n\n  this._highlightColor = Color.clone(Color.WHITE); // Only used by Vector3DTilePoints\n\n  var that = this;\n  this._uniforms = {\n    u_atlas: function () {\n      return that._textureAtlas.texture;\n    },\n    u_highlightColor: function () {\n      return that._highlightColor;\n    },\n  };\n\n  var scene = this._scene;\n  if (defined(scene) && defined(scene.terrainProviderChanged)) {\n    this._removeCallbackFunc = scene.terrainProviderChanged.addEventListener(\n      function () {\n        var billboards = this._billboards;\n        var length = billboards.length;\n        for (var i = 0; i < length; ++i) {\n          billboards[i]._updateClamping();\n        }\n      },\n      this\n    );\n  }\n}\n\nObject.defineProperties(BillboardCollection.prototype, {\n  /**\n   * Returns the number of billboards in this collection.  This is commonly used with\n   * {@link BillboardCollection#get} to iterate over all the billboards\n   * in the collection.\n   * @memberof BillboardCollection.prototype\n   * @type {Number}\n   */\n  length: {\n    get: function () {\n      removeBillboards(this);\n      return this._billboards.length;\n    },\n  },\n\n  /**\n   * Gets or sets the textureAtlas.\n   * @memberof BillboardCollection.prototype\n   * @type {TextureAtlas}\n   * @private\n   */\n  textureAtlas: {\n    get: function () {\n      return this._textureAtlas;\n    },\n    set: function (value) {\n      if (this._textureAtlas !== value) {\n        this._textureAtlas =\n          this._destroyTextureAtlas &&\n          this._textureAtlas &&\n          this._textureAtlas.destroy();\n        this._textureAtlas = value;\n        this._createVertexArray = true; // New per-billboard texture coordinates\n      }\n    },\n  },\n\n  /**\n   * Gets or sets a value which determines if the texture atlas is\n   * destroyed when the collection is destroyed.\n   *\n   * If the texture atlas is used by more than one collection, set this to <code>false</code>,\n   * and explicitly destroy the atlas to avoid attempting to destroy it multiple times.\n   *\n   * @memberof BillboardCollection.prototype\n   * @type {Boolean}\n   * @private\n   *\n   * @example\n   * // Set destroyTextureAtlas\n   * // Destroy a billboard collection but not its texture atlas.\n   *\n   * var atlas = new TextureAtlas({\n   *   scene : scene,\n   *   images : images\n   * });\n   * billboards.textureAtlas = atlas;\n   * billboards.destroyTextureAtlas = false;\n   * billboards = billboards.destroy();\n   * console.log(atlas.isDestroyed()); // False\n   */\n  destroyTextureAtlas: {\n    get: function () {\n      return this._destroyTextureAtlas;\n    },\n    set: function (value) {\n      this._destroyTextureAtlas = value;\n    },\n  },\n});\n\nfunction destroyBillboards(billboards) {\n  var length = billboards.length;\n  for (var i = 0; i < length; ++i) {\n    if (billboards[i]) {\n      billboards[i]._destroy();\n    }\n  }\n}\n\n/**\n * Creates and adds a billboard with the specified initial properties to the collection.\n * The added billboard is returned so it can be modified or removed from the collection later.\n *\n * @param {Object}[options] A template describing the billboard's properties as shown in Example 1.\n * @returns {Billboard} The billboard that was added to the collection.\n *\n * @performance Calling <code>add</code> is expected constant time.  However, the collection's vertex buffer\n * is rewritten - an <code>O(n)</code> operation that also incurs CPU to GPU overhead.  For\n * best performance, add as many billboards as possible before calling <code>update</code>.\n *\n * @exception {DeveloperError} This object was destroyed, i.e., destroy() was called.\n *\n *\n * @example\n * // Example 1:  Add a billboard, specifying all the default values.\n * var b = billboards.add({\n *   show : true,\n *   position : Cesium.Cartesian3.ZERO,\n *   pixelOffset : Cesium.Cartesian2.ZERO,\n *   eyeOffset : Cesium.Cartesian3.ZERO,\n *   heightReference : Cesium.HeightReference.NONE,\n *   horizontalOrigin : Cesium.HorizontalOrigin.CENTER,\n *   verticalOrigin : Cesium.VerticalOrigin.CENTER,\n *   scale : 1.0,\n *   image : 'url/to/image',\n *   imageSubRegion : undefined,\n *   color : Cesium.Color.WHITE,\n *   id : undefined,\n *   rotation : 0.0,\n *   alignedAxis : Cesium.Cartesian3.ZERO,\n *   width : undefined,\n *   height : undefined,\n *   scaleByDistance : undefined,\n *   translucencyByDistance : undefined,\n *   pixelOffsetScaleByDistance : undefined,\n *   sizeInMeters : false,\n *   distanceDisplayCondition : undefined\n * });\n *\n * @example\n * // Example 2:  Specify only the billboard's cartographic position.\n * var b = billboards.add({\n *   position : Cesium.Cartesian3.fromDegrees(longitude, latitude, height)\n * });\n *\n * @see BillboardCollection#remove\n * @see BillboardCollection#removeAll\n */\nBillboardCollection.prototype.add = function (options) {\n  var b = new Billboard(options, this);\n  b._index = this._billboards.length;\n\n  this._billboards.push(b);\n  this._createVertexArray = true;\n\n  return b;\n};\n\n/**\n * Removes a billboard from the collection.\n *\n * @param {Billboard} billboard The billboard to remove.\n * @returns {Boolean} <code>true</code> if the billboard was removed; <code>false</code> if the billboard was not found in the collection.\n *\n * @performance Calling <code>remove</code> is expected constant time.  However, the collection's vertex buffer\n * is rewritten - an <code>O(n)</code> operation that also incurs CPU to GPU overhead.  For\n * best performance, remove as many billboards as possible before calling <code>update</code>.\n * If you intend to temporarily hide a billboard, it is usually more efficient to call\n * {@link Billboard#show} instead of removing and re-adding the billboard.\n *\n * @exception {DeveloperError} This object was destroyed, i.e., destroy() was called.\n *\n *\n * @example\n * var b = billboards.add(...);\n * billboards.remove(b);  // Returns true\n *\n * @see BillboardCollection#add\n * @see BillboardCollection#removeAll\n * @see Billboard#show\n */\nBillboardCollection.prototype.remove = function (billboard) {\n  if (this.contains(billboard)) {\n    this._billboards[billboard._index] = null; // Removed later\n    this._billboardsRemoved = true;\n    this._createVertexArray = true;\n    billboard._destroy();\n    return true;\n  }\n\n  return false;\n};\n\n/**\n * Removes all billboards from the collection.\n *\n * @performance <code>O(n)</code>.  It is more efficient to remove all the billboards\n * from a collection and then add new ones than to create a new collection entirely.\n *\n * @exception {DeveloperError} This object was destroyed, i.e., destroy() was called.\n *\n *\n * @example\n * billboards.add(...);\n * billboards.add(...);\n * billboards.removeAll();\n *\n * @see BillboardCollection#add\n * @see BillboardCollection#remove\n */\nBillboardCollection.prototype.removeAll = function () {\n  destroyBillboards(this._billboards);\n  this._billboards = [];\n  this._billboardsToUpdate = [];\n  this._billboardsToUpdateIndex = 0;\n  this._billboardsRemoved = false;\n\n  this._createVertexArray = true;\n};\n\nfunction removeBillboards(billboardCollection) {\n  if (billboardCollection._billboardsRemoved) {\n    billboardCollection._billboardsRemoved = false;\n\n    var newBillboards = [];\n    var billboards = billboardCollection._billboards;\n    var length = billboards.length;\n    for (var i = 0, j = 0; i < length; ++i) {\n      var billboard = billboards[i];\n      if (billboard) {\n        billboard._index = j++;\n        newBillboards.push(billboard);\n      }\n    }\n\n    billboardCollection._billboards = newBillboards;\n  }\n}\n\nBillboardCollection.prototype._updateBillboard = function (\n  billboard,\n  propertyChanged\n) {\n  if (!billboard._dirty) {\n    this._billboardsToUpdate[this._billboardsToUpdateIndex++] = billboard;\n  }\n\n  ++this._propertiesChanged[propertyChanged];\n};\n\n/**\n * Check whether this collection contains a given billboard.\n *\n * @param {Billboard} [billboard] The billboard to check for.\n * @returns {Boolean} true if this collection contains the billboard, false otherwise.\n *\n * @see BillboardCollection#get\n */\nBillboardCollection.prototype.contains = function (billboard) {\n  return defined(billboard) && billboard._billboardCollection === this;\n};\n\n/**\n * Returns the billboard in the collection at the specified index.  Indices are zero-based\n * and increase as billboards are added.  Removing a billboard shifts all billboards after\n * it to the left, changing their indices.  This function is commonly used with\n * {@link BillboardCollection#length} to iterate over all the billboards\n * in the collection.\n *\n * @param {Number} index The zero-based index of the billboard.\n * @returns {Billboard} The billboard at the specified index.\n *\n * @performance Expected constant time.  If billboards were removed from the collection and\n * {@link BillboardCollection#update} was not called, an implicit <code>O(n)</code>\n * operation is performed.\n *\n * @exception {DeveloperError} This object was destroyed, i.e., destroy() was called.\n *\n *\n * @example\n * // Toggle the show property of every billboard in the collection\n * var len = billboards.length;\n * for (var i = 0; i < len; ++i) {\n *   var b = billboards.get(i);\n *   b.show = !b.show;\n * }\n *\n * @see BillboardCollection#length\n */\nBillboardCollection.prototype.get = function (index) {\n  //>>includeStart('debug', pragmas.debug);\n  if (!defined(index)) {\n    throw new DeveloperError(\"index is required.\");\n  }\n  //>>includeEnd('debug');\n\n  removeBillboards(this);\n  return this._billboards[index];\n};\n\nvar getIndexBuffer;\n\nfunction getIndexBufferBatched(context) {\n  var sixteenK = 16 * 1024;\n\n  var indexBuffer = context.cache.billboardCollection_indexBufferBatched;\n  if (defined(indexBuffer)) {\n    return indexBuffer;\n  }\n\n  // Subtract 6 because the last index is reserverd for primitive restart.\n  // https://www.khronos.org/registry/webgl/specs/latest/2.0/#5.18\n  var length = sixteenK * 6 - 6;\n  var indices = new Uint16Array(length);\n  for (var i = 0, j = 0; i < length; i += 6, j += 4) {\n    indices[i] = j;\n    indices[i + 1] = j + 1;\n    indices[i + 2] = j + 2;\n\n    indices[i + 3] = j + 0;\n    indices[i + 4] = j + 2;\n    indices[i + 5] = j + 3;\n  }\n\n  // PERFORMANCE_IDEA:  Should we reference count billboard collections, and eventually delete this?\n  // Is this too much memory to allocate up front?  Should we dynamically grow it?\n  indexBuffer = Buffer.createIndexBuffer({\n    context: context,\n    typedArray: indices,\n    usage: BufferUsage.STATIC_DRAW,\n    indexDatatype: IndexDatatype.UNSIGNED_SHORT,\n  });\n  indexBuffer.vertexArrayDestroyable = false;\n  context.cache.billboardCollection_indexBufferBatched = indexBuffer;\n  return indexBuffer;\n}\n\nfunction getIndexBufferInstanced(context) {\n  var indexBuffer = context.cache.billboardCollection_indexBufferInstanced;\n  if (defined(indexBuffer)) {\n    return indexBuffer;\n  }\n\n  indexBuffer = Buffer.createIndexBuffer({\n    context: context,\n    typedArray: new Uint16Array([0, 1, 2, 0, 2, 3]),\n    usage: BufferUsage.STATIC_DRAW,\n    indexDatatype: IndexDatatype.UNSIGNED_SHORT,\n  });\n\n  indexBuffer.vertexArrayDestroyable = false;\n  context.cache.billboardCollection_indexBufferInstanced = indexBuffer;\n  return indexBuffer;\n}\n\nfunction getVertexBufferInstanced(context) {\n  var vertexBuffer = context.cache.billboardCollection_vertexBufferInstanced;\n  if (defined(vertexBuffer)) {\n    return vertexBuffer;\n  }\n\n  vertexBuffer = Buffer.createVertexBuffer({\n    context: context,\n    typedArray: new Float32Array([0.0, 0.0, 1.0, 0.0, 1.0, 1.0, 0.0, 1.0]),\n    usage: BufferUsage.STATIC_DRAW,\n  });\n\n  vertexBuffer.vertexArrayDestroyable = false;\n  context.cache.billboardCollection_vertexBufferInstanced = vertexBuffer;\n  return vertexBuffer;\n}\n\nBillboardCollection.prototype.computeNewBuffersUsage = function () {\n  var buffersUsage = this._buffersUsage;\n  var usageChanged = false;\n\n  var properties = this._propertiesChanged;\n  for (var k = 0; k < NUMBER_OF_PROPERTIES; ++k) {\n    var newUsage =\n      properties[k] === 0 ? BufferUsage.STATIC_DRAW : BufferUsage.STREAM_DRAW;\n    usageChanged = usageChanged || buffersUsage[k] !== newUsage;\n    buffersUsage[k] = newUsage;\n  }\n\n  return usageChanged;\n};\n\nfunction createVAF(\n  context,\n  numberOfBillboards,\n  buffersUsage,\n  instanced,\n  batchTable,\n  sdf\n) {\n  var attributes = [\n    {\n      index: attributeLocations.positionHighAndScale,\n      componentsPerAttribute: 4,\n      componentDatatype: ComponentDatatype.FLOAT,\n      usage: buffersUsage[POSITION_INDEX],\n    },\n    {\n      index: attributeLocations.positionLowAndRotation,\n      componentsPerAttribute: 4,\n      componentDatatype: ComponentDatatype.FLOAT,\n      usage: buffersUsage[POSITION_INDEX],\n    },\n    {\n      index: attributeLocations.compressedAttribute0,\n      componentsPerAttribute: 4,\n      componentDatatype: ComponentDatatype.FLOAT,\n      usage: buffersUsage[PIXEL_OFFSET_INDEX],\n    },\n    {\n      index: attributeLocations.compressedAttribute1,\n      componentsPerAttribute: 4,\n      componentDatatype: ComponentDatatype.FLOAT,\n      usage: buffersUsage[TRANSLUCENCY_BY_DISTANCE_INDEX],\n    },\n    {\n      index: attributeLocations.compressedAttribute2,\n      componentsPerAttribute: 4,\n      componentDatatype: ComponentDatatype.FLOAT,\n      usage: buffersUsage[COLOR_INDEX],\n    },\n    {\n      index: attributeLocations.eyeOffset,\n      componentsPerAttribute: 4,\n      componentDatatype: ComponentDatatype.FLOAT,\n      usage: buffersUsage[EYE_OFFSET_INDEX],\n    },\n    {\n      index: attributeLocations.scaleByDistance,\n      componentsPerAttribute: 4,\n      componentDatatype: ComponentDatatype.FLOAT,\n      usage: buffersUsage[SCALE_BY_DISTANCE_INDEX],\n    },\n    {\n      index: attributeLocations.pixelOffsetScaleByDistance,\n      componentsPerAttribute: 4,\n      componentDatatype: ComponentDatatype.FLOAT,\n      usage: buffersUsage[PIXEL_OFFSET_SCALE_BY_DISTANCE_INDEX],\n    },\n    {\n      index: attributeLocations.compressedAttribute3,\n      componentsPerAttribute: 4,\n      componentDatatype: ComponentDatatype.FLOAT,\n      usage: buffersUsage[DISTANCE_DISPLAY_CONDITION_INDEX],\n    },\n    {\n      index: attributeLocations.textureCoordinateBoundsOrLabelTranslate,\n      componentsPerAttribute: 4,\n      componentDatatype: ComponentDatatype.FLOAT,\n      usage: buffersUsage[TEXTURE_COORDINATE_BOUNDS],\n    },\n  ];\n\n  // Instancing requires one non-instanced attribute.\n  if (instanced) {\n    attributes.push({\n      index: attributeLocations.direction,\n      componentsPerAttribute: 2,\n      componentDatatype: ComponentDatatype.FLOAT,\n      vertexBuffer: getVertexBufferInstanced(context),\n    });\n  }\n\n  if (defined(batchTable)) {\n    attributes.push({\n      index: attributeLocations.a_batchId,\n      componentsPerAttribute: 1,\n      componentDatatyps: ComponentDatatype.FLOAT,\n      bufferUsage: BufferUsage.STATIC_DRAW,\n    });\n  }\n\n  if (sdf) {\n    attributes.push({\n      index: attributeLocations.sdf,\n      componentsPerAttribute: 2,\n      componentDatatype: ComponentDatatype.FLOAT,\n      usage: buffersUsage[SDF_INDEX],\n    });\n  }\n\n  // When instancing is enabled, only one vertex is needed for each billboard.\n  var sizeInVertices = instanced ? numberOfBillboards : 4 * numberOfBillboards;\n  return new VertexArrayFacade(context, attributes, sizeInVertices, instanced);\n}\n\n///////////////////////////////////////////////////////////////////////////\n\n// Four vertices per billboard.  Each has the same position, etc., but a different screen-space direction vector.\n\n// PERFORMANCE_IDEA:  Save memory if a property is the same for all billboards, use a latched attribute state,\n// instead of storing it in a vertex buffer.\n\nvar writePositionScratch = new EncodedCartesian3();\n\nfunction writePositionScaleAndRotation(\n  billboardCollection,\n  context,\n  textureAtlasCoordinates,\n  vafWriters,\n  billboard\n) {\n  var i;\n  var positionHighWriter = vafWriters[attributeLocations.positionHighAndScale];\n  var positionLowWriter = vafWriters[attributeLocations.positionLowAndRotation];\n  var position = billboard._getActualPosition();\n\n  if (billboardCollection._mode === SceneMode.SCENE3D) {\n    BoundingSphere.expand(\n      billboardCollection._baseVolume,\n      position,\n      billboardCollection._baseVolume\n    );\n    billboardCollection._boundingVolumeDirty = true;\n  }\n\n  EncodedCartesian3.fromCartesian(position, writePositionScratch);\n  var scale = billboard.scale;\n  var rotation = billboard.rotation;\n\n  if (rotation !== 0.0) {\n    billboardCollection._shaderRotation = true;\n  }\n\n  billboardCollection._maxScale = Math.max(\n    billboardCollection._maxScale,\n    scale\n  );\n\n  var high = writePositionScratch.high;\n  var low = writePositionScratch.low;\n\n  if (billboardCollection._instanced) {\n    i = billboard._index;\n    positionHighWriter(i, high.x, high.y, high.z, scale);\n    positionLowWriter(i, low.x, low.y, low.z, rotation);\n  } else {\n    i = billboard._index * 4;\n    positionHighWriter(i + 0, high.x, high.y, high.z, scale);\n    positionHighWriter(i + 1, high.x, high.y, high.z, scale);\n    positionHighWriter(i + 2, high.x, high.y, high.z, scale);\n    positionHighWriter(i + 3, high.x, high.y, high.z, scale);\n\n    positionLowWriter(i + 0, low.x, low.y, low.z, rotation);\n    positionLowWriter(i + 1, low.x, low.y, low.z, rotation);\n    positionLowWriter(i + 2, low.x, low.y, low.z, rotation);\n    positionLowWriter(i + 3, low.x, low.y, low.z, rotation);\n  }\n}\n\nvar scratchCartesian2 = new Cartesian2();\n\nvar UPPER_BOUND = 32768.0; // 2^15\n\nvar LEFT_SHIFT16 = 65536.0; // 2^16\nvar LEFT_SHIFT12 = 4096.0; // 2^12\nvar LEFT_SHIFT8 = 256.0; // 2^8\nvar LEFT_SHIFT7 = 128.0;\nvar LEFT_SHIFT5 = 32.0;\nvar LEFT_SHIFT3 = 8.0;\nvar LEFT_SHIFT2 = 4.0;\n\nvar RIGHT_SHIFT8 = 1.0 / 256.0;\n\nvar LOWER_LEFT = 0.0;\nvar LOWER_RIGHT = 2.0;\nvar UPPER_RIGHT = 3.0;\nvar UPPER_LEFT = 1.0;\n\nfunction writeCompressedAttrib0(\n  billboardCollection,\n  context,\n  textureAtlasCoordinates,\n  vafWriters,\n  billboard\n) {\n  var i;\n  var writer = vafWriters[attributeLocations.compressedAttribute0];\n  var pixelOffset = billboard.pixelOffset;\n  var pixelOffsetX = pixelOffset.x;\n  var pixelOffsetY = pixelOffset.y;\n\n  var translate = billboard._translate;\n  var translateX = translate.x;\n  var translateY = translate.y;\n\n  billboardCollection._maxPixelOffset = Math.max(\n    billboardCollection._maxPixelOffset,\n    Math.abs(pixelOffsetX + translateX),\n    Math.abs(-pixelOffsetY + translateY)\n  );\n\n  var horizontalOrigin = billboard.horizontalOrigin;\n  var verticalOrigin = billboard._verticalOrigin;\n  var show = billboard.show && billboard.clusterShow;\n\n  // If the color alpha is zero, do not show this billboard.  This lets us avoid providing\n  // color during the pick pass and also eliminates a discard in the fragment shader.\n  if (billboard.color.alpha === 0.0) {\n    show = false;\n  }\n\n  // Raw billboards don't distinguish between BASELINE and BOTTOM, only LabelCollection does that.\n  if (verticalOrigin === VerticalOrigin.BASELINE) {\n    verticalOrigin = VerticalOrigin.BOTTOM;\n  }\n\n  billboardCollection._allHorizontalCenter =\n    billboardCollection._allHorizontalCenter &&\n    horizontalOrigin === HorizontalOrigin.CENTER;\n  billboardCollection._allVerticalCenter =\n    billboardCollection._allVerticalCenter &&\n    verticalOrigin === VerticalOrigin.CENTER;\n\n  var bottomLeftX = 0;\n  var bottomLeftY = 0;\n  var width = 0;\n  var height = 0;\n  var index = billboard._imageIndex;\n  if (index !== -1) {\n    var imageRectangle = textureAtlasCoordinates[index];\n\n    //>>includeStart('debug', pragmas.debug);\n    if (!defined(imageRectangle)) {\n      throw new DeveloperError(\"Invalid billboard image index: \" + index);\n    }\n    //>>includeEnd('debug');\n\n    bottomLeftX = imageRectangle.x;\n    bottomLeftY = imageRectangle.y;\n    width = imageRectangle.width;\n    height = imageRectangle.height;\n  }\n  var topRightX = bottomLeftX + width;\n  var topRightY = bottomLeftY + height;\n\n  var compressed0 =\n    Math.floor(\n      CesiumMath.clamp(pixelOffsetX, -UPPER_BOUND, UPPER_BOUND) + UPPER_BOUND\n    ) * LEFT_SHIFT7;\n  compressed0 += (horizontalOrigin + 1.0) * LEFT_SHIFT5;\n  compressed0 += (verticalOrigin + 1.0) * LEFT_SHIFT3;\n  compressed0 += (show ? 1.0 : 0.0) * LEFT_SHIFT2;\n\n  var compressed1 =\n    Math.floor(\n      CesiumMath.clamp(pixelOffsetY, -UPPER_BOUND, UPPER_BOUND) + UPPER_BOUND\n    ) * LEFT_SHIFT8;\n  var compressed2 =\n    Math.floor(\n      CesiumMath.clamp(translateX, -UPPER_BOUND, UPPER_BOUND) + UPPER_BOUND\n    ) * LEFT_SHIFT8;\n\n  var tempTanslateY =\n    (CesiumMath.clamp(translateY, -UPPER_BOUND, UPPER_BOUND) + UPPER_BOUND) *\n    RIGHT_SHIFT8;\n  var upperTranslateY = Math.floor(tempTanslateY);\n  var lowerTranslateY = Math.floor(\n    (tempTanslateY - upperTranslateY) * LEFT_SHIFT8\n  );\n\n  compressed1 += upperTranslateY;\n  compressed2 += lowerTranslateY;\n\n  scratchCartesian2.x = bottomLeftX;\n  scratchCartesian2.y = bottomLeftY;\n  var compressedTexCoordsLL = AttributeCompression.compressTextureCoordinates(\n    scratchCartesian2\n  );\n  scratchCartesian2.x = topRightX;\n  var compressedTexCoordsLR = AttributeCompression.compressTextureCoordinates(\n    scratchCartesian2\n  );\n  scratchCartesian2.y = topRightY;\n  var compressedTexCoordsUR = AttributeCompression.compressTextureCoordinates(\n    scratchCartesian2\n  );\n  scratchCartesian2.x = bottomLeftX;\n  var compressedTexCoordsUL = AttributeCompression.compressTextureCoordinates(\n    scratchCartesian2\n  );\n\n  if (billboardCollection._instanced) {\n    i = billboard._index;\n    writer(i, compressed0, compressed1, compressed2, compressedTexCoordsLL);\n  } else {\n    i = billboard._index * 4;\n    writer(\n      i + 0,\n      compressed0 + LOWER_LEFT,\n      compressed1,\n      compressed2,\n      compressedTexCoordsLL\n    );\n    writer(\n      i + 1,\n      compressed0 + LOWER_RIGHT,\n      compressed1,\n      compressed2,\n      compressedTexCoordsLR\n    );\n    writer(\n      i + 2,\n      compressed0 + UPPER_RIGHT,\n      compressed1,\n      compressed2,\n      compressedTexCoordsUR\n    );\n    writer(\n      i + 3,\n      compressed0 + UPPER_LEFT,\n      compressed1,\n      compressed2,\n      compressedTexCoordsUL\n    );\n  }\n}\n\nfunction writeCompressedAttrib1(\n  billboardCollection,\n  context,\n  textureAtlasCoordinates,\n  vafWriters,\n  billboard\n) {\n  var i;\n  var writer = vafWriters[attributeLocations.compressedAttribute1];\n  var alignedAxis = billboard.alignedAxis;\n  if (!Cartesian3.equals(alignedAxis, Cartesian3.ZERO)) {\n    billboardCollection._shaderAlignedAxis = true;\n  }\n\n  var near = 0.0;\n  var nearValue = 1.0;\n  var far = 1.0;\n  var farValue = 1.0;\n\n  var translucency = billboard.translucencyByDistance;\n  if (defined(translucency)) {\n    near = translucency.near;\n    nearValue = translucency.nearValue;\n    far = translucency.far;\n    farValue = translucency.farValue;\n\n    if (nearValue !== 1.0 || farValue !== 1.0) {\n      // translucency by distance calculation in shader need not be enabled\n      // until a billboard with near and far !== 1.0 is found\n      billboardCollection._shaderTranslucencyByDistance = true;\n    }\n  }\n\n  var width = 0;\n  var index = billboard._imageIndex;\n  if (index !== -1) {\n    var imageRectangle = textureAtlasCoordinates[index];\n\n    //>>includeStart('debug', pragmas.debug);\n    if (!defined(imageRectangle)) {\n      throw new DeveloperError(\"Invalid billboard image index: \" + index);\n    }\n    //>>includeEnd('debug');\n\n    width = imageRectangle.width;\n  }\n\n  var textureWidth = billboardCollection._textureAtlas.texture.width;\n  var imageWidth = Math.round(\n    defaultValue(billboard.width, textureWidth * width)\n  );\n  billboardCollection._maxSize = Math.max(\n    billboardCollection._maxSize,\n    imageWidth\n  );\n\n  var compressed0 = CesiumMath.clamp(imageWidth, 0.0, LEFT_SHIFT16);\n  var compressed1 = 0.0;\n\n  if (\n    Math.abs(Cartesian3.magnitudeSquared(alignedAxis) - 1.0) <\n    CesiumMath.EPSILON6\n  ) {\n    compressed1 = AttributeCompression.octEncodeFloat(alignedAxis);\n  }\n\n  nearValue = CesiumMath.clamp(nearValue, 0.0, 1.0);\n  nearValue = nearValue === 1.0 ? 255.0 : (nearValue * 255.0) | 0;\n  compressed0 = compressed0 * LEFT_SHIFT8 + nearValue;\n\n  farValue = CesiumMath.clamp(farValue, 0.0, 1.0);\n  farValue = farValue === 1.0 ? 255.0 : (farValue * 255.0) | 0;\n  compressed1 = compressed1 * LEFT_SHIFT8 + farValue;\n\n  if (billboardCollection._instanced) {\n    i = billboard._index;\n    writer(i, compressed0, compressed1, near, far);\n  } else {\n    i = billboard._index * 4;\n    writer(i + 0, compressed0, compressed1, near, far);\n    writer(i + 1, compressed0, compressed1, near, far);\n    writer(i + 2, compressed0, compressed1, near, far);\n    writer(i + 3, compressed0, compressed1, near, far);\n  }\n}\n\nfunction writeCompressedAttrib2(\n  billboardCollection,\n  context,\n  textureAtlasCoordinates,\n  vafWriters,\n  billboard\n) {\n  var i;\n  var writer = vafWriters[attributeLocations.compressedAttribute2];\n  var color = billboard.color;\n  var pickColor = !defined(billboardCollection._batchTable)\n    ? billboard.getPickId(context).color\n    : Color.WHITE;\n  var sizeInMeters = billboard.sizeInMeters ? 1.0 : 0.0;\n  var validAlignedAxis =\n    Math.abs(Cartesian3.magnitudeSquared(billboard.alignedAxis) - 1.0) <\n    CesiumMath.EPSILON6\n      ? 1.0\n      : 0.0;\n\n  billboardCollection._allSizedInMeters =\n    billboardCollection._allSizedInMeters && sizeInMeters === 1.0;\n\n  var height = 0;\n  var index = billboard._imageIndex;\n  if (index !== -1) {\n    var imageRectangle = textureAtlasCoordinates[index];\n\n    //>>includeStart('debug', pragmas.debug);\n    if (!defined(imageRectangle)) {\n      throw new DeveloperError(\"Invalid billboard image index: \" + index);\n    }\n    //>>includeEnd('debug');\n\n    height = imageRectangle.height;\n  }\n\n  var dimensions = billboardCollection._textureAtlas.texture.dimensions;\n  var imageHeight = Math.round(\n    defaultValue(billboard.height, dimensions.y * height)\n  );\n  billboardCollection._maxSize = Math.max(\n    billboardCollection._maxSize,\n    imageHeight\n  );\n  var labelHorizontalOrigin = defaultValue(\n    billboard._labelHorizontalOrigin,\n    -2\n  );\n  labelHorizontalOrigin += 2;\n  var compressed3 = imageHeight * LEFT_SHIFT2 + labelHorizontalOrigin;\n\n  var red = Color.floatToByte(color.red);\n  var green = Color.floatToByte(color.green);\n  var blue = Color.floatToByte(color.blue);\n  var compressed0 = red * LEFT_SHIFT16 + green * LEFT_SHIFT8 + blue;\n\n  red = Color.floatToByte(pickColor.red);\n  green = Color.floatToByte(pickColor.green);\n  blue = Color.floatToByte(pickColor.blue);\n  var compressed1 = red * LEFT_SHIFT16 + green * LEFT_SHIFT8 + blue;\n\n  var compressed2 =\n    Color.floatToByte(color.alpha) * LEFT_SHIFT16 +\n    Color.floatToByte(pickColor.alpha) * LEFT_SHIFT8;\n  compressed2 += sizeInMeters * 2.0 + validAlignedAxis;\n\n  if (billboardCollection._instanced) {\n    i = billboard._index;\n    writer(i, compressed0, compressed1, compressed2, compressed3);\n  } else {\n    i = billboard._index * 4;\n    writer(i + 0, compressed0, compressed1, compressed2, compressed3);\n    writer(i + 1, compressed0, compressed1, compressed2, compressed3);\n    writer(i + 2, compressed0, compressed1, compressed2, compressed3);\n    writer(i + 3, compressed0, compressed1, compressed2, compressed3);\n  }\n}\n\nfunction writeEyeOffset(\n  billboardCollection,\n  context,\n  textureAtlasCoordinates,\n  vafWriters,\n  billboard\n) {\n  var i;\n  var writer = vafWriters[attributeLocations.eyeOffset];\n  var eyeOffset = billboard.eyeOffset;\n\n  // For billboards that are clamped to ground, move it slightly closer to the camera\n  var eyeOffsetZ = eyeOffset.z;\n  if (billboard._heightReference !== HeightReference.NONE) {\n    eyeOffsetZ *= 1.005;\n  }\n  billboardCollection._maxEyeOffset = Math.max(\n    billboardCollection._maxEyeOffset,\n    Math.abs(eyeOffset.x),\n    Math.abs(eyeOffset.y),\n    Math.abs(eyeOffsetZ)\n  );\n\n  if (billboardCollection._instanced) {\n    var width = 0;\n    var height = 0;\n    var index = billboard._imageIndex;\n    if (index !== -1) {\n      var imageRectangle = textureAtlasCoordinates[index];\n\n      //>>includeStart('debug', pragmas.debug);\n      if (!defined(imageRectangle)) {\n        throw new DeveloperError(\"Invalid billboard image index: \" + index);\n      }\n      //>>includeEnd('debug');\n\n      width = imageRectangle.width;\n      height = imageRectangle.height;\n    }\n\n    scratchCartesian2.x = width;\n    scratchCartesian2.y = height;\n    var compressedTexCoordsRange = AttributeCompression.compressTextureCoordinates(\n      scratchCartesian2\n    );\n\n    i = billboard._index;\n    writer(i, eyeOffset.x, eyeOffset.y, eyeOffsetZ, compressedTexCoordsRange);\n  } else {\n    i = billboard._index * 4;\n    writer(i + 0, eyeOffset.x, eyeOffset.y, eyeOffsetZ, 0.0);\n    writer(i + 1, eyeOffset.x, eyeOffset.y, eyeOffsetZ, 0.0);\n    writer(i + 2, eyeOffset.x, eyeOffset.y, eyeOffsetZ, 0.0);\n    writer(i + 3, eyeOffset.x, eyeOffset.y, eyeOffsetZ, 0.0);\n  }\n}\n\nfunction writeScaleByDistance(\n  billboardCollection,\n  context,\n  textureAtlasCoordinates,\n  vafWriters,\n  billboard\n) {\n  var i;\n  var writer = vafWriters[attributeLocations.scaleByDistance];\n  var near = 0.0;\n  var nearValue = 1.0;\n  var far = 1.0;\n  var farValue = 1.0;\n\n  var scale = billboard.scaleByDistance;\n  if (defined(scale)) {\n    near = scale.near;\n    nearValue = scale.nearValue;\n    far = scale.far;\n    farValue = scale.farValue;\n\n    if (nearValue !== 1.0 || farValue !== 1.0) {\n      // scale by distance calculation in shader need not be enabled\n      // until a billboard with near and far !== 1.0 is found\n      billboardCollection._shaderScaleByDistance = true;\n    }\n  }\n\n  if (billboardCollection._instanced) {\n    i = billboard._index;\n    writer(i, near, nearValue, far, farValue);\n  } else {\n    i = billboard._index * 4;\n    writer(i + 0, near, nearValue, far, farValue);\n    writer(i + 1, near, nearValue, far, farValue);\n    writer(i + 2, near, nearValue, far, farValue);\n    writer(i + 3, near, nearValue, far, farValue);\n  }\n}\n\nfunction writePixelOffsetScaleByDistance(\n  billboardCollection,\n  context,\n  textureAtlasCoordinates,\n  vafWriters,\n  billboard\n) {\n  var i;\n  var writer = vafWriters[attributeLocations.pixelOffsetScaleByDistance];\n  var near = 0.0;\n  var nearValue = 1.0;\n  var far = 1.0;\n  var farValue = 1.0;\n\n  var pixelOffsetScale = billboard.pixelOffsetScaleByDistance;\n  if (defined(pixelOffsetScale)) {\n    near = pixelOffsetScale.near;\n    nearValue = pixelOffsetScale.nearValue;\n    far = pixelOffsetScale.far;\n    farValue = pixelOffsetScale.farValue;\n\n    if (nearValue !== 1.0 || farValue !== 1.0) {\n      // pixelOffsetScale by distance calculation in shader need not be enabled\n      // until a billboard with near and far !== 1.0 is found\n      billboardCollection._shaderPixelOffsetScaleByDistance = true;\n    }\n  }\n\n  if (billboardCollection._instanced) {\n    i = billboard._index;\n    writer(i, near, nearValue, far, farValue);\n  } else {\n    i = billboard._index * 4;\n    writer(i + 0, near, nearValue, far, farValue);\n    writer(i + 1, near, nearValue, far, farValue);\n    writer(i + 2, near, nearValue, far, farValue);\n    writer(i + 3, near, nearValue, far, farValue);\n  }\n}\n\nfunction writeCompressedAttribute3(\n  billboardCollection,\n  context,\n  textureAtlasCoordinates,\n  vafWriters,\n  billboard\n) {\n  var i;\n  var writer = vafWriters[attributeLocations.compressedAttribute3];\n  var near = 0.0;\n  var far = Number.MAX_VALUE;\n\n  var distanceDisplayCondition = billboard.distanceDisplayCondition;\n  if (defined(distanceDisplayCondition)) {\n    near = distanceDisplayCondition.near;\n    far = distanceDisplayCondition.far;\n\n    near *= near;\n    far *= far;\n\n    billboardCollection._shaderDistanceDisplayCondition = true;\n  }\n\n  var disableDepthTestDistance = billboard.disableDepthTestDistance;\n  var clampToGround =\n    billboard.heightReference === HeightReference.CLAMP_TO_GROUND &&\n    billboardCollection._scene.context.depthTexture;\n  if (!defined(disableDepthTestDistance)) {\n    disableDepthTestDistance = clampToGround ? 5000.0 : 0.0;\n  }\n\n  disableDepthTestDistance *= disableDepthTestDistance;\n  if (clampToGround || disableDepthTestDistance > 0.0) {\n    billboardCollection._shaderDisableDepthDistance = true;\n    if (disableDepthTestDistance === Number.POSITIVE_INFINITY) {\n      disableDepthTestDistance = -1.0;\n    }\n  }\n\n  var imageHeight;\n  var imageWidth;\n\n  if (!defined(billboard._labelDimensions)) {\n    var height = 0;\n    var width = 0;\n    var index = billboard._imageIndex;\n    if (index !== -1) {\n      var imageRectangle = textureAtlasCoordinates[index];\n\n      //>>includeStart('debug', pragmas.debug);\n      if (!defined(imageRectangle)) {\n        throw new DeveloperError(\"Invalid billboard image index: \" + index);\n      }\n      //>>includeEnd('debug');\n\n      height = imageRectangle.height;\n      width = imageRectangle.width;\n    }\n\n    imageHeight = Math.round(\n      defaultValue(\n        billboard.height,\n        billboardCollection._textureAtlas.texture.dimensions.y * height\n      )\n    );\n\n    var textureWidth = billboardCollection._textureAtlas.texture.width;\n    imageWidth = Math.round(\n      defaultValue(billboard.width, textureWidth * width)\n    );\n  } else {\n    imageWidth = billboard._labelDimensions.x;\n    imageHeight = billboard._labelDimensions.y;\n  }\n\n  var w = Math.floor(CesiumMath.clamp(imageWidth, 0.0, LEFT_SHIFT12));\n  var h = Math.floor(CesiumMath.clamp(imageHeight, 0.0, LEFT_SHIFT12));\n  var dimensions = w * LEFT_SHIFT12 + h;\n\n  if (billboardCollection._instanced) {\n    i = billboard._index;\n    writer(i, near, far, disableDepthTestDistance, dimensions);\n  } else {\n    i = billboard._index * 4;\n    writer(i + 0, near, far, disableDepthTestDistance, dimensions);\n    writer(i + 1, near, far, disableDepthTestDistance, dimensions);\n    writer(i + 2, near, far, disableDepthTestDistance, dimensions);\n    writer(i + 3, near, far, disableDepthTestDistance, dimensions);\n  }\n}\n\nfunction writeTextureCoordinateBoundsOrLabelTranslate(\n  billboardCollection,\n  context,\n  textureAtlasCoordinates,\n  vafWriters,\n  billboard\n) {\n  if (billboard.heightReference === HeightReference.CLAMP_TO_GROUND) {\n    billboardCollection._shaderClampToGround =\n      billboardCollection._scene.context.depthTexture;\n  }\n  var i;\n  var writer =\n    vafWriters[attributeLocations.textureCoordinateBoundsOrLabelTranslate];\n\n  if (ContextLimits.maximumVertexTextureImageUnits > 0) {\n    //write _labelTranslate, used by depth testing in the vertex shader\n    var translateX = 0;\n    var translateY = 0;\n    if (defined(billboard._labelTranslate)) {\n      translateX = billboard._labelTranslate.x;\n      translateY = billboard._labelTranslate.y;\n    }\n    if (billboardCollection._instanced) {\n      i = billboard._index;\n      writer(i, translateX, translateY, 0.0, 0.0);\n    } else {\n      i = billboard._index * 4;\n      writer(i + 0, translateX, translateY, 0.0, 0.0);\n      writer(i + 1, translateX, translateY, 0.0, 0.0);\n      writer(i + 2, translateX, translateY, 0.0, 0.0);\n      writer(i + 3, translateX, translateY, 0.0, 0.0);\n    }\n    return;\n  }\n\n  //write texture coordinate bounds, used by depth testing in fragment shader\n  var minX = 0;\n  var minY = 0;\n  var width = 0;\n  var height = 0;\n  var index = billboard._imageIndex;\n  if (index !== -1) {\n    var imageRectangle = textureAtlasCoordinates[index];\n\n    //>>includeStart('debug', pragmas.debug);\n    if (!defined(imageRectangle)) {\n      throw new DeveloperError(\"Invalid billboard image index: \" + index);\n    }\n    //>>includeEnd('debug');\n\n    minX = imageRectangle.x;\n    minY = imageRectangle.y;\n    width = imageRectangle.width;\n    height = imageRectangle.height;\n  }\n  var maxX = minX + width;\n  var maxY = minY + height;\n\n  if (billboardCollection._instanced) {\n    i = billboard._index;\n    writer(i, minX, minY, maxX, maxY);\n  } else {\n    i = billboard._index * 4;\n    writer(i + 0, minX, minY, maxX, maxY);\n    writer(i + 1, minX, minY, maxX, maxY);\n    writer(i + 2, minX, minY, maxX, maxY);\n    writer(i + 3, minX, minY, maxX, maxY);\n  }\n}\n\nfunction writeBatchId(\n  billboardCollection,\n  context,\n  textureAtlasCoordinates,\n  vafWriters,\n  billboard\n) {\n  if (!defined(billboardCollection._batchTable)) {\n    return;\n  }\n\n  var writer = vafWriters[attributeLocations.a_batchId];\n  var id = billboard._batchIndex;\n\n  var i;\n  if (billboardCollection._instanced) {\n    i = billboard._index;\n    writer(i, id);\n  } else {\n    i = billboard._index * 4;\n    writer(i + 0, id);\n    writer(i + 1, id);\n    writer(i + 2, id);\n    writer(i + 3, id);\n  }\n}\n\nfunction writeSDF(\n  billboardCollection,\n  context,\n  textureAtlasCoordinates,\n  vafWriters,\n  billboard\n) {\n  if (!billboardCollection._sdf) {\n    return;\n  }\n\n  var i;\n  var writer = vafWriters[attributeLocations.sdf];\n\n  var outlineColor = billboard.outlineColor;\n  var outlineWidth = billboard.outlineWidth;\n\n  var red = Color.floatToByte(outlineColor.red);\n  var green = Color.floatToByte(outlineColor.green);\n  var blue = Color.floatToByte(outlineColor.blue);\n  var compressed0 = red * LEFT_SHIFT16 + green * LEFT_SHIFT8 + blue;\n\n  // Compute the relative outline distance\n  var outlineDistance = outlineWidth / SDFSettings.RADIUS;\n  var compressed1 =\n    Color.floatToByte(outlineColor.alpha) * LEFT_SHIFT16 +\n    Color.floatToByte(outlineDistance) * LEFT_SHIFT8;\n\n  if (billboardCollection._instanced) {\n    i = billboard._index;\n    writer(i, compressed0, compressed1);\n  } else {\n    i = billboard._index * 4;\n    writer(i + 0, compressed0 + LOWER_LEFT, compressed1);\n    writer(i + 1, compressed0 + LOWER_RIGHT, compressed1);\n    writer(i + 2, compressed0 + UPPER_RIGHT, compressed1);\n    writer(i + 3, compressed0 + UPPER_LEFT, compressed1);\n  }\n}\n\nfunction writeBillboard(\n  billboardCollection,\n  context,\n  textureAtlasCoordinates,\n  vafWriters,\n  billboard\n) {\n  writePositionScaleAndRotation(\n    billboardCollection,\n    context,\n    textureAtlasCoordinates,\n    vafWriters,\n    billboard\n  );\n  writeCompressedAttrib0(\n    billboardCollection,\n    context,\n    textureAtlasCoordinates,\n    vafWriters,\n    billboard\n  );\n  writeCompressedAttrib1(\n    billboardCollection,\n    context,\n    textureAtlasCoordinates,\n    vafWriters,\n    billboard\n  );\n  writeCompressedAttrib2(\n    billboardCollection,\n    context,\n    textureAtlasCoordinates,\n    vafWriters,\n    billboard\n  );\n  writeEyeOffset(\n    billboardCollection,\n    context,\n    textureAtlasCoordinates,\n    vafWriters,\n    billboard\n  );\n  writeScaleByDistance(\n    billboardCollection,\n    context,\n    textureAtlasCoordinates,\n    vafWriters,\n    billboard\n  );\n  writePixelOffsetScaleByDistance(\n    billboardCollection,\n    context,\n    textureAtlasCoordinates,\n    vafWriters,\n    billboard\n  );\n  writeCompressedAttribute3(\n    billboardCollection,\n    context,\n    textureAtlasCoordinates,\n    vafWriters,\n    billboard\n  );\n  writeTextureCoordinateBoundsOrLabelTranslate(\n    billboardCollection,\n    context,\n    textureAtlasCoordinates,\n    vafWriters,\n    billboard\n  );\n  writeBatchId(\n    billboardCollection,\n    context,\n    textureAtlasCoordinates,\n    vafWriters,\n    billboard\n  );\n  writeSDF(\n    billboardCollection,\n    context,\n    textureAtlasCoordinates,\n    vafWriters,\n    billboard\n  );\n}\n\nfunction recomputeActualPositions(\n  billboardCollection,\n  billboards,\n  length,\n  frameState,\n  modelMatrix,\n  recomputeBoundingVolume\n) {\n  var boundingVolume;\n  if (frameState.mode === SceneMode.SCENE3D) {\n    boundingVolume = billboardCollection._baseVolume;\n    billboardCollection._boundingVolumeDirty = true;\n  } else {\n    boundingVolume = billboardCollection._baseVolume2D;\n  }\n\n  var positions = [];\n  for (var i = 0; i < length; ++i) {\n    var billboard = billboards[i];\n    var position = billboard.position;\n    var actualPosition = Billboard._computeActualPosition(\n      billboard,\n      position,\n      frameState,\n      modelMatrix\n    );\n    if (defined(actualPosition)) {\n      billboard._setActualPosition(actualPosition);\n\n      if (recomputeBoundingVolume) {\n        positions.push(actualPosition);\n      } else {\n        BoundingSphere.expand(boundingVolume, actualPosition, boundingVolume);\n      }\n    }\n  }\n\n  if (recomputeBoundingVolume) {\n    BoundingSphere.fromPoints(positions, boundingVolume);\n  }\n}\n\nfunction updateMode(billboardCollection, frameState) {\n  var mode = frameState.mode;\n\n  var billboards = billboardCollection._billboards;\n  var billboardsToUpdate = billboardCollection._billboardsToUpdate;\n  var modelMatrix = billboardCollection._modelMatrix;\n\n  if (\n    billboardCollection._createVertexArray ||\n    billboardCollection._mode !== mode ||\n    (mode !== SceneMode.SCENE3D &&\n      !Matrix4.equals(modelMatrix, billboardCollection.modelMatrix))\n  ) {\n    billboardCollection._mode = mode;\n    Matrix4.clone(billboardCollection.modelMatrix, modelMatrix);\n    billboardCollection._createVertexArray = true;\n\n    if (\n      mode === SceneMode.SCENE3D ||\n      mode === SceneMode.SCENE2D ||\n      mode === SceneMode.COLUMBUS_VIEW\n    ) {\n      recomputeActualPositions(\n        billboardCollection,\n        billboards,\n        billboards.length,\n        frameState,\n        modelMatrix,\n        true\n      );\n    }\n  } else if (mode === SceneMode.MORPHING) {\n    recomputeActualPositions(\n      billboardCollection,\n      billboards,\n      billboards.length,\n      frameState,\n      modelMatrix,\n      true\n    );\n  } else if (mode === SceneMode.SCENE2D || mode === SceneMode.COLUMBUS_VIEW) {\n    recomputeActualPositions(\n      billboardCollection,\n      billboardsToUpdate,\n      billboardCollection._billboardsToUpdateIndex,\n      frameState,\n      modelMatrix,\n      false\n    );\n  }\n}\n\nfunction updateBoundingVolume(collection, frameState, boundingVolume) {\n  var pixelScale = 1.0;\n  if (!collection._allSizedInMeters || collection._maxPixelOffset !== 0.0) {\n    pixelScale = frameState.camera.getPixelSize(\n      boundingVolume,\n      frameState.context.drawingBufferWidth,\n      frameState.context.drawingBufferHeight\n    );\n  }\n\n  var size = pixelScale * collection._maxScale * collection._maxSize * 2.0;\n  if (collection._allHorizontalCenter && collection._allVerticalCenter) {\n    size *= 0.5;\n  }\n\n  var offset =\n    pixelScale * collection._maxPixelOffset + collection._maxEyeOffset;\n  boundingVolume.radius += size + offset;\n}\n\nfunction createDebugCommand(billboardCollection, context) {\n  var fs;\n  fs =\n    \"uniform sampler2D billboard_texture; \\n\" +\n    \"varying vec2 v_textureCoordinates; \\n\" +\n    \"void main() \\n\" +\n    \"{ \\n\" +\n    \"    gl_FragColor = texture2D(billboard_texture, v_textureCoordinates); \\n\" +\n    \"} \\n\";\n\n  var drawCommand = context.createViewportQuadCommand(fs, {\n    uniformMap: {\n      billboard_texture: function () {\n        return billboardCollection._textureAtlas.texture;\n      },\n    },\n  });\n  drawCommand.pass = Pass.OVERLAY;\n  return drawCommand;\n}\n\nvar scratchWriterArray = [];\n\n/**\n * Called when {@link Viewer} or {@link CesiumWidget} render the scene to\n * get the draw commands needed to render this primitive.\n * <p>\n * Do not call this function directly.  This is documented just to\n * list the exceptions that may be propagated when the scene is rendered:\n * </p>\n *\n * @exception {RuntimeError} image with id must be in the atlas.\n */\nBillboardCollection.prototype.update = function (frameState) {\n  removeBillboards(this);\n  var billboards = this._billboards;\n  var billboardsLength = billboards.length;\n\n  var context = frameState.context;\n  this._instanced = context.instancedArrays;\n  attributeLocations = this._instanced\n    ? attributeLocationsInstanced\n    : attributeLocationsBatched;\n  getIndexBuffer = this._instanced\n    ? getIndexBufferInstanced\n    : getIndexBufferBatched;\n\n  var textureAtlas = this._textureAtlas;\n  if (!defined(textureAtlas)) {\n    textureAtlas = this._textureAtlas = new TextureAtlas({\n      context: context,\n    });\n\n    for (var ii = 0; ii < billboardsLength; ++ii) {\n      billboards[ii]._loadImage();\n    }\n  }\n\n  var textureAtlasCoordinates = textureAtlas.textureCoordinates;\n  if (textureAtlasCoordinates.length === 0) {\n    // Can't write billboard vertices until we have texture coordinates\n    // provided by a texture atlas\n    return;\n  }\n\n  updateMode(this, frameState);\n\n  billboards = this._billboards;\n  billboardsLength = billboards.length;\n  var billboardsToUpdate = this._billboardsToUpdate;\n  var billboardsToUpdateLength = this._billboardsToUpdateIndex;\n\n  var properties = this._propertiesChanged;\n\n  var textureAtlasGUID = textureAtlas.guid;\n  var createVertexArray =\n    this._createVertexArray || this._textureAtlasGUID !== textureAtlasGUID;\n  this._textureAtlasGUID = textureAtlasGUID;\n\n  var vafWriters;\n  var pass = frameState.passes;\n  var picking = pass.pick;\n\n  // PERFORMANCE_IDEA: Round robin multiple buffers.\n  if (createVertexArray || (!picking && this.computeNewBuffersUsage())) {\n    this._createVertexArray = false;\n\n    for (var k = 0; k < NUMBER_OF_PROPERTIES; ++k) {\n      properties[k] = 0;\n    }\n\n    this._vaf = this._vaf && this._vaf.destroy();\n\n    if (billboardsLength > 0) {\n      // PERFORMANCE_IDEA:  Instead of creating a new one, resize like std::vector.\n      this._vaf = createVAF(\n        context,\n        billboardsLength,\n        this._buffersUsage,\n        this._instanced,\n        this._batchTable,\n        this._sdf\n      );\n      vafWriters = this._vaf.writers;\n\n      // Rewrite entire buffer if billboards were added or removed.\n      for (var i = 0; i < billboardsLength; ++i) {\n        var billboard = this._billboards[i];\n        billboard._dirty = false; // In case it needed an update.\n        writeBillboard(\n          this,\n          context,\n          textureAtlasCoordinates,\n          vafWriters,\n          billboard\n        );\n      }\n\n      // Different billboard collections share the same index buffer.\n      this._vaf.commit(getIndexBuffer(context));\n    }\n\n    this._billboardsToUpdateIndex = 0;\n  } else if (billboardsToUpdateLength > 0) {\n    // Billboards were modified, but none were added or removed.\n    var writers = scratchWriterArray;\n    writers.length = 0;\n\n    if (\n      properties[POSITION_INDEX] ||\n      properties[ROTATION_INDEX] ||\n      properties[SCALE_INDEX]\n    ) {\n      writers.push(writePositionScaleAndRotation);\n    }\n\n    if (\n      properties[IMAGE_INDEX_INDEX] ||\n      properties[PIXEL_OFFSET_INDEX] ||\n      properties[HORIZONTAL_ORIGIN_INDEX] ||\n      properties[VERTICAL_ORIGIN_INDEX] ||\n      properties[SHOW_INDEX]\n    ) {\n      writers.push(writeCompressedAttrib0);\n      if (this._instanced) {\n        writers.push(writeEyeOffset);\n      }\n    }\n\n    if (\n      properties[IMAGE_INDEX_INDEX] ||\n      properties[ALIGNED_AXIS_INDEX] ||\n      properties[TRANSLUCENCY_BY_DISTANCE_INDEX]\n    ) {\n      writers.push(writeCompressedAttrib1);\n      writers.push(writeCompressedAttrib2);\n    }\n\n    if (properties[IMAGE_INDEX_INDEX] || properties[COLOR_INDEX]) {\n      writers.push(writeCompressedAttrib2);\n    }\n\n    if (properties[EYE_OFFSET_INDEX]) {\n      writers.push(writeEyeOffset);\n    }\n\n    if (properties[SCALE_BY_DISTANCE_INDEX]) {\n      writers.push(writeScaleByDistance);\n    }\n\n    if (properties[PIXEL_OFFSET_SCALE_BY_DISTANCE_INDEX]) {\n      writers.push(writePixelOffsetScaleByDistance);\n    }\n\n    if (\n      properties[DISTANCE_DISPLAY_CONDITION_INDEX] ||\n      properties[DISABLE_DEPTH_DISTANCE] ||\n      properties[IMAGE_INDEX_INDEX] ||\n      properties[POSITION_INDEX]\n    ) {\n      writers.push(writeCompressedAttribute3);\n    }\n\n    if (properties[IMAGE_INDEX_INDEX] || properties[POSITION_INDEX]) {\n      writers.push(writeTextureCoordinateBoundsOrLabelTranslate);\n    }\n\n    if (properties[SDF_INDEX]) {\n      writers.push(writeSDF);\n    }\n\n    var numWriters = writers.length;\n    vafWriters = this._vaf.writers;\n\n    if (billboardsToUpdateLength / billboardsLength > 0.1) {\n      // If more than 10% of billboard change, rewrite the entire buffer.\n\n      // PERFORMANCE_IDEA:  I totally made up 10% :).\n\n      for (var m = 0; m < billboardsToUpdateLength; ++m) {\n        var b = billboardsToUpdate[m];\n        b._dirty = false;\n\n        for (var n = 0; n < numWriters; ++n) {\n          writers[n](this, context, textureAtlasCoordinates, vafWriters, b);\n        }\n      }\n      this._vaf.commit(getIndexBuffer(context));\n    } else {\n      for (var h = 0; h < billboardsToUpdateLength; ++h) {\n        var bb = billboardsToUpdate[h];\n        bb._dirty = false;\n\n        for (var o = 0; o < numWriters; ++o) {\n          writers[o](this, context, textureAtlasCoordinates, vafWriters, bb);\n        }\n\n        if (this._instanced) {\n          this._vaf.subCommit(bb._index, 1);\n        } else {\n          this._vaf.subCommit(bb._index * 4, 4);\n        }\n      }\n      this._vaf.endSubCommits();\n    }\n\n    this._billboardsToUpdateIndex = 0;\n  }\n\n  // If the number of total billboards ever shrinks considerably\n  // Truncate billboardsToUpdate so that we free memory that we're\n  // not going to be using.\n  if (billboardsToUpdateLength > billboardsLength * 1.5) {\n    billboardsToUpdate.length = billboardsLength;\n  }\n\n  if (!defined(this._vaf) || !defined(this._vaf.va)) {\n    return;\n  }\n\n  if (this._boundingVolumeDirty) {\n    this._boundingVolumeDirty = false;\n    BoundingSphere.transform(\n      this._baseVolume,\n      this.modelMatrix,\n      this._baseVolumeWC\n    );\n  }\n\n  var boundingVolume;\n  var modelMatrix = Matrix4.IDENTITY;\n  if (frameState.mode === SceneMode.SCENE3D) {\n    modelMatrix = this.modelMatrix;\n    boundingVolume = BoundingSphere.clone(\n      this._baseVolumeWC,\n      this._boundingVolume\n    );\n  } else {\n    boundingVolume = BoundingSphere.clone(\n      this._baseVolume2D,\n      this._boundingVolume\n    );\n  }\n  updateBoundingVolume(this, frameState, boundingVolume);\n\n  var blendOptionChanged = this._blendOption !== this.blendOption;\n  this._blendOption = this.blendOption;\n\n  if (blendOptionChanged) {\n    if (\n      this._blendOption === BlendOption.OPAQUE ||\n      this._blendOption === BlendOption.OPAQUE_AND_TRANSLUCENT\n    ) {\n      this._rsOpaque = RenderState.fromCache({\n        depthTest: {\n          enabled: true,\n          func: WebGLConstants.LESS,\n        },\n        depthMask: true,\n      });\n    } else {\n      this._rsOpaque = undefined;\n    }\n\n    // If OPAQUE_AND_TRANSLUCENT is in use, only the opaque pass gets the benefit of the depth buffer,\n    // not the translucent pass.  Otherwise, if the TRANSLUCENT pass is on its own, it turns on\n    // a depthMask in lieu of full depth sorting (because it has opaque-ish fragments that look bad in OIT).\n    // When the TRANSLUCENT depth mask is in use, label backgrounds require the depth func to be LEQUAL.\n    var useTranslucentDepthMask = this._blendOption === BlendOption.TRANSLUCENT;\n\n    if (\n      this._blendOption === BlendOption.TRANSLUCENT ||\n      this._blendOption === BlendOption.OPAQUE_AND_TRANSLUCENT\n    ) {\n      this._rsTranslucent = RenderState.fromCache({\n        depthTest: {\n          enabled: true,\n          func: useTranslucentDepthMask\n            ? WebGLConstants.LEQUAL\n            : WebGLConstants.LESS,\n        },\n        depthMask: useTranslucentDepthMask,\n        blending: BlendingState.ALPHA_BLEND,\n      });\n    } else {\n      this._rsTranslucent = undefined;\n    }\n  }\n\n  this._shaderDisableDepthDistance =\n    this._shaderDisableDepthDistance ||\n    frameState.minimumDisableDepthTestDistance !== 0.0;\n\n  var vsSource;\n  var fsSource;\n  var vs;\n  var fs;\n  var vertDefines;\n\n  var supportVSTextureReads = ContextLimits.maximumVertexTextureImageUnits > 0;\n\n  if (\n    blendOptionChanged ||\n    this._shaderRotation !== this._compiledShaderRotation ||\n    this._shaderAlignedAxis !== this._compiledShaderAlignedAxis ||\n    this._shaderScaleByDistance !== this._compiledShaderScaleByDistance ||\n    this._shaderTranslucencyByDistance !==\n      this._compiledShaderTranslucencyByDistance ||\n    this._shaderPixelOffsetScaleByDistance !==\n      this._compiledShaderPixelOffsetScaleByDistance ||\n    this._shaderDistanceDisplayCondition !==\n      this._compiledShaderDistanceDisplayCondition ||\n    this._shaderDisableDepthDistance !==\n      this._compiledShaderDisableDepthDistance ||\n    this._shaderClampToGround !== this._compiledShaderClampToGround ||\n    this._sdf !== this._compiledSDF\n  ) {\n    vsSource = BillboardCollectionVS;\n    fsSource = BillboardCollectionFS;\n\n    vertDefines = [];\n    if (defined(this._batchTable)) {\n      vertDefines.push(\"VECTOR_TILE\");\n      vsSource = this._batchTable.getVertexShaderCallback(\n        false,\n        \"a_batchId\",\n        undefined\n      )(vsSource);\n      fsSource = this._batchTable.getFragmentShaderCallback(\n        false,\n        undefined\n      )(fsSource);\n    }\n\n    vs = new ShaderSource({\n      defines: vertDefines,\n      sources: [vsSource],\n    });\n    if (this._instanced) {\n      vs.defines.push(\"INSTANCED\");\n    }\n    if (this._shaderRotation) {\n      vs.defines.push(\"ROTATION\");\n    }\n    if (this._shaderAlignedAxis) {\n      vs.defines.push(\"ALIGNED_AXIS\");\n    }\n    if (this._shaderScaleByDistance) {\n      vs.defines.push(\"EYE_DISTANCE_SCALING\");\n    }\n    if (this._shaderTranslucencyByDistance) {\n      vs.defines.push(\"EYE_DISTANCE_TRANSLUCENCY\");\n    }\n    if (this._shaderPixelOffsetScaleByDistance) {\n      vs.defines.push(\"EYE_DISTANCE_PIXEL_OFFSET\");\n    }\n    if (this._shaderDistanceDisplayCondition) {\n      vs.defines.push(\"DISTANCE_DISPLAY_CONDITION\");\n    }\n    if (this._shaderDisableDepthDistance) {\n      vs.defines.push(\"DISABLE_DEPTH_DISTANCE\");\n    }\n    if (this._shaderClampToGround) {\n      if (supportVSTextureReads) {\n        vs.defines.push(\"VERTEX_DEPTH_CHECK\");\n      } else {\n        vs.defines.push(\"FRAGMENT_DEPTH_CHECK\");\n      }\n    }\n\n    var sdfEdge = 1.0 - SDFSettings.CUTOFF;\n\n    if (this._sdf) {\n      vs.defines.push(\"SDF\");\n    }\n\n    var vectorFragDefine = defined(this._batchTable) ? \"VECTOR_TILE\" : \"\";\n\n    if (this._blendOption === BlendOption.OPAQUE_AND_TRANSLUCENT) {\n      fs = new ShaderSource({\n        defines: [\"OPAQUE\", vectorFragDefine],\n        sources: [fsSource],\n      });\n      if (this._shaderClampToGround) {\n        if (supportVSTextureReads) {\n          fs.defines.push(\"VERTEX_DEPTH_CHECK\");\n        } else {\n          fs.defines.push(\"FRAGMENT_DEPTH_CHECK\");\n        }\n      }\n\n      if (this._sdf) {\n        fs.defines.push(\"SDF\");\n        fs.defines.push(\"SDF_EDGE \" + sdfEdge);\n      }\n\n      this._sp = ShaderProgram.replaceCache({\n        context: context,\n        shaderProgram: this._sp,\n        vertexShaderSource: vs,\n        fragmentShaderSource: fs,\n        attributeLocations: attributeLocations,\n      });\n\n      fs = new ShaderSource({\n        defines: [\"TRANSLUCENT\", vectorFragDefine],\n        sources: [fsSource],\n      });\n      if (this._shaderClampToGround) {\n        if (supportVSTextureReads) {\n          fs.defines.push(\"VERTEX_DEPTH_CHECK\");\n        } else {\n          fs.defines.push(\"FRAGMENT_DEPTH_CHECK\");\n        }\n      }\n      if (this._sdf) {\n        fs.defines.push(\"SDF\");\n        fs.defines.push(\"SDF_EDGE \" + sdfEdge);\n      }\n      this._spTranslucent = ShaderProgram.replaceCache({\n        context: context,\n        shaderProgram: this._spTranslucent,\n        vertexShaderSource: vs,\n        fragmentShaderSource: fs,\n        attributeLocations: attributeLocations,\n      });\n    }\n\n    if (this._blendOption === BlendOption.OPAQUE) {\n      fs = new ShaderSource({\n        defines: [vectorFragDefine],\n        sources: [fsSource],\n      });\n      if (this._shaderClampToGround) {\n        if (supportVSTextureReads) {\n          fs.defines.push(\"VERTEX_DEPTH_CHECK\");\n        } else {\n          fs.defines.push(\"FRAGMENT_DEPTH_CHECK\");\n        }\n      }\n      if (this._sdf) {\n        fs.defines.push(\"SDF\");\n        fs.defines.push(\"SDF_EDGE \" + sdfEdge);\n      }\n      this._sp = ShaderProgram.replaceCache({\n        context: context,\n        shaderProgram: this._sp,\n        vertexShaderSource: vs,\n        fragmentShaderSource: fs,\n        attributeLocations: attributeLocations,\n      });\n    }\n\n    if (this._blendOption === BlendOption.TRANSLUCENT) {\n      fs = new ShaderSource({\n        defines: [vectorFragDefine],\n        sources: [fsSource],\n      });\n      if (this._shaderClampToGround) {\n        if (supportVSTextureReads) {\n          fs.defines.push(\"VERTEX_DEPTH_CHECK\");\n        } else {\n          fs.defines.push(\"FRAGMENT_DEPTH_CHECK\");\n        }\n      }\n      if (this._sdf) {\n        fs.defines.push(\"SDF\");\n        fs.defines.push(\"SDF_EDGE \" + sdfEdge);\n      }\n      this._spTranslucent = ShaderProgram.replaceCache({\n        context: context,\n        shaderProgram: this._spTranslucent,\n        vertexShaderSource: vs,\n        fragmentShaderSource: fs,\n        attributeLocations: attributeLocations,\n      });\n    }\n\n    this._compiledShaderRotation = this._shaderRotation;\n    this._compiledShaderAlignedAxis = this._shaderAlignedAxis;\n    this._compiledShaderScaleByDistance = this._shaderScaleByDistance;\n    this._compiledShaderTranslucencyByDistance = this._shaderTranslucencyByDistance;\n    this._compiledShaderPixelOffsetScaleByDistance = this._shaderPixelOffsetScaleByDistance;\n    this._compiledShaderDistanceDisplayCondition = this._shaderDistanceDisplayCondition;\n    this._compiledShaderDisableDepthDistance = this._shaderDisableDepthDistance;\n    this._compiledShaderClampToGround = this._shaderClampToGround;\n    this._compiledSDF = this._sdf;\n  }\n\n  var commandList = frameState.commandList;\n\n  if (pass.render || pass.pick) {\n    var colorList = this._colorCommands;\n\n    var opaque = this._blendOption === BlendOption.OPAQUE;\n    var opaqueAndTranslucent =\n      this._blendOption === BlendOption.OPAQUE_AND_TRANSLUCENT;\n\n    var va = this._vaf.va;\n    var vaLength = va.length;\n\n    var uniforms = this._uniforms;\n    var pickId;\n    if (defined(this._batchTable)) {\n      uniforms = this._batchTable.getUniformMapCallback()(uniforms);\n      pickId = this._batchTable.getPickId();\n    } else {\n      pickId = \"v_pickColor\";\n    }\n\n    colorList.length = vaLength;\n    var totalLength = opaqueAndTranslucent ? vaLength * 2 : vaLength;\n    for (var j = 0; j < totalLength; ++j) {\n      var command = colorList[j];\n      if (!defined(command)) {\n        command = colorList[j] = new DrawCommand();\n      }\n\n      var opaqueCommand = opaque || (opaqueAndTranslucent && j % 2 === 0);\n\n      command.pass =\n        opaqueCommand || !opaqueAndTranslucent ? Pass.OPAQUE : Pass.TRANSLUCENT;\n      command.owner = this;\n\n      var index = opaqueAndTranslucent ? Math.floor(j / 2.0) : j;\n      command.boundingVolume = boundingVolume;\n      command.modelMatrix = modelMatrix;\n      command.count = va[index].indicesCount;\n      command.shaderProgram = opaqueCommand ? this._sp : this._spTranslucent;\n      command.uniformMap = uniforms;\n      command.vertexArray = va[index].va;\n      command.renderState = opaqueCommand\n        ? this._rsOpaque\n        : this._rsTranslucent;\n      command.debugShowBoundingVolume = this.debugShowBoundingVolume;\n      command.pickId = pickId;\n\n      if (this._instanced) {\n        command.count = 6;\n        command.instanceCount = billboardsLength;\n      }\n\n      commandList.push(command);\n    }\n\n    if (this.debugShowTextureAtlas) {\n      if (!defined(this.debugCommand)) {\n        this.debugCommand = createDebugCommand(this, frameState.context);\n      }\n\n      commandList.push(this.debugCommand);\n    }\n  }\n};\n\n/**\n * Returns true if this object was destroyed; otherwise, false.\n * <br /><br />\n * If this object was destroyed, it should not be used; calling any function other than\n * <code>isDestroyed</code> will result in a {@link DeveloperError} exception.\n *\n * @returns {Boolean} <code>true</code> if this object was destroyed; otherwise, <code>false</code>.\n *\n * @see BillboardCollection#destroy\n */\nBillboardCollection.prototype.isDestroyed = function () {\n  return false;\n};\n\n/**\n * Destroys the WebGL resources held by this object.  Destroying an object allows for deterministic\n * release of WebGL resources, instead of relying on the garbage collector to destroy this object.\n * <br /><br />\n * Once an object is destroyed, it should not be used; calling any function other than\n * <code>isDestroyed</code> will result in a {@link DeveloperError} exception.  Therefore,\n * assign the return value (<code>undefined</code>) to the object as done in the example.\n *\n * @exception {DeveloperError} This object was destroyed, i.e., destroy() was called.\n *\n *\n * @example\n * billboards = billboards && billboards.destroy();\n *\n * @see BillboardCollection#isDestroyed\n */\nBillboardCollection.prototype.destroy = function () {\n  if (defined(this._removeCallbackFunc)) {\n    this._removeCallbackFunc();\n    this._removeCallbackFunc = undefined;\n  }\n\n  this._textureAtlas =\n    this._destroyTextureAtlas &&\n    this._textureAtlas &&\n    this._textureAtlas.destroy();\n  this._sp = this._sp && this._sp.destroy();\n  this._spTranslucent = this._spTranslucent && this._spTranslucent.destroy();\n  this._vaf = this._vaf && this._vaf.destroy();\n  destroyBillboards(this._billboards);\n\n  return destroyObject(this);\n};\nexport default BillboardCollection;\n"]},"metadata":{},"sourceType":"module"}