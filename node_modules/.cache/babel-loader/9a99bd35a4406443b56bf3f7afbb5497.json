{"ast":null,"code":"import Uri from \"../ThirdParty/Uri.js\";\nimport when from \"../ThirdParty/when.js\";\nimport appendForwardSlash from \"./appendForwardSlash.js\";\nimport Check from \"./Check.js\";\nimport clone from \"./clone.js\";\nimport combine from \"./combine.js\";\nimport defaultValue from \"./defaultValue.js\";\nimport defined from \"./defined.js\";\nimport DeveloperError from \"./DeveloperError.js\";\nimport getAbsoluteUri from \"./getAbsoluteUri.js\";\nimport getBaseUri from \"./getBaseUri.js\";\nimport getExtensionFromUri from \"./getExtensionFromUri.js\";\nimport isBlobUri from \"./isBlobUri.js\";\nimport isCrossOriginUrl from \"./isCrossOriginUrl.js\";\nimport isDataUri from \"./isDataUri.js\";\nimport loadAndExecuteScript from \"./loadAndExecuteScript.js\";\nimport objectToQuery from \"./objectToQuery.js\";\nimport queryToObject from \"./queryToObject.js\";\nimport Request from \"./Request.js\";\nimport RequestErrorEvent from \"./RequestErrorEvent.js\";\nimport RequestScheduler from \"./RequestScheduler.js\";\nimport RequestState from \"./RequestState.js\";\nimport RuntimeError from \"./RuntimeError.js\";\nimport TrustedServers from \"./TrustedServers.js\";\n\nvar xhrBlobSupported = function () {\n  try {\n    var xhr = new XMLHttpRequest();\n    xhr.open(\"GET\", \"#\", true);\n    xhr.responseType = \"blob\";\n    return xhr.responseType === \"blob\";\n  } catch (e) {\n    return false;\n  }\n}();\n/**\n * Parses a query string and returns the object equivalent.\n *\n * @param {Uri} uri The Uri with a query object.\n * @param {Resource} resource The Resource that will be assigned queryParameters.\n * @param {Boolean} merge If true, we'll merge with the resource's existing queryParameters. Otherwise they will be replaced.\n * @param {Boolean} preserveQueryParameters If true duplicate parameters will be concatenated into an array. If false, keys in uri will take precedence.\n *\n * @private\n */\n\n\nfunction parseQuery(uri, resource, merge, preserveQueryParameters) {\n  var queryString = uri.query;\n\n  if (!defined(queryString) || queryString.length === 0) {\n    return {};\n  }\n\n  var query; // Special case we run into where the querystring is just a string, not key/value pairs\n\n  if (queryString.indexOf(\"=\") === -1) {\n    var result = {};\n    result[queryString] = undefined;\n    query = result;\n  } else {\n    query = queryToObject(queryString);\n  }\n\n  if (merge) {\n    resource._queryParameters = combineQueryParameters(query, resource._queryParameters, preserveQueryParameters);\n  } else {\n    resource._queryParameters = query;\n  }\n\n  uri.query = undefined;\n}\n/**\n * Converts a query object into a string.\n *\n * @param {Uri} uri The Uri object that will have the query object set.\n * @param {Resource} resource The resource that has queryParameters\n *\n * @private\n */\n\n\nfunction stringifyQuery(uri, resource) {\n  var queryObject = resource._queryParameters;\n  var keys = Object.keys(queryObject); // We have 1 key with an undefined value, so this is just a string, not key/value pairs\n\n  if (keys.length === 1 && !defined(queryObject[keys[0]])) {\n    uri.query = keys[0];\n  } else {\n    uri.query = objectToQuery(queryObject);\n  }\n}\n/**\n * Clones a value if it is defined, otherwise returns the default value\n *\n * @param {*} [val] The value to clone.\n * @param {*} [defaultVal] The default value.\n *\n * @returns {*} A clone of val or the defaultVal.\n *\n * @private\n */\n\n\nfunction defaultClone(val, defaultVal) {\n  if (!defined(val)) {\n    return defaultVal;\n  }\n\n  return defined(val.clone) ? val.clone() : clone(val);\n}\n/**\n * Checks to make sure the Resource isn't already being requested.\n *\n * @param {Request} request The request to check.\n *\n * @private\n */\n\n\nfunction checkAndResetRequest(request) {\n  if (request.state === RequestState.ISSUED || request.state === RequestState.ACTIVE) {\n    throw new RuntimeError(\"The Resource is already being fetched.\");\n  }\n\n  request.state = RequestState.UNISSUED;\n  request.deferred = undefined;\n}\n/**\n * This combines a map of query parameters.\n *\n * @param {Object} q1 The first map of query parameters. Values in this map will take precedence if preserveQueryParameters is false.\n * @param {Object} q2 The second map of query parameters.\n * @param {Boolean} preserveQueryParameters If true duplicate parameters will be concatenated into an array. If false, keys in q1 will take precedence.\n *\n * @returns {Object} The combined map of query parameters.\n *\n * @example\n * var q1 = {\n *   a: 1,\n *   b: 2\n * };\n * var q2 = {\n *   a: 3,\n *   c: 4\n * };\n * var q3 = {\n *   b: [5, 6],\n *   d: 7\n * }\n *\n * // Returns\n * // {\n * //   a: [1, 3],\n * //   b: 2,\n * //   c: 4\n * // };\n * combineQueryParameters(q1, q2, true);\n *\n * // Returns\n * // {\n * //   a: 1,\n * //   b: 2,\n * //   c: 4\n * // };\n * combineQueryParameters(q1, q2, false);\n *\n * // Returns\n * // {\n * //   a: 1,\n * //   b: [2, 5, 6],\n * //   d: 7\n * // };\n * combineQueryParameters(q1, q3, true);\n *\n * // Returns\n * // {\n * //   a: 1,\n * //   b: 2,\n * //   d: 7\n * // };\n * combineQueryParameters(q1, q3, false);\n *\n * @private\n */\n\n\nfunction combineQueryParameters(q1, q2, preserveQueryParameters) {\n  if (!preserveQueryParameters) {\n    return combine(q1, q2);\n  }\n\n  var result = clone(q1, true);\n\n  for (var param in q2) {\n    if (q2.hasOwnProperty(param)) {\n      var value = result[param];\n      var q2Value = q2[param];\n\n      if (defined(value)) {\n        if (!Array.isArray(value)) {\n          value = result[param] = [value];\n        }\n\n        result[param] = value.concat(q2Value);\n      } else {\n        result[param] = Array.isArray(q2Value) ? q2Value.slice() : q2Value;\n      }\n    }\n  }\n\n  return result;\n}\n/**\n * A resource that includes the location and any other parameters we need to retrieve it or create derived resources. It also provides the ability to retry requests.\n *\n * @alias Resource\n * @constructor\n *\n * @param {String|Object} options A url or an object with the following properties\n * @param {String} options.url The url of the resource.\n * @param {Object} [options.queryParameters] An object containing query parameters that will be sent when retrieving the resource.\n * @param {Object} [options.templateValues] Key/Value pairs that are used to replace template values (eg. {x}).\n * @param {Object} [options.headers={}] Additional HTTP headers that will be sent.\n * @param {DefaultProxy} [options.proxy] A proxy to be used when loading the resource.\n * @param {Resource~RetryCallback} [options.retryCallback] The Function to call when a request for this resource fails. If it returns true, the request will be retried.\n * @param {Number} [options.retryAttempts=0] The number of times the retryCallback should be called before giving up.\n * @param {Request} [options.request] A Request object that will be used. Intended for internal use only.\n *\n * @example\n * function refreshTokenRetryCallback(resource, error) {\n *   if (error.statusCode === 403) {\n *     // 403 status code means a new token should be generated\n *     return getNewAccessToken()\n *       .then(function(token) {\n *         resource.queryParameters.access_token = token;\n *         return true;\n *       })\n *       .otherwise(function() {\n *         return false;\n *       });\n *   }\n *\n *   return false;\n * }\n *\n * var resource = new Resource({\n *    url: 'http://server.com/path/to/resource.json',\n *    proxy: new DefaultProxy('/proxy/'),\n *    headers: {\n *      'X-My-Header': 'valueOfHeader'\n *    },\n *    queryParameters: {\n *      'access_token': '123-435-456-000'\n *    },\n *    retryCallback: refreshTokenRetryCallback,\n *    retryAttempts: 1\n * });\n */\n\n\nfunction Resource(options) {\n  options = defaultValue(options, defaultValue.EMPTY_OBJECT);\n\n  if (typeof options === \"string\") {\n    options = {\n      url: options\n    };\n  } //>>includeStart('debug', pragmas.debug);\n\n\n  Check.typeOf.string(\"options.url\", options.url); //>>includeEnd('debug');\n\n  this._url = undefined;\n  this._templateValues = defaultClone(options.templateValues, {});\n  this._queryParameters = defaultClone(options.queryParameters, {});\n  /**\n   * Additional HTTP headers that will be sent with the request.\n   *\n   * @type {Object}\n   */\n\n  this.headers = defaultClone(options.headers, {});\n  /**\n   * A Request object that will be used. Intended for internal use only.\n   *\n   * @type {Request}\n   */\n\n  this.request = defaultValue(options.request, new Request());\n  /**\n   * A proxy to be used when loading the resource.\n   *\n   * @type {DefaultProxy}\n   */\n\n  this.proxy = options.proxy;\n  /**\n   * Function to call when a request for this resource fails. If it returns true or a Promise that resolves to true, the request will be retried.\n   *\n   * @type {Function}\n   */\n\n  this.retryCallback = options.retryCallback;\n  /**\n   * The number of times the retryCallback should be called before giving up.\n   *\n   * @type {Number}\n   */\n\n  this.retryAttempts = defaultValue(options.retryAttempts, 0);\n  this._retryCount = 0;\n  var uri = new Uri(options.url);\n  parseQuery(uri, this, true, true); // Remove the fragment as it's not sent with a request\n\n  uri.fragment = undefined;\n  this._url = uri.toString();\n}\n/**\n * A helper function to create a resource depending on whether we have a String or a Resource\n *\n * @param {Resource|String} resource A Resource or a String to use when creating a new Resource.\n *\n * @returns {Resource} If resource is a String, a Resource constructed with the url and options. Otherwise the resource parameter is returned.\n *\n * @private\n */\n\n\nResource.createIfNeeded = function (resource) {\n  if (resource instanceof Resource) {\n    // Keep existing request object. This function is used internally to duplicate a Resource, so that it can't\n    //  be modified outside of a class that holds it (eg. an imagery or terrain provider). Since the Request objects\n    //  are managed outside of the providers, by the tile loading code, we want to keep the request property the same so if it is changed\n    //  in the underlying tiling code the requests for this resource will use it.\n    return resource.getDerivedResource({\n      request: resource.request\n    });\n  }\n\n  if (typeof resource !== \"string\") {\n    return resource;\n  }\n\n  return new Resource({\n    url: resource\n  });\n};\n\nvar supportsImageBitmapOptionsPromise;\n/**\n * A helper function to check whether createImageBitmap supports passing ImageBitmapOptions.\n *\n * @returns {Promise<Boolean>} A promise that resolves to true if this browser supports creating an ImageBitmap with options.\n *\n * @private\n */\n\nResource.supportsImageBitmapOptions = function () {\n  // Until the HTML folks figure out what to do about this, we need to actually try loading an image to\n  // know if this browser supports passing options to the createImageBitmap function.\n  // https://github.com/whatwg/html/pull/4248\n  if (defined(supportsImageBitmapOptionsPromise)) {\n    return supportsImageBitmapOptionsPromise;\n  }\n\n  if (typeof createImageBitmap !== \"function\") {\n    supportsImageBitmapOptionsPromise = when.resolve(false);\n    return supportsImageBitmapOptionsPromise;\n  }\n\n  var imageDataUri = \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWP4////fwAJ+wP9CNHoHgAAAABJRU5ErkJggg==\";\n  supportsImageBitmapOptionsPromise = Resource.fetchBlob({\n    url: imageDataUri\n  }).then(function (blob) {\n    return createImageBitmap(blob, {\n      imageOrientation: \"flipY\",\n      premultiplyAlpha: \"none\"\n    });\n  }).then(function (imageBitmap) {\n    return true;\n  }).otherwise(function () {\n    return false;\n  });\n  return supportsImageBitmapOptionsPromise;\n};\n\nObject.defineProperties(Resource, {\n  /**\n   * Returns true if blobs are supported.\n   *\n   * @memberof Resource\n   * @type {Boolean}\n   *\n   * @readonly\n   */\n  isBlobSupported: {\n    get: function get() {\n      return xhrBlobSupported;\n    }\n  }\n});\nObject.defineProperties(Resource.prototype, {\n  /**\n   * Query parameters appended to the url.\n   *\n   * @memberof Resource.prototype\n   * @type {Object}\n   *\n   * @readonly\n   */\n  queryParameters: {\n    get: function get() {\n      return this._queryParameters;\n    }\n  },\n\n  /**\n   * The key/value pairs used to replace template parameters in the url.\n   *\n   * @memberof Resource.prototype\n   * @type {Object}\n   *\n   * @readonly\n   */\n  templateValues: {\n    get: function get() {\n      return this._templateValues;\n    }\n  },\n\n  /**\n   * The url to the resource with template values replaced, query string appended and encoded by proxy if one was set.\n   *\n   * @memberof Resource.prototype\n   * @type {String}\n   */\n  url: {\n    get: function get() {\n      return this.getUrlComponent(true, true);\n    },\n    set: function set(value) {\n      var uri = new Uri(value);\n      parseQuery(uri, this, false); // Remove the fragment as it's not sent with a request\n\n      uri.fragment = undefined;\n      this._url = uri.toString();\n    }\n  },\n\n  /**\n   * The file extension of the resource.\n   *\n   * @memberof Resource.prototype\n   * @type {String}\n   *\n   * @readonly\n   */\n  extension: {\n    get: function get() {\n      return getExtensionFromUri(this._url);\n    }\n  },\n\n  /**\n   * True if the Resource refers to a data URI.\n   *\n   * @memberof Resource.prototype\n   * @type {Boolean}\n   */\n  isDataUri: {\n    get: function get() {\n      return isDataUri(this._url);\n    }\n  },\n\n  /**\n   * True if the Resource refers to a blob URI.\n   *\n   * @memberof Resource.prototype\n   * @type {Boolean}\n   */\n  isBlobUri: {\n    get: function get() {\n      return isBlobUri(this._url);\n    }\n  },\n\n  /**\n   * True if the Resource refers to a cross origin URL.\n   *\n   * @memberof Resource.prototype\n   * @type {Boolean}\n   */\n  isCrossOriginUrl: {\n    get: function get() {\n      return isCrossOriginUrl(this._url);\n    }\n  },\n\n  /**\n   * True if the Resource has request headers. This is equivalent to checking if the headers property has any keys.\n   *\n   * @memberof Resource.prototype\n   * @type {Boolean}\n   */\n  hasHeaders: {\n    get: function get() {\n      return Object.keys(this.headers).length > 0;\n    }\n  }\n});\n/**\n * Returns the url, optional with the query string and processed by a proxy.\n *\n * @param {Boolean} [query=false] If true, the query string is included.\n * @param {Boolean} [proxy=false] If true, the url is processed the proxy object if defined.\n *\n * @returns {String} The url with all the requested components.\n */\n\nResource.prototype.getUrlComponent = function (query, proxy) {\n  if (this.isDataUri) {\n    return this._url;\n  }\n\n  var uri = new Uri(this._url);\n\n  if (query) {\n    stringifyQuery(uri, this);\n  } // objectToQuery escapes the placeholders.  Undo that.\n\n\n  var url = uri.toString().replace(/%7B/g, \"{\").replace(/%7D/g, \"}\");\n  var templateValues = this._templateValues;\n  url = url.replace(/{(.*?)}/g, function (match, key) {\n    var replacement = templateValues[key];\n\n    if (defined(replacement)) {\n      // use the replacement value from templateValues if there is one...\n      return encodeURIComponent(replacement);\n    } // otherwise leave it unchanged\n\n\n    return match;\n  });\n\n  if (proxy && defined(this.proxy)) {\n    url = this.proxy.getURL(url);\n  }\n\n  return url;\n};\n/**\n * Combines the specified object and the existing query parameters. This allows you to add many parameters at once,\n *  as opposed to adding them one at a time to the queryParameters property. If a value is already set, it will be replaced with the new value.\n *\n * @param {Object} params The query parameters\n * @param {Boolean} [useAsDefault=false] If true the params will be used as the default values, so they will only be set if they are undefined.\n */\n\n\nResource.prototype.setQueryParameters = function (params, useAsDefault) {\n  if (useAsDefault) {\n    this._queryParameters = combineQueryParameters(this._queryParameters, params, false);\n  } else {\n    this._queryParameters = combineQueryParameters(params, this._queryParameters, false);\n  }\n};\n/**\n * Combines the specified object and the existing query parameters. This allows you to add many parameters at once,\n *  as opposed to adding them one at a time to the queryParameters property.\n *\n * @param {Object} params The query parameters\n */\n\n\nResource.prototype.appendQueryParameters = function (params) {\n  this._queryParameters = combineQueryParameters(params, this._queryParameters, true);\n};\n/**\n * Combines the specified object and the existing template values. This allows you to add many values at once,\n *  as opposed to adding them one at a time to the templateValues property. If a value is already set, it will become an array and the new value will be appended.\n *\n * @param {Object} template The template values\n * @param {Boolean} [useAsDefault=false] If true the values will be used as the default values, so they will only be set if they are undefined.\n */\n\n\nResource.prototype.setTemplateValues = function (template, useAsDefault) {\n  if (useAsDefault) {\n    this._templateValues = combine(this._templateValues, template);\n  } else {\n    this._templateValues = combine(template, this._templateValues);\n  }\n};\n/**\n * Returns a resource relative to the current instance. All properties remain the same as the current instance unless overridden in options.\n *\n * @param {Object} options An object with the following properties\n * @param {String} [options.url]  The url that will be resolved relative to the url of the current instance.\n * @param {Object} [options.queryParameters] An object containing query parameters that will be combined with those of the current instance.\n * @param {Object} [options.templateValues] Key/Value pairs that are used to replace template values (eg. {x}). These will be combined with those of the current instance.\n * @param {Object} [options.headers={}] Additional HTTP headers that will be sent.\n * @param {DefaultProxy} [options.proxy] A proxy to be used when loading the resource.\n * @param {Resource~RetryCallback} [options.retryCallback] The function to call when loading the resource fails.\n * @param {Number} [options.retryAttempts] The number of times the retryCallback should be called before giving up.\n * @param {Request} [options.request] A Request object that will be used. Intended for internal use only.\n * @param {Boolean} [options.preserveQueryParameters=false] If true, this will keep all query parameters from the current resource and derived resource. If false, derived parameters will replace those of the current resource.\n *\n * @returns {Resource} The resource derived from the current one.\n */\n\n\nResource.prototype.getDerivedResource = function (options) {\n  var resource = this.clone();\n  resource._retryCount = 0;\n\n  if (defined(options.url)) {\n    var uri = new Uri(options.url);\n    var preserveQueryParameters = defaultValue(options.preserveQueryParameters, false);\n    parseQuery(uri, resource, true, preserveQueryParameters); // Remove the fragment as it's not sent with a request\n\n    uri.fragment = undefined;\n    resource._url = uri.resolve(new Uri(getAbsoluteUri(this._url))).toString();\n  }\n\n  if (defined(options.queryParameters)) {\n    resource._queryParameters = combine(options.queryParameters, resource._queryParameters);\n  }\n\n  if (defined(options.templateValues)) {\n    resource._templateValues = combine(options.templateValues, resource.templateValues);\n  }\n\n  if (defined(options.headers)) {\n    resource.headers = combine(options.headers, resource.headers);\n  }\n\n  if (defined(options.proxy)) {\n    resource.proxy = options.proxy;\n  }\n\n  if (defined(options.request)) {\n    resource.request = options.request;\n  }\n\n  if (defined(options.retryCallback)) {\n    resource.retryCallback = options.retryCallback;\n  }\n\n  if (defined(options.retryAttempts)) {\n    resource.retryAttempts = options.retryAttempts;\n  }\n\n  return resource;\n};\n/**\n * Called when a resource fails to load. This will call the retryCallback function if defined until retryAttempts is reached.\n *\n * @param {Error} [error] The error that was encountered.\n *\n * @returns {Promise<Boolean>} A promise to a boolean, that if true will cause the resource request to be retried.\n *\n * @private\n */\n\n\nResource.prototype.retryOnError = function (error) {\n  var retryCallback = this.retryCallback;\n\n  if (typeof retryCallback !== \"function\" || this._retryCount >= this.retryAttempts) {\n    return when(false);\n  }\n\n  var that = this;\n  return when(retryCallback(this, error)).then(function (result) {\n    ++that._retryCount;\n    return result;\n  });\n};\n/**\n * Duplicates a Resource instance.\n *\n * @param {Resource} [result] The object onto which to store the result.\n *\n * @returns {Resource} The modified result parameter or a new Resource instance if one was not provided.\n */\n\n\nResource.prototype.clone = function (result) {\n  if (!defined(result)) {\n    result = new Resource({\n      url: this._url\n    });\n  }\n\n  result._url = this._url;\n  result._queryParameters = clone(this._queryParameters);\n  result._templateValues = clone(this._templateValues);\n  result.headers = clone(this.headers);\n  result.proxy = this.proxy;\n  result.retryCallback = this.retryCallback;\n  result.retryAttempts = this.retryAttempts;\n  result._retryCount = 0;\n  result.request = this.request.clone();\n  return result;\n};\n/**\n * Returns the base path of the Resource.\n *\n * @param {Boolean} [includeQuery = false] Whether or not to include the query string and fragment form the uri\n *\n * @returns {String} The base URI of the resource\n */\n\n\nResource.prototype.getBaseUri = function (includeQuery) {\n  return getBaseUri(this.getUrlComponent(includeQuery), includeQuery);\n};\n/**\n * Appends a forward slash to the URL.\n */\n\n\nResource.prototype.appendForwardSlash = function () {\n  this._url = appendForwardSlash(this._url);\n};\n/**\n * Asynchronously loads the resource as raw binary data.  Returns a promise that will resolve to\n * an ArrayBuffer once loaded, or reject if the resource failed to load.  The data is loaded\n * using XMLHttpRequest, which means that in order to make requests to another origin,\n * the server must have Cross-Origin Resource Sharing (CORS) headers enabled.\n *\n * @returns {Promise.<ArrayBuffer>|undefined} a promise that will resolve to the requested data when loaded. Returns undefined if <code>request.throttle</code> is true and the request does not have high enough priority.\n *\n * @example\n * // load a single URL asynchronously\n * resource.fetchArrayBuffer().then(function(arrayBuffer) {\n *     // use the data\n * }).otherwise(function(error) {\n *     // an error occurred\n * });\n *\n * @see {@link http://www.w3.org/TR/cors/|Cross-Origin Resource Sharing}\n * @see {@link http://wiki.commonjs.org/wiki/Promises/A|CommonJS Promises/A}\n */\n\n\nResource.prototype.fetchArrayBuffer = function () {\n  return this.fetch({\n    responseType: \"arraybuffer\"\n  });\n};\n/**\n * Creates a Resource and calls fetchArrayBuffer() on it.\n *\n * @param {String|Object} options A url or an object with the following properties\n * @param {String} options.url The url of the resource.\n * @param {Object} [options.queryParameters] An object containing query parameters that will be sent when retrieving the resource.\n * @param {Object} [options.templateValues] Key/Value pairs that are used to replace template values (eg. {x}).\n * @param {Object} [options.headers={}] Additional HTTP headers that will be sent.\n * @param {DefaultProxy} [options.proxy] A proxy to be used when loading the resource.\n * @param {Resource~RetryCallback} [options.retryCallback] The Function to call when a request for this resource fails. If it returns true, the request will be retried.\n * @param {Number} [options.retryAttempts=0] The number of times the retryCallback should be called before giving up.\n * @param {Request} [options.request] A Request object that will be used. Intended for internal use only.\n * @returns {Promise.<ArrayBuffer>|undefined} a promise that will resolve to the requested data when loaded. Returns undefined if <code>request.throttle</code> is true and the request does not have high enough priority.\n */\n\n\nResource.fetchArrayBuffer = function (options) {\n  var resource = new Resource(options);\n  return resource.fetchArrayBuffer();\n};\n/**\n * Asynchronously loads the given resource as a blob.  Returns a promise that will resolve to\n * a Blob once loaded, or reject if the resource failed to load.  The data is loaded\n * using XMLHttpRequest, which means that in order to make requests to another origin,\n * the server must have Cross-Origin Resource Sharing (CORS) headers enabled.\n *\n * @returns {Promise.<Blob>|undefined} a promise that will resolve to the requested data when loaded. Returns undefined if <code>request.throttle</code> is true and the request does not have high enough priority.\n *\n * @example\n * // load a single URL asynchronously\n * resource.fetchBlob().then(function(blob) {\n *     // use the data\n * }).otherwise(function(error) {\n *     // an error occurred\n * });\n *\n * @see {@link http://www.w3.org/TR/cors/|Cross-Origin Resource Sharing}\n * @see {@link http://wiki.commonjs.org/wiki/Promises/A|CommonJS Promises/A}\n */\n\n\nResource.prototype.fetchBlob = function () {\n  return this.fetch({\n    responseType: \"blob\"\n  });\n};\n/**\n * Creates a Resource and calls fetchBlob() on it.\n *\n * @param {String|Object} options A url or an object with the following properties\n * @param {String} options.url The url of the resource.\n * @param {Object} [options.queryParameters] An object containing query parameters that will be sent when retrieving the resource.\n * @param {Object} [options.templateValues] Key/Value pairs that are used to replace template values (eg. {x}).\n * @param {Object} [options.headers={}] Additional HTTP headers that will be sent.\n * @param {DefaultProxy} [options.proxy] A proxy to be used when loading the resource.\n * @param {Resource~RetryCallback} [options.retryCallback] The Function to call when a request for this resource fails. If it returns true, the request will be retried.\n * @param {Number} [options.retryAttempts=0] The number of times the retryCallback should be called before giving up.\n * @param {Request} [options.request] A Request object that will be used. Intended for internal use only.\n * @returns {Promise.<Blob>|undefined} a promise that will resolve to the requested data when loaded. Returns undefined if <code>request.throttle</code> is true and the request does not have high enough priority.\n */\n\n\nResource.fetchBlob = function (options) {\n  var resource = new Resource(options);\n  return resource.fetchBlob();\n};\n/**\n * Asynchronously loads the given image resource.  Returns a promise that will resolve to\n * an {@link https://developer.mozilla.org/en-US/docs/Web/API/ImageBitmap|ImageBitmap} if <code>preferImageBitmap</code> is true and the browser supports <code>createImageBitmap</code> or otherwise an\n * {@link https://developer.mozilla.org/en-US/docs/Web/API/HTMLImageElement|Image} once loaded, or reject if the image failed to load.\n *\n * @param {Object} [options] An object with the following properties.\n * @param {Boolean} [options.preferBlob=false] If true, we will load the image via a blob.\n * @param {Boolean} [options.preferImageBitmap=false] If true, image will be decoded during fetch and an <code>ImageBitmap</code> is returned.\n * @param {Boolean} [options.flipY=false] If true, image will be vertically flipped during decode. Only applies if the browser supports <code>createImageBitmap</code>.\n * @returns {Promise.<ImageBitmap>|Promise.<Image>|undefined} a promise that will resolve to the requested data when loaded. Returns undefined if <code>request.throttle</code> is true and the request does not have high enough priority.\n *\n *\n * @example\n * // load a single image asynchronously\n * resource.fetchImage().then(function(image) {\n *     // use the loaded image\n * }).otherwise(function(error) {\n *     // an error occurred\n * });\n *\n * // load several images in parallel\n * when.all([resource1.fetchImage(), resource2.fetchImage()]).then(function(images) {\n *     // images is an array containing all the loaded images\n * });\n *\n * @see {@link http://www.w3.org/TR/cors/|Cross-Origin Resource Sharing}\n * @see {@link http://wiki.commonjs.org/wiki/Promises/A|CommonJS Promises/A}\n */\n\n\nResource.prototype.fetchImage = function (options) {\n  options = defaultValue(options, defaultValue.EMPTY_OBJECT);\n  var preferImageBitmap = defaultValue(options.preferImageBitmap, false);\n  var preferBlob = defaultValue(options.preferBlob, false);\n  var flipY = defaultValue(options.flipY, false);\n  checkAndResetRequest(this.request); // We try to load the image normally if\n  // 1. Blobs aren't supported\n  // 2. It's a data URI\n  // 3. It's a blob URI\n  // 4. It doesn't have request headers and we preferBlob is false\n\n  if (!xhrBlobSupported || this.isDataUri || this.isBlobUri || !this.hasHeaders && !preferBlob) {\n    return fetchImage({\n      resource: this,\n      flipY: flipY,\n      preferImageBitmap: preferImageBitmap\n    });\n  }\n\n  var blobPromise = this.fetchBlob();\n\n  if (!defined(blobPromise)) {\n    return;\n  }\n\n  var supportsImageBitmap;\n  var useImageBitmap;\n  var generatedBlobResource;\n  var generatedBlob;\n  return Resource.supportsImageBitmapOptions().then(function (result) {\n    supportsImageBitmap = result;\n    useImageBitmap = supportsImageBitmap && preferImageBitmap;\n    return blobPromise;\n  }).then(function (blob) {\n    if (!defined(blob)) {\n      return;\n    }\n\n    generatedBlob = blob;\n\n    if (useImageBitmap) {\n      return Resource.createImageBitmapFromBlob(blob, {\n        flipY: flipY,\n        premultiplyAlpha: false\n      });\n    }\n\n    var blobUrl = window.URL.createObjectURL(blob);\n    generatedBlobResource = new Resource({\n      url: blobUrl\n    });\n    return fetchImage({\n      resource: generatedBlobResource,\n      flipY: flipY,\n      preferImageBitmap: false\n    });\n  }).then(function (image) {\n    if (!defined(image)) {\n      return;\n    } // The blob object may be needed for use by a TileDiscardPolicy,\n    // so attach it to the image.\n\n\n    image.blob = generatedBlob;\n\n    if (useImageBitmap) {\n      return image;\n    }\n\n    window.URL.revokeObjectURL(generatedBlobResource.url);\n    return image;\n  }).otherwise(function (error) {\n    if (defined(generatedBlobResource)) {\n      window.URL.revokeObjectURL(generatedBlobResource.url);\n    } // If the blob load succeeded but the image decode failed, attach the blob\n    // to the error object for use by a TileDiscardPolicy.\n    // In particular, BingMapsImageryProvider uses this to detect the\n    // zero-length response that is returned when a tile is not available.\n\n\n    error.blob = generatedBlob;\n    return when.reject(error);\n  });\n};\n/**\n * Fetches an image and returns a promise to it.\n *\n * @param {Object} [options] An object with the following properties.\n * @param {Resource} [options.resource] Resource object that points to an image to fetch.\n * @param {Boolean} [options.preferImageBitmap] If true, image will be decoded during fetch and an <code>ImageBitmap</code> is returned.\n * @param {Boolean} [options.flipY] If true, image will be vertically flipped during decode. Only applies if the browser supports <code>createImageBitmap</code>.\n *\n * @private\n */\n\n\nfunction fetchImage(options) {\n  var resource = options.resource;\n  var flipY = options.flipY;\n  var preferImageBitmap = options.preferImageBitmap;\n  var request = resource.request;\n  request.url = resource.url;\n\n  request.requestFunction = function () {\n    var crossOrigin = false; // data URIs can't have crossorigin set.\n\n    if (!resource.isDataUri && !resource.isBlobUri) {\n      crossOrigin = resource.isCrossOriginUrl;\n    }\n\n    var deferred = when.defer();\n\n    Resource._Implementations.createImage(request, crossOrigin, deferred, flipY, preferImageBitmap);\n\n    return deferred.promise;\n  };\n\n  var promise = RequestScheduler.request(request);\n\n  if (!defined(promise)) {\n    return;\n  }\n\n  return promise.otherwise(function (e) {\n    // Don't retry cancelled or otherwise aborted requests\n    if (request.state !== RequestState.FAILED) {\n      return when.reject(e);\n    }\n\n    return resource.retryOnError(e).then(function (retry) {\n      if (retry) {\n        // Reset request so it can try again\n        request.state = RequestState.UNISSUED;\n        request.deferred = undefined;\n        return fetchImage({\n          resource: resource,\n          flipY: flipY,\n          preferImageBitmap: preferImageBitmap\n        });\n      }\n\n      return when.reject(e);\n    });\n  });\n}\n/**\n * Creates a Resource and calls fetchImage() on it.\n *\n * @param {String|Object} options A url or an object with the following properties\n * @param {String} options.url The url of the resource.\n * @param {Object} [options.queryParameters] An object containing query parameters that will be sent when retrieving the resource.\n * @param {Object} [options.templateValues] Key/Value pairs that are used to replace template values (eg. {x}).\n * @param {Object} [options.headers={}] Additional HTTP headers that will be sent.\n * @param {DefaultProxy} [options.proxy] A proxy to be used when loading the resource.\n * @param {Boolean} [options.flipY=false] Whether to vertically flip the image during fetch and decode. Only applies when requesting an image and the browser supports <code>createImageBitmap</code>.\n * @param {Resource~RetryCallback} [options.retryCallback] The Function to call when a request for this resource fails. If it returns true, the request will be retried.\n * @param {Number} [options.retryAttempts=0] The number of times the retryCallback should be called before giving up.\n * @param {Request} [options.request] A Request object that will be used. Intended for internal use only.\n * @param {Boolean} [options.preferBlob=false]  If true, we will load the image via a blob.\n * @param {Boolean} [options.preferImageBitmap=false] If true, image will be decoded during fetch and an <code>ImageBitmap</code> is returned.\n * @returns {Promise.<ImageBitmap>|Promise.<Image>|undefined} a promise that will resolve to the requested data when loaded. Returns undefined if <code>request.throttle</code> is true and the request does not have high enough priority.\n */\n\n\nResource.fetchImage = function (options) {\n  var resource = new Resource(options);\n  return resource.fetchImage({\n    flipY: options.flipY,\n    preferBlob: options.preferBlob,\n    preferImageBitmap: options.preferImageBitmap\n  });\n};\n/**\n * Asynchronously loads the given resource as text.  Returns a promise that will resolve to\n * a String once loaded, or reject if the resource failed to load.  The data is loaded\n * using XMLHttpRequest, which means that in order to make requests to another origin,\n * the server must have Cross-Origin Resource Sharing (CORS) headers enabled.\n *\n * @returns {Promise.<String>|undefined} a promise that will resolve to the requested data when loaded. Returns undefined if <code>request.throttle</code> is true and the request does not have high enough priority.\n *\n * @example\n * // load text from a URL, setting a custom header\n * var resource = new Resource({\n *   url: 'http://someUrl.com/someJson.txt',\n *   headers: {\n *     'X-Custom-Header' : 'some value'\n *   }\n * });\n * resource.fetchText().then(function(text) {\n *     // Do something with the text\n * }).otherwise(function(error) {\n *     // an error occurred\n * });\n *\n * @see {@link https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest|XMLHttpRequest}\n * @see {@link http://www.w3.org/TR/cors/|Cross-Origin Resource Sharing}\n * @see {@link http://wiki.commonjs.org/wiki/Promises/A|CommonJS Promises/A}\n */\n\n\nResource.prototype.fetchText = function () {\n  return this.fetch({\n    responseType: \"text\"\n  });\n};\n/**\n * Creates a Resource and calls fetchText() on it.\n *\n * @param {String|Object} options A url or an object with the following properties\n * @param {String} options.url The url of the resource.\n * @param {Object} [options.queryParameters] An object containing query parameters that will be sent when retrieving the resource.\n * @param {Object} [options.templateValues] Key/Value pairs that are used to replace template values (eg. {x}).\n * @param {Object} [options.headers={}] Additional HTTP headers that will be sent.\n * @param {DefaultProxy} [options.proxy] A proxy to be used when loading the resource.\n * @param {Resource~RetryCallback} [options.retryCallback] The Function to call when a request for this resource fails. If it returns true, the request will be retried.\n * @param {Number} [options.retryAttempts=0] The number of times the retryCallback should be called before giving up.\n * @param {Request} [options.request] A Request object that will be used. Intended for internal use only.\n * @returns {Promise.<String>|undefined} a promise that will resolve to the requested data when loaded. Returns undefined if <code>request.throttle</code> is true and the request does not have high enough priority.\n */\n\n\nResource.fetchText = function (options) {\n  var resource = new Resource(options);\n  return resource.fetchText();\n}; // note: &#42;&#47;&#42; below is */* but that ends the comment block early\n\n/**\n * Asynchronously loads the given resource as JSON.  Returns a promise that will resolve to\n * a JSON object once loaded, or reject if the resource failed to load.  The data is loaded\n * using XMLHttpRequest, which means that in order to make requests to another origin,\n * the server must have Cross-Origin Resource Sharing (CORS) headers enabled. This function\n * adds 'Accept: application/json,&#42;&#47;&#42;;q=0.01' to the request headers, if not\n * already specified.\n *\n * @returns {Promise.<Object>|undefined} a promise that will resolve to the requested data when loaded. Returns undefined if <code>request.throttle</code> is true and the request does not have high enough priority.\n *\n *\n * @example\n * resource.fetchJson().then(function(jsonData) {\n *     // Do something with the JSON object\n * }).otherwise(function(error) {\n *     // an error occurred\n * });\n *\n * @see {@link http://www.w3.org/TR/cors/|Cross-Origin Resource Sharing}\n * @see {@link http://wiki.commonjs.org/wiki/Promises/A|CommonJS Promises/A}\n */\n\n\nResource.prototype.fetchJson = function () {\n  var promise = this.fetch({\n    responseType: \"text\",\n    headers: {\n      Accept: \"application/json,*/*;q=0.01\"\n    }\n  });\n\n  if (!defined(promise)) {\n    return undefined;\n  }\n\n  return promise.then(function (value) {\n    if (!defined(value)) {\n      return;\n    }\n\n    return JSON.parse(value);\n  });\n};\n/**\n * Creates a Resource and calls fetchJson() on it.\n *\n * @param {String|Object} options A url or an object with the following properties\n * @param {String} options.url The url of the resource.\n * @param {Object} [options.queryParameters] An object containing query parameters that will be sent when retrieving the resource.\n * @param {Object} [options.templateValues] Key/Value pairs that are used to replace template values (eg. {x}).\n * @param {Object} [options.headers={}] Additional HTTP headers that will be sent.\n * @param {DefaultProxy} [options.proxy] A proxy to be used when loading the resource.\n * @param {Resource~RetryCallback} [options.retryCallback] The Function to call when a request for this resource fails. If it returns true, the request will be retried.\n * @param {Number} [options.retryAttempts=0] The number of times the retryCallback should be called before giving up.\n * @param {Request} [options.request] A Request object that will be used. Intended for internal use only.\n * @returns {Promise.<Object>|undefined} a promise that will resolve to the requested data when loaded. Returns undefined if <code>request.throttle</code> is true and the request does not have high enough priority.\n */\n\n\nResource.fetchJson = function (options) {\n  var resource = new Resource(options);\n  return resource.fetchJson();\n};\n/**\n * Asynchronously loads the given resource as XML.  Returns a promise that will resolve to\n * an XML Document once loaded, or reject if the resource failed to load.  The data is loaded\n * using XMLHttpRequest, which means that in order to make requests to another origin,\n * the server must have Cross-Origin Resource Sharing (CORS) headers enabled.\n *\n * @returns {Promise.<XMLDocument>|undefined} a promise that will resolve to the requested data when loaded. Returns undefined if <code>request.throttle</code> is true and the request does not have high enough priority.\n *\n *\n * @example\n * // load XML from a URL, setting a custom header\n * Cesium.loadXML('http://someUrl.com/someXML.xml', {\n *   'X-Custom-Header' : 'some value'\n * }).then(function(document) {\n *     // Do something with the document\n * }).otherwise(function(error) {\n *     // an error occurred\n * });\n *\n * @see {@link https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest|XMLHttpRequest}\n * @see {@link http://www.w3.org/TR/cors/|Cross-Origin Resource Sharing}\n * @see {@link http://wiki.commonjs.org/wiki/Promises/A|CommonJS Promises/A}\n */\n\n\nResource.prototype.fetchXML = function () {\n  return this.fetch({\n    responseType: \"document\",\n    overrideMimeType: \"text/xml\"\n  });\n};\n/**\n * Creates a Resource and calls fetchXML() on it.\n *\n * @param {String|Object} options A url or an object with the following properties\n * @param {String} options.url The url of the resource.\n * @param {Object} [options.queryParameters] An object containing query parameters that will be sent when retrieving the resource.\n * @param {Object} [options.templateValues] Key/Value pairs that are used to replace template values (eg. {x}).\n * @param {Object} [options.headers={}] Additional HTTP headers that will be sent.\n * @param {DefaultProxy} [options.proxy] A proxy to be used when loading the resource.\n * @param {Resource~RetryCallback} [options.retryCallback] The Function to call when a request for this resource fails. If it returns true, the request will be retried.\n * @param {Number} [options.retryAttempts=0] The number of times the retryCallback should be called before giving up.\n * @param {Request} [options.request] A Request object that will be used. Intended for internal use only.\n * @returns {Promise.<XMLDocument>|undefined} a promise that will resolve to the requested data when loaded. Returns undefined if <code>request.throttle</code> is true and the request does not have high enough priority.\n */\n\n\nResource.fetchXML = function (options) {\n  var resource = new Resource(options);\n  return resource.fetchXML();\n};\n/**\n * Requests a resource using JSONP.\n *\n * @param {String} [callbackParameterName='callback'] The callback parameter name that the server expects.\n * @returns {Promise.<Object>|undefined} a promise that will resolve to the requested data when loaded. Returns undefined if <code>request.throttle</code> is true and the request does not have high enough priority.\n *\n *\n * @example\n * // load a data asynchronously\n * resource.fetchJsonp().then(function(data) {\n *     // use the loaded data\n * }).otherwise(function(error) {\n *     // an error occurred\n * });\n *\n * @see {@link http://wiki.commonjs.org/wiki/Promises/A|CommonJS Promises/A}\n */\n\n\nResource.prototype.fetchJsonp = function (callbackParameterName) {\n  callbackParameterName = defaultValue(callbackParameterName, \"callback\");\n  checkAndResetRequest(this.request); //generate a unique function name\n\n  var functionName;\n\n  do {\n    functionName = \"loadJsonp\" + Math.random().toString().substring(2, 8);\n  } while (defined(window[functionName]));\n\n  return fetchJsonp(this, callbackParameterName, functionName);\n};\n\nfunction fetchJsonp(resource, callbackParameterName, functionName) {\n  var callbackQuery = {};\n  callbackQuery[callbackParameterName] = functionName;\n  resource.setQueryParameters(callbackQuery);\n  var request = resource.request;\n  request.url = resource.url;\n\n  request.requestFunction = function () {\n    var deferred = when.defer(); //assign a function with that name in the global scope\n\n    window[functionName] = function (data) {\n      deferred.resolve(data);\n\n      try {\n        delete window[functionName];\n      } catch (e) {\n        window[functionName] = undefined;\n      }\n    };\n\n    Resource._Implementations.loadAndExecuteScript(resource.url, functionName, deferred);\n\n    return deferred.promise;\n  };\n\n  var promise = RequestScheduler.request(request);\n\n  if (!defined(promise)) {\n    return;\n  }\n\n  return promise.otherwise(function (e) {\n    if (request.state !== RequestState.FAILED) {\n      return when.reject(e);\n    }\n\n    return resource.retryOnError(e).then(function (retry) {\n      if (retry) {\n        // Reset request so it can try again\n        request.state = RequestState.UNISSUED;\n        request.deferred = undefined;\n        return fetchJsonp(resource, callbackParameterName, functionName);\n      }\n\n      return when.reject(e);\n    });\n  });\n}\n/**\n * Creates a Resource from a URL and calls fetchJsonp() on it.\n *\n * @param {String|Object} options A url or an object with the following properties\n * @param {String} options.url The url of the resource.\n * @param {Object} [options.queryParameters] An object containing query parameters that will be sent when retrieving the resource.\n * @param {Object} [options.templateValues] Key/Value pairs that are used to replace template values (eg. {x}).\n * @param {Object} [options.headers={}] Additional HTTP headers that will be sent.\n * @param {DefaultProxy} [options.proxy] A proxy to be used when loading the resource.\n * @param {Resource~RetryCallback} [options.retryCallback] The Function to call when a request for this resource fails. If it returns true, the request will be retried.\n * @param {Number} [options.retryAttempts=0] The number of times the retryCallback should be called before giving up.\n * @param {Request} [options.request] A Request object that will be used. Intended for internal use only.\n * @param {String} [options.callbackParameterName='callback'] The callback parameter name that the server expects.\n * @returns {Promise.<Object>|undefined} a promise that will resolve to the requested data when loaded. Returns undefined if <code>request.throttle</code> is true and the request does not have high enough priority.\n */\n\n\nResource.fetchJsonp = function (options) {\n  var resource = new Resource(options);\n  return resource.fetchJsonp(options.callbackParameterName);\n};\n/**\n * @private\n */\n\n\nResource.prototype._makeRequest = function (options) {\n  var resource = this;\n  checkAndResetRequest(resource.request);\n  var request = resource.request;\n  request.url = resource.url;\n\n  request.requestFunction = function () {\n    var responseType = options.responseType;\n    var headers = combine(options.headers, resource.headers);\n    var overrideMimeType = options.overrideMimeType;\n    var method = options.method;\n    var data = options.data;\n    var deferred = when.defer();\n\n    var xhr = Resource._Implementations.loadWithXhr(resource.url, responseType, method, data, headers, deferred, overrideMimeType);\n\n    if (defined(xhr) && defined(xhr.abort)) {\n      request.cancelFunction = function () {\n        xhr.abort();\n      };\n    }\n\n    return deferred.promise;\n  };\n\n  var promise = RequestScheduler.request(request);\n\n  if (!defined(promise)) {\n    return;\n  }\n\n  return promise.then(function (data) {\n    return data;\n  }).otherwise(function (e) {\n    if (request.state !== RequestState.FAILED) {\n      return when.reject(e);\n    }\n\n    return resource.retryOnError(e).then(function (retry) {\n      if (retry) {\n        // Reset request so it can try again\n        request.state = RequestState.UNISSUED;\n        request.deferred = undefined;\n        return resource.fetch(options);\n      }\n\n      return when.reject(e);\n    });\n  });\n};\n\nvar dataUriRegex = /^data:(.*?)(;base64)?,(.*)$/;\n\nfunction decodeDataUriText(isBase64, data) {\n  var result = decodeURIComponent(data);\n\n  if (isBase64) {\n    return atob(result);\n  }\n\n  return result;\n}\n\nfunction decodeDataUriArrayBuffer(isBase64, data) {\n  var byteString = decodeDataUriText(isBase64, data);\n  var buffer = new ArrayBuffer(byteString.length);\n  var view = new Uint8Array(buffer);\n\n  for (var i = 0; i < byteString.length; i++) {\n    view[i] = byteString.charCodeAt(i);\n  }\n\n  return buffer;\n}\n\nfunction decodeDataUri(dataUriRegexResult, responseType) {\n  responseType = defaultValue(responseType, \"\");\n  var mimeType = dataUriRegexResult[1];\n  var isBase64 = !!dataUriRegexResult[2];\n  var data = dataUriRegexResult[3];\n\n  switch (responseType) {\n    case \"\":\n    case \"text\":\n      return decodeDataUriText(isBase64, data);\n\n    case \"arraybuffer\":\n      return decodeDataUriArrayBuffer(isBase64, data);\n\n    case \"blob\":\n      var buffer = decodeDataUriArrayBuffer(isBase64, data);\n      return new Blob([buffer], {\n        type: mimeType\n      });\n\n    case \"document\":\n      var parser = new DOMParser();\n      return parser.parseFromString(decodeDataUriText(isBase64, data), mimeType);\n\n    case \"json\":\n      return JSON.parse(decodeDataUriText(isBase64, data));\n\n    default:\n      //>>includeStart('debug', pragmas.debug);\n      throw new DeveloperError(\"Unhandled responseType: \" + responseType);\n    //>>includeEnd('debug');\n  }\n}\n/**\n * Asynchronously loads the given resource.  Returns a promise that will resolve to\n * the result once loaded, or reject if the resource failed to load.  The data is loaded\n * using XMLHttpRequest, which means that in order to make requests to another origin,\n * the server must have Cross-Origin Resource Sharing (CORS) headers enabled. It's recommended that you use\n * the more specific functions eg. fetchJson, fetchBlob, etc.\n *\n * @param {Object} [options] Object with the following properties:\n * @param {String} [options.responseType] The type of response.  This controls the type of item returned.\n * @param {Object} [options.headers] Additional HTTP headers to send with the request, if any.\n * @param {String} [options.overrideMimeType] Overrides the MIME type returned by the server.\n * @returns {Promise.<Object>|undefined} a promise that will resolve to the requested data when loaded. Returns undefined if <code>request.throttle</code> is true and the request does not have high enough priority.\n *\n *\n * @example\n * resource.fetch()\n *   .then(function(body) {\n *       // use the data\n *   }).otherwise(function(error) {\n *       // an error occurred\n *   });\n *\n * @see {@link http://www.w3.org/TR/cors/|Cross-Origin Resource Sharing}\n * @see {@link http://wiki.commonjs.org/wiki/Promises/A|CommonJS Promises/A}\n */\n\n\nResource.prototype.fetch = function (options) {\n  options = defaultClone(options, {});\n  options.method = \"GET\";\n  return this._makeRequest(options);\n};\n/**\n * Creates a Resource from a URL and calls fetch() on it.\n *\n * @param {String|Object} options A url or an object with the following properties\n * @param {String} options.url The url of the resource.\n * @param {Object} [options.queryParameters] An object containing query parameters that will be sent when retrieving the resource.\n * @param {Object} [options.templateValues] Key/Value pairs that are used to replace template values (eg. {x}).\n * @param {Object} [options.headers={}] Additional HTTP headers that will be sent.\n * @param {DefaultProxy} [options.proxy] A proxy to be used when loading the resource.\n * @param {Resource~RetryCallback} [options.retryCallback] The Function to call when a request for this resource fails. If it returns true, the request will be retried.\n * @param {Number} [options.retryAttempts=0] The number of times the retryCallback should be called before giving up.\n * @param {Request} [options.request] A Request object that will be used. Intended for internal use only.\n * @param {String} [options.responseType] The type of response.  This controls the type of item returned.\n * @param {String} [options.overrideMimeType] Overrides the MIME type returned by the server.\n * @returns {Promise.<Object>|undefined} a promise that will resolve to the requested data when loaded. Returns undefined if <code>request.throttle</code> is true and the request does not have high enough priority.\n */\n\n\nResource.fetch = function (options) {\n  var resource = new Resource(options);\n  return resource.fetch({\n    // Make copy of just the needed fields because headers can be passed to both the constructor and to fetch\n    responseType: options.responseType,\n    overrideMimeType: options.overrideMimeType\n  });\n};\n/**\n * Asynchronously deletes the given resource.  Returns a promise that will resolve to\n * the result once loaded, or reject if the resource failed to load.  The data is loaded\n * using XMLHttpRequest, which means that in order to make requests to another origin,\n * the server must have Cross-Origin Resource Sharing (CORS) headers enabled.\n *\n * @param {Object} [options] Object with the following properties:\n * @param {String} [options.responseType] The type of response.  This controls the type of item returned.\n * @param {Object} [options.headers] Additional HTTP headers to send with the request, if any.\n * @param {String} [options.overrideMimeType] Overrides the MIME type returned by the server.\n * @returns {Promise.<Object>|undefined} a promise that will resolve to the requested data when loaded. Returns undefined if <code>request.throttle</code> is true and the request does not have high enough priority.\n *\n *\n * @example\n * resource.delete()\n *   .then(function(body) {\n *       // use the data\n *   }).otherwise(function(error) {\n *       // an error occurred\n *   });\n *\n * @see {@link http://www.w3.org/TR/cors/|Cross-Origin Resource Sharing}\n * @see {@link http://wiki.commonjs.org/wiki/Promises/A|CommonJS Promises/A}\n */\n\n\nResource.prototype.delete = function (options) {\n  options = defaultClone(options, {});\n  options.method = \"DELETE\";\n  return this._makeRequest(options);\n};\n/**\n * Creates a Resource from a URL and calls delete() on it.\n *\n * @param {String|Object} options A url or an object with the following properties\n * @param {String} options.url The url of the resource.\n * @param {Object} [options.data] Data that is posted with the resource.\n * @param {Object} [options.queryParameters] An object containing query parameters that will be sent when retrieving the resource.\n * @param {Object} [options.templateValues] Key/Value pairs that are used to replace template values (eg. {x}).\n * @param {Object} [options.headers={}] Additional HTTP headers that will be sent.\n * @param {DefaultProxy} [options.proxy] A proxy to be used when loading the resource.\n * @param {Resource~RetryCallback} [options.retryCallback] The Function to call when a request for this resource fails. If it returns true, the request will be retried.\n * @param {Number} [options.retryAttempts=0] The number of times the retryCallback should be called before giving up.\n * @param {Request} [options.request] A Request object that will be used. Intended for internal use only.\n * @param {String} [options.responseType] The type of response.  This controls the type of item returned.\n * @param {String} [options.overrideMimeType] Overrides the MIME type returned by the server.\n * @returns {Promise.<Object>|undefined} a promise that will resolve to the requested data when loaded. Returns undefined if <code>request.throttle</code> is true and the request does not have high enough priority.\n */\n\n\nResource.delete = function (options) {\n  var resource = new Resource(options);\n  return resource.delete({\n    // Make copy of just the needed fields because headers can be passed to both the constructor and to fetch\n    responseType: options.responseType,\n    overrideMimeType: options.overrideMimeType,\n    data: options.data\n  });\n};\n/**\n * Asynchronously gets headers the given resource.  Returns a promise that will resolve to\n * the result once loaded, or reject if the resource failed to load.  The data is loaded\n * using XMLHttpRequest, which means that in order to make requests to another origin,\n * the server must have Cross-Origin Resource Sharing (CORS) headers enabled.\n *\n * @param {Object} [options] Object with the following properties:\n * @param {String} [options.responseType] The type of response.  This controls the type of item returned.\n * @param {Object} [options.headers] Additional HTTP headers to send with the request, if any.\n * @param {String} [options.overrideMimeType] Overrides the MIME type returned by the server.\n * @returns {Promise.<Object>|undefined} a promise that will resolve to the requested data when loaded. Returns undefined if <code>request.throttle</code> is true and the request does not have high enough priority.\n *\n *\n * @example\n * resource.head()\n *   .then(function(headers) {\n *       // use the data\n *   }).otherwise(function(error) {\n *       // an error occurred\n *   });\n *\n * @see {@link http://www.w3.org/TR/cors/|Cross-Origin Resource Sharing}\n * @see {@link http://wiki.commonjs.org/wiki/Promises/A|CommonJS Promises/A}\n */\n\n\nResource.prototype.head = function (options) {\n  options = defaultClone(options, {});\n  options.method = \"HEAD\";\n  return this._makeRequest(options);\n};\n/**\n * Creates a Resource from a URL and calls head() on it.\n *\n * @param {String|Object} options A url or an object with the following properties\n * @param {String} options.url The url of the resource.\n * @param {Object} [options.queryParameters] An object containing query parameters that will be sent when retrieving the resource.\n * @param {Object} [options.templateValues] Key/Value pairs that are used to replace template values (eg. {x}).\n * @param {Object} [options.headers={}] Additional HTTP headers that will be sent.\n * @param {DefaultProxy} [options.proxy] A proxy to be used when loading the resource.\n * @param {Resource~RetryCallback} [options.retryCallback] The Function to call when a request for this resource fails. If it returns true, the request will be retried.\n * @param {Number} [options.retryAttempts=0] The number of times the retryCallback should be called before giving up.\n * @param {Request} [options.request] A Request object that will be used. Intended for internal use only.\n * @param {String} [options.responseType] The type of response.  This controls the type of item returned.\n * @param {String} [options.overrideMimeType] Overrides the MIME type returned by the server.\n * @returns {Promise.<Object>|undefined} a promise that will resolve to the requested data when loaded. Returns undefined if <code>request.throttle</code> is true and the request does not have high enough priority.\n */\n\n\nResource.head = function (options) {\n  var resource = new Resource(options);\n  return resource.head({\n    // Make copy of just the needed fields because headers can be passed to both the constructor and to fetch\n    responseType: options.responseType,\n    overrideMimeType: options.overrideMimeType\n  });\n};\n/**\n * Asynchronously gets options the given resource.  Returns a promise that will resolve to\n * the result once loaded, or reject if the resource failed to load.  The data is loaded\n * using XMLHttpRequest, which means that in order to make requests to another origin,\n * the server must have Cross-Origin Resource Sharing (CORS) headers enabled.\n *\n * @param {Object} [options] Object with the following properties:\n * @param {String} [options.responseType] The type of response.  This controls the type of item returned.\n * @param {Object} [options.headers] Additional HTTP headers to send with the request, if any.\n * @param {String} [options.overrideMimeType] Overrides the MIME type returned by the server.\n * @returns {Promise.<Object>|undefined} a promise that will resolve to the requested data when loaded. Returns undefined if <code>request.throttle</code> is true and the request does not have high enough priority.\n *\n *\n * @example\n * resource.options()\n *   .then(function(headers) {\n *       // use the data\n *   }).otherwise(function(error) {\n *       // an error occurred\n *   });\n *\n * @see {@link http://www.w3.org/TR/cors/|Cross-Origin Resource Sharing}\n * @see {@link http://wiki.commonjs.org/wiki/Promises/A|CommonJS Promises/A}\n */\n\n\nResource.prototype.options = function (options) {\n  options = defaultClone(options, {});\n  options.method = \"OPTIONS\";\n  return this._makeRequest(options);\n};\n/**\n * Creates a Resource from a URL and calls options() on it.\n *\n * @param {String|Object} options A url or an object with the following properties\n * @param {String} options.url The url of the resource.\n * @param {Object} [options.queryParameters] An object containing query parameters that will be sent when retrieving the resource.\n * @param {Object} [options.templateValues] Key/Value pairs that are used to replace template values (eg. {x}).\n * @param {Object} [options.headers={}] Additional HTTP headers that will be sent.\n * @param {DefaultProxy} [options.proxy] A proxy to be used when loading the resource.\n * @param {Resource~RetryCallback} [options.retryCallback] The Function to call when a request for this resource fails. If it returns true, the request will be retried.\n * @param {Number} [options.retryAttempts=0] The number of times the retryCallback should be called before giving up.\n * @param {Request} [options.request] A Request object that will be used. Intended for internal use only.\n * @param {String} [options.responseType] The type of response.  This controls the type of item returned.\n * @param {String} [options.overrideMimeType] Overrides the MIME type returned by the server.\n * @returns {Promise.<Object>|undefined} a promise that will resolve to the requested data when loaded. Returns undefined if <code>request.throttle</code> is true and the request does not have high enough priority.\n */\n\n\nResource.options = function (options) {\n  var resource = new Resource(options);\n  return resource.options({\n    // Make copy of just the needed fields because headers can be passed to both the constructor and to fetch\n    responseType: options.responseType,\n    overrideMimeType: options.overrideMimeType\n  });\n};\n/**\n * Asynchronously posts data to the given resource.  Returns a promise that will resolve to\n * the result once loaded, or reject if the resource failed to load.  The data is loaded\n * using XMLHttpRequest, which means that in order to make requests to another origin,\n * the server must have Cross-Origin Resource Sharing (CORS) headers enabled.\n *\n * @param {Object} data Data that is posted with the resource.\n * @param {Object} [options] Object with the following properties:\n * @param {Object} [options.data] Data that is posted with the resource.\n * @param {String} [options.responseType] The type of response.  This controls the type of item returned.\n * @param {Object} [options.headers] Additional HTTP headers to send with the request, if any.\n * @param {String} [options.overrideMimeType] Overrides the MIME type returned by the server.\n * @returns {Promise.<Object>|undefined} a promise that will resolve to the requested data when loaded. Returns undefined if <code>request.throttle</code> is true and the request does not have high enough priority.\n *\n *\n * @example\n * resource.post(data)\n *   .then(function(result) {\n *       // use the result\n *   }).otherwise(function(error) {\n *       // an error occurred\n *   });\n *\n * @see {@link http://www.w3.org/TR/cors/|Cross-Origin Resource Sharing}\n * @see {@link http://wiki.commonjs.org/wiki/Promises/A|CommonJS Promises/A}\n */\n\n\nResource.prototype.post = function (data, options) {\n  Check.defined(\"data\", data);\n  options = defaultClone(options, {});\n  options.method = \"POST\";\n  options.data = data;\n  return this._makeRequest(options);\n};\n/**\n * Creates a Resource from a URL and calls post() on it.\n *\n * @param {Object} options A url or an object with the following properties\n * @param {String} options.url The url of the resource.\n * @param {Object} options.data Data that is posted with the resource.\n * @param {Object} [options.queryParameters] An object containing query parameters that will be sent when retrieving the resource.\n * @param {Object} [options.templateValues] Key/Value pairs that are used to replace template values (eg. {x}).\n * @param {Object} [options.headers={}] Additional HTTP headers that will be sent.\n * @param {DefaultProxy} [options.proxy] A proxy to be used when loading the resource.\n * @param {Resource~RetryCallback} [options.retryCallback] The Function to call when a request for this resource fails. If it returns true, the request will be retried.\n * @param {Number} [options.retryAttempts=0] The number of times the retryCallback should be called before giving up.\n * @param {Request} [options.request] A Request object that will be used. Intended for internal use only.\n * @param {String} [options.responseType] The type of response.  This controls the type of item returned.\n * @param {String} [options.overrideMimeType] Overrides the MIME type returned by the server.\n * @returns {Promise.<Object>|undefined} a promise that will resolve to the requested data when loaded. Returns undefined if <code>request.throttle</code> is true and the request does not have high enough priority.\n */\n\n\nResource.post = function (options) {\n  var resource = new Resource(options);\n  return resource.post(options.data, {\n    // Make copy of just the needed fields because headers can be passed to both the constructor and to post\n    responseType: options.responseType,\n    overrideMimeType: options.overrideMimeType\n  });\n};\n/**\n * Asynchronously puts data to the given resource.  Returns a promise that will resolve to\n * the result once loaded, or reject if the resource failed to load.  The data is loaded\n * using XMLHttpRequest, which means that in order to make requests to another origin,\n * the server must have Cross-Origin Resource Sharing (CORS) headers enabled.\n *\n * @param {Object} data Data that is posted with the resource.\n * @param {Object} [options] Object with the following properties:\n * @param {String} [options.responseType] The type of response.  This controls the type of item returned.\n * @param {Object} [options.headers] Additional HTTP headers to send with the request, if any.\n * @param {String} [options.overrideMimeType] Overrides the MIME type returned by the server.\n * @returns {Promise.<Object>|undefined} a promise that will resolve to the requested data when loaded. Returns undefined if <code>request.throttle</code> is true and the request does not have high enough priority.\n *\n *\n * @example\n * resource.put(data)\n *   .then(function(result) {\n *       // use the result\n *   }).otherwise(function(error) {\n *       // an error occurred\n *   });\n *\n * @see {@link http://www.w3.org/TR/cors/|Cross-Origin Resource Sharing}\n * @see {@link http://wiki.commonjs.org/wiki/Promises/A|CommonJS Promises/A}\n */\n\n\nResource.prototype.put = function (data, options) {\n  Check.defined(\"data\", data);\n  options = defaultClone(options, {});\n  options.method = \"PUT\";\n  options.data = data;\n  return this._makeRequest(options);\n};\n/**\n * Creates a Resource from a URL and calls put() on it.\n *\n * @param {Object} options A url or an object with the following properties\n * @param {String} options.url The url of the resource.\n * @param {Object} options.data Data that is posted with the resource.\n * @param {Object} [options.queryParameters] An object containing query parameters that will be sent when retrieving the resource.\n * @param {Object} [options.templateValues] Key/Value pairs that are used to replace template values (eg. {x}).\n * @param {Object} [options.headers={}] Additional HTTP headers that will be sent.\n * @param {DefaultProxy} [options.proxy] A proxy to be used when loading the resource.\n * @param {Resource~RetryCallback} [options.retryCallback] The Function to call when a request for this resource fails. If it returns true, the request will be retried.\n * @param {Number} [options.retryAttempts=0] The number of times the retryCallback should be called before giving up.\n * @param {Request} [options.request] A Request object that will be used. Intended for internal use only.\n * @param {String} [options.responseType] The type of response.  This controls the type of item returned.\n * @param {String} [options.overrideMimeType] Overrides the MIME type returned by the server.\n * @returns {Promise.<Object>|undefined} a promise that will resolve to the requested data when loaded. Returns undefined if <code>request.throttle</code> is true and the request does not have high enough priority.\n */\n\n\nResource.put = function (options) {\n  var resource = new Resource(options);\n  return resource.put(options.data, {\n    // Make copy of just the needed fields because headers can be passed to both the constructor and to post\n    responseType: options.responseType,\n    overrideMimeType: options.overrideMimeType\n  });\n};\n/**\n * Asynchronously patches data to the given resource.  Returns a promise that will resolve to\n * the result once loaded, or reject if the resource failed to load.  The data is loaded\n * using XMLHttpRequest, which means that in order to make requests to another origin,\n * the server must have Cross-Origin Resource Sharing (CORS) headers enabled.\n *\n * @param {Object} data Data that is posted with the resource.\n * @param {Object} [options] Object with the following properties:\n * @param {String} [options.responseType] The type of response.  This controls the type of item returned.\n * @param {Object} [options.headers] Additional HTTP headers to send with the request, if any.\n * @param {String} [options.overrideMimeType] Overrides the MIME type returned by the server.\n * @returns {Promise.<Object>|undefined} a promise that will resolve to the requested data when loaded. Returns undefined if <code>request.throttle</code> is true and the request does not have high enough priority.\n *\n *\n * @example\n * resource.patch(data)\n *   .then(function(result) {\n *       // use the result\n *   }).otherwise(function(error) {\n *       // an error occurred\n *   });\n *\n * @see {@link http://www.w3.org/TR/cors/|Cross-Origin Resource Sharing}\n * @see {@link http://wiki.commonjs.org/wiki/Promises/A|CommonJS Promises/A}\n */\n\n\nResource.prototype.patch = function (data, options) {\n  Check.defined(\"data\", data);\n  options = defaultClone(options, {});\n  options.method = \"PATCH\";\n  options.data = data;\n  return this._makeRequest(options);\n};\n/**\n * Creates a Resource from a URL and calls patch() on it.\n *\n * @param {Object} options A url or an object with the following properties\n * @param {String} options.url The url of the resource.\n * @param {Object} options.data Data that is posted with the resource.\n * @param {Object} [options.queryParameters] An object containing query parameters that will be sent when retrieving the resource.\n * @param {Object} [options.templateValues] Key/Value pairs that are used to replace template values (eg. {x}).\n * @param {Object} [options.headers={}] Additional HTTP headers that will be sent.\n * @param {DefaultProxy} [options.proxy] A proxy to be used when loading the resource.\n * @param {Resource~RetryCallback} [options.retryCallback] The Function to call when a request for this resource fails. If it returns true, the request will be retried.\n * @param {Number} [options.retryAttempts=0] The number of times the retryCallback should be called before giving up.\n * @param {Request} [options.request] A Request object that will be used. Intended for internal use only.\n * @param {String} [options.responseType] The type of response.  This controls the type of item returned.\n * @param {String} [options.overrideMimeType] Overrides the MIME type returned by the server.\n * @returns {Promise.<Object>|undefined} a promise that will resolve to the requested data when loaded. Returns undefined if <code>request.throttle</code> is true and the request does not have high enough priority.\n */\n\n\nResource.patch = function (options) {\n  var resource = new Resource(options);\n  return resource.patch(options.data, {\n    // Make copy of just the needed fields because headers can be passed to both the constructor and to post\n    responseType: options.responseType,\n    overrideMimeType: options.overrideMimeType\n  });\n};\n/**\n * Contains implementations of functions that can be replaced for testing\n *\n * @private\n */\n\n\nResource._Implementations = {};\n\nfunction loadImageElement(url, crossOrigin, deferred) {\n  var image = new Image();\n\n  image.onload = function () {\n    deferred.resolve(image);\n  };\n\n  image.onerror = function (e) {\n    deferred.reject(e);\n  };\n\n  if (crossOrigin) {\n    if (TrustedServers.contains(url)) {\n      image.crossOrigin = \"use-credentials\";\n    } else {\n      image.crossOrigin = \"\";\n    }\n  }\n\n  image.src = url;\n}\n\nResource._Implementations.createImage = function (request, crossOrigin, deferred, flipY, preferImageBitmap) {\n  var url = request.url; // Passing an Image to createImageBitmap will force it to run on the main thread\n  // since DOM elements don't exist on workers. We convert it to a blob so it's non-blocking.\n  // See:\n  //    https://bugzilla.mozilla.org/show_bug.cgi?id=1044102#c38\n  //    https://bugs.chromium.org/p/chromium/issues/detail?id=580202#c10\n\n  Resource.supportsImageBitmapOptions().then(function (supportsImageBitmap) {\n    // We can only use ImageBitmap if we can flip on decode.\n    // See: https://github.com/CesiumGS/cesium/pull/7579#issuecomment-466146898\n    if (!(supportsImageBitmap && preferImageBitmap)) {\n      loadImageElement(url, crossOrigin, deferred);\n      return;\n    }\n\n    var responseType = \"blob\";\n    var method = \"GET\";\n    var xhrDeferred = when.defer();\n\n    var xhr = Resource._Implementations.loadWithXhr(url, responseType, method, undefined, undefined, xhrDeferred, undefined, undefined, undefined);\n\n    if (defined(xhr) && defined(xhr.abort)) {\n      request.cancelFunction = function () {\n        xhr.abort();\n      };\n    }\n\n    return xhrDeferred.promise.then(function (blob) {\n      if (!defined(blob)) {\n        deferred.reject(new RuntimeError(\"Successfully retrieved \" + url + \" but it contained no content.\"));\n        return;\n      }\n\n      return Resource.createImageBitmapFromBlob(blob, {\n        flipY: flipY,\n        premultiplyAlpha: false\n      });\n    }).then(deferred.resolve);\n  }).otherwise(deferred.reject);\n};\n/**\n * Wrapper for createImageBitmap\n *\n * @private\n */\n\n\nResource.createImageBitmapFromBlob = function (blob, options) {\n  Check.defined(\"options\", options);\n  Check.typeOf.bool(\"options.flipY\", options.flipY);\n  Check.typeOf.bool(\"options.premultiplyAlpha\", options.premultiplyAlpha);\n  return createImageBitmap(blob, {\n    imageOrientation: options.flipY ? \"flipY\" : \"none\",\n    premultiplyAlpha: options.premultiplyAlpha ? \"premultiply\" : \"none\"\n  });\n};\n\nfunction decodeResponse(loadWithHttpResponse, responseType) {\n  switch (responseType) {\n    case \"text\":\n      return loadWithHttpResponse.toString(\"utf8\");\n\n    case \"json\":\n      return JSON.parse(loadWithHttpResponse.toString(\"utf8\"));\n\n    default:\n      return new Uint8Array(loadWithHttpResponse).buffer;\n  }\n}\n\nfunction loadWithHttpRequest(url, responseType, method, data, headers, deferred, overrideMimeType) {\n  // Note: only the 'json' and 'text' responseTypes transforms the loaded buffer\n\n  /* eslint-disable no-undef */\n  var URL = require(\"url\").parse(url);\n\n  var http = URL.protocol === \"https:\" ? require(\"https\") : require(\"http\");\n\n  var zlib = require(\"zlib\");\n  /* eslint-enable no-undef */\n\n\n  var options = {\n    protocol: URL.protocol,\n    hostname: URL.hostname,\n    port: URL.port,\n    path: URL.path,\n    query: URL.query,\n    method: method,\n    headers: headers\n  };\n  http.request(options).on(\"response\", function (res) {\n    if (res.statusCode < 200 || res.statusCode >= 300) {\n      deferred.reject(new RequestErrorEvent(res.statusCode, res, res.headers));\n      return;\n    }\n\n    var chunkArray = [];\n    res.on(\"data\", function (chunk) {\n      chunkArray.push(chunk);\n    });\n    res.on(\"end\", function () {\n      // eslint-disable-next-line no-undef\n      var result = Buffer.concat(chunkArray);\n\n      if (res.headers[\"content-encoding\"] === \"gzip\") {\n        zlib.gunzip(result, function (error, resultUnzipped) {\n          if (error) {\n            deferred.reject(new RuntimeError(\"Error decompressing response.\"));\n          } else {\n            deferred.resolve(decodeResponse(resultUnzipped, responseType));\n          }\n        });\n      } else {\n        deferred.resolve(decodeResponse(result, responseType));\n      }\n    });\n  }).on(\"error\", function (e) {\n    deferred.reject(new RequestErrorEvent());\n  }).end();\n}\n\nvar noXMLHttpRequest = typeof XMLHttpRequest === \"undefined\";\n\nResource._Implementations.loadWithXhr = function (url, responseType, method, data, headers, deferred, overrideMimeType) {\n  var dataUriRegexResult = dataUriRegex.exec(url);\n\n  if (dataUriRegexResult !== null) {\n    deferred.resolve(decodeDataUri(dataUriRegexResult, responseType));\n    return;\n  }\n\n  if (noXMLHttpRequest) {\n    loadWithHttpRequest(url, responseType, method, data, headers, deferred, overrideMimeType);\n    return;\n  }\n\n  var xhr = new XMLHttpRequest();\n\n  if (TrustedServers.contains(url)) {\n    xhr.withCredentials = true;\n  }\n\n  xhr.open(method, url, true);\n\n  if (defined(overrideMimeType) && defined(xhr.overrideMimeType)) {\n    xhr.overrideMimeType(overrideMimeType);\n  }\n\n  if (defined(headers)) {\n    for (var key in headers) {\n      if (headers.hasOwnProperty(key)) {\n        xhr.setRequestHeader(key, headers[key]);\n      }\n    }\n  }\n\n  if (defined(responseType)) {\n    xhr.responseType = responseType;\n  } // While non-standard, file protocol always returns a status of 0 on success\n\n\n  var localFile = false;\n\n  if (typeof url === \"string\") {\n    localFile = url.indexOf(\"file://\") === 0 || typeof window !== \"undefined\" && window.location.origin === \"file://\";\n  }\n\n  xhr.onload = function () {\n    if ((xhr.status < 200 || xhr.status >= 300) && !(localFile && xhr.status === 0)) {\n      deferred.reject(new RequestErrorEvent(xhr.status, xhr.response, xhr.getAllResponseHeaders()));\n      return;\n    }\n\n    var response = xhr.response;\n    var browserResponseType = xhr.responseType;\n\n    if (method === \"HEAD\" || method === \"OPTIONS\") {\n      var responseHeaderString = xhr.getAllResponseHeaders();\n      var splitHeaders = responseHeaderString.trim().split(/[\\r\\n]+/);\n      var responseHeaders = {};\n      splitHeaders.forEach(function (line) {\n        var parts = line.split(\": \");\n        var header = parts.shift();\n        responseHeaders[header] = parts.join(\": \");\n      });\n      deferred.resolve(responseHeaders);\n      return;\n    } //All modern browsers will go into either the first or second if block or last else block.\n    //Other code paths support older browsers that either do not support the supplied responseType\n    //or do not support the xhr.response property.\n\n\n    if (xhr.status === 204) {\n      // accept no content\n      deferred.resolve();\n    } else if (defined(response) && (!defined(responseType) || browserResponseType === responseType)) {\n      deferred.resolve(response);\n    } else if (responseType === \"json\" && typeof response === \"string\") {\n      try {\n        deferred.resolve(JSON.parse(response));\n      } catch (e) {\n        deferred.reject(e);\n      }\n    } else if ((browserResponseType === \"\" || browserResponseType === \"document\") && defined(xhr.responseXML) && xhr.responseXML.hasChildNodes()) {\n      deferred.resolve(xhr.responseXML);\n    } else if ((browserResponseType === \"\" || browserResponseType === \"text\") && defined(xhr.responseText)) {\n      deferred.resolve(xhr.responseText);\n    } else {\n      deferred.reject(new RuntimeError(\"Invalid XMLHttpRequest response type.\"));\n    }\n  };\n\n  xhr.onerror = function (e) {\n    deferred.reject(new RequestErrorEvent());\n  };\n\n  xhr.send(data);\n  return xhr;\n};\n\nResource._Implementations.loadAndExecuteScript = function (url, functionName, deferred) {\n  return loadAndExecuteScript(url, functionName).otherwise(deferred.reject);\n};\n/**\n * The default implementations\n *\n * @private\n */\n\n\nResource._DefaultImplementations = {};\nResource._DefaultImplementations.createImage = Resource._Implementations.createImage;\nResource._DefaultImplementations.loadWithXhr = Resource._Implementations.loadWithXhr;\nResource._DefaultImplementations.loadAndExecuteScript = Resource._Implementations.loadAndExecuteScript;\n/**\n * A resource instance initialized to the current browser location\n *\n * @type {Resource}\n * @constant\n */\n\nResource.DEFAULT = Object.freeze(new Resource({\n  url: typeof document === \"undefined\" ? \"\" : document.location.href.split(\"?\")[0]\n}));\n/**\n * A function that returns the value of the property.\n * @callback Resource~RetryCallback\n *\n * @param {Resource} [resource] The resource that failed to load.\n * @param {Error} [error] The error that occurred during the loading of the resource.\n * @returns {Boolean|Promise<Boolean>} If true or a promise that resolved to true, the resource will be retried. Otherwise the failure will be returned.\n */\n\nexport default Resource;","map":{"version":3,"sources":["C:/Users/passa/Desktop/WaterLevelReact/node_modules/cesium/Source/Core/Resource.js"],"names":["Uri","when","appendForwardSlash","Check","clone","combine","defaultValue","defined","DeveloperError","getAbsoluteUri","getBaseUri","getExtensionFromUri","isBlobUri","isCrossOriginUrl","isDataUri","loadAndExecuteScript","objectToQuery","queryToObject","Request","RequestErrorEvent","RequestScheduler","RequestState","RuntimeError","TrustedServers","xhrBlobSupported","xhr","XMLHttpRequest","open","responseType","e","parseQuery","uri","resource","merge","preserveQueryParameters","queryString","query","length","indexOf","result","undefined","_queryParameters","combineQueryParameters","stringifyQuery","queryObject","keys","Object","defaultClone","val","defaultVal","checkAndResetRequest","request","state","ISSUED","ACTIVE","UNISSUED","deferred","q1","q2","param","hasOwnProperty","value","q2Value","Array","isArray","concat","slice","Resource","options","EMPTY_OBJECT","url","typeOf","string","_url","_templateValues","templateValues","queryParameters","headers","proxy","retryCallback","retryAttempts","_retryCount","fragment","toString","createIfNeeded","getDerivedResource","supportsImageBitmapOptionsPromise","supportsImageBitmapOptions","createImageBitmap","resolve","imageDataUri","fetchBlob","then","blob","imageOrientation","premultiplyAlpha","imageBitmap","otherwise","defineProperties","isBlobSupported","get","prototype","getUrlComponent","set","extension","hasHeaders","replace","match","key","replacement","encodeURIComponent","getURL","setQueryParameters","params","useAsDefault","appendQueryParameters","setTemplateValues","template","retryOnError","error","that","includeQuery","fetchArrayBuffer","fetch","fetchImage","preferImageBitmap","preferBlob","flipY","blobPromise","supportsImageBitmap","useImageBitmap","generatedBlobResource","generatedBlob","createImageBitmapFromBlob","blobUrl","window","URL","createObjectURL","image","revokeObjectURL","reject","requestFunction","crossOrigin","defer","_Implementations","createImage","promise","FAILED","retry","fetchText","fetchJson","Accept","JSON","parse","fetchXML","overrideMimeType","fetchJsonp","callbackParameterName","functionName","Math","random","substring","callbackQuery","data","_makeRequest","method","loadWithXhr","abort","cancelFunction","dataUriRegex","decodeDataUriText","isBase64","decodeURIComponent","atob","decodeDataUriArrayBuffer","byteString","buffer","ArrayBuffer","view","Uint8Array","i","charCodeAt","decodeDataUri","dataUriRegexResult","mimeType","Blob","type","parser","DOMParser","parseFromString","delete","head","post","put","patch","loadImageElement","Image","onload","onerror","contains","src","xhrDeferred","bool","decodeResponse","loadWithHttpResponse","loadWithHttpRequest","require","http","protocol","zlib","hostname","port","path","on","res","statusCode","chunkArray","chunk","push","Buffer","gunzip","resultUnzipped","end","noXMLHttpRequest","exec","withCredentials","setRequestHeader","localFile","location","origin","status","response","getAllResponseHeaders","browserResponseType","responseHeaderString","splitHeaders","trim","split","responseHeaders","forEach","line","parts","header","shift","join","responseXML","hasChildNodes","responseText","send","_DefaultImplementations","DEFAULT","freeze","document","href"],"mappings":"AAAA,OAAOA,GAAP,MAAgB,sBAAhB;AACA,OAAOC,IAAP,MAAiB,uBAAjB;AACA,OAAOC,kBAAP,MAA+B,yBAA/B;AACA,OAAOC,KAAP,MAAkB,YAAlB;AACA,OAAOC,KAAP,MAAkB,YAAlB;AACA,OAAOC,OAAP,MAAoB,cAApB;AACA,OAAOC,YAAP,MAAyB,mBAAzB;AACA,OAAOC,OAAP,MAAoB,cAApB;AACA,OAAOC,cAAP,MAA2B,qBAA3B;AACA,OAAOC,cAAP,MAA2B,qBAA3B;AACA,OAAOC,UAAP,MAAuB,iBAAvB;AACA,OAAOC,mBAAP,MAAgC,0BAAhC;AACA,OAAOC,SAAP,MAAsB,gBAAtB;AACA,OAAOC,gBAAP,MAA6B,uBAA7B;AACA,OAAOC,SAAP,MAAsB,gBAAtB;AACA,OAAOC,oBAAP,MAAiC,2BAAjC;AACA,OAAOC,aAAP,MAA0B,oBAA1B;AACA,OAAOC,aAAP,MAA0B,oBAA1B;AACA,OAAOC,OAAP,MAAoB,cAApB;AACA,OAAOC,iBAAP,MAA8B,wBAA9B;AACA,OAAOC,gBAAP,MAA6B,uBAA7B;AACA,OAAOC,YAAP,MAAyB,mBAAzB;AACA,OAAOC,YAAP,MAAyB,mBAAzB;AACA,OAAOC,cAAP,MAA2B,qBAA3B;;AAEA,IAAIC,gBAAgB,GAAI,YAAY;AAClC,MAAI;AACF,QAAIC,GAAG,GAAG,IAAIC,cAAJ,EAAV;AACAD,IAAAA,GAAG,CAACE,IAAJ,CAAS,KAAT,EAAgB,GAAhB,EAAqB,IAArB;AACAF,IAAAA,GAAG,CAACG,YAAJ,GAAmB,MAAnB;AACA,WAAOH,GAAG,CAACG,YAAJ,KAAqB,MAA5B;AACD,GALD,CAKE,OAAOC,CAAP,EAAU;AACV,WAAO,KAAP;AACD;AACF,CATsB,EAAvB;AAWA;;;;;;;;;;;;AAUA,SAASC,UAAT,CAAoBC,GAApB,EAAyBC,QAAzB,EAAmCC,KAAnC,EAA0CC,uBAA1C,EAAmE;AACjE,MAAIC,WAAW,GAAGJ,GAAG,CAACK,KAAtB;;AACA,MAAI,CAAC7B,OAAO,CAAC4B,WAAD,CAAR,IAAyBA,WAAW,CAACE,MAAZ,KAAuB,CAApD,EAAuD;AACrD,WAAO,EAAP;AACD;;AAED,MAAID,KAAJ,CANiE,CAOjE;;AACA,MAAID,WAAW,CAACG,OAAZ,CAAoB,GAApB,MAA6B,CAAC,CAAlC,EAAqC;AACnC,QAAIC,MAAM,GAAG,EAAb;AACAA,IAAAA,MAAM,CAACJ,WAAD,CAAN,GAAsBK,SAAtB;AACAJ,IAAAA,KAAK,GAAGG,MAAR;AACD,GAJD,MAIO;AACLH,IAAAA,KAAK,GAAGnB,aAAa,CAACkB,WAAD,CAArB;AACD;;AAED,MAAIF,KAAJ,EAAW;AACTD,IAAAA,QAAQ,CAACS,gBAAT,GAA4BC,sBAAsB,CAChDN,KADgD,EAEhDJ,QAAQ,CAACS,gBAFuC,EAGhDP,uBAHgD,CAAlD;AAKD,GAND,MAMO;AACLF,IAAAA,QAAQ,CAACS,gBAAT,GAA4BL,KAA5B;AACD;;AACDL,EAAAA,GAAG,CAACK,KAAJ,GAAYI,SAAZ;AACD;AAED;;;;;;;;;;AAQA,SAASG,cAAT,CAAwBZ,GAAxB,EAA6BC,QAA7B,EAAuC;AACrC,MAAIY,WAAW,GAAGZ,QAAQ,CAACS,gBAA3B;AAEA,MAAII,IAAI,GAAGC,MAAM,CAACD,IAAP,CAAYD,WAAZ,CAAX,CAHqC,CAKrC;;AACA,MAAIC,IAAI,CAACR,MAAL,KAAgB,CAAhB,IAAqB,CAAC9B,OAAO,CAACqC,WAAW,CAACC,IAAI,CAAC,CAAD,CAAL,CAAZ,CAAjC,EAAyD;AACvDd,IAAAA,GAAG,CAACK,KAAJ,GAAYS,IAAI,CAAC,CAAD,CAAhB;AACD,GAFD,MAEO;AACLd,IAAAA,GAAG,CAACK,KAAJ,GAAYpB,aAAa,CAAC4B,WAAD,CAAzB;AACD;AACF;AAED;;;;;;;;;;;;AAUA,SAASG,YAAT,CAAsBC,GAAtB,EAA2BC,UAA3B,EAAuC;AACrC,MAAI,CAAC1C,OAAO,CAACyC,GAAD,CAAZ,EAAmB;AACjB,WAAOC,UAAP;AACD;;AAED,SAAO1C,OAAO,CAACyC,GAAG,CAAC5C,KAAL,CAAP,GAAqB4C,GAAG,CAAC5C,KAAJ,EAArB,GAAmCA,KAAK,CAAC4C,GAAD,CAA/C;AACD;AAED;;;;;;;;;AAOA,SAASE,oBAAT,CAA8BC,OAA9B,EAAuC;AACrC,MACEA,OAAO,CAACC,KAAR,KAAkB/B,YAAY,CAACgC,MAA/B,IACAF,OAAO,CAACC,KAAR,KAAkB/B,YAAY,CAACiC,MAFjC,EAGE;AACA,UAAM,IAAIhC,YAAJ,CAAiB,wCAAjB,CAAN;AACD;;AAED6B,EAAAA,OAAO,CAACC,KAAR,GAAgB/B,YAAY,CAACkC,QAA7B;AACAJ,EAAAA,OAAO,CAACK,QAAR,GAAmBhB,SAAnB;AACD;AAED;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAyDA,SAASE,sBAAT,CAAgCe,EAAhC,EAAoCC,EAApC,EAAwCxB,uBAAxC,EAAiE;AAC/D,MAAI,CAACA,uBAAL,EAA8B;AAC5B,WAAO7B,OAAO,CAACoD,EAAD,EAAKC,EAAL,CAAd;AACD;;AAED,MAAInB,MAAM,GAAGnC,KAAK,CAACqD,EAAD,EAAK,IAAL,CAAlB;;AACA,OAAK,IAAIE,KAAT,IAAkBD,EAAlB,EAAsB;AACpB,QAAIA,EAAE,CAACE,cAAH,CAAkBD,KAAlB,CAAJ,EAA8B;AAC5B,UAAIE,KAAK,GAAGtB,MAAM,CAACoB,KAAD,CAAlB;AACA,UAAIG,OAAO,GAAGJ,EAAE,CAACC,KAAD,CAAhB;;AACA,UAAIpD,OAAO,CAACsD,KAAD,CAAX,EAAoB;AAClB,YAAI,CAACE,KAAK,CAACC,OAAN,CAAcH,KAAd,CAAL,EAA2B;AACzBA,UAAAA,KAAK,GAAGtB,MAAM,CAACoB,KAAD,CAAN,GAAgB,CAACE,KAAD,CAAxB;AACD;;AAEDtB,QAAAA,MAAM,CAACoB,KAAD,CAAN,GAAgBE,KAAK,CAACI,MAAN,CAAaH,OAAb,CAAhB;AACD,OAND,MAMO;AACLvB,QAAAA,MAAM,CAACoB,KAAD,CAAN,GAAgBI,KAAK,CAACC,OAAN,CAAcF,OAAd,IAAyBA,OAAO,CAACI,KAAR,EAAzB,GAA2CJ,OAA3D;AACD;AACF;AACF;;AAED,SAAOvB,MAAP;AACD;AAED;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AA8CA,SAAS4B,QAAT,CAAkBC,OAAlB,EAA2B;AACzBA,EAAAA,OAAO,GAAG9D,YAAY,CAAC8D,OAAD,EAAU9D,YAAY,CAAC+D,YAAvB,CAAtB;;AACA,MAAI,OAAOD,OAAP,KAAmB,QAAvB,EAAiC;AAC/BA,IAAAA,OAAO,GAAG;AACRE,MAAAA,GAAG,EAAEF;AADG,KAAV;AAGD,GANwB,CAQzB;;;AACAjE,EAAAA,KAAK,CAACoE,MAAN,CAAaC,MAAb,CAAoB,aAApB,EAAmCJ,OAAO,CAACE,GAA3C,EATyB,CAUzB;;AAEA,OAAKG,IAAL,GAAYjC,SAAZ;AACA,OAAKkC,eAAL,GAAuB3B,YAAY,CAACqB,OAAO,CAACO,cAAT,EAAyB,EAAzB,CAAnC;AACA,OAAKlC,gBAAL,GAAwBM,YAAY,CAACqB,OAAO,CAACQ,eAAT,EAA0B,EAA1B,CAApC;AAEA;;;;;;AAKA,OAAKC,OAAL,GAAe9B,YAAY,CAACqB,OAAO,CAACS,OAAT,EAAkB,EAAlB,CAA3B;AAEA;;;;;;AAKA,OAAK1B,OAAL,GAAe7C,YAAY,CAAC8D,OAAO,CAACjB,OAAT,EAAkB,IAAIjC,OAAJ,EAAlB,CAA3B;AAEA;;;;;;AAKA,OAAK4D,KAAL,GAAaV,OAAO,CAACU,KAArB;AAEA;;;;;;AAKA,OAAKC,aAAL,GAAqBX,OAAO,CAACW,aAA7B;AAEA;;;;;;AAKA,OAAKC,aAAL,GAAqB1E,YAAY,CAAC8D,OAAO,CAACY,aAAT,EAAwB,CAAxB,CAAjC;AACA,OAAKC,WAAL,GAAmB,CAAnB;AAEA,MAAIlD,GAAG,GAAG,IAAI/B,GAAJ,CAAQoE,OAAO,CAACE,GAAhB,CAAV;AACAxC,EAAAA,UAAU,CAACC,GAAD,EAAM,IAAN,EAAY,IAAZ,EAAkB,IAAlB,CAAV,CArDyB,CAuDzB;;AACAA,EAAAA,GAAG,CAACmD,QAAJ,GAAe1C,SAAf;AAEA,OAAKiC,IAAL,GAAY1C,GAAG,CAACoD,QAAJ,EAAZ;AACD;AAED;;;;;;;;;;;AASAhB,QAAQ,CAACiB,cAAT,GAA0B,UAAUpD,QAAV,EAAoB;AAC5C,MAAIA,QAAQ,YAAYmC,QAAxB,EAAkC;AAChC;AACA;AACA;AACA;AACA,WAAOnC,QAAQ,CAACqD,kBAAT,CAA4B;AACjClC,MAAAA,OAAO,EAAEnB,QAAQ,CAACmB;AADe,KAA5B,CAAP;AAGD;;AAED,MAAI,OAAOnB,QAAP,KAAoB,QAAxB,EAAkC;AAChC,WAAOA,QAAP;AACD;;AAED,SAAO,IAAImC,QAAJ,CAAa;AAClBG,IAAAA,GAAG,EAAEtC;AADa,GAAb,CAAP;AAGD,CAlBD;;AAoBA,IAAIsD,iCAAJ;AACA;;;;;;;;AAOAnB,QAAQ,CAACoB,0BAAT,GAAsC,YAAY;AAChD;AACA;AACA;AACA,MAAIhF,OAAO,CAAC+E,iCAAD,CAAX,EAAgD;AAC9C,WAAOA,iCAAP;AACD;;AAED,MAAI,OAAOE,iBAAP,KAA6B,UAAjC,EAA6C;AAC3CF,IAAAA,iCAAiC,GAAGrF,IAAI,CAACwF,OAAL,CAAa,KAAb,CAApC;AACA,WAAOH,iCAAP;AACD;;AAED,MAAII,YAAY,GACd,wHADF;AAGAJ,EAAAA,iCAAiC,GAAGnB,QAAQ,CAACwB,SAAT,CAAmB;AACrDrB,IAAAA,GAAG,EAAEoB;AADgD,GAAnB,EAGjCE,IAHiC,CAG5B,UAAUC,IAAV,EAAgB;AACpB,WAAOL,iBAAiB,CAACK,IAAD,EAAO;AAC7BC,MAAAA,gBAAgB,EAAE,OADW;AAE7BC,MAAAA,gBAAgB,EAAE;AAFW,KAAP,CAAxB;AAID,GARiC,EASjCH,IATiC,CAS5B,UAAUI,WAAV,EAAuB;AAC3B,WAAO,IAAP;AACD,GAXiC,EAYjCC,SAZiC,CAYvB,YAAY;AACrB,WAAO,KAAP;AACD,GAdiC,CAApC;AAgBA,SAAOX,iCAAP;AACD,CAjCD;;AAmCAxC,MAAM,CAACoD,gBAAP,CAAwB/B,QAAxB,EAAkC;AAChC;;;;;;;;AAQAgC,EAAAA,eAAe,EAAE;AACfC,IAAAA,GAAG,EAAE,eAAY;AACf,aAAO5E,gBAAP;AACD;AAHc;AATe,CAAlC;AAgBAsB,MAAM,CAACoD,gBAAP,CAAwB/B,QAAQ,CAACkC,SAAjC,EAA4C;AAC1C;;;;;;;;AAQAzB,EAAAA,eAAe,EAAE;AACfwB,IAAAA,GAAG,EAAE,eAAY;AACf,aAAO,KAAK3D,gBAAZ;AACD;AAHc,GATyB;;AAe1C;;;;;;;;AAQAkC,EAAAA,cAAc,EAAE;AACdyB,IAAAA,GAAG,EAAE,eAAY;AACf,aAAO,KAAK1B,eAAZ;AACD;AAHa,GAvB0B;;AA6B1C;;;;;;AAMAJ,EAAAA,GAAG,EAAE;AACH8B,IAAAA,GAAG,EAAE,eAAY;AACf,aAAO,KAAKE,eAAL,CAAqB,IAArB,EAA2B,IAA3B,CAAP;AACD,KAHE;AAIHC,IAAAA,GAAG,EAAE,aAAU1C,KAAV,EAAiB;AACpB,UAAI9B,GAAG,GAAG,IAAI/B,GAAJ,CAAQ6D,KAAR,CAAV;AAEA/B,MAAAA,UAAU,CAACC,GAAD,EAAM,IAAN,EAAY,KAAZ,CAAV,CAHoB,CAKpB;;AACAA,MAAAA,GAAG,CAACmD,QAAJ,GAAe1C,SAAf;AAEA,WAAKiC,IAAL,GAAY1C,GAAG,CAACoD,QAAJ,EAAZ;AACD;AAbE,GAnCqC;;AAmD1C;;;;;;;;AAQAqB,EAAAA,SAAS,EAAE;AACTJ,IAAAA,GAAG,EAAE,eAAY;AACf,aAAOzF,mBAAmB,CAAC,KAAK8D,IAAN,CAA1B;AACD;AAHQ,GA3D+B;;AAiE1C;;;;;;AAMA3D,EAAAA,SAAS,EAAE;AACTsF,IAAAA,GAAG,EAAE,eAAY;AACf,aAAOtF,SAAS,CAAC,KAAK2D,IAAN,CAAhB;AACD;AAHQ,GAvE+B;;AA6E1C;;;;;;AAMA7D,EAAAA,SAAS,EAAE;AACTwF,IAAAA,GAAG,EAAE,eAAY;AACf,aAAOxF,SAAS,CAAC,KAAK6D,IAAN,CAAhB;AACD;AAHQ,GAnF+B;;AAyF1C;;;;;;AAMA5D,EAAAA,gBAAgB,EAAE;AAChBuF,IAAAA,GAAG,EAAE,eAAY;AACf,aAAOvF,gBAAgB,CAAC,KAAK4D,IAAN,CAAvB;AACD;AAHe,GA/FwB;;AAqG1C;;;;;;AAMAgC,EAAAA,UAAU,EAAE;AACVL,IAAAA,GAAG,EAAE,eAAY;AACf,aAAOtD,MAAM,CAACD,IAAP,CAAY,KAAKgC,OAAjB,EAA0BxC,MAA1B,GAAmC,CAA1C;AACD;AAHS;AA3G8B,CAA5C;AAkHA;;;;;;;;;AAQA8B,QAAQ,CAACkC,SAAT,CAAmBC,eAAnB,GAAqC,UAAUlE,KAAV,EAAiB0C,KAAjB,EAAwB;AAC3D,MAAI,KAAKhE,SAAT,EAAoB;AAClB,WAAO,KAAK2D,IAAZ;AACD;;AAED,MAAI1C,GAAG,GAAG,IAAI/B,GAAJ,CAAQ,KAAKyE,IAAb,CAAV;;AAEA,MAAIrC,KAAJ,EAAW;AACTO,IAAAA,cAAc,CAACZ,GAAD,EAAM,IAAN,CAAd;AACD,GAT0D,CAW3D;;;AACA,MAAIuC,GAAG,GAAGvC,GAAG,CAACoD,QAAJ,GAAeuB,OAAf,CAAuB,MAAvB,EAA+B,GAA/B,EAAoCA,OAApC,CAA4C,MAA5C,EAAoD,GAApD,CAAV;AAEA,MAAI/B,cAAc,GAAG,KAAKD,eAA1B;AACAJ,EAAAA,GAAG,GAAGA,GAAG,CAACoC,OAAJ,CAAY,UAAZ,EAAwB,UAAUC,KAAV,EAAiBC,GAAjB,EAAsB;AAClD,QAAIC,WAAW,GAAGlC,cAAc,CAACiC,GAAD,CAAhC;;AACA,QAAIrG,OAAO,CAACsG,WAAD,CAAX,EAA0B;AACxB;AACA,aAAOC,kBAAkB,CAACD,WAAD,CAAzB;AACD,KALiD,CAMlD;;;AACA,WAAOF,KAAP;AACD,GARK,CAAN;;AAUA,MAAI7B,KAAK,IAAIvE,OAAO,CAAC,KAAKuE,KAAN,CAApB,EAAkC;AAChCR,IAAAA,GAAG,GAAG,KAAKQ,KAAL,CAAWiC,MAAX,CAAkBzC,GAAlB,CAAN;AACD;;AACD,SAAOA,GAAP;AACD,CA7BD;AA+BA;;;;;;;;;AAOAH,QAAQ,CAACkC,SAAT,CAAmBW,kBAAnB,GAAwC,UAAUC,MAAV,EAAkBC,YAAlB,EAAgC;AACtE,MAAIA,YAAJ,EAAkB;AAChB,SAAKzE,gBAAL,GAAwBC,sBAAsB,CAC5C,KAAKD,gBADuC,EAE5CwE,MAF4C,EAG5C,KAH4C,CAA9C;AAKD,GAND,MAMO;AACL,SAAKxE,gBAAL,GAAwBC,sBAAsB,CAC5CuE,MAD4C,EAE5C,KAAKxE,gBAFuC,EAG5C,KAH4C,CAA9C;AAKD;AACF,CAdD;AAgBA;;;;;;;;AAMA0B,QAAQ,CAACkC,SAAT,CAAmBc,qBAAnB,GAA2C,UAAUF,MAAV,EAAkB;AAC3D,OAAKxE,gBAAL,GAAwBC,sBAAsB,CAC5CuE,MAD4C,EAE5C,KAAKxE,gBAFuC,EAG5C,IAH4C,CAA9C;AAKD,CAND;AAQA;;;;;;;;;AAOA0B,QAAQ,CAACkC,SAAT,CAAmBe,iBAAnB,GAAuC,UAAUC,QAAV,EAAoBH,YAApB,EAAkC;AACvE,MAAIA,YAAJ,EAAkB;AAChB,SAAKxC,eAAL,GAAuBrE,OAAO,CAAC,KAAKqE,eAAN,EAAuB2C,QAAvB,CAA9B;AACD,GAFD,MAEO;AACL,SAAK3C,eAAL,GAAuBrE,OAAO,CAACgH,QAAD,EAAW,KAAK3C,eAAhB,CAA9B;AACD;AACF,CAND;AAQA;;;;;;;;;;;;;;;;;;AAgBAP,QAAQ,CAACkC,SAAT,CAAmBhB,kBAAnB,GAAwC,UAAUjB,OAAV,EAAmB;AACzD,MAAIpC,QAAQ,GAAG,KAAK5B,KAAL,EAAf;AACA4B,EAAAA,QAAQ,CAACiD,WAAT,GAAuB,CAAvB;;AAEA,MAAI1E,OAAO,CAAC6D,OAAO,CAACE,GAAT,CAAX,EAA0B;AACxB,QAAIvC,GAAG,GAAG,IAAI/B,GAAJ,CAAQoE,OAAO,CAACE,GAAhB,CAAV;AAEA,QAAIpC,uBAAuB,GAAG5B,YAAY,CACxC8D,OAAO,CAAClC,uBADgC,EAExC,KAFwC,CAA1C;AAIAJ,IAAAA,UAAU,CAACC,GAAD,EAAMC,QAAN,EAAgB,IAAhB,EAAsBE,uBAAtB,CAAV,CAPwB,CASxB;;AACAH,IAAAA,GAAG,CAACmD,QAAJ,GAAe1C,SAAf;AAEAR,IAAAA,QAAQ,CAACyC,IAAT,GAAgB1C,GAAG,CAAC0D,OAAJ,CAAY,IAAIzF,GAAJ,CAAQS,cAAc,CAAC,KAAKgE,IAAN,CAAtB,CAAZ,EAAgDU,QAAhD,EAAhB;AACD;;AAED,MAAI5E,OAAO,CAAC6D,OAAO,CAACQ,eAAT,CAAX,EAAsC;AACpC5C,IAAAA,QAAQ,CAACS,gBAAT,GAA4BpC,OAAO,CACjC+D,OAAO,CAACQ,eADyB,EAEjC5C,QAAQ,CAACS,gBAFwB,CAAnC;AAID;;AACD,MAAIlC,OAAO,CAAC6D,OAAO,CAACO,cAAT,CAAX,EAAqC;AACnC3C,IAAAA,QAAQ,CAAC0C,eAAT,GAA2BrE,OAAO,CAChC+D,OAAO,CAACO,cADwB,EAEhC3C,QAAQ,CAAC2C,cAFuB,CAAlC;AAID;;AACD,MAAIpE,OAAO,CAAC6D,OAAO,CAACS,OAAT,CAAX,EAA8B;AAC5B7C,IAAAA,QAAQ,CAAC6C,OAAT,GAAmBxE,OAAO,CAAC+D,OAAO,CAACS,OAAT,EAAkB7C,QAAQ,CAAC6C,OAA3B,CAA1B;AACD;;AACD,MAAItE,OAAO,CAAC6D,OAAO,CAACU,KAAT,CAAX,EAA4B;AAC1B9C,IAAAA,QAAQ,CAAC8C,KAAT,GAAiBV,OAAO,CAACU,KAAzB;AACD;;AACD,MAAIvE,OAAO,CAAC6D,OAAO,CAACjB,OAAT,CAAX,EAA8B;AAC5BnB,IAAAA,QAAQ,CAACmB,OAAT,GAAmBiB,OAAO,CAACjB,OAA3B;AACD;;AACD,MAAI5C,OAAO,CAAC6D,OAAO,CAACW,aAAT,CAAX,EAAoC;AAClC/C,IAAAA,QAAQ,CAAC+C,aAAT,GAAyBX,OAAO,CAACW,aAAjC;AACD;;AACD,MAAIxE,OAAO,CAAC6D,OAAO,CAACY,aAAT,CAAX,EAAoC;AAClChD,IAAAA,QAAQ,CAACgD,aAAT,GAAyBZ,OAAO,CAACY,aAAjC;AACD;;AAED,SAAOhD,QAAP;AACD,CAhDD;AAkDA;;;;;;;;;;;AASAmC,QAAQ,CAACkC,SAAT,CAAmBiB,YAAnB,GAAkC,UAAUC,KAAV,EAAiB;AACjD,MAAIxC,aAAa,GAAG,KAAKA,aAAzB;;AACA,MACE,OAAOA,aAAP,KAAyB,UAAzB,IACA,KAAKE,WAAL,IAAoB,KAAKD,aAF3B,EAGE;AACA,WAAO/E,IAAI,CAAC,KAAD,CAAX;AACD;;AAED,MAAIuH,IAAI,GAAG,IAAX;AACA,SAAOvH,IAAI,CAAC8E,aAAa,CAAC,IAAD,EAAOwC,KAAP,CAAd,CAAJ,CAAiC3B,IAAjC,CAAsC,UAAUrD,MAAV,EAAkB;AAC7D,MAAEiF,IAAI,CAACvC,WAAP;AAEA,WAAO1C,MAAP;AACD,GAJM,CAAP;AAKD,CAfD;AAiBA;;;;;;;;;AAOA4B,QAAQ,CAACkC,SAAT,CAAmBjG,KAAnB,GAA2B,UAAUmC,MAAV,EAAkB;AAC3C,MAAI,CAAChC,OAAO,CAACgC,MAAD,CAAZ,EAAsB;AACpBA,IAAAA,MAAM,GAAG,IAAI4B,QAAJ,CAAa;AACpBG,MAAAA,GAAG,EAAE,KAAKG;AADU,KAAb,CAAT;AAGD;;AAEDlC,EAAAA,MAAM,CAACkC,IAAP,GAAc,KAAKA,IAAnB;AACAlC,EAAAA,MAAM,CAACE,gBAAP,GAA0BrC,KAAK,CAAC,KAAKqC,gBAAN,CAA/B;AACAF,EAAAA,MAAM,CAACmC,eAAP,GAAyBtE,KAAK,CAAC,KAAKsE,eAAN,CAA9B;AACAnC,EAAAA,MAAM,CAACsC,OAAP,GAAiBzE,KAAK,CAAC,KAAKyE,OAAN,CAAtB;AACAtC,EAAAA,MAAM,CAACuC,KAAP,GAAe,KAAKA,KAApB;AACAvC,EAAAA,MAAM,CAACwC,aAAP,GAAuB,KAAKA,aAA5B;AACAxC,EAAAA,MAAM,CAACyC,aAAP,GAAuB,KAAKA,aAA5B;AACAzC,EAAAA,MAAM,CAAC0C,WAAP,GAAqB,CAArB;AACA1C,EAAAA,MAAM,CAACY,OAAP,GAAiB,KAAKA,OAAL,CAAa/C,KAAb,EAAjB;AAEA,SAAOmC,MAAP;AACD,CAlBD;AAoBA;;;;;;;;;AAOA4B,QAAQ,CAACkC,SAAT,CAAmB3F,UAAnB,GAAgC,UAAU+G,YAAV,EAAwB;AACtD,SAAO/G,UAAU,CAAC,KAAK4F,eAAL,CAAqBmB,YAArB,CAAD,EAAqCA,YAArC,CAAjB;AACD,CAFD;AAIA;;;;;AAGAtD,QAAQ,CAACkC,SAAT,CAAmBnG,kBAAnB,GAAwC,YAAY;AAClD,OAAKuE,IAAL,GAAYvE,kBAAkB,CAAC,KAAKuE,IAAN,CAA9B;AACD,CAFD;AAIA;;;;;;;;;;;;;;;;;;;;;AAmBAN,QAAQ,CAACkC,SAAT,CAAmBqB,gBAAnB,GAAsC,YAAY;AAChD,SAAO,KAAKC,KAAL,CAAW;AAChB/F,IAAAA,YAAY,EAAE;AADE,GAAX,CAAP;AAGD,CAJD;AAMA;;;;;;;;;;;;;;;;AAcAuC,QAAQ,CAACuD,gBAAT,GAA4B,UAAUtD,OAAV,EAAmB;AAC7C,MAAIpC,QAAQ,GAAG,IAAImC,QAAJ,CAAaC,OAAb,CAAf;AACA,SAAOpC,QAAQ,CAAC0F,gBAAT,EAAP;AACD,CAHD;AAKA;;;;;;;;;;;;;;;;;;;;;AAmBAvD,QAAQ,CAACkC,SAAT,CAAmBV,SAAnB,GAA+B,YAAY;AACzC,SAAO,KAAKgC,KAAL,CAAW;AAChB/F,IAAAA,YAAY,EAAE;AADE,GAAX,CAAP;AAGD,CAJD;AAMA;;;;;;;;;;;;;;;;AAcAuC,QAAQ,CAACwB,SAAT,GAAqB,UAAUvB,OAAV,EAAmB;AACtC,MAAIpC,QAAQ,GAAG,IAAImC,QAAJ,CAAaC,OAAb,CAAf;AACA,SAAOpC,QAAQ,CAAC2D,SAAT,EAAP;AACD,CAHD;AAKA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AA4BAxB,QAAQ,CAACkC,SAAT,CAAmBuB,UAAnB,GAAgC,UAAUxD,OAAV,EAAmB;AACjDA,EAAAA,OAAO,GAAG9D,YAAY,CAAC8D,OAAD,EAAU9D,YAAY,CAAC+D,YAAvB,CAAtB;AACA,MAAIwD,iBAAiB,GAAGvH,YAAY,CAAC8D,OAAO,CAACyD,iBAAT,EAA4B,KAA5B,CAApC;AACA,MAAIC,UAAU,GAAGxH,YAAY,CAAC8D,OAAO,CAAC0D,UAAT,EAAqB,KAArB,CAA7B;AACA,MAAIC,KAAK,GAAGzH,YAAY,CAAC8D,OAAO,CAAC2D,KAAT,EAAgB,KAAhB,CAAxB;AAEA7E,EAAAA,oBAAoB,CAAC,KAAKC,OAAN,CAApB,CANiD,CAQjD;AACA;AACA;AACA;AACA;;AACA,MACE,CAAC3B,gBAAD,IACA,KAAKV,SADL,IAEA,KAAKF,SAFL,IAGC,CAAC,KAAK6F,UAAN,IAAoB,CAACqB,UAJxB,EAKE;AACA,WAAOF,UAAU,CAAC;AAChB5F,MAAAA,QAAQ,EAAE,IADM;AAEhB+F,MAAAA,KAAK,EAAEA,KAFS;AAGhBF,MAAAA,iBAAiB,EAAEA;AAHH,KAAD,CAAjB;AAKD;;AAED,MAAIG,WAAW,GAAG,KAAKrC,SAAL,EAAlB;;AACA,MAAI,CAACpF,OAAO,CAACyH,WAAD,CAAZ,EAA2B;AACzB;AACD;;AAED,MAAIC,mBAAJ;AACA,MAAIC,cAAJ;AACA,MAAIC,qBAAJ;AACA,MAAIC,aAAJ;AACA,SAAOjE,QAAQ,CAACoB,0BAAT,GACJK,IADI,CACC,UAAUrD,MAAV,EAAkB;AACtB0F,IAAAA,mBAAmB,GAAG1F,MAAtB;AACA2F,IAAAA,cAAc,GAAGD,mBAAmB,IAAIJ,iBAAxC;AACA,WAAOG,WAAP;AACD,GALI,EAMJpC,IANI,CAMC,UAAUC,IAAV,EAAgB;AACpB,QAAI,CAACtF,OAAO,CAACsF,IAAD,CAAZ,EAAoB;AAClB;AACD;;AACDuC,IAAAA,aAAa,GAAGvC,IAAhB;;AACA,QAAIqC,cAAJ,EAAoB;AAClB,aAAO/D,QAAQ,CAACkE,yBAAT,CAAmCxC,IAAnC,EAAyC;AAC9CkC,QAAAA,KAAK,EAAEA,KADuC;AAE9ChC,QAAAA,gBAAgB,EAAE;AAF4B,OAAzC,CAAP;AAID;;AACD,QAAIuC,OAAO,GAAGC,MAAM,CAACC,GAAP,CAAWC,eAAX,CAA2B5C,IAA3B,CAAd;AACAsC,IAAAA,qBAAqB,GAAG,IAAIhE,QAAJ,CAAa;AACnCG,MAAAA,GAAG,EAAEgE;AAD8B,KAAb,CAAxB;AAIA,WAAOV,UAAU,CAAC;AAChB5F,MAAAA,QAAQ,EAAEmG,qBADM;AAEhBJ,MAAAA,KAAK,EAAEA,KAFS;AAGhBF,MAAAA,iBAAiB,EAAE;AAHH,KAAD,CAAjB;AAKD,GA3BI,EA4BJjC,IA5BI,CA4BC,UAAU8C,KAAV,EAAiB;AACrB,QAAI,CAACnI,OAAO,CAACmI,KAAD,CAAZ,EAAqB;AACnB;AACD,KAHoB,CAKrB;AACA;;;AACAA,IAAAA,KAAK,CAAC7C,IAAN,GAAauC,aAAb;;AAEA,QAAIF,cAAJ,EAAoB;AAClB,aAAOQ,KAAP;AACD;;AAEDH,IAAAA,MAAM,CAACC,GAAP,CAAWG,eAAX,CAA2BR,qBAAqB,CAAC7D,GAAjD;AACA,WAAOoE,KAAP;AACD,GA3CI,EA4CJzC,SA5CI,CA4CM,UAAUsB,KAAV,EAAiB;AAC1B,QAAIhH,OAAO,CAAC4H,qBAAD,CAAX,EAAoC;AAClCI,MAAAA,MAAM,CAACC,GAAP,CAAWG,eAAX,CAA2BR,qBAAqB,CAAC7D,GAAjD;AACD,KAHyB,CAK1B;AACA;AACA;AACA;;;AACAiD,IAAAA,KAAK,CAAC1B,IAAN,GAAauC,aAAb;AAEA,WAAOnI,IAAI,CAAC2I,MAAL,CAAYrB,KAAZ,CAAP;AACD,GAxDI,CAAP;AAyDD,CA5FD;AA8FA;;;;;;;;;;;;AAUA,SAASK,UAAT,CAAoBxD,OAApB,EAA6B;AAC3B,MAAIpC,QAAQ,GAAGoC,OAAO,CAACpC,QAAvB;AACA,MAAI+F,KAAK,GAAG3D,OAAO,CAAC2D,KAApB;AACA,MAAIF,iBAAiB,GAAGzD,OAAO,CAACyD,iBAAhC;AAEA,MAAI1E,OAAO,GAAGnB,QAAQ,CAACmB,OAAvB;AACAA,EAAAA,OAAO,CAACmB,GAAR,GAActC,QAAQ,CAACsC,GAAvB;;AACAnB,EAAAA,OAAO,CAAC0F,eAAR,GAA0B,YAAY;AACpC,QAAIC,WAAW,GAAG,KAAlB,CADoC,CAGpC;;AACA,QAAI,CAAC9G,QAAQ,CAAClB,SAAV,IAAuB,CAACkB,QAAQ,CAACpB,SAArC,EAAgD;AAC9CkI,MAAAA,WAAW,GAAG9G,QAAQ,CAACnB,gBAAvB;AACD;;AAED,QAAI2C,QAAQ,GAAGvD,IAAI,CAAC8I,KAAL,EAAf;;AACA5E,IAAAA,QAAQ,CAAC6E,gBAAT,CAA0BC,WAA1B,CACE9F,OADF,EAEE2F,WAFF,EAGEtF,QAHF,EAIEuE,KAJF,EAKEF,iBALF;;AAQA,WAAOrE,QAAQ,CAAC0F,OAAhB;AACD,GAlBD;;AAoBA,MAAIA,OAAO,GAAG9H,gBAAgB,CAAC+B,OAAjB,CAAyBA,OAAzB,CAAd;;AACA,MAAI,CAAC5C,OAAO,CAAC2I,OAAD,CAAZ,EAAuB;AACrB;AACD;;AAED,SAAOA,OAAO,CAACjD,SAAR,CAAkB,UAAUpE,CAAV,EAAa;AACpC;AACA,QAAIsB,OAAO,CAACC,KAAR,KAAkB/B,YAAY,CAAC8H,MAAnC,EAA2C;AACzC,aAAOlJ,IAAI,CAAC2I,MAAL,CAAY/G,CAAZ,CAAP;AACD;;AAED,WAAOG,QAAQ,CAACsF,YAAT,CAAsBzF,CAAtB,EAAyB+D,IAAzB,CAA8B,UAAUwD,KAAV,EAAiB;AACpD,UAAIA,KAAJ,EAAW;AACT;AACAjG,QAAAA,OAAO,CAACC,KAAR,GAAgB/B,YAAY,CAACkC,QAA7B;AACAJ,QAAAA,OAAO,CAACK,QAAR,GAAmBhB,SAAnB;AAEA,eAAOoF,UAAU,CAAC;AAChB5F,UAAAA,QAAQ,EAAEA,QADM;AAEhB+F,UAAAA,KAAK,EAAEA,KAFS;AAGhBF,UAAAA,iBAAiB,EAAEA;AAHH,SAAD,CAAjB;AAKD;;AAED,aAAO5H,IAAI,CAAC2I,MAAL,CAAY/G,CAAZ,CAAP;AACD,KAdM,CAAP;AAeD,GArBM,CAAP;AAsBD;AAED;;;;;;;;;;;;;;;;;;;AAiBAsC,QAAQ,CAACyD,UAAT,GAAsB,UAAUxD,OAAV,EAAmB;AACvC,MAAIpC,QAAQ,GAAG,IAAImC,QAAJ,CAAaC,OAAb,CAAf;AACA,SAAOpC,QAAQ,CAAC4F,UAAT,CAAoB;AACzBG,IAAAA,KAAK,EAAE3D,OAAO,CAAC2D,KADU;AAEzBD,IAAAA,UAAU,EAAE1D,OAAO,CAAC0D,UAFK;AAGzBD,IAAAA,iBAAiB,EAAEzD,OAAO,CAACyD;AAHF,GAApB,CAAP;AAKD,CAPD;AASA;;;;;;;;;;;;;;;;;;;;;;;;;;;;AA0BA1D,QAAQ,CAACkC,SAAT,CAAmBgD,SAAnB,GAA+B,YAAY;AACzC,SAAO,KAAK1B,KAAL,CAAW;AAChB/F,IAAAA,YAAY,EAAE;AADE,GAAX,CAAP;AAGD,CAJD;AAMA;;;;;;;;;;;;;;;;AAcAuC,QAAQ,CAACkF,SAAT,GAAqB,UAAUjF,OAAV,EAAmB;AACtC,MAAIpC,QAAQ,GAAG,IAAImC,QAAJ,CAAaC,OAAb,CAAf;AACA,SAAOpC,QAAQ,CAACqH,SAAT,EAAP;AACD,CAHD,C,CAKA;;AACA;;;;;;;;;;;;;;;;;;;;;;;AAqBAlF,QAAQ,CAACkC,SAAT,CAAmBiD,SAAnB,GAA+B,YAAY;AACzC,MAAIJ,OAAO,GAAG,KAAKvB,KAAL,CAAW;AACvB/F,IAAAA,YAAY,EAAE,MADS;AAEvBiD,IAAAA,OAAO,EAAE;AACP0E,MAAAA,MAAM,EAAE;AADD;AAFc,GAAX,CAAd;;AAOA,MAAI,CAAChJ,OAAO,CAAC2I,OAAD,CAAZ,EAAuB;AACrB,WAAO1G,SAAP;AACD;;AAED,SAAO0G,OAAO,CAACtD,IAAR,CAAa,UAAU/B,KAAV,EAAiB;AACnC,QAAI,CAACtD,OAAO,CAACsD,KAAD,CAAZ,EAAqB;AACnB;AACD;;AACD,WAAO2F,IAAI,CAACC,KAAL,CAAW5F,KAAX,CAAP;AACD,GALM,CAAP;AAMD,CAlBD;AAoBA;;;;;;;;;;;;;;;;AAcAM,QAAQ,CAACmF,SAAT,GAAqB,UAAUlF,OAAV,EAAmB;AACtC,MAAIpC,QAAQ,GAAG,IAAImC,QAAJ,CAAaC,OAAb,CAAf;AACA,SAAOpC,QAAQ,CAACsH,SAAT,EAAP;AACD,CAHD;AAKA;;;;;;;;;;;;;;;;;;;;;;;;;AAuBAnF,QAAQ,CAACkC,SAAT,CAAmBqD,QAAnB,GAA8B,YAAY;AACxC,SAAO,KAAK/B,KAAL,CAAW;AAChB/F,IAAAA,YAAY,EAAE,UADE;AAEhB+H,IAAAA,gBAAgB,EAAE;AAFF,GAAX,CAAP;AAID,CALD;AAOA;;;;;;;;;;;;;;;;AAcAxF,QAAQ,CAACuF,QAAT,GAAoB,UAAUtF,OAAV,EAAmB;AACrC,MAAIpC,QAAQ,GAAG,IAAImC,QAAJ,CAAaC,OAAb,CAAf;AACA,SAAOpC,QAAQ,CAAC0H,QAAT,EAAP;AACD,CAHD;AAKA;;;;;;;;;;;;;;;;;;;AAiBAvF,QAAQ,CAACkC,SAAT,CAAmBuD,UAAnB,GAAgC,UAAUC,qBAAV,EAAiC;AAC/DA,EAAAA,qBAAqB,GAAGvJ,YAAY,CAACuJ,qBAAD,EAAwB,UAAxB,CAApC;AAEA3G,EAAAA,oBAAoB,CAAC,KAAKC,OAAN,CAApB,CAH+D,CAK/D;;AACA,MAAI2G,YAAJ;;AACA,KAAG;AACDA,IAAAA,YAAY,GAAG,cAAcC,IAAI,CAACC,MAAL,GAAc7E,QAAd,GAAyB8E,SAAzB,CAAmC,CAAnC,EAAsC,CAAtC,CAA7B;AACD,GAFD,QAES1J,OAAO,CAACgI,MAAM,CAACuB,YAAD,CAAP,CAFhB;;AAIA,SAAOF,UAAU,CAAC,IAAD,EAAOC,qBAAP,EAA8BC,YAA9B,CAAjB;AACD,CAZD;;AAcA,SAASF,UAAT,CAAoB5H,QAApB,EAA8B6H,qBAA9B,EAAqDC,YAArD,EAAmE;AACjE,MAAII,aAAa,GAAG,EAApB;AACAA,EAAAA,aAAa,CAACL,qBAAD,CAAb,GAAuCC,YAAvC;AACA9H,EAAAA,QAAQ,CAACgF,kBAAT,CAA4BkD,aAA5B;AAEA,MAAI/G,OAAO,GAAGnB,QAAQ,CAACmB,OAAvB;AACAA,EAAAA,OAAO,CAACmB,GAAR,GAActC,QAAQ,CAACsC,GAAvB;;AACAnB,EAAAA,OAAO,CAAC0F,eAAR,GAA0B,YAAY;AACpC,QAAIrF,QAAQ,GAAGvD,IAAI,CAAC8I,KAAL,EAAf,CADoC,CAGpC;;AACAR,IAAAA,MAAM,CAACuB,YAAD,CAAN,GAAuB,UAAUK,IAAV,EAAgB;AACrC3G,MAAAA,QAAQ,CAACiC,OAAT,CAAiB0E,IAAjB;;AAEA,UAAI;AACF,eAAO5B,MAAM,CAACuB,YAAD,CAAb;AACD,OAFD,CAEE,OAAOjI,CAAP,EAAU;AACV0G,QAAAA,MAAM,CAACuB,YAAD,CAAN,GAAuBtH,SAAvB;AACD;AACF,KARD;;AAUA2B,IAAAA,QAAQ,CAAC6E,gBAAT,CAA0BjI,oBAA1B,CACEiB,QAAQ,CAACsC,GADX,EAEEwF,YAFF,EAGEtG,QAHF;;AAKA,WAAOA,QAAQ,CAAC0F,OAAhB;AACD,GApBD;;AAsBA,MAAIA,OAAO,GAAG9H,gBAAgB,CAAC+B,OAAjB,CAAyBA,OAAzB,CAAd;;AACA,MAAI,CAAC5C,OAAO,CAAC2I,OAAD,CAAZ,EAAuB;AACrB;AACD;;AAED,SAAOA,OAAO,CAACjD,SAAR,CAAkB,UAAUpE,CAAV,EAAa;AACpC,QAAIsB,OAAO,CAACC,KAAR,KAAkB/B,YAAY,CAAC8H,MAAnC,EAA2C;AACzC,aAAOlJ,IAAI,CAAC2I,MAAL,CAAY/G,CAAZ,CAAP;AACD;;AAED,WAAOG,QAAQ,CAACsF,YAAT,CAAsBzF,CAAtB,EAAyB+D,IAAzB,CAA8B,UAAUwD,KAAV,EAAiB;AACpD,UAAIA,KAAJ,EAAW;AACT;AACAjG,QAAAA,OAAO,CAACC,KAAR,GAAgB/B,YAAY,CAACkC,QAA7B;AACAJ,QAAAA,OAAO,CAACK,QAAR,GAAmBhB,SAAnB;AAEA,eAAOoH,UAAU,CAAC5H,QAAD,EAAW6H,qBAAX,EAAkCC,YAAlC,CAAjB;AACD;;AAED,aAAO7J,IAAI,CAAC2I,MAAL,CAAY/G,CAAZ,CAAP;AACD,KAVM,CAAP;AAWD,GAhBM,CAAP;AAiBD;AAED;;;;;;;;;;;;;;;;;AAeAsC,QAAQ,CAACyF,UAAT,GAAsB,UAAUxF,OAAV,EAAmB;AACvC,MAAIpC,QAAQ,GAAG,IAAImC,QAAJ,CAAaC,OAAb,CAAf;AACA,SAAOpC,QAAQ,CAAC4H,UAAT,CAAoBxF,OAAO,CAACyF,qBAA5B,CAAP;AACD,CAHD;AAKA;;;;;AAGA1F,QAAQ,CAACkC,SAAT,CAAmB+D,YAAnB,GAAkC,UAAUhG,OAAV,EAAmB;AACnD,MAAIpC,QAAQ,GAAG,IAAf;AACAkB,EAAAA,oBAAoB,CAAClB,QAAQ,CAACmB,OAAV,CAApB;AAEA,MAAIA,OAAO,GAAGnB,QAAQ,CAACmB,OAAvB;AACAA,EAAAA,OAAO,CAACmB,GAAR,GAActC,QAAQ,CAACsC,GAAvB;;AAEAnB,EAAAA,OAAO,CAAC0F,eAAR,GAA0B,YAAY;AACpC,QAAIjH,YAAY,GAAGwC,OAAO,CAACxC,YAA3B;AACA,QAAIiD,OAAO,GAAGxE,OAAO,CAAC+D,OAAO,CAACS,OAAT,EAAkB7C,QAAQ,CAAC6C,OAA3B,CAArB;AACA,QAAI8E,gBAAgB,GAAGvF,OAAO,CAACuF,gBAA/B;AACA,QAAIU,MAAM,GAAGjG,OAAO,CAACiG,MAArB;AACA,QAAIF,IAAI,GAAG/F,OAAO,CAAC+F,IAAnB;AACA,QAAI3G,QAAQ,GAAGvD,IAAI,CAAC8I,KAAL,EAAf;;AACA,QAAItH,GAAG,GAAG0C,QAAQ,CAAC6E,gBAAT,CAA0BsB,WAA1B,CACRtI,QAAQ,CAACsC,GADD,EAER1C,YAFQ,EAGRyI,MAHQ,EAIRF,IAJQ,EAKRtF,OALQ,EAMRrB,QANQ,EAORmG,gBAPQ,CAAV;;AASA,QAAIpJ,OAAO,CAACkB,GAAD,CAAP,IAAgBlB,OAAO,CAACkB,GAAG,CAAC8I,KAAL,CAA3B,EAAwC;AACtCpH,MAAAA,OAAO,CAACqH,cAAR,GAAyB,YAAY;AACnC/I,QAAAA,GAAG,CAAC8I,KAAJ;AACD,OAFD;AAGD;;AACD,WAAO/G,QAAQ,CAAC0F,OAAhB;AACD,GAtBD;;AAwBA,MAAIA,OAAO,GAAG9H,gBAAgB,CAAC+B,OAAjB,CAAyBA,OAAzB,CAAd;;AACA,MAAI,CAAC5C,OAAO,CAAC2I,OAAD,CAAZ,EAAuB;AACrB;AACD;;AAED,SAAOA,OAAO,CACXtD,IADI,CACC,UAAUuE,IAAV,EAAgB;AACpB,WAAOA,IAAP;AACD,GAHI,EAIJlE,SAJI,CAIM,UAAUpE,CAAV,EAAa;AACtB,QAAIsB,OAAO,CAACC,KAAR,KAAkB/B,YAAY,CAAC8H,MAAnC,EAA2C;AACzC,aAAOlJ,IAAI,CAAC2I,MAAL,CAAY/G,CAAZ,CAAP;AACD;;AAED,WAAOG,QAAQ,CAACsF,YAAT,CAAsBzF,CAAtB,EAAyB+D,IAAzB,CAA8B,UAAUwD,KAAV,EAAiB;AACpD,UAAIA,KAAJ,EAAW;AACT;AACAjG,QAAAA,OAAO,CAACC,KAAR,GAAgB/B,YAAY,CAACkC,QAA7B;AACAJ,QAAAA,OAAO,CAACK,QAAR,GAAmBhB,SAAnB;AAEA,eAAOR,QAAQ,CAAC2F,KAAT,CAAevD,OAAf,CAAP;AACD;;AAED,aAAOnE,IAAI,CAAC2I,MAAL,CAAY/G,CAAZ,CAAP;AACD,KAVM,CAAP;AAWD,GApBI,CAAP;AAqBD,CAzDD;;AA2DA,IAAI4I,YAAY,GAAG,6BAAnB;;AAEA,SAASC,iBAAT,CAA2BC,QAA3B,EAAqCR,IAArC,EAA2C;AACzC,MAAI5H,MAAM,GAAGqI,kBAAkB,CAACT,IAAD,CAA/B;;AACA,MAAIQ,QAAJ,EAAc;AACZ,WAAOE,IAAI,CAACtI,MAAD,CAAX;AACD;;AACD,SAAOA,MAAP;AACD;;AAED,SAASuI,wBAAT,CAAkCH,QAAlC,EAA4CR,IAA5C,EAAkD;AAChD,MAAIY,UAAU,GAAGL,iBAAiB,CAACC,QAAD,EAAWR,IAAX,CAAlC;AACA,MAAIa,MAAM,GAAG,IAAIC,WAAJ,CAAgBF,UAAU,CAAC1I,MAA3B,CAAb;AACA,MAAI6I,IAAI,GAAG,IAAIC,UAAJ,CAAeH,MAAf,CAAX;;AACA,OAAK,IAAII,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGL,UAAU,CAAC1I,MAA/B,EAAuC+I,CAAC,EAAxC,EAA4C;AAC1CF,IAAAA,IAAI,CAACE,CAAD,CAAJ,GAAUL,UAAU,CAACM,UAAX,CAAsBD,CAAtB,CAAV;AACD;;AACD,SAAOJ,MAAP;AACD;;AAED,SAASM,aAAT,CAAuBC,kBAAvB,EAA2C3J,YAA3C,EAAyD;AACvDA,EAAAA,YAAY,GAAGtB,YAAY,CAACsB,YAAD,EAAe,EAAf,CAA3B;AACA,MAAI4J,QAAQ,GAAGD,kBAAkB,CAAC,CAAD,CAAjC;AACA,MAAIZ,QAAQ,GAAG,CAAC,CAACY,kBAAkB,CAAC,CAAD,CAAnC;AACA,MAAIpB,IAAI,GAAGoB,kBAAkB,CAAC,CAAD,CAA7B;;AAEA,UAAQ3J,YAAR;AACE,SAAK,EAAL;AACA,SAAK,MAAL;AACE,aAAO8I,iBAAiB,CAACC,QAAD,EAAWR,IAAX,CAAxB;;AACF,SAAK,aAAL;AACE,aAAOW,wBAAwB,CAACH,QAAD,EAAWR,IAAX,CAA/B;;AACF,SAAK,MAAL;AACE,UAAIa,MAAM,GAAGF,wBAAwB,CAACH,QAAD,EAAWR,IAAX,CAArC;AACA,aAAO,IAAIsB,IAAJ,CAAS,CAACT,MAAD,CAAT,EAAmB;AACxBU,QAAAA,IAAI,EAAEF;AADkB,OAAnB,CAAP;;AAGF,SAAK,UAAL;AACE,UAAIG,MAAM,GAAG,IAAIC,SAAJ,EAAb;AACA,aAAOD,MAAM,CAACE,eAAP,CACLnB,iBAAiB,CAACC,QAAD,EAAWR,IAAX,CADZ,EAELqB,QAFK,CAAP;;AAIF,SAAK,MAAL;AACE,aAAOhC,IAAI,CAACC,KAAL,CAAWiB,iBAAiB,CAACC,QAAD,EAAWR,IAAX,CAA5B,CAAP;;AACF;AACE;AACA,YAAM,IAAI3J,cAAJ,CAAmB,6BAA6BoB,YAAhD,CAAN;AACF;AAtBF;AAwBD;AAED;;;;;;;;;;;;;;;;;;;;;;;;;;;AAyBAuC,QAAQ,CAACkC,SAAT,CAAmBsB,KAAnB,GAA2B,UAAUvD,OAAV,EAAmB;AAC5CA,EAAAA,OAAO,GAAGrB,YAAY,CAACqB,OAAD,EAAU,EAAV,CAAtB;AACAA,EAAAA,OAAO,CAACiG,MAAR,GAAiB,KAAjB;AAEA,SAAO,KAAKD,YAAL,CAAkBhG,OAAlB,CAAP;AACD,CALD;AAOA;;;;;;;;;;;;;;;;;;AAgBAD,QAAQ,CAACwD,KAAT,GAAiB,UAAUvD,OAAV,EAAmB;AAClC,MAAIpC,QAAQ,GAAG,IAAImC,QAAJ,CAAaC,OAAb,CAAf;AACA,SAAOpC,QAAQ,CAAC2F,KAAT,CAAe;AACpB;AACA/F,IAAAA,YAAY,EAAEwC,OAAO,CAACxC,YAFF;AAGpB+H,IAAAA,gBAAgB,EAAEvF,OAAO,CAACuF;AAHN,GAAf,CAAP;AAKD,CAPD;AASA;;;;;;;;;;;;;;;;;;;;;;;;;;AAwBAxF,QAAQ,CAACkC,SAAT,CAAmByF,MAAnB,GAA4B,UAAU1H,OAAV,EAAmB;AAC7CA,EAAAA,OAAO,GAAGrB,YAAY,CAACqB,OAAD,EAAU,EAAV,CAAtB;AACAA,EAAAA,OAAO,CAACiG,MAAR,GAAiB,QAAjB;AAEA,SAAO,KAAKD,YAAL,CAAkBhG,OAAlB,CAAP;AACD,CALD;AAOA;;;;;;;;;;;;;;;;;;;AAiBAD,QAAQ,CAAC2H,MAAT,GAAkB,UAAU1H,OAAV,EAAmB;AACnC,MAAIpC,QAAQ,GAAG,IAAImC,QAAJ,CAAaC,OAAb,CAAf;AACA,SAAOpC,QAAQ,CAAC8J,MAAT,CAAgB;AACrB;AACAlK,IAAAA,YAAY,EAAEwC,OAAO,CAACxC,YAFD;AAGrB+H,IAAAA,gBAAgB,EAAEvF,OAAO,CAACuF,gBAHL;AAIrBQ,IAAAA,IAAI,EAAE/F,OAAO,CAAC+F;AAJO,GAAhB,CAAP;AAMD,CARD;AAUA;;;;;;;;;;;;;;;;;;;;;;;;;;AAwBAhG,QAAQ,CAACkC,SAAT,CAAmB0F,IAAnB,GAA0B,UAAU3H,OAAV,EAAmB;AAC3CA,EAAAA,OAAO,GAAGrB,YAAY,CAACqB,OAAD,EAAU,EAAV,CAAtB;AACAA,EAAAA,OAAO,CAACiG,MAAR,GAAiB,MAAjB;AAEA,SAAO,KAAKD,YAAL,CAAkBhG,OAAlB,CAAP;AACD,CALD;AAOA;;;;;;;;;;;;;;;;;;AAgBAD,QAAQ,CAAC4H,IAAT,GAAgB,UAAU3H,OAAV,EAAmB;AACjC,MAAIpC,QAAQ,GAAG,IAAImC,QAAJ,CAAaC,OAAb,CAAf;AACA,SAAOpC,QAAQ,CAAC+J,IAAT,CAAc;AACnB;AACAnK,IAAAA,YAAY,EAAEwC,OAAO,CAACxC,YAFH;AAGnB+H,IAAAA,gBAAgB,EAAEvF,OAAO,CAACuF;AAHP,GAAd,CAAP;AAKD,CAPD;AASA;;;;;;;;;;;;;;;;;;;;;;;;;;AAwBAxF,QAAQ,CAACkC,SAAT,CAAmBjC,OAAnB,GAA6B,UAAUA,OAAV,EAAmB;AAC9CA,EAAAA,OAAO,GAAGrB,YAAY,CAACqB,OAAD,EAAU,EAAV,CAAtB;AACAA,EAAAA,OAAO,CAACiG,MAAR,GAAiB,SAAjB;AAEA,SAAO,KAAKD,YAAL,CAAkBhG,OAAlB,CAAP;AACD,CALD;AAOA;;;;;;;;;;;;;;;;;;AAgBAD,QAAQ,CAACC,OAAT,GAAmB,UAAUA,OAAV,EAAmB;AACpC,MAAIpC,QAAQ,GAAG,IAAImC,QAAJ,CAAaC,OAAb,CAAf;AACA,SAAOpC,QAAQ,CAACoC,OAAT,CAAiB;AACtB;AACAxC,IAAAA,YAAY,EAAEwC,OAAO,CAACxC,YAFA;AAGtB+H,IAAAA,gBAAgB,EAAEvF,OAAO,CAACuF;AAHJ,GAAjB,CAAP;AAKD,CAPD;AASA;;;;;;;;;;;;;;;;;;;;;;;;;;;;AA0BAxF,QAAQ,CAACkC,SAAT,CAAmB2F,IAAnB,GAA0B,UAAU7B,IAAV,EAAgB/F,OAAhB,EAAyB;AACjDjE,EAAAA,KAAK,CAACI,OAAN,CAAc,MAAd,EAAsB4J,IAAtB;AAEA/F,EAAAA,OAAO,GAAGrB,YAAY,CAACqB,OAAD,EAAU,EAAV,CAAtB;AACAA,EAAAA,OAAO,CAACiG,MAAR,GAAiB,MAAjB;AACAjG,EAAAA,OAAO,CAAC+F,IAAR,GAAeA,IAAf;AAEA,SAAO,KAAKC,YAAL,CAAkBhG,OAAlB,CAAP;AACD,CARD;AAUA;;;;;;;;;;;;;;;;;;;AAiBAD,QAAQ,CAAC6H,IAAT,GAAgB,UAAU5H,OAAV,EAAmB;AACjC,MAAIpC,QAAQ,GAAG,IAAImC,QAAJ,CAAaC,OAAb,CAAf;AACA,SAAOpC,QAAQ,CAACgK,IAAT,CAAc5H,OAAO,CAAC+F,IAAtB,EAA4B;AACjC;AACAvI,IAAAA,YAAY,EAAEwC,OAAO,CAACxC,YAFW;AAGjC+H,IAAAA,gBAAgB,EAAEvF,OAAO,CAACuF;AAHO,GAA5B,CAAP;AAKD,CAPD;AASA;;;;;;;;;;;;;;;;;;;;;;;;;;;AAyBAxF,QAAQ,CAACkC,SAAT,CAAmB4F,GAAnB,GAAyB,UAAU9B,IAAV,EAAgB/F,OAAhB,EAAyB;AAChDjE,EAAAA,KAAK,CAACI,OAAN,CAAc,MAAd,EAAsB4J,IAAtB;AAEA/F,EAAAA,OAAO,GAAGrB,YAAY,CAACqB,OAAD,EAAU,EAAV,CAAtB;AACAA,EAAAA,OAAO,CAACiG,MAAR,GAAiB,KAAjB;AACAjG,EAAAA,OAAO,CAAC+F,IAAR,GAAeA,IAAf;AAEA,SAAO,KAAKC,YAAL,CAAkBhG,OAAlB,CAAP;AACD,CARD;AAUA;;;;;;;;;;;;;;;;;;;AAiBAD,QAAQ,CAAC8H,GAAT,GAAe,UAAU7H,OAAV,EAAmB;AAChC,MAAIpC,QAAQ,GAAG,IAAImC,QAAJ,CAAaC,OAAb,CAAf;AACA,SAAOpC,QAAQ,CAACiK,GAAT,CAAa7H,OAAO,CAAC+F,IAArB,EAA2B;AAChC;AACAvI,IAAAA,YAAY,EAAEwC,OAAO,CAACxC,YAFU;AAGhC+H,IAAAA,gBAAgB,EAAEvF,OAAO,CAACuF;AAHM,GAA3B,CAAP;AAKD,CAPD;AASA;;;;;;;;;;;;;;;;;;;;;;;;;;;AAyBAxF,QAAQ,CAACkC,SAAT,CAAmB6F,KAAnB,GAA2B,UAAU/B,IAAV,EAAgB/F,OAAhB,EAAyB;AAClDjE,EAAAA,KAAK,CAACI,OAAN,CAAc,MAAd,EAAsB4J,IAAtB;AAEA/F,EAAAA,OAAO,GAAGrB,YAAY,CAACqB,OAAD,EAAU,EAAV,CAAtB;AACAA,EAAAA,OAAO,CAACiG,MAAR,GAAiB,OAAjB;AACAjG,EAAAA,OAAO,CAAC+F,IAAR,GAAeA,IAAf;AAEA,SAAO,KAAKC,YAAL,CAAkBhG,OAAlB,CAAP;AACD,CARD;AAUA;;;;;;;;;;;;;;;;;;;AAiBAD,QAAQ,CAAC+H,KAAT,GAAiB,UAAU9H,OAAV,EAAmB;AAClC,MAAIpC,QAAQ,GAAG,IAAImC,QAAJ,CAAaC,OAAb,CAAf;AACA,SAAOpC,QAAQ,CAACkK,KAAT,CAAe9H,OAAO,CAAC+F,IAAvB,EAA6B;AAClC;AACAvI,IAAAA,YAAY,EAAEwC,OAAO,CAACxC,YAFY;AAGlC+H,IAAAA,gBAAgB,EAAEvF,OAAO,CAACuF;AAHQ,GAA7B,CAAP;AAKD,CAPD;AASA;;;;;;;AAKAxF,QAAQ,CAAC6E,gBAAT,GAA4B,EAA5B;;AAEA,SAASmD,gBAAT,CAA0B7H,GAA1B,EAA+BwE,WAA/B,EAA4CtF,QAA5C,EAAsD;AACpD,MAAIkF,KAAK,GAAG,IAAI0D,KAAJ,EAAZ;;AAEA1D,EAAAA,KAAK,CAAC2D,MAAN,GAAe,YAAY;AACzB7I,IAAAA,QAAQ,CAACiC,OAAT,CAAiBiD,KAAjB;AACD,GAFD;;AAIAA,EAAAA,KAAK,CAAC4D,OAAN,GAAgB,UAAUzK,CAAV,EAAa;AAC3B2B,IAAAA,QAAQ,CAACoF,MAAT,CAAgB/G,CAAhB;AACD,GAFD;;AAIA,MAAIiH,WAAJ,EAAiB;AACf,QAAIvH,cAAc,CAACgL,QAAf,CAAwBjI,GAAxB,CAAJ,EAAkC;AAChCoE,MAAAA,KAAK,CAACI,WAAN,GAAoB,iBAApB;AACD,KAFD,MAEO;AACLJ,MAAAA,KAAK,CAACI,WAAN,GAAoB,EAApB;AACD;AACF;;AAEDJ,EAAAA,KAAK,CAAC8D,GAAN,GAAYlI,GAAZ;AACD;;AAEDH,QAAQ,CAAC6E,gBAAT,CAA0BC,WAA1B,GAAwC,UACtC9F,OADsC,EAEtC2F,WAFsC,EAGtCtF,QAHsC,EAItCuE,KAJsC,EAKtCF,iBALsC,EAMtC;AACA,MAAIvD,GAAG,GAAGnB,OAAO,CAACmB,GAAlB,CADA,CAEA;AACA;AACA;AACA;AACA;;AACAH,EAAAA,QAAQ,CAACoB,0BAAT,GACGK,IADH,CACQ,UAAUqC,mBAAV,EAA+B;AACnC;AACA;AACA,QAAI,EAAEA,mBAAmB,IAAIJ,iBAAzB,CAAJ,EAAiD;AAC/CsE,MAAAA,gBAAgB,CAAC7H,GAAD,EAAMwE,WAAN,EAAmBtF,QAAnB,CAAhB;AACA;AACD;;AACD,QAAI5B,YAAY,GAAG,MAAnB;AACA,QAAIyI,MAAM,GAAG,KAAb;AACA,QAAIoC,WAAW,GAAGxM,IAAI,CAAC8I,KAAL,EAAlB;;AACA,QAAItH,GAAG,GAAG0C,QAAQ,CAAC6E,gBAAT,CAA0BsB,WAA1B,CACRhG,GADQ,EAER1C,YAFQ,EAGRyI,MAHQ,EAIR7H,SAJQ,EAKRA,SALQ,EAMRiK,WANQ,EAORjK,SAPQ,EAQRA,SARQ,EASRA,SATQ,CAAV;;AAYA,QAAIjC,OAAO,CAACkB,GAAD,CAAP,IAAgBlB,OAAO,CAACkB,GAAG,CAAC8I,KAAL,CAA3B,EAAwC;AACtCpH,MAAAA,OAAO,CAACqH,cAAR,GAAyB,YAAY;AACnC/I,QAAAA,GAAG,CAAC8I,KAAJ;AACD,OAFD;AAGD;;AACD,WAAOkC,WAAW,CAACvD,OAAZ,CACJtD,IADI,CACC,UAAUC,IAAV,EAAgB;AACpB,UAAI,CAACtF,OAAO,CAACsF,IAAD,CAAZ,EAAoB;AAClBrC,QAAAA,QAAQ,CAACoF,MAAT,CACE,IAAItH,YAAJ,CACE,4BACEgD,GADF,GAEE,+BAHJ,CADF;AAOA;AACD;;AAED,aAAOH,QAAQ,CAACkE,yBAAT,CAAmCxC,IAAnC,EAAyC;AAC9CkC,QAAAA,KAAK,EAAEA,KADuC;AAE9ChC,QAAAA,gBAAgB,EAAE;AAF4B,OAAzC,CAAP;AAID,KAjBI,EAkBJH,IAlBI,CAkBCpC,QAAQ,CAACiC,OAlBV,CAAP;AAmBD,GA/CH,EAgDGQ,SAhDH,CAgDazC,QAAQ,CAACoF,MAhDtB;AAiDD,CA9DD;AAgEA;;;;;;;AAKAzE,QAAQ,CAACkE,yBAAT,GAAqC,UAAUxC,IAAV,EAAgBzB,OAAhB,EAAyB;AAC5DjE,EAAAA,KAAK,CAACI,OAAN,CAAc,SAAd,EAAyB6D,OAAzB;AACAjE,EAAAA,KAAK,CAACoE,MAAN,CAAamI,IAAb,CAAkB,eAAlB,EAAmCtI,OAAO,CAAC2D,KAA3C;AACA5H,EAAAA,KAAK,CAACoE,MAAN,CAAamI,IAAb,CAAkB,0BAAlB,EAA8CtI,OAAO,CAAC2B,gBAAtD;AAEA,SAAOP,iBAAiB,CAACK,IAAD,EAAO;AAC7BC,IAAAA,gBAAgB,EAAE1B,OAAO,CAAC2D,KAAR,GAAgB,OAAhB,GAA0B,MADf;AAE7BhC,IAAAA,gBAAgB,EAAE3B,OAAO,CAAC2B,gBAAR,GAA2B,aAA3B,GAA2C;AAFhC,GAAP,CAAxB;AAID,CATD;;AAWA,SAAS4G,cAAT,CAAwBC,oBAAxB,EAA8ChL,YAA9C,EAA4D;AAC1D,UAAQA,YAAR;AACE,SAAK,MAAL;AACE,aAAOgL,oBAAoB,CAACzH,QAArB,CAA8B,MAA9B,CAAP;;AACF,SAAK,MAAL;AACE,aAAOqE,IAAI,CAACC,KAAL,CAAWmD,oBAAoB,CAACzH,QAArB,CAA8B,MAA9B,CAAX,CAAP;;AACF;AACE,aAAO,IAAIgG,UAAJ,CAAeyB,oBAAf,EAAqC5B,MAA5C;AANJ;AAQD;;AAED,SAAS6B,mBAAT,CACEvI,GADF,EAEE1C,YAFF,EAGEyI,MAHF,EAIEF,IAJF,EAKEtF,OALF,EAMErB,QANF,EAOEmG,gBAPF,EAQE;AACA;;AACA;AACA,MAAInB,GAAG,GAAGsE,OAAO,CAAC,KAAD,CAAP,CAAerD,KAAf,CAAqBnF,GAArB,CAAV;;AACA,MAAIyI,IAAI,GAAGvE,GAAG,CAACwE,QAAJ,KAAiB,QAAjB,GAA4BF,OAAO,CAAC,OAAD,CAAnC,GAA+CA,OAAO,CAAC,MAAD,CAAjE;;AACA,MAAIG,IAAI,GAAGH,OAAO,CAAC,MAAD,CAAlB;AACA;;;AAEA,MAAI1I,OAAO,GAAG;AACZ4I,IAAAA,QAAQ,EAAExE,GAAG,CAACwE,QADF;AAEZE,IAAAA,QAAQ,EAAE1E,GAAG,CAAC0E,QAFF;AAGZC,IAAAA,IAAI,EAAE3E,GAAG,CAAC2E,IAHE;AAIZC,IAAAA,IAAI,EAAE5E,GAAG,CAAC4E,IAJE;AAKZhL,IAAAA,KAAK,EAAEoG,GAAG,CAACpG,KALC;AAMZiI,IAAAA,MAAM,EAAEA,MANI;AAOZxF,IAAAA,OAAO,EAAEA;AAPG,GAAd;AAUAkI,EAAAA,IAAI,CACD5J,OADH,CACWiB,OADX,EAEGiJ,EAFH,CAEM,UAFN,EAEkB,UAAUC,GAAV,EAAe;AAC7B,QAAIA,GAAG,CAACC,UAAJ,GAAiB,GAAjB,IAAwBD,GAAG,CAACC,UAAJ,IAAkB,GAA9C,EAAmD;AACjD/J,MAAAA,QAAQ,CAACoF,MAAT,CACE,IAAIzH,iBAAJ,CAAsBmM,GAAG,CAACC,UAA1B,EAAsCD,GAAtC,EAA2CA,GAAG,CAACzI,OAA/C,CADF;AAGA;AACD;;AAED,QAAI2I,UAAU,GAAG,EAAjB;AACAF,IAAAA,GAAG,CAACD,EAAJ,CAAO,MAAP,EAAe,UAAUI,KAAV,EAAiB;AAC9BD,MAAAA,UAAU,CAACE,IAAX,CAAgBD,KAAhB;AACD,KAFD;AAIAH,IAAAA,GAAG,CAACD,EAAJ,CAAO,KAAP,EAAc,YAAY;AACxB;AACA,UAAI9K,MAAM,GAAGoL,MAAM,CAAC1J,MAAP,CAAcuJ,UAAd,CAAb;;AACA,UAAIF,GAAG,CAACzI,OAAJ,CAAY,kBAAZ,MAAoC,MAAxC,EAAgD;AAC9CoI,QAAAA,IAAI,CAACW,MAAL,CAAYrL,MAAZ,EAAoB,UAAUgF,KAAV,EAAiBsG,cAAjB,EAAiC;AACnD,cAAItG,KAAJ,EAAW;AACT/D,YAAAA,QAAQ,CAACoF,MAAT,CACE,IAAItH,YAAJ,CAAiB,+BAAjB,CADF;AAGD,WAJD,MAIO;AACLkC,YAAAA,QAAQ,CAACiC,OAAT,CAAiBkH,cAAc,CAACkB,cAAD,EAAiBjM,YAAjB,CAA/B;AACD;AACF,SARD;AASD,OAVD,MAUO;AACL4B,QAAAA,QAAQ,CAACiC,OAAT,CAAiBkH,cAAc,CAACpK,MAAD,EAASX,YAAT,CAA/B;AACD;AACF,KAhBD;AAiBD,GAhCH,EAiCGyL,EAjCH,CAiCM,OAjCN,EAiCe,UAAUxL,CAAV,EAAa;AACxB2B,IAAAA,QAAQ,CAACoF,MAAT,CAAgB,IAAIzH,iBAAJ,EAAhB;AACD,GAnCH,EAoCG2M,GApCH;AAqCD;;AAED,IAAIC,gBAAgB,GAAG,OAAOrM,cAAP,KAA0B,WAAjD;;AACAyC,QAAQ,CAAC6E,gBAAT,CAA0BsB,WAA1B,GAAwC,UACtChG,GADsC,EAEtC1C,YAFsC,EAGtCyI,MAHsC,EAItCF,IAJsC,EAKtCtF,OALsC,EAMtCrB,QANsC,EAOtCmG,gBAPsC,EAQtC;AACA,MAAI4B,kBAAkB,GAAGd,YAAY,CAACuD,IAAb,CAAkB1J,GAAlB,CAAzB;;AACA,MAAIiH,kBAAkB,KAAK,IAA3B,EAAiC;AAC/B/H,IAAAA,QAAQ,CAACiC,OAAT,CAAiB6F,aAAa,CAACC,kBAAD,EAAqB3J,YAArB,CAA9B;AACA;AACD;;AAED,MAAImM,gBAAJ,EAAsB;AACpBlB,IAAAA,mBAAmB,CACjBvI,GADiB,EAEjB1C,YAFiB,EAGjByI,MAHiB,EAIjBF,IAJiB,EAKjBtF,OALiB,EAMjBrB,QANiB,EAOjBmG,gBAPiB,CAAnB;AASA;AACD;;AAED,MAAIlI,GAAG,GAAG,IAAIC,cAAJ,EAAV;;AAEA,MAAIH,cAAc,CAACgL,QAAf,CAAwBjI,GAAxB,CAAJ,EAAkC;AAChC7C,IAAAA,GAAG,CAACwM,eAAJ,GAAsB,IAAtB;AACD;;AAEDxM,EAAAA,GAAG,CAACE,IAAJ,CAAS0I,MAAT,EAAiB/F,GAAjB,EAAsB,IAAtB;;AAEA,MAAI/D,OAAO,CAACoJ,gBAAD,CAAP,IAA6BpJ,OAAO,CAACkB,GAAG,CAACkI,gBAAL,CAAxC,EAAgE;AAC9DlI,IAAAA,GAAG,CAACkI,gBAAJ,CAAqBA,gBAArB;AACD;;AAED,MAAIpJ,OAAO,CAACsE,OAAD,CAAX,EAAsB;AACpB,SAAK,IAAI+B,GAAT,IAAgB/B,OAAhB,EAAyB;AACvB,UAAIA,OAAO,CAACjB,cAAR,CAAuBgD,GAAvB,CAAJ,EAAiC;AAC/BnF,QAAAA,GAAG,CAACyM,gBAAJ,CAAqBtH,GAArB,EAA0B/B,OAAO,CAAC+B,GAAD,CAAjC;AACD;AACF;AACF;;AAED,MAAIrG,OAAO,CAACqB,YAAD,CAAX,EAA2B;AACzBH,IAAAA,GAAG,CAACG,YAAJ,GAAmBA,YAAnB;AACD,GA1CD,CA4CA;;;AACA,MAAIuM,SAAS,GAAG,KAAhB;;AACA,MAAI,OAAO7J,GAAP,KAAe,QAAnB,EAA6B;AAC3B6J,IAAAA,SAAS,GACP7J,GAAG,CAAChC,OAAJ,CAAY,SAAZ,MAA2B,CAA3B,IACC,OAAOiG,MAAP,KAAkB,WAAlB,IAAiCA,MAAM,CAAC6F,QAAP,CAAgBC,MAAhB,KAA2B,SAF/D;AAGD;;AAED5M,EAAAA,GAAG,CAAC4K,MAAJ,GAAa,YAAY;AACvB,QACE,CAAC5K,GAAG,CAAC6M,MAAJ,GAAa,GAAb,IAAoB7M,GAAG,CAAC6M,MAAJ,IAAc,GAAnC,KACA,EAAEH,SAAS,IAAI1M,GAAG,CAAC6M,MAAJ,KAAe,CAA9B,CAFF,EAGE;AACA9K,MAAAA,QAAQ,CAACoF,MAAT,CACE,IAAIzH,iBAAJ,CACEM,GAAG,CAAC6M,MADN,EAEE7M,GAAG,CAAC8M,QAFN,EAGE9M,GAAG,CAAC+M,qBAAJ,EAHF,CADF;AAOA;AACD;;AAED,QAAID,QAAQ,GAAG9M,GAAG,CAAC8M,QAAnB;AACA,QAAIE,mBAAmB,GAAGhN,GAAG,CAACG,YAA9B;;AAEA,QAAIyI,MAAM,KAAK,MAAX,IAAqBA,MAAM,KAAK,SAApC,EAA+C;AAC7C,UAAIqE,oBAAoB,GAAGjN,GAAG,CAAC+M,qBAAJ,EAA3B;AACA,UAAIG,YAAY,GAAGD,oBAAoB,CAACE,IAArB,GAA4BC,KAA5B,CAAkC,SAAlC,CAAnB;AAEA,UAAIC,eAAe,GAAG,EAAtB;AACAH,MAAAA,YAAY,CAACI,OAAb,CAAqB,UAAUC,IAAV,EAAgB;AACnC,YAAIC,KAAK,GAAGD,IAAI,CAACH,KAAL,CAAW,IAAX,CAAZ;AACA,YAAIK,MAAM,GAAGD,KAAK,CAACE,KAAN,EAAb;AACAL,QAAAA,eAAe,CAACI,MAAD,CAAf,GAA0BD,KAAK,CAACG,IAAN,CAAW,IAAX,CAA1B;AACD,OAJD;AAMA5L,MAAAA,QAAQ,CAACiC,OAAT,CAAiBqJ,eAAjB;AACA;AACD,KA/BsB,CAiCvB;AACA;AACA;;;AACA,QAAIrN,GAAG,CAAC6M,MAAJ,KAAe,GAAnB,EAAwB;AACtB;AACA9K,MAAAA,QAAQ,CAACiC,OAAT;AACD,KAHD,MAGO,IACLlF,OAAO,CAACgO,QAAD,CAAP,KACC,CAAChO,OAAO,CAACqB,YAAD,CAAR,IAA0B6M,mBAAmB,KAAK7M,YADnD,CADK,EAGL;AACA4B,MAAAA,QAAQ,CAACiC,OAAT,CAAiB8I,QAAjB;AACD,KALM,MAKA,IAAI3M,YAAY,KAAK,MAAjB,IAA2B,OAAO2M,QAAP,KAAoB,QAAnD,EAA6D;AAClE,UAAI;AACF/K,QAAAA,QAAQ,CAACiC,OAAT,CAAiB+D,IAAI,CAACC,KAAL,CAAW8E,QAAX,CAAjB;AACD,OAFD,CAEE,OAAO1M,CAAP,EAAU;AACV2B,QAAAA,QAAQ,CAACoF,MAAT,CAAgB/G,CAAhB;AACD;AACF,KANM,MAMA,IACL,CAAC4M,mBAAmB,KAAK,EAAxB,IAA8BA,mBAAmB,KAAK,UAAvD,KACAlO,OAAO,CAACkB,GAAG,CAAC4N,WAAL,CADP,IAEA5N,GAAG,CAAC4N,WAAJ,CAAgBC,aAAhB,EAHK,EAIL;AACA9L,MAAAA,QAAQ,CAACiC,OAAT,CAAiBhE,GAAG,CAAC4N,WAArB;AACD,KANM,MAMA,IACL,CAACZ,mBAAmB,KAAK,EAAxB,IAA8BA,mBAAmB,KAAK,MAAvD,KACAlO,OAAO,CAACkB,GAAG,CAAC8N,YAAL,CAFF,EAGL;AACA/L,MAAAA,QAAQ,CAACiC,OAAT,CAAiBhE,GAAG,CAAC8N,YAArB;AACD,KALM,MAKA;AACL/L,MAAAA,QAAQ,CAACoF,MAAT,CACE,IAAItH,YAAJ,CAAiB,uCAAjB,CADF;AAGD;AACF,GAlED;;AAoEAG,EAAAA,GAAG,CAAC6K,OAAJ,GAAc,UAAUzK,CAAV,EAAa;AACzB2B,IAAAA,QAAQ,CAACoF,MAAT,CAAgB,IAAIzH,iBAAJ,EAAhB;AACD,GAFD;;AAIAM,EAAAA,GAAG,CAAC+N,IAAJ,CAASrF,IAAT;AAEA,SAAO1I,GAAP;AACD,CAvID;;AAyIA0C,QAAQ,CAAC6E,gBAAT,CAA0BjI,oBAA1B,GAAiD,UAC/CuD,GAD+C,EAE/CwF,YAF+C,EAG/CtG,QAH+C,EAI/C;AACA,SAAOzC,oBAAoB,CAACuD,GAAD,EAAMwF,YAAN,CAApB,CAAwC7D,SAAxC,CAAkDzC,QAAQ,CAACoF,MAA3D,CAAP;AACD,CAND;AAQA;;;;;;;AAKAzE,QAAQ,CAACsL,uBAAT,GAAmC,EAAnC;AACAtL,QAAQ,CAACsL,uBAAT,CAAiCxG,WAAjC,GACE9E,QAAQ,CAAC6E,gBAAT,CAA0BC,WAD5B;AAEA9E,QAAQ,CAACsL,uBAAT,CAAiCnF,WAAjC,GACEnG,QAAQ,CAAC6E,gBAAT,CAA0BsB,WAD5B;AAEAnG,QAAQ,CAACsL,uBAAT,CAAiC1O,oBAAjC,GACEoD,QAAQ,CAAC6E,gBAAT,CAA0BjI,oBAD5B;AAGA;;;;;;;AAMAoD,QAAQ,CAACuL,OAAT,GAAmB5M,MAAM,CAAC6M,MAAP,CACjB,IAAIxL,QAAJ,CAAa;AACXG,EAAAA,GAAG,EACD,OAAOsL,QAAP,KAAoB,WAApB,GACI,EADJ,GAEIA,QAAQ,CAACxB,QAAT,CAAkByB,IAAlB,CAAuBhB,KAAvB,CAA6B,GAA7B,EAAkC,CAAlC;AAJK,CAAb,CADiB,CAAnB;AASA;;;;;;;;;AAQA,eAAe1K,QAAf","sourcesContent":["import Uri from \"../ThirdParty/Uri.js\";\nimport when from \"../ThirdParty/when.js\";\nimport appendForwardSlash from \"./appendForwardSlash.js\";\nimport Check from \"./Check.js\";\nimport clone from \"./clone.js\";\nimport combine from \"./combine.js\";\nimport defaultValue from \"./defaultValue.js\";\nimport defined from \"./defined.js\";\nimport DeveloperError from \"./DeveloperError.js\";\nimport getAbsoluteUri from \"./getAbsoluteUri.js\";\nimport getBaseUri from \"./getBaseUri.js\";\nimport getExtensionFromUri from \"./getExtensionFromUri.js\";\nimport isBlobUri from \"./isBlobUri.js\";\nimport isCrossOriginUrl from \"./isCrossOriginUrl.js\";\nimport isDataUri from \"./isDataUri.js\";\nimport loadAndExecuteScript from \"./loadAndExecuteScript.js\";\nimport objectToQuery from \"./objectToQuery.js\";\nimport queryToObject from \"./queryToObject.js\";\nimport Request from \"./Request.js\";\nimport RequestErrorEvent from \"./RequestErrorEvent.js\";\nimport RequestScheduler from \"./RequestScheduler.js\";\nimport RequestState from \"./RequestState.js\";\nimport RuntimeError from \"./RuntimeError.js\";\nimport TrustedServers from \"./TrustedServers.js\";\n\nvar xhrBlobSupported = (function () {\n  try {\n    var xhr = new XMLHttpRequest();\n    xhr.open(\"GET\", \"#\", true);\n    xhr.responseType = \"blob\";\n    return xhr.responseType === \"blob\";\n  } catch (e) {\n    return false;\n  }\n})();\n\n/**\n * Parses a query string and returns the object equivalent.\n *\n * @param {Uri} uri The Uri with a query object.\n * @param {Resource} resource The Resource that will be assigned queryParameters.\n * @param {Boolean} merge If true, we'll merge with the resource's existing queryParameters. Otherwise they will be replaced.\n * @param {Boolean} preserveQueryParameters If true duplicate parameters will be concatenated into an array. If false, keys in uri will take precedence.\n *\n * @private\n */\nfunction parseQuery(uri, resource, merge, preserveQueryParameters) {\n  var queryString = uri.query;\n  if (!defined(queryString) || queryString.length === 0) {\n    return {};\n  }\n\n  var query;\n  // Special case we run into where the querystring is just a string, not key/value pairs\n  if (queryString.indexOf(\"=\") === -1) {\n    var result = {};\n    result[queryString] = undefined;\n    query = result;\n  } else {\n    query = queryToObject(queryString);\n  }\n\n  if (merge) {\n    resource._queryParameters = combineQueryParameters(\n      query,\n      resource._queryParameters,\n      preserveQueryParameters\n    );\n  } else {\n    resource._queryParameters = query;\n  }\n  uri.query = undefined;\n}\n\n/**\n * Converts a query object into a string.\n *\n * @param {Uri} uri The Uri object that will have the query object set.\n * @param {Resource} resource The resource that has queryParameters\n *\n * @private\n */\nfunction stringifyQuery(uri, resource) {\n  var queryObject = resource._queryParameters;\n\n  var keys = Object.keys(queryObject);\n\n  // We have 1 key with an undefined value, so this is just a string, not key/value pairs\n  if (keys.length === 1 && !defined(queryObject[keys[0]])) {\n    uri.query = keys[0];\n  } else {\n    uri.query = objectToQuery(queryObject);\n  }\n}\n\n/**\n * Clones a value if it is defined, otherwise returns the default value\n *\n * @param {*} [val] The value to clone.\n * @param {*} [defaultVal] The default value.\n *\n * @returns {*} A clone of val or the defaultVal.\n *\n * @private\n */\nfunction defaultClone(val, defaultVal) {\n  if (!defined(val)) {\n    return defaultVal;\n  }\n\n  return defined(val.clone) ? val.clone() : clone(val);\n}\n\n/**\n * Checks to make sure the Resource isn't already being requested.\n *\n * @param {Request} request The request to check.\n *\n * @private\n */\nfunction checkAndResetRequest(request) {\n  if (\n    request.state === RequestState.ISSUED ||\n    request.state === RequestState.ACTIVE\n  ) {\n    throw new RuntimeError(\"The Resource is already being fetched.\");\n  }\n\n  request.state = RequestState.UNISSUED;\n  request.deferred = undefined;\n}\n\n/**\n * This combines a map of query parameters.\n *\n * @param {Object} q1 The first map of query parameters. Values in this map will take precedence if preserveQueryParameters is false.\n * @param {Object} q2 The second map of query parameters.\n * @param {Boolean} preserveQueryParameters If true duplicate parameters will be concatenated into an array. If false, keys in q1 will take precedence.\n *\n * @returns {Object} The combined map of query parameters.\n *\n * @example\n * var q1 = {\n *   a: 1,\n *   b: 2\n * };\n * var q2 = {\n *   a: 3,\n *   c: 4\n * };\n * var q3 = {\n *   b: [5, 6],\n *   d: 7\n * }\n *\n * // Returns\n * // {\n * //   a: [1, 3],\n * //   b: 2,\n * //   c: 4\n * // };\n * combineQueryParameters(q1, q2, true);\n *\n * // Returns\n * // {\n * //   a: 1,\n * //   b: 2,\n * //   c: 4\n * // };\n * combineQueryParameters(q1, q2, false);\n *\n * // Returns\n * // {\n * //   a: 1,\n * //   b: [2, 5, 6],\n * //   d: 7\n * // };\n * combineQueryParameters(q1, q3, true);\n *\n * // Returns\n * // {\n * //   a: 1,\n * //   b: 2,\n * //   d: 7\n * // };\n * combineQueryParameters(q1, q3, false);\n *\n * @private\n */\nfunction combineQueryParameters(q1, q2, preserveQueryParameters) {\n  if (!preserveQueryParameters) {\n    return combine(q1, q2);\n  }\n\n  var result = clone(q1, true);\n  for (var param in q2) {\n    if (q2.hasOwnProperty(param)) {\n      var value = result[param];\n      var q2Value = q2[param];\n      if (defined(value)) {\n        if (!Array.isArray(value)) {\n          value = result[param] = [value];\n        }\n\n        result[param] = value.concat(q2Value);\n      } else {\n        result[param] = Array.isArray(q2Value) ? q2Value.slice() : q2Value;\n      }\n    }\n  }\n\n  return result;\n}\n\n/**\n * A resource that includes the location and any other parameters we need to retrieve it or create derived resources. It also provides the ability to retry requests.\n *\n * @alias Resource\n * @constructor\n *\n * @param {String|Object} options A url or an object with the following properties\n * @param {String} options.url The url of the resource.\n * @param {Object} [options.queryParameters] An object containing query parameters that will be sent when retrieving the resource.\n * @param {Object} [options.templateValues] Key/Value pairs that are used to replace template values (eg. {x}).\n * @param {Object} [options.headers={}] Additional HTTP headers that will be sent.\n * @param {DefaultProxy} [options.proxy] A proxy to be used when loading the resource.\n * @param {Resource~RetryCallback} [options.retryCallback] The Function to call when a request for this resource fails. If it returns true, the request will be retried.\n * @param {Number} [options.retryAttempts=0] The number of times the retryCallback should be called before giving up.\n * @param {Request} [options.request] A Request object that will be used. Intended for internal use only.\n *\n * @example\n * function refreshTokenRetryCallback(resource, error) {\n *   if (error.statusCode === 403) {\n *     // 403 status code means a new token should be generated\n *     return getNewAccessToken()\n *       .then(function(token) {\n *         resource.queryParameters.access_token = token;\n *         return true;\n *       })\n *       .otherwise(function() {\n *         return false;\n *       });\n *   }\n *\n *   return false;\n * }\n *\n * var resource = new Resource({\n *    url: 'http://server.com/path/to/resource.json',\n *    proxy: new DefaultProxy('/proxy/'),\n *    headers: {\n *      'X-My-Header': 'valueOfHeader'\n *    },\n *    queryParameters: {\n *      'access_token': '123-435-456-000'\n *    },\n *    retryCallback: refreshTokenRetryCallback,\n *    retryAttempts: 1\n * });\n */\nfunction Resource(options) {\n  options = defaultValue(options, defaultValue.EMPTY_OBJECT);\n  if (typeof options === \"string\") {\n    options = {\n      url: options,\n    };\n  }\n\n  //>>includeStart('debug', pragmas.debug);\n  Check.typeOf.string(\"options.url\", options.url);\n  //>>includeEnd('debug');\n\n  this._url = undefined;\n  this._templateValues = defaultClone(options.templateValues, {});\n  this._queryParameters = defaultClone(options.queryParameters, {});\n\n  /**\n   * Additional HTTP headers that will be sent with the request.\n   *\n   * @type {Object}\n   */\n  this.headers = defaultClone(options.headers, {});\n\n  /**\n   * A Request object that will be used. Intended for internal use only.\n   *\n   * @type {Request}\n   */\n  this.request = defaultValue(options.request, new Request());\n\n  /**\n   * A proxy to be used when loading the resource.\n   *\n   * @type {DefaultProxy}\n   */\n  this.proxy = options.proxy;\n\n  /**\n   * Function to call when a request for this resource fails. If it returns true or a Promise that resolves to true, the request will be retried.\n   *\n   * @type {Function}\n   */\n  this.retryCallback = options.retryCallback;\n\n  /**\n   * The number of times the retryCallback should be called before giving up.\n   *\n   * @type {Number}\n   */\n  this.retryAttempts = defaultValue(options.retryAttempts, 0);\n  this._retryCount = 0;\n\n  var uri = new Uri(options.url);\n  parseQuery(uri, this, true, true);\n\n  // Remove the fragment as it's not sent with a request\n  uri.fragment = undefined;\n\n  this._url = uri.toString();\n}\n\n/**\n * A helper function to create a resource depending on whether we have a String or a Resource\n *\n * @param {Resource|String} resource A Resource or a String to use when creating a new Resource.\n *\n * @returns {Resource} If resource is a String, a Resource constructed with the url and options. Otherwise the resource parameter is returned.\n *\n * @private\n */\nResource.createIfNeeded = function (resource) {\n  if (resource instanceof Resource) {\n    // Keep existing request object. This function is used internally to duplicate a Resource, so that it can't\n    //  be modified outside of a class that holds it (eg. an imagery or terrain provider). Since the Request objects\n    //  are managed outside of the providers, by the tile loading code, we want to keep the request property the same so if it is changed\n    //  in the underlying tiling code the requests for this resource will use it.\n    return resource.getDerivedResource({\n      request: resource.request,\n    });\n  }\n\n  if (typeof resource !== \"string\") {\n    return resource;\n  }\n\n  return new Resource({\n    url: resource,\n  });\n};\n\nvar supportsImageBitmapOptionsPromise;\n/**\n * A helper function to check whether createImageBitmap supports passing ImageBitmapOptions.\n *\n * @returns {Promise<Boolean>} A promise that resolves to true if this browser supports creating an ImageBitmap with options.\n *\n * @private\n */\nResource.supportsImageBitmapOptions = function () {\n  // Until the HTML folks figure out what to do about this, we need to actually try loading an image to\n  // know if this browser supports passing options to the createImageBitmap function.\n  // https://github.com/whatwg/html/pull/4248\n  if (defined(supportsImageBitmapOptionsPromise)) {\n    return supportsImageBitmapOptionsPromise;\n  }\n\n  if (typeof createImageBitmap !== \"function\") {\n    supportsImageBitmapOptionsPromise = when.resolve(false);\n    return supportsImageBitmapOptionsPromise;\n  }\n\n  var imageDataUri =\n    \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWP4////fwAJ+wP9CNHoHgAAAABJRU5ErkJggg==\";\n\n  supportsImageBitmapOptionsPromise = Resource.fetchBlob({\n    url: imageDataUri,\n  })\n    .then(function (blob) {\n      return createImageBitmap(blob, {\n        imageOrientation: \"flipY\",\n        premultiplyAlpha: \"none\",\n      });\n    })\n    .then(function (imageBitmap) {\n      return true;\n    })\n    .otherwise(function () {\n      return false;\n    });\n\n  return supportsImageBitmapOptionsPromise;\n};\n\nObject.defineProperties(Resource, {\n  /**\n   * Returns true if blobs are supported.\n   *\n   * @memberof Resource\n   * @type {Boolean}\n   *\n   * @readonly\n   */\n  isBlobSupported: {\n    get: function () {\n      return xhrBlobSupported;\n    },\n  },\n});\n\nObject.defineProperties(Resource.prototype, {\n  /**\n   * Query parameters appended to the url.\n   *\n   * @memberof Resource.prototype\n   * @type {Object}\n   *\n   * @readonly\n   */\n  queryParameters: {\n    get: function () {\n      return this._queryParameters;\n    },\n  },\n\n  /**\n   * The key/value pairs used to replace template parameters in the url.\n   *\n   * @memberof Resource.prototype\n   * @type {Object}\n   *\n   * @readonly\n   */\n  templateValues: {\n    get: function () {\n      return this._templateValues;\n    },\n  },\n\n  /**\n   * The url to the resource with template values replaced, query string appended and encoded by proxy if one was set.\n   *\n   * @memberof Resource.prototype\n   * @type {String}\n   */\n  url: {\n    get: function () {\n      return this.getUrlComponent(true, true);\n    },\n    set: function (value) {\n      var uri = new Uri(value);\n\n      parseQuery(uri, this, false);\n\n      // Remove the fragment as it's not sent with a request\n      uri.fragment = undefined;\n\n      this._url = uri.toString();\n    },\n  },\n\n  /**\n   * The file extension of the resource.\n   *\n   * @memberof Resource.prototype\n   * @type {String}\n   *\n   * @readonly\n   */\n  extension: {\n    get: function () {\n      return getExtensionFromUri(this._url);\n    },\n  },\n\n  /**\n   * True if the Resource refers to a data URI.\n   *\n   * @memberof Resource.prototype\n   * @type {Boolean}\n   */\n  isDataUri: {\n    get: function () {\n      return isDataUri(this._url);\n    },\n  },\n\n  /**\n   * True if the Resource refers to a blob URI.\n   *\n   * @memberof Resource.prototype\n   * @type {Boolean}\n   */\n  isBlobUri: {\n    get: function () {\n      return isBlobUri(this._url);\n    },\n  },\n\n  /**\n   * True if the Resource refers to a cross origin URL.\n   *\n   * @memberof Resource.prototype\n   * @type {Boolean}\n   */\n  isCrossOriginUrl: {\n    get: function () {\n      return isCrossOriginUrl(this._url);\n    },\n  },\n\n  /**\n   * True if the Resource has request headers. This is equivalent to checking if the headers property has any keys.\n   *\n   * @memberof Resource.prototype\n   * @type {Boolean}\n   */\n  hasHeaders: {\n    get: function () {\n      return Object.keys(this.headers).length > 0;\n    },\n  },\n});\n\n/**\n * Returns the url, optional with the query string and processed by a proxy.\n *\n * @param {Boolean} [query=false] If true, the query string is included.\n * @param {Boolean} [proxy=false] If true, the url is processed the proxy object if defined.\n *\n * @returns {String} The url with all the requested components.\n */\nResource.prototype.getUrlComponent = function (query, proxy) {\n  if (this.isDataUri) {\n    return this._url;\n  }\n\n  var uri = new Uri(this._url);\n\n  if (query) {\n    stringifyQuery(uri, this);\n  }\n\n  // objectToQuery escapes the placeholders.  Undo that.\n  var url = uri.toString().replace(/%7B/g, \"{\").replace(/%7D/g, \"}\");\n\n  var templateValues = this._templateValues;\n  url = url.replace(/{(.*?)}/g, function (match, key) {\n    var replacement = templateValues[key];\n    if (defined(replacement)) {\n      // use the replacement value from templateValues if there is one...\n      return encodeURIComponent(replacement);\n    }\n    // otherwise leave it unchanged\n    return match;\n  });\n\n  if (proxy && defined(this.proxy)) {\n    url = this.proxy.getURL(url);\n  }\n  return url;\n};\n\n/**\n * Combines the specified object and the existing query parameters. This allows you to add many parameters at once,\n *  as opposed to adding them one at a time to the queryParameters property. If a value is already set, it will be replaced with the new value.\n *\n * @param {Object} params The query parameters\n * @param {Boolean} [useAsDefault=false] If true the params will be used as the default values, so they will only be set if they are undefined.\n */\nResource.prototype.setQueryParameters = function (params, useAsDefault) {\n  if (useAsDefault) {\n    this._queryParameters = combineQueryParameters(\n      this._queryParameters,\n      params,\n      false\n    );\n  } else {\n    this._queryParameters = combineQueryParameters(\n      params,\n      this._queryParameters,\n      false\n    );\n  }\n};\n\n/**\n * Combines the specified object and the existing query parameters. This allows you to add many parameters at once,\n *  as opposed to adding them one at a time to the queryParameters property.\n *\n * @param {Object} params The query parameters\n */\nResource.prototype.appendQueryParameters = function (params) {\n  this._queryParameters = combineQueryParameters(\n    params,\n    this._queryParameters,\n    true\n  );\n};\n\n/**\n * Combines the specified object and the existing template values. This allows you to add many values at once,\n *  as opposed to adding them one at a time to the templateValues property. If a value is already set, it will become an array and the new value will be appended.\n *\n * @param {Object} template The template values\n * @param {Boolean} [useAsDefault=false] If true the values will be used as the default values, so they will only be set if they are undefined.\n */\nResource.prototype.setTemplateValues = function (template, useAsDefault) {\n  if (useAsDefault) {\n    this._templateValues = combine(this._templateValues, template);\n  } else {\n    this._templateValues = combine(template, this._templateValues);\n  }\n};\n\n/**\n * Returns a resource relative to the current instance. All properties remain the same as the current instance unless overridden in options.\n *\n * @param {Object} options An object with the following properties\n * @param {String} [options.url]  The url that will be resolved relative to the url of the current instance.\n * @param {Object} [options.queryParameters] An object containing query parameters that will be combined with those of the current instance.\n * @param {Object} [options.templateValues] Key/Value pairs that are used to replace template values (eg. {x}). These will be combined with those of the current instance.\n * @param {Object} [options.headers={}] Additional HTTP headers that will be sent.\n * @param {DefaultProxy} [options.proxy] A proxy to be used when loading the resource.\n * @param {Resource~RetryCallback} [options.retryCallback] The function to call when loading the resource fails.\n * @param {Number} [options.retryAttempts] The number of times the retryCallback should be called before giving up.\n * @param {Request} [options.request] A Request object that will be used. Intended for internal use only.\n * @param {Boolean} [options.preserveQueryParameters=false] If true, this will keep all query parameters from the current resource and derived resource. If false, derived parameters will replace those of the current resource.\n *\n * @returns {Resource} The resource derived from the current one.\n */\nResource.prototype.getDerivedResource = function (options) {\n  var resource = this.clone();\n  resource._retryCount = 0;\n\n  if (defined(options.url)) {\n    var uri = new Uri(options.url);\n\n    var preserveQueryParameters = defaultValue(\n      options.preserveQueryParameters,\n      false\n    );\n    parseQuery(uri, resource, true, preserveQueryParameters);\n\n    // Remove the fragment as it's not sent with a request\n    uri.fragment = undefined;\n\n    resource._url = uri.resolve(new Uri(getAbsoluteUri(this._url))).toString();\n  }\n\n  if (defined(options.queryParameters)) {\n    resource._queryParameters = combine(\n      options.queryParameters,\n      resource._queryParameters\n    );\n  }\n  if (defined(options.templateValues)) {\n    resource._templateValues = combine(\n      options.templateValues,\n      resource.templateValues\n    );\n  }\n  if (defined(options.headers)) {\n    resource.headers = combine(options.headers, resource.headers);\n  }\n  if (defined(options.proxy)) {\n    resource.proxy = options.proxy;\n  }\n  if (defined(options.request)) {\n    resource.request = options.request;\n  }\n  if (defined(options.retryCallback)) {\n    resource.retryCallback = options.retryCallback;\n  }\n  if (defined(options.retryAttempts)) {\n    resource.retryAttempts = options.retryAttempts;\n  }\n\n  return resource;\n};\n\n/**\n * Called when a resource fails to load. This will call the retryCallback function if defined until retryAttempts is reached.\n *\n * @param {Error} [error] The error that was encountered.\n *\n * @returns {Promise<Boolean>} A promise to a boolean, that if true will cause the resource request to be retried.\n *\n * @private\n */\nResource.prototype.retryOnError = function (error) {\n  var retryCallback = this.retryCallback;\n  if (\n    typeof retryCallback !== \"function\" ||\n    this._retryCount >= this.retryAttempts\n  ) {\n    return when(false);\n  }\n\n  var that = this;\n  return when(retryCallback(this, error)).then(function (result) {\n    ++that._retryCount;\n\n    return result;\n  });\n};\n\n/**\n * Duplicates a Resource instance.\n *\n * @param {Resource} [result] The object onto which to store the result.\n *\n * @returns {Resource} The modified result parameter or a new Resource instance if one was not provided.\n */\nResource.prototype.clone = function (result) {\n  if (!defined(result)) {\n    result = new Resource({\n      url: this._url,\n    });\n  }\n\n  result._url = this._url;\n  result._queryParameters = clone(this._queryParameters);\n  result._templateValues = clone(this._templateValues);\n  result.headers = clone(this.headers);\n  result.proxy = this.proxy;\n  result.retryCallback = this.retryCallback;\n  result.retryAttempts = this.retryAttempts;\n  result._retryCount = 0;\n  result.request = this.request.clone();\n\n  return result;\n};\n\n/**\n * Returns the base path of the Resource.\n *\n * @param {Boolean} [includeQuery = false] Whether or not to include the query string and fragment form the uri\n *\n * @returns {String} The base URI of the resource\n */\nResource.prototype.getBaseUri = function (includeQuery) {\n  return getBaseUri(this.getUrlComponent(includeQuery), includeQuery);\n};\n\n/**\n * Appends a forward slash to the URL.\n */\nResource.prototype.appendForwardSlash = function () {\n  this._url = appendForwardSlash(this._url);\n};\n\n/**\n * Asynchronously loads the resource as raw binary data.  Returns a promise that will resolve to\n * an ArrayBuffer once loaded, or reject if the resource failed to load.  The data is loaded\n * using XMLHttpRequest, which means that in order to make requests to another origin,\n * the server must have Cross-Origin Resource Sharing (CORS) headers enabled.\n *\n * @returns {Promise.<ArrayBuffer>|undefined} a promise that will resolve to the requested data when loaded. Returns undefined if <code>request.throttle</code> is true and the request does not have high enough priority.\n *\n * @example\n * // load a single URL asynchronously\n * resource.fetchArrayBuffer().then(function(arrayBuffer) {\n *     // use the data\n * }).otherwise(function(error) {\n *     // an error occurred\n * });\n *\n * @see {@link http://www.w3.org/TR/cors/|Cross-Origin Resource Sharing}\n * @see {@link http://wiki.commonjs.org/wiki/Promises/A|CommonJS Promises/A}\n */\nResource.prototype.fetchArrayBuffer = function () {\n  return this.fetch({\n    responseType: \"arraybuffer\",\n  });\n};\n\n/**\n * Creates a Resource and calls fetchArrayBuffer() on it.\n *\n * @param {String|Object} options A url or an object with the following properties\n * @param {String} options.url The url of the resource.\n * @param {Object} [options.queryParameters] An object containing query parameters that will be sent when retrieving the resource.\n * @param {Object} [options.templateValues] Key/Value pairs that are used to replace template values (eg. {x}).\n * @param {Object} [options.headers={}] Additional HTTP headers that will be sent.\n * @param {DefaultProxy} [options.proxy] A proxy to be used when loading the resource.\n * @param {Resource~RetryCallback} [options.retryCallback] The Function to call when a request for this resource fails. If it returns true, the request will be retried.\n * @param {Number} [options.retryAttempts=0] The number of times the retryCallback should be called before giving up.\n * @param {Request} [options.request] A Request object that will be used. Intended for internal use only.\n * @returns {Promise.<ArrayBuffer>|undefined} a promise that will resolve to the requested data when loaded. Returns undefined if <code>request.throttle</code> is true and the request does not have high enough priority.\n */\nResource.fetchArrayBuffer = function (options) {\n  var resource = new Resource(options);\n  return resource.fetchArrayBuffer();\n};\n\n/**\n * Asynchronously loads the given resource as a blob.  Returns a promise that will resolve to\n * a Blob once loaded, or reject if the resource failed to load.  The data is loaded\n * using XMLHttpRequest, which means that in order to make requests to another origin,\n * the server must have Cross-Origin Resource Sharing (CORS) headers enabled.\n *\n * @returns {Promise.<Blob>|undefined} a promise that will resolve to the requested data when loaded. Returns undefined if <code>request.throttle</code> is true and the request does not have high enough priority.\n *\n * @example\n * // load a single URL asynchronously\n * resource.fetchBlob().then(function(blob) {\n *     // use the data\n * }).otherwise(function(error) {\n *     // an error occurred\n * });\n *\n * @see {@link http://www.w3.org/TR/cors/|Cross-Origin Resource Sharing}\n * @see {@link http://wiki.commonjs.org/wiki/Promises/A|CommonJS Promises/A}\n */\nResource.prototype.fetchBlob = function () {\n  return this.fetch({\n    responseType: \"blob\",\n  });\n};\n\n/**\n * Creates a Resource and calls fetchBlob() on it.\n *\n * @param {String|Object} options A url or an object with the following properties\n * @param {String} options.url The url of the resource.\n * @param {Object} [options.queryParameters] An object containing query parameters that will be sent when retrieving the resource.\n * @param {Object} [options.templateValues] Key/Value pairs that are used to replace template values (eg. {x}).\n * @param {Object} [options.headers={}] Additional HTTP headers that will be sent.\n * @param {DefaultProxy} [options.proxy] A proxy to be used when loading the resource.\n * @param {Resource~RetryCallback} [options.retryCallback] The Function to call when a request for this resource fails. If it returns true, the request will be retried.\n * @param {Number} [options.retryAttempts=0] The number of times the retryCallback should be called before giving up.\n * @param {Request} [options.request] A Request object that will be used. Intended for internal use only.\n * @returns {Promise.<Blob>|undefined} a promise that will resolve to the requested data when loaded. Returns undefined if <code>request.throttle</code> is true and the request does not have high enough priority.\n */\nResource.fetchBlob = function (options) {\n  var resource = new Resource(options);\n  return resource.fetchBlob();\n};\n\n/**\n * Asynchronously loads the given image resource.  Returns a promise that will resolve to\n * an {@link https://developer.mozilla.org/en-US/docs/Web/API/ImageBitmap|ImageBitmap} if <code>preferImageBitmap</code> is true and the browser supports <code>createImageBitmap</code> or otherwise an\n * {@link https://developer.mozilla.org/en-US/docs/Web/API/HTMLImageElement|Image} once loaded, or reject if the image failed to load.\n *\n * @param {Object} [options] An object with the following properties.\n * @param {Boolean} [options.preferBlob=false] If true, we will load the image via a blob.\n * @param {Boolean} [options.preferImageBitmap=false] If true, image will be decoded during fetch and an <code>ImageBitmap</code> is returned.\n * @param {Boolean} [options.flipY=false] If true, image will be vertically flipped during decode. Only applies if the browser supports <code>createImageBitmap</code>.\n * @returns {Promise.<ImageBitmap>|Promise.<Image>|undefined} a promise that will resolve to the requested data when loaded. Returns undefined if <code>request.throttle</code> is true and the request does not have high enough priority.\n *\n *\n * @example\n * // load a single image asynchronously\n * resource.fetchImage().then(function(image) {\n *     // use the loaded image\n * }).otherwise(function(error) {\n *     // an error occurred\n * });\n *\n * // load several images in parallel\n * when.all([resource1.fetchImage(), resource2.fetchImage()]).then(function(images) {\n *     // images is an array containing all the loaded images\n * });\n *\n * @see {@link http://www.w3.org/TR/cors/|Cross-Origin Resource Sharing}\n * @see {@link http://wiki.commonjs.org/wiki/Promises/A|CommonJS Promises/A}\n */\nResource.prototype.fetchImage = function (options) {\n  options = defaultValue(options, defaultValue.EMPTY_OBJECT);\n  var preferImageBitmap = defaultValue(options.preferImageBitmap, false);\n  var preferBlob = defaultValue(options.preferBlob, false);\n  var flipY = defaultValue(options.flipY, false);\n\n  checkAndResetRequest(this.request);\n\n  // We try to load the image normally if\n  // 1. Blobs aren't supported\n  // 2. It's a data URI\n  // 3. It's a blob URI\n  // 4. It doesn't have request headers and we preferBlob is false\n  if (\n    !xhrBlobSupported ||\n    this.isDataUri ||\n    this.isBlobUri ||\n    (!this.hasHeaders && !preferBlob)\n  ) {\n    return fetchImage({\n      resource: this,\n      flipY: flipY,\n      preferImageBitmap: preferImageBitmap,\n    });\n  }\n\n  var blobPromise = this.fetchBlob();\n  if (!defined(blobPromise)) {\n    return;\n  }\n\n  var supportsImageBitmap;\n  var useImageBitmap;\n  var generatedBlobResource;\n  var generatedBlob;\n  return Resource.supportsImageBitmapOptions()\n    .then(function (result) {\n      supportsImageBitmap = result;\n      useImageBitmap = supportsImageBitmap && preferImageBitmap;\n      return blobPromise;\n    })\n    .then(function (blob) {\n      if (!defined(blob)) {\n        return;\n      }\n      generatedBlob = blob;\n      if (useImageBitmap) {\n        return Resource.createImageBitmapFromBlob(blob, {\n          flipY: flipY,\n          premultiplyAlpha: false,\n        });\n      }\n      var blobUrl = window.URL.createObjectURL(blob);\n      generatedBlobResource = new Resource({\n        url: blobUrl,\n      });\n\n      return fetchImage({\n        resource: generatedBlobResource,\n        flipY: flipY,\n        preferImageBitmap: false,\n      });\n    })\n    .then(function (image) {\n      if (!defined(image)) {\n        return;\n      }\n\n      // The blob object may be needed for use by a TileDiscardPolicy,\n      // so attach it to the image.\n      image.blob = generatedBlob;\n\n      if (useImageBitmap) {\n        return image;\n      }\n\n      window.URL.revokeObjectURL(generatedBlobResource.url);\n      return image;\n    })\n    .otherwise(function (error) {\n      if (defined(generatedBlobResource)) {\n        window.URL.revokeObjectURL(generatedBlobResource.url);\n      }\n\n      // If the blob load succeeded but the image decode failed, attach the blob\n      // to the error object for use by a TileDiscardPolicy.\n      // In particular, BingMapsImageryProvider uses this to detect the\n      // zero-length response that is returned when a tile is not available.\n      error.blob = generatedBlob;\n\n      return when.reject(error);\n    });\n};\n\n/**\n * Fetches an image and returns a promise to it.\n *\n * @param {Object} [options] An object with the following properties.\n * @param {Resource} [options.resource] Resource object that points to an image to fetch.\n * @param {Boolean} [options.preferImageBitmap] If true, image will be decoded during fetch and an <code>ImageBitmap</code> is returned.\n * @param {Boolean} [options.flipY] If true, image will be vertically flipped during decode. Only applies if the browser supports <code>createImageBitmap</code>.\n *\n * @private\n */\nfunction fetchImage(options) {\n  var resource = options.resource;\n  var flipY = options.flipY;\n  var preferImageBitmap = options.preferImageBitmap;\n\n  var request = resource.request;\n  request.url = resource.url;\n  request.requestFunction = function () {\n    var crossOrigin = false;\n\n    // data URIs can't have crossorigin set.\n    if (!resource.isDataUri && !resource.isBlobUri) {\n      crossOrigin = resource.isCrossOriginUrl;\n    }\n\n    var deferred = when.defer();\n    Resource._Implementations.createImage(\n      request,\n      crossOrigin,\n      deferred,\n      flipY,\n      preferImageBitmap\n    );\n\n    return deferred.promise;\n  };\n\n  var promise = RequestScheduler.request(request);\n  if (!defined(promise)) {\n    return;\n  }\n\n  return promise.otherwise(function (e) {\n    // Don't retry cancelled or otherwise aborted requests\n    if (request.state !== RequestState.FAILED) {\n      return when.reject(e);\n    }\n\n    return resource.retryOnError(e).then(function (retry) {\n      if (retry) {\n        // Reset request so it can try again\n        request.state = RequestState.UNISSUED;\n        request.deferred = undefined;\n\n        return fetchImage({\n          resource: resource,\n          flipY: flipY,\n          preferImageBitmap: preferImageBitmap,\n        });\n      }\n\n      return when.reject(e);\n    });\n  });\n}\n\n/**\n * Creates a Resource and calls fetchImage() on it.\n *\n * @param {String|Object} options A url or an object with the following properties\n * @param {String} options.url The url of the resource.\n * @param {Object} [options.queryParameters] An object containing query parameters that will be sent when retrieving the resource.\n * @param {Object} [options.templateValues] Key/Value pairs that are used to replace template values (eg. {x}).\n * @param {Object} [options.headers={}] Additional HTTP headers that will be sent.\n * @param {DefaultProxy} [options.proxy] A proxy to be used when loading the resource.\n * @param {Boolean} [options.flipY=false] Whether to vertically flip the image during fetch and decode. Only applies when requesting an image and the browser supports <code>createImageBitmap</code>.\n * @param {Resource~RetryCallback} [options.retryCallback] The Function to call when a request for this resource fails. If it returns true, the request will be retried.\n * @param {Number} [options.retryAttempts=0] The number of times the retryCallback should be called before giving up.\n * @param {Request} [options.request] A Request object that will be used. Intended for internal use only.\n * @param {Boolean} [options.preferBlob=false]  If true, we will load the image via a blob.\n * @param {Boolean} [options.preferImageBitmap=false] If true, image will be decoded during fetch and an <code>ImageBitmap</code> is returned.\n * @returns {Promise.<ImageBitmap>|Promise.<Image>|undefined} a promise that will resolve to the requested data when loaded. Returns undefined if <code>request.throttle</code> is true and the request does not have high enough priority.\n */\nResource.fetchImage = function (options) {\n  var resource = new Resource(options);\n  return resource.fetchImage({\n    flipY: options.flipY,\n    preferBlob: options.preferBlob,\n    preferImageBitmap: options.preferImageBitmap,\n  });\n};\n\n/**\n * Asynchronously loads the given resource as text.  Returns a promise that will resolve to\n * a String once loaded, or reject if the resource failed to load.  The data is loaded\n * using XMLHttpRequest, which means that in order to make requests to another origin,\n * the server must have Cross-Origin Resource Sharing (CORS) headers enabled.\n *\n * @returns {Promise.<String>|undefined} a promise that will resolve to the requested data when loaded. Returns undefined if <code>request.throttle</code> is true and the request does not have high enough priority.\n *\n * @example\n * // load text from a URL, setting a custom header\n * var resource = new Resource({\n *   url: 'http://someUrl.com/someJson.txt',\n *   headers: {\n *     'X-Custom-Header' : 'some value'\n *   }\n * });\n * resource.fetchText().then(function(text) {\n *     // Do something with the text\n * }).otherwise(function(error) {\n *     // an error occurred\n * });\n *\n * @see {@link https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest|XMLHttpRequest}\n * @see {@link http://www.w3.org/TR/cors/|Cross-Origin Resource Sharing}\n * @see {@link http://wiki.commonjs.org/wiki/Promises/A|CommonJS Promises/A}\n */\nResource.prototype.fetchText = function () {\n  return this.fetch({\n    responseType: \"text\",\n  });\n};\n\n/**\n * Creates a Resource and calls fetchText() on it.\n *\n * @param {String|Object} options A url or an object with the following properties\n * @param {String} options.url The url of the resource.\n * @param {Object} [options.queryParameters] An object containing query parameters that will be sent when retrieving the resource.\n * @param {Object} [options.templateValues] Key/Value pairs that are used to replace template values (eg. {x}).\n * @param {Object} [options.headers={}] Additional HTTP headers that will be sent.\n * @param {DefaultProxy} [options.proxy] A proxy to be used when loading the resource.\n * @param {Resource~RetryCallback} [options.retryCallback] The Function to call when a request for this resource fails. If it returns true, the request will be retried.\n * @param {Number} [options.retryAttempts=0] The number of times the retryCallback should be called before giving up.\n * @param {Request} [options.request] A Request object that will be used. Intended for internal use only.\n * @returns {Promise.<String>|undefined} a promise that will resolve to the requested data when loaded. Returns undefined if <code>request.throttle</code> is true and the request does not have high enough priority.\n */\nResource.fetchText = function (options) {\n  var resource = new Resource(options);\n  return resource.fetchText();\n};\n\n// note: &#42;&#47;&#42; below is */* but that ends the comment block early\n/**\n * Asynchronously loads the given resource as JSON.  Returns a promise that will resolve to\n * a JSON object once loaded, or reject if the resource failed to load.  The data is loaded\n * using XMLHttpRequest, which means that in order to make requests to another origin,\n * the server must have Cross-Origin Resource Sharing (CORS) headers enabled. This function\n * adds 'Accept: application/json,&#42;&#47;&#42;;q=0.01' to the request headers, if not\n * already specified.\n *\n * @returns {Promise.<Object>|undefined} a promise that will resolve to the requested data when loaded. Returns undefined if <code>request.throttle</code> is true and the request does not have high enough priority.\n *\n *\n * @example\n * resource.fetchJson().then(function(jsonData) {\n *     // Do something with the JSON object\n * }).otherwise(function(error) {\n *     // an error occurred\n * });\n *\n * @see {@link http://www.w3.org/TR/cors/|Cross-Origin Resource Sharing}\n * @see {@link http://wiki.commonjs.org/wiki/Promises/A|CommonJS Promises/A}\n */\nResource.prototype.fetchJson = function () {\n  var promise = this.fetch({\n    responseType: \"text\",\n    headers: {\n      Accept: \"application/json,*/*;q=0.01\",\n    },\n  });\n\n  if (!defined(promise)) {\n    return undefined;\n  }\n\n  return promise.then(function (value) {\n    if (!defined(value)) {\n      return;\n    }\n    return JSON.parse(value);\n  });\n};\n\n/**\n * Creates a Resource and calls fetchJson() on it.\n *\n * @param {String|Object} options A url or an object with the following properties\n * @param {String} options.url The url of the resource.\n * @param {Object} [options.queryParameters] An object containing query parameters that will be sent when retrieving the resource.\n * @param {Object} [options.templateValues] Key/Value pairs that are used to replace template values (eg. {x}).\n * @param {Object} [options.headers={}] Additional HTTP headers that will be sent.\n * @param {DefaultProxy} [options.proxy] A proxy to be used when loading the resource.\n * @param {Resource~RetryCallback} [options.retryCallback] The Function to call when a request for this resource fails. If it returns true, the request will be retried.\n * @param {Number} [options.retryAttempts=0] The number of times the retryCallback should be called before giving up.\n * @param {Request} [options.request] A Request object that will be used. Intended for internal use only.\n * @returns {Promise.<Object>|undefined} a promise that will resolve to the requested data when loaded. Returns undefined if <code>request.throttle</code> is true and the request does not have high enough priority.\n */\nResource.fetchJson = function (options) {\n  var resource = new Resource(options);\n  return resource.fetchJson();\n};\n\n/**\n * Asynchronously loads the given resource as XML.  Returns a promise that will resolve to\n * an XML Document once loaded, or reject if the resource failed to load.  The data is loaded\n * using XMLHttpRequest, which means that in order to make requests to another origin,\n * the server must have Cross-Origin Resource Sharing (CORS) headers enabled.\n *\n * @returns {Promise.<XMLDocument>|undefined} a promise that will resolve to the requested data when loaded. Returns undefined if <code>request.throttle</code> is true and the request does not have high enough priority.\n *\n *\n * @example\n * // load XML from a URL, setting a custom header\n * Cesium.loadXML('http://someUrl.com/someXML.xml', {\n *   'X-Custom-Header' : 'some value'\n * }).then(function(document) {\n *     // Do something with the document\n * }).otherwise(function(error) {\n *     // an error occurred\n * });\n *\n * @see {@link https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest|XMLHttpRequest}\n * @see {@link http://www.w3.org/TR/cors/|Cross-Origin Resource Sharing}\n * @see {@link http://wiki.commonjs.org/wiki/Promises/A|CommonJS Promises/A}\n */\nResource.prototype.fetchXML = function () {\n  return this.fetch({\n    responseType: \"document\",\n    overrideMimeType: \"text/xml\",\n  });\n};\n\n/**\n * Creates a Resource and calls fetchXML() on it.\n *\n * @param {String|Object} options A url or an object with the following properties\n * @param {String} options.url The url of the resource.\n * @param {Object} [options.queryParameters] An object containing query parameters that will be sent when retrieving the resource.\n * @param {Object} [options.templateValues] Key/Value pairs that are used to replace template values (eg. {x}).\n * @param {Object} [options.headers={}] Additional HTTP headers that will be sent.\n * @param {DefaultProxy} [options.proxy] A proxy to be used when loading the resource.\n * @param {Resource~RetryCallback} [options.retryCallback] The Function to call when a request for this resource fails. If it returns true, the request will be retried.\n * @param {Number} [options.retryAttempts=0] The number of times the retryCallback should be called before giving up.\n * @param {Request} [options.request] A Request object that will be used. Intended for internal use only.\n * @returns {Promise.<XMLDocument>|undefined} a promise that will resolve to the requested data when loaded. Returns undefined if <code>request.throttle</code> is true and the request does not have high enough priority.\n */\nResource.fetchXML = function (options) {\n  var resource = new Resource(options);\n  return resource.fetchXML();\n};\n\n/**\n * Requests a resource using JSONP.\n *\n * @param {String} [callbackParameterName='callback'] The callback parameter name that the server expects.\n * @returns {Promise.<Object>|undefined} a promise that will resolve to the requested data when loaded. Returns undefined if <code>request.throttle</code> is true and the request does not have high enough priority.\n *\n *\n * @example\n * // load a data asynchronously\n * resource.fetchJsonp().then(function(data) {\n *     // use the loaded data\n * }).otherwise(function(error) {\n *     // an error occurred\n * });\n *\n * @see {@link http://wiki.commonjs.org/wiki/Promises/A|CommonJS Promises/A}\n */\nResource.prototype.fetchJsonp = function (callbackParameterName) {\n  callbackParameterName = defaultValue(callbackParameterName, \"callback\");\n\n  checkAndResetRequest(this.request);\n\n  //generate a unique function name\n  var functionName;\n  do {\n    functionName = \"loadJsonp\" + Math.random().toString().substring(2, 8);\n  } while (defined(window[functionName]));\n\n  return fetchJsonp(this, callbackParameterName, functionName);\n};\n\nfunction fetchJsonp(resource, callbackParameterName, functionName) {\n  var callbackQuery = {};\n  callbackQuery[callbackParameterName] = functionName;\n  resource.setQueryParameters(callbackQuery);\n\n  var request = resource.request;\n  request.url = resource.url;\n  request.requestFunction = function () {\n    var deferred = when.defer();\n\n    //assign a function with that name in the global scope\n    window[functionName] = function (data) {\n      deferred.resolve(data);\n\n      try {\n        delete window[functionName];\n      } catch (e) {\n        window[functionName] = undefined;\n      }\n    };\n\n    Resource._Implementations.loadAndExecuteScript(\n      resource.url,\n      functionName,\n      deferred\n    );\n    return deferred.promise;\n  };\n\n  var promise = RequestScheduler.request(request);\n  if (!defined(promise)) {\n    return;\n  }\n\n  return promise.otherwise(function (e) {\n    if (request.state !== RequestState.FAILED) {\n      return when.reject(e);\n    }\n\n    return resource.retryOnError(e).then(function (retry) {\n      if (retry) {\n        // Reset request so it can try again\n        request.state = RequestState.UNISSUED;\n        request.deferred = undefined;\n\n        return fetchJsonp(resource, callbackParameterName, functionName);\n      }\n\n      return when.reject(e);\n    });\n  });\n}\n\n/**\n * Creates a Resource from a URL and calls fetchJsonp() on it.\n *\n * @param {String|Object} options A url or an object with the following properties\n * @param {String} options.url The url of the resource.\n * @param {Object} [options.queryParameters] An object containing query parameters that will be sent when retrieving the resource.\n * @param {Object} [options.templateValues] Key/Value pairs that are used to replace template values (eg. {x}).\n * @param {Object} [options.headers={}] Additional HTTP headers that will be sent.\n * @param {DefaultProxy} [options.proxy] A proxy to be used when loading the resource.\n * @param {Resource~RetryCallback} [options.retryCallback] The Function to call when a request for this resource fails. If it returns true, the request will be retried.\n * @param {Number} [options.retryAttempts=0] The number of times the retryCallback should be called before giving up.\n * @param {Request} [options.request] A Request object that will be used. Intended for internal use only.\n * @param {String} [options.callbackParameterName='callback'] The callback parameter name that the server expects.\n * @returns {Promise.<Object>|undefined} a promise that will resolve to the requested data when loaded. Returns undefined if <code>request.throttle</code> is true and the request does not have high enough priority.\n */\nResource.fetchJsonp = function (options) {\n  var resource = new Resource(options);\n  return resource.fetchJsonp(options.callbackParameterName);\n};\n\n/**\n * @private\n */\nResource.prototype._makeRequest = function (options) {\n  var resource = this;\n  checkAndResetRequest(resource.request);\n\n  var request = resource.request;\n  request.url = resource.url;\n\n  request.requestFunction = function () {\n    var responseType = options.responseType;\n    var headers = combine(options.headers, resource.headers);\n    var overrideMimeType = options.overrideMimeType;\n    var method = options.method;\n    var data = options.data;\n    var deferred = when.defer();\n    var xhr = Resource._Implementations.loadWithXhr(\n      resource.url,\n      responseType,\n      method,\n      data,\n      headers,\n      deferred,\n      overrideMimeType\n    );\n    if (defined(xhr) && defined(xhr.abort)) {\n      request.cancelFunction = function () {\n        xhr.abort();\n      };\n    }\n    return deferred.promise;\n  };\n\n  var promise = RequestScheduler.request(request);\n  if (!defined(promise)) {\n    return;\n  }\n\n  return promise\n    .then(function (data) {\n      return data;\n    })\n    .otherwise(function (e) {\n      if (request.state !== RequestState.FAILED) {\n        return when.reject(e);\n      }\n\n      return resource.retryOnError(e).then(function (retry) {\n        if (retry) {\n          // Reset request so it can try again\n          request.state = RequestState.UNISSUED;\n          request.deferred = undefined;\n\n          return resource.fetch(options);\n        }\n\n        return when.reject(e);\n      });\n    });\n};\n\nvar dataUriRegex = /^data:(.*?)(;base64)?,(.*)$/;\n\nfunction decodeDataUriText(isBase64, data) {\n  var result = decodeURIComponent(data);\n  if (isBase64) {\n    return atob(result);\n  }\n  return result;\n}\n\nfunction decodeDataUriArrayBuffer(isBase64, data) {\n  var byteString = decodeDataUriText(isBase64, data);\n  var buffer = new ArrayBuffer(byteString.length);\n  var view = new Uint8Array(buffer);\n  for (var i = 0; i < byteString.length; i++) {\n    view[i] = byteString.charCodeAt(i);\n  }\n  return buffer;\n}\n\nfunction decodeDataUri(dataUriRegexResult, responseType) {\n  responseType = defaultValue(responseType, \"\");\n  var mimeType = dataUriRegexResult[1];\n  var isBase64 = !!dataUriRegexResult[2];\n  var data = dataUriRegexResult[3];\n\n  switch (responseType) {\n    case \"\":\n    case \"text\":\n      return decodeDataUriText(isBase64, data);\n    case \"arraybuffer\":\n      return decodeDataUriArrayBuffer(isBase64, data);\n    case \"blob\":\n      var buffer = decodeDataUriArrayBuffer(isBase64, data);\n      return new Blob([buffer], {\n        type: mimeType,\n      });\n    case \"document\":\n      var parser = new DOMParser();\n      return parser.parseFromString(\n        decodeDataUriText(isBase64, data),\n        mimeType\n      );\n    case \"json\":\n      return JSON.parse(decodeDataUriText(isBase64, data));\n    default:\n      //>>includeStart('debug', pragmas.debug);\n      throw new DeveloperError(\"Unhandled responseType: \" + responseType);\n    //>>includeEnd('debug');\n  }\n}\n\n/**\n * Asynchronously loads the given resource.  Returns a promise that will resolve to\n * the result once loaded, or reject if the resource failed to load.  The data is loaded\n * using XMLHttpRequest, which means that in order to make requests to another origin,\n * the server must have Cross-Origin Resource Sharing (CORS) headers enabled. It's recommended that you use\n * the more specific functions eg. fetchJson, fetchBlob, etc.\n *\n * @param {Object} [options] Object with the following properties:\n * @param {String} [options.responseType] The type of response.  This controls the type of item returned.\n * @param {Object} [options.headers] Additional HTTP headers to send with the request, if any.\n * @param {String} [options.overrideMimeType] Overrides the MIME type returned by the server.\n * @returns {Promise.<Object>|undefined} a promise that will resolve to the requested data when loaded. Returns undefined if <code>request.throttle</code> is true and the request does not have high enough priority.\n *\n *\n * @example\n * resource.fetch()\n *   .then(function(body) {\n *       // use the data\n *   }).otherwise(function(error) {\n *       // an error occurred\n *   });\n *\n * @see {@link http://www.w3.org/TR/cors/|Cross-Origin Resource Sharing}\n * @see {@link http://wiki.commonjs.org/wiki/Promises/A|CommonJS Promises/A}\n */\nResource.prototype.fetch = function (options) {\n  options = defaultClone(options, {});\n  options.method = \"GET\";\n\n  return this._makeRequest(options);\n};\n\n/**\n * Creates a Resource from a URL and calls fetch() on it.\n *\n * @param {String|Object} options A url or an object with the following properties\n * @param {String} options.url The url of the resource.\n * @param {Object} [options.queryParameters] An object containing query parameters that will be sent when retrieving the resource.\n * @param {Object} [options.templateValues] Key/Value pairs that are used to replace template values (eg. {x}).\n * @param {Object} [options.headers={}] Additional HTTP headers that will be sent.\n * @param {DefaultProxy} [options.proxy] A proxy to be used when loading the resource.\n * @param {Resource~RetryCallback} [options.retryCallback] The Function to call when a request for this resource fails. If it returns true, the request will be retried.\n * @param {Number} [options.retryAttempts=0] The number of times the retryCallback should be called before giving up.\n * @param {Request} [options.request] A Request object that will be used. Intended for internal use only.\n * @param {String} [options.responseType] The type of response.  This controls the type of item returned.\n * @param {String} [options.overrideMimeType] Overrides the MIME type returned by the server.\n * @returns {Promise.<Object>|undefined} a promise that will resolve to the requested data when loaded. Returns undefined if <code>request.throttle</code> is true and the request does not have high enough priority.\n */\nResource.fetch = function (options) {\n  var resource = new Resource(options);\n  return resource.fetch({\n    // Make copy of just the needed fields because headers can be passed to both the constructor and to fetch\n    responseType: options.responseType,\n    overrideMimeType: options.overrideMimeType,\n  });\n};\n\n/**\n * Asynchronously deletes the given resource.  Returns a promise that will resolve to\n * the result once loaded, or reject if the resource failed to load.  The data is loaded\n * using XMLHttpRequest, which means that in order to make requests to another origin,\n * the server must have Cross-Origin Resource Sharing (CORS) headers enabled.\n *\n * @param {Object} [options] Object with the following properties:\n * @param {String} [options.responseType] The type of response.  This controls the type of item returned.\n * @param {Object} [options.headers] Additional HTTP headers to send with the request, if any.\n * @param {String} [options.overrideMimeType] Overrides the MIME type returned by the server.\n * @returns {Promise.<Object>|undefined} a promise that will resolve to the requested data when loaded. Returns undefined if <code>request.throttle</code> is true and the request does not have high enough priority.\n *\n *\n * @example\n * resource.delete()\n *   .then(function(body) {\n *       // use the data\n *   }).otherwise(function(error) {\n *       // an error occurred\n *   });\n *\n * @see {@link http://www.w3.org/TR/cors/|Cross-Origin Resource Sharing}\n * @see {@link http://wiki.commonjs.org/wiki/Promises/A|CommonJS Promises/A}\n */\nResource.prototype.delete = function (options) {\n  options = defaultClone(options, {});\n  options.method = \"DELETE\";\n\n  return this._makeRequest(options);\n};\n\n/**\n * Creates a Resource from a URL and calls delete() on it.\n *\n * @param {String|Object} options A url or an object with the following properties\n * @param {String} options.url The url of the resource.\n * @param {Object} [options.data] Data that is posted with the resource.\n * @param {Object} [options.queryParameters] An object containing query parameters that will be sent when retrieving the resource.\n * @param {Object} [options.templateValues] Key/Value pairs that are used to replace template values (eg. {x}).\n * @param {Object} [options.headers={}] Additional HTTP headers that will be sent.\n * @param {DefaultProxy} [options.proxy] A proxy to be used when loading the resource.\n * @param {Resource~RetryCallback} [options.retryCallback] The Function to call when a request for this resource fails. If it returns true, the request will be retried.\n * @param {Number} [options.retryAttempts=0] The number of times the retryCallback should be called before giving up.\n * @param {Request} [options.request] A Request object that will be used. Intended for internal use only.\n * @param {String} [options.responseType] The type of response.  This controls the type of item returned.\n * @param {String} [options.overrideMimeType] Overrides the MIME type returned by the server.\n * @returns {Promise.<Object>|undefined} a promise that will resolve to the requested data when loaded. Returns undefined if <code>request.throttle</code> is true and the request does not have high enough priority.\n */\nResource.delete = function (options) {\n  var resource = new Resource(options);\n  return resource.delete({\n    // Make copy of just the needed fields because headers can be passed to both the constructor and to fetch\n    responseType: options.responseType,\n    overrideMimeType: options.overrideMimeType,\n    data: options.data,\n  });\n};\n\n/**\n * Asynchronously gets headers the given resource.  Returns a promise that will resolve to\n * the result once loaded, or reject if the resource failed to load.  The data is loaded\n * using XMLHttpRequest, which means that in order to make requests to another origin,\n * the server must have Cross-Origin Resource Sharing (CORS) headers enabled.\n *\n * @param {Object} [options] Object with the following properties:\n * @param {String} [options.responseType] The type of response.  This controls the type of item returned.\n * @param {Object} [options.headers] Additional HTTP headers to send with the request, if any.\n * @param {String} [options.overrideMimeType] Overrides the MIME type returned by the server.\n * @returns {Promise.<Object>|undefined} a promise that will resolve to the requested data when loaded. Returns undefined if <code>request.throttle</code> is true and the request does not have high enough priority.\n *\n *\n * @example\n * resource.head()\n *   .then(function(headers) {\n *       // use the data\n *   }).otherwise(function(error) {\n *       // an error occurred\n *   });\n *\n * @see {@link http://www.w3.org/TR/cors/|Cross-Origin Resource Sharing}\n * @see {@link http://wiki.commonjs.org/wiki/Promises/A|CommonJS Promises/A}\n */\nResource.prototype.head = function (options) {\n  options = defaultClone(options, {});\n  options.method = \"HEAD\";\n\n  return this._makeRequest(options);\n};\n\n/**\n * Creates a Resource from a URL and calls head() on it.\n *\n * @param {String|Object} options A url or an object with the following properties\n * @param {String} options.url The url of the resource.\n * @param {Object} [options.queryParameters] An object containing query parameters that will be sent when retrieving the resource.\n * @param {Object} [options.templateValues] Key/Value pairs that are used to replace template values (eg. {x}).\n * @param {Object} [options.headers={}] Additional HTTP headers that will be sent.\n * @param {DefaultProxy} [options.proxy] A proxy to be used when loading the resource.\n * @param {Resource~RetryCallback} [options.retryCallback] The Function to call when a request for this resource fails. If it returns true, the request will be retried.\n * @param {Number} [options.retryAttempts=0] The number of times the retryCallback should be called before giving up.\n * @param {Request} [options.request] A Request object that will be used. Intended for internal use only.\n * @param {String} [options.responseType] The type of response.  This controls the type of item returned.\n * @param {String} [options.overrideMimeType] Overrides the MIME type returned by the server.\n * @returns {Promise.<Object>|undefined} a promise that will resolve to the requested data when loaded. Returns undefined if <code>request.throttle</code> is true and the request does not have high enough priority.\n */\nResource.head = function (options) {\n  var resource = new Resource(options);\n  return resource.head({\n    // Make copy of just the needed fields because headers can be passed to both the constructor and to fetch\n    responseType: options.responseType,\n    overrideMimeType: options.overrideMimeType,\n  });\n};\n\n/**\n * Asynchronously gets options the given resource.  Returns a promise that will resolve to\n * the result once loaded, or reject if the resource failed to load.  The data is loaded\n * using XMLHttpRequest, which means that in order to make requests to another origin,\n * the server must have Cross-Origin Resource Sharing (CORS) headers enabled.\n *\n * @param {Object} [options] Object with the following properties:\n * @param {String} [options.responseType] The type of response.  This controls the type of item returned.\n * @param {Object} [options.headers] Additional HTTP headers to send with the request, if any.\n * @param {String} [options.overrideMimeType] Overrides the MIME type returned by the server.\n * @returns {Promise.<Object>|undefined} a promise that will resolve to the requested data when loaded. Returns undefined if <code>request.throttle</code> is true and the request does not have high enough priority.\n *\n *\n * @example\n * resource.options()\n *   .then(function(headers) {\n *       // use the data\n *   }).otherwise(function(error) {\n *       // an error occurred\n *   });\n *\n * @see {@link http://www.w3.org/TR/cors/|Cross-Origin Resource Sharing}\n * @see {@link http://wiki.commonjs.org/wiki/Promises/A|CommonJS Promises/A}\n */\nResource.prototype.options = function (options) {\n  options = defaultClone(options, {});\n  options.method = \"OPTIONS\";\n\n  return this._makeRequest(options);\n};\n\n/**\n * Creates a Resource from a URL and calls options() on it.\n *\n * @param {String|Object} options A url or an object with the following properties\n * @param {String} options.url The url of the resource.\n * @param {Object} [options.queryParameters] An object containing query parameters that will be sent when retrieving the resource.\n * @param {Object} [options.templateValues] Key/Value pairs that are used to replace template values (eg. {x}).\n * @param {Object} [options.headers={}] Additional HTTP headers that will be sent.\n * @param {DefaultProxy} [options.proxy] A proxy to be used when loading the resource.\n * @param {Resource~RetryCallback} [options.retryCallback] The Function to call when a request for this resource fails. If it returns true, the request will be retried.\n * @param {Number} [options.retryAttempts=0] The number of times the retryCallback should be called before giving up.\n * @param {Request} [options.request] A Request object that will be used. Intended for internal use only.\n * @param {String} [options.responseType] The type of response.  This controls the type of item returned.\n * @param {String} [options.overrideMimeType] Overrides the MIME type returned by the server.\n * @returns {Promise.<Object>|undefined} a promise that will resolve to the requested data when loaded. Returns undefined if <code>request.throttle</code> is true and the request does not have high enough priority.\n */\nResource.options = function (options) {\n  var resource = new Resource(options);\n  return resource.options({\n    // Make copy of just the needed fields because headers can be passed to both the constructor and to fetch\n    responseType: options.responseType,\n    overrideMimeType: options.overrideMimeType,\n  });\n};\n\n/**\n * Asynchronously posts data to the given resource.  Returns a promise that will resolve to\n * the result once loaded, or reject if the resource failed to load.  The data is loaded\n * using XMLHttpRequest, which means that in order to make requests to another origin,\n * the server must have Cross-Origin Resource Sharing (CORS) headers enabled.\n *\n * @param {Object} data Data that is posted with the resource.\n * @param {Object} [options] Object with the following properties:\n * @param {Object} [options.data] Data that is posted with the resource.\n * @param {String} [options.responseType] The type of response.  This controls the type of item returned.\n * @param {Object} [options.headers] Additional HTTP headers to send with the request, if any.\n * @param {String} [options.overrideMimeType] Overrides the MIME type returned by the server.\n * @returns {Promise.<Object>|undefined} a promise that will resolve to the requested data when loaded. Returns undefined if <code>request.throttle</code> is true and the request does not have high enough priority.\n *\n *\n * @example\n * resource.post(data)\n *   .then(function(result) {\n *       // use the result\n *   }).otherwise(function(error) {\n *       // an error occurred\n *   });\n *\n * @see {@link http://www.w3.org/TR/cors/|Cross-Origin Resource Sharing}\n * @see {@link http://wiki.commonjs.org/wiki/Promises/A|CommonJS Promises/A}\n */\nResource.prototype.post = function (data, options) {\n  Check.defined(\"data\", data);\n\n  options = defaultClone(options, {});\n  options.method = \"POST\";\n  options.data = data;\n\n  return this._makeRequest(options);\n};\n\n/**\n * Creates a Resource from a URL and calls post() on it.\n *\n * @param {Object} options A url or an object with the following properties\n * @param {String} options.url The url of the resource.\n * @param {Object} options.data Data that is posted with the resource.\n * @param {Object} [options.queryParameters] An object containing query parameters that will be sent when retrieving the resource.\n * @param {Object} [options.templateValues] Key/Value pairs that are used to replace template values (eg. {x}).\n * @param {Object} [options.headers={}] Additional HTTP headers that will be sent.\n * @param {DefaultProxy} [options.proxy] A proxy to be used when loading the resource.\n * @param {Resource~RetryCallback} [options.retryCallback] The Function to call when a request for this resource fails. If it returns true, the request will be retried.\n * @param {Number} [options.retryAttempts=0] The number of times the retryCallback should be called before giving up.\n * @param {Request} [options.request] A Request object that will be used. Intended for internal use only.\n * @param {String} [options.responseType] The type of response.  This controls the type of item returned.\n * @param {String} [options.overrideMimeType] Overrides the MIME type returned by the server.\n * @returns {Promise.<Object>|undefined} a promise that will resolve to the requested data when loaded. Returns undefined if <code>request.throttle</code> is true and the request does not have high enough priority.\n */\nResource.post = function (options) {\n  var resource = new Resource(options);\n  return resource.post(options.data, {\n    // Make copy of just the needed fields because headers can be passed to both the constructor and to post\n    responseType: options.responseType,\n    overrideMimeType: options.overrideMimeType,\n  });\n};\n\n/**\n * Asynchronously puts data to the given resource.  Returns a promise that will resolve to\n * the result once loaded, or reject if the resource failed to load.  The data is loaded\n * using XMLHttpRequest, which means that in order to make requests to another origin,\n * the server must have Cross-Origin Resource Sharing (CORS) headers enabled.\n *\n * @param {Object} data Data that is posted with the resource.\n * @param {Object} [options] Object with the following properties:\n * @param {String} [options.responseType] The type of response.  This controls the type of item returned.\n * @param {Object} [options.headers] Additional HTTP headers to send with the request, if any.\n * @param {String} [options.overrideMimeType] Overrides the MIME type returned by the server.\n * @returns {Promise.<Object>|undefined} a promise that will resolve to the requested data when loaded. Returns undefined if <code>request.throttle</code> is true and the request does not have high enough priority.\n *\n *\n * @example\n * resource.put(data)\n *   .then(function(result) {\n *       // use the result\n *   }).otherwise(function(error) {\n *       // an error occurred\n *   });\n *\n * @see {@link http://www.w3.org/TR/cors/|Cross-Origin Resource Sharing}\n * @see {@link http://wiki.commonjs.org/wiki/Promises/A|CommonJS Promises/A}\n */\nResource.prototype.put = function (data, options) {\n  Check.defined(\"data\", data);\n\n  options = defaultClone(options, {});\n  options.method = \"PUT\";\n  options.data = data;\n\n  return this._makeRequest(options);\n};\n\n/**\n * Creates a Resource from a URL and calls put() on it.\n *\n * @param {Object} options A url or an object with the following properties\n * @param {String} options.url The url of the resource.\n * @param {Object} options.data Data that is posted with the resource.\n * @param {Object} [options.queryParameters] An object containing query parameters that will be sent when retrieving the resource.\n * @param {Object} [options.templateValues] Key/Value pairs that are used to replace template values (eg. {x}).\n * @param {Object} [options.headers={}] Additional HTTP headers that will be sent.\n * @param {DefaultProxy} [options.proxy] A proxy to be used when loading the resource.\n * @param {Resource~RetryCallback} [options.retryCallback] The Function to call when a request for this resource fails. If it returns true, the request will be retried.\n * @param {Number} [options.retryAttempts=0] The number of times the retryCallback should be called before giving up.\n * @param {Request} [options.request] A Request object that will be used. Intended for internal use only.\n * @param {String} [options.responseType] The type of response.  This controls the type of item returned.\n * @param {String} [options.overrideMimeType] Overrides the MIME type returned by the server.\n * @returns {Promise.<Object>|undefined} a promise that will resolve to the requested data when loaded. Returns undefined if <code>request.throttle</code> is true and the request does not have high enough priority.\n */\nResource.put = function (options) {\n  var resource = new Resource(options);\n  return resource.put(options.data, {\n    // Make copy of just the needed fields because headers can be passed to both the constructor and to post\n    responseType: options.responseType,\n    overrideMimeType: options.overrideMimeType,\n  });\n};\n\n/**\n * Asynchronously patches data to the given resource.  Returns a promise that will resolve to\n * the result once loaded, or reject if the resource failed to load.  The data is loaded\n * using XMLHttpRequest, which means that in order to make requests to another origin,\n * the server must have Cross-Origin Resource Sharing (CORS) headers enabled.\n *\n * @param {Object} data Data that is posted with the resource.\n * @param {Object} [options] Object with the following properties:\n * @param {String} [options.responseType] The type of response.  This controls the type of item returned.\n * @param {Object} [options.headers] Additional HTTP headers to send with the request, if any.\n * @param {String} [options.overrideMimeType] Overrides the MIME type returned by the server.\n * @returns {Promise.<Object>|undefined} a promise that will resolve to the requested data when loaded. Returns undefined if <code>request.throttle</code> is true and the request does not have high enough priority.\n *\n *\n * @example\n * resource.patch(data)\n *   .then(function(result) {\n *       // use the result\n *   }).otherwise(function(error) {\n *       // an error occurred\n *   });\n *\n * @see {@link http://www.w3.org/TR/cors/|Cross-Origin Resource Sharing}\n * @see {@link http://wiki.commonjs.org/wiki/Promises/A|CommonJS Promises/A}\n */\nResource.prototype.patch = function (data, options) {\n  Check.defined(\"data\", data);\n\n  options = defaultClone(options, {});\n  options.method = \"PATCH\";\n  options.data = data;\n\n  return this._makeRequest(options);\n};\n\n/**\n * Creates a Resource from a URL and calls patch() on it.\n *\n * @param {Object} options A url or an object with the following properties\n * @param {String} options.url The url of the resource.\n * @param {Object} options.data Data that is posted with the resource.\n * @param {Object} [options.queryParameters] An object containing query parameters that will be sent when retrieving the resource.\n * @param {Object} [options.templateValues] Key/Value pairs that are used to replace template values (eg. {x}).\n * @param {Object} [options.headers={}] Additional HTTP headers that will be sent.\n * @param {DefaultProxy} [options.proxy] A proxy to be used when loading the resource.\n * @param {Resource~RetryCallback} [options.retryCallback] The Function to call when a request for this resource fails. If it returns true, the request will be retried.\n * @param {Number} [options.retryAttempts=0] The number of times the retryCallback should be called before giving up.\n * @param {Request} [options.request] A Request object that will be used. Intended for internal use only.\n * @param {String} [options.responseType] The type of response.  This controls the type of item returned.\n * @param {String} [options.overrideMimeType] Overrides the MIME type returned by the server.\n * @returns {Promise.<Object>|undefined} a promise that will resolve to the requested data when loaded. Returns undefined if <code>request.throttle</code> is true and the request does not have high enough priority.\n */\nResource.patch = function (options) {\n  var resource = new Resource(options);\n  return resource.patch(options.data, {\n    // Make copy of just the needed fields because headers can be passed to both the constructor and to post\n    responseType: options.responseType,\n    overrideMimeType: options.overrideMimeType,\n  });\n};\n\n/**\n * Contains implementations of functions that can be replaced for testing\n *\n * @private\n */\nResource._Implementations = {};\n\nfunction loadImageElement(url, crossOrigin, deferred) {\n  var image = new Image();\n\n  image.onload = function () {\n    deferred.resolve(image);\n  };\n\n  image.onerror = function (e) {\n    deferred.reject(e);\n  };\n\n  if (crossOrigin) {\n    if (TrustedServers.contains(url)) {\n      image.crossOrigin = \"use-credentials\";\n    } else {\n      image.crossOrigin = \"\";\n    }\n  }\n\n  image.src = url;\n}\n\nResource._Implementations.createImage = function (\n  request,\n  crossOrigin,\n  deferred,\n  flipY,\n  preferImageBitmap\n) {\n  var url = request.url;\n  // Passing an Image to createImageBitmap will force it to run on the main thread\n  // since DOM elements don't exist on workers. We convert it to a blob so it's non-blocking.\n  // See:\n  //    https://bugzilla.mozilla.org/show_bug.cgi?id=1044102#c38\n  //    https://bugs.chromium.org/p/chromium/issues/detail?id=580202#c10\n  Resource.supportsImageBitmapOptions()\n    .then(function (supportsImageBitmap) {\n      // We can only use ImageBitmap if we can flip on decode.\n      // See: https://github.com/CesiumGS/cesium/pull/7579#issuecomment-466146898\n      if (!(supportsImageBitmap && preferImageBitmap)) {\n        loadImageElement(url, crossOrigin, deferred);\n        return;\n      }\n      var responseType = \"blob\";\n      var method = \"GET\";\n      var xhrDeferred = when.defer();\n      var xhr = Resource._Implementations.loadWithXhr(\n        url,\n        responseType,\n        method,\n        undefined,\n        undefined,\n        xhrDeferred,\n        undefined,\n        undefined,\n        undefined\n      );\n\n      if (defined(xhr) && defined(xhr.abort)) {\n        request.cancelFunction = function () {\n          xhr.abort();\n        };\n      }\n      return xhrDeferred.promise\n        .then(function (blob) {\n          if (!defined(blob)) {\n            deferred.reject(\n              new RuntimeError(\n                \"Successfully retrieved \" +\n                  url +\n                  \" but it contained no content.\"\n              )\n            );\n            return;\n          }\n\n          return Resource.createImageBitmapFromBlob(blob, {\n            flipY: flipY,\n            premultiplyAlpha: false,\n          });\n        })\n        .then(deferred.resolve);\n    })\n    .otherwise(deferred.reject);\n};\n\n/**\n * Wrapper for createImageBitmap\n *\n * @private\n */\nResource.createImageBitmapFromBlob = function (blob, options) {\n  Check.defined(\"options\", options);\n  Check.typeOf.bool(\"options.flipY\", options.flipY);\n  Check.typeOf.bool(\"options.premultiplyAlpha\", options.premultiplyAlpha);\n\n  return createImageBitmap(blob, {\n    imageOrientation: options.flipY ? \"flipY\" : \"none\",\n    premultiplyAlpha: options.premultiplyAlpha ? \"premultiply\" : \"none\",\n  });\n};\n\nfunction decodeResponse(loadWithHttpResponse, responseType) {\n  switch (responseType) {\n    case \"text\":\n      return loadWithHttpResponse.toString(\"utf8\");\n    case \"json\":\n      return JSON.parse(loadWithHttpResponse.toString(\"utf8\"));\n    default:\n      return new Uint8Array(loadWithHttpResponse).buffer;\n  }\n}\n\nfunction loadWithHttpRequest(\n  url,\n  responseType,\n  method,\n  data,\n  headers,\n  deferred,\n  overrideMimeType\n) {\n  // Note: only the 'json' and 'text' responseTypes transforms the loaded buffer\n  /* eslint-disable no-undef */\n  var URL = require(\"url\").parse(url);\n  var http = URL.protocol === \"https:\" ? require(\"https\") : require(\"http\");\n  var zlib = require(\"zlib\");\n  /* eslint-enable no-undef */\n\n  var options = {\n    protocol: URL.protocol,\n    hostname: URL.hostname,\n    port: URL.port,\n    path: URL.path,\n    query: URL.query,\n    method: method,\n    headers: headers,\n  };\n\n  http\n    .request(options)\n    .on(\"response\", function (res) {\n      if (res.statusCode < 200 || res.statusCode >= 300) {\n        deferred.reject(\n          new RequestErrorEvent(res.statusCode, res, res.headers)\n        );\n        return;\n      }\n\n      var chunkArray = [];\n      res.on(\"data\", function (chunk) {\n        chunkArray.push(chunk);\n      });\n\n      res.on(\"end\", function () {\n        // eslint-disable-next-line no-undef\n        var result = Buffer.concat(chunkArray);\n        if (res.headers[\"content-encoding\"] === \"gzip\") {\n          zlib.gunzip(result, function (error, resultUnzipped) {\n            if (error) {\n              deferred.reject(\n                new RuntimeError(\"Error decompressing response.\")\n              );\n            } else {\n              deferred.resolve(decodeResponse(resultUnzipped, responseType));\n            }\n          });\n        } else {\n          deferred.resolve(decodeResponse(result, responseType));\n        }\n      });\n    })\n    .on(\"error\", function (e) {\n      deferred.reject(new RequestErrorEvent());\n    })\n    .end();\n}\n\nvar noXMLHttpRequest = typeof XMLHttpRequest === \"undefined\";\nResource._Implementations.loadWithXhr = function (\n  url,\n  responseType,\n  method,\n  data,\n  headers,\n  deferred,\n  overrideMimeType\n) {\n  var dataUriRegexResult = dataUriRegex.exec(url);\n  if (dataUriRegexResult !== null) {\n    deferred.resolve(decodeDataUri(dataUriRegexResult, responseType));\n    return;\n  }\n\n  if (noXMLHttpRequest) {\n    loadWithHttpRequest(\n      url,\n      responseType,\n      method,\n      data,\n      headers,\n      deferred,\n      overrideMimeType\n    );\n    return;\n  }\n\n  var xhr = new XMLHttpRequest();\n\n  if (TrustedServers.contains(url)) {\n    xhr.withCredentials = true;\n  }\n\n  xhr.open(method, url, true);\n\n  if (defined(overrideMimeType) && defined(xhr.overrideMimeType)) {\n    xhr.overrideMimeType(overrideMimeType);\n  }\n\n  if (defined(headers)) {\n    for (var key in headers) {\n      if (headers.hasOwnProperty(key)) {\n        xhr.setRequestHeader(key, headers[key]);\n      }\n    }\n  }\n\n  if (defined(responseType)) {\n    xhr.responseType = responseType;\n  }\n\n  // While non-standard, file protocol always returns a status of 0 on success\n  var localFile = false;\n  if (typeof url === \"string\") {\n    localFile =\n      url.indexOf(\"file://\") === 0 ||\n      (typeof window !== \"undefined\" && window.location.origin === \"file://\");\n  }\n\n  xhr.onload = function () {\n    if (\n      (xhr.status < 200 || xhr.status >= 300) &&\n      !(localFile && xhr.status === 0)\n    ) {\n      deferred.reject(\n        new RequestErrorEvent(\n          xhr.status,\n          xhr.response,\n          xhr.getAllResponseHeaders()\n        )\n      );\n      return;\n    }\n\n    var response = xhr.response;\n    var browserResponseType = xhr.responseType;\n\n    if (method === \"HEAD\" || method === \"OPTIONS\") {\n      var responseHeaderString = xhr.getAllResponseHeaders();\n      var splitHeaders = responseHeaderString.trim().split(/[\\r\\n]+/);\n\n      var responseHeaders = {};\n      splitHeaders.forEach(function (line) {\n        var parts = line.split(\": \");\n        var header = parts.shift();\n        responseHeaders[header] = parts.join(\": \");\n      });\n\n      deferred.resolve(responseHeaders);\n      return;\n    }\n\n    //All modern browsers will go into either the first or second if block or last else block.\n    //Other code paths support older browsers that either do not support the supplied responseType\n    //or do not support the xhr.response property.\n    if (xhr.status === 204) {\n      // accept no content\n      deferred.resolve();\n    } else if (\n      defined(response) &&\n      (!defined(responseType) || browserResponseType === responseType)\n    ) {\n      deferred.resolve(response);\n    } else if (responseType === \"json\" && typeof response === \"string\") {\n      try {\n        deferred.resolve(JSON.parse(response));\n      } catch (e) {\n        deferred.reject(e);\n      }\n    } else if (\n      (browserResponseType === \"\" || browserResponseType === \"document\") &&\n      defined(xhr.responseXML) &&\n      xhr.responseXML.hasChildNodes()\n    ) {\n      deferred.resolve(xhr.responseXML);\n    } else if (\n      (browserResponseType === \"\" || browserResponseType === \"text\") &&\n      defined(xhr.responseText)\n    ) {\n      deferred.resolve(xhr.responseText);\n    } else {\n      deferred.reject(\n        new RuntimeError(\"Invalid XMLHttpRequest response type.\")\n      );\n    }\n  };\n\n  xhr.onerror = function (e) {\n    deferred.reject(new RequestErrorEvent());\n  };\n\n  xhr.send(data);\n\n  return xhr;\n};\n\nResource._Implementations.loadAndExecuteScript = function (\n  url,\n  functionName,\n  deferred\n) {\n  return loadAndExecuteScript(url, functionName).otherwise(deferred.reject);\n};\n\n/**\n * The default implementations\n *\n * @private\n */\nResource._DefaultImplementations = {};\nResource._DefaultImplementations.createImage =\n  Resource._Implementations.createImage;\nResource._DefaultImplementations.loadWithXhr =\n  Resource._Implementations.loadWithXhr;\nResource._DefaultImplementations.loadAndExecuteScript =\n  Resource._Implementations.loadAndExecuteScript;\n\n/**\n * A resource instance initialized to the current browser location\n *\n * @type {Resource}\n * @constant\n */\nResource.DEFAULT = Object.freeze(\n  new Resource({\n    url:\n      typeof document === \"undefined\"\n        ? \"\"\n        : document.location.href.split(\"?\")[0],\n  })\n);\n\n/**\n * A function that returns the value of the property.\n * @callback Resource~RetryCallback\n *\n * @param {Resource} [resource] The resource that failed to load.\n * @param {Error} [error] The error that occurred during the loading of the resource.\n * @returns {Boolean|Promise<Boolean>} If true or a promise that resolved to true, the resource will be retried. Otherwise the failure will be returned.\n */\nexport default Resource;\n"]},"metadata":{},"sourceType":"module"}