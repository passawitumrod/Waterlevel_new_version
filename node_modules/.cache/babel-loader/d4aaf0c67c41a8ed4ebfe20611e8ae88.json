{"ast":null,"code":"import BoundingSphere from \"../Core/BoundingSphere.js\";\nimport Cartesian3 from \"../Core/Cartesian3.js\";\nimport Color from \"../Core/Color.js\";\nimport ColorGeometryInstanceAttribute from \"../Core/ColorGeometryInstanceAttribute.js\";\nimport CullingVolume from \"../Core/CullingVolume.js\";\nimport defaultValue from \"../Core/defaultValue.js\";\nimport defined from \"../Core/defined.js\";\nimport deprecationWarning from \"../Core/deprecationWarning.js\";\nimport destroyObject from \"../Core/destroyObject.js\";\nimport Ellipsoid from \"../Core/Ellipsoid.js\";\nimport getMagic from \"../Core/getMagic.js\";\nimport Intersect from \"../Core/Intersect.js\";\nimport JulianDate from \"../Core/JulianDate.js\";\nimport CesiumMath from \"../Core/Math.js\";\nimport Matrix3 from \"../Core/Matrix3.js\";\nimport Matrix4 from \"../Core/Matrix4.js\";\nimport OrientedBoundingBox from \"../Core/OrientedBoundingBox.js\";\nimport OrthographicFrustum from \"../Core/OrthographicFrustum.js\";\nimport Rectangle from \"../Core/Rectangle.js\";\nimport Request from \"../Core/Request.js\";\nimport RequestScheduler from \"../Core/RequestScheduler.js\";\nimport RequestState from \"../Core/RequestState.js\";\nimport RequestType from \"../Core/RequestType.js\";\nimport Resource from \"../Core/Resource.js\";\nimport RuntimeError from \"../Core/RuntimeError.js\";\nimport when from \"../ThirdParty/when.js\";\nimport Cesium3DTileContentFactory from \"./Cesium3DTileContentFactory.js\";\nimport Cesium3DTileContentState from \"./Cesium3DTileContentState.js\";\nimport Cesium3DTileOptimizationHint from \"./Cesium3DTileOptimizationHint.js\";\nimport Cesium3DTilePass from \"./Cesium3DTilePass.js\";\nimport Cesium3DTileRefine from \"./Cesium3DTileRefine.js\";\nimport Empty3DTileContent from \"./Empty3DTileContent.js\";\nimport SceneMode from \"./SceneMode.js\";\nimport TileBoundingRegion from \"./TileBoundingRegion.js\";\nimport TileBoundingSphere from \"./TileBoundingSphere.js\";\nimport TileOrientedBoundingBox from \"./TileOrientedBoundingBox.js\";\n/**\n * A tile in a {@link Cesium3DTileset}.  When a tile is first created, its content is not loaded;\n * the content is loaded on-demand when needed based on the view.\n * <p>\n * Do not construct this directly, instead access tiles through {@link Cesium3DTileset#tileVisible}.\n * </p>\n *\n * @alias Cesium3DTile\n * @constructor\n */\n\nfunction Cesium3DTile(tileset, baseResource, header, parent) {\n  this._tileset = tileset;\n  this._header = header;\n  var contentHeader = header.content;\n  /**\n   * The local transform of this tile.\n   * @type {Matrix4}\n   */\n\n  this.transform = defined(header.transform) ? Matrix4.unpack(header.transform) : Matrix4.clone(Matrix4.IDENTITY);\n  var parentTransform = defined(parent) ? parent.computedTransform : tileset.modelMatrix;\n  var computedTransform = Matrix4.multiply(parentTransform, this.transform, new Matrix4());\n  var parentInitialTransform = defined(parent) ? parent._initialTransform : Matrix4.IDENTITY;\n  this._initialTransform = Matrix4.multiply(parentInitialTransform, this.transform, new Matrix4());\n  /**\n   * The final computed transform of this tile.\n   * @type {Matrix4}\n   * @readonly\n   */\n\n  this.computedTransform = computedTransform;\n  this._boundingVolume = this.createBoundingVolume(header.boundingVolume, computedTransform);\n  this._boundingVolume2D = undefined;\n  var contentBoundingVolume;\n\n  if (defined(contentHeader) && defined(contentHeader.boundingVolume)) {\n    // Non-leaf tiles may have a content bounding-volume, which is a tight-fit bounding volume\n    // around only the features in the tile.  This box is useful for culling for rendering,\n    // but not for culling for traversing the tree since it does not guarantee spatial coherence, i.e.,\n    // since it only bounds features in the tile, not the entire tile, children may be\n    // outside of this box.\n    contentBoundingVolume = this.createBoundingVolume(contentHeader.boundingVolume, computedTransform);\n  }\n\n  this._contentBoundingVolume = contentBoundingVolume;\n  this._contentBoundingVolume2D = undefined;\n  var viewerRequestVolume;\n\n  if (defined(header.viewerRequestVolume)) {\n    viewerRequestVolume = this.createBoundingVolume(header.viewerRequestVolume, computedTransform);\n  }\n\n  this._viewerRequestVolume = viewerRequestVolume;\n  /**\n   * The error, in meters, introduced if this tile is rendered and its children are not.\n   * This is used to compute screen space error, i.e., the error measured in pixels.\n   *\n   * @type {Number}\n   * @readonly\n   */\n\n  this.geometricError = header.geometricError;\n  this._geometricError = header.geometricError;\n\n  if (!defined(this._geometricError)) {\n    this._geometricError = defined(parent) ? parent.geometricError : tileset._geometricError;\n\n    Cesium3DTile._deprecationWarning(\"geometricErrorUndefined\", \"Required property geometricError is undefined for this tile. Using parent's geometric error instead.\");\n  }\n\n  this.updateGeometricErrorScale();\n  var refine;\n\n  if (defined(header.refine)) {\n    if (header.refine === \"replace\" || header.refine === \"add\") {\n      Cesium3DTile._deprecationWarning(\"lowercase-refine\", 'This tile uses a lowercase refine \"' + header.refine + '\". Instead use \"' + header.refine.toUpperCase() + '\".');\n    }\n\n    refine = header.refine.toUpperCase() === \"REPLACE\" ? Cesium3DTileRefine.REPLACE : Cesium3DTileRefine.ADD;\n  } else if (defined(parent)) {\n    // Inherit from parent tile if omitted.\n    refine = parent.refine;\n  } else {\n    refine = Cesium3DTileRefine.REPLACE;\n  }\n  /**\n   * Specifies the type of refinement that is used when traversing this tile for rendering.\n   *\n   * @type {Cesium3DTileRefine}\n   * @readonly\n   * @private\n   */\n\n\n  this.refine = refine;\n  /**\n   * Gets the tile's children.\n   *\n   * @type {Cesium3DTile[]}\n   * @readonly\n   */\n\n  this.children = [];\n  /**\n   * This tile's parent or <code>undefined</code> if this tile is the root.\n   * <p>\n   * When a tile's content points to an external tileset JSON file, the external tileset's\n   * root tile's parent is not <code>undefined</code>; instead, the parent references\n   * the tile (with its content pointing to an external tileset JSON file) as if the two tilesets were merged.\n   * </p>\n   *\n   * @type {Cesium3DTile}\n   * @readonly\n   */\n\n  this.parent = parent;\n  var content;\n  var hasEmptyContent;\n  var contentState;\n  var contentResource;\n  var serverKey;\n  baseResource = Resource.createIfNeeded(baseResource);\n\n  if (defined(contentHeader)) {\n    var contentHeaderUri = contentHeader.uri;\n\n    if (defined(contentHeader.url)) {\n      Cesium3DTile._deprecationWarning(\"contentUrl\", 'This tileset JSON uses the \"content.url\" property which has been deprecated. Use \"content.uri\" instead.');\n\n      contentHeaderUri = contentHeader.url;\n    }\n\n    hasEmptyContent = false;\n    contentState = Cesium3DTileContentState.UNLOADED;\n    contentResource = baseResource.getDerivedResource({\n      url: contentHeaderUri\n    });\n    serverKey = RequestScheduler.getServerKey(contentResource.getUrlComponent());\n  } else {\n    content = new Empty3DTileContent(tileset, this);\n    hasEmptyContent = true;\n    contentState = Cesium3DTileContentState.READY;\n  }\n\n  this._content = content;\n  this._contentResource = contentResource;\n  this._contentState = contentState;\n  this._contentReadyToProcessPromise = undefined;\n  this._contentReadyPromise = undefined;\n  this._expiredContent = undefined;\n  this._serverKey = serverKey;\n  /**\n   * When <code>true</code>, the tile has no content.\n   *\n   * @type {Boolean}\n   * @readonly\n   *\n   * @private\n   */\n\n  this.hasEmptyContent = hasEmptyContent;\n  /**\n   * When <code>true</code>, the tile's content points to an external tileset.\n   * <p>\n   * This is <code>false</code> until the tile's content is loaded.\n   * </p>\n   *\n   * @type {Boolean}\n   * @readonly\n   *\n   * @private\n   */\n\n  this.hasTilesetContent = false;\n  /**\n   * The node in the tileset's LRU cache, used to determine when to unload a tile's content.\n   *\n   * See {@link Cesium3DTilesetCache}\n   *\n   * @type {DoublyLinkedListNode}\n   * @readonly\n   *\n   * @private\n   */\n\n  this.cacheNode = undefined;\n  var expire = header.expire;\n  var expireDuration;\n  var expireDate;\n\n  if (defined(expire)) {\n    expireDuration = expire.duration;\n\n    if (defined(expire.date)) {\n      expireDate = JulianDate.fromIso8601(expire.date);\n    }\n  }\n  /**\n   * The time in seconds after the tile's content is ready when the content expires and new content is requested.\n   *\n   * @type {Number}\n   */\n\n\n  this.expireDuration = expireDuration;\n  /**\n   * The date when the content expires and new content is requested.\n   *\n   * @type {JulianDate}\n   */\n\n  this.expireDate = expireDate;\n  /**\n   * The time when a style was last applied to this tile.\n   *\n   * @type {Number}\n   *\n   * @private\n   */\n\n  this.lastStyleTime = 0.0;\n  /**\n   * Marks whether the tile's children bounds are fully contained within the tile's bounds\n   *\n   * @type {Cesium3DTileOptimizationHint}\n   *\n   * @private\n   */\n\n  this._optimChildrenWithinParent = Cesium3DTileOptimizationHint.NOT_COMPUTED;\n  /**\n   * Tracks if the tile's relationship with a ClippingPlaneCollection has changed with regards\n   * to the ClippingPlaneCollection's state.\n   *\n   * @type {Boolean}\n   *\n   * @private\n   */\n\n  this.clippingPlanesDirty = false;\n  /**\n   * Tracks if the tile's request should be deferred until all non-deferred\n   * tiles load.\n   *\n   * @type {Boolean}\n   *\n   * @private\n   */\n\n  this.priorityDeferred = false; // Members that are updated every frame for tree traversal and rendering optimizations:\n\n  this._distanceToCamera = 0.0;\n  this._centerZDepth = 0.0;\n  this._screenSpaceError = 0.0;\n  this._screenSpaceErrorProgressiveResolution = 0.0; // The screen space error at a given screen height of tileset.progressiveResolutionHeightFraction * screenHeight\n\n  this._visibilityPlaneMask = 0;\n  this._visible = false;\n  this._inRequestVolume = false;\n  this._finalResolution = true;\n  this._depth = 0;\n  this._stackLength = 0;\n  this._selectionDepth = 0;\n  this._updatedVisibilityFrame = 0;\n  this._touchedFrame = 0;\n  this._visitedFrame = 0;\n  this._selectedFrame = 0;\n  this._requestedFrame = 0;\n  this._ancestorWithContent = undefined;\n  this._ancestorWithContentAvailable = undefined;\n  this._refines = false;\n  this._shouldSelect = false;\n  this._isClipped = true;\n  this._clippingPlanesState = 0; // encapsulates (_isClipped, clippingPlanes.enabled) and number/function\n\n  this._debugBoundingVolume = undefined;\n  this._debugContentBoundingVolume = undefined;\n  this._debugViewerRequestVolume = undefined;\n  this._debugColor = Color.fromRandom({\n    alpha: 1.0\n  });\n  this._debugColorizeTiles = false;\n  this._priority = 0.0; // The priority used for request sorting\n\n  this._priorityHolder = this; // Reference to the ancestor up the tree that holds the _foveatedFactor and _distanceToCamera for all tiles in the refinement chain.\n\n  this._priorityProgressiveResolution = false;\n  this._priorityProgressiveResolutionScreenSpaceErrorLeaf = false;\n  this._priorityReverseScreenSpaceError = 0.0;\n  this._foveatedFactor = 0.0;\n  this._wasMinPriorityChild = false; // Needed for knowing when to continue a refinement chain. Gets reset in updateTile in traversal and gets set in updateAndPushChildren in traversal.\n\n  this._loadTimestamp = new JulianDate();\n  this._commandsLength = 0;\n  this._color = undefined;\n  this._colorDirty = false;\n  this._request = undefined;\n} // This can be overridden for testing purposes\n\n\nCesium3DTile._deprecationWarning = deprecationWarning;\nObject.defineProperties(Cesium3DTile.prototype, {\n  /**\n   * The tileset containing this tile.\n   *\n   * @memberof Cesium3DTile.prototype\n   *\n   * @type {Cesium3DTileset}\n   * @readonly\n   */\n  tileset: {\n    get: function () {\n      return this._tileset;\n    }\n  },\n\n  /**\n   * The tile's content.  This represents the actual tile's payload,\n   * not the content's metadata in the tileset JSON file.\n   *\n   * @memberof Cesium3DTile.prototype\n   *\n   * @type {Cesium3DTileContent}\n   * @readonly\n   */\n  content: {\n    get: function () {\n      return this._content;\n    }\n  },\n\n  /**\n   * Get the tile's bounding volume.\n   *\n   * @memberof Cesium3DTile.prototype\n   *\n   * @type {TileBoundingVolume}\n   * @readonly\n   * @private\n   */\n  boundingVolume: {\n    get: function () {\n      return this._boundingVolume;\n    }\n  },\n\n  /**\n   * Get the bounding volume of the tile's contents.  This defaults to the\n   * tile's bounding volume when the content's bounding volume is\n   * <code>undefined</code>.\n   *\n   * @memberof Cesium3DTile.prototype\n   *\n   * @type {TileBoundingVolume}\n   * @readonly\n   * @private\n   */\n  contentBoundingVolume: {\n    get: function () {\n      return defaultValue(this._contentBoundingVolume, this._boundingVolume);\n    }\n  },\n\n  /**\n   * Get the bounding sphere derived from the tile's bounding volume.\n   *\n   * @memberof Cesium3DTile.prototype\n   *\n   * @type {BoundingSphere}\n   * @readonly\n   */\n  boundingSphere: {\n    get: function () {\n      return this._boundingVolume.boundingSphere;\n    }\n  },\n\n  /**\n   * Returns the <code>extras</code> property in the tileset JSON for this tile, which contains application specific metadata.\n   * Returns <code>undefined</code> if <code>extras</code> does not exist.\n   *\n   * @memberof Cesium3DTile.prototype\n   *\n   * @type {*}\n   * @readonly\n   * @see {@link https://github.com/CesiumGS/3d-tiles/tree/master/specification#specifying-extensions-and-application-specific-extras|Extras in the 3D Tiles specification.}\n   */\n  extras: {\n    get: function () {\n      return this._header.extras;\n    }\n  },\n\n  /**\n   * Gets or sets the tile's highlight color.\n   *\n   * @memberof Cesium3DTile.prototype\n   *\n   * @type {Color}\n   *\n   * @default {@link Color.WHITE}\n   *\n   * @private\n   */\n  color: {\n    get: function () {\n      if (!defined(this._color)) {\n        this._color = new Color();\n      }\n\n      return Color.clone(this._color);\n    },\n    set: function (value) {\n      this._color = Color.clone(value, this._color);\n      this._colorDirty = true;\n    }\n  },\n\n  /**\n   * Determines if the tile has available content to render.  <code>true</code> if the tile's\n   * content is ready or if it has expired content that renders while new content loads; otherwise,\n   * <code>false</code>.\n   *\n   * @memberof Cesium3DTile.prototype\n   *\n   * @type {Boolean}\n   * @readonly\n   *\n   * @private\n   */\n  contentAvailable: {\n    get: function () {\n      return this.contentReady && !this.hasEmptyContent && !this.hasTilesetContent || defined(this._expiredContent) && !this.contentFailed;\n    }\n  },\n\n  /**\n   * Determines if the tile's content is ready. This is automatically <code>true</code> for\n   * tile's with empty content.\n   *\n   * @memberof Cesium3DTile.prototype\n   *\n   * @type {Boolean}\n   * @readonly\n   *\n   * @private\n   */\n  contentReady: {\n    get: function () {\n      return this._contentState === Cesium3DTileContentState.READY;\n    }\n  },\n\n  /**\n   * Determines if the tile's content has not be requested. <code>true</code> if tile's\n   * content has not be requested; otherwise, <code>false</code>.\n   *\n   * @memberof Cesium3DTile.prototype\n   *\n   * @type {Boolean}\n   * @readonly\n   *\n   * @private\n   */\n  contentUnloaded: {\n    get: function () {\n      return this._contentState === Cesium3DTileContentState.UNLOADED;\n    }\n  },\n\n  /**\n   * Determines if the tile's content is expired. <code>true</code> if tile's\n   * content is expired; otherwise, <code>false</code>.\n   *\n   * @memberof Cesium3DTile.prototype\n   *\n   * @type {Boolean}\n   * @readonly\n   *\n   * @private\n   */\n  contentExpired: {\n    get: function () {\n      return this._contentState === Cesium3DTileContentState.EXPIRED;\n    }\n  },\n\n  /**\n   * Determines if the tile's content failed to load.  <code>true</code> if the tile's\n   * content failed to load; otherwise, <code>false</code>.\n   *\n   * @memberof Cesium3DTile.prototype\n   *\n   * @type {Boolean}\n   * @readonly\n   *\n   * @private\n   */\n  contentFailed: {\n    get: function () {\n      return this._contentState === Cesium3DTileContentState.FAILED;\n    }\n  },\n\n  /**\n   * Gets the promise that will be resolved when the tile's content is ready to process.\n   * This happens after the content is downloaded but before the content is ready\n   * to render.\n   * <p>\n   * The promise remains <code>undefined</code> until the tile's content is requested.\n   * </p>\n   *\n   * @type {Promise.<Cesium3DTileContent>}\n   * @readonly\n   *\n   * @private\n   */\n  contentReadyToProcessPromise: {\n    get: function () {\n      if (defined(this._contentReadyToProcessPromise)) {\n        return this._contentReadyToProcessPromise.promise;\n      }\n\n      return undefined;\n    }\n  },\n\n  /**\n   * Gets the promise that will be resolved when the tile's content is ready to render.\n   * <p>\n   * The promise remains <code>undefined</code> until the tile's content is requested.\n   * </p>\n   *\n   * @type {Promise.<Cesium3DTileContent>}\n   * @readonly\n   *\n   * @private\n   */\n  contentReadyPromise: {\n    get: function () {\n      if (defined(this._contentReadyPromise)) {\n        return this._contentReadyPromise.promise;\n      }\n\n      return undefined;\n    }\n  },\n\n  /**\n   * Returns the number of draw commands used by this tile.\n   *\n   * @readonly\n   *\n   * @private\n   */\n  commandsLength: {\n    get: function () {\n      return this._commandsLength;\n    }\n  }\n});\nvar scratchCartesian = new Cartesian3();\n\nfunction isPriorityDeferred(tile, frameState) {\n  var tileset = tile._tileset; // If closest point on line is inside the sphere then set foveatedFactor to 0. Otherwise, the dot product is with the line from camera to the point on the sphere that is closest to the line.\n\n  var camera = frameState.camera;\n  var boundingSphere = tile.boundingSphere;\n  var radius = boundingSphere.radius;\n  var scaledCameraDirection = Cartesian3.multiplyByScalar(camera.directionWC, tile._centerZDepth, scratchCartesian);\n  var closestPointOnLine = Cartesian3.add(camera.positionWC, scaledCameraDirection, scratchCartesian); // The distance from the camera's view direction to the tile.\n\n  var toLine = Cartesian3.subtract(closestPointOnLine, boundingSphere.center, scratchCartesian);\n  var distanceToCenterLine = Cartesian3.magnitude(toLine);\n  var notTouchingSphere = distanceToCenterLine > radius; // If camera's direction vector is inside the bounding sphere then consider\n  // this tile right along the line of sight and set _foveatedFactor to 0.\n  // Otherwise,_foveatedFactor is one minus the dot product of the camera's direction\n  // and the vector between the camera and the point on the bounding sphere closest to the view line.\n\n  if (notTouchingSphere) {\n    var toLineNormalized = Cartesian3.normalize(toLine, scratchCartesian);\n    var scaledToLine = Cartesian3.multiplyByScalar(toLineNormalized, radius, scratchCartesian);\n    var closestOnSphere = Cartesian3.add(boundingSphere.center, scaledToLine, scratchCartesian);\n    var toClosestOnSphere = Cartesian3.subtract(closestOnSphere, camera.positionWC, scratchCartesian);\n    var toClosestOnSphereNormalize = Cartesian3.normalize(toClosestOnSphere, scratchCartesian);\n    tile._foveatedFactor = 1.0 - Math.abs(Cartesian3.dot(camera.directionWC, toClosestOnSphereNormalize));\n  } else {\n    tile._foveatedFactor = 0.0;\n  } // Skip this feature if: non-skipLevelOfDetail and replace refine, if the foveated settings are turned off, if tile is progressive resolution and replace refine and skipLevelOfDetail (will help get rid of ancestor artifacts faster)\n  // Or if the tile is a preload of any kind\n\n\n  var replace = tile.refine === Cesium3DTileRefine.REPLACE;\n  var skipLevelOfDetail = tileset._skipLevelOfDetail;\n\n  if (replace && !skipLevelOfDetail || !tileset.foveatedScreenSpaceError || tileset.foveatedConeSize === 1.0 || tile._priorityProgressiveResolution && replace && skipLevelOfDetail || tileset._pass === Cesium3DTilePass.PRELOAD_FLIGHT || tileset._pass === Cesium3DTilePass.PRELOAD) {\n    return false;\n  }\n\n  var maximumFovatedFactor = 1.0 - Math.cos(camera.frustum.fov * 0.5); // 0.14 for fov = 60. NOTE very hard to defer vertically foveated tiles since max is based on fovy (which is fov). Lowering the 0.5 to a smaller fraction of the screen height will start to defer vertically foveated tiles.\n\n  var foveatedConeFactor = tileset.foveatedConeSize * maximumFovatedFactor; // If it's inside the user-defined view cone, then it should not be deferred.\n\n  if (tile._foveatedFactor <= foveatedConeFactor) {\n    return false;\n  } // Relax SSE based on how big the angle is between the tile and the edge of the foveated cone.\n\n\n  var range = maximumFovatedFactor - foveatedConeFactor;\n  var normalizedFoveatedFactor = CesiumMath.clamp((tile._foveatedFactor - foveatedConeFactor) / range, 0.0, 1.0);\n  var sseRelaxation = tileset.foveatedInterpolationCallback(tileset.foveatedMinimumScreenSpaceErrorRelaxation, tileset.maximumScreenSpaceError, normalizedFoveatedFactor);\n  var sse = tile._screenSpaceError === 0.0 && defined(tile.parent) ? tile.parent._screenSpaceError * 0.5 : tile._screenSpaceError;\n  return tileset.maximumScreenSpaceError - sseRelaxation <= sse;\n}\n\nvar scratchJulianDate = new JulianDate();\n/**\n * Get the tile's screen space error.\n *\n * @private\n */\n\nCesium3DTile.prototype.getScreenSpaceError = function (frameState, useParentGeometricError, progressiveResolutionHeightFraction) {\n  var tileset = this._tileset;\n  var heightFraction = defaultValue(progressiveResolutionHeightFraction, 1.0);\n  var parentGeometricError = defined(this.parent) ? this.parent.geometricError : tileset._geometricError;\n  var geometricError = useParentGeometricError ? parentGeometricError : this.geometricError;\n\n  if (geometricError === 0.0) {\n    // Leaf tiles do not have any error so save the computation\n    return 0.0;\n  }\n\n  var camera = frameState.camera;\n  var frustum = camera.frustum;\n  var context = frameState.context;\n  var width = context.drawingBufferWidth;\n  var height = context.drawingBufferHeight * heightFraction;\n  var error;\n\n  if (frameState.mode === SceneMode.SCENE2D || frustum instanceof OrthographicFrustum) {\n    if (defined(frustum._offCenterFrustum)) {\n      frustum = frustum._offCenterFrustum;\n    }\n\n    var pixelSize = Math.max(frustum.top - frustum.bottom, frustum.right - frustum.left) / Math.max(width, height);\n    error = geometricError / pixelSize;\n  } else {\n    // Avoid divide by zero when viewer is inside the tile\n    var distance = Math.max(this._distanceToCamera, CesiumMath.EPSILON7);\n    var sseDenominator = camera.frustum.sseDenominator;\n    error = geometricError * height / (distance * sseDenominator);\n\n    if (tileset.dynamicScreenSpaceError) {\n      var density = tileset._dynamicScreenSpaceErrorComputedDensity;\n      var factor = tileset.dynamicScreenSpaceErrorFactor;\n      var dynamicError = CesiumMath.fog(distance, density) * factor;\n      error -= dynamicError;\n    }\n  }\n\n  error /= frameState.pixelRatio;\n  return error;\n};\n\nfunction isPriorityProgressiveResolution(tileset, tile) {\n  if (tileset.progressiveResolutionHeightFraction <= 0.0 || tileset.progressiveResolutionHeightFraction > 0.5) {\n    return false;\n  }\n\n  var isProgressiveResolutionTile = tile._screenSpaceErrorProgressiveResolution > tileset._maximumScreenSpaceError; // Mark non-SSE leaves\n\n  tile._priorityProgressiveResolutionScreenSpaceErrorLeaf = false; // Needed for skipLOD\n\n  var parent = tile.parent;\n  var maximumScreenSpaceError = tileset._maximumScreenSpaceError;\n  var tilePasses = tile._screenSpaceErrorProgressiveResolution <= maximumScreenSpaceError;\n  var parentFails = defined(parent) && parent._screenSpaceErrorProgressiveResolution > maximumScreenSpaceError;\n\n  if (tilePasses && parentFails) {\n    // A progressive resolution SSE leaf, promote its priority as well\n    tile._priorityProgressiveResolutionScreenSpaceErrorLeaf = true;\n    isProgressiveResolutionTile = true;\n  }\n\n  return isProgressiveResolutionTile;\n}\n\nfunction getPriorityReverseScreenSpaceError(tileset, tile) {\n  var parent = tile.parent;\n  var useParentScreenSpaceError = defined(parent) && (!tileset._skipLevelOfDetail || tile._screenSpaceError === 0.0 || parent.hasTilesetContent);\n  var screenSpaceError = useParentScreenSpaceError ? parent._screenSpaceError : tile._screenSpaceError;\n  return tileset.root._screenSpaceError - screenSpaceError;\n}\n/**\n * Update the tile's visibility.\n *\n * @private\n */\n\n\nCesium3DTile.prototype.updateVisibility = function (frameState) {\n  var parent = this.parent;\n  var tileset = this._tileset;\n  var parentTransform = defined(parent) ? parent.computedTransform : tileset.modelMatrix;\n  var parentVisibilityPlaneMask = defined(parent) ? parent._visibilityPlaneMask : CullingVolume.MASK_INDETERMINATE;\n  this.updateTransform(parentTransform);\n  this._distanceToCamera = this.distanceToTile(frameState);\n  this._centerZDepth = this.distanceToTileCenter(frameState);\n  this._screenSpaceError = this.getScreenSpaceError(frameState, false);\n  this._screenSpaceErrorProgressiveResolution = this.getScreenSpaceError(frameState, false, tileset.progressiveResolutionHeightFraction);\n  this._visibilityPlaneMask = this.visibility(frameState, parentVisibilityPlaneMask); // Use parent's plane mask to speed up visibility test\n\n  this._visible = this._visibilityPlaneMask !== CullingVolume.MASK_OUTSIDE;\n  this._inRequestVolume = this.insideViewerRequestVolume(frameState);\n  this._priorityReverseScreenSpaceError = getPriorityReverseScreenSpaceError(tileset, this);\n  this._priorityProgressiveResolution = isPriorityProgressiveResolution(tileset, this);\n  this.priorityDeferred = isPriorityDeferred(this, frameState);\n};\n/**\n * Update whether the tile has expired.\n *\n * @private\n */\n\n\nCesium3DTile.prototype.updateExpiration = function () {\n  if (defined(this.expireDate) && this.contentReady && !this.hasEmptyContent) {\n    var now = JulianDate.now(scratchJulianDate);\n\n    if (JulianDate.lessThan(this.expireDate, now)) {\n      this._contentState = Cesium3DTileContentState.EXPIRED;\n      this._expiredContent = this._content;\n    }\n  }\n};\n\nfunction updateExpireDate(tile) {\n  if (defined(tile.expireDuration)) {\n    var expireDurationDate = JulianDate.now(scratchJulianDate);\n    JulianDate.addSeconds(expireDurationDate, tile.expireDuration, expireDurationDate);\n\n    if (defined(tile.expireDate)) {\n      if (JulianDate.lessThan(tile.expireDate, expireDurationDate)) {\n        JulianDate.clone(expireDurationDate, tile.expireDate);\n      }\n    } else {\n      tile.expireDate = JulianDate.clone(expireDurationDate);\n    }\n  }\n}\n\nfunction getContentFailedFunction(tile, tileset) {\n  return function (error) {\n    if (tile._contentState === Cesium3DTileContentState.PROCESSING) {\n      --tileset.statistics.numberOfTilesProcessing;\n    } else {\n      --tileset.statistics.numberOfPendingRequests;\n    }\n\n    tile._contentState = Cesium3DTileContentState.FAILED;\n\n    tile._contentReadyPromise.reject(error);\n\n    tile._contentReadyToProcessPromise.reject(error);\n  };\n}\n\nfunction createPriorityFunction(tile) {\n  return function () {\n    return tile._priority;\n  };\n}\n/**\n * Requests the tile's content.\n * <p>\n * The request may not be made if the Cesium Request Scheduler can't prioritize it.\n * </p>\n *\n * @private\n */\n\n\nCesium3DTile.prototype.requestContent = function () {\n  var that = this;\n  var tileset = this._tileset;\n\n  if (this.hasEmptyContent) {\n    return false;\n  }\n\n  var resource = this._contentResource.clone();\n\n  var expired = this.contentExpired;\n\n  if (expired) {\n    // Append a query parameter of the tile expiration date to prevent caching\n    resource.setQueryParameters({\n      expired: this.expireDate.toString()\n    });\n  }\n\n  var request = new Request({\n    throttle: true,\n    throttleByServer: true,\n    type: RequestType.TILES3D,\n    priorityFunction: createPriorityFunction(this),\n    serverKey: this._serverKey\n  });\n  this._request = request;\n  resource.request = request;\n  var promise = resource.fetchArrayBuffer();\n\n  if (!defined(promise)) {\n    return false;\n  }\n\n  var contentState = this._contentState;\n  this._contentState = Cesium3DTileContentState.LOADING;\n  this._contentReadyToProcessPromise = when.defer();\n  this._contentReadyPromise = when.defer();\n  var contentFailedFunction = getContentFailedFunction(this, tileset);\n  promise.then(function (arrayBuffer) {\n    if (that.isDestroyed()) {\n      // Tile is unloaded before the content finishes loading\n      contentFailedFunction();\n      return;\n    }\n\n    var uint8Array = new Uint8Array(arrayBuffer);\n    var magic = getMagic(uint8Array);\n    var contentFactory = Cesium3DTileContentFactory[magic];\n    var content; // Vector and Geometry tile rendering do not support the skip LOD optimization.\n\n    tileset._disableSkipLevelOfDetail = tileset._disableSkipLevelOfDetail || magic === \"vctr\" || magic === \"geom\";\n\n    if (defined(contentFactory)) {\n      content = contentFactory(tileset, that, that._contentResource, arrayBuffer, 0);\n    } else {\n      // The content may be json instead\n      content = Cesium3DTileContentFactory.json(tileset, that, that._contentResource, arrayBuffer, 0);\n      that.hasTilesetContent = true;\n    }\n\n    if (expired) {\n      that.expireDate = undefined;\n    }\n\n    that._content = content;\n    that._contentState = Cesium3DTileContentState.PROCESSING;\n\n    that._contentReadyToProcessPromise.resolve(content);\n\n    return content.readyPromise.then(function (content) {\n      if (that.isDestroyed()) {\n        // Tile is unloaded before the content finishes processing\n        contentFailedFunction();\n        return;\n      }\n\n      updateExpireDate(that); // Refresh style for expired content\n\n      that._selectedFrame = 0;\n      that.lastStyleTime = 0.0;\n      JulianDate.now(that._loadTimestamp);\n      that._contentState = Cesium3DTileContentState.READY;\n\n      that._contentReadyPromise.resolve(content);\n    });\n  }).otherwise(function (error) {\n    if (request.state === RequestState.CANCELLED) {\n      // Cancelled due to low priority - try again later.\n      that._contentState = contentState;\n      --tileset.statistics.numberOfPendingRequests;\n      ++tileset.statistics.numberOfAttemptedRequests;\n      return;\n    }\n\n    contentFailedFunction(error);\n  });\n  return true;\n};\n/**\n * Unloads the tile's content.\n *\n * @private\n */\n\n\nCesium3DTile.prototype.unloadContent = function () {\n  if (this.hasEmptyContent || this.hasTilesetContent) {\n    return;\n  }\n\n  this._content = this._content && this._content.destroy();\n  this._contentState = Cesium3DTileContentState.UNLOADED;\n  this._contentReadyToProcessPromise = undefined;\n  this._contentReadyPromise = undefined;\n  this.lastStyleTime = 0.0;\n  this.clippingPlanesDirty = this._clippingPlanesState === 0;\n  this._clippingPlanesState = 0;\n  this._debugColorizeTiles = false;\n  this._debugBoundingVolume = this._debugBoundingVolume && this._debugBoundingVolume.destroy();\n  this._debugContentBoundingVolume = this._debugContentBoundingVolume && this._debugContentBoundingVolume.destroy();\n  this._debugViewerRequestVolume = this._debugViewerRequestVolume && this._debugViewerRequestVolume.destroy();\n};\n\nvar scratchProjectedBoundingSphere = new BoundingSphere();\n\nfunction getBoundingVolume(tile, frameState) {\n  if (frameState.mode !== SceneMode.SCENE3D && !defined(tile._boundingVolume2D)) {\n    var boundingSphere = tile._boundingVolume.boundingSphere;\n    var sphere = BoundingSphere.projectTo2D(boundingSphere, frameState.mapProjection, scratchProjectedBoundingSphere);\n    tile._boundingVolume2D = new TileBoundingSphere(sphere.center, sphere.radius);\n  }\n\n  return frameState.mode !== SceneMode.SCENE3D ? tile._boundingVolume2D : tile._boundingVolume;\n}\n\nfunction getContentBoundingVolume(tile, frameState) {\n  if (frameState.mode !== SceneMode.SCENE3D && !defined(tile._contentBoundingVolume2D)) {\n    var boundingSphere = tile._contentBoundingVolume.boundingSphere;\n    var sphere = BoundingSphere.projectTo2D(boundingSphere, frameState.mapProjection, scratchProjectedBoundingSphere);\n    tile._contentBoundingVolume2D = new TileBoundingSphere(sphere.center, sphere.radius);\n  }\n\n  return frameState.mode !== SceneMode.SCENE3D ? tile._contentBoundingVolume2D : tile._contentBoundingVolume;\n}\n/**\n * Determines whether the tile's bounding volume intersects the culling volume.\n *\n * @param {FrameState} frameState The frame state.\n * @param {Number} parentVisibilityPlaneMask The parent's plane mask to speed up the visibility check.\n * @returns {Number} A plane mask as described above in {@link CullingVolume#computeVisibilityWithPlaneMask}.\n *\n * @private\n */\n\n\nCesium3DTile.prototype.visibility = function (frameState, parentVisibilityPlaneMask) {\n  var cullingVolume = frameState.cullingVolume;\n  var boundingVolume = getBoundingVolume(this, frameState);\n  var tileset = this._tileset;\n  var clippingPlanes = tileset.clippingPlanes;\n\n  if (defined(clippingPlanes) && clippingPlanes.enabled) {\n    var intersection = clippingPlanes.computeIntersectionWithBoundingVolume(boundingVolume, tileset.clippingPlanesOriginMatrix);\n    this._isClipped = intersection !== Intersect.INSIDE;\n\n    if (intersection === Intersect.OUTSIDE) {\n      return CullingVolume.MASK_OUTSIDE;\n    }\n  }\n\n  return cullingVolume.computeVisibilityWithPlaneMask(boundingVolume, parentVisibilityPlaneMask);\n};\n/**\n * Assuming the tile's bounding volume intersects the culling volume, determines\n * whether the tile's content's bounding volume intersects the culling volume.\n *\n * @param {FrameState} frameState The frame state.\n * @returns {Intersect} The result of the intersection: the tile's content is completely outside, completely inside, or intersecting the culling volume.\n *\n * @private\n */\n\n\nCesium3DTile.prototype.contentVisibility = function (frameState) {\n  // Assumes the tile's bounding volume intersects the culling volume already, so\n  // just return Intersect.INSIDE if there is no content bounding volume.\n  if (!defined(this._contentBoundingVolume)) {\n    return Intersect.INSIDE;\n  }\n\n  if (this._visibilityPlaneMask === CullingVolume.MASK_INSIDE) {\n    // The tile's bounding volume is completely inside the culling volume so\n    // the content bounding volume must also be inside.\n    return Intersect.INSIDE;\n  } // PERFORMANCE_IDEA: is it possible to burn less CPU on this test since we know the\n  // tile's (not the content's) bounding volume intersects the culling volume?\n\n\n  var cullingVolume = frameState.cullingVolume;\n  var boundingVolume = getContentBoundingVolume(this, frameState);\n  var tileset = this._tileset;\n  var clippingPlanes = tileset.clippingPlanes;\n\n  if (defined(clippingPlanes) && clippingPlanes.enabled) {\n    var intersection = clippingPlanes.computeIntersectionWithBoundingVolume(boundingVolume, tileset.clippingPlanesOriginMatrix);\n    this._isClipped = intersection !== Intersect.INSIDE;\n\n    if (intersection === Intersect.OUTSIDE) {\n      return Intersect.OUTSIDE;\n    }\n  }\n\n  return cullingVolume.computeVisibility(boundingVolume);\n};\n/**\n * Computes the (potentially approximate) distance from the closest point of the tile's bounding volume to the camera.\n *\n * @param {FrameState} frameState The frame state.\n * @returns {Number} The distance, in meters, or zero if the camera is inside the bounding volume.\n *\n * @private\n */\n\n\nCesium3DTile.prototype.distanceToTile = function (frameState) {\n  var boundingVolume = getBoundingVolume(this, frameState);\n  return boundingVolume.distanceToCamera(frameState);\n};\n\nvar scratchToTileCenter = new Cartesian3();\n/**\n * Computes the distance from the center of the tile's bounding volume to the camera's plane defined by its position and view direction.\n *\n * @param {FrameState} frameState The frame state.\n * @returns {Number} The distance, in meters.\n *\n * @private\n */\n\nCesium3DTile.prototype.distanceToTileCenter = function (frameState) {\n  var tileBoundingVolume = getBoundingVolume(this, frameState);\n  var boundingVolume = tileBoundingVolume.boundingVolume; // Gets the underlying OrientedBoundingBox or BoundingSphere\n\n  var toCenter = Cartesian3.subtract(boundingVolume.center, frameState.camera.positionWC, scratchToTileCenter);\n  return Cartesian3.dot(frameState.camera.directionWC, toCenter);\n};\n/**\n * Checks if the camera is inside the viewer request volume.\n *\n * @param {FrameState} frameState The frame state.\n * @returns {Boolean} Whether the camera is inside the volume.\n *\n * @private\n */\n\n\nCesium3DTile.prototype.insideViewerRequestVolume = function (frameState) {\n  var viewerRequestVolume = this._viewerRequestVolume;\n  return !defined(viewerRequestVolume) || viewerRequestVolume.distanceToCamera(frameState) === 0.0;\n};\n\nvar scratchMatrix = new Matrix3();\nvar scratchScale = new Cartesian3();\nvar scratchHalfAxes = new Matrix3();\nvar scratchCenter = new Cartesian3();\nvar scratchRectangle = new Rectangle();\nvar scratchOrientedBoundingBox = new OrientedBoundingBox();\nvar scratchTransform = new Matrix4();\n\nfunction createBox(box, transform, result) {\n  var center = Cartesian3.fromElements(box[0], box[1], box[2], scratchCenter);\n  var halfAxes = Matrix3.fromArray(box, 3, scratchHalfAxes); // Find the transformed center and halfAxes\n\n  center = Matrix4.multiplyByPoint(transform, center, center);\n  var rotationScale = Matrix4.getMatrix3(transform, scratchMatrix);\n  halfAxes = Matrix3.multiply(rotationScale, halfAxes, halfAxes);\n\n  if (defined(result)) {\n    result.update(center, halfAxes);\n    return result;\n  }\n\n  return new TileOrientedBoundingBox(center, halfAxes);\n}\n\nfunction createBoxFromTransformedRegion(region, transform, initialTransform, result) {\n  var rectangle = Rectangle.unpack(region, 0, scratchRectangle);\n  var minimumHeight = region[4];\n  var maximumHeight = region[5];\n  var orientedBoundingBox = OrientedBoundingBox.fromRectangle(rectangle, minimumHeight, maximumHeight, Ellipsoid.WGS84, scratchOrientedBoundingBox);\n  var center = orientedBoundingBox.center;\n  var halfAxes = orientedBoundingBox.halfAxes; // A region bounding volume is not transformed by the transform in the tileset JSON,\n  // but may be transformed by additional transforms applied in Cesium.\n  // This is why the transform is calculated as the difference between the initial transform and the current transform.\n\n  transform = Matrix4.multiplyTransformation(transform, Matrix4.inverseTransformation(initialTransform, scratchTransform), scratchTransform);\n  center = Matrix4.multiplyByPoint(transform, center, center);\n  var rotationScale = Matrix4.getMatrix3(transform, scratchMatrix);\n  halfAxes = Matrix3.multiply(rotationScale, halfAxes, halfAxes);\n\n  if (defined(result) && result instanceof TileOrientedBoundingBox) {\n    result.update(center, halfAxes);\n    return result;\n  }\n\n  return new TileOrientedBoundingBox(center, halfAxes);\n}\n\nfunction createRegion(region, transform, initialTransform, result) {\n  if (!Matrix4.equalsEpsilon(transform, initialTransform, CesiumMath.EPSILON8)) {\n    return createBoxFromTransformedRegion(region, transform, initialTransform, result);\n  }\n\n  if (defined(result)) {\n    return result;\n  }\n\n  var rectangleRegion = Rectangle.unpack(region, 0, scratchRectangle);\n  return new TileBoundingRegion({\n    rectangle: rectangleRegion,\n    minimumHeight: region[4],\n    maximumHeight: region[5]\n  });\n}\n\nfunction createSphere(sphere, transform, result) {\n  var center = Cartesian3.fromElements(sphere[0], sphere[1], sphere[2], scratchCenter);\n  var radius = sphere[3]; // Find the transformed center and radius\n\n  center = Matrix4.multiplyByPoint(transform, center, center);\n  var scale = Matrix4.getScale(transform, scratchScale);\n  var uniformScale = Cartesian3.maximumComponent(scale);\n  radius *= uniformScale;\n\n  if (defined(result)) {\n    result.update(center, radius);\n    return result;\n  }\n\n  return new TileBoundingSphere(center, radius);\n}\n/**\n * Create a bounding volume from the tile's bounding volume header.\n *\n * @param {Object} boundingVolumeHeader The tile's bounding volume header.\n * @param {Matrix4} transform The transform to apply to the bounding volume.\n * @param {TileBoundingVolume} [result] The object onto which to store the result.\n *\n * @returns {TileBoundingVolume} The modified result parameter or a new TileBoundingVolume instance if none was provided.\n *\n * @private\n */\n\n\nCesium3DTile.prototype.createBoundingVolume = function (boundingVolumeHeader, transform, result) {\n  if (!defined(boundingVolumeHeader)) {\n    throw new RuntimeError(\"boundingVolume must be defined\");\n  }\n\n  if (defined(boundingVolumeHeader.box)) {\n    return createBox(boundingVolumeHeader.box, transform, result);\n  }\n\n  if (defined(boundingVolumeHeader.region)) {\n    return createRegion(boundingVolumeHeader.region, transform, this._initialTransform, result);\n  }\n\n  if (defined(boundingVolumeHeader.sphere)) {\n    return createSphere(boundingVolumeHeader.sphere, transform, result);\n  }\n\n  throw new RuntimeError(\"boundingVolume must contain a sphere, region, or box\");\n};\n/**\n * Update the tile's transform. The transform is applied to the tile's bounding volumes.\n *\n * @private\n */\n\n\nCesium3DTile.prototype.updateTransform = function (parentTransform) {\n  parentTransform = defaultValue(parentTransform, Matrix4.IDENTITY);\n  var computedTransform = Matrix4.multiply(parentTransform, this.transform, scratchTransform);\n  var transformChanged = !Matrix4.equals(computedTransform, this.computedTransform);\n\n  if (!transformChanged) {\n    return;\n  }\n\n  Matrix4.clone(computedTransform, this.computedTransform); // Update the bounding volumes\n\n  var header = this._header;\n  var content = this._header.content;\n  this._boundingVolume = this.createBoundingVolume(header.boundingVolume, this.computedTransform, this._boundingVolume);\n\n  if (defined(this._contentBoundingVolume)) {\n    this._contentBoundingVolume = this.createBoundingVolume(content.boundingVolume, this.computedTransform, this._contentBoundingVolume);\n  }\n\n  if (defined(this._viewerRequestVolume)) {\n    this._viewerRequestVolume = this.createBoundingVolume(header.viewerRequestVolume, this.computedTransform, this._viewerRequestVolume);\n  }\n\n  this.updateGeometricErrorScale(); // Destroy the debug bounding volumes. They will be generated fresh.\n\n  this._debugBoundingVolume = this._debugBoundingVolume && this._debugBoundingVolume.destroy();\n  this._debugContentBoundingVolume = this._debugContentBoundingVolume && this._debugContentBoundingVolume.destroy();\n  this._debugViewerRequestVolume = this._debugViewerRequestVolume && this._debugViewerRequestVolume.destroy();\n};\n\nCesium3DTile.prototype.updateGeometricErrorScale = function () {\n  var scale = Matrix4.getScale(this.computedTransform, scratchScale);\n  var uniformScale = Cartesian3.maximumComponent(scale);\n  this.geometricError = this._geometricError * uniformScale;\n};\n\nfunction applyDebugSettings(tile, tileset, frameState, passOptions) {\n  if (!passOptions.isRender) {\n    return;\n  }\n\n  var hasContentBoundingVolume = defined(tile._header.content) && defined(tile._header.content.boundingVolume);\n  var empty = tile.hasEmptyContent || tile.hasTilesetContent;\n  var showVolume = tileset.debugShowBoundingVolume || tileset.debugShowContentBoundingVolume && !hasContentBoundingVolume;\n\n  if (showVolume) {\n    var color;\n\n    if (!tile._finalResolution) {\n      color = Color.YELLOW;\n    } else if (empty) {\n      color = Color.DARKGRAY;\n    } else {\n      color = Color.WHITE;\n    }\n\n    if (!defined(tile._debugBoundingVolume)) {\n      tile._debugBoundingVolume = tile._boundingVolume.createDebugVolume(color);\n    }\n\n    tile._debugBoundingVolume.update(frameState);\n\n    var attributes = tile._debugBoundingVolume.getGeometryInstanceAttributes(\"outline\");\n\n    attributes.color = ColorGeometryInstanceAttribute.toValue(color, attributes.color);\n  } else if (!showVolume && defined(tile._debugBoundingVolume)) {\n    tile._debugBoundingVolume = tile._debugBoundingVolume.destroy();\n  }\n\n  if (tileset.debugShowContentBoundingVolume && hasContentBoundingVolume) {\n    if (!defined(tile._debugContentBoundingVolume)) {\n      tile._debugContentBoundingVolume = tile._contentBoundingVolume.createDebugVolume(Color.BLUE);\n    }\n\n    tile._debugContentBoundingVolume.update(frameState);\n  } else if (!tileset.debugShowContentBoundingVolume && defined(tile._debugContentBoundingVolume)) {\n    tile._debugContentBoundingVolume = tile._debugContentBoundingVolume.destroy();\n  }\n\n  if (tileset.debugShowViewerRequestVolume && defined(tile._viewerRequestVolume)) {\n    if (!defined(tile._debugViewerRequestVolume)) {\n      tile._debugViewerRequestVolume = tile._viewerRequestVolume.createDebugVolume(Color.YELLOW);\n    }\n\n    tile._debugViewerRequestVolume.update(frameState);\n  } else if (!tileset.debugShowViewerRequestVolume && defined(tile._debugViewerRequestVolume)) {\n    tile._debugViewerRequestVolume = tile._debugViewerRequestVolume.destroy();\n  }\n\n  var debugColorizeTilesOn = tileset.debugColorizeTiles && !tile._debugColorizeTiles || defined(tileset._heatmap.tilePropertyName);\n  var debugColorizeTilesOff = !tileset.debugColorizeTiles && tile._debugColorizeTiles;\n\n  if (debugColorizeTilesOn) {\n    tileset._heatmap.colorize(tile, frameState); // Skipped if tileset._heatmap.tilePropertyName is undefined\n\n\n    tile._debugColorizeTiles = true;\n    tile.color = tile._debugColor;\n  } else if (debugColorizeTilesOff) {\n    tile._debugColorizeTiles = false;\n    tile.color = Color.WHITE;\n  }\n\n  if (tile._colorDirty) {\n    tile._colorDirty = false;\n\n    tile._content.applyDebugSettings(true, tile._color);\n  }\n\n  if (debugColorizeTilesOff) {\n    tileset.makeStyleDirty(); // Re-apply style now that colorize is switched off\n  }\n}\n\nfunction updateContent(tile, tileset, frameState) {\n  var content = tile._content;\n  var expiredContent = tile._expiredContent;\n\n  if (defined(expiredContent)) {\n    if (!tile.contentReady) {\n      // Render the expired content while the content loads\n      expiredContent.update(tileset, frameState);\n      return;\n    } // New content is ready, destroy expired content\n\n\n    tile._expiredContent.destroy();\n\n    tile._expiredContent = undefined;\n  }\n\n  content.update(tileset, frameState);\n}\n\nfunction updateClippingPlanes(tile, tileset) {\n  // Compute and compare ClippingPlanes state:\n  // - enabled-ness - are clipping planes enabled? is this tile clipped?\n  // - clipping plane count\n  // - clipping function (union v. intersection)\n  var clippingPlanes = tileset.clippingPlanes;\n  var currentClippingPlanesState = 0;\n\n  if (defined(clippingPlanes) && tile._isClipped && clippingPlanes.enabled) {\n    currentClippingPlanesState = clippingPlanes.clippingPlanesState;\n  } // If clippingPlaneState for tile changed, mark clippingPlanesDirty so content can update\n\n\n  if (currentClippingPlanesState !== tile._clippingPlanesState) {\n    tile._clippingPlanesState = currentClippingPlanesState;\n    tile.clippingPlanesDirty = true;\n  }\n}\n/**\n * Get the draw commands needed to render this tile.\n *\n * @private\n */\n\n\nCesium3DTile.prototype.update = function (tileset, frameState, passOptions) {\n  var initCommandLength = frameState.commandList.length;\n  updateClippingPlanes(this, tileset);\n  applyDebugSettings(this, tileset, frameState, passOptions);\n  updateContent(this, tileset, frameState);\n  this._commandsLength = frameState.commandList.length - initCommandLength;\n  this.clippingPlanesDirty = false; // reset after content update\n};\n\nvar scratchCommandList = [];\n/**\n * Processes the tile's content, e.g., create WebGL resources, to move from the PROCESSING to READY state.\n *\n * @param {Cesium3DTileset} tileset The tileset containing this tile.\n * @param {FrameState} frameState The frame state.\n *\n * @private\n */\n\nCesium3DTile.prototype.process = function (tileset, frameState) {\n  var savedCommandList = frameState.commandList;\n  frameState.commandList = scratchCommandList;\n\n  this._content.update(tileset, frameState);\n\n  scratchCommandList.length = 0;\n  frameState.commandList = savedCommandList;\n};\n\nfunction isolateDigits(normalizedValue, numberOfDigits, leftShift) {\n  var scaled = normalizedValue * Math.pow(10, numberOfDigits);\n  var integer = parseInt(scaled);\n  return integer * Math.pow(10, leftShift);\n}\n\nfunction priorityNormalizeAndClamp(value, minimum, maximum) {\n  return Math.max(CesiumMath.normalize(value, minimum, maximum) - CesiumMath.EPSILON7, 0.0); // Subtract epsilon since we only want decimal digits present in the output.\n}\n/**\n * Sets the priority of the tile based on distance and depth\n * @private\n */\n\n\nCesium3DTile.prototype.updatePriority = function () {\n  var tileset = this.tileset;\n  var preferLeaves = tileset.preferLeaves;\n  var minimumPriority = tileset._minimumPriority;\n  var maximumPriority = tileset._maximumPriority; // Combine priority systems together by mapping them into a base 10 number where each priority controls a specific set of digits in the number.\n  // For number priorities, map them to a 0.xxxxx number then left shift it up into a set number of digits before the decimal point. Chop of the fractional part then left shift again into the position it needs to go.\n  // For blending number priorities, normalize them to 0-1 and interpolate to get a combined 0-1 number, then proceed as normal.\n  // Booleans can just be 0 or 10^leftshift.\n  // Think of digits as penalties since smaller numbers are higher priority. If a tile has some large quantity or has a flag raised it's (usually) penalized for it, expressed as a higher number for the digit.\n  // Priority number format: preloadFlightDigits(1) | foveatedDeferDigits(1) | foveatedDigits(4) | preloadProgressiveResolutionDigits(1) | preferredSortingDigits(4) . depthDigits(the decimal digits)\n  // Certain flags like preferLeaves will flip / turn off certain digits to get desired load order.\n  // Setup leftShifts, digit counts, and scales (for booleans)\n\n  var digitsForANumber = 4;\n  var digitsForABoolean = 1;\n  var preferredSortingLeftShift = 0;\n  var preferredSortingDigitsCount = digitsForANumber;\n  var foveatedLeftShift = preferredSortingLeftShift + preferredSortingDigitsCount;\n  var foveatedDigitsCount = digitsForANumber;\n  var preloadProgressiveResolutionLeftShift = foveatedLeftShift + foveatedDigitsCount;\n  var preloadProgressiveResolutionDigitsCount = digitsForABoolean;\n  var preloadProgressiveResolutionScale = Math.pow(10, preloadProgressiveResolutionLeftShift);\n  var foveatedDeferLeftShift = preloadProgressiveResolutionLeftShift + preloadProgressiveResolutionDigitsCount;\n  var foveatedDeferDigitsCount = digitsForABoolean;\n  var foveatedDeferScale = Math.pow(10, foveatedDeferLeftShift);\n  var preloadFlightLeftShift = foveatedDeferLeftShift + foveatedDeferDigitsCount;\n  var preloadFlightScale = Math.pow(10, preloadFlightLeftShift); // Compute the digits for each priority\n\n  var depthDigits = priorityNormalizeAndClamp(this._depth, minimumPriority.depth, maximumPriority.depth);\n  depthDigits = preferLeaves ? 1.0 - depthDigits : depthDigits; // Map 0-1 then convert to digit. Include a distance sort when doing non-skipLOD and replacement refinement, helps things like non-skipLOD photogrammetry\n\n  var useDistance = !tileset._skipLevelOfDetail && this.refine === Cesium3DTileRefine.REPLACE;\n  var normalizedPreferredSorting = useDistance ? priorityNormalizeAndClamp(this._priorityHolder._distanceToCamera, minimumPriority.distance, maximumPriority.distance) : priorityNormalizeAndClamp(this._priorityReverseScreenSpaceError, minimumPriority.reverseScreenSpaceError, maximumPriority.reverseScreenSpaceError);\n  var preferredSortingDigits = isolateDigits(normalizedPreferredSorting, preferredSortingDigitsCount, preferredSortingLeftShift);\n  var preloadProgressiveResolutionDigits = this._priorityProgressiveResolution ? 0 : preloadProgressiveResolutionScale;\n  var normalizedFoveatedFactor = priorityNormalizeAndClamp(this._priorityHolder._foveatedFactor, minimumPriority.foveatedFactor, maximumPriority.foveatedFactor);\n  var foveatedDigits = isolateDigits(normalizedFoveatedFactor, foveatedDigitsCount, foveatedLeftShift);\n  var foveatedDeferDigits = this.priorityDeferred ? foveatedDeferScale : 0;\n  var preloadFlightDigits = tileset._pass === Cesium3DTilePass.PRELOAD_FLIGHT ? 0 : preloadFlightScale; // Get the final base 10 number\n\n  this._priority = depthDigits + preferredSortingDigits + preloadProgressiveResolutionDigits + foveatedDigits + foveatedDeferDigits + preloadFlightDigits;\n};\n/**\n * @private\n */\n\n\nCesium3DTile.prototype.isDestroyed = function () {\n  return false;\n};\n/**\n * @private\n */\n\n\nCesium3DTile.prototype.destroy = function () {\n  // For the interval between new content being requested and downloaded, expiredContent === content, so don't destroy twice\n  this._content = this._content && this._content.destroy();\n  this._expiredContent = this._expiredContent && !this._expiredContent.isDestroyed() && this._expiredContent.destroy();\n  this._debugBoundingVolume = this._debugBoundingVolume && this._debugBoundingVolume.destroy();\n  this._debugContentBoundingVolume = this._debugContentBoundingVolume && this._debugContentBoundingVolume.destroy();\n  this._debugViewerRequestVolume = this._debugViewerRequestVolume && this._debugViewerRequestVolume.destroy();\n  return destroyObject(this);\n};\n\nexport default Cesium3DTile;","map":{"version":3,"sources":["C:/Users/passa/Desktop/WaterLevelReact/node_modules/cesium/Source/Scene/Cesium3DTile.js"],"names":["BoundingSphere","Cartesian3","Color","ColorGeometryInstanceAttribute","CullingVolume","defaultValue","defined","deprecationWarning","destroyObject","Ellipsoid","getMagic","Intersect","JulianDate","CesiumMath","Matrix3","Matrix4","OrientedBoundingBox","OrthographicFrustum","Rectangle","Request","RequestScheduler","RequestState","RequestType","Resource","RuntimeError","when","Cesium3DTileContentFactory","Cesium3DTileContentState","Cesium3DTileOptimizationHint","Cesium3DTilePass","Cesium3DTileRefine","Empty3DTileContent","SceneMode","TileBoundingRegion","TileBoundingSphere","TileOrientedBoundingBox","Cesium3DTile","tileset","baseResource","header","parent","_tileset","_header","contentHeader","content","transform","unpack","clone","IDENTITY","parentTransform","computedTransform","modelMatrix","multiply","parentInitialTransform","_initialTransform","_boundingVolume","createBoundingVolume","boundingVolume","_boundingVolume2D","undefined","contentBoundingVolume","_contentBoundingVolume","_contentBoundingVolume2D","viewerRequestVolume","_viewerRequestVolume","geometricError","_geometricError","_deprecationWarning","updateGeometricErrorScale","refine","toUpperCase","REPLACE","ADD","children","hasEmptyContent","contentState","contentResource","serverKey","createIfNeeded","contentHeaderUri","uri","url","UNLOADED","getDerivedResource","getServerKey","getUrlComponent","READY","_content","_contentResource","_contentState","_contentReadyToProcessPromise","_contentReadyPromise","_expiredContent","_serverKey","hasTilesetContent","cacheNode","expire","expireDuration","expireDate","duration","date","fromIso8601","lastStyleTime","_optimChildrenWithinParent","NOT_COMPUTED","clippingPlanesDirty","priorityDeferred","_distanceToCamera","_centerZDepth","_screenSpaceError","_screenSpaceErrorProgressiveResolution","_visibilityPlaneMask","_visible","_inRequestVolume","_finalResolution","_depth","_stackLength","_selectionDepth","_updatedVisibilityFrame","_touchedFrame","_visitedFrame","_selectedFrame","_requestedFrame","_ancestorWithContent","_ancestorWithContentAvailable","_refines","_shouldSelect","_isClipped","_clippingPlanesState","_debugBoundingVolume","_debugContentBoundingVolume","_debugViewerRequestVolume","_debugColor","fromRandom","alpha","_debugColorizeTiles","_priority","_priorityHolder","_priorityProgressiveResolution","_priorityProgressiveResolutionScreenSpaceErrorLeaf","_priorityReverseScreenSpaceError","_foveatedFactor","_wasMinPriorityChild","_loadTimestamp","_commandsLength","_color","_colorDirty","_request","Object","defineProperties","prototype","get","boundingSphere","extras","color","set","value","contentAvailable","contentReady","contentFailed","contentUnloaded","contentExpired","EXPIRED","FAILED","contentReadyToProcessPromise","promise","contentReadyPromise","commandsLength","scratchCartesian","isPriorityDeferred","tile","frameState","camera","radius","scaledCameraDirection","multiplyByScalar","directionWC","closestPointOnLine","add","positionWC","toLine","subtract","center","distanceToCenterLine","magnitude","notTouchingSphere","toLineNormalized","normalize","scaledToLine","closestOnSphere","toClosestOnSphere","toClosestOnSphereNormalize","Math","abs","dot","replace","skipLevelOfDetail","_skipLevelOfDetail","foveatedScreenSpaceError","foveatedConeSize","_pass","PRELOAD_FLIGHT","PRELOAD","maximumFovatedFactor","cos","frustum","fov","foveatedConeFactor","range","normalizedFoveatedFactor","clamp","sseRelaxation","foveatedInterpolationCallback","foveatedMinimumScreenSpaceErrorRelaxation","maximumScreenSpaceError","sse","scratchJulianDate","getScreenSpaceError","useParentGeometricError","progressiveResolutionHeightFraction","heightFraction","parentGeometricError","context","width","drawingBufferWidth","height","drawingBufferHeight","error","mode","SCENE2D","_offCenterFrustum","pixelSize","max","top","bottom","right","left","distance","EPSILON7","sseDenominator","dynamicScreenSpaceError","density","_dynamicScreenSpaceErrorComputedDensity","factor","dynamicScreenSpaceErrorFactor","dynamicError","fog","pixelRatio","isPriorityProgressiveResolution","isProgressiveResolutionTile","_maximumScreenSpaceError","tilePasses","parentFails","getPriorityReverseScreenSpaceError","useParentScreenSpaceError","screenSpaceError","root","updateVisibility","parentVisibilityPlaneMask","MASK_INDETERMINATE","updateTransform","distanceToTile","distanceToTileCenter","visibility","MASK_OUTSIDE","insideViewerRequestVolume","updateExpiration","now","lessThan","updateExpireDate","expireDurationDate","addSeconds","getContentFailedFunction","PROCESSING","statistics","numberOfTilesProcessing","numberOfPendingRequests","reject","createPriorityFunction","requestContent","that","resource","expired","setQueryParameters","toString","request","throttle","throttleByServer","type","TILES3D","priorityFunction","fetchArrayBuffer","LOADING","defer","contentFailedFunction","then","arrayBuffer","isDestroyed","uint8Array","Uint8Array","magic","contentFactory","_disableSkipLevelOfDetail","json","resolve","readyPromise","otherwise","state","CANCELLED","numberOfAttemptedRequests","unloadContent","destroy","scratchProjectedBoundingSphere","getBoundingVolume","SCENE3D","sphere","projectTo2D","mapProjection","getContentBoundingVolume","cullingVolume","clippingPlanes","enabled","intersection","computeIntersectionWithBoundingVolume","clippingPlanesOriginMatrix","INSIDE","OUTSIDE","computeVisibilityWithPlaneMask","contentVisibility","MASK_INSIDE","computeVisibility","distanceToCamera","scratchToTileCenter","tileBoundingVolume","toCenter","scratchMatrix","scratchScale","scratchHalfAxes","scratchCenter","scratchRectangle","scratchOrientedBoundingBox","scratchTransform","createBox","box","result","fromElements","halfAxes","fromArray","multiplyByPoint","rotationScale","getMatrix3","update","createBoxFromTransformedRegion","region","initialTransform","rectangle","minimumHeight","maximumHeight","orientedBoundingBox","fromRectangle","WGS84","multiplyTransformation","inverseTransformation","createRegion","equalsEpsilon","EPSILON8","rectangleRegion","createSphere","scale","getScale","uniformScale","maximumComponent","boundingVolumeHeader","transformChanged","equals","applyDebugSettings","passOptions","isRender","hasContentBoundingVolume","empty","showVolume","debugShowBoundingVolume","debugShowContentBoundingVolume","YELLOW","DARKGRAY","WHITE","createDebugVolume","attributes","getGeometryInstanceAttributes","toValue","BLUE","debugShowViewerRequestVolume","debugColorizeTilesOn","debugColorizeTiles","_heatmap","tilePropertyName","debugColorizeTilesOff","colorize","makeStyleDirty","updateContent","expiredContent","updateClippingPlanes","currentClippingPlanesState","clippingPlanesState","initCommandLength","commandList","length","scratchCommandList","process","savedCommandList","isolateDigits","normalizedValue","numberOfDigits","leftShift","scaled","pow","integer","parseInt","priorityNormalizeAndClamp","minimum","maximum","updatePriority","preferLeaves","minimumPriority","_minimumPriority","maximumPriority","_maximumPriority","digitsForANumber","digitsForABoolean","preferredSortingLeftShift","preferredSortingDigitsCount","foveatedLeftShift","foveatedDigitsCount","preloadProgressiveResolutionLeftShift","preloadProgressiveResolutionDigitsCount","preloadProgressiveResolutionScale","foveatedDeferLeftShift","foveatedDeferDigitsCount","foveatedDeferScale","preloadFlightLeftShift","preloadFlightScale","depthDigits","depth","useDistance","normalizedPreferredSorting","reverseScreenSpaceError","preferredSortingDigits","preloadProgressiveResolutionDigits","foveatedFactor","foveatedDigits","foveatedDeferDigits","preloadFlightDigits"],"mappings":"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","sourcesContent":["import BoundingSphere from \"../Core/BoundingSphere.js\";\nimport Cartesian3 from \"../Core/Cartesian3.js\";\nimport Color from \"../Core/Color.js\";\nimport ColorGeometryInstanceAttribute from \"../Core/ColorGeometryInstanceAttribute.js\";\nimport CullingVolume from \"../Core/CullingVolume.js\";\nimport defaultValue from \"../Core/defaultValue.js\";\nimport defined from \"../Core/defined.js\";\nimport deprecationWarning from \"../Core/deprecationWarning.js\";\nimport destroyObject from \"../Core/destroyObject.js\";\nimport Ellipsoid from \"../Core/Ellipsoid.js\";\nimport getMagic from \"../Core/getMagic.js\";\nimport Intersect from \"../Core/Intersect.js\";\nimport JulianDate from \"../Core/JulianDate.js\";\nimport CesiumMath from \"../Core/Math.js\";\nimport Matrix3 from \"../Core/Matrix3.js\";\nimport Matrix4 from \"../Core/Matrix4.js\";\nimport OrientedBoundingBox from \"../Core/OrientedBoundingBox.js\";\nimport OrthographicFrustum from \"../Core/OrthographicFrustum.js\";\nimport Rectangle from \"../Core/Rectangle.js\";\nimport Request from \"../Core/Request.js\";\nimport RequestScheduler from \"../Core/RequestScheduler.js\";\nimport RequestState from \"../Core/RequestState.js\";\nimport RequestType from \"../Core/RequestType.js\";\nimport Resource from \"../Core/Resource.js\";\nimport RuntimeError from \"../Core/RuntimeError.js\";\nimport when from \"../ThirdParty/when.js\";\nimport Cesium3DTileContentFactory from \"./Cesium3DTileContentFactory.js\";\nimport Cesium3DTileContentState from \"./Cesium3DTileContentState.js\";\nimport Cesium3DTileOptimizationHint from \"./Cesium3DTileOptimizationHint.js\";\nimport Cesium3DTilePass from \"./Cesium3DTilePass.js\";\nimport Cesium3DTileRefine from \"./Cesium3DTileRefine.js\";\nimport Empty3DTileContent from \"./Empty3DTileContent.js\";\nimport SceneMode from \"./SceneMode.js\";\nimport TileBoundingRegion from \"./TileBoundingRegion.js\";\nimport TileBoundingSphere from \"./TileBoundingSphere.js\";\nimport TileOrientedBoundingBox from \"./TileOrientedBoundingBox.js\";\n\n/**\n * A tile in a {@link Cesium3DTileset}.  When a tile is first created, its content is not loaded;\n * the content is loaded on-demand when needed based on the view.\n * <p>\n * Do not construct this directly, instead access tiles through {@link Cesium3DTileset#tileVisible}.\n * </p>\n *\n * @alias Cesium3DTile\n * @constructor\n */\nfunction Cesium3DTile(tileset, baseResource, header, parent) {\n  this._tileset = tileset;\n  this._header = header;\n  var contentHeader = header.content;\n\n  /**\n   * The local transform of this tile.\n   * @type {Matrix4}\n   */\n  this.transform = defined(header.transform)\n    ? Matrix4.unpack(header.transform)\n    : Matrix4.clone(Matrix4.IDENTITY);\n\n  var parentTransform = defined(parent)\n    ? parent.computedTransform\n    : tileset.modelMatrix;\n  var computedTransform = Matrix4.multiply(\n    parentTransform,\n    this.transform,\n    new Matrix4()\n  );\n\n  var parentInitialTransform = defined(parent)\n    ? parent._initialTransform\n    : Matrix4.IDENTITY;\n  this._initialTransform = Matrix4.multiply(\n    parentInitialTransform,\n    this.transform,\n    new Matrix4()\n  );\n\n  /**\n   * The final computed transform of this tile.\n   * @type {Matrix4}\n   * @readonly\n   */\n  this.computedTransform = computedTransform;\n\n  this._boundingVolume = this.createBoundingVolume(\n    header.boundingVolume,\n    computedTransform\n  );\n  this._boundingVolume2D = undefined;\n\n  var contentBoundingVolume;\n\n  if (defined(contentHeader) && defined(contentHeader.boundingVolume)) {\n    // Non-leaf tiles may have a content bounding-volume, which is a tight-fit bounding volume\n    // around only the features in the tile.  This box is useful for culling for rendering,\n    // but not for culling for traversing the tree since it does not guarantee spatial coherence, i.e.,\n    // since it only bounds features in the tile, not the entire tile, children may be\n    // outside of this box.\n    contentBoundingVolume = this.createBoundingVolume(\n      contentHeader.boundingVolume,\n      computedTransform\n    );\n  }\n  this._contentBoundingVolume = contentBoundingVolume;\n  this._contentBoundingVolume2D = undefined;\n\n  var viewerRequestVolume;\n  if (defined(header.viewerRequestVolume)) {\n    viewerRequestVolume = this.createBoundingVolume(\n      header.viewerRequestVolume,\n      computedTransform\n    );\n  }\n  this._viewerRequestVolume = viewerRequestVolume;\n\n  /**\n   * The error, in meters, introduced if this tile is rendered and its children are not.\n   * This is used to compute screen space error, i.e., the error measured in pixels.\n   *\n   * @type {Number}\n   * @readonly\n   */\n  this.geometricError = header.geometricError;\n  this._geometricError = header.geometricError;\n\n  if (!defined(this._geometricError)) {\n    this._geometricError = defined(parent)\n      ? parent.geometricError\n      : tileset._geometricError;\n    Cesium3DTile._deprecationWarning(\n      \"geometricErrorUndefined\",\n      \"Required property geometricError is undefined for this tile. Using parent's geometric error instead.\"\n    );\n  }\n\n  this.updateGeometricErrorScale();\n\n  var refine;\n  if (defined(header.refine)) {\n    if (header.refine === \"replace\" || header.refine === \"add\") {\n      Cesium3DTile._deprecationWarning(\n        \"lowercase-refine\",\n        'This tile uses a lowercase refine \"' +\n          header.refine +\n          '\". Instead use \"' +\n          header.refine.toUpperCase() +\n          '\".'\n      );\n    }\n    refine =\n      header.refine.toUpperCase() === \"REPLACE\"\n        ? Cesium3DTileRefine.REPLACE\n        : Cesium3DTileRefine.ADD;\n  } else if (defined(parent)) {\n    // Inherit from parent tile if omitted.\n    refine = parent.refine;\n  } else {\n    refine = Cesium3DTileRefine.REPLACE;\n  }\n\n  /**\n   * Specifies the type of refinement that is used when traversing this tile for rendering.\n   *\n   * @type {Cesium3DTileRefine}\n   * @readonly\n   * @private\n   */\n  this.refine = refine;\n\n  /**\n   * Gets the tile's children.\n   *\n   * @type {Cesium3DTile[]}\n   * @readonly\n   */\n  this.children = [];\n\n  /**\n   * This tile's parent or <code>undefined</code> if this tile is the root.\n   * <p>\n   * When a tile's content points to an external tileset JSON file, the external tileset's\n   * root tile's parent is not <code>undefined</code>; instead, the parent references\n   * the tile (with its content pointing to an external tileset JSON file) as if the two tilesets were merged.\n   * </p>\n   *\n   * @type {Cesium3DTile}\n   * @readonly\n   */\n  this.parent = parent;\n\n  var content;\n  var hasEmptyContent;\n  var contentState;\n  var contentResource;\n  var serverKey;\n\n  baseResource = Resource.createIfNeeded(baseResource);\n\n  if (defined(contentHeader)) {\n    var contentHeaderUri = contentHeader.uri;\n    if (defined(contentHeader.url)) {\n      Cesium3DTile._deprecationWarning(\n        \"contentUrl\",\n        'This tileset JSON uses the \"content.url\" property which has been deprecated. Use \"content.uri\" instead.'\n      );\n      contentHeaderUri = contentHeader.url;\n    }\n    hasEmptyContent = false;\n    contentState = Cesium3DTileContentState.UNLOADED;\n    contentResource = baseResource.getDerivedResource({\n      url: contentHeaderUri,\n    });\n    serverKey = RequestScheduler.getServerKey(\n      contentResource.getUrlComponent()\n    );\n  } else {\n    content = new Empty3DTileContent(tileset, this);\n    hasEmptyContent = true;\n    contentState = Cesium3DTileContentState.READY;\n  }\n\n  this._content = content;\n  this._contentResource = contentResource;\n  this._contentState = contentState;\n  this._contentReadyToProcessPromise = undefined;\n  this._contentReadyPromise = undefined;\n  this._expiredContent = undefined;\n\n  this._serverKey = serverKey;\n\n  /**\n   * When <code>true</code>, the tile has no content.\n   *\n   * @type {Boolean}\n   * @readonly\n   *\n   * @private\n   */\n  this.hasEmptyContent = hasEmptyContent;\n\n  /**\n   * When <code>true</code>, the tile's content points to an external tileset.\n   * <p>\n   * This is <code>false</code> until the tile's content is loaded.\n   * </p>\n   *\n   * @type {Boolean}\n   * @readonly\n   *\n   * @private\n   */\n  this.hasTilesetContent = false;\n\n  /**\n   * The node in the tileset's LRU cache, used to determine when to unload a tile's content.\n   *\n   * See {@link Cesium3DTilesetCache}\n   *\n   * @type {DoublyLinkedListNode}\n   * @readonly\n   *\n   * @private\n   */\n  this.cacheNode = undefined;\n\n  var expire = header.expire;\n  var expireDuration;\n  var expireDate;\n  if (defined(expire)) {\n    expireDuration = expire.duration;\n    if (defined(expire.date)) {\n      expireDate = JulianDate.fromIso8601(expire.date);\n    }\n  }\n\n  /**\n   * The time in seconds after the tile's content is ready when the content expires and new content is requested.\n   *\n   * @type {Number}\n   */\n  this.expireDuration = expireDuration;\n\n  /**\n   * The date when the content expires and new content is requested.\n   *\n   * @type {JulianDate}\n   */\n  this.expireDate = expireDate;\n\n  /**\n   * The time when a style was last applied to this tile.\n   *\n   * @type {Number}\n   *\n   * @private\n   */\n  this.lastStyleTime = 0.0;\n\n  /**\n   * Marks whether the tile's children bounds are fully contained within the tile's bounds\n   *\n   * @type {Cesium3DTileOptimizationHint}\n   *\n   * @private\n   */\n  this._optimChildrenWithinParent = Cesium3DTileOptimizationHint.NOT_COMPUTED;\n\n  /**\n   * Tracks if the tile's relationship with a ClippingPlaneCollection has changed with regards\n   * to the ClippingPlaneCollection's state.\n   *\n   * @type {Boolean}\n   *\n   * @private\n   */\n  this.clippingPlanesDirty = false;\n\n  /**\n   * Tracks if the tile's request should be deferred until all non-deferred\n   * tiles load.\n   *\n   * @type {Boolean}\n   *\n   * @private\n   */\n  this.priorityDeferred = false;\n\n  // Members that are updated every frame for tree traversal and rendering optimizations:\n  this._distanceToCamera = 0.0;\n  this._centerZDepth = 0.0;\n  this._screenSpaceError = 0.0;\n  this._screenSpaceErrorProgressiveResolution = 0.0; // The screen space error at a given screen height of tileset.progressiveResolutionHeightFraction * screenHeight\n  this._visibilityPlaneMask = 0;\n  this._visible = false;\n  this._inRequestVolume = false;\n\n  this._finalResolution = true;\n  this._depth = 0;\n  this._stackLength = 0;\n  this._selectionDepth = 0;\n\n  this._updatedVisibilityFrame = 0;\n  this._touchedFrame = 0;\n  this._visitedFrame = 0;\n  this._selectedFrame = 0;\n  this._requestedFrame = 0;\n  this._ancestorWithContent = undefined;\n  this._ancestorWithContentAvailable = undefined;\n  this._refines = false;\n  this._shouldSelect = false;\n  this._isClipped = true;\n  this._clippingPlanesState = 0; // encapsulates (_isClipped, clippingPlanes.enabled) and number/function\n  this._debugBoundingVolume = undefined;\n  this._debugContentBoundingVolume = undefined;\n  this._debugViewerRequestVolume = undefined;\n  this._debugColor = Color.fromRandom({ alpha: 1.0 });\n  this._debugColorizeTiles = false;\n\n  this._priority = 0.0; // The priority used for request sorting\n  this._priorityHolder = this; // Reference to the ancestor up the tree that holds the _foveatedFactor and _distanceToCamera for all tiles in the refinement chain.\n  this._priorityProgressiveResolution = false;\n  this._priorityProgressiveResolutionScreenSpaceErrorLeaf = false;\n  this._priorityReverseScreenSpaceError = 0.0;\n  this._foveatedFactor = 0.0;\n  this._wasMinPriorityChild = false; // Needed for knowing when to continue a refinement chain. Gets reset in updateTile in traversal and gets set in updateAndPushChildren in traversal.\n\n  this._loadTimestamp = new JulianDate();\n\n  this._commandsLength = 0;\n\n  this._color = undefined;\n  this._colorDirty = false;\n\n  this._request = undefined;\n}\n\n// This can be overridden for testing purposes\nCesium3DTile._deprecationWarning = deprecationWarning;\n\nObject.defineProperties(Cesium3DTile.prototype, {\n  /**\n   * The tileset containing this tile.\n   *\n   * @memberof Cesium3DTile.prototype\n   *\n   * @type {Cesium3DTileset}\n   * @readonly\n   */\n  tileset: {\n    get: function () {\n      return this._tileset;\n    },\n  },\n\n  /**\n   * The tile's content.  This represents the actual tile's payload,\n   * not the content's metadata in the tileset JSON file.\n   *\n   * @memberof Cesium3DTile.prototype\n   *\n   * @type {Cesium3DTileContent}\n   * @readonly\n   */\n  content: {\n    get: function () {\n      return this._content;\n    },\n  },\n\n  /**\n   * Get the tile's bounding volume.\n   *\n   * @memberof Cesium3DTile.prototype\n   *\n   * @type {TileBoundingVolume}\n   * @readonly\n   * @private\n   */\n  boundingVolume: {\n    get: function () {\n      return this._boundingVolume;\n    },\n  },\n\n  /**\n   * Get the bounding volume of the tile's contents.  This defaults to the\n   * tile's bounding volume when the content's bounding volume is\n   * <code>undefined</code>.\n   *\n   * @memberof Cesium3DTile.prototype\n   *\n   * @type {TileBoundingVolume}\n   * @readonly\n   * @private\n   */\n  contentBoundingVolume: {\n    get: function () {\n      return defaultValue(this._contentBoundingVolume, this._boundingVolume);\n    },\n  },\n\n  /**\n   * Get the bounding sphere derived from the tile's bounding volume.\n   *\n   * @memberof Cesium3DTile.prototype\n   *\n   * @type {BoundingSphere}\n   * @readonly\n   */\n  boundingSphere: {\n    get: function () {\n      return this._boundingVolume.boundingSphere;\n    },\n  },\n\n  /**\n   * Returns the <code>extras</code> property in the tileset JSON for this tile, which contains application specific metadata.\n   * Returns <code>undefined</code> if <code>extras</code> does not exist.\n   *\n   * @memberof Cesium3DTile.prototype\n   *\n   * @type {*}\n   * @readonly\n   * @see {@link https://github.com/CesiumGS/3d-tiles/tree/master/specification#specifying-extensions-and-application-specific-extras|Extras in the 3D Tiles specification.}\n   */\n  extras: {\n    get: function () {\n      return this._header.extras;\n    },\n  },\n\n  /**\n   * Gets or sets the tile's highlight color.\n   *\n   * @memberof Cesium3DTile.prototype\n   *\n   * @type {Color}\n   *\n   * @default {@link Color.WHITE}\n   *\n   * @private\n   */\n  color: {\n    get: function () {\n      if (!defined(this._color)) {\n        this._color = new Color();\n      }\n      return Color.clone(this._color);\n    },\n    set: function (value) {\n      this._color = Color.clone(value, this._color);\n      this._colorDirty = true;\n    },\n  },\n\n  /**\n   * Determines if the tile has available content to render.  <code>true</code> if the tile's\n   * content is ready or if it has expired content that renders while new content loads; otherwise,\n   * <code>false</code>.\n   *\n   * @memberof Cesium3DTile.prototype\n   *\n   * @type {Boolean}\n   * @readonly\n   *\n   * @private\n   */\n  contentAvailable: {\n    get: function () {\n      return (\n        (this.contentReady &&\n          !this.hasEmptyContent &&\n          !this.hasTilesetContent) ||\n        (defined(this._expiredContent) && !this.contentFailed)\n      );\n    },\n  },\n\n  /**\n   * Determines if the tile's content is ready. This is automatically <code>true</code> for\n   * tile's with empty content.\n   *\n   * @memberof Cesium3DTile.prototype\n   *\n   * @type {Boolean}\n   * @readonly\n   *\n   * @private\n   */\n  contentReady: {\n    get: function () {\n      return this._contentState === Cesium3DTileContentState.READY;\n    },\n  },\n\n  /**\n   * Determines if the tile's content has not be requested. <code>true</code> if tile's\n   * content has not be requested; otherwise, <code>false</code>.\n   *\n   * @memberof Cesium3DTile.prototype\n   *\n   * @type {Boolean}\n   * @readonly\n   *\n   * @private\n   */\n  contentUnloaded: {\n    get: function () {\n      return this._contentState === Cesium3DTileContentState.UNLOADED;\n    },\n  },\n\n  /**\n   * Determines if the tile's content is expired. <code>true</code> if tile's\n   * content is expired; otherwise, <code>false</code>.\n   *\n   * @memberof Cesium3DTile.prototype\n   *\n   * @type {Boolean}\n   * @readonly\n   *\n   * @private\n   */\n  contentExpired: {\n    get: function () {\n      return this._contentState === Cesium3DTileContentState.EXPIRED;\n    },\n  },\n\n  /**\n   * Determines if the tile's content failed to load.  <code>true</code> if the tile's\n   * content failed to load; otherwise, <code>false</code>.\n   *\n   * @memberof Cesium3DTile.prototype\n   *\n   * @type {Boolean}\n   * @readonly\n   *\n   * @private\n   */\n  contentFailed: {\n    get: function () {\n      return this._contentState === Cesium3DTileContentState.FAILED;\n    },\n  },\n\n  /**\n   * Gets the promise that will be resolved when the tile's content is ready to process.\n   * This happens after the content is downloaded but before the content is ready\n   * to render.\n   * <p>\n   * The promise remains <code>undefined</code> until the tile's content is requested.\n   * </p>\n   *\n   * @type {Promise.<Cesium3DTileContent>}\n   * @readonly\n   *\n   * @private\n   */\n  contentReadyToProcessPromise: {\n    get: function () {\n      if (defined(this._contentReadyToProcessPromise)) {\n        return this._contentReadyToProcessPromise.promise;\n      }\n      return undefined;\n    },\n  },\n\n  /**\n   * Gets the promise that will be resolved when the tile's content is ready to render.\n   * <p>\n   * The promise remains <code>undefined</code> until the tile's content is requested.\n   * </p>\n   *\n   * @type {Promise.<Cesium3DTileContent>}\n   * @readonly\n   *\n   * @private\n   */\n  contentReadyPromise: {\n    get: function () {\n      if (defined(this._contentReadyPromise)) {\n        return this._contentReadyPromise.promise;\n      }\n      return undefined;\n    },\n  },\n\n  /**\n   * Returns the number of draw commands used by this tile.\n   *\n   * @readonly\n   *\n   * @private\n   */\n  commandsLength: {\n    get: function () {\n      return this._commandsLength;\n    },\n  },\n});\n\nvar scratchCartesian = new Cartesian3();\nfunction isPriorityDeferred(tile, frameState) {\n  var tileset = tile._tileset;\n\n  // If closest point on line is inside the sphere then set foveatedFactor to 0. Otherwise, the dot product is with the line from camera to the point on the sphere that is closest to the line.\n  var camera = frameState.camera;\n  var boundingSphere = tile.boundingSphere;\n  var radius = boundingSphere.radius;\n  var scaledCameraDirection = Cartesian3.multiplyByScalar(\n    camera.directionWC,\n    tile._centerZDepth,\n    scratchCartesian\n  );\n  var closestPointOnLine = Cartesian3.add(\n    camera.positionWC,\n    scaledCameraDirection,\n    scratchCartesian\n  );\n  // The distance from the camera's view direction to the tile.\n  var toLine = Cartesian3.subtract(\n    closestPointOnLine,\n    boundingSphere.center,\n    scratchCartesian\n  );\n  var distanceToCenterLine = Cartesian3.magnitude(toLine);\n  var notTouchingSphere = distanceToCenterLine > radius;\n\n  // If camera's direction vector is inside the bounding sphere then consider\n  // this tile right along the line of sight and set _foveatedFactor to 0.\n  // Otherwise,_foveatedFactor is one minus the dot product of the camera's direction\n  // and the vector between the camera and the point on the bounding sphere closest to the view line.\n  if (notTouchingSphere) {\n    var toLineNormalized = Cartesian3.normalize(toLine, scratchCartesian);\n    var scaledToLine = Cartesian3.multiplyByScalar(\n      toLineNormalized,\n      radius,\n      scratchCartesian\n    );\n    var closestOnSphere = Cartesian3.add(\n      boundingSphere.center,\n      scaledToLine,\n      scratchCartesian\n    );\n    var toClosestOnSphere = Cartesian3.subtract(\n      closestOnSphere,\n      camera.positionWC,\n      scratchCartesian\n    );\n    var toClosestOnSphereNormalize = Cartesian3.normalize(\n      toClosestOnSphere,\n      scratchCartesian\n    );\n    tile._foveatedFactor =\n      1.0 -\n      Math.abs(Cartesian3.dot(camera.directionWC, toClosestOnSphereNormalize));\n  } else {\n    tile._foveatedFactor = 0.0;\n  }\n\n  // Skip this feature if: non-skipLevelOfDetail and replace refine, if the foveated settings are turned off, if tile is progressive resolution and replace refine and skipLevelOfDetail (will help get rid of ancestor artifacts faster)\n  // Or if the tile is a preload of any kind\n  var replace = tile.refine === Cesium3DTileRefine.REPLACE;\n  var skipLevelOfDetail = tileset._skipLevelOfDetail;\n  if (\n    (replace && !skipLevelOfDetail) ||\n    !tileset.foveatedScreenSpaceError ||\n    tileset.foveatedConeSize === 1.0 ||\n    (tile._priorityProgressiveResolution && replace && skipLevelOfDetail) ||\n    tileset._pass === Cesium3DTilePass.PRELOAD_FLIGHT ||\n    tileset._pass === Cesium3DTilePass.PRELOAD\n  ) {\n    return false;\n  }\n\n  var maximumFovatedFactor = 1.0 - Math.cos(camera.frustum.fov * 0.5); // 0.14 for fov = 60. NOTE very hard to defer vertically foveated tiles since max is based on fovy (which is fov). Lowering the 0.5 to a smaller fraction of the screen height will start to defer vertically foveated tiles.\n  var foveatedConeFactor = tileset.foveatedConeSize * maximumFovatedFactor;\n\n  // If it's inside the user-defined view cone, then it should not be deferred.\n  if (tile._foveatedFactor <= foveatedConeFactor) {\n    return false;\n  }\n\n  // Relax SSE based on how big the angle is between the tile and the edge of the foveated cone.\n  var range = maximumFovatedFactor - foveatedConeFactor;\n  var normalizedFoveatedFactor = CesiumMath.clamp(\n    (tile._foveatedFactor - foveatedConeFactor) / range,\n    0.0,\n    1.0\n  );\n  var sseRelaxation = tileset.foveatedInterpolationCallback(\n    tileset.foveatedMinimumScreenSpaceErrorRelaxation,\n    tileset.maximumScreenSpaceError,\n    normalizedFoveatedFactor\n  );\n  var sse =\n    tile._screenSpaceError === 0.0 && defined(tile.parent)\n      ? tile.parent._screenSpaceError * 0.5\n      : tile._screenSpaceError;\n\n  return tileset.maximumScreenSpaceError - sseRelaxation <= sse;\n}\n\nvar scratchJulianDate = new JulianDate();\n\n/**\n * Get the tile's screen space error.\n *\n * @private\n */\nCesium3DTile.prototype.getScreenSpaceError = function (\n  frameState,\n  useParentGeometricError,\n  progressiveResolutionHeightFraction\n) {\n  var tileset = this._tileset;\n  var heightFraction = defaultValue(progressiveResolutionHeightFraction, 1.0);\n  var parentGeometricError = defined(this.parent)\n    ? this.parent.geometricError\n    : tileset._geometricError;\n  var geometricError = useParentGeometricError\n    ? parentGeometricError\n    : this.geometricError;\n  if (geometricError === 0.0) {\n    // Leaf tiles do not have any error so save the computation\n    return 0.0;\n  }\n  var camera = frameState.camera;\n  var frustum = camera.frustum;\n  var context = frameState.context;\n  var width = context.drawingBufferWidth;\n  var height = context.drawingBufferHeight * heightFraction;\n  var error;\n  if (\n    frameState.mode === SceneMode.SCENE2D ||\n    frustum instanceof OrthographicFrustum\n  ) {\n    if (defined(frustum._offCenterFrustum)) {\n      frustum = frustum._offCenterFrustum;\n    }\n    var pixelSize =\n      Math.max(frustum.top - frustum.bottom, frustum.right - frustum.left) /\n      Math.max(width, height);\n    error = geometricError / pixelSize;\n  } else {\n    // Avoid divide by zero when viewer is inside the tile\n    var distance = Math.max(this._distanceToCamera, CesiumMath.EPSILON7);\n    var sseDenominator = camera.frustum.sseDenominator;\n    error = (geometricError * height) / (distance * sseDenominator);\n    if (tileset.dynamicScreenSpaceError) {\n      var density = tileset._dynamicScreenSpaceErrorComputedDensity;\n      var factor = tileset.dynamicScreenSpaceErrorFactor;\n      var dynamicError = CesiumMath.fog(distance, density) * factor;\n      error -= dynamicError;\n    }\n  }\n\n  error /= frameState.pixelRatio;\n\n  return error;\n};\n\nfunction isPriorityProgressiveResolution(tileset, tile) {\n  if (\n    tileset.progressiveResolutionHeightFraction <= 0.0 ||\n    tileset.progressiveResolutionHeightFraction > 0.5\n  ) {\n    return false;\n  }\n\n  var isProgressiveResolutionTile =\n    tile._screenSpaceErrorProgressiveResolution >\n    tileset._maximumScreenSpaceError; // Mark non-SSE leaves\n  tile._priorityProgressiveResolutionScreenSpaceErrorLeaf = false; // Needed for skipLOD\n  var parent = tile.parent;\n  var maximumScreenSpaceError = tileset._maximumScreenSpaceError;\n  var tilePasses =\n    tile._screenSpaceErrorProgressiveResolution <= maximumScreenSpaceError;\n  var parentFails =\n    defined(parent) &&\n    parent._screenSpaceErrorProgressiveResolution > maximumScreenSpaceError;\n  if (tilePasses && parentFails) {\n    // A progressive resolution SSE leaf, promote its priority as well\n    tile._priorityProgressiveResolutionScreenSpaceErrorLeaf = true;\n    isProgressiveResolutionTile = true;\n  }\n  return isProgressiveResolutionTile;\n}\n\nfunction getPriorityReverseScreenSpaceError(tileset, tile) {\n  var parent = tile.parent;\n  var useParentScreenSpaceError =\n    defined(parent) &&\n    (!tileset._skipLevelOfDetail ||\n      tile._screenSpaceError === 0.0 ||\n      parent.hasTilesetContent);\n  var screenSpaceError = useParentScreenSpaceError\n    ? parent._screenSpaceError\n    : tile._screenSpaceError;\n  return tileset.root._screenSpaceError - screenSpaceError;\n}\n\n/**\n * Update the tile's visibility.\n *\n * @private\n */\nCesium3DTile.prototype.updateVisibility = function (frameState) {\n  var parent = this.parent;\n  var tileset = this._tileset;\n  var parentTransform = defined(parent)\n    ? parent.computedTransform\n    : tileset.modelMatrix;\n  var parentVisibilityPlaneMask = defined(parent)\n    ? parent._visibilityPlaneMask\n    : CullingVolume.MASK_INDETERMINATE;\n  this.updateTransform(parentTransform);\n  this._distanceToCamera = this.distanceToTile(frameState);\n  this._centerZDepth = this.distanceToTileCenter(frameState);\n  this._screenSpaceError = this.getScreenSpaceError(frameState, false);\n  this._screenSpaceErrorProgressiveResolution = this.getScreenSpaceError(\n    frameState,\n    false,\n    tileset.progressiveResolutionHeightFraction\n  );\n  this._visibilityPlaneMask = this.visibility(\n    frameState,\n    parentVisibilityPlaneMask\n  ); // Use parent's plane mask to speed up visibility test\n  this._visible = this._visibilityPlaneMask !== CullingVolume.MASK_OUTSIDE;\n  this._inRequestVolume = this.insideViewerRequestVolume(frameState);\n  this._priorityReverseScreenSpaceError = getPriorityReverseScreenSpaceError(\n    tileset,\n    this\n  );\n  this._priorityProgressiveResolution = isPriorityProgressiveResolution(\n    tileset,\n    this\n  );\n  this.priorityDeferred = isPriorityDeferred(this, frameState);\n};\n\n/**\n * Update whether the tile has expired.\n *\n * @private\n */\nCesium3DTile.prototype.updateExpiration = function () {\n  if (defined(this.expireDate) && this.contentReady && !this.hasEmptyContent) {\n    var now = JulianDate.now(scratchJulianDate);\n    if (JulianDate.lessThan(this.expireDate, now)) {\n      this._contentState = Cesium3DTileContentState.EXPIRED;\n      this._expiredContent = this._content;\n    }\n  }\n};\n\nfunction updateExpireDate(tile) {\n  if (defined(tile.expireDuration)) {\n    var expireDurationDate = JulianDate.now(scratchJulianDate);\n    JulianDate.addSeconds(\n      expireDurationDate,\n      tile.expireDuration,\n      expireDurationDate\n    );\n\n    if (defined(tile.expireDate)) {\n      if (JulianDate.lessThan(tile.expireDate, expireDurationDate)) {\n        JulianDate.clone(expireDurationDate, tile.expireDate);\n      }\n    } else {\n      tile.expireDate = JulianDate.clone(expireDurationDate);\n    }\n  }\n}\n\nfunction getContentFailedFunction(tile, tileset) {\n  return function (error) {\n    if (tile._contentState === Cesium3DTileContentState.PROCESSING) {\n      --tileset.statistics.numberOfTilesProcessing;\n    } else {\n      --tileset.statistics.numberOfPendingRequests;\n    }\n    tile._contentState = Cesium3DTileContentState.FAILED;\n    tile._contentReadyPromise.reject(error);\n    tile._contentReadyToProcessPromise.reject(error);\n  };\n}\n\nfunction createPriorityFunction(tile) {\n  return function () {\n    return tile._priority;\n  };\n}\n\n/**\n * Requests the tile's content.\n * <p>\n * The request may not be made if the Cesium Request Scheduler can't prioritize it.\n * </p>\n *\n * @private\n */\nCesium3DTile.prototype.requestContent = function () {\n  var that = this;\n  var tileset = this._tileset;\n\n  if (this.hasEmptyContent) {\n    return false;\n  }\n\n  var resource = this._contentResource.clone();\n  var expired = this.contentExpired;\n  if (expired) {\n    // Append a query parameter of the tile expiration date to prevent caching\n    resource.setQueryParameters({\n      expired: this.expireDate.toString(),\n    });\n  }\n\n  var request = new Request({\n    throttle: true,\n    throttleByServer: true,\n    type: RequestType.TILES3D,\n    priorityFunction: createPriorityFunction(this),\n    serverKey: this._serverKey,\n  });\n\n  this._request = request;\n  resource.request = request;\n\n  var promise = resource.fetchArrayBuffer();\n\n  if (!defined(promise)) {\n    return false;\n  }\n\n  var contentState = this._contentState;\n  this._contentState = Cesium3DTileContentState.LOADING;\n  this._contentReadyToProcessPromise = when.defer();\n  this._contentReadyPromise = when.defer();\n\n  var contentFailedFunction = getContentFailedFunction(this, tileset);\n  promise\n    .then(function (arrayBuffer) {\n      if (that.isDestroyed()) {\n        // Tile is unloaded before the content finishes loading\n        contentFailedFunction();\n        return;\n      }\n      var uint8Array = new Uint8Array(arrayBuffer);\n      var magic = getMagic(uint8Array);\n      var contentFactory = Cesium3DTileContentFactory[magic];\n      var content;\n\n      // Vector and Geometry tile rendering do not support the skip LOD optimization.\n      tileset._disableSkipLevelOfDetail =\n        tileset._disableSkipLevelOfDetail ||\n        magic === \"vctr\" ||\n        magic === \"geom\";\n\n      if (defined(contentFactory)) {\n        content = contentFactory(\n          tileset,\n          that,\n          that._contentResource,\n          arrayBuffer,\n          0\n        );\n      } else {\n        // The content may be json instead\n        content = Cesium3DTileContentFactory.json(\n          tileset,\n          that,\n          that._contentResource,\n          arrayBuffer,\n          0\n        );\n        that.hasTilesetContent = true;\n      }\n\n      if (expired) {\n        that.expireDate = undefined;\n      }\n\n      that._content = content;\n      that._contentState = Cesium3DTileContentState.PROCESSING;\n      that._contentReadyToProcessPromise.resolve(content);\n\n      return content.readyPromise.then(function (content) {\n        if (that.isDestroyed()) {\n          // Tile is unloaded before the content finishes processing\n          contentFailedFunction();\n          return;\n        }\n        updateExpireDate(that);\n\n        // Refresh style for expired content\n        that._selectedFrame = 0;\n        that.lastStyleTime = 0.0;\n\n        JulianDate.now(that._loadTimestamp);\n        that._contentState = Cesium3DTileContentState.READY;\n        that._contentReadyPromise.resolve(content);\n      });\n    })\n    .otherwise(function (error) {\n      if (request.state === RequestState.CANCELLED) {\n        // Cancelled due to low priority - try again later.\n        that._contentState = contentState;\n        --tileset.statistics.numberOfPendingRequests;\n        ++tileset.statistics.numberOfAttemptedRequests;\n        return;\n      }\n      contentFailedFunction(error);\n    });\n\n  return true;\n};\n\n/**\n * Unloads the tile's content.\n *\n * @private\n */\nCesium3DTile.prototype.unloadContent = function () {\n  if (this.hasEmptyContent || this.hasTilesetContent) {\n    return;\n  }\n\n  this._content = this._content && this._content.destroy();\n  this._contentState = Cesium3DTileContentState.UNLOADED;\n  this._contentReadyToProcessPromise = undefined;\n  this._contentReadyPromise = undefined;\n\n  this.lastStyleTime = 0.0;\n  this.clippingPlanesDirty = this._clippingPlanesState === 0;\n  this._clippingPlanesState = 0;\n\n  this._debugColorizeTiles = false;\n\n  this._debugBoundingVolume =\n    this._debugBoundingVolume && this._debugBoundingVolume.destroy();\n  this._debugContentBoundingVolume =\n    this._debugContentBoundingVolume &&\n    this._debugContentBoundingVolume.destroy();\n  this._debugViewerRequestVolume =\n    this._debugViewerRequestVolume && this._debugViewerRequestVolume.destroy();\n};\n\nvar scratchProjectedBoundingSphere = new BoundingSphere();\n\nfunction getBoundingVolume(tile, frameState) {\n  if (\n    frameState.mode !== SceneMode.SCENE3D &&\n    !defined(tile._boundingVolume2D)\n  ) {\n    var boundingSphere = tile._boundingVolume.boundingSphere;\n    var sphere = BoundingSphere.projectTo2D(\n      boundingSphere,\n      frameState.mapProjection,\n      scratchProjectedBoundingSphere\n    );\n    tile._boundingVolume2D = new TileBoundingSphere(\n      sphere.center,\n      sphere.radius\n    );\n  }\n\n  return frameState.mode !== SceneMode.SCENE3D\n    ? tile._boundingVolume2D\n    : tile._boundingVolume;\n}\n\nfunction getContentBoundingVolume(tile, frameState) {\n  if (\n    frameState.mode !== SceneMode.SCENE3D &&\n    !defined(tile._contentBoundingVolume2D)\n  ) {\n    var boundingSphere = tile._contentBoundingVolume.boundingSphere;\n    var sphere = BoundingSphere.projectTo2D(\n      boundingSphere,\n      frameState.mapProjection,\n      scratchProjectedBoundingSphere\n    );\n    tile._contentBoundingVolume2D = new TileBoundingSphere(\n      sphere.center,\n      sphere.radius\n    );\n  }\n  return frameState.mode !== SceneMode.SCENE3D\n    ? tile._contentBoundingVolume2D\n    : tile._contentBoundingVolume;\n}\n\n/**\n * Determines whether the tile's bounding volume intersects the culling volume.\n *\n * @param {FrameState} frameState The frame state.\n * @param {Number} parentVisibilityPlaneMask The parent's plane mask to speed up the visibility check.\n * @returns {Number} A plane mask as described above in {@link CullingVolume#computeVisibilityWithPlaneMask}.\n *\n * @private\n */\nCesium3DTile.prototype.visibility = function (\n  frameState,\n  parentVisibilityPlaneMask\n) {\n  var cullingVolume = frameState.cullingVolume;\n  var boundingVolume = getBoundingVolume(this, frameState);\n\n  var tileset = this._tileset;\n  var clippingPlanes = tileset.clippingPlanes;\n  if (defined(clippingPlanes) && clippingPlanes.enabled) {\n    var intersection = clippingPlanes.computeIntersectionWithBoundingVolume(\n      boundingVolume,\n      tileset.clippingPlanesOriginMatrix\n    );\n    this._isClipped = intersection !== Intersect.INSIDE;\n    if (intersection === Intersect.OUTSIDE) {\n      return CullingVolume.MASK_OUTSIDE;\n    }\n  }\n\n  return cullingVolume.computeVisibilityWithPlaneMask(\n    boundingVolume,\n    parentVisibilityPlaneMask\n  );\n};\n\n/**\n * Assuming the tile's bounding volume intersects the culling volume, determines\n * whether the tile's content's bounding volume intersects the culling volume.\n *\n * @param {FrameState} frameState The frame state.\n * @returns {Intersect} The result of the intersection: the tile's content is completely outside, completely inside, or intersecting the culling volume.\n *\n * @private\n */\nCesium3DTile.prototype.contentVisibility = function (frameState) {\n  // Assumes the tile's bounding volume intersects the culling volume already, so\n  // just return Intersect.INSIDE if there is no content bounding volume.\n  if (!defined(this._contentBoundingVolume)) {\n    return Intersect.INSIDE;\n  }\n\n  if (this._visibilityPlaneMask === CullingVolume.MASK_INSIDE) {\n    // The tile's bounding volume is completely inside the culling volume so\n    // the content bounding volume must also be inside.\n    return Intersect.INSIDE;\n  }\n\n  // PERFORMANCE_IDEA: is it possible to burn less CPU on this test since we know the\n  // tile's (not the content's) bounding volume intersects the culling volume?\n  var cullingVolume = frameState.cullingVolume;\n  var boundingVolume = getContentBoundingVolume(this, frameState);\n\n  var tileset = this._tileset;\n  var clippingPlanes = tileset.clippingPlanes;\n  if (defined(clippingPlanes) && clippingPlanes.enabled) {\n    var intersection = clippingPlanes.computeIntersectionWithBoundingVolume(\n      boundingVolume,\n      tileset.clippingPlanesOriginMatrix\n    );\n    this._isClipped = intersection !== Intersect.INSIDE;\n    if (intersection === Intersect.OUTSIDE) {\n      return Intersect.OUTSIDE;\n    }\n  }\n\n  return cullingVolume.computeVisibility(boundingVolume);\n};\n\n/**\n * Computes the (potentially approximate) distance from the closest point of the tile's bounding volume to the camera.\n *\n * @param {FrameState} frameState The frame state.\n * @returns {Number} The distance, in meters, or zero if the camera is inside the bounding volume.\n *\n * @private\n */\nCesium3DTile.prototype.distanceToTile = function (frameState) {\n  var boundingVolume = getBoundingVolume(this, frameState);\n  return boundingVolume.distanceToCamera(frameState);\n};\n\nvar scratchToTileCenter = new Cartesian3();\n\n/**\n * Computes the distance from the center of the tile's bounding volume to the camera's plane defined by its position and view direction.\n *\n * @param {FrameState} frameState The frame state.\n * @returns {Number} The distance, in meters.\n *\n * @private\n */\nCesium3DTile.prototype.distanceToTileCenter = function (frameState) {\n  var tileBoundingVolume = getBoundingVolume(this, frameState);\n  var boundingVolume = tileBoundingVolume.boundingVolume; // Gets the underlying OrientedBoundingBox or BoundingSphere\n  var toCenter = Cartesian3.subtract(\n    boundingVolume.center,\n    frameState.camera.positionWC,\n    scratchToTileCenter\n  );\n  return Cartesian3.dot(frameState.camera.directionWC, toCenter);\n};\n\n/**\n * Checks if the camera is inside the viewer request volume.\n *\n * @param {FrameState} frameState The frame state.\n * @returns {Boolean} Whether the camera is inside the volume.\n *\n * @private\n */\nCesium3DTile.prototype.insideViewerRequestVolume = function (frameState) {\n  var viewerRequestVolume = this._viewerRequestVolume;\n  return (\n    !defined(viewerRequestVolume) ||\n    viewerRequestVolume.distanceToCamera(frameState) === 0.0\n  );\n};\n\nvar scratchMatrix = new Matrix3();\nvar scratchScale = new Cartesian3();\nvar scratchHalfAxes = new Matrix3();\nvar scratchCenter = new Cartesian3();\nvar scratchRectangle = new Rectangle();\nvar scratchOrientedBoundingBox = new OrientedBoundingBox();\nvar scratchTransform = new Matrix4();\n\nfunction createBox(box, transform, result) {\n  var center = Cartesian3.fromElements(box[0], box[1], box[2], scratchCenter);\n  var halfAxes = Matrix3.fromArray(box, 3, scratchHalfAxes);\n\n  // Find the transformed center and halfAxes\n  center = Matrix4.multiplyByPoint(transform, center, center);\n  var rotationScale = Matrix4.getMatrix3(transform, scratchMatrix);\n  halfAxes = Matrix3.multiply(rotationScale, halfAxes, halfAxes);\n\n  if (defined(result)) {\n    result.update(center, halfAxes);\n    return result;\n  }\n  return new TileOrientedBoundingBox(center, halfAxes);\n}\n\nfunction createBoxFromTransformedRegion(\n  region,\n  transform,\n  initialTransform,\n  result\n) {\n  var rectangle = Rectangle.unpack(region, 0, scratchRectangle);\n  var minimumHeight = region[4];\n  var maximumHeight = region[5];\n\n  var orientedBoundingBox = OrientedBoundingBox.fromRectangle(\n    rectangle,\n    minimumHeight,\n    maximumHeight,\n    Ellipsoid.WGS84,\n    scratchOrientedBoundingBox\n  );\n  var center = orientedBoundingBox.center;\n  var halfAxes = orientedBoundingBox.halfAxes;\n\n  // A region bounding volume is not transformed by the transform in the tileset JSON,\n  // but may be transformed by additional transforms applied in Cesium.\n  // This is why the transform is calculated as the difference between the initial transform and the current transform.\n  transform = Matrix4.multiplyTransformation(\n    transform,\n    Matrix4.inverseTransformation(initialTransform, scratchTransform),\n    scratchTransform\n  );\n  center = Matrix4.multiplyByPoint(transform, center, center);\n  var rotationScale = Matrix4.getMatrix3(transform, scratchMatrix);\n  halfAxes = Matrix3.multiply(rotationScale, halfAxes, halfAxes);\n\n  if (defined(result) && result instanceof TileOrientedBoundingBox) {\n    result.update(center, halfAxes);\n    return result;\n  }\n\n  return new TileOrientedBoundingBox(center, halfAxes);\n}\n\nfunction createRegion(region, transform, initialTransform, result) {\n  if (\n    !Matrix4.equalsEpsilon(transform, initialTransform, CesiumMath.EPSILON8)\n  ) {\n    return createBoxFromTransformedRegion(\n      region,\n      transform,\n      initialTransform,\n      result\n    );\n  }\n\n  if (defined(result)) {\n    return result;\n  }\n\n  var rectangleRegion = Rectangle.unpack(region, 0, scratchRectangle);\n\n  return new TileBoundingRegion({\n    rectangle: rectangleRegion,\n    minimumHeight: region[4],\n    maximumHeight: region[5],\n  });\n}\n\nfunction createSphere(sphere, transform, result) {\n  var center = Cartesian3.fromElements(\n    sphere[0],\n    sphere[1],\n    sphere[2],\n    scratchCenter\n  );\n  var radius = sphere[3];\n\n  // Find the transformed center and radius\n  center = Matrix4.multiplyByPoint(transform, center, center);\n  var scale = Matrix4.getScale(transform, scratchScale);\n  var uniformScale = Cartesian3.maximumComponent(scale);\n  radius *= uniformScale;\n\n  if (defined(result)) {\n    result.update(center, radius);\n    return result;\n  }\n  return new TileBoundingSphere(center, radius);\n}\n\n/**\n * Create a bounding volume from the tile's bounding volume header.\n *\n * @param {Object} boundingVolumeHeader The tile's bounding volume header.\n * @param {Matrix4} transform The transform to apply to the bounding volume.\n * @param {TileBoundingVolume} [result] The object onto which to store the result.\n *\n * @returns {TileBoundingVolume} The modified result parameter or a new TileBoundingVolume instance if none was provided.\n *\n * @private\n */\nCesium3DTile.prototype.createBoundingVolume = function (\n  boundingVolumeHeader,\n  transform,\n  result\n) {\n  if (!defined(boundingVolumeHeader)) {\n    throw new RuntimeError(\"boundingVolume must be defined\");\n  }\n  if (defined(boundingVolumeHeader.box)) {\n    return createBox(boundingVolumeHeader.box, transform, result);\n  }\n  if (defined(boundingVolumeHeader.region)) {\n    return createRegion(\n      boundingVolumeHeader.region,\n      transform,\n      this._initialTransform,\n      result\n    );\n  }\n  if (defined(boundingVolumeHeader.sphere)) {\n    return createSphere(boundingVolumeHeader.sphere, transform, result);\n  }\n  throw new RuntimeError(\n    \"boundingVolume must contain a sphere, region, or box\"\n  );\n};\n\n/**\n * Update the tile's transform. The transform is applied to the tile's bounding volumes.\n *\n * @private\n */\nCesium3DTile.prototype.updateTransform = function (parentTransform) {\n  parentTransform = defaultValue(parentTransform, Matrix4.IDENTITY);\n  var computedTransform = Matrix4.multiply(\n    parentTransform,\n    this.transform,\n    scratchTransform\n  );\n  var transformChanged = !Matrix4.equals(\n    computedTransform,\n    this.computedTransform\n  );\n\n  if (!transformChanged) {\n    return;\n  }\n\n  Matrix4.clone(computedTransform, this.computedTransform);\n\n  // Update the bounding volumes\n  var header = this._header;\n  var content = this._header.content;\n  this._boundingVolume = this.createBoundingVolume(\n    header.boundingVolume,\n    this.computedTransform,\n    this._boundingVolume\n  );\n  if (defined(this._contentBoundingVolume)) {\n    this._contentBoundingVolume = this.createBoundingVolume(\n      content.boundingVolume,\n      this.computedTransform,\n      this._contentBoundingVolume\n    );\n  }\n  if (defined(this._viewerRequestVolume)) {\n    this._viewerRequestVolume = this.createBoundingVolume(\n      header.viewerRequestVolume,\n      this.computedTransform,\n      this._viewerRequestVolume\n    );\n  }\n\n  this.updateGeometricErrorScale();\n\n  // Destroy the debug bounding volumes. They will be generated fresh.\n  this._debugBoundingVolume =\n    this._debugBoundingVolume && this._debugBoundingVolume.destroy();\n  this._debugContentBoundingVolume =\n    this._debugContentBoundingVolume &&\n    this._debugContentBoundingVolume.destroy();\n  this._debugViewerRequestVolume =\n    this._debugViewerRequestVolume && this._debugViewerRequestVolume.destroy();\n};\n\nCesium3DTile.prototype.updateGeometricErrorScale = function () {\n  var scale = Matrix4.getScale(this.computedTransform, scratchScale);\n  var uniformScale = Cartesian3.maximumComponent(scale);\n  this.geometricError = this._geometricError * uniformScale;\n};\n\nfunction applyDebugSettings(tile, tileset, frameState, passOptions) {\n  if (!passOptions.isRender) {\n    return;\n  }\n\n  var hasContentBoundingVolume =\n    defined(tile._header.content) &&\n    defined(tile._header.content.boundingVolume);\n  var empty = tile.hasEmptyContent || tile.hasTilesetContent;\n\n  var showVolume =\n    tileset.debugShowBoundingVolume ||\n    (tileset.debugShowContentBoundingVolume && !hasContentBoundingVolume);\n  if (showVolume) {\n    var color;\n    if (!tile._finalResolution) {\n      color = Color.YELLOW;\n    } else if (empty) {\n      color = Color.DARKGRAY;\n    } else {\n      color = Color.WHITE;\n    }\n    if (!defined(tile._debugBoundingVolume)) {\n      tile._debugBoundingVolume = tile._boundingVolume.createDebugVolume(color);\n    }\n    tile._debugBoundingVolume.update(frameState);\n    var attributes = tile._debugBoundingVolume.getGeometryInstanceAttributes(\n      \"outline\"\n    );\n    attributes.color = ColorGeometryInstanceAttribute.toValue(\n      color,\n      attributes.color\n    );\n  } else if (!showVolume && defined(tile._debugBoundingVolume)) {\n    tile._debugBoundingVolume = tile._debugBoundingVolume.destroy();\n  }\n\n  if (tileset.debugShowContentBoundingVolume && hasContentBoundingVolume) {\n    if (!defined(tile._debugContentBoundingVolume)) {\n      tile._debugContentBoundingVolume = tile._contentBoundingVolume.createDebugVolume(\n        Color.BLUE\n      );\n    }\n    tile._debugContentBoundingVolume.update(frameState);\n  } else if (\n    !tileset.debugShowContentBoundingVolume &&\n    defined(tile._debugContentBoundingVolume)\n  ) {\n    tile._debugContentBoundingVolume = tile._debugContentBoundingVolume.destroy();\n  }\n\n  if (\n    tileset.debugShowViewerRequestVolume &&\n    defined(tile._viewerRequestVolume)\n  ) {\n    if (!defined(tile._debugViewerRequestVolume)) {\n      tile._debugViewerRequestVolume = tile._viewerRequestVolume.createDebugVolume(\n        Color.YELLOW\n      );\n    }\n    tile._debugViewerRequestVolume.update(frameState);\n  } else if (\n    !tileset.debugShowViewerRequestVolume &&\n    defined(tile._debugViewerRequestVolume)\n  ) {\n    tile._debugViewerRequestVolume = tile._debugViewerRequestVolume.destroy();\n  }\n\n  var debugColorizeTilesOn =\n    (tileset.debugColorizeTiles && !tile._debugColorizeTiles) ||\n    defined(tileset._heatmap.tilePropertyName);\n  var debugColorizeTilesOff =\n    !tileset.debugColorizeTiles && tile._debugColorizeTiles;\n\n  if (debugColorizeTilesOn) {\n    tileset._heatmap.colorize(tile, frameState); // Skipped if tileset._heatmap.tilePropertyName is undefined\n    tile._debugColorizeTiles = true;\n    tile.color = tile._debugColor;\n  } else if (debugColorizeTilesOff) {\n    tile._debugColorizeTiles = false;\n    tile.color = Color.WHITE;\n  }\n\n  if (tile._colorDirty) {\n    tile._colorDirty = false;\n    tile._content.applyDebugSettings(true, tile._color);\n  }\n\n  if (debugColorizeTilesOff) {\n    tileset.makeStyleDirty(); // Re-apply style now that colorize is switched off\n  }\n}\n\nfunction updateContent(tile, tileset, frameState) {\n  var content = tile._content;\n  var expiredContent = tile._expiredContent;\n\n  if (defined(expiredContent)) {\n    if (!tile.contentReady) {\n      // Render the expired content while the content loads\n      expiredContent.update(tileset, frameState);\n      return;\n    }\n\n    // New content is ready, destroy expired content\n    tile._expiredContent.destroy();\n    tile._expiredContent = undefined;\n  }\n\n  content.update(tileset, frameState);\n}\n\nfunction updateClippingPlanes(tile, tileset) {\n  // Compute and compare ClippingPlanes state:\n  // - enabled-ness - are clipping planes enabled? is this tile clipped?\n  // - clipping plane count\n  // - clipping function (union v. intersection)\n  var clippingPlanes = tileset.clippingPlanes;\n  var currentClippingPlanesState = 0;\n  if (defined(clippingPlanes) && tile._isClipped && clippingPlanes.enabled) {\n    currentClippingPlanesState = clippingPlanes.clippingPlanesState;\n  }\n  // If clippingPlaneState for tile changed, mark clippingPlanesDirty so content can update\n  if (currentClippingPlanesState !== tile._clippingPlanesState) {\n    tile._clippingPlanesState = currentClippingPlanesState;\n    tile.clippingPlanesDirty = true;\n  }\n}\n\n/**\n * Get the draw commands needed to render this tile.\n *\n * @private\n */\nCesium3DTile.prototype.update = function (tileset, frameState, passOptions) {\n  var initCommandLength = frameState.commandList.length;\n  updateClippingPlanes(this, tileset);\n  applyDebugSettings(this, tileset, frameState, passOptions);\n  updateContent(this, tileset, frameState);\n  this._commandsLength = frameState.commandList.length - initCommandLength;\n\n  this.clippingPlanesDirty = false; // reset after content update\n};\n\nvar scratchCommandList = [];\n\n/**\n * Processes the tile's content, e.g., create WebGL resources, to move from the PROCESSING to READY state.\n *\n * @param {Cesium3DTileset} tileset The tileset containing this tile.\n * @param {FrameState} frameState The frame state.\n *\n * @private\n */\nCesium3DTile.prototype.process = function (tileset, frameState) {\n  var savedCommandList = frameState.commandList;\n  frameState.commandList = scratchCommandList;\n\n  this._content.update(tileset, frameState);\n\n  scratchCommandList.length = 0;\n  frameState.commandList = savedCommandList;\n};\n\nfunction isolateDigits(normalizedValue, numberOfDigits, leftShift) {\n  var scaled = normalizedValue * Math.pow(10, numberOfDigits);\n  var integer = parseInt(scaled);\n  return integer * Math.pow(10, leftShift);\n}\n\nfunction priorityNormalizeAndClamp(value, minimum, maximum) {\n  return Math.max(\n    CesiumMath.normalize(value, minimum, maximum) - CesiumMath.EPSILON7,\n    0.0\n  ); // Subtract epsilon since we only want decimal digits present in the output.\n}\n\n/**\n * Sets the priority of the tile based on distance and depth\n * @private\n */\nCesium3DTile.prototype.updatePriority = function () {\n  var tileset = this.tileset;\n  var preferLeaves = tileset.preferLeaves;\n  var minimumPriority = tileset._minimumPriority;\n  var maximumPriority = tileset._maximumPriority;\n\n  // Combine priority systems together by mapping them into a base 10 number where each priority controls a specific set of digits in the number.\n  // For number priorities, map them to a 0.xxxxx number then left shift it up into a set number of digits before the decimal point. Chop of the fractional part then left shift again into the position it needs to go.\n  // For blending number priorities, normalize them to 0-1 and interpolate to get a combined 0-1 number, then proceed as normal.\n  // Booleans can just be 0 or 10^leftshift.\n  // Think of digits as penalties since smaller numbers are higher priority. If a tile has some large quantity or has a flag raised it's (usually) penalized for it, expressed as a higher number for the digit.\n  // Priority number format: preloadFlightDigits(1) | foveatedDeferDigits(1) | foveatedDigits(4) | preloadProgressiveResolutionDigits(1) | preferredSortingDigits(4) . depthDigits(the decimal digits)\n  // Certain flags like preferLeaves will flip / turn off certain digits to get desired load order.\n\n  // Setup leftShifts, digit counts, and scales (for booleans)\n  var digitsForANumber = 4;\n  var digitsForABoolean = 1;\n\n  var preferredSortingLeftShift = 0;\n  var preferredSortingDigitsCount = digitsForANumber;\n\n  var foveatedLeftShift =\n    preferredSortingLeftShift + preferredSortingDigitsCount;\n  var foveatedDigitsCount = digitsForANumber;\n\n  var preloadProgressiveResolutionLeftShift =\n    foveatedLeftShift + foveatedDigitsCount;\n  var preloadProgressiveResolutionDigitsCount = digitsForABoolean;\n  var preloadProgressiveResolutionScale = Math.pow(\n    10,\n    preloadProgressiveResolutionLeftShift\n  );\n\n  var foveatedDeferLeftShift =\n    preloadProgressiveResolutionLeftShift +\n    preloadProgressiveResolutionDigitsCount;\n  var foveatedDeferDigitsCount = digitsForABoolean;\n  var foveatedDeferScale = Math.pow(10, foveatedDeferLeftShift);\n\n  var preloadFlightLeftShift =\n    foveatedDeferLeftShift + foveatedDeferDigitsCount;\n  var preloadFlightScale = Math.pow(10, preloadFlightLeftShift);\n\n  // Compute the digits for each priority\n  var depthDigits = priorityNormalizeAndClamp(\n    this._depth,\n    minimumPriority.depth,\n    maximumPriority.depth\n  );\n  depthDigits = preferLeaves ? 1.0 - depthDigits : depthDigits;\n\n  // Map 0-1 then convert to digit. Include a distance sort when doing non-skipLOD and replacement refinement, helps things like non-skipLOD photogrammetry\n  var useDistance =\n    !tileset._skipLevelOfDetail && this.refine === Cesium3DTileRefine.REPLACE;\n  var normalizedPreferredSorting = useDistance\n    ? priorityNormalizeAndClamp(\n        this._priorityHolder._distanceToCamera,\n        minimumPriority.distance,\n        maximumPriority.distance\n      )\n    : priorityNormalizeAndClamp(\n        this._priorityReverseScreenSpaceError,\n        minimumPriority.reverseScreenSpaceError,\n        maximumPriority.reverseScreenSpaceError\n      );\n  var preferredSortingDigits = isolateDigits(\n    normalizedPreferredSorting,\n    preferredSortingDigitsCount,\n    preferredSortingLeftShift\n  );\n\n  var preloadProgressiveResolutionDigits = this._priorityProgressiveResolution\n    ? 0\n    : preloadProgressiveResolutionScale;\n\n  var normalizedFoveatedFactor = priorityNormalizeAndClamp(\n    this._priorityHolder._foveatedFactor,\n    minimumPriority.foveatedFactor,\n    maximumPriority.foveatedFactor\n  );\n  var foveatedDigits = isolateDigits(\n    normalizedFoveatedFactor,\n    foveatedDigitsCount,\n    foveatedLeftShift\n  );\n\n  var foveatedDeferDigits = this.priorityDeferred ? foveatedDeferScale : 0;\n\n  var preloadFlightDigits =\n    tileset._pass === Cesium3DTilePass.PRELOAD_FLIGHT ? 0 : preloadFlightScale;\n\n  // Get the final base 10 number\n  this._priority =\n    depthDigits +\n    preferredSortingDigits +\n    preloadProgressiveResolutionDigits +\n    foveatedDigits +\n    foveatedDeferDigits +\n    preloadFlightDigits;\n};\n\n/**\n * @private\n */\nCesium3DTile.prototype.isDestroyed = function () {\n  return false;\n};\n\n/**\n * @private\n */\nCesium3DTile.prototype.destroy = function () {\n  // For the interval between new content being requested and downloaded, expiredContent === content, so don't destroy twice\n  this._content = this._content && this._content.destroy();\n  this._expiredContent =\n    this._expiredContent &&\n    !this._expiredContent.isDestroyed() &&\n    this._expiredContent.destroy();\n  this._debugBoundingVolume =\n    this._debugBoundingVolume && this._debugBoundingVolume.destroy();\n  this._debugContentBoundingVolume =\n    this._debugContentBoundingVolume &&\n    this._debugContentBoundingVolume.destroy();\n  this._debugViewerRequestVolume =\n    this._debugViewerRequestVolume && this._debugViewerRequestVolume.destroy();\n  return destroyObject(this);\n};\nexport default Cesium3DTile;\n"]},"metadata":{},"sourceType":"module"}