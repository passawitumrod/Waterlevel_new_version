{"ast":null,"code":"import BoundingSphere from \"../Core/BoundingSphere.js\";\nimport Cartesian3 from \"../Core/Cartesian3.js\";\nimport ComponentDatatype from \"../Core/ComponentDatatype.js\";\nimport defined from \"../Core/defined.js\";\nimport FeatureDetection from \"../Core/FeatureDetection.js\";\nimport Geometry from \"../Core/Geometry.js\";\nimport GeometryAttribute from \"../Core/GeometryAttribute.js\";\nimport PrimitiveType from \"../Core/PrimitiveType.js\";\nimport BufferUsage from \"../Renderer/BufferUsage.js\";\nimport DrawCommand from \"../Renderer/DrawCommand.js\";\nimport Pass from \"../Renderer/Pass.js\";\nimport RenderState from \"../Renderer/RenderState.js\";\nimport ShaderProgram from \"../Renderer/ShaderProgram.js\";\nimport ShaderSource from \"../Renderer/ShaderSource.js\";\nimport VertexArray from \"../Renderer/VertexArray.js\";\nimport DepthPlaneFS from \"../Shaders/DepthPlaneFS.js\";\nimport DepthPlaneVS from \"../Shaders/DepthPlaneVS.js\";\nimport SceneMode from \"./SceneMode.js\";\n/**\n * @private\n */\n\nfunction DepthPlane() {\n  this._rs = undefined;\n  this._sp = undefined;\n  this._va = undefined;\n  this._command = undefined;\n  this._mode = undefined;\n  this._useLogDepth = false;\n}\n\nvar depthQuadScratch = FeatureDetection.supportsTypedArrays() ? new Float32Array(12) : [];\nvar scratchCartesian1 = new Cartesian3();\nvar scratchCartesian2 = new Cartesian3();\nvar scratchCartesian3 = new Cartesian3();\nvar scratchCartesian4 = new Cartesian3();\n\nfunction computeDepthQuad(ellipsoid, frameState) {\n  var radii = ellipsoid.radii;\n  var p = frameState.camera.positionWC; // Find the corresponding position in the scaled space of the ellipsoid.\n\n  var q = Cartesian3.multiplyComponents(ellipsoid.oneOverRadii, p, scratchCartesian1);\n  var qMagnitude = Cartesian3.magnitude(q);\n  var qUnit = Cartesian3.normalize(q, scratchCartesian2); // Determine the east and north directions at q.\n\n  var eUnit = Cartesian3.normalize(Cartesian3.cross(Cartesian3.UNIT_Z, q, scratchCartesian3), scratchCartesian3);\n  var nUnit = Cartesian3.normalize(Cartesian3.cross(qUnit, eUnit, scratchCartesian4), scratchCartesian4); // Determine the radius of the 'limb' of the ellipsoid.\n\n  var wMagnitude = Math.sqrt(Cartesian3.magnitudeSquared(q) - 1.0); // Compute the center and offsets.\n\n  var center = Cartesian3.multiplyByScalar(qUnit, 1.0 / qMagnitude, scratchCartesian1);\n  var scalar = wMagnitude / qMagnitude;\n  var eastOffset = Cartesian3.multiplyByScalar(eUnit, scalar, scratchCartesian2);\n  var northOffset = Cartesian3.multiplyByScalar(nUnit, scalar, scratchCartesian3); // A conservative measure for the longitudes would be to use the min/max longitudes of the bounding frustum.\n\n  var upperLeft = Cartesian3.add(center, northOffset, scratchCartesian4);\n  Cartesian3.subtract(upperLeft, eastOffset, upperLeft);\n  Cartesian3.multiplyComponents(radii, upperLeft, upperLeft);\n  Cartesian3.pack(upperLeft, depthQuadScratch, 0);\n  var lowerLeft = Cartesian3.subtract(center, northOffset, scratchCartesian4);\n  Cartesian3.subtract(lowerLeft, eastOffset, lowerLeft);\n  Cartesian3.multiplyComponents(radii, lowerLeft, lowerLeft);\n  Cartesian3.pack(lowerLeft, depthQuadScratch, 3);\n  var upperRight = Cartesian3.add(center, northOffset, scratchCartesian4);\n  Cartesian3.add(upperRight, eastOffset, upperRight);\n  Cartesian3.multiplyComponents(radii, upperRight, upperRight);\n  Cartesian3.pack(upperRight, depthQuadScratch, 6);\n  var lowerRight = Cartesian3.subtract(center, northOffset, scratchCartesian4);\n  Cartesian3.add(lowerRight, eastOffset, lowerRight);\n  Cartesian3.multiplyComponents(radii, lowerRight, lowerRight);\n  Cartesian3.pack(lowerRight, depthQuadScratch, 9);\n  return depthQuadScratch;\n}\n\nDepthPlane.prototype.update = function (frameState) {\n  this._mode = frameState.mode;\n\n  if (frameState.mode !== SceneMode.SCENE3D) {\n    return;\n  }\n\n  var context = frameState.context;\n  var ellipsoid = frameState.mapProjection.ellipsoid;\n  var useLogDepth = frameState.useLogDepth;\n\n  if (!defined(this._command)) {\n    this._rs = RenderState.fromCache({\n      // Write depth, not color\n      cull: {\n        enabled: true\n      },\n      depthTest: {\n        enabled: true\n      },\n      colorMask: {\n        red: false,\n        green: false,\n        blue: false,\n        alpha: false\n      }\n    });\n    this._command = new DrawCommand({\n      renderState: this._rs,\n      boundingVolume: new BoundingSphere(Cartesian3.ZERO, ellipsoid.maximumRadius),\n      pass: Pass.OPAQUE,\n      owner: this\n    });\n  }\n\n  if (!defined(this._sp) || this._useLogDepth !== useLogDepth) {\n    this._useLogDepth = useLogDepth;\n    var vs = new ShaderSource({\n      sources: [DepthPlaneVS]\n    });\n    var fs = new ShaderSource({\n      sources: [DepthPlaneFS]\n    });\n\n    if (useLogDepth) {\n      var extension = \"#ifdef GL_EXT_frag_depth \\n\" + \"#extension GL_EXT_frag_depth : enable \\n\" + \"#endif \\n\\n\";\n      fs.sources.push(extension);\n      fs.defines.push(\"LOG_DEPTH\");\n      vs.defines.push(\"LOG_DEPTH\");\n    }\n\n    this._sp = ShaderProgram.replaceCache({\n      shaderProgram: this._sp,\n      context: context,\n      vertexShaderSource: vs,\n      fragmentShaderSource: fs,\n      attributeLocations: {\n        position: 0\n      }\n    });\n    this._command.shaderProgram = this._sp;\n  } // update depth plane\n\n\n  var depthQuad = computeDepthQuad(ellipsoid, frameState); // depth plane\n\n  if (!defined(this._va)) {\n    var geometry = new Geometry({\n      attributes: {\n        position: new GeometryAttribute({\n          componentDatatype: ComponentDatatype.FLOAT,\n          componentsPerAttribute: 3,\n          values: depthQuad\n        })\n      },\n      indices: [0, 1, 2, 2, 1, 3],\n      primitiveType: PrimitiveType.TRIANGLES\n    });\n    this._va = VertexArray.fromGeometry({\n      context: context,\n      geometry: geometry,\n      attributeLocations: {\n        position: 0\n      },\n      bufferUsage: BufferUsage.DYNAMIC_DRAW\n    });\n    this._command.vertexArray = this._va;\n  } else {\n    this._va.getAttribute(0).vertexBuffer.copyFromArrayView(depthQuad);\n  }\n};\n\nDepthPlane.prototype.execute = function (context, passState) {\n  if (this._mode === SceneMode.SCENE3D) {\n    this._command.execute(context, passState);\n  }\n};\n\nDepthPlane.prototype.isDestroyed = function () {\n  return false;\n};\n\nDepthPlane.prototype.destroy = function () {\n  this._sp = this._sp && this._sp.destroy();\n  this._va = this._va && this._va.destroy();\n};\n\nexport default DepthPlane;","map":{"version":3,"sources":["C:/Users/passa/Desktop/WaterDeployTrial/node_modules/cesium/Source/Scene/DepthPlane.js"],"names":["BoundingSphere","Cartesian3","ComponentDatatype","defined","FeatureDetection","Geometry","GeometryAttribute","PrimitiveType","BufferUsage","DrawCommand","Pass","RenderState","ShaderProgram","ShaderSource","VertexArray","DepthPlaneFS","DepthPlaneVS","SceneMode","DepthPlane","_rs","undefined","_sp","_va","_command","_mode","_useLogDepth","depthQuadScratch","supportsTypedArrays","Float32Array","scratchCartesian1","scratchCartesian2","scratchCartesian3","scratchCartesian4","computeDepthQuad","ellipsoid","frameState","radii","p","camera","positionWC","q","multiplyComponents","oneOverRadii","qMagnitude","magnitude","qUnit","normalize","eUnit","cross","UNIT_Z","nUnit","wMagnitude","Math","sqrt","magnitudeSquared","center","multiplyByScalar","scalar","eastOffset","northOffset","upperLeft","add","subtract","pack","lowerLeft","upperRight","lowerRight","prototype","update","mode","SCENE3D","context","mapProjection","useLogDepth","fromCache","cull","enabled","depthTest","colorMask","red","green","blue","alpha","renderState","boundingVolume","ZERO","maximumRadius","pass","OPAQUE","owner","vs","sources","fs","extension","push","defines","replaceCache","shaderProgram","vertexShaderSource","fragmentShaderSource","attributeLocations","position","depthQuad","geometry","attributes","componentDatatype","FLOAT","componentsPerAttribute","values","indices","primitiveType","TRIANGLES","fromGeometry","bufferUsage","DYNAMIC_DRAW","vertexArray","getAttribute","vertexBuffer","copyFromArrayView","execute","passState","isDestroyed","destroy"],"mappings":"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","sourcesContent":["import BoundingSphere from \"../Core/BoundingSphere.js\";\nimport Cartesian3 from \"../Core/Cartesian3.js\";\nimport ComponentDatatype from \"../Core/ComponentDatatype.js\";\nimport defined from \"../Core/defined.js\";\nimport FeatureDetection from \"../Core/FeatureDetection.js\";\nimport Geometry from \"../Core/Geometry.js\";\nimport GeometryAttribute from \"../Core/GeometryAttribute.js\";\nimport PrimitiveType from \"../Core/PrimitiveType.js\";\nimport BufferUsage from \"../Renderer/BufferUsage.js\";\nimport DrawCommand from \"../Renderer/DrawCommand.js\";\nimport Pass from \"../Renderer/Pass.js\";\nimport RenderState from \"../Renderer/RenderState.js\";\nimport ShaderProgram from \"../Renderer/ShaderProgram.js\";\nimport ShaderSource from \"../Renderer/ShaderSource.js\";\nimport VertexArray from \"../Renderer/VertexArray.js\";\nimport DepthPlaneFS from \"../Shaders/DepthPlaneFS.js\";\nimport DepthPlaneVS from \"../Shaders/DepthPlaneVS.js\";\nimport SceneMode from \"./SceneMode.js\";\n\n/**\n * @private\n */\nfunction DepthPlane() {\n  this._rs = undefined;\n  this._sp = undefined;\n  this._va = undefined;\n  this._command = undefined;\n  this._mode = undefined;\n  this._useLogDepth = false;\n}\n\nvar depthQuadScratch = FeatureDetection.supportsTypedArrays()\n  ? new Float32Array(12)\n  : [];\nvar scratchCartesian1 = new Cartesian3();\nvar scratchCartesian2 = new Cartesian3();\nvar scratchCartesian3 = new Cartesian3();\nvar scratchCartesian4 = new Cartesian3();\n\nfunction computeDepthQuad(ellipsoid, frameState) {\n  var radii = ellipsoid.radii;\n  var p = frameState.camera.positionWC;\n\n  // Find the corresponding position in the scaled space of the ellipsoid.\n  var q = Cartesian3.multiplyComponents(\n    ellipsoid.oneOverRadii,\n    p,\n    scratchCartesian1\n  );\n\n  var qMagnitude = Cartesian3.magnitude(q);\n  var qUnit = Cartesian3.normalize(q, scratchCartesian2);\n\n  // Determine the east and north directions at q.\n  var eUnit = Cartesian3.normalize(\n    Cartesian3.cross(Cartesian3.UNIT_Z, q, scratchCartesian3),\n    scratchCartesian3\n  );\n  var nUnit = Cartesian3.normalize(\n    Cartesian3.cross(qUnit, eUnit, scratchCartesian4),\n    scratchCartesian4\n  );\n\n  // Determine the radius of the 'limb' of the ellipsoid.\n  var wMagnitude = Math.sqrt(Cartesian3.magnitudeSquared(q) - 1.0);\n\n  // Compute the center and offsets.\n  var center = Cartesian3.multiplyByScalar(\n    qUnit,\n    1.0 / qMagnitude,\n    scratchCartesian1\n  );\n  var scalar = wMagnitude / qMagnitude;\n  var eastOffset = Cartesian3.multiplyByScalar(\n    eUnit,\n    scalar,\n    scratchCartesian2\n  );\n  var northOffset = Cartesian3.multiplyByScalar(\n    nUnit,\n    scalar,\n    scratchCartesian3\n  );\n\n  // A conservative measure for the longitudes would be to use the min/max longitudes of the bounding frustum.\n  var upperLeft = Cartesian3.add(center, northOffset, scratchCartesian4);\n  Cartesian3.subtract(upperLeft, eastOffset, upperLeft);\n  Cartesian3.multiplyComponents(radii, upperLeft, upperLeft);\n  Cartesian3.pack(upperLeft, depthQuadScratch, 0);\n\n  var lowerLeft = Cartesian3.subtract(center, northOffset, scratchCartesian4);\n  Cartesian3.subtract(lowerLeft, eastOffset, lowerLeft);\n  Cartesian3.multiplyComponents(radii, lowerLeft, lowerLeft);\n  Cartesian3.pack(lowerLeft, depthQuadScratch, 3);\n\n  var upperRight = Cartesian3.add(center, northOffset, scratchCartesian4);\n  Cartesian3.add(upperRight, eastOffset, upperRight);\n  Cartesian3.multiplyComponents(radii, upperRight, upperRight);\n  Cartesian3.pack(upperRight, depthQuadScratch, 6);\n\n  var lowerRight = Cartesian3.subtract(center, northOffset, scratchCartesian4);\n  Cartesian3.add(lowerRight, eastOffset, lowerRight);\n  Cartesian3.multiplyComponents(radii, lowerRight, lowerRight);\n  Cartesian3.pack(lowerRight, depthQuadScratch, 9);\n\n  return depthQuadScratch;\n}\n\nDepthPlane.prototype.update = function (frameState) {\n  this._mode = frameState.mode;\n  if (frameState.mode !== SceneMode.SCENE3D) {\n    return;\n  }\n\n  var context = frameState.context;\n  var ellipsoid = frameState.mapProjection.ellipsoid;\n  var useLogDepth = frameState.useLogDepth;\n\n  if (!defined(this._command)) {\n    this._rs = RenderState.fromCache({\n      // Write depth, not color\n      cull: {\n        enabled: true,\n      },\n      depthTest: {\n        enabled: true,\n      },\n      colorMask: {\n        red: false,\n        green: false,\n        blue: false,\n        alpha: false,\n      },\n    });\n\n    this._command = new DrawCommand({\n      renderState: this._rs,\n      boundingVolume: new BoundingSphere(\n        Cartesian3.ZERO,\n        ellipsoid.maximumRadius\n      ),\n      pass: Pass.OPAQUE,\n      owner: this,\n    });\n  }\n\n  if (!defined(this._sp) || this._useLogDepth !== useLogDepth) {\n    this._useLogDepth = useLogDepth;\n\n    var vs = new ShaderSource({\n      sources: [DepthPlaneVS],\n    });\n    var fs = new ShaderSource({\n      sources: [DepthPlaneFS],\n    });\n    if (useLogDepth) {\n      var extension =\n        \"#ifdef GL_EXT_frag_depth \\n\" +\n        \"#extension GL_EXT_frag_depth : enable \\n\" +\n        \"#endif \\n\\n\";\n\n      fs.sources.push(extension);\n      fs.defines.push(\"LOG_DEPTH\");\n      vs.defines.push(\"LOG_DEPTH\");\n    }\n\n    this._sp = ShaderProgram.replaceCache({\n      shaderProgram: this._sp,\n      context: context,\n      vertexShaderSource: vs,\n      fragmentShaderSource: fs,\n      attributeLocations: {\n        position: 0,\n      },\n    });\n\n    this._command.shaderProgram = this._sp;\n  }\n\n  // update depth plane\n  var depthQuad = computeDepthQuad(ellipsoid, frameState);\n\n  // depth plane\n  if (!defined(this._va)) {\n    var geometry = new Geometry({\n      attributes: {\n        position: new GeometryAttribute({\n          componentDatatype: ComponentDatatype.FLOAT,\n          componentsPerAttribute: 3,\n          values: depthQuad,\n        }),\n      },\n      indices: [0, 1, 2, 2, 1, 3],\n      primitiveType: PrimitiveType.TRIANGLES,\n    });\n\n    this._va = VertexArray.fromGeometry({\n      context: context,\n      geometry: geometry,\n      attributeLocations: {\n        position: 0,\n      },\n      bufferUsage: BufferUsage.DYNAMIC_DRAW,\n    });\n\n    this._command.vertexArray = this._va;\n  } else {\n    this._va.getAttribute(0).vertexBuffer.copyFromArrayView(depthQuad);\n  }\n};\n\nDepthPlane.prototype.execute = function (context, passState) {\n  if (this._mode === SceneMode.SCENE3D) {\n    this._command.execute(context, passState);\n  }\n};\n\nDepthPlane.prototype.isDestroyed = function () {\n  return false;\n};\n\nDepthPlane.prototype.destroy = function () {\n  this._sp = this._sp && this._sp.destroy();\n  this._va = this._va && this._va.destroy();\n};\nexport default DepthPlane;\n"]},"metadata":{},"sourceType":"module"}